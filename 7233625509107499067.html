<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Node.js,前端,C++,">





  <link rel="alternate" href="atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta name="description" content="&amp;#x4E00;&amp;#x3001;&amp;#x80CC;&amp;#x666F;&amp;#x4F60;&amp;#x597D;&amp;#xFF01;&amp;#x6211;&amp;#x662F;&amp;#x903B;&amp;#x5343;&amp;#xFF0C;&amp;#x975E;&amp;#x5E38;&amp;#x9AD8;&amp;#x5174;&amp;#x4F60;&amp;#x80FD;&amp;#x770B;&amp;#x5230;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;">
<meta name="keywords" content="Node.js,前端,C++">
<meta property="og:type" content="article">
<meta property="og:title" content="Node 中的 AsyncLocalStorage 的前世今">
<meta property="og:url" content="https://dev.newban.cn/7233625509107499067.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:description" content="&amp;#x4E00;&amp;#x3001;&amp;#x80CC;&amp;#x666F;&amp;#x4F60;&amp;#x597D;&amp;#xFF01;&amp;#x6211;&amp;#x662F;&amp;#x903B;&amp;#x5343;&amp;#xFF0C;&amp;#x975E;&amp;#x5E38;&amp;#x9AD8;&amp;#x5174;&amp;#x4F60;&amp;#x80FD;&amp;#x770B;&amp;#x5230;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/76690e004be71e4ff5901390b5a94fd201f8c4fd85ed6d171e7e4be7e5007477">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/474a62136aef30b6aa5a113fa6f0fb7870b2959bb58557a6cabb0b622807356a">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/d502057cb6d6c203cbee7f6d8b8418543828a268e169049b8144de25a6b1d788">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4e394fb3ecc3c17de3e353cf678a0b77487fe35285a9b8af5f8dfc32c7e5ee65">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0440a7ec9c3e4ae1819413914bfe7196a1af2a491f399ade0291d8179c778da4">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d6835046c3c728f13ce977774869f58514f4914567005e70519950c3823abf5">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6a45a352587f4dc1e58ec99514f8955ca1c7f6d6538cb184865c599abdb8f6d">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/63210224001af4e04afb287cfbba4bab36fef05ae575f0457d20dcce0a2ca191">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/3e1d3b38e1e7e8075a119a3b5337234f407feb5dfda92faaab344525995cc994">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0a02586a931534dafb9e51e01ab042a798a29318da44f3547f84e3b18e00a4a0">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a99ea1bac5616fc973b92571f342f503fd686f3035cc42b371621f724058a731">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9aee0aaa769ea22a8b6a157e78a739a312a16595e6bde4cdc654c0a09856bce5">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e79cdd5ec76c51fed2f9131d9d1d63468dee25af205f5c74876aeec6d017630c">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c9646e201b380478add1555fb6f67723ad28add54181450934531e80a7de82de">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/27f4e2f98ca15ebc9cec99dec11e17f5cae12cc5b6554a14547d8cb3298f8175">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/67c7cea90f445928c63b97f391252389ef4a80b55ea349a67a57ab22c225cc36">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/7b9f597c2442a81082bc6816d805b2904396ed0c8f013427bf43cca69f7b9a81">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/294ec9faacde0f406b4d878df7baa70ca35b2dd6aacba5ff8e92d15af29fdbad">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f728b446fc8621087f2a0190c1cb7d893fcf3cb3f77dbcb0c8127ab08824abe5">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0799228bb37158f0fcedcbed7bb168f85f5fefaf667bc7d5a943bc229a49ef6e">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f845a06ae4ed9ff595b40092d9a927218ff167b7fbcdcd18780185984495a126">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/b2601115c384c4f09a83168693bc45d3e48d30675afc17f1cffdfb2f34b4c430">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c373a20c3aed76aa8b06ab581ff052ece9b5ff0870ddcb706e3ad11538bcaf4d">
<meta property="og:updated_time" content="2024-04-25T02:02:17.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node 中的 AsyncLocalStorage 的前世今">
<meta name="twitter:description" content="&amp;#x4E00;&amp;#x3001;&amp;#x80CC;&amp;#x666F;&amp;#x4F60;&amp;#x597D;&amp;#xFF01;&amp;#x6211;&amp;#x662F;&amp;#x903B;&amp;#x5343;&amp;#xFF0C;&amp;#x975E;&amp;#x5E38;&amp;#x9AD8;&amp;#x5174;&amp;#x4F60;&amp;#x80FD;&amp;#x770B;&amp;#x5230;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;">
<meta name="twitter:image" content="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/76690e004be71e4ff5901390b5a94fd201f8c4fd85ed6d171e7e4be7e5007477">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/7233625509107499067.html">





  <title>Node 中的 AsyncLocalStorage 的前世今 | 开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Node 中的 AsyncLocalStorage 的前世今</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-16T15:22:14+08:00">
                2023-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="&#x4E00;&#x3001;&#x80CC;&#x666F;"><a href="#&#x4E00;&#x3001;&#x80CC;&#x666F;" class="headerlink" title="&#x4E00;&#x3001;&#x80CC;&#x666F;"></a>&#x4E00;&#x3001;&#x80CC;&#x666F;</h1><p>&#x4F60;&#x597D;&#xFF01;&#x6211;&#x662F;&#x903B;&#x5343;&#xFF0C;&#x975E;&#x5E38;&#x9AD8;&#x5174;&#x4F60;&#x80FD;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5728;&#x5F00;&#x59CB;&#x524D;&#x6211;&#x5C06;&#x5927;&#x81F4;&#x4ECB;&#x7ECD;&#x4E24;&#x70B9;&#xFF0C;&#x5173;&#x4E8E;&#x9002;&#x5408;&#x8C01;&#x770B;&#x548C;&#x80FD;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;</p>
<h2 id="&#x9002;&#x5408;&#x8C01;&#x770B;"><a href="#&#x9002;&#x5408;&#x8C01;&#x770B;" class="headerlink" title="&#x9002;&#x5408;&#x8C01;&#x770B;"></a>&#x9002;&#x5408;&#x8C01;&#x770B;</h2><table>
<thead>
<tr>
<th><strong>&#x7C7B;&#x578B;&#x4EBA;&#x7FA4;</strong></th>
<th><strong>&#x63A8;&#x8350;&#x6307;&#x6570;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>&#x5B8C;&#x5168;&#x4E0D;&#x4E86;&#x89E3;Node&#xFF0C;&#x4F46;&#x6709;&#x5174;&#x8DA3;&#x770B;&#x770B;</td>
<td>&#x9002;&#x5408;&#xFF0C;&#x6709;&#x70B9;&#x95E8;&#x69DB;&#xFF0C;&#x4F1A;&#x5C3D;&#x91CF;&#x7167;&#x987E;&#x5230;</td>
</tr>
<tr>
<td>&#x5199;&#x8FC7;Node Server&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x8FD9;&#x4E2A;API</td>
<td>&#x5F88;&#x9002;&#x5408;&#xFF0C;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#x7684;&#x673A;&#x4F1A;</td>
</tr>
<tr>
<td>&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x6B64;API&#xFF0C;&#x4F46;&#x4E0D;&#x77E5;&#x9053;&#x4ED6;&#x7684;&#x524D;&#x4E16;&#x4ECA;&#x751F;</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF0C;&#x4F60;&#x770B;&#x6807;&#x9898;&#x554A;</td>
</tr>
<tr>
<td>&#x975E;&#x5E38;&#x4E86;&#x89E3;&#x6B64;API&#x751A;&#x81F3;&#x63D0;&#x8FC7;&#x76F8;&#x5173;PR</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF01;</td>
</tr>
</tbody></table>
<h2 id="Takeaway"><a href="#Takeaway" class="headerlink" title="Takeaway"></a>Takeaway</h2><p>&#x5982;&#x679C;&#x4F60;&#x6709;&#x8010;&#x5FC3;&#x770B;&#x5B8C;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;&#xFF1A;</p>
<ol>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4E00;&#x822C;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
<li>AsyncLocalStorage &#x4E0E;&#x6700;&#x65B0;&#x7684;&#x963F;&#x91CC;&#x5DF4;&#x5DF4;&#x4E3B;&#x5BFC;&#x7684; TC39 &#x63D0;&#x6848; AsyncContext &#x4E4B;&#x95F4;&#x662F;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#xFF1F;</li>
<li>&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7C7B;&#x4F3C;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x600E;&#x4E48;&#x7528;&#x7684;&#xFF1F;</li>
<li>Node &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684; AsyncHook&#xFF1F;</li>
</ol>
<h1 id="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage"><a href="#&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage" class="headerlink" title="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage"></a>&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage</h1><h2 id="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"><a href="#&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;" class="headerlink" title="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"></a>&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;</h2><p>&#x5F53;&#x4E00;&#x4E2A; Request &#x901A;&#x8FC7;&#x5C42;&#x5C42;&#x5173;&#x5361;&#x6253;&#x5230;&#x6211;&#x4EEC;&#x7684; Server&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x4EA7;&#x751F;&#x591A;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#xFF1A;</p>
<ol>
<li>&#x8BBF;&#x95EE;&#x65E5;&#x5FD7;</li>
<li>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;</li>
<li>SQL&#x65E5;&#x5FD7;</li>
<li>&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x65E5;&#x5FD7;&#x7B49;</li>
</ol>
<p>&#x800C;&#x5F53;&#x53D1;&#x751F;&#x4E86;&#x7EBF;&#x4E0A;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x6EAF;&#x6E90;&#x6392;&#x67E5;&#x3002;</p>
<p>&#x4E00;&#x822C;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x5728;&#x8BF7;&#x6C42;&#x4E4B;&#x5904;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x4E2A; unique traceId&#xFF0C;&#x6B64; id &#x5728;&#x6240;&#x6709;&#x65E5;&#x5FD7;&#x4E2D;&#x643A;&#x5E26;&#x5C31;&#x53EF;&#x4EE5;&#x8FFD;&#x8E2A;&#x8BE5;&#x8BF7;&#x6C42;&#x7684;&#x6240;&#x6709;&#x94FE;&#x8DEF;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;<strong>&#x5168;&#x94FE;&#x8DEF;&#x65E5;&#x5FD7;&#x8FFD;&#x8E2A;</strong>&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5728; Node Server &#x4E2D;&#x5982;&#x4F55;&#x8BA9;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0A;&#x4E0B;&#x6E38;&#x8C03;&#x7528;&#x90FD;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A; traceId &#x5462;&#xFF0C;&#x6211;&#x4EEC;&#x4E0B;&#x9762;&#x7ED9;&#x51E0;&#x4E2A;&#x65B9;&#x6848;&#x3002;</p>
<p>&#xFF08;&#x5148;&#x4E0D;&#x7BA1;&#x8FD9;&#x4E2A; id &#x662F; server &#x81EA;&#x5DF1;&#x751F;&#x6210;&#x7684;&#x8FD8;&#x662F; client &#x5E26;&#x4E0A;&#x6765;&#x7684;&#xFF09;</p>
<h2 id="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"><a href="#&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;" class="headerlink" title="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"></a>&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;</h2><p>&#x7B80;&#x5355;&#xFF0C;&#x5148;&#x62CD;&#x8111;&#x888B;&#x60F3;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>globalTraceId</code>&#xFF01;</p>
<p>&#x56E0;&#x4E3A;<code>closure</code>&#x95ED;&#x5305;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;close&#x4F4F;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5728;&#x4EFB;&#x4F55;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#xFF0C;&#x8BFB;&#x53D6;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x6240;&#x6307;&#x7684;&#x5185;&#x5B58;&#x91CC;&#x7684;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x7ED9;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x5373;&#x53EF;&#xFF1A;&#xFF08;&#x4EE5; raw Node.js &#x4E3A;&#x4F8B;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Raw Node.js HTTP server</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">let globalTraceId // &#xF8FF;&#x5168;&#x5C40;&#x53D8;&#x91CF;</span><br><span class="line"></span><br><span class="line">// 0. &#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  // &#x751F;&#x6210;&#x552F;&#x4E00; traceId&#xFF0C;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#xFF0C;&#x590D;&#x5199; globalTraceId &#x7684;&#x503C;</span><br><span class="line">  globalTraceId = generateTraceId()</span><br><span class="line"></span><br><span class="line">  // &#x68C0;&#x67E5;&#x7528;&#x6237;cookie&#x662F;&#x5426;&#x6709;&#x6548;</span><br><span class="line">  cookieValidator().then((res) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });</span><br><span class="line">    res.write(&apos;Congrats! Your damn cookie is the best one!&apos;);</span><br><span class="line">    res.end();</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x628A; traceId &#x8FDE;&#x540C; error &#x4E0A;&#x62A5;&#x7ED9;&#x5F02;&#x5E38;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;</span><br><span class="line">    reportError(err, globalTraceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 1. &#x521B;&#x5EFA; server </span><br><span class="line">const server = http.createServer((req, res) =&gt; {</span><br><span class="line">	handleRequest(req, res)</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// 2. &#x8BA9; server &#x548C; port:3000 &#x5EFA;&#x7ACB; socket &#x94FE;&#x63A5;&#xFF0C;&#x6301;&#x7EED;&#x63A5;&#x6536;&#x7AEF;&#x53E3;&#x4FE1;&#x606F;</span><br><span class="line">server.listen(3000, () =&gt; {</span><br><span class="line">  console.log(&apos;Server listening on port 3000&apos;);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x4F46;&#x662F;&#x5728; Node.js &#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF08;&#x4E3B;&#x7EBF;&#x7A0B;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF09;&#xFF0C;<code>globalTraceId</code>&#x8FD9;&#x6837;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5F02;&#x6B65;&#x6821;&#x9A8C; cookie &#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x56E0;&#x4E3A; main stack &#x5DF2;&#x7A7A;&#xFF0C;&#x6240;&#x4EE5;&#x4ECE;<code>backlog</code>&#x91CC;&#x9762;&#x8C03;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#x4E3B;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x800C;<code>globalTraceId</code>&#x4F1A;&#x88AB;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x590D;&#x5199;&#xFF0C;&#x5BFC;&#x81F4;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5728;&#x9519;&#x8BEF;&#x4E0A;&#x62A5;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x80FD;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684; id</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/76690e004be71e4ff5901390b5a94fd201f8c4fd85ed6d171e7e4be7e5007477" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"><a href="#&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;" class="headerlink" title="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"></a>&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</h2><p>&#x90A3;&#x4E0A;&#x9762;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x6CD5;&#x786E;&#x5B9E;&#x4E0D;&#x5BF9;&#xFF0C;&#x90A3;&#x4F60;&#x4F1A;&#x60F3;&#xFF0C;&#x90A3;&#x6211;&#x628A;&#x751F;&#x6210;&#x7684; traceId &#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4E00;&#x6B65;&#x6B65;&#x900F;&#x4F20;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x540C;&#x4E00;&#x4E2A; traceId &#x7684;&#x6548;&#x679C;&#xFF0C;&#x597D;&#x50CF;&#x597D;&#x591A;&#x5E93;&#x548C;&#x6846;&#x67B6;&#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<p>&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  const traceId = req.headers[&apos;x-trace-id&apos;] || generateTraceId();</span><br><span class="line">  // &#x628A; traceId &#x5199;&#x5165; req &#x8FD9;&#x4E2A; object&#xFF0C;&#x5C06;&#x53C2;&#x6570;&#x4E00;&#x8DEF;&#x5E26;&#x4E0B;&#x53BB;</span><br><span class="line">  req.traceId = traceId;</span><br><span class="line"></span><br><span class="line">  // &#x540C;&#x4E0A;</span><br><span class="line">  cookieValidator().then((result) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">  	// ...</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">    reportError(err, req.traceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function cookieValidator() {</span><br><span class="line">  return new Promise((resolve, reject) =&gt; {</span><br><span class="line">    setTimeout(() =&gt; {</span><br><span class="line">      // do someting</span><br><span class="line">      // ...</span><br><span class="line">    }, 1000);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x6B64;&#x540E;&#x7701;&#x7565;&#x76D1;&#x542C;&#x7B49;&#x64CD;&#x4F5C;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x80FD;&#x591F;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x628A; traceId &#x901A;&#x8FC7; req &#x8FD9;&#x4E2A; object &#x4E00;&#x8DEF;&#x4F20;&#x4E0B;&#x53BB;&#x3002;&#x80FD;&#x4F20;&#x4E0B;&#x53BB;&#x7684;&#x539F;&#x56E0;&#x662F; node &#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684; context&#xFF08;&#x4E0A;&#x4E0B;&#x6587;&#xFF09;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x8C03;&#x7528;&#x6808;&#x3001;local variable&#x3001;referenced global variable &#x5B58;&#x4E0B;&#x6765;&#xFF0C;&#x4E00;&#x76F4;&#x5230;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x518D;&#x5728;&#x5B58;&#x4E0B;&#x6765;&#x7684; context &#x4E2D;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6240;&#x8C13;&#x7684;<code>&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</code>&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7; local variable &#x88AB;&#x5B58;&#x5230;&#x4E86; async function call context &#x91CC;&#x9762;&#x800C;&#x5B8C;&#x6210;&#x4E86;<code>traceId</code>&#x5728;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x91CC;&#x9762;&#x4E00;&#x8DEF;&#x4F20;&#x9012;&#x3002;</p>
<p><strong>&#x5E38;&#x89C1;&#x7684; Node &#x5E93;&#x5982;&#x4F55;&#x5904;&#x7406; traceId &#x7684;&#xFF1F;</strong></p>
<p>&#x7EC6;&#x5FC3;&#x7684;&#x4F60;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x5E38;&#x7528; express &#x6216;&#x8005; koa &#x8FD9;&#x6837;&#x7684;&#x5E93;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x5E72;&#x7684;&#x561B;&#x3002;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x4E3E;&#x51E0;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x5E93;&#x7684;&#x4F8B;&#x5B50;</p>
<p><strong>Express.js</strong></p>
<p><a href="/external_links/4ed5922eb818b953fc6e20d667e67b46.html" target="blank" rel="noopener">Express</a> &#x662F;&#x6700;&#x65E9;&#x6D41;&#x884C;&#x7684;Node server&#x5E93;&#xFF0C;&#x5230;&#x73B0;&#x5728;&#x4F9D;&#x7136;&#x5F88;&#x6D41;&#x884C;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x8DEF;&#x7531;&#x3001;&#x4E2D;&#x95F4;&#x4EF6;&#x7B49;&#x5404;&#x79CD;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x770B;&#x4E0B; Express &#x662F;&#x5982;&#x4F55;&#x4F20;&#x9012; TraceId &#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Via express</span><br><span class="line">const express = require(&apos;express&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  req.traceId = traceId; // attach the trace ID to the request object</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x8BBE;&#x7F6E;&#x8DEF;&#x7531;</span><br><span class="line">app.get(&apos;/&apos;, async (req, res, next) =&gt; {</span><br><span class="line">  const traceId = req.traceId;</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    // call an asynchronous function and pass along the trace ID</span><br><span class="line">    const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">    // do something with the result</span><br><span class="line">    res.send(result);</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    next(error);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p><strong>Koa.js</strong></p>
<p><a href="/external_links/375bfd688767fe0bd21f1453cbb48a1c.html" target="blank" rel="noopener">Koa</a> &#x4E5F;&#x662F;&#x793E;&#x533A;&#x975E;&#x5E38;&#x6D41;&#x884C;&#x7684;&#x5E93;</p>
<p>Koa &#x65E9;&#x671F;&#x4F7F;&#x7528; <code>yield</code>&#x8BED;&#x6CD5;&#xFF0C;&#x540E;&#x671F;&#x652F;&#x6301;&#x4E86;<code>await</code>&#x8BED;&#x6CD5;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684; <code>egg.js</code>&#x662F;&#x57FA;&#x4E8E; Koa &#x5C01;&#x88C5;&#x7684;Node Server&#x6846;&#x67B6;&#x3002;&#x73B0;&#x5728;&#x6DD8;&#x5B9D;&#x7684;<code>midwayjs</code>&#x6700;&#x65E9;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;<code>egg.js</code>&#x505A;&#x7684;&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8F88;&#x5206;&#x5173;&#x7CFB;&#x68B3;&#x7406;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Koa &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const Koa = require(&apos;koa&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;A</span><br><span class="line">app.use(async (ctx, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  ctx.state.traceId = traceId; // store the trace ID in the Koa context object</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    await next();</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    throw error;</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;B&#xFF0C;&#x901A;&#x8FC7; ctx &#x900F;&#x4F20; traceId</span><br><span class="line">app.use(async (ctx) =&gt; {</span><br><span class="line">  const traceId = ctx.state.traceId;</span><br><span class="line"></span><br><span class="line">  // call an asynchronous function and pass along the trace ID</span><br><span class="line">  const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">  // do something with the result</span><br><span class="line">  ctx.body = result;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x51E0;&#x4E4E;&#x548C; express &#x4E00;&#x6837;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x628A; tracId &#x5B58;&#x5230;&#x4E00;&#x8DEF;&#x900F;&#x4F20;&#x7684; ctx &#x53D8;&#x91CF;&#x91CC;&#x9762;&#x5B9E;&#x73B0;&#x53C2;&#x6570;&#x7684;&#x900F;&#x4F20;&#x3002;</p>
<p><strong>Nest.js</strong></p>
<p><a href="/external_links/12ea646682d52a51d59a7d141b2bc347.html" target="blank" rel="noopener">Nest</a> (NestJS) &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x9AD8;&#x6548;&#x3001;&#x53EF;&#x6269;&#x5C55;&#x7684; Node.js &#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5F00;&#x53D1;&#x6846;&#x67B6;&#x3002;&#x5B83;&#x5229;&#x7528; JavaScript &#x7684;&#x6E10;&#x8FDB;&#x589E;&#x5F3A;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F7F;&#x7528;&#x5E76;&#x5B8C;&#x5168;&#x652F;&#x6301; TypeScript &#xFF08;&#x4ECD;&#x7136;&#x5141;&#x8BB8;&#x5F00;&#x53D1;&#x8005;&#x4F7F;&#x7528;&#x7EAF; JavaScript &#x8FDB;&#x884C;&#x5F00;&#x53D1;&#xFF09;&#xFF0C;&#x5E76;&#x7ED3;&#x5408;&#x4E86; OOP &#xFF08;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#xFF09;&#x3001;FP &#xFF08;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x548C; FRP &#xFF08;&#x51FD;&#x6570;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x3002;</p>
<p>&#x603B;&#x7ED3;&#x6765;&#x8BF4; Nest &#x7684;&#x7279;&#x70B9;&#x662F;&#xFF0C;&#x5B8C;&#x7F8E;&#x652F;&#x6301;ts&#x3001;&#x62E5;&#x62B1;&#x88C5;&#x9970;&#x5668;&#x548C;&#x6CE8;&#x89E3;&#xFF0C;&#x540C;&#x65F6;&#x901A;&#x8FC7;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#xFF08;DI&#xFF09;&#x548C;&#x6A21;&#x5757;&#x5316;&#x601D;&#x60F3;&#x7B49;&#xFF0C;&#x4F7F;&#x4EE3;&#x7801;&#x7ED3;&#x6784;&#x5DE5;&#x6574;&#xFF0C;&#x6613;&#x4E8E;&#x9605;&#x8BFB;&#x3002;&#x66F4;&#x591A;&#x4ECB;&#x7ECD;&#x53EF;&#x4EE5;&#x770B;&#x5B98;&#x7F51;&#x3002;</p>
<p>&#x5728;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x4E0A;&#xFF0C;Nest &#x662F;&#x63A8;&#x8350;&#x5982;&#x4F55;&#x4F7F;&#x7528; Async Local Storage &#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x89C1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<p><a href="/external_links/feb8be566d78178e7a3d1f7852caa0bd.html" target="blank" rel="noopener">docs.nestjs.com/recipes/asy&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F7F;&#x7528; nestjs-cls&#x8FD9;&#x4E2A;&#x5E93;</span><br><span class="line">// npm i nestjs-cls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x6A21;&#x5757;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7533;&#x660E; Cls Module</span><br><span class="line">@Module({</span><br><span class="line">  imports: [</span><br><span class="line">    // Register the ClsModule,</span><br><span class="line">    ClsModule.forRoot({</span><br><span class="line">      middleware: {</span><br><span class="line">        // automatically mount the</span><br><span class="line">        // ClsMiddleware for all routes</span><br><span class="line">        mount: true,</span><br><span class="line">        // and use the setup method to</span><br><span class="line">        // provide default store values.</span><br><span class="line">        setup: (cls, req) =&gt; {</span><br><span class="line">          // &#x901A;&#x8FC7;CLS&#x5B58;&#x50A8; traceId</span><br><span class="line">          cls.set(&apos;traceId&apos;, req.headers[&apos;x-trace-id&apos;] || generateTraceId()); </span><br><span class="line">        },</span><br><span class="line">      },</span><br><span class="line">    }),</span><br><span class="line">  ],</span><br><span class="line">  providers: [CatService],</span><br><span class="line">  controllers: [CatController],</span><br><span class="line">})</span><br><span class="line">export class AppModule {}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5728; Service &#x4E2D;&#x6CE8;&#x518C; Cls&#xFF0C;&#x5E76;&#x4E14;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">@Injectable()</span><br><span class="line">export class CatService {</span><br><span class="line">  constructor(</span><br><span class="line">    // We can inject the provided ClsService instance,</span><br><span class="line">    private readonly cls: ClsService,</span><br><span class="line">    private readonly catRepository: CatRepository,</span><br><span class="line">  ) {}</span><br><span class="line"></span><br><span class="line">  getCatForUser() {</span><br><span class="line">    // and use the &quot;get&quot; method to retrieve any stored value.</span><br><span class="line">    const userId = this.cls.get(&apos;traceId&apos;); // &#x83B7;&#x5F97; traceId</span><br><span class="line">    return this.catRepository.getForUser(userId);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Nest &#x548C;&#x4E0A;&#x9762;&#x7684;&#x5E93;&#x8089;&#x773C;&#x4E0A;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x662F;&#x91C7;&#x7528;&#x4E86;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#xFF0C;&#x540C;&#x65F6;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x88C5;&#x9970;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x5982;&#x679C;&#x5BF9;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x6709;&#x5174;&#x8DA3;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5B8C;&#x6210;&#x4E86;IOC&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>
<p><a href="/external_links/70d2f105f034cda3227e2404a8261f1f.html" target="blank" rel="noopener">zhuanlan.zhihu.com/p/311184005</a></p>
<p>OK&#xFF0C;&#x90A3;&#x4E48; <code>nestjs-cls</code>&#x8FD9;&#x4E2A;&#x5E93;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x8FD9;&#x4E2A;&#x5305;&#x7684;&#x63CF;&#x8FF0;</p>
<p>The <a href="/external_links/a0093739fc6f0cfaa52e7579861105d8.html" target="blank" rel="noopener">nestjs-cls</a> package provides several DX improvements over using plain <strong>AsyncLocalStorage</strong> (<strong>CLS</strong> is an abbreviation of the term continuation-local storage).</p>
<p>DX &#x662F; Developer Experience &#x5373;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x5E93;&#x662F;&#x7528;&#x4E8E;&#x63D0;&#x5347;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x7684;&#x57FA;&#x4E8E;&#x539F;&#x751F;<code>AsyncLocalStorage</code>&#x7684;&#x5305;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4E0B;&#x9762;&#x7EC8;&#x4E8E;&#x4ECB;&#x7ECD;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x7684;&#x4E3B;&#x89D2;<code>AsyncLocalStorage</code>&#xFF01;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/474a62136aef30b6aa5a113fa6f0fb7870b2959bb58557a6cabb0b622807356a" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"><a href="#&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage" class="headerlink" title="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"></a>&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;<code>AsyncLocalStorage</code></h2><p>AsyncLocalStorage &#x662F; Nodejs &#x7684; API&#xFF08;&#x5927;&#x7EA6;&#x5728;2019&#x5E74;&#x63A8;&#x51FA;&#xFF0C;2020&#x5E74;&#x8FDB;&#x5165;&#x7A33;&#x5B9A;&#x7248;&#x672C;&#xFF09;</p>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F; Node.js &#x89C9;&#x5F97;&#x5927;&#x5BB6;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4E0D;&#x591F;&#x4F18;&#x96C5;&#xFF0C;&#x54E5;&#x76F4;&#x63A5;&#x5728;<code>C++</code>&#x7684;&#x5C42;&#x9762;&#x7ED9;&#x4F60;&#x4EEC;&#x505A;&#x6389;&#x8FD9;&#x4E2A;&#x4E8B;&#xFF0C;&#x7136;&#x540E;&#x63D0;&#x4F9B;&#x4E2A;API&#x7ED9;&#x5927;&#x4F19;&#x7528;&#xFF0C;&#x600E;&#x4E48;&#x6837;&#xFF1F;&#x55EF;&#x5927;&#x6982;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x3002;</p>
<p>&#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x662F;&#x5B98;&#x65B9;&#x7684;API&#xFF0C;&#x81EA;&#x7136;&#x6709;&#x5B98;&#x65B9;&#x7684;&#x6587;&#x6863;&#x6765;&#x63CF;&#x8FF0;</p>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;</p>
<blockquote>
<p>This class creates stores that stay coherent through asynchronous operations.</p>
<p>While you can create your own implementation on top of the node:async_hooks module, AsyncLocalStorage should be preferred as it is a performant and memory safe implementation that involves significant optimizations that are non-obvious to implement.</p>
<p>The following example uses AsyncLocalStorage to build a simple logger that assigns IDs to incoming HTTP requests and includes them in messages logged within each request.</p>
</blockquote>
<p>&#x6587;&#x6863;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/8b7ffbb550a0eb20f988772d3dcd2f09.html" target="blank" rel="noopener">nodejs.org/api/async_c&#x2026;</a></p>
<p>&#x4E2D;&#x6587;&#x89E3;&#x91CA;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#xFF1A;<code>AsyncLocalStorage</code>&#x662F;&#x57FA;&#x4E8E;<code>node:async_hooks</code>&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#xFF08;&#x6BD4;&#x4E4B;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#xFF09;&#x662F;&#x6027;&#x80FD;&#x597D;&#x3001;&#x5185;&#x5B58;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x5B58;&#x50A8;&#x7528;&#x4E8E;<code>log</code>&#x7684;&#x4FE1;&#x606F;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E2A;&#x4F8B;&#x5B50; <code>AsyncLocalStorage</code>&#x662F;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;// How to use AsyncLocalStorage in Node.js</span><br><span class="line">import http from &apos;node:http&apos;;</span><br><span class="line">import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">function logWithId(msg) {</span><br><span class="line">  const traceId = asyncLocalStorage.getStore();</span><br><span class="line">  console.log(`${traceId}:`, msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">http.createServer((req, res) =&gt; {</span><br><span class="line">  // &#xF8FF;&#x5173;&#x952E;&#x7684;API&#x8C03;&#x7528;&#xF8FF;</span><br><span class="line">  asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">    logWithId(&apos;start&apos;);</span><br><span class="line">    // Imagine any chain of async operations here</span><br><span class="line">    setImmediate(() =&gt; {</span><br><span class="line">      logWithId(&apos;finish&apos;);</span><br><span class="line">      res.end();</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}).listen(8080);</span><br><span class="line"></span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">// Prints:</span><br><span class="line">//   0: start</span><br><span class="line">//   1: start</span><br><span class="line">//   0: finish</span><br><span class="line">//   1: finish</span><br></pre></td></tr></table></figure>

<p>&#x4E0B;&#x9762;&#x662F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x89E3;&#x91CA;&#xFF1A;</p>
<p>&#x4E0A;&#x9762;&#x5C55;&#x793A;&#x4E86;2&#x4E2A;&#x8BF7;&#x6C42;&#x88AB;&#x6253;&#x5230;<code>port:8080</code>&#xFF0C;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x88AB;&#x653E;&#x5728;&#x4E86;<code>asyncLocalStorage.run</code>&#x8FD9;&#x4E2A;API&#x91CC;&#x9762;&#x3002;<code>setImmediate</code>&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7;<code>logWithId</code>&#x53D6;&#x51FA;&#x8BE5;&#x8BF7;&#x6C42;&#x5728;&#x8FDB;&#x5165;&#x65F6;&#x88AB;&#x8D4B;&#x4E88;&#x7684;<code>id</code>&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5373;&#x4F7F;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;id(&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;idSeq=0&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x65F6;idSeq=1)&#x5DF2;&#x7ECF;&#x88AB;log&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x662F; line 8 &#x7684; &#x540C;&#x4E00;&#x4E2A; <code>asyncLocalStorage</code>&#x5374;&#x80FD;<code>getStore</code>&#x51FA;&#x5BF9;&#x5E94;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0D;&#x540C;id&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x5F0F;&#x5B58;&#x50A8;<code>id</code>&#x4F18;&#x96C5;&#x5F97;&#x591A;&#xFF08;&#x53E6;&#x5916;&#xFF0C;&#x901A;&#x8FC7;<code>asyncLocalStorage</code>&#x8FD9;&#x6837;&#x9690;&#x5F0F;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x6709;&#x70B9;&#x50CF;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; State Monad &#x5E2E;&#x52A9;&#x5F00;&#x53D1;&#x8005;&#x9690;&#x5F0F;&#x7BA1;&#x7406;&#x53C2;&#x6570;&#x4F20;&#x9012;&#xFF09;</p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x8BB2;&#x5230;&#x8FD9;&#xFF0C;&#x6211;&#x4EEC;<code>Takeaway</code>&#x4E2D;&#x7684;1&#x5DF2;&#x7ECF;&#x88AB;&#x89E3;&#x51B3;&#x4E86;</p>
<ul>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
</ul>
<p>&#x5982;&#x679C;&#x8BA4;&#x771F;&#x770B;&#x5B8C;&#xFF0C;&#x76F8;&#x4FE1;&#x4F60;&#x5BF9;&#x5B83;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x4E2A;&#x611F;&#x6027;&#x7684;&#x8BA4;&#x8BC6;&#x3002;&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6807;&#x9898;&#x7684;&#x540E;&#x4E00;&#x53E5;&#x8BDD;&#xFF0C;<code>AsyncLocalStorage</code>&#x7684;<code>&#x524D;&#x4E16;&#x4ECA;&#x751F;</code></p>
<h1 id="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage"><a href="#&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage" class="headerlink" title="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage"></a>&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage</h1><blockquote>
<p>&#x5FD8;&#x8BB0;&#x5386;&#x53F2;&#x5C31;&#x610F;&#x5473;&#x7740;&#x80CC;&#x53DB;&#xFF08;&#x72D7;&#x5934;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x5386;&#x53F2;&#x7684;&#x5408;&#x8BA2;&#x672C;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x5927;&#x5BB6;&#x90FD;&#x6709;&#x53C2;&#x6570;&#x5F02;&#x6B65;&#x4F20;&#x9012;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x6240;&#x4EE5;&#x7B49;19&#x5E74;AsyncLocalStorage&#x88AB;&#x63A8;&#x51FA;&#x4E4B;&#x524D;&#x4E00;&#x5B9A;&#x6709;&#x793E;&#x533A;&#x65B9;&#x6848;&#x88AB;&#x5927;&#x5BB6;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Node.js 14&#x53D1;&#x5E03;&#x4E4B;&#x524D;&#xFF0C;&#x793E;&#x533A;&#x662F;&#x5982;&#x4F55;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x7EBF;&#x6765;&#x68B3;&#x7406;&#x6B64;&#x4E8B;&#xFF0C;&#x90A3;&#x8981;&#x4ECE;2013&#x5E74;&#x7684;&#x6625;&#x5929;&#x8BF4;&#x8D77;</p>
<h2 id="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;"><a href="#2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;" class="headerlink" title="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;"></a>2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;</h2><p>2013&#x5E74;4&#x6708;30&#x53F7;&#xFF0C;<a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">node-continuation-local-storage</a> &#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x63D0;&#x4EA4;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A; <code>commit</code>&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#xFF0C;&#x793E;&#x533A;&#x66F4;&#x591A;&#x5730;&#x79F0;&#x5B83;&#x4E3A;<code>CLS</code>(Continuation-Local Storage&#xFF0C;&#x4E4B;&#x540E;&#x7B80;&#x79F0;&#x4E3A;CLS)&#x3002;&#x6211;&#x622A;&#x53D6;&#x4E86;&#x8FD9;&#x4E2A;10&#x5C81;&#x7684;&#x4ED3;&#x5E93;README&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x6BB5;&#x7ED9;&#x5927;&#x5BB6;</p>
<blockquote>
<p>Continuation-local storage works like thread-local storage in threaded programming, but is based on chains of Node-style callbacks instead of threads. The standard Node convention of functions calling functions is very similar to something called <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> in functional programming, and the name comes from the way this module allows you to set and get values that are scoped to the lifetime of these chains of function calls.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x8BDD;&#x53EF;&#x4EE5;&#x63D0;&#x53D6;&#x51FA;&#x51E0;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<ol>
<li>CLS &#x50CF;&#x591A;&#x7EBF;&#x7A0B;&#x7F16;&#x7A0B;&#x4E2D;&#x7684;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x7684; storage&#xFF08;TLS: thread local storage&#xFF09;&#x4E00;&#x6837;&#x5DE5;&#x4F5C;&#xFF0C;&#x53EA;&#x662F;&#x539F;&#x7406;&#x662F;&#x57FA;&#x4E8E; callback function &#x800C;&#x4E0D;&#x662F;&#x7EBF;&#x7A0B;</li>
<li>&#x53D6;&#x540D;&#x4E2D;&#x6709; Continuation &#x4EE3;&#x8868; C&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> &#x6982;&#x5FF5;&#xFF0C;&#x65E8;&#x5728;&#x94FE;&#x5F0F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x6301;&#x4E45;&#x7684;&#x6570;&#x636E;</li>
<li>&#x4F60;<code>set</code>&#x548C;<code>get</code>&#x7684;&#x503C;&#xFF0C;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5F02;&#x6B65;&#x7684;function&#x7684;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x8C03;&#x7528;&#x94FE;&#x5185;&#x7684;</li>
</ol>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x4E0B;&#x9762;&#x662F; github &#x4E0A;&#x8BE5;&#x4ED3;&#x5E93;&#x7684;&#x793A;&#x4F8B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const cls = require(&apos;continuation-local-storage&apos;); // require(&apos;cls-hooked&apos;) &#x4E5F;&#x884C;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;</span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// Create a new namespace for the traceId</span><br><span class="line">const traceNamespace = cls.createNamespace(&apos;trace&apos;);</span><br><span class="line"></span><br><span class="line">// Middleware to set the traceId for each request</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  traceNamespace.run(() =&gt; {</span><br><span class="line">    // Generate a new traceId if one doesn&apos;t exist</span><br><span class="line">    traceNamespace.set(&apos;traceId&apos;, generateTraceId());</span><br><span class="line">    next();</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// Route to get the traceId for the current request</span><br><span class="line">app.get(&apos;/traceId&apos;, async (req, res) =&gt; {</span><br><span class="line">  try {</span><br><span class="line">    const cookie = await cookieValidator()</span><br><span class="line">    // &#x6821;&#x9A8C;&#x662F;&#x5426;&#x6210;&#x529F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  } catch(e) {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">  	const traceId = traceNamespace.get(&apos;traceId&apos;);</span><br><span class="line">    reportError(err, traceId)</span><br><span class="line">  }</span><br><span class="line">  res.send(`Trace ID: ${traceId}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x6BCF;&#x6B21;&#x6267;&#x884C; <code>namespace.run(callback)</code> &#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x8BED;&#x6CD5;&#x4E0A;&#xFF0C;&#x901A;&#x8FC7; run &#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x4F4F;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x56DE;&#x8C03;&#x5185;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x6211;&#x4EEC;&#x7684; <code>Continuation-Local Storage</code>&#x3002;&#x8FD9;&#x4E2A;<code>xxx.run(callbakc, ...)</code>&#x7684;&#x8BED;&#x6CD5;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x4F1A;&#x591A;&#x6B21;&#x770B;&#x5230;&#x3002;</p>
<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>CLS &#x901A;&#x8FC7; <code>process.addAsyncListener</code> &#x8FD9;&#x4E2A; API &#x76D1;&#x542C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x3002;&#x5728;&#x521B;&#x5EFA;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#x5C06;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x5165;&#xFF0C;&#x6267;&#x884C;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x65F6;&#xFF0C;&#x4F20;&#x5165;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x9500;&#x6BC1;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x800C;<code>process.addAsyncListener</code>&#x662F; <a href="/external_links/579311e71bce05526dda23c9eec7c845.html" target="blank" rel="noopener">Node v0.11 &#x7248;&#x672C;&#x7684; API</a>&#xFF0C;&#x76EE;&#x524D;&#x4ED3;&#x5E93;&#x5F15;&#x7528;&#x7684;&#x662F; polyfill &#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4ECE;&#x4E0B;&#x9762;&#x622A;&#x56FE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x8FD9;&#x662F;&#x6BB5; polyfill &#x7684;&#x4EE3;&#x7801;&#x662F;2013&#x5E74;9&#x6708;2&#x53F7;&#x88AB;&#x63D0;&#x4EA4;&#x7684;&#xFF0C;&#x662F;&#x76F8;&#x5F53;&#x53E4;&#x65E9;&#x7684;&#x4E8B;&#x60C5;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// load polyfill if native support is unavailable</span><br><span class="line">if (!process.addAsyncListener) require(&apos;async-listener&apos;);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/d502057cb6d6c203cbee7f6d8b8418543828a268e169049b8144de25a6b1d788" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x901A;&#x8FC7; async call &#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x5199;&#x51FA;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#x7684;&#x9700;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x53D8;&#x91CF;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6765;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF1B;&#x540C;&#x65F6;&#x5728;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x91CC;&#x9762;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x901A;&#x8FC7;&#x6B64;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5B8C;&#x6210;&#x4E86;<code>nest</code>&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5373;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#xFF0C;run&#x91CC;&#x9762;&#x5728;&#x5D4C;&#x5165;&#x4E00;&#x4E2A;run&#x3002;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x975E;&#x5E38;&#x9002;&#x5408;&#x505A;&#x8C03;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x56E0;&#x4E3A; main call stack &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6808; : &#xFF09;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF1A;<a href="/external_links/7113efbf78025131b4cfb56c78bc528d.html" target="blank" rel="noopener">github.com/othiym23/no&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;// createNamespace &#x5C31;&#x662F;&#x8C03;&#x7528;&#x5185;&#x90E8;&#x7684; create &#x65B9;&#x6CD5;</span><br><span class="line">function create(name) {</span><br><span class="line">  assert.ok(name, &quot;namespace must be given a name!&quot;);</span><br><span class="line"></span><br><span class="line">  var namespace = new Namespace(name); // &#x65B0;&#x5EFA; space</span><br><span class="line">  namespace.id = process.addAsyncListener({</span><br><span class="line">    create : function () { return namespace.active; },</span><br><span class="line">    before : function (context, storage) { if (storage) namespace.enter(storage); },</span><br><span class="line">    after  : function (context, storage) { if (storage) namespace.exit(storage); },</span><br><span class="line">    error  : function (storage) { if (storage) namespace.exit(storage); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  process.namespaces[name] = namespace;</span><br><span class="line">  return namespace;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>create</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A; Namespace &#x6765;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64; name &#x4F1A;&#x5728;&#x539F;&#x751F;API&#x4E0A;&#x76D1;&#x542C;&#x5404;&#x79CD;&#x4E8B;&#x4EF6;&#xFF0C;&#x540C;&#x65F6;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x7684; store &#x53D8;&#x5316;&#x3002;&#x5176;&#x4E2D;<code>namespace.enter(storage)</code>&#x8868;&#x793A;&#x5C06;&#x6B64;&#x65F6;&#x7684; ctx &#x5165;&#x6808;&#xFF0C;&#x5728;async call before&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#xFF0C;&#x5373;&#x5B8C;&#x6210;&#x5F02;&#x6B65;&#x65F6;&#x95F4;&#x540E;&#x3001;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x3002;&#x800C;&#x5728;async call after&#x65F6;&#xFF0C;&#x5219;&#x662F;&#x8C03;&#x7528;&#x51FA;&#x6808;&#x65B9;&#x6CD5; <code>namespace.exit(storage)</code>&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570; storage&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728; store &#x4E2D;&#x5B58;&#x5165;&#x7684; traceId</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// cls&#x7684;&#x5B9E;&#x73B0;</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x662F; store &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684; class</span><br><span class="line">function Namespace(name) {</span><br><span class="line">  this.name   = name;</span><br><span class="line">  // changed in 2.7: no default context</span><br><span class="line">  this.active = null;</span><br><span class="line">  this._set   = [];</span><br><span class="line">  this.id     = null;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// run&#x65B9;&#x6CD5;</span><br><span class="line">Namespace.prototype.run = function (fn) {</span><br><span class="line">  var context = this.createContext();</span><br><span class="line">  this.enter(context);</span><br><span class="line">  try {</span><br><span class="line">    fn(context);</span><br><span class="line">    return context;</span><br><span class="line">  }</span><br><span class="line">  catch (exception) {</span><br><span class="line">    if (exception) {</span><br><span class="line">      exception[ERROR_SYMBOL] = context;</span><br><span class="line">    }</span><br><span class="line">    throw exception;</span><br><span class="line">  }</span><br><span class="line">  finally {</span><br><span class="line">    this.exit(context);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// &#x5F53;&#x524D;&#x7684; active &#x5165;&#x6808;&#xFF0C;&#x628A;&#x65B0;&#x7684; ctx &#x5F53;&#x505A; this.active</span><br><span class="line">Namespace.prototype.enter = function (context) {</span><br><span class="line">  assert.ok(context, &quot;context must be provided for entering&quot;);</span><br><span class="line"></span><br><span class="line">  this._set.push(this.active);</span><br><span class="line">  this.active = context;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684; <code>this._set</code>&#x5C31;&#x662F;&#x521A;&#x624D;&#x8BF4;&#x7684;&#x88AB;&#x7EF4;&#x62A4;&#x7684;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x6BCF;&#x4E00;&#x6B21; run &#x7684;&#x8C03;&#x7528;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; context &#x4F5C;&#x4E3A; this.active&#xFF0C;&#x540C;&#x65F6;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;&#x7684; context&#xFF08;this.active&#xFF09;&#x7ED9; push &#x8FDB;&#x5165; this._set &#x8FD9;&#x4E2A;&#x6808;&#xFF0C;&#x7B49;&#x5F85;&#x540E;&#x7EED;&#x88AB;pop&#x540E;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540E;&#x6765;&#x4ECB;&#x7ECD;&#x7684;<code>cls-hooked</code>&#x903B;&#x8F91;&#x548C;&#x4ED6;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x73B0;&#x66F4;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x628A;&#x4ED6;&#x628A;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5B58;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>new map()</code>&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;<code>&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x4E3A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x751F;&#x6210;&#x7684;asyncId</code> &#x4F5C;&#x4E3A; key &#x6765;&#x533A;&#x5206;&#x3002;&#x4E0D;&#x8FC7;&#x4E3A;&#x4E86;&#x5D4C;&#x5957;&#x80FD;&#x529B;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x4F9D;&#x65E7;&#x4FDD;&#x7559;&#x3002;</p>
<p>&#x867D;&#x7136;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x5DF2;&#x7ECF;&#x5728;&#x201D;&#x5386;&#x53F2;&#x7684;&#x5783;&#x573E;&#x5806;&#x201D;&#x91CC;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x91CC;&#x9762; API &#x7684;&#x8BBE;&#x8BA1;&#x548C;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x7684;&#x8FD8;&#x662F;&#x503C;&#x5F97;&#x4E00;&#x770B;&#xFF0C;&#x56E0;&#x4E3A;&#x4E4B;&#x540E;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x6CBF;&#x7528;&#x7684;&#x7C7B;&#x4F3C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;</p>
<p>&#x90A3;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x770B;&#x4E0B;&#x4E00;&#x4E2A;API&#x7684;&#x53D1;&#x5E03;</p>
<h2 id="2017&#x5E74;&#xFF1A;async-hooks"><a href="#2017&#x5E74;&#xFF1A;async-hooks" class="headerlink" title="2017&#x5E74;&#xFF1A;async_hooks"></a>2017&#x5E74;&#xFF1A;async_hooks</h2><blockquote>
<p><code>async_hooks</code>&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x4E09;&#x65B9;&#x5E93;&#xFF0C;&#x800C;&#x662F;&#x4E00;&#x4E2A;Node build-in&#x7684;module&#xFF0C;&#x4F9B;&#x7528;&#x6237;&#x8C03;&#x7528;&#x3002;</p>
</blockquote>
<p>The async_hooks API was released in Node.js 8.x in 2017</p>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x901A;&#x8FC7; hook &#x53EF;&#x4EE5;&#x5F80; async call &#x7684;&#x5404;&#x4E2A;&#x9636;&#x6BB5;&#x6CE8;&#x518C;&#x65B9;&#x6CD5;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684;React&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x4E00;&#x65E0;&#x4E8C;&#x7684;<code>asyncId</code>&#xFF0C;&#x6240;&#x4EE5;&#x57FA;&#x4E8E;&#x6B64;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6211;&#x4EEC;&#x7684;&#x5F02;&#x6B65;&#x76D1;&#x542C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;const asyncHooks = require(&apos;async-hooks&apos;)</span><br><span class="line">const asyncHook = asyncHooks.createHook({</span><br><span class="line">  init: (asyncId, type, triggerAsyncId, resource) =&gt; {},</span><br><span class="line">  before: asyncId =&gt; {},</span><br><span class="line">  after: asyncId =&gt; {},</span><br><span class="line">  destroy: asyncId =&gt; {},</span><br><span class="line">  promiseResolve: asyncId =&gt; {},</span><br><span class="line">})</span><br><span class="line">asyncHook.enable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// init() is called during object construction. The resource may not have</span><br><span class="line">// completed construction when this callback runs. Therefore, all fields of the</span><br><span class="line">// resource referenced by &quot;asyncId&quot; may not have been populated.</span><br><span class="line">function init(asyncId, type, triggerAsyncId, resource) { }</span><br><span class="line"></span><br><span class="line">// before() is called just before the resource&apos;s callback is called. It can be</span><br><span class="line">// called 0-N times for handles (such as TCPWrap), and will be called exactly 1</span><br><span class="line">// time for requests (such as FSReqCallback).</span><br><span class="line">function before(asyncId) { }</span><br><span class="line"></span><br><span class="line">// after() is called just after the resource&apos;s callback has finished.</span><br><span class="line">function after(asyncId) { }</span><br><span class="line"></span><br><span class="line">// destroy() is called when the resource is destroyed.</span><br><span class="line">function destroy(asyncId) { }</span><br></pre></td></tr></table></figure>

<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>&#x5177;&#x4F53;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x6700;&#x540E;&#x7684;&#x5EF6;&#x5C55;&#x7AE0;&#x8282;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x4E86;</p>
<h2 id="2017&#x5E74;&#xFF1A;cls-hooked"><a href="#2017&#x5E74;&#xFF1A;cls-hooked" class="headerlink" title="2017&#x5E74;&#xFF1A;cls-hooked"></a>2017&#x5E74;&#xFF1A;cls-hooked</h2><p>&#x5728;2017&#x5E74;&#xFF0C;async_hooks&#x53D1;&#x5E03;&#x540E;&#xFF0C;Jeff Lewis &#x8FD9;&#x4F4D;&#x8001;&#x5144;&#x9A6C;&#x4E0D;&#x505C;&#x8E44;&#x5730;&#x5C06;&#x8001;&#x4ED3;&#x5E93;fork&#x51FA;&#x6765;&#xFF0C;&#x91CD;&#x65B0;&#x7528;&#x6700;&#x65B0;&#x7684; async_hooks &#x91CD;&#x5199;&#x4E86; CLS&#x3002;&#x7531;&#x4E8E;&#x91CD;&#x5199;&#x540E; API &#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53D8;&#x5316;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x5217;&#x4E3E;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E86;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4ED6;&#x7684; <code>README</code></p>
<blockquote>
<p>This is a fork of <a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">CLS</a> using <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> OR <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> instead of <a href="/external_links/688d0de2171d760751ff9c148c702be3.html" target="blank" rel="noopener">async-listener</a>.</p>
<p>When running Nodejs version &lt; 8, this module uses <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> which is an unsupported Nodejs API, so please consider the risk before using it.</p>
<p>When running Nodejs version &gt;= 8.2.1, this module uses the newer <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> API which is considered <strong>Experimental</strong> by Nodejs.</p>
</blockquote>
<p>&#x4ECE;&#x4ED6;&#x7684; <code>README</code> &#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Node&#x7248;&#x672C;&#x5C0F;&#x4E8E;8&#x7684;&#xFF0C;&#x4F7F;&#x7528;&#x4E86; AsyncWrap&#xFF0C;&#x800C;Node&#x7248;&#x672C;&#x5927;&#x4E8E;8.2.1&#x7684;&#x5219;&#x7528;async_hooks&#x91CD;&#x5199;&#x4E86;&#x3002;</p>
<p>&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x4ED6;&#x7528; <code>Experimental</code>&#x6765;&#x63CF;&#x8FF0;&#x6B64;API&#xFF0C;&#x81EA;&#x7136;&#x800C;&#x7136;&#x6211;&#x4EEC;&#x5230; Nodejs &#x7684;&#x5B98;&#x7F51;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E0D;&#x518D;&#x88AB;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x3002;&#x539F;&#x56E0;&#x662F;&#x53EF;&#x7528;&#x6027;&#x3001;&#x5B89;&#x5168;&#x6027;&#x3001;&#x4EE5;&#x53CA;&#x6027;&#x80FD;&#x8868;&#x73B0;&#x90FD;&#x6709;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x4F60;&#x60F3;&#x4F7F;&#x7528; Async Context Tracking &#x7684;&#x80FD;&#x529B;&#xFF0C;&#x53D6;&#x800C;&#x4EE3;&#x4E4B;&#x7684;&#x5E94;&#x8BE5;&#x662F; <code>AsyncLocalStorage</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x56E0;&#x4E3A;&#x662F; ALS &#x505A;&#x4E86;&#x9002;&#x5F53;&#x7684;&#x4F18;&#x5316;&#x5E76;&#x4E14;&#x8BED;&#x6CD5;&#x66F4;&#x7B80;&#x6D01;</p>
<blockquote>
<p>Stability: 1 - Experimental. Please migrate away from this API, if you can. We do <strong>not</strong> recommend using the createHook, AsyncHook, and executionAsyncResource APIs as they have usability issues, safety risks, and performance implications. Async context tracking use cases are better served by the stable <strong>AsyncLocalStorage</strong> API.</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4e394fb3ecc3c17de3e353cf678a0b77487fe35285a9b8af5f8dfc32c7e5ee65" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>Node&#x6587;&#x6863;&#x4E2D;&#xFF0C;API&#x7684;&#x7A33;&#x5B9A;&#x6027;&#xFF08;&#x5C31;&#x662F;&#x544A;&#x8BC9;&#x4F60;&#x6562;&#x4E0D;&#x6562;&#x7528;&#x8FD9;&#x4E2A; API&#xFF09;&#x6709;&#x5206;&#x7EA7;</p>
<p>&#x5373;<code>Stability index</code>&#x88AB;&#x5206;&#x4E3A;&#x4E86;4&#x6863;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;</p>
<ul>
<li>Stability: 0 - Deprecated</li>
<li>Stability: 1 - Experimental</li>
<li>Stability: 2 - Stable</li>
<li>Stability: 3 - Legacy</li>
</ul>
<p>&#x6211;&#x4EEC;&#x7684; async_hooks &#x88AB;&#x5F52;&#x5230;&#x4E86; Experimental&#xFF0C;<code>&#x5728;&#x672A;&#x6765;&#x7684;&#x4EFB;&#x4F55;&#x7248;&#x672C;&#x4E2D;&#x90FD;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x975E;&#x5411;&#x540E;&#x517C;&#x5BB9;&#x7684;&#x53D8;&#x5316;&#x6216;&#x5220;&#x9664;&#x3002;&#x4E0D;&#x5EFA;&#x8BAE;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;</code>&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x4EFB;&#x4F55;&#x7EBF;&#x4E0A;&#x73AF;&#x5883;&#x90FD;&#x53EA;&#x4F7F;&#x7528; Statbility:2 - Stable &#x5C31;&#x597D;&#x3002;</p>
<h2 id="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"><a href="#2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;" class="headerlink" title="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"></a>2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;</h2><p>AsyncLocalStorage was first introduced in Node.js version 12.0.0, released on April 23, 2019.</p>
<p>&#x56E0;&#x4E3A;AsyncLocalStorage (ALS) &#x7684;&#x9700;&#x6C42;&#x5F3A;&#x70C8;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5B9E;&#x9A8C;&#x540E;&#xFF0C;ALS&#x7EC8;&#x4E8E;&#x5728; Node v13.10.0 &#x5B8C;&#x6574;&#x652F;&#x6301;&#x4E86;&#xFF0C;&#x968F;&#x540E; API &#x8FC1;&#x79FB;&#x5230;&#x4E86;&#x957F;&#x671F;&#x652F;&#x6301;&#x7248;&#x672C; Node v12.17.0</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0440a7ec9c3e4ae1819413914bfe7196a1af2a491f399ade0291d8179c778da4" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x56E0;&#x4E3A;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;API&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x4E5F;&#x5938;&#x4E86;&#x4E0D;&#x5C11;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4ECE;&#x5176;&#x4ED6;&#x89D2;&#x5EA6;&#x6765;&#x9610;&#x8FF0;&#x4E0B;</p>
<p><strong>&#x6027;&#x80FD;&#x95EE;&#x9898;</strong></p>
<p>AsyncLocalStorage &#x76F4;&#x63A5;&#x57FA;&#x4E8E; async_hooks &#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x3002;&#x800C; async_hooks &#x5BF9;&#x4E8E;&#x6027;&#x80FD;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x5728;&#x9AD8;&#x5E76;&#x53D1;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x5927;&#x5BB6;&#x5BF9;&#x6B64; API &#x4FDD;&#x6301;&#x4E86;&#x8C28;&#x614E;&#x7684;&#x6001;&#x5EA6;&#x3002;</p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/6f76ee04dc2a41d55ed6ec8653f3fcec.html" target="blank" rel="noopener">github.com/bmeurer/asy&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d6835046c3c728f13ce977774869f58514f4914567005e70519950c3823abf5" alt="image.png"></p>
<p>&#x540C;&#x65F6;&#xFF0C;Node &#x7684; issue &#x91CC;&#x9762;&#x4E5F;&#x6709;&#x5927;&#x91CF;&#x5BF9;&#x6B64;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x4E2A;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">&#x300A;AsyncLocalStorage kills 97% of performance in an async environment #34493&#x300B;</a></p>
<p>&#x672C;&#x6765;Node&#x7684;&#x6027;&#x80FD;&#x5C31;&#x662F;&#x4ED6;&#x7684;&#x77ED;&#x677F;&#xFF08;&#x6216;&#x8005;&#x8BF4;&#x8FD9;&#x4E8B;&#x56E0;&#x4E3A;&#x4ED6;&#x7684;&#x7279;&#x8D28;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#xFF09;&#xFF0C;&#x73B0;&#x5728;&#x7528;&#x4E0A;ALS&#x540E;&#x6027;&#x80FD;&#x53C8;&#x53D8;&#x5DEE;&#x4E86;&#x4E0D;&#x5C11;&#xFF0C;&#x81EA;&#x7136;&#x4F1A;&#x8BA9;&#x4EBA;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5BF9;&#x4ED6;&#x656C;&#x800C;&#x8FDC;&#x4E4B;&#xFF0C;&#x6240;&#x4EE5;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5462;&#xFF1F;</p>
<p><strong>&#x540E;&#x7EED;&#x66F4;&#x65B0;</strong></p>
<p>&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x8001;&#x5927;&#x54E5; V8 &#x51FA;&#x624B;&#x4E86;&#xFF0C;&#x6211;&#x501F;&#x7ED9;&#x4F60;&#x4E00;&#x4E2A; V8 &#x7684; API &#x7528;&#x5427;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x76D1;&#x542C;&#x6211;&#x7684; Promise lifecycle</p>
<p>&#x8FD9;&#x5C31;&#x662F; v8::Context PromiseHook API&#x3002;&#x8FD9;&#x4E2A; Hook &#x88AB;&#x52A0;&#x5165; V8 &#x540E;&#xFF0C;&#x5F88;&#x5FEB;&#x88AB; <a href="/external_links/706a78c569161016581eebbc66a99d27.html" target="blank" rel="noopener">Stephen Belanger</a> &#x52A0;&#x5165;&#x5230;&#x4E86; async_hooks</p>
<p>&#x8FD9;&#x662F;&#x5F15;&#x5165; PromiseHook &#x7684; PR &#x5730;&#x5740;&#xFF1A;<a href="/external_links/91da14a86e1b4f6cd2f94e947848e1eb.html" target="blank" rel="noopener">PR: async_hooks: use new v8::Context PromiseHook API #36394</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6a45a352587f4dc1e58ec99514f8955ca1c7f6d6538cb184865c599abdb8f6d" alt="image.png"></p>
<p>&#x7136;&#x540E;&#xFF0C;&#x4ECE;21&#x5E74;5&#x6708;&#x8FD9;&#x4E2A;&#x8BC4;&#x8BBA;&#x91CC;&#x9762;&#x5C31;&#x80FD;&#x770B;&#x51FA;&#xFF0C;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">github.com/nodejs/node&#x2026;</a>&#xFF0C;&#x5728;V8&#x7684;&#x52A0;&#x6301;&#x4E0B;&#xFF0C;&#x5728; Node v16.2.0 &#x7684;&#x7248;&#x672C;&#x91CC;&#xFF0C;ALS&#x7684;&#x6027;&#x80FD;&#x201D;&#x5927;&#x5E45;&#x201D;&#x63D0;&#x5347;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/63210224001af4e04afb287cfbba4bab36fef05ae575f0457d20dcce0a2ca191" alt="image.png"></p>
<h2 id="&#x5C0F;&#x7ED3;-1"><a href="#&#x5C0F;&#x7ED3;-1" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x6211;&#x4EEC;&#x5B8C;&#x6210;&#x4E86;2&#x548C;3&#xFF0C;&#x540C;&#x65F6;&#x62D3;&#x5C55;&#x4E86;&#x4E9B;&#x7C7B;&#x4F3C;&#x7684;&#x573A;&#x666F;&#x548C;&#x7528;&#x6CD5;</p>
<ul>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
</ul>
<p>&#x901A;&#x8FC7;&#x6B64;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x8F74;&#x753B;&#x4E00;&#x5F20;&#x56FE;&#x51FA;&#x6765;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/3e1d3b38e1e7e8075a119a3b5337234f407feb5dfda92faaab344525995cc994" alt="image.png"></p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8FD9;&#x5E45;&#x56FE;&#x5DF2;&#x7ECF;&#x9610;&#x8FF0;&#x4E86;&#x5927;&#x81F4;&#x7684;&#x53D1;&#x5C55;&#x7684;&#x5386;&#x53F2;</p>
<p>&#x800C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x4E4B;&#x524D;&#x4ECE;&#x672A;&#x63D0;&#x53CA;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x4E5F;&#x5F15;&#x51FA;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x88AB;&#x5199;&#x51FA;&#x7684;&#x539F;&#x56E0;<code>AsyncContext</code>&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BF4;&#xFF0C;&#x6700;&#x603B;&#x7ED3;&#x7684;&#x65F6;&#x5019;&#x8BF4;&#x5427;</p>
<h1 id="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;"><a href="#&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;" class="headerlink" title="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;"></a>&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;</h1><blockquote>
<p>&#x7531;&#x963F;&#x91CC;&#x5DF4;&#x5DF4; TC39 &#x4EE3;&#x8868;&#x4E3B;&#x5BFC;&#x7684; <a href="/external_links/f44d0aeb1204b34bfe7e868bfb06412a.html" target="blank" rel="noopener">Async Context &#x63D0;&#x6848;</a> &#x521A;&#x5728; 2023&#x5E74; 2 &#x6708;&#x521D;&#x7684; TC39 &#x4F1A;&#x8BAE;&#x4E2D;&#x6210;&#x4E3A;&#x4E86; TC39 Stage 1 &#x63D0;&#x6848;&#x3002;&#x63D0;&#x6848;&#x7684;&#x76EE;&#x6807;&#x662F;&#x5B9A;&#x4E49;&#x5728; JavaScript &#x7684;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x4E2D;&#x4F20;&#x9012;&#x6570;&#x636E;&#x7684;&#x65B9;&#x6848;&#x3002;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x5927;&#x5BB6;&#x4E5F;&#x80FD;&#x5F88;&#x5FEB;&#x660E;&#x767D;&#x65B0;&#x7684; TC39 &#x63D0;&#x6848;<code>AsyncContext</code>&#x662F;&#x5728;&#x505A;&#x4EC0;&#x4E48;&#x3002;</p>
<p>&#x5BF9;&#x6BD4;&#x4E24;&#x8005;&#x7684;API&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>AsyncContext</code>&#x7ED3;&#x5408;&#x4E86;<code>AsyncLocalStorage</code>&#x548C;<code>AsyncResource</code>&#xFF0C;&#x5E76;&#x7528;&#x4E86;&#x66F4;&#x901A;&#x7528;&#x7684;&#x540D;&#x5B57;<code>context</code>&#x6765;&#x6307;&#x4EE3;&#x540E;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x7684;&#x7ED3;&#x5408;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// ======= TC39&#x63D0;&#x6848;: AsyncContext =======</span><br><span class="line">class AsyncContext&lt;T&gt; {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6240;&#x6709; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x3002;</span><br><span class="line">  // &#x5F53;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6267;&#x884C;&#x65F6;&#xFF0C;&#x4F1A;&#x5C06; AsyncContext &#x72B6;&#x6001;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  static wrap&lt;R&gt;(fn: (...args: any[]) =&gt; R): (...args: any[]) =&gt; R;</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06; value &#x8BBE;&#x7F6E;&#x4E3A;&#x5F53;&#x524D; </span><br><span class="line">  // AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x503C;&#x4F1A;&#x5728; fn &#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x8D77;&#x7684;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x4E2D;&#x88AB;</span><br><span class="line">  // &#x5FEB;&#x7167;&#xFF08;&#x76F8;&#x5F53;&#x4E8E; wrap&#xFF09;&#x3002;</span><br><span class="line">  run&lt;R&gt;(value: T, fn: () =&gt; R): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F53;&#x524D; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;</span><br><span class="line">  get(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ======= Node API: AsyncLocalStorage =======</span><br><span class="line">class AsyncLocalStorage&lt;T&gt; {</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; callback&#xFF0C;&#x5E76;&#x5728; callback &#x6267;&#x884C;&#x671F;&#x95F4;&#x8BBE;&#x7F6E;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x503C;&#x3002;</span><br><span class="line">  run&lt;R&gt;(store: T, callback: (...args: any[]) =&gt; R, ...args: any[]): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5F53;&#x524D;&#x503C;</span><br><span class="line">  getStore(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">class AsyncResource {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x7684;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  runInAsyncScope&lt;R&gt;(fn: (...args: any[]) =&gt; R, thisArg, ...args: any[]): R;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;&#x8FD9;&#x91CC;&#x56DE;&#x7B54;&#x4E0B;&#x8FD9;&#x7AE0;&#x7684;&#x6807;&#x9898;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684;&#x5173;&#x7CFB;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x662F;</p>
<ul>
<li>AsyncLocalStorage&#x662F;Node&#x7684;API&#xFF1B;&#x4E0D;&#x662F;&#x6807;&#x51C6;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A; runtime &#x7684; API</li>
<li>AsyncContext&#x662F;EMACScript&#x6807;&#x51C6;(&#x5982;&#x679C;&#x901A;&#x8FC7;)&#xFF1B;&#x901A;&#x8FC7;&#x540E;&#x5C06;&#x6210;&#x4E3A;&#x89C4;&#x8303;&#xFF0C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7531;&#x5404;&#x79CD; runtime &#x914D;&#x5408; JS Engine &#x6765;&#x652F;&#x6301;</li>
</ul>
<p>&#x770B;&#x6765;&#x8FD9;&#x6BD4;&#x96F7;&#x950B;&#x548C;&#x96F7;&#x950B;&#x5854;&#x7684;&#x5173;&#x7CFB;&#x66F4;&#x8FD1;&#x4E9B;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x4E3A;&#x4E86;&#x8BA9; ECMA &#x6807;&#x51C6;&#x80FD;&#x540C;&#x65F6;&#x80FD;&#x517C;&#x5BB9;Node&#x7684;API&#xFF08;&#x56E0;&#x4E3A;&#x6807;&#x51C6;&#x548C;&#x76EE;&#x524D;&#x7684;API&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5230;&#x65F6;&#x5019;&#x53C8;&#x5F97;&#x6539;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x541E;&#x541E;&#x8001;&#x5E08;&#x7684;&#x63D0;&#x6848;&#x8BA9; AsyncContext &#x7684;&#x8BED;&#x6CD5;&#x548C; AsyncLocalStorage &#x975E;&#x5E38;&#x63A5;&#x8FD1;</p>
<h1 id="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"><a href="#&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"></a>&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;</h1><p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x4E0B;&#x540C;&#x884C;&#x90FD;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#xFF0C;&#x5927;&#x5BB6;&#x770B;&#x770B;&#x95E8;&#x9053;&#xFF0C;&#x6211;&#x4E5F;&#x770B;&#x4E2A;&#x70ED;&#x95F9;</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>&#x4F7F;&#x7528; ThreadLocal &#x6765;&#x5904;&#x7406;&#x7EBF;&#x7A0B;&#x5185;&#x7684;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class TraceIdFilter implements Filter {</span><br><span class="line"></span><br><span class="line">    private static final String TRACE_ID_HEADER = &quot;X-Trace-Id&quot;;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;String&gt; TRACE_ID = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)</span><br><span class="line">            throws IOException, ServletException {</span><br><span class="line">        HttpServletRequest httpRequest = (HttpServletRequest) request;</span><br><span class="line">        String traceId = httpRequest.getHeader(TRACE_ID_HEADER);</span><br><span class="line">        if (traceId == null || traceId.isEmpty()) {</span><br><span class="line">            traceId = generateTraceId();</span><br><span class="line">        }</span><br><span class="line">        TRACE_ID.set(traceId);</span><br><span class="line">        try {</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        } finally {</span><br><span class="line">            TRACE_ID.remove();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static String getTraceId() {</span><br><span class="line">        return TRACE_ID.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private String generateTraceId() {</span><br><span class="line">        return UUID.randomUUID().toString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // Other methods for initializing and destroying the filter...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h3><p>&#x4F7F;&#x7528; thread_local &#x6765;&#x5904;&#x7406;&#x672C;&#x5730;&#x7EBF;&#x7A0B;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;iostream&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line"></span><br><span class="line">thread_local int my_thread_local;</span><br><span class="line"></span><br><span class="line">void my_thread_function() {</span><br><span class="line">    my_thread_local = std::hash&lt;std::thread::id&gt;()(std::this_thread::get_id());</span><br><span class="line">    std::cout &lt;&lt; &quot;My thread-local value is &quot; &lt;&lt; my_thread_local &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main() {</span><br><span class="line">    std::thread t1(my_thread_function);</span><br><span class="line">    std::thread t2(my_thread_function);</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>&#x540C;&#x4E0A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">py&#x590D;&#x5236;&#x4EE3;&#x7801;import threading</span><br><span class="line"></span><br><span class="line">my_thread_local = threading.local()</span><br><span class="line"></span><br><span class="line">def my_thread_function():</span><br><span class="line">    my_thread_local.value = threading.get_ident()</span><br><span class="line">    print(f&quot;My thread-local value is {my_thread_local.value}&quot;)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=my_thread_function)</span><br><span class="line">t2 = threading.Thread(target=my_thread_function)</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br></pre></td></tr></table></figure>

<h1 id="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"></a>&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;</h1><p>&#x4E0B;&#x9762;&#x4E24;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x591A;&#x8D70;&#x4FE9;&#x6B65;&#xFF0C;&#x4ECB;&#x7ECD;&#x548C;&#x8BA8;&#x8BBA;&#x4E0B;&#x8FD9;&#x4E9B; API &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x5E0C;&#x671B;&#x6307;&#x6B63;&#x3002;</p>
<blockquote>
<p>&#x56E0;&#x4E3A;&#x5177;&#x4F53;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x4F1A;&#x548C; Node &#x7684;&#x7248;&#x672C;&#x6709;&#x5F3A;&#x76F8;&#x5173;</p>
<p>&#x6240;&#x4EE5;&#x7279;&#x522B;&#x58F0;&#x660E;&#xFF1A;&#x4E0B;&#x9762;&#x7684;&#x6587;&#x6863;&#x3001;&#x4EE3;&#x7801;&#x90FD;&#x4EE5; <strong>Node v16.x LTS</strong> (Long-term Support) &#x4E2D;&#x7684;&#x6587;&#x6863;&#x548C;&#x4EE3;&#x7801;&#x4E3A;&#x4F8B;&#x3002;</p>
</blockquote>
<h2 id="I-Wonder-Where-the-API-Comes-From"><a href="#I-Wonder-Where-the-API-Comes-From" class="headerlink" title="I Wonder Where the API Comes From"></a>I Wonder Where the API Comes From</h2><p>&#x8981;&#x60F3;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;API&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x8BFB;&#x6587;&#x6863;</p>
<p><a href="/external_links/664de0d336dbe22f94ea8fc636ae5876.html" target="blank" rel="noopener">nodejs.org/docs/latest&#x2026;</a></p>
<p>&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x6587;&#x6863;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;API&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x662F;&#x5374;&#x900F;&#x9732;&#x4E86;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x4FE1;&#x606F;&#xFF0C;source code &#x6765;&#x81EA;<code>lib/async_hook.js</code></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0a02586a931534dafb9e51e01ab042a798a29318da44f3547f84e3b18e00a4a0" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a99ea1bac5616fc973b92571f342f503fd686f3035cc42b371621f724058a731" alt="image.png"><br>&#x6240;&#x4EE5;&#x987A;&#x7406;&#x6210;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x63A2;&#x7D22;</p>
<p>&#x63A2;&#x7D22;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x5148;&#x5927;&#x6982;&#x4ECB;&#x7ECD;&#x4E0B; nodejs &#x9879;&#x76EE;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</p>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x548C;&#x6784;&#x5EFA;&#x6587;&#x4EF6;&#x54B1;&#x5148;&#x4E0D;&#x770B;&#xFF0C;&#x54B1;&#x4EEC;&#x770B;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x4E09;&#x4E2A;&#x6587;&#x4EF6;&#x5939;<code>deps</code>&#x3001;<code>lib</code>&#x3001;<code>src</code></p>
<table>
<thead>
<tr>
<th><strong>&#x540D;&#x5B57;</strong></th>
<th><strong>&#x8BF4;&#x660E;</strong></th>
<th><strong>&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x8BED;&#x8A00;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>deps</td>
<td>&#x5305;&#x542B; Node.js &#x4F7F;&#x7528;&#x7684;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#xFF0C;&#x5305;&#x62EC; V8 &#x5F15;&#x64CE;&#x548C; libuv &#x5E93;&#x7B49;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F; node_modules</td>
<td>C++/C</td>
</tr>
<tr>
<td>lib</td>
<td>&#x5305;&#x542B; Node.js &#x6838;&#x5FC3;&#x5E93;&#x6587;&#x4EF6;&#xFF0C;&#x5305;&#x62EC;&#x7528;&#x4E8E;&#x5904;&#x7406; I/O &#x64CD;&#x4F5C;&#x3001;&#x7F51;&#x7EDC;&#x548C;&#x5176;&#x4ED6;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#x7684;&#x6A21;&#x5757;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x6838;&#x5FC3;&#x5E93;&#x7684;JS&#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x4F5C;&#x4E3A;API&#x63D0;&#x4F9B;&#x7ED9;Nodejs&#x4F7F;&#x7528;&#x3002;&#x6BD4;&#x5982;&#x54B1;&#x4EEC;&#x719F;&#x6089;&#x7684; require(http) &#x5C31;&#x662F;&#x5F15;&#x7528;&#x7684; <code>lib/http.js</code></td>
<td>Javascript</td>
</tr>
<tr>
<td>src</td>
<td>&#x5305;&#x542B; Node.js &#x7684; C++ &#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x5305;&#x62EC;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x5982;&#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;&#x3001;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x548C; HTTP &#x670D;&#x52A1;&#x5668;&#x3002;C++&#x6838;&#x5FC3;&#x6A21;&#x5757;</td>
<td>C++</td>
</tr>
</tbody></table>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x6B65;&#x6B65;&#x6765;&#x68B3;&#x7406; AsyncLocalStorage API&#x2019;s calling chain</p>
<h2 id="Javascript-Zone"><a href="#Javascript-Zone" class="headerlink" title="Javascript Zone"></a>Javascript Zone</h2><p>OK&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x5927;&#x6982;&#x77E5;&#x9053;&#x4E86;&#x7684; <code>AsyncLocalStorage</code>API &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF0C;&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x6253;&#x5F00; <code>async_hooks.js</code>&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 1. &#x771F;&#x6B63;&#x7684;&#x50A8;&#x5B58;&#x4F4D;&#x7F6E;</span><br><span class="line">const storageList = [];</span><br><span class="line">const storageHook = createHook({</span><br><span class="line">  init(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">    const currentResource = executionAsyncResource();</span><br><span class="line">    // Value of currentResource is always a non null object</span><br><span class="line">    for (let i = 0; i &lt; storageList.length; ++i) {</span><br><span class="line">      storageList[i]._propagate(resource, currentResource);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">function createHook(fns) {</span><br><span class="line">  return new AsyncHook(fns);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 2. ALS Class &#x7684;&#x5B9E;&#x73B0;</span><br><span class="line">class AsyncLocalStorage {</span><br><span class="line">  constructor() {</span><br><span class="line">    this.kResourceStore = Symbol(&apos;kResourceStore&apos;);</span><br><span class="line">    this.enabled = false;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  _enable() {</span><br><span class="line">    if (!this.enabled) {</span><br><span class="line">      this.enabled = true;</span><br><span class="line">      ArrayPrototypePush(storageList, this);</span><br><span class="line">      storageHook.enable();</span><br><span class="line">		}</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  run(store, callback, ...args) {</span><br><span class="line">    // Avoid creation of an AsyncResource if store is already active</span><br><span class="line">    if (ObjectIs(store, this.getStore())) {</span><br><span class="line">      return ReflectApply(callback, null, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    this._enable();</span><br><span class="line"></span><br><span class="line">    // &#x65B0;&#x8001; resource &#x4EA4;&#x63A5;&#x73ED;</span><br><span class="line">    const resource = executionAsyncResource(); // &#x65B0;&#x7684;resource</span><br><span class="line">    const oldStore = resource[this.kResourceStore];  // &#x8001;&#x7684;resource</span><br><span class="line"></span><br><span class="line">    resource[this.kResourceStore] = store; // &#x65B0;&#x7684;resource&#xFF0C;traceId&#x5B58;&#x653E;&#x7684;&#x5730;&#x65B9;</span><br><span class="line"></span><br><span class="line">    try {</span><br><span class="line">      return ReflectApply(callback, null, args); </span><br><span class="line">    } finally {</span><br><span class="line">      resource[this.kResourceStore] = oldStore; // &#x7B49;callback&#x6267;&#x884C;&#x7ED3;&#x675F;&#xFF0C;&#x5C06;&#x8001;&#x7684;oldStore&#x5F52;&#x8FD8;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  getStore() {</span><br><span class="line">    if (this.enabled) {</span><br><span class="line">      const resource = executionAsyncResource();</span><br><span class="line">      return resource[this.kResourceStore];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4E86;&#x4FBF;&#x4E8E;&#x9605;&#x8BFB;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5220;&#x53BB;&#x4E86;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FD0;&#x884C; <code>AsyncLocalStorage.run(callback)</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x6267;&#x884C;2&#x4E2A;&#x52A8;&#x4F5C;&#xFF1A;</p>
<p>&#x53C2;&#x7167;&#x4E0B;&#x9762;&#x7684;API&#x8C03;&#x7528;&#x4EE3;&#x7801;&#x6765;&#x770B;</p>
<ul>
<li><code>this._enable()</code>&#xFF0C;&#x6FC0;&#x6D3B; hook &#x76D1;&#x542C;</li>
<li>&#x901A;&#x8FC7; <code>executionAsyncResource()</code>&#xFF0C;&#x83B7;&#x5F97;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8D44;&#x6E90;<code>resource</code>&#xFF08;AsyncResource&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;V8&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;AsyncResource&#xFF09;</li>
<li>&#x7136;&#x540E;&#x628A;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; store &#x5F53;&#x505A;<code>resource</code>&#x91CC;<code>kResourceStore</code>&#x5BF9;&#x5E94;&#x7684;&#x503C;&#xFF08;store&#x5C31;&#x662F;traceId&#xFF0C;kResourceStore&#x5C31;&#x662F;&#x4E00;&#x4E2A;Symbol&#x800C;&#x5DF2;&#xFF09;</li>
<li>&#x7136;&#x540E;&#x624D;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684;callback&#x4EE3;&#x7801;<code>ReflectApply(callback, null, args)</code>&#x3002;&#x5176;&#x4E2D;<code>ReflectApply</code>&#x76F4;&#x63A5;&#x7406;&#x89E3;&#x4E3A;JS&#x4E2D;&#x7684;<code>Function.Apply()</code>&#x3002;</li>
<li>&#x4E4B;&#x540E;&#x8FD9;&#x4E2A; run &#x65B9;&#x6CD5;&#x91CC;&#x9762;&#xFF0C;&#x4EFB;&#x4F55;&#x901A;&#x8FC7;<code>executionAsyncResource()</code>&#x5F97;&#x5230;&#x7684;&#x503C;&#x90FD;&#x662F;&#x6211;&#x4EEC;&#x1F446;&#x1F3FB;&#x4E0A;&#x9762;&#x7684; <code>traceId</code></li>
<li>&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>getStore()</code>&#x62FF;&#x5230;&#x8FD9;&#x4E2A;<code>traceId</code>&#xFF0C;&#x5B8C;&#x7F8E;&#xFF01;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">  console.log(asyncLocalStorage.getStore())</span><br><span class="line">  setImmediate(() =&gt; {</span><br><span class="line">    console.log(asyncLocalStorage.getStore())</span><br><span class="line">  })</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">asyncLocalStorage.run(&apos;test&apos;, () =&gt; {})</span><br></pre></td></tr></table></figure>

<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#x57FA;&#x4E8E;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;<code>ALS.run()</code>&#x91CC;&#x9762;&#x7684;callback&#x540C;&#x6B65;&#x8BF7;&#x6C42;&#x90FD;&#x53EF;&#x4EE5;&#x987A;&#x5229;&#x62FF;&#x5230;&#x5BF9;&#x5E94;&#x7684;<code>store</code>&#xFF0C;&#x4F46;&#x662F;&#x5F02;&#x6B65;&#x7684;&#x8BF7;&#x6C42;&#x6BCF;&#x6B21;&#x4F1A;&#x65B0;&#x5EFA; <code>AsyncResource</code>&#x3002;&#x6240;&#x4EE5;&#x62FF;&#x4E0D;&#x5230;&#x4E0A;&#x9762;&#x7684; store</p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x6765;&#x770B;<code>storageHook</code>&#x53D8;&#x91CF;&#xFF0C;&#x4ED6;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; Hook &#x6765;&#x76D1;&#x542C; init &#x4E8B;&#x4EF6;&#xFF0C;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x7684;&#x5F02;&#x6B65;&#x8D44;&#x6E90;(AsyncResource)&#x7684;&#x503C;&#x4F20;&#x7ED9;&#x6211;&#x4EEC;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x547D;&#x540D;&#x5B83;&#x4E3A;&#x5F02;&#x6B65;A&#x3002;&#x6240;&#x4EE5;&#x5728;&#x4E0D;&#x4E45;&#x7684;&#x5C06;&#x6765;&#xFF0C;&#x5F02;&#x6B65;A&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>asyncLocalStorage.getStore()</code>&#x53EF;&#x4EE5;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684;&#x503C;</p>
<p>&#x7ED3;&#x8BBA;&#xFF0C;ALS&#x4E5F;&#x662F;&#x57FA;&#x4E8E;AsyncHook&#x548C;&#x795E;&#x79D8;&#x7684;<code>executionAsyncResource</code>&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x4F46;&#x662F;&#x4ED6;&#x53EA;&#x4F7F;&#x7528;&#x4E86; init Hook&#xFF0C;&#x800C;&#x4E14;&#x5C01;&#x88C5;&#x7684;&#x5F88;&#x597D;&#xFF0C;&#x6240;&#x4EE5;&#x6027;&#x80FD;&#x548C;&#x53EF;&#x7528;&#x6027;&#x90FD;&#x66F4;&#x597D;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x770B; <code>AsyncHook</code>&#x90FD;&#x66F4;&#x53EF;&#x7591;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x7AE0;&#x6211;&#x4EEC;&#x6765;&#x5206;&#x6790;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x76D1;&#x542C;&#x52AB;&#x6301;&#x4EFB;&#x4F55;&#x4E00;&#x79CD;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x8FD9;&#x4E2A;<code>run&#x65B9;&#x6CD5;</code> &#x91CC;&#x9762;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x5B9E;&#x73B0;&#x7684;&#x5F62;&#x5F0F;&#x662F;&#x901A;&#x8FC7;&#x7C7B;&#x4F3C;&#x4E8E;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B8C;&#x6210;&#x4E86;<code>&#x5D4C;&#x5957;nest</code>&#x80FD;&#x529B;</p>
<p>&#x5176;&#x5B9E;&#x4ECE;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684; commit log &#x4E2D;&#x4E5F;&#x80FD;&#x8BC1;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x731C;&#x60F3;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9aee0aaa769ea22a8b6a157e78a739a312a16595e6bde4cdc654c0a09856bce5" alt></p>
<p>&#x8FD9;&#x4E2A;&#x622A;&#x56FE;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E2A;&#x5C0F;&#x5F69;&#x86CB; Reviewed-By: Zijian Liu</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x8FD9;&#x79CD;&#x9012;&#x5F52;&#x8FD8;&#x6709;&#x70B9;&#x50CF; Leetcode &#x7ECF;&#x5178;&#x7684;&#x56DE;&#x6EAF;&#x7B97;&#x6CD5;&#x9898; <a href="/external_links/25a09439e0a56f47cfbff81fc581b659.html" target="blank" rel="noopener">51. N-Queens</a>&#xFF0C;&#x5B83;&#x5C31;&#x662F;&#x5BF9; tree &#x7684;DFS&#x904D;&#x5386;&#x3002;DFS&#x904D;&#x5386;&#x7528;&#x9012;&#x5F52;&#x5199;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x800C;&#x7528;&#x8FED;&#x4EE3;&#x5199;&#x5C31;&#x662F;&#x7528;Stack&#x4E86;</p>
<h1 id="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;"></a>&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;</h1><h2 id="Intro-and-Guess"><a href="#Intro-and-Guess" class="headerlink" title="Intro and Guess"></a>Intro and Guess</h2><p>&#x5728;&#x4E0A;&#x4E00;&#x4E2A;&#x7AE0;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0; AsyncHook &#x548C; executionAsyncResource &#x662F;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B; AsyncHook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line">class AsyncHook {</span><br><span class="line">  constructor({</span><br><span class="line">    init,</span><br><span class="line">    before,</span><br><span class="line">    after,</span><br><span class="line">    destroy,</span><br><span class="line">    promiseResolve</span><br><span class="line">  }) {</span><br><span class="line">    this[init_symbol] = init;</span><br><span class="line">    this[before_symbol] = before;</span><br><span class="line">    this[after_symbol] = after;</span><br><span class="line">    this[destroy_symbol] = destroy;</span><br><span class="line">    this[promise_resolve_symbol] = promiseResolve;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  enable() {</span><br><span class="line">    // The set of callbacks for a hook should be the same regardless of whether</span><br><span class="line">    // enable()/disable() are run during their execution. The following</span><br><span class="line">    // references are reassigned to the tmp arrays if a hook is currently being</span><br><span class="line">    // processed.</span><br><span class="line">    const {</span><br><span class="line">      0: hooks_array,</span><br><span class="line">      1: hook_fields</span><br><span class="line">    } = getHookArrays();</span><br><span class="line"></span><br><span class="line">    // Each hook is only allowed to be added once.</span><br><span class="line">    if (ArrayPrototypeIncludes(hooks_array, this))</span><br><span class="line">      return this;</span><br><span class="line"></span><br><span class="line">    const prev_kTotals = hook_fields[kTotals];</span><br><span class="line"></span><br><span class="line">    // createHook() has already enforced that the callbacks are all functions,</span><br><span class="line">    // so here simply increment the count of whether each callbacks exists or</span><br><span class="line">    // not.</span><br><span class="line">    hook_fields[kTotals] = hook_fields[kInit] += +!!this[init_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kBefore] += +!!this[before_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kAfter] += +!!this[after_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kDestroy] += +!!this[destroy_symbol];</span><br><span class="line">    hook_fields[kTotals] +=</span><br><span class="line">      hook_fields[kPromiseResolve] += +!!this[promise_resolve_symbol];</span><br><span class="line">    ArrayPrototypePush(hooks_array, this);</span><br><span class="line"></span><br><span class="line">    if (prev_kTotals === 0 &amp;&amp; hook_fields[kTotals] &gt; 0) {</span><br><span class="line">      enableHooks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    updatePromiseHookMode();</span><br><span class="line"></span><br><span class="line">    return this;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD8;&#x597D;&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E0D;&#x7B97;&#x53EF;&#x7591;&#xFF0C;&#x548C;&#x9884;&#x60F3;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x628A;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7684; hook &#x7684; callback &#x5B58;&#x8D77;&#x6765;&#x3002;&#x7136;&#x540E;&#x518D;&#x901A;&#x8FC7; enable &#x65B9;&#x6CD5;&#x6FC0;&#x6D3B;&#x4ED6;&#x4EEC;&#xFF0C;&#x90A3; line 44 &#x7684; enableHooks() &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF1F;&#x6765;&#x81EA;<code>lib/internal/async_hooks.js</code>&#xFF08;&#x662F;&#x7684;&#xFF0C;&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x539F;&#x6765;&#x6BCF;&#x4E00;&#x4E2A;lib&#x6587;&#x4EF6;&#x5939;&#x7684;API&#x8FD8;&#x8C03;&#x7528;&#x4E86;<code>lib/internal</code>&#x8FD9;&#x5C42;&#x5185;&#x90E8;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x53C8;&#x62BD;&#x8C61;&#x4E86;&#x4E00;&#x5C42;&#x51FA;&#x6765;&#x3002;&#xFF09;</p>
<p>&#x770B;&#x4E0B;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">const async_wrap = internalBinding(&apos;async_wrap&apos;);</span><br><span class="line">const { setCallbackTrampoline } = async_wrap;</span><br><span class="line"></span><br><span class="line">function enableHooks() {</span><br><span class="line">  async_hook_fields[kCheck] += 1;</span><br><span class="line"></span><br><span class="line">  setCallbackTrampoline(callbackTrampoline);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; setCallbackTrampoline&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x81EA; async_wrap&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x770B;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x8C03;&#x7528;&#x7684;&#x795E;&#x79D8;&#x7684; executionAsyncResource &#x91CC;&#x9762;&#x8C03;&#x7528;&#x7684;&#x5173;&#x952E;&#x53D8;&#x91CF;&#xFF0C;&#x51E0;&#x4E4E;&#x90FD;&#x6765;&#x81EA;<code>async_wrap</code>&#xFF0C;&#x901A;&#x8FC7; internalBinding &#x83B7;&#x53D6;&#x5230;&#x7684;&#x3002;</p>
<p>&#x65E2;&#x7136;&#x8FD9;&#x91CC;&#x7528;&#x7684;&#x662F;<code>internalBinding(String)</code>&#xFF0C;&#x5165;&#x53C2;&#x662F;&#x4E2A;string&#xFF0C;&#x518D;&#x52A0;&#x4E0A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x7136;&#x53EF;&#x4EE5;&#x731C;&#x6D4B; internalBinding &#x91CC;&#x9762;&#x8FD8;&#x6709;&#x8BB8;&#x591A;string&#x53EF;&#x4EE5;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x4E14;&#x53EF;&#x679A;&#x4E3E;&#x5B8C;&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x6CA1;&#x6709;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x4E3A;const&#x3001;enum&#x3001;&#x6216;&#x8005;symbol&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x806A;&#x660E;&#x7684;&#x4F60;&#x53BB;&#x89E3;&#x7B54;&#x4E86;&#xFF09;</p>
<p>&#x968F;&#x4FBF;&#x641C;&#x4E0B;&#xFF0C;&#x65E0;&#x6570;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x901A;&#x8FC7; <code>internalBinding</code>&#x83B7;&#x53D6;&#x5230;&#xFF0C;&#x731C;&#x6D4B;&#x9A8C;&#x8BC1;&#x7ED3;&#x675F;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e79cdd5ec76c51fed2f9131d9d1d63468dee25af205f5c74876aeec6d017630c" alt="image.png"></p>
<p>&#x4F46;&#x662F;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x9047;&#x5230;&#x4E00;&#x4E9B;&#x5C0F;&#x9EBB;&#x70E6;&#xFF0C;&#x56E0;&#x4E3A;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;<code>internalBinding</code>&#x5E76;&#x6CA1;&#x6709;&#x901A;&#x8FC7; <code>require()</code>&#x7684;&#x65B9;&#x5F0F;&#x5F15;&#x7528;&#x8FDB;&#x4EE3;&#x7801;&#xFF0C;command+&#x5DE6;&#x952E;&#x4E5F;&#x53EA;&#x80FD;&#x5230;&#x5B83;&#x7684;d.ts&#x5B9A;&#x4E49;&#x91CC;&#x9762;&#x3002;&#x611F;&#x89C9;&#x4F3C;&#x4E4E;&#x9677;&#x5165;&#x4E86;&#x6B7B;&#x80E1;&#x540C;&#x6216;&#x8005;&#x4EC0;&#x4E48;&#x9ED1;&#x9B54;&#x6CD5;&#x4E4B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// d.ts file</span><br><span class="line">declare function InternalBinding(binding: &apos;blob&apos;): {</span><br><span class="line">  createBlob(sources: Array&lt;Uint8Array | InternalBlobBinding.BlobHandle&gt;, length: number): InternalBlobBinding.BlobHandle;</span><br><span class="line">  FixedSizeBlobCopyJob: typeof InternalBlobBinding.FixedSizeBlobCopyJob;</span><br><span class="line">  getDataObject(id: string): [handle: InternalBlobBinding.BlobHandle | undefined, length: number, type: string] | undefined;</span><br><span class="line">  storeDataObject(id: string, handle: InternalBlobBinding.BlobHandle, size: number, type: string): void;</span><br><span class="line">  revokeDataObject(id: string): void;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p><a href="/external_links/94019a2c32ae2ec25e3db8f62529a519.html" target="blank" rel="noopener">github.com/nodejs/help&#x2026;</a></p>
<p>&#x7B80;&#x5355;&#x4E00;&#x641C;&#xFF0C;&#x5C31;&#x80FD;&#x641C;&#x5230;&#x95EE;&#x9898;&#x7684;&#x56DE;&#x7B54;&#xFF0C;&#x67F3;&#x6697;&#x82B1;&#x660E;&#x3002;&#xFF08;&#x5176;&#x5B9E;&#x5168;&#x5C40;&#x641C;&#x7D22;&#x4E5F;&#x80FD;&#x641C;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF09;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x6765;&#x5230;<code>lib/internal/bootstrap/loader.js</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line"></span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Set up internalBinding() in the closure.</span><br><span class="line">/**</span><br><span class="line"> * @type {InternalBinding}</span><br><span class="line"> */</span><br><span class="line">let internalBinding;</span><br><span class="line">{</span><br><span class="line">  const bindingObj = ObjectCreate(null);</span><br><span class="line">  // eslint-disable-next-line no-global-assign</span><br><span class="line">  internalBinding = function internalBinding(module) {</span><br><span class="line">    let mod = bindingObj[module];</span><br><span class="line">    if (typeof mod !== &apos;object&apos;) {</span><br><span class="line">      mod = bindingObj[module] = getInternalBinding(module);</span><br><span class="line">      ArrayPrototypePush(moduleLoadList, `Internal Binding ${module}`);</span><br><span class="line">    }</span><br><span class="line">    return mod;</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x662F;&#x7B80;&#x5316;&#x540E;&#x7684;&#x5907;&#x6CE8;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x52A0;&#x8F7D;&#x4E3A;&#x4E86; loader&#xFF0C;&#x65E2;&#x7136;&#x662F; loader &#x81EA;&#x7136;&#x8981; load &#x6587;&#x4EF6;&#xFF0C;load &#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<p>&#x7528;&#x4E8E; load built-in modules&#xFF08;&#x52A0;&#x8F7D;&#x5185;&#x90E8;&#x6A21;&#x5757;&#xFF09;&#x3002;&#x628A;C++&#x7684;&#x6A21;&#x5757;load&#x5230;js&#x91CC;&#x9762;&#x8FDB;&#x884C;&#x8C03;&#x7528;</p>
<p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;In line 30&#xFF0C;getInternalBinding &#x4E5F;&#x662F;&#x2018;&#x51ED;&#x7A7A;&#x2019;&#x51FA;&#x73B0;&#x7684;&#x3002;&#x81EA;&#x7136;&#x6211;&#x4EEC;&#x53BB;&#x641C;&#x4E0B;&#x4ED6;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c9646e201b380478add1555fb6f67723ad28add54181450934531e80a7de82de" alt="image.png"></p>
<p>&#x770B;&#x6765;&#xFF0C;getInternalBinding() &#x662F;&#x771F;&#x5728;js&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x627E;&#x4E0D;&#x5230;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x4E0D;&#x6765;&#x81EA;js&#x4E16;&#x754C;</p>
<p>Alright&#xFF0C;&#x606D;&#x559C;&#x4F60;&#xFF0C;&#x5230;&#x8FBE;C++&#x7684;&#x5730;&#x76D8;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4F7F;&#x7528; internalBinding() &#x5C06; async_wrap &#x4ECE;<code>async_wrap.cc</code>&#x52A0;&#x8F7D;&#x5230;&#x4E86; <code>async_wrap.js</code></p>
<p>&#x90A3; internalBinding &#x662F;&#x88AB;&#x5B9A;&#x4E49;&#x5728;&#x4E86; js &#x6587;&#x4EF6;&#x91CC;&#x9762;&#xFF0C;&#x53C8;&#x4E3A;&#x5565;&#x53EF;&#x4EE5;&#x88AB;&#x5168;&#x5C40;&#x8BBF;&#x95EE;&#x5230;&#xFF0C;&#x800C;&#x4E14;&#x6CA1;&#x4F7F;&#x7528; require&#x3002;&#x8FD9;&#x4E2A;&#x5728;&#x5907;&#x6CE8;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x89E3;&#x91CA;</p>
<blockquote>
<p><code>// This file is compiled as if it&apos;s wrapped in a function with arguments</code>  </p>
<p><code>// passed by node::RunBootstrapping()</code></p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x7F16;&#x8BD1;&#x4E86;&#xFF0C;&#x5C31;&#x50CF;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x4E00;&#x6837;&#x88AB;&#x4F20;&#x5165;<code>node::RunBootstrapping()</code>&#x8C03;&#x7528;&#x3002;&#x800C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Node&#x7684;<code>C++ built-in module</code>&#x7684;&#x542F;&#x52A8;&#x51FD;&#x6570;</p>
<h3 id="C-World"><a href="#C-World" class="headerlink" title="C++ World"></a>C++ World</h3><p>&#x6211;&#x4EEC;&#x56DE;&#x5230;&#x4E3B;&#x7EBF;&#xFF0C;&#x770B;&#x770B;<code>async_wrap</code>&#x5728;&#x505A;&#x4EC0;&#x4E48;&#xFF0C;&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p>&#x603B;&#x4E4B;&#xFF0C;<code>async_wrap</code>&#x88AB;<code>getInternalBinding</code>&#x7ED9;get&#x5230;&#x4E86;loader.js&#x91CC;&#x9762;&#xFF0C;&#x90A3;&#x6709;get&#x5C31;&#x4E00;&#x5B9A;&#x6709;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;set&#x6216;&#x8005;&#x8BF4;&#x6CE8;&#x518C;&#x3002;&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x653E;&#x5230;src&#x6587;&#x4EF6;&#x5939;&#x7684;&#x8FD9;&#x91CC;<code>src/async_wrap.cc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">// &#x8BE5;&#x6587;&#x4EF6;&#x7ED3;&#x5C3E;&#x5904;</span><br><span class="line">// &#x5728;node_binding.h&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x4E86;&#x5B8F;macro</span><br><span class="line">// #define NODE_MODULE_CONTEXT_AWARE_INTERNAL(modname, regfunc)</span><br><span class="line">NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize);  </span><br><span class="line">NODE_MODULE_EXTERNAL_REFERENCE(async_wrap, node::AsyncWrap::RegisterExternalReferences);</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8BE5;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x5C3E;&#x5904;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x8FD9;&#x4E2A;<code>&#x5B8F;(macro)</code>&#xFF0C;&#x6CE8;&#x518C;&#x4E86;<code>async_wrap</code>&#x3002;</p>
<p>&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x5728;&#x4EE3;&#x7801;&#x5C42;&#x9762;&#x56DE;&#x7B54;&#x4E86; <code>where set</code>async_wrap<code>is called</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;<code>&#x5185;&#x90E8;&#x6A21;&#x5757;(Internal Module)</code>&#x662F;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x6765;&#x66B4;&#x9732;&#x7ED9;js&#x4EE5;&#x4F5C;&#x8C03;&#x7528;&#x7684;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x7684; loader &#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;<code>getInternalBinding</code></p>
<p>&#x81F3;&#x4E8E;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x6DF1;&#x6316;&#x3002;</p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>-&gt; <code>NODE_MODULE_CONTEXT_AWARE_CPP</code> -&gt; &#x2026;</p>
<p>&#x81EA;&#x6B64;&#x5C0F;&#x7ED3;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;<code>async_wrap</code>&#x662F;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;<code>async_wrap</code>&#x7684;&#x884C;&#x4E3A;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x5B9A;&#x4E49;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;<code>async_wrap.cc</code>&#x5185;&#x90E8;&#x5728;&#x505A;&#x4EC0;&#x4E48;</p>
<p><strong>async_wrap.cc</strong></p>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x6709;700&#x884C;&#x5DE6;&#x53F3;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x5C31;&#x4E0D;&#x5168;&#x90E8;&#x8D34;&#x51FA;&#x6765;&#x4E86;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5728;&#x770B;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x731C;&#x4E0B;&#xFF0C;&#x4ED6;&#x5728;&#x5E72;&#x561B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x7684;&#x731C;&#x6D4B;&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x6765;&#x770B;&#xFF0C;&#x4ED6;&#x53EB;&#x505A; async wrap&#xFF0C;wrap&#x5C31;&#x662F;&#x628A;&#x6211;&#x4EEC;&#x7684;async call&#x7ED9;&#x5305;&#x4F4F;&#x4E86;&#xFF0C;&#x5305;&#x4F4F;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;&#x4EE3;&#x8868;async call&#x60F3;&#x505A;&#x4EC0;&#x4E48;&#x4E8B;&#xFF0C;&#x90FD;&#x5F97;&#x5148;&#x8FC7;&#x4E00;&#x5C42;&#x6211;wrap&#x518D;&#x8BF4;&#x3002;</p>
<p>&#x719F;&#x6089;&#x5417;&#xFF1F;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x8C13;&#x7684;&#x76D1;&#x542C;(listen)&#x3001;&#x52AB;&#x6301;(hijack)&#x3001;&#x5305;&#x88F9;(wrap)&#x3001;&#x76D1;&#x63A7;(monitor)&#xFF0C;&#x5927;&#x81F4;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x610F;&#x601D;&#x3002;wrap&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x70B9;&#x50CF;AOP&#xFF08;&#x9762;&#x5411;&#x5207;&#x9762;&#x7F16;&#x7A0B;&#xFF09;&#x3001;&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x3001;&#x4EE3;&#x7406;proxy&#x7B49;&#x4E1C;&#x897F;&#xFF0C;&#x90FD;&#x662F;&#x4E3B;&#x89C2;&#x4E0A;&#x7ED9;&#x4EBA;&#x4E00;&#x79CD;&#x5C42;(layer)&#x7684;&#x611F;&#x89C9;&#x3002;</p>
<p>&#x8BDD;&#x8BF4;&#x56DE;&#x6765;&#xFF0C;&#x5728;&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x5C31;&#x77E5;&#x9053;&#xFF0C;<code>libuv</code>&#x662F;&#x7528;C&#x5199;&#x7684;&#x5E93;&#xFF0C;&#x8D1F;&#x8D23;&#x5F02;&#x6B65;I/O&#x7B49;&#x5DE5;&#x4F5C;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x7684;&#x5C31;&#x731C;&#x6D4B;&#xFF0C;&#x4F60;&#x65E2;&#x7136;wrap&#x52AB;&#x6301;async call&#xFF0C;&#x90A3;&#x5177;&#x4F53;&#x662F;&#x52AB;&#x6301;&#x4EC0;&#x4E48;&#x5462;&#xFF0C;&#x591A;&#x534A;&#x5C31;&#x662F;&#x548C;libuv&#x7684;&#x4E1C;&#x897F;&#x6709;&#x5173;&#x4E86;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x548C;libuv&#x548C;&#x52AB;&#x6301;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5728;<code>async_wrap.cc</code>&#x4EE3;&#x7801;&#x5185;&#x90E8;&#x627E;&#x5230;<code>uv.h</code>&#x5934;&#x6587;&#x4EF6;&#xFF08;&#x4EE3;&#x8868;libuv&#xFF09;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x81F3;&#x5C11;libuv&#x6CA1;&#x6709;&#x88AB;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x3002;&#x4F46;&#x662F;&#x5927;&#x7684;&#x65B9;&#x5411;&#x4E0D;&#x4F1A;&#x9519;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x770B;libuv&#x5B98;&#x7F51;&#x6587;&#x6863;<a href="/external_links/2069550e1bd72141db50b5b89d29f779.html" target="blank" rel="noopener">docs.libuv.org/en/v1.x/api&#x2026;</a></p>
<p>&#x8FD9;&#x91CC;&#x91CC;&#x9762;&#x6709;&#x5927;&#x91CF;&#x53E5;&#x67C4;(handle)&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x5E95;&#x5C42;I/O&#x8D44;&#x6E90;&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;&#xFF0C;&#x4EE5;&#x53CA;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x901A;&#x77E5;&#x548C;&#x56DE;&#x8C03;</p>
<p><strong>&#x6CE8;&#x610F;&#x4E0B;&#x9762;&#x53EA;&#x662F;&#x731C;&#x60F3;&#xFF01;&#x4E0D;&#x662F;&#x5BF9;&#x7684;&#xFF01;</strong></p>
<p><strong>&#x731C;&#x60F3;1&#xFF1A;</strong></p>
<p>&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x7684; libuv &#x91CC;&#x8FD9;&#x4E2A;API&#x4E86;&#xFF0C;&#x7528;&#x4F5C;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x4E14;&#x62FF;&#x5230;&#x5F02;&#x6B65;&#x7684;&#x56DE;&#x8C03;&#x3002;</p>
<p>&#x4E24;&#x4E2A;&#x5E93;&#x5185;&#x90E8;&#x7684;&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x4E92;&#x76F8;&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E0D;&#x7B26;&#x5408;&#x89C4;&#x8303;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x88AB;&#x5305;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x5BF9;&#x5916;&#x7684;API&#x8FDB;&#x884C;&#x4EA4;&#x4E92;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC; <code>async_wrap</code> <code>&lt;---&gt;</code> <code>libuv</code> &#x8FD9;&#x79CD;&#x5173;&#x7CFB;&#x53EF;&#x4EE5;&#x62BD;&#x8C61;&#x4E3A;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x1F447;&#x1F3FB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/27f4e2f98ca15ebc9cec99dec11e17f5cae12cc5b6554a14547d8cb3298f8175" alt="image.png"></p>
<p><strong>&#x731C;&#x60F3;2&#xFF1A;</strong></p>
<p>AsyncWrap&#x4F5C;&#x4E3A;&#x57FA;&#x7C7B;&#xFF0C;&#x63D0;&#x4F9B;&#x5404;&#x79CD;&#x57FA;&#x7840;API&#x548C;JS&#x5C42;&#x4EA4;&#x4E92;&#x3002;&#x884D;&#x751F;&#x7684;&#x5B50;&#x7C7B;&#x548C; libuv &#x901A;&#x8FC7; uv_handle_t &#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x7531; libuv &#x901A;&#x77E5;&#x5B50;&#x7C7B;&#x53BB;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684; async hook</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x4E0B;&#x4E00;&#x7AE0;&#x770B;&#x770B;&#x731C;&#x6D4B;&#x662F;&#x5426;&#x6B63;&#x786E;</p>
<p>&#x6700;&#x540E;&#xFF0C;<code>libuv</code>&#x91CC;&#x9762;&#x7684;uv&#x4E0D;&#x662F;&#x6BCF;&#x65E5;&#x8BBF;&#x95EE;&#x91CF;UV&#xFF08;Unique Visitor&#xFF09;&#x6216;&#x8005;DAU&#xFF08;Daily Active User&#xFF09;&#xFF0C;&#x800C;&#x662F; Lib of Unicorn Velociraptor&#xFF08;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF09;&#x3002;&#x4F60;&#x95EE;&#x6211;&#x4E3A;&#x5565;&#x662F;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF0C;&#x56E0;&#x4E3A;&#x3002;&#x3002;&#x3002;&#x3002;&#x770B;&#x4ED6;&#x7684;logo&#x5427;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/67c7cea90f445928c63b97f391252389ef4a80b55ea349a67a57ab22c225cc36" alt="image.png"></p>
<h2 id="How-Is-AsyncHook-Init-Invoked-by-Node-Core"><a href="#How-Is-AsyncHook-Init-Invoked-by-Node-Core" class="headerlink" title="How Is AsyncHook.Init() Invoked by Node Core"></a>How Is AsyncHook.Init() Invoked by Node Core</h2><p>&#x4E3A;&#x4E86;&#x56DE;&#x7B54;&#x4E0A;&#x9762;&#x90A3;&#x4E2A;&#x731C;&#x60F3;&#xFF0C;&#x6211;&#x60F3;&#x6211;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECB;&#x7ECD;&#x4E0B; AsyncHook &#x7684; init &#x65B9;&#x6CD5;&#x662F;&#x5982;&#x4F55;&#x88AB; Node Core &#x8C03;&#x7528;&#x7684;</p>
<p>&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x628A; init &#x5B58;&#x5728;&#x4E86;&#x67D0;&#x4E2A;&#x5730;&#x65B9;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x4E00;&#x4E2A; async call &#x7684;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x4F1A;&#x88AB;&#x89E6;&#x53D1;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6709;&#x4E86;&#x4E0B;&#x9762;2&#x4E2A;&#x6B65;&#x9AA4;&#xFF1A;</p>
<h3 id="Step-1-where-is-callback-stored-in"><a href="#Step-1-where-is-callback-stored-in" class="headerlink" title="Step 1, where is callback stored in?"></a>Step 1, where is callback stored in?</h3><p>&#x4E0A;&#x4E00;&#x7AE0;&#x8BF4;&#x4E86;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; hook cb &#x88AB;&#x5B58;&#x5728;&#x4E86; AsyncHook Class &#x5BF9;&#x5E94;&#x7684; this[xxx_symbol] = xxx &#x91CC;&#x9762;&#xFF0C;&#x5728;&#x88AB; enable &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7; ArrayPrototypePush(hooks_array, this) &#x88AB; push &#x5230;&#x4E86; hooks_array&#x3002;</p>
<p>&#x8FD9;&#x4E2A; hooks_array &#x6765;&#x81EA; lib/internal/async_hooks.js&#xFF0C;&#x53EB;&#x505A; active_hooks&#xFF0C;&#x770B;&#x4E0B;&#x5B9A;&#x4E49;&#xFF0C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; object</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Properties in active_hooks are used to keep track of the set of hooks being</span><br><span class="line">// executed in case another hook is enabled/disabled. The new set of hooks is</span><br><span class="line">// then restored once the active set of hooks is finished executing.</span><br><span class="line">const active_hooks = {</span><br><span class="line">  // Array of all AsyncHooks that will be iterated whenever an async event</span><br><span class="line">  // fires. Using var instead of (preferably const) in order to assign</span><br><span class="line">  // active_hooks.tmp_array if a hook is enabled/disabled during hook</span><br><span class="line">  // execution.</span><br><span class="line">  array: [],</span><br><span class="line">  // Use a counter to track nested calls of async hook callbacks and make sure</span><br><span class="line">  // the active_hooks.array isn&apos;t altered mid execution.</span><br><span class="line">  call_depth: 0,</span><br><span class="line">  // Use to temporarily store and updated active_hooks.array if the user</span><br><span class="line">  // enables or disables a hook while hooks are being processed. If a hook is</span><br><span class="line">  // enabled() or disabled() during hook execution then the current set of</span><br><span class="line">  // active hooks is duplicated and set equal to active_hooks.tmp_array. Any</span><br><span class="line">  // subsequent changes are on the duplicated array. When all hooks have</span><br><span class="line">  // completed executing active_hooks.tmp_array is assigned to</span><br><span class="line">  // active_hooks.array.</span><br><span class="line">  tmp_array: null,</span><br><span class="line">  // Keep track of the field counts held in active_hooks.tmp_array. Because the</span><br><span class="line">  // async_hook_fields can&apos;t be reassigned, store each uint32 in an array that</span><br><span class="line">  // is written back to async_hook_fields when active_hooks.array is restored.</span><br><span class="line">  tmp_fields: null</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = {</span><br><span class="line">  executionAsyncId,</span><br><span class="line">  triggerAsyncId,</span><br><span class="line">  // Private API</span><br><span class="line">  getHookArrays,</span><br><span class="line">  symbols: {</span><br><span class="line">    async_id_symbol, trigger_async_id_symbol,</span><br><span class="line">    init_symbol, before_symbol, after_symbol, destroy_symbol,</span><br><span class="line">    promise_resolve_symbol, owner_symbol</span><br><span class="line">  },</span><br><span class="line">  // ..</span><br><span class="line">  executionAsyncResource,</span><br><span class="line">  // Internal Embedder API</span><br><span class="line">	// ...</span><br><span class="line">  nativeHooks: {  </span><br><span class="line">    init: emitInitNative, //  &lt;====== &#x770B;&#x8FD9;&#x91CC;</span><br><span class="line">    before: emitBeforeNative,</span><br><span class="line">    after: emitAfterNative,</span><br><span class="line">    destroy: emitDestroyNative,</span><br><span class="line">    promise_resolve: emitPromiseResolveNative</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A; lib/internal/async_hooks.js &#x6587;&#x4EF6;export&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x6709;&#x4E2A;&#x540D;&#x5B57;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#xFF0C;emitInitNative&#x3002;Native, Native&#xFF0C;&#x540D;&#x5B57;&#x91CC;&#x9762;&#x6709; Native&#xFF0C;&#x5B9E;&#x5728;&#x592A;&#x4E0D;&#x5BF9;&#x52B2;&#x4E86;&#x3002;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5B9E;&#x73B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Emit From Native //</span><br><span class="line"></span><br><span class="line">// Used by C++ to call all init() callbacks. Because some state can be setup</span><br><span class="line">// from C++ there&apos;s no need to perform all the same operations as in</span><br><span class="line">// emitInitScript.</span><br><span class="line">function emitInitNative(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">  active_hooks.call_depth += 1;</span><br><span class="line">  resource = lookupPublicResource(resource);</span><br><span class="line">  // Use a single try/catch for all hooks to avoid setting up one per iteration.</span><br><span class="line">  try {</span><br><span class="line">    // Using var here instead of let because &quot;for (var ...)&quot; is faster than let.</span><br><span class="line">    // Refs: https://github.com/nodejs/node/pull/30380#issuecomment-552948364</span><br><span class="line">    // eslint-disable-next-line no-var</span><br><span class="line">    for (var i = 0; i &lt; active_hooks.array.length; i++) {</span><br><span class="line">      if (typeof active_hooks.array[i][init_symbol] === &apos;function&apos;) {</span><br><span class="line">        active_hooks.array[i][init_symbol](</span><br><span class="line">          asyncId, type, triggerAsyncId,</span><br><span class="line">          resource</span><br><span class="line">        );</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  } catch (e) {</span><br><span class="line">    fatalError(e);</span><br><span class="line">  } finally {</span><br><span class="line">    active_hooks.call_depth -= 1;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // Hooks can only be restored if there have been no recursive hook calls.</span><br><span class="line">  // Also the active hooks do not need to be restored if enable()/disable()</span><br><span class="line">  // weren&apos;t called during hook execution, in which case active_hooks.tmp_array</span><br><span class="line">  // will be null.</span><br><span class="line">  if (active_hooks.call_depth === 0 &amp;&amp; active_hooks.tmp_array !== null) {</span><br><span class="line">    restoreActiveHooks();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7; comment &#x8BC1;&#x660E;&#x4E86;&#xFF0C;emitInitNative &#x786E;&#x5B9E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x88AB; native &#x8C03;&#x7528;&#xFF08;C++&#xFF09;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x8DEF;&#x5B58;&#x4E0B;&#x6765;&#x7684; active_hooks &#x4F1A;&#x5728; line 18 &#x91CC;&#x9762;&#xFF0C;&#x5728;js&#x5C42;&#x88AB;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540C;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x7684; before, after &#x7B49;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x56DE;&#x7B54;&#x4E86;&#x6807;&#x9898;&#xFF0C;callback&#x662F;&#x5B58;&#x5728;&#x54EA;&#x91CC;&#x5E76;&#x88AB;&#x6267;&#x884C;&#x7684;</p>
<p>&#x5148;&#x522B;&#x6025;&#x7740;&#x8D70;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x5DEE;&#x4E00;&#x4EF6;&#x4E8B;&#xFF0C;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x628A;&#x8FD9;&#x4E2A; js &#x7684;&#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9;&#x6211;&#x4EEC;&#x7684; native &#x5C42;&#xFF1F;&#x5728;&#x8FD9;&#x91CC;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap.js</span><br><span class="line"></span><br><span class="line">const { nativeHooks } = require(&apos;internal/async_hooks&apos;);</span><br><span class="line">internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</span><br></pre></td></tr></table></figure>

<p>&#x795E;&#x79D8;&#x7684;&#xFF0C;&#x4ECE;C++&#x5C42;&#x6765;&#x7684; async_wrap &#x8D1F;&#x8D23;&#x628A;&#x6211;&#x4EEC;&#x7684; nativeHooks &#x6CE8;&#x518C;&#x5230;c++&#x3002;OK&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F; setupHooks is responsible for registering nativeHooks &#x5373;&#x53EF;</p>
<h3 id="Step-2-which-code-line-is-responsible-for-calling-init-callback"><a href="#Step-2-which-code-line-is-responsible-for-calling-init-callback" class="headerlink" title="Step 2, which code line is responsible for calling init callback?"></a>Step 2, which code line is responsible for calling init callback?</h3><p>&#x5148;&#x8BF4;&#x7ED3;&#x8BBA;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; async call &#x90FD;&#x4F1A;&#x7531;&#x4E00;&#x4E2A; C++ &#x7684;&#x7C7B;&#x53EB;&#x505A; AsyncWrap &#x6765;&#x5305;&#x88C5;&#xFF0C;&#x5730;&#x5740;&#x5728; src/async_wrap.cc</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x628A; async_wrap &#x66B4;&#x9732;&#x51FA;&#x53BB;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x6765;&#x770B;<code>Initialize</code></p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize)</code></p>
<p><strong>Initialize</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::Initialize(Local&lt;Object&gt; target,</span><br><span class="line">                           Local&lt;Value&gt; unused,</span><br><span class="line">                           Local&lt;Context&gt; context,</span><br><span class="line">                           void* priv) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(context);</span><br><span class="line">  Isolate* isolate = env-&gt;isolate();</span><br><span class="line">  HandleScope scope(isolate);</span><br><span class="line"></span><br><span class="line">  env-&gt;SetMethod(target, &quot;setupHooks&quot;, SetupHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setCallbackTrampoline&quot;, SetCallbackTrampoline);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;pushAsyncContext&quot;, PushAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;popAsyncContext&quot;, PopAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;executionAsyncResource&quot;, ExecutionAsyncResource);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;clearAsyncIdStack&quot;, ClearAsyncIdStack);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;queueDestroyAsyncId&quot;, QueueDestroyAsyncId);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setPromiseHooks&quot;, SetPromiseHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;registerDestroyHook&quot;, RegisterDestroyHook);</span><br><span class="line"></span><br><span class="line">  PropertyAttribute ReadOnlyDontDelete =</span><br><span class="line">      static_cast&lt;PropertyAttribute&gt;(ReadOnly | DontDelete);</span><br><span class="line">  // ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5148;&#x89E3;&#x91CA;&#x51E0;&#x4E2A;&#x57FA;&#x672C;&#x6982;&#x5FF5;&#x548C;&#x6570;&#x636E;&#x7C7B;&#x578B;:</p>
<ul>
<li><strong>Isolate</strong>: line 8 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728; <code>v8.h</code>&#x3002;Isolate&#x662F;V8&#x5F15;&#x64CE;&#x7684;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x5B9E;&#x4F8B;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;JavaScript&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x8FD0;&#x884C;&#x5728;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5185;&#x5B58;&#x5806;&#x3001;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x548C;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Isolate&#xFF0C;&#x6BCF;&#x4E2A;Isolate&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#xFF0C;&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x8FD0;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;</li>
<li><strong>Context</strong>: line 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;Context&#x8868;&#x793A;Isolate&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;JavaScript&#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x542B;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x53D8;&#x91CF;&#x3001;&#x51FD;&#x6570;&#x548C;&#x5176;&#x4ED6;&#x6570;&#x636E;&#x3002;Context&#x5728;Isolate&#x4E2D;&#x521B;&#x5EFA;&#xFF0C;&#x5E76;&#x4E0E;&#x7279;&#x5B9A;&#x7684;&#x6267;&#x884C;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;&#x8054;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x5355;&#x4E2A;Isolate&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Context&#xFF0C;&#x6BCF;&#x4E2A;Context&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x6267;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x77E5;&#x7684; <code>vm.createContext()</code>&#x4E5F;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; Context &#x5B9E;&#x4F8B;&#x3002;</li>
<li><strong>Local</strong>: lin 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;&#x5728; V8 &#x5F15;&#x64CE;&#xFF08;Node.js &#x7684; JavaScript &#x5F15;&#x64CE;&#xFF09;&#x4E2D;&#xFF0C;&#x7528;&#x4E8E;&#x8868;&#x793A; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#xFF08;Handle&#xFF09;</li>
</ul>
<ul>
<li><ul>
<li>&#x770B;&#x4E0B;&#x539F;&#x6587;&#x63CF;&#x8FF0;&#xFF1A;<code>An object reference managed by the v8 garbage collector. All objects returned from v8 have to be tracked by the garbage collector so that it knows that the objects are still alive</code>&#x3002;<ul>
<li>&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6307;&#x9488;&#xFF0C;&#x4F46;&#x662F;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4F1A;&#x968F;&#x7740;GC&#xFF08;garbage collection&#xFF09;&#x800C;&#x53D8;&#x5316;&#xFF0C;&#x786E;&#x4FDD;&#x603B;&#x662F;&#x6307;&#x5411;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x503C;&#xFF0C;&#x540C;&#x65F6;&#x7BA1;&#x7406;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x88AB;&#x6E05;&#x7406;&#x3002;</li>
<li>Local &#x53E5;&#x67C4;&#x662F;&#x4E00;&#x79CD;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#xFF0C;&#x5B83;&#x5728; V8 &#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x662F;&#x6709;&#x9650;&#x7684;&#x3002;&#x5F53; V8 &#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x56DE;&#x6536;&#x65F6;&#xFF0C;Local &#x53E5;&#x67C4;&#x6240;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x6E05;&#x7406;&#x3002;Local&#x5C31;&#x4EE3;&#x8868;&#x4E00;&#x4E2A;V8 Context &#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#x3002;&#x9664;&#x4E86;&#x672C;&#x5730;&#x53E5;&#x67C4;Local&#xFF0C;&#x8FD8;&#x6709;MaybeLocal&#xFF0C;Eternal&#x7B49;&#x7C7B;&#x578B;&#x3002;</li>
<li>line 9 &#x4E2D;&#x7684; HandleScope &#x4E5F;&#x662F;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x53E5;&#x67C4;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Environment</strong>: line 7 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>src/env.h</code>&#x3002;&#x5728; Node.js &#x7684; C++ &#x5C42;&#x9762;&#xFF0C;Environment &#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x548C;&#x7EF4;&#x62A4; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x548C;&#x8D44;&#x6E90;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x6865;&#x6881;&#xFF0C;&#x8BA9; Node.js &#x7684; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;Environment &#x7C7B;&#x5C01;&#x88C5;&#x4E86;&#x8BB8;&#x591A;&#x4E0E; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x4EE5;&#x4E0B;&#x662F; Environment &#x7C7B;&#x7684;&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x804C;&#x8D23;&#xFF1A;</li>
</ul>
<ul>
<li><ul>
<li>&#x7BA1;&#x7406; V8 Isolate &#x5B9E;&#x4F8B;&#xFF1A;Isolate &#x662F; V8 &#x5F15;&#x64CE;&#x4E2D;&#x8868;&#x793A;&#x72EC;&#x7ACB;&#x7684; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x4E00;&#x4E2A; Environment &#x5B9E;&#x4F8B;&#x4E0E;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684; Isolate &#x5B9E;&#x4F8B;&#x5173;&#x8054;&#xFF0C;&#x5B83;&#x4EEC;&#x5171;&#x540C;&#x6784;&#x6210;&#x4E86; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x3002;<ul>
<li>&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF1A;Environment &#x7C7B;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x4E0E;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x5982;&#x5BF9;&#x8C61;&#x53E5;&#x67C4;&#x3001;&#x7F13;&#x51B2;&#x533A;&#x7B49;&#x3002;&#x901A;&#x8FC7;&#x521B;&#x5EFA; V8 HandleScope &#x548C; EscapableHandleScope &#x5B9E;&#x4F8B;&#xFF0C;Environment &#x80FD;&#x786E;&#x4FDD; V8 &#x80FD;&#x6B63;&#x786E;&#x5730;&#x7BA1;&#x7406; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</li>
<li>&#x4E0E; JavaScript &#x5C42;&#x7684;&#x4E92;&#x64CD;&#x4F5C;&#xFF1A;Environment &#x7C7B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x5305;&#x62EC;&#x8BBE;&#x7F6E; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x65B9;&#x6CD5;&#x3001;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7B49;&#x3002;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>OK&#xFF0C;&#x57FA;&#x4E8E;&#x6B64;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x5728; line 7&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; Environment::GetCurrent(context) &#x83B7;&#x53D6;&#x5230;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x7684; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x5728;line 11&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x6307;&#x9488;&#x6240;&#x6307;&#x7684;&#x65B9;&#x6CD5; SetMethod&#xFF0C;&#x8BB2;&#x6211;&#x4EEC;&#x7684; SetupHooks &#x7ED1;&#x5B9A;&#x5230;&#x4E0A;&#x4E00;&#x8282;&#x63D0;&#x5230;&#x8FC7;&#x7684; <code>internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</code></p>
<p>&#x90A3; SetupHooks &#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p><strong>SetupHooks</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">static void SetupHooks(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(args);</span><br><span class="line"></span><br><span class="line">  CHECK(args[0]-&gt;IsObject());</span><br><span class="line"></span><br><span class="line">  // All of init, before, after, destroy, and promise_resolve are supplied by</span><br><span class="line">  // async_hooks internally, so this should only ever be called once. At which</span><br><span class="line">  // time all the functions should be set. Detect this by checking if</span><br><span class="line">  // init !IsEmpty().</span><br><span class="line">  CHECK(env-&gt;async_hooks_init_function().IsEmpty());</span><br><span class="line"></span><br><span class="line">  Local&lt;Object&gt; fn_obj = args[0].As&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">#define SET_HOOK_FN(name)                                                      \</span><br><span class="line">  do {                                                                         \</span><br><span class="line">    Local&lt;Value&gt; v =                                                           \</span><br><span class="line">        fn_obj-&gt;Get(env-&gt;context(),                                            \</span><br><span class="line">                    FIXED_ONE_BYTE_STRING(env-&gt;isolate(), #name))              \</span><br><span class="line">            .ToLocalChecked();                                                 \</span><br><span class="line">    CHECK(v-&gt;IsFunction());                                                    \</span><br><span class="line">    env-&gt;set_async_hooks_##name##_function(v.As&lt;Function&gt;());                  \</span><br><span class="line">  } while (0)</span><br><span class="line"></span><br><span class="line">  SET_HOOK_FN(init);</span><br><span class="line">  SET_HOOK_FN(before);</span><br><span class="line">  SET_HOOK_FN(after);</span><br><span class="line">  SET_HOOK_FN(destroy);</span><br><span class="line">  SET_HOOK_FN(promise_resolve);</span><br><span class="line">#undef SET_HOOK_FN</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x662F;&#x83B7;&#x53D6; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x786E;&#x4FDD; args[0] &#x662F;&#x4E00;&#x4E2A; Objext&#xFF0C;&#x540C;&#x65F6; async_hooks_init_function &#x662F; empty&#xFF0C;&#x786E;&#x4FDD;&#x53EA;&#x4F1A;&#x88AB;&#x521D;&#x59CB;&#x5316;1&#x6B21;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x5B9A;&#x4E49;&#x4E86; SET_HOOK_FN &#x8FD9;&#x4E2A;&#x5B8F;(marco)&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x5B8F;&#xFF0C;&#x5C06; init &#x65B9;&#x6CD5;&#x7ED1;&#x5B9A;&#x5230;&#x89E6;&#x53D1;&#x51FD;&#x6570;</p>
<p><code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>##name## &#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;init&#x3001;before&#x3001;after&#x3001;destroy&#x53D8;&#x91CF;&#xFF0C;&#x2018;#&#x2019; &#x548C; &#x2018;##&#x2019; &#x8BED;&#x6CD5;&#x7528;&#x4E8E; C/C++ &#x4E2D;&#x7684; macro &#x547D;&#x4EE4;&#x3002;&#x6700;&#x540E;&#x7684; #undef &#x4F7F;&#x7528;&#x662F;&#x53BB;&#x6389;&#x5B8F;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x6B64;&#x5B8F;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5728; AsyncWrap::EmitAsyncInit &#x4E2D;&#x8C03;&#x7528;</p>
<p><strong>EmitAsyncInit</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::EmitAsyncInit(Environment* env,</span><br><span class="line">                              Local&lt;Object&gt; object,</span><br><span class="line">                              Local&lt;String&gt; type,</span><br><span class="line">                              double async_id,</span><br><span class="line">                              double trigger_async_id) {</span><br><span class="line">  CHECK(!object.IsEmpty());</span><br><span class="line">  CHECK(!type.IsEmpty());</span><br><span class="line">  AsyncHooks* async_hooks = env-&gt;async_hooks();</span><br><span class="line"></span><br><span class="line">  // Nothing to execute, so can continue normally.</span><br><span class="line">  if (async_hooks-&gt;fields()[AsyncHooks::kInit] == 0) {</span><br><span class="line">    return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  HandleScope scope(env-&gt;isolate());</span><br><span class="line">  Local&lt;Function&gt; init_fn = env-&gt;async_hooks_init_function();</span><br><span class="line"></span><br><span class="line">  Local&lt;Value&gt; argv[] = {</span><br><span class="line">    Number::New(env-&gt;isolate(), async_id),</span><br><span class="line">    type,</span><br><span class="line">    Number::New(env-&gt;isolate(), trigger_async_id),</span><br><span class="line">    object,</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);</span><br><span class="line">  USE(init_fn-&gt;Call(env-&gt;context(), object, arraysize(argv), argv));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// location: v8.h</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A JavaScript function object (ECMA-262, 15.3).</span><br><span class="line"> */</span><br><span class="line">class V8_EXPORT Function : public Object {}</span><br></pre></td></tr></table></figure>

<p>set the fn: <code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>get the corresponding fn: <code>env -&gt; async_hooks_init_function()</code></p>
<p>&#x5728; line 18&#xFF0C;&#x6211;&#x4EEC;&#x83B7;&#x5F97;&#x4E86;&#x4E4B;&#x524D;&#x6CE8;&#x518C;&#x7684; init&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A; Local &#x53E5;&#x67C4;&#xFF0C;Local &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411; js &#x7684; function &#x7684;&#x53E5;&#x67C4;&#xFF0C;&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; line 28 &#x7684; init_fn -&gt; Call() &#x53EF;&#x4EE5;&#x6765;&#x89E6;&#x53D1; js &#x51FD;&#x6570;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x8BF4;&#x5B8C;&#x4E86;&#x4E00;&#x4E2A; Async Init Hook &#x662F;&#x5982;&#x4F55;&#x88AB;&#x5B8C;&#x6574;&#x8C03;&#x7528;&#x7684;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x56DE;&#x987E;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x7B97;&#x662F;&#x662F;&#x4E00;&#x4E2A;&#x5C0F;&#x7ED3;</p>
<h2 id="Sum-Up-High-Level-Overview-Flowchart"><a href="#Sum-Up-High-Level-Overview-Flowchart" class="headerlink" title="Sum Up: High-Level Overview Flowchart"></a>Sum Up: High-Level Overview Flowchart</h2><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/7b9f597c2442a81082bc6816d805b2904396ed0c8f013427bf43cca69f7b9a81" alt="image.png"></p>
<ul>
<li>API&#xFF1A;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x66B4;&#x9732;&#x4E86;&#x8FD9;3&#x4E2A;&#x91CD;&#x8981;&#x7684;API</li>
<li>Node Core - Native JS Module:</li>
</ul>
<pre><code>+ &#x4E0A;&#x9762;&#x7684;3&#x4E2A;API&#x6765;&#x81EA;async\_hooks.js&#x4E2D;&#x7684;3&#x4E2A;&#x7C7B;&#xFF1A;AsyncLocalStorage/AsyncResource/AsyncHook
+ AsyncHook&#x8D1F;&#x8D23;&#x6CE8;&#x518C;4&#x4E2A;&#x9636;&#x6BB5;&#x7684;Callback function
+ &#x5728;&#x8FD9;&#x91CC;&#x901A;&#x8FC7; internalBinding(&apos;async\_wrap&apos;) &#x83B7;&#x5F97;C++&#x5C42;&#x7684; AsyncWrap</code></pre><ul>
<li>Node Core - C++ Binding:</li>
</ul>
<pre><code>+ &#x5728; async\_wrap.cc &#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x5173;&#x952E;&#x7684;&#x57FA;&#x7C7B; `AsyncWrap`&#xFF0C;&#x5B83;&#x7EE7;&#x627F;&#x81EA; `BaseObject`
+ &#x901A;&#x8FC7; NODE\_MODULE\_CONTEXT\_AWARE\_INTERNAL &#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9; JS &#x5C42;
+ AsyncWrap&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x7C7B;&#x3002;UPDWrap&#x3001;TCPWrap&#x3001;FSEventWrap&#x7B49;&#x76F4;&#x63A5;&#x6216;&#x95F4;&#x63A5;&#x7EE7;&#x627F;&#x8005;&#x5B83;&#xFF0C;&#x4E3A;&#x5404;&#x79CD; Wrap &#x63D0;&#x4F9B;&#x8D1F;&#x8D23;&#x89E6;&#x53D1;Hook&#x56DE;&#x8C03;&#x7684;&#x65B9;&#x6CD5;&#x3002;
    - &#x6BD4;&#x5982; TCPWrap -&gt; ConnectionWrap -&gt; LibuvStreamWrap -&gt; HandleWrap -&gt; AsyncWrap
    - libuv&#x7684;&#x65B9;&#x6CD5;&#x5728;&#x5177;&#x4F53;&#x7684; Wrap &#x91CC;&#x9762;&#x8C03;&#x7528;&#x3002;
        * &#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A; TCP &#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x53D1;&#x51FA;&#x65F6;&#xFF0C;&#x4F1A;&#x6267;&#x884C; new TCPWrap&#xFF0C;&#x901A;&#x8FC7; uv\_tcp\_connect() &#x53D1;&#x8D77;&#x94FE;&#x63A5;&#xFF08;&#x65B9;&#x6CD5;&#x6765;&#x81EA;libuv&#xFF09;&#xFF1B;
        * &#x94FE;&#x63A5;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x53E5;&#x67C4;&#xFF08;uv\_tcp\_t&#xFF09;&#xFF0C;&#x5BF9; libuv &#x4FDD;&#x6301;&#x8BBF;&#x95EE;&#x3002;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x53E5;&#x67C4;&#x7C7B;&#x578B;&#x4F1A;&#x88AB;&#x8F6C;&#x53D8; uv\_tcp\_t -&gt; uv\_stream\_t
        * &#x5F53;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x65F6;&#x5019;&#xFF0C; TCPHandle &#x5BF9;&#x8C61;&#x4F1A;&#x89E6;&#x53D1; uv\_\_stream\_io() &#x65B9;&#x6CD5;&#x53BB;&#x6267;&#x884C; uv\_\_read()&#xFF0C;&#x6700;&#x7EC8;&#x901A;&#x77E5; TCPWrap &#x6216;&#x8005;&#x5176;&#x7236;&#x7C7B;&#x6267;&#x884C;&#x56DE;&#x8C03;
+ src/api &#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x7ED9;&#x4E09;&#x65B9;addons&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;API&#xFF0C;&#x5176;&#x4E2D;AsyncResource&#x662F;&#x57FA;&#x4E8E;AsyncWrap&#x7684;&#x5C01;&#x88C5;&#xFF0C;AsyncWrap&#x89E6;&#x53D1;before&#x548C;after&#x7684;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x662F;&#x901A;&#x8FC7; AsyncWrap::MakeCallback &#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x8C03;&#x7528; CallbackScope &#x5185;&#x90E8;&#x7684; InternalMakeCallback</code></pre><ul>
<li>Deps:</li>
</ul>
<pre><code>+ Libuv: &#x5BF9;I/O&#x5F02;&#x6B65;&#x3001;&#x7F51;&#x7EDC;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x8D1F;&#x8D23;
+ V8: &#x5BF9;Promise &#x548C; async/await &#x8BED;&#x6CD5;&#x8D1F;&#x8D23;
+ &#x6700;&#x7EC8;&#x901A;&#x8FC7; AsyncWrap &#x901A;&#x77E5;&#x5230; JS &#x5C42;&#x7684; AsyncHook</code></pre><h2 id="Add-On"><a href="#Add-On" class="headerlink" title="Add-On"></a>Add-On</h2><p>&#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x4E9B;&#x6536;&#x96C6;&#x8D44;&#x6599;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x73B0;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x548C;&#x5F69;&#x86CB;&#xFF0C;&#x5206;&#x4EAB;&#x7ED9;&#x5927;&#x5BB6;</p>
<p><strong>Performance Improvement</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/294ec9faacde0f406b4d878df7baa70ca35b2dd6aacba5ff8e92d15af29fdbad" alt="image.png"></p>
<p><a href="/external_links/4785ad23bbb7e952c4771db1818ea44a.html" target="blank" rel="noopener">PR&#xFF1A;async_hooks: use resource stack for AsyncLocalStorage run #39890</a></p>
<p>&#x5173;&#x952E;&#x5B57;&#xFF1A;</p>
<ul>
<li>using stack instead of AsyncResouce instance</li>
<li>eliminate extra lifecycle event</li>
</ul>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x6267;&#x884C;<code>AsyncLocalStorage.run</code>&#x7684;&#x65F6;&#x5019;&#x6709;&#x4E2A; commit log&#xFF0C;&#x8FD9;&#x6B21;&#x7684; PR &#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x5347;&#x6027;&#x80FD;</p>
<p><strong>PromiseHook</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f728b446fc8621087f2a0190c1cb7d893fcf3cb3f77dbcb0c8127ab08824abe5" alt="image.png"></p>
<p><a href="/external_links/16fe0b66fa48442349ec71a97786b483.html" target="blank" rel="noopener">PR: async_hooks: fast-path for PromiseHooks in JS #32891</a></p>
<p>&#x53C8;&#x662F;&#x8FD9;&#x4E2A;&#x54E5;&#x4EEC;&#x3002;</p>
<p>&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5F69;&#x86CB;&#x3002;Reviewed-By: Chengzhong Wu</p>
<p>&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x660E;&#x660E;&#x88AB;&#x5173;&#x95ED;&#x7684;PR&#xFF1F;&#x4EE3;&#x7801; commit &#x5374;&#x51FA;&#x73B0;&#x4E86;&#x5728;&#x4E86; Node v16.18&#xFF1F;&#x56E0;&#x4E3A;Node&#x53D1;&#x7248;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x4E0D;&#x4F7F;&#x7528;Github&#x7684;PR&#xFF0C;&#x6709;&#x4E00;&#x5957;&#x81EA;&#x5DF1;&#x7684;&#x6D41;&#x7A0B;&#xFF09;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0799228bb37158f0fcedcbed7bb168f85f5fefaf667bc7d5a943bc229a49ef6e" alt="image.png"></p>
<p><strong>How is loader created</strong></p>
<p>&#x8FD9;&#x91CC;&#x653E;&#x4E0B; <code>lib/internal/bootstrap/loader.js</code>&#x6587;&#x4EF6;&#x7684;&#x5B8C;&#x6574;&#x5907;&#x6CE8;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x5206;&#x60C5;&#x51B5;&#x8BA8;&#x8BBA;&#x4E86;<code>require</code>&#x8BED;&#x6CD5;&#x91CC;&#x62FF;&#x5230;&#x7684;&#x5404;&#x79CD;&#x5BF9;&#x8C61;&#x662F;&#x600E;&#x4E48;&#x88AB;&#x52A0;&#x8F7D;&#x8FDB;&#x53BB;&#x7684;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x628A;&#x6587;&#x6863;&#x7684;&#x6CE8;&#x91CA;&#x8BFB;&#x5B8C;&#xFF0C;&#x6574;&#x4E2A; loader &#x8FD9;&#x4E00;&#x5C42;&#x5C31;&#x4F1A;&#x6E05;&#x695A;&#x5F88;&#x591A;&#x3002;&#x6240;&#x4EE5;&#x975E;&#x5E38;&#x559C;&#x6B22; Node &#x7684;&#x4E30;&#x5BCC;&#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line">//</span><br><span class="line">// This file is compiled and run by node.cc before bootstrap/node.js</span><br><span class="line">// was called, therefore the loaders are bootstrapped before we start to</span><br><span class="line">// actually bootstrap Node.js. It creates the following objects:</span><br><span class="line">//</span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - process.binding(): the legacy C++ binding loader, accessible from user land</span><br><span class="line">//   because it is an object attached to the global process object.</span><br><span class="line">//   These C++ bindings are created using NODE_BUILTIN_MODULE_CONTEXT_AWARE()</span><br><span class="line">//   and have their nm_flags set to NM_F_BUILTIN. We do not make any guarantees</span><br><span class="line">//   about the stability of these bindings, but still have to take care of</span><br><span class="line">//   compatibility issues caused by them from time to time.</span><br><span class="line">// - process._linkedBinding(): intended to be used by embedders to add</span><br><span class="line">//   additional C++ bindings in their applications. These C++ bindings</span><br><span class="line">//   can be created using NODE_MODULE_CONTEXT_AWARE_CPP() with the flag</span><br><span class="line">//   NM_F_LINKED.</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line">//</span><br><span class="line">// Internal JavaScript module loader:</span><br><span class="line">// - NativeModule: a minimal module system used to load the JavaScript core</span><br><span class="line">//   modules found in lib/**/*.js and deps/**/*.js. All core modules are</span><br><span class="line">//   compiled into the node binary via node_javascript.cc generated by js2c.py,</span><br><span class="line">//   so they can be loaded faster without the cost of I/O. This class makes the</span><br><span class="line">//   lib/internal/*, deps/internal/* modules and internalBinding() available by</span><br><span class="line">//   default to core modules, and lets the core modules require itself via</span><br><span class="line">//   require(&apos;internal/bootstrap/loaders&apos;) even when this file is not written in</span><br><span class="line">//   CommonJS style.</span><br><span class="line">//</span><br><span class="line">// Other objects:</span><br><span class="line">// - process.moduleLoadList: an array recording the bindings and the modules</span><br><span class="line">//   loaded in the process and the order in which they are loaded.</span><br><span class="line"></span><br><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br></pre></td></tr></table></figure>

<p><strong>The Workflow of Node.js Startup</strong></p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">leezhenghui.github.io/node.js/201&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f845a06ae4ed9ff595b40092d9a927218ff167b7fbcdcd18780185984495a126" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/b2601115c384c4f09a83168693bc45d3e48d30675afc17f1cffdfb2f34b4c430" alt></p>
<p>&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#x7684; loader &#x5C31;&#x662F;&#x5728; LoadEnv &#x9636;&#x6BB5;&#x88AB;&#x6267;&#x884C;&#x7684;&#x3002;</p>
<p>&#x800C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BA8;&#x8BBA;&#x7684; AsyncHook &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5C31;&#x5728;&#x4E0A;&#x9762;&#x7684; [node native module] - [node-core(c/c++)] &#x4E24;&#x5C42;&#x4E4B;&#x95F4;</p>
<p>&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x539F;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x975E;&#x5E38;&#x8BE6;&#x7EC6;&#x5F97;&#x4ECB;&#x7ECD;&#x4E86; Node&#xFF0C;&#x540D;&#x5B57;&#x4E5F;&#x5F88;&#x6709;&#x610F;&#x601D; <a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">&#x300A;Demystify node.js - Modularization&#x300B;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c373a20c3aed76aa8b06ab581ff052ece9b5ff0870ddcb706e3ad11538bcaf4d" alt="image.png"></p>
<h1 id="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"><a href="#&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;" class="headerlink" title="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"></a>&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;</h1><p>&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x60F3;&#x6CD5;&#x975E;&#x5E38;&#x7A81;&#x7136;&#x3002;&#x5927;&#x6982;&#x662F;2&#x6708;&#x521D;&#xFF0C;&#x541E;&#x541E;&#x8001;&#x5E08;&#x5728;&#x7FA4;&#x91CC;&#x5206;&#x4EAB;&#x4E86;&#x5173;&#x4E8E; AsyncContext &#x63D0;&#x6848;&#x8FDB;&#x5165; Stage1 &#x7684;&#x6D88;&#x606F;&#xFF0C;&#x5C31;&#x7784;&#x4E86;&#x4E00;&#x773C;&#x53D1;&#x73B0;&#x770B;&#x4E0D;&#x61C2;&#xFF0C;&#x4E8E;&#x662F;&#x5728;&#x5927;&#x7FA4;&#x91CC;&#x6C42;&#x6559;&#x3002;</p>
<p>&#x540E;&#x6765;&#xFF0C;&#x4E86;&#x89E3;&#x5230;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x548C;Node&#x4E2D;&#x7684;&#x4E00;&#x4E9B;API&#x7C7B;&#x4F3C;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x5F00;&#x59CB;&#x6162;&#x6162;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#x7684;&#x80CC;&#x666F;&#xFF0C;&#x5FC3;&#x91CC;&#x60F3;&#x7740;&#x90FD;&#x6574;&#x7406;&#x4E86;&#x4E9B;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5199;&#x7BC7;&#x6587;&#x7AE0;&#x603B;&#x7ED3;&#x4E0B;&#x5427;&#x3002;&#x4F46;&#x662F;&#x5149;&#x4ECB;&#x7ECD; API &#x548B;&#x7528;&#x7531;&#x6709;&#x70B9;&#x6D45;&#xFF0C;&#x5B98;&#x7F51;&#x6587;&#x6863;&#x4E5F;&#x6709;&#xFF0C;&#x4E8E;&#x662F;&#x6240;&#x5E78;&#x68B3;&#x7406;&#x4E0B;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x3002;&#x540E;&#x6765;&#x611F;&#x89C9;&#xFF0C;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x90FD;&#x770B;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x4E5F;&#x4E00;&#x628A;&#x68AD;&#x5427;&#xFF0C;&#x51B5;&#x4E14;&#x8981;&#x5199;&#x5C31;&#x8D28;&#x91CF;&#x5199;&#x9AD8;&#x70B9;&#x561B;&#xFF0C;&#x6B63;&#x597D;&#x501F;&#x8FD9;&#x4E2A;&#x673A;&#x4F1A;&#x518D;&#x4E86;&#x89E3;&#x4E0B;Node&#xFF0C;&#x4E8E;&#x662F;&#xFF0C;&#x4FBF;&#x6709;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x8270;&#x96BE;&#x7684;&#xFF0C;&#x8FB9;&#x731C;&#x8FB9;&#x5B66;&#x8FB9;&#x5199;&#x3002;&#x96BE;&#x70B9;&#x6709;&#x4E8C;&#xFF0C;&#x96BE;&#x70B9;&#x4E4B;&#x4E00;&#xFF0C;&#x662F;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x5BF9;&#x6211;&#x6709;&#x4E00;&#x5B9A;&#x96BE;&#x5EA6;&#xFF1B;&#x4ECE;&#x4E00;&#x4E2A;&#x70B9;&#x5207;&#x5165;&#x8FDB;&#x5165;&#xFF08;&#x4E00;&#x4E2A;API&#xFF09;&#xFF0C;&#x53D1;&#x73B0;&#x8FD8;&#x9700;&#x8981;&#x4E00;&#x6761;&#x7EBF;&#xFF08;Node&#x7684;&#x673A;&#x5236;&#xFF09;&#x751A;&#x81F3;&#x4E00;&#x4E2A;&#x9762;&#x7684;&#x77E5;&#x8BC6;&#xFF08;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x3001;&#x751A;&#x81F3;&#x76F8;&#x5173;&#x9886;&#x57DF;&#x7684;&#x77E5;&#x8BC6;&#xFF09;&#x3002;&#x4E00;&#x5F00;&#x59CB;&#x6709;&#x70B9;overwhelming&#xFF0C;&#x53D1;&#x73B0;&#x9700;&#x8981;&#x540C;&#x6B65;&#x5B66;&#x7684;&#x77E5;&#x8BC6;&#x592A;&#x591A;&#x4E86;&#x3002;&#x540E;&#x6765;&#x53EF;&#x7B97;&#x627E;&#x5230;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x53EA;&#x8981;&#x7D27;&#x76EF;&#x7740;&#x8FD9;&#x4E2A;&#x70B9;&#xFF0C;&#x4E0D;&#x8981;&#x76F2;&#x76EE;&#x5C55;&#x5F00; Todo List&#xFF0C;&#x5C31;&#x6162;&#x6162;&#x5411;&#x5916;&#x6269;&#x5C55;&#x5373;&#x53EF;&#x3002;&#x96BE;&#x70B9;&#x4E4B;&#x4E8C;&#xFF0C;&#x662F;&#x884C;&#x6587;&#x5982;&#x4F55;&#x5C55;&#x5F00;&#xFF0C;&#x56E0;&#x4E3A;&#x5C31;&#x6211;&#x81EA;&#x5DF1;&#x8BFB;&#x6280;&#x672F;&#x4E66;&#x7C4D;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x5F88;&#x5C11;&#x63CF;&#x5199;&#x4E3A;&#x4EC0;&#x4E48;&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x53BB;&#x60F3;&#x6216;&#x8005;&#x672C;&#x8EAB;&#x5C31;&#x6709;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x624D;&#x80FD;&#x5F97;&#x5230;&#x7B54;&#x6848;&#xFF0C;&#x6211;&#x8FD8;&#x662F;&#x5E0C;&#x671B;&#x80FD;&#x63D0;&#x4F9B;&#x66F4;&#x591A;&#x7684;&#x80CC;&#x666F;&#x6765;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x3002;&#x60F3;&#x6CD5;&#x5F88;&#x7F8E;&#x597D;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E8B;&#x5B9E;&#x4E0A;&#x81EA;&#x5DF1;&#x4E0A;&#x624B;&#x4E4B;&#x540E;&#x53D1;&#x73B0;&#xFF0C;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x7406;&#x51FA;&#x4E00;&#x6761;&#x601D;&#x8DEF;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x50CF;&#x6F14;&#x5458;&#x5E26;&#x5165;&#x89D2;&#x8272;&#x4E00;&#x6837;&#x6765;&#x5E26;&#x5165;&#x8BFB;&#x8005;&#xFF0C;&#x5F88;&#x8003;&#x9A8C;&#x529F;&#x529B;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x6700;&#x540E;3&#x7AE0;&#xFF0C;&#x628A;&#x63E1;&#x4E0D;&#x4F4F;&#x4E86;&#x3002;</p>
<p>&#x5E78;&#x597D;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x6709;&#x8D35;&#x4EBA;&#x76F8;&#x52A9;&#xFF0C;&#x611F;&#x8C22;&#x8FC7;&#x7A0B;&#x4E2D;&#x5404;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x6307;&#x6559; @&#x5B50;&#x8083; @&#x6B65;&#x767D; @&#x9769;&#x65B0;&#x3002;&#x611F;&#x8C22;&#x4E24;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x5BA1;&#x7A3F;@&#x541E;&#x541E; @&#x6653;&#x7530;&#xFF1B;&#x4EE5;&#x53CA;&#x611F;&#x8C22;&#x8BA9;&#x6211;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x201D;&#x59CB;&#x4F5C;&#x4FD1;&#x8005;&#x201D; @&#x541E;&#x541E;&#xFF0C;&#x6CA1;&#x6709;&#x90A3;&#x6761;&#x606D;&#x559C;&#x63D0;&#x6848;&#x7684;&#x6D88;&#x606F;&#x6211;&#x4E5F;&#x4E0D;&#x4F1A;&#x53BB;&#x770B;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x81EA;&#x7136;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;&#x8FD8;&#x6709;&#x4E9B;&#x6CA1;&#x6709;&#x70B9;&#x540D;&#x7684;&#x670B;&#x53CB;&#xFF0C;&#x518D;&#x6B21;&#x4E5F;&#x4E00;&#x4E00;&#x611F;&#x8C22;&#x4E86;&#x3002;&#x591A;&#x52A9;&#x5F97;&#x9053;&#x3001;&#x5BE1;&#x52A9;&#x5931;&#x9053;&#xFF0C;&#x5BFB;&#x6C42;&#x5E2E;&#x52A9;&#x5BF9;&#x6211;&#x6765;&#x8BF4;&#x610F;&#x4E49;&#x5F88;&#x5927;&#xFF0C;&#x611F;&#x8C22;&#x5927;&#x5BB6;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x5728;&#x6709;&#x6536;&#x83B7;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x70B9;&#x8D5E;&#xFF0C;&#x53D1;&#x73B0;&#x9519;&#x8BEF;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x6307;&#x6B63;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e18b6744359e79d681dc89e018e2ff09.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="tags/Node-js-前端-C/" rel="tag"># Node.js,前端,C++</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="7232164444985622588.html" rel="next" title="Flutter 310 之 Flutter Web 路线已">
                <i class="fa fa-chevron-left"></i> Flutter 310 之 Flutter Web 路线已
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="7233964656287973436.html" rel="prev" title="Flutter 小技巧之 310 适配之单例 Window">
                Flutter 小技巧之 310 适配之单例 Window <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


    <!-- 有瓣音频文章内嵌广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6145016388"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    <div class="post-spread">
      
    </div>
  </div>
  <!-- 有瓣音频信息流广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-6t+ed+2i-1n-4w" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6455528644"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">1152</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">481</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、背景"><span class="nav-number">1.</span> <span class="nav-text">一、背景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#适合谁看"><span class="nav-number">1.1.</span> <span class="nav-text">适合谁看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Takeaway"><span class="nav-number">1.2.</span> <span class="nav-text">Takeaway</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、开门见山：什么是-AsyncLocalStorage"><span class="nav-number">2.</span> <span class="nav-text">二、开门见山：什么是 AsyncLocalStorage</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一个案例引入"><span class="nav-number">2.1.</span> <span class="nav-text">一个案例引入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方案1：全局变量"><span class="nav-number">2.2.</span> <span class="nav-text">方案1：全局变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方案2：直接透传参数"><span class="nav-number">2.3.</span> <span class="nav-text">方案2：直接透传参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方案3：今天的角，AsyncLocalStorage"><span class="nav-number">2.4.</span> <span class="nav-text">方案3：今天的角，AsyncLocalStorage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">2.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、历史合订：在-Node-js-14-之前的-Async-Local-Storage"><span class="nav-number">3.</span> <span class="nav-text">三、历史合订：在 Node.js 14 之前的 Async Local Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2013年：CLS横空出世（1-1k-Star）"><span class="nav-number">3.1.</span> <span class="nav-text">2013年：CLS横空出世（1.1k Star）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2017年：async-hooks"><span class="nav-number">3.2.</span> <span class="nav-text">2017年：async_hooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2017年：cls-hooked"><span class="nav-number">3.3.</span> <span class="nav-text">2017年：cls-hooked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2019年：AsyncLocalStorage（ALS）千呼万唤始出来"><span class="nav-number">3.4.</span> <span class="nav-text">2019年：AsyncLocalStorage（ALS）千呼万唤始出来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结-1"><span class="nav-number">3.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、异枝同根：ALS-与最新-TC39-提案-AsyncContext-的关系"><span class="nav-number">4.</span> <span class="nav-text">四、异枝同根：ALS 与最新 TC39 提案 AsyncContext 的关系</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、它山之石：其他语言中管理多线程上下文的方法"><span class="nav-number">5.</span> <span class="nav-text">五、它山之石：其他语言中管理多线程上下文的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java"><span class="nav-number">5.0.1.</span> <span class="nav-text">Java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C"><span class="nav-number">5.0.2.</span> <span class="nav-text">C++</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python"><span class="nav-number">5.0.3.</span> <span class="nav-text">Python</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#六、多走一步：AsyncLocalStorage-是如何实现的"><span class="nav-number">6.</span> <span class="nav-text">六、多走一步：AsyncLocalStorage 是如何实现的</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#I-Wonder-Where-the-API-Comes-From"><span class="nav-number">6.1.</span> <span class="nav-text">I Wonder Where the API Comes From</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Javascript-Zone"><span class="nav-number">6.2.</span> <span class="nav-text">Javascript Zone</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、再走一步：AsyncHook-是如何在-Node-Core-层实现的"><span class="nav-number">7.</span> <span class="nav-text">七、再走一步：AsyncHook 是如何在 Node Core 层实现的</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Intro-and-Guess"><span class="nav-number">7.1.</span> <span class="nav-text">Intro and Guess</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#C-World"><span class="nav-number">7.1.1.</span> <span class="nav-text">C++ World</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-Is-AsyncHook-Init-Invoked-by-Node-Core"><span class="nav-number">7.2.</span> <span class="nav-text">How Is AsyncHook.Init() Invoked by Node Core</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-where-is-callback-stored-in"><span class="nav-number">7.2.1.</span> <span class="nav-text">Step 1, where is callback stored in?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-which-code-line-is-responsible-for-calling-init-callback"><span class="nav-number">7.2.2.</span> <span class="nav-text">Step 2, which code line is responsible for calling init callback?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sum-Up-High-Level-Overview-Flowchart"><span class="nav-number">7.3.</span> <span class="nav-text">Sum Up: High-Level Overview Flowchart</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add-On"><span class="nav-number">7.4.</span> <span class="nav-text">Add-On</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#八、最后的最后：打个总结"><span class="nav-number">8.</span> <span class="nav-text">八、最后的最后：打个总结</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
