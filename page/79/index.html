<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/79/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/79/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340278606391738387.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340278606391738387.html" itemprop="url">【Android 13源码分析】Activity启动流程-3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T16:58:16+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#xFF0C;&#x672C;&#x7BC7;&#x4E3A;Activity&#x542F;&#x52A8;&#x7684;&#x7B2C;&#x4E09;&#x7BC7;&#xFF0C; &#x4E3B;&#x8981;&#x662F;&#x5728;&#x76EE;&#x6807;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x540E;&#x7684;&#x903B;&#x8F91;&#x3002;</p>
<ol>
<li><h1 id="&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;"><a href="#&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;" class="headerlink" title="&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;"></a>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;</h1></li>
</ol>
<p>java&#x7684;&#x65B9;&#x6CD5;&#x7684;main&#x51FD;&#x6570;<br>&#x5176;&#x5B9E;&#x5728;&#x6267;&#x884C;&#x5230;AMS::attachApplication&#x524D;&#xFF0C;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x4E5F;&#x6709;&#x4E00;&#x6BB5;&#x903B;&#x8F91;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityThread</span><br><span class="line">    // ApplicationThread &#x662F; AMS &#x4F5C;&#x4E3A; C &#x7AEF;&#x65F6;&#xFF0C;&#x4E0E;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x7684;&#x65B9;&#x5F0F;</span><br><span class="line">    final ApplicationThread mAppThread = new ApplicationThread();</span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        ......</span><br><span class="line">        // &#x91CD;&#x70B9; *1. &#x4E3B;&#x7EBF;&#x7A0B;Looper &#x5904;&#x7406;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;ActivityThread</span><br><span class="line">        // &#x4E3B;&#x7EBF;&#x7A0B;Looper</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        ......</span><br><span class="line">        ActivityThread thread = new ActivityThread();</span><br><span class="line">        thread.attach(false, startSeq);</span><br><span class="line">        // &#x4E3B;&#x7EBF;&#x7A0B;Looper</span><br><span class="line">         Looper.loop();</span><br><span class="line">    }</span><br><span class="line">    private void attach(boolean system, long startSeq) {</span><br><span class="line">        ......</span><br><span class="line">            final IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            try {</span><br><span class="line">                //&#x91CD;&#x70B9; *2.  &#x5C06;mAppThread&#x544A;&#x77E5;AMS&#xFF0C;&#x7528;&#x4E8E;AMS&#x4E0E;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;</span><br><span class="line">                mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">            } catch (RemoteException ex) {</span><br><span class="line">                throw ex.rethrowFromSystemServer();</span><br><span class="line">            }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#xFF08;&#x7535;&#x8BDD;&#xFF09;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x5728;main&#x65B9;&#x6CD5;&#x91CC;&#x4F1A;&#x6267;&#x884C;attach&#xFF0C;&#x5C31;&#x662F;&#x8981;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x4FE1;&#x606F;&#x544A;&#x77E5;AMS&#xFF0C;&#x6BD5;&#x7ADF;AMS &#x662F;&#x7BA1;&#x7406;&#x6A21;&#x5757;&#x3002;</p>
<ol start="2">
<li><h1 id="AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C;-realStartActivityLocked"><a href="#AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C;-realStartActivityLocked" class="headerlink" title="AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C; realStartActivityLocked"></a>AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C; realStartActivityLocked</h1></li>
</ol>
<p>&#x56E0;&#x4E3A;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4E5F;&#x4E0D;&#x662F;&#x7531;AMS&#x6267;&#x884C;&#xFF0C;AMS&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x5177;&#x4F53;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x597D;&#x540E;&#xFF0C;&#x4F1A;&#x6267;&#x884C; AMS::attachApplication&#x6765;&#x544A;&#x77E5;&#x3002; &#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;AMS&#x5C31;&#x77E5;&#x9053;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x5904;&#x7406;&#x540E;&#x7EED;&#x903B;&#x8F91;&#x4E86;</p>
<h2 id="2-1-&#x8C03;&#x7528;&#x94FE;"><a href="#2-1-&#x8C03;&#x7528;&#x94FE;" class="headerlink" title="2.1 &#x8C03;&#x7528;&#x94FE;"></a>2.1 &#x8C03;&#x7528;&#x94FE;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;AMS::attachApplication</span><br><span class="line">    AMS::attachApplicationLocked</span><br><span class="line">        ActivityThread::bindApplication</span><br><span class="line">            ActivityTaskManagerService.LocalService::attachApplication</span><br><span class="line">                WindowContainer::forAllRootTasks  --- &#x7701;&#x7565;forAllRootTasks&#x7B49;&#x56FA;&#x5B9A;&#x5806;&#x6808;</span><br><span class="line">                    Task::forAllRootTasks</span><br><span class="line">                        WindowContainer::forAllActivities</span><br><span class="line">                            ActivityRecord::forAllActivities</span><br><span class="line">                                RootWindowContainer.AttachApplicationHelper::test</span><br><span class="line">                                    RootWindowContainer.AttachApplicationHelper::test</span><br><span class="line">                                        ActivityTaskSupervisor::realStartActivityLocked  -- &#x6784;&#x5EFA;LaunchActivityItem</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/df061568cceb4ea83c4b9f9d7e4a8b9a79927e83e4b4e52d4817dbf6ab158b0f" alt="&#x8C03;&#x7528;&#x94FE;realStartActivityLocked.png"></p>
<p>&#x63A5;&#x4E0A;&#x4E00;&#x7BC7;&#x77E5;&#x9053;&#x5982;&#x679C;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x4E86;ActivityTaskSupervisor::startSpecificActivity&#x5C31;&#x4F1A;&#x8D70;&#x8FDB;&#x53BB;ActivityTaskSupervisor::realStartActivityLocked&#x3002;<br>&#x4F46;&#x662F;&#x53EF;&#x80FD;&#x4F1A;&#x597D;&#x5947;&#x600E;&#x4E48;&#x5C31;&#x77E5;&#x9053;&#x8981;&#x6267;&#x884C;&#x5E94;&#x7528;MainActivity&#x5230;onCreate&#x5C31;&#x4E00;&#x5B9A;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x5462;&#xFF1F; &#x8C03;&#x8BD5;&#x65B9;&#x6CD5;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#x52A0;log&#xFF0C;&#x6253;&#x5806;&#x6808;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x5E94;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x7684;&#x662F;&#xFF0C;&#x9700;&#x8981;&#x6267;&#x884C;Activity&#x542F;&#x52A8;&#x5230;onCreate&#x7684;&#x63A7;&#x5236;&#x5728;LaunchActivityItem&#x4E2D;&#xFF0C;&#x800C;LaunchActivityItem&#x5728;framework&#x7684;&#x5F15;&#x7528;&#x51FA;&#x4E86;&#x672C;&#x8EAB;&#xFF0C;&#x5C31;&#x53EA;&#x6709;&#x5728;ActivityTaskSupervisor&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/abe6ed303476e2d45795fa992fa4762eced986d1a27197730417592798b843cd" alt="&#x4E3A;&#x4EC0;&#x4E48;&#x770B;ActivityTaskSupervisor.png"></p>
<h2 id="2-2-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-2-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.2 &#x4E3B;&#x6D41;&#x7A0B;"></a>2.2 &#x4E3B;&#x6D41;&#x7A0B;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# AMS </span><br><span class="line">    // &#x5F53;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x8C03;&#x7528;attachApplication &#x6267;&#x884C;</span><br><span class="line">    public final void attachApplication(IApplicationThread thread, long startSeq) {</span><br><span class="line">        if (thread == null) {</span><br><span class="line">            throw new SecurityException(&quot;Invalid application interface&quot;);</span><br><span class="line">        }</span><br><span class="line">        synchronized (this) {</span><br><span class="line">            // &#x83B7;&#x53D6; &#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7684;&#x4FE1;&#x606F;&#x540E;&#x6267;&#x884C;attachApplicationLocked</span><br><span class="line">            int callingPid = Binder.getCallingPid();</span><br><span class="line">            final int callingUid = Binder.getCallingUid();</span><br><span class="line">            final long origId = Binder.clearCallingIdentity();</span><br><span class="line">            attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    private boolean attachApplicationLocked(@NonNull IApplicationThread thread,</span><br><span class="line">            int pid, int callingUid, long startSeq) {</span><br><span class="line">            // &#x9700;&#x8981;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x7684;&#x8FDB;&#x7A0B;&#x6570;&#x636E;</span><br><span class="line">            ProcessRecord app;</span><br><span class="line">            ......</span><br><span class="line">            if (pid != MY_PID &amp;&amp; pid &gt;= 0) {</span><br><span class="line">                synchronized (mPidsSelfLocked) {</span><br><span class="line">                    // &#x901A;&#x8FC7;mPidsSelfLocked&#x83B7;&#x53D6;</span><br><span class="line">                    app = mPidsSelfLocked.get(pid);</span><br><span class="line">                }</span><br><span class="line">                ......</span><br><span class="line">            } </span><br><span class="line">            ...... </span><br><span class="line">            // &#x89E6;&#x53D1;ActivityThread::bindApplication &#x903B;&#x8F91;</span><br><span class="line">            if (app.getIsolatedEntryPoint() != null) {</span><br><span class="line"></span><br><span class="line">            } else if (instr2 != null) {</span><br><span class="line">                // bindApplication</span><br><span class="line">                thread.bindApplication(processName, appInfo,</span><br><span class="line">                        app.sdkSandboxClientAppVolumeUuid, app.sdkSandboxClientAppPackage,</span><br><span class="line">                        providerList,</span><br><span class="line">                        instr2.mClass,</span><br><span class="line">                        profilerInfo, instr2.mArguments,</span><br><span class="line">                        instr2.mWatcher,</span><br><span class="line">                        instr2.mUiAutomationConnection, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        new Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.getCompat(), getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                        app.getDisabledCompatChanges(), serializedSystemFontMap,</span><br><span class="line">                        app.getStartElapsedTime(), app.getStartUptime());      </span><br><span class="line">            } else {</span><br><span class="line">                // bindApplication</span><br><span class="line">                thread.bindApplication(processName, appInfo,</span><br><span class="line">                        app.sdkSandboxClientAppVolumeUuid, app.sdkSandboxClientAppPackage,</span><br><span class="line">                        providerList, null, profilerInfo, null, null, null, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        new Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.getCompat(), getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                        app.getDisabledCompatChanges(), serializedSystemFontMap,</span><br><span class="line">                        app.getStartElapsedTime(), app.getStartUptime());</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            if (normalMode) {</span><br><span class="line">                try {</span><br><span class="line">                    // &#x91CD;&#x70B9; &#x89E6;&#x53D1;&#x6784;&#x5EFA; LaunchActivityItem &#x6D41;&#x7A0B;</span><br><span class="line">                    didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e);</span><br><span class="line">                    badApp = true;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x662F;&#x89E6;&#x53D1; LaunchActivityItem &#x7684;&#x6D41;&#x7A0B;&#x4E3B;&#x7EBF; , mAtmInternal&#x662F; ATMS &#x7684;&#x5185;&#x90E8;&#x7C7B; LocalService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskManagerService.LocalService</span><br><span class="line">        @Override</span><br><span class="line">        public boolean attachApplication(WindowProcessController wpc) throws RemoteException {</span><br><span class="line">            ......</span><br><span class="line">            return mRootWindowContainer.attachApplication(wpc);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line"># RootWindowContainer</span><br><span class="line">        boolean attachApplication(WindowProcessController app) throws RemoteException {</span><br><span class="line">            try {</span><br><span class="line">                return mAttachApplicationHelper.process(app);</span><br><span class="line">            } finally {</span><br><span class="line">                mAttachApplicationHelper.reset();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"># RootWindowContainer.AttachApplicationHelper</span><br><span class="line">        boolean process(WindowProcessController app) throws RemoteException {</span><br><span class="line">            mApp = app;</span><br><span class="line">            for (int displayNdx = getChildCount() - 1; displayNdx &gt;= 0; --displayNdx) {</span><br><span class="line">                // &#x91CD;&#x70B9;* &#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x5BB9;&#x5668;&#x7684; forAllRootTasks</span><br><span class="line">                getChildAt(displayNdx).forAllRootTasks(this);</span><br><span class="line">                if (mRemoteException != null) {</span><br><span class="line">                    throw mRemoteException;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x91CD;&#x70B9;&#x662F;&#x6267;&#x884C;&#x4E86;forAllRootTasks&#xFF0C;&#x5F53;&#x5B69;&#x5B50;&#x662F;RootTask&#x5BB9;&#x5668;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x6267;&#x884C;Lambda&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p>AttachApplicationHelper &#x5FC5;&#x7136;&#x5B9E;&#x73B0;&#x4E86; Consumer &#x63A5;&#x53E3;&#xFF0C; &#x76F4;&#x63A5;&#x770B;&#x5176; accept &#x5B9E;&#x73B0;&#x5373;&#x53EF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# RootWindowContainer.AttachApplicationHelper</span><br><span class="line">  private class AttachApplicationHelper implements Consumer&lt;Task&gt;, Predicate&lt;ActivityRecord&gt; {</span><br><span class="line">        ......</span><br><span class="line">        boolean process(WindowProcessController app) throws RemoteException {</span><br><span class="line">            mApp = app;</span><br><span class="line">            for (int displayNdx = getChildCount() - 1; displayNdx &gt;= 0; --displayNdx) {</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x5BB9;&#x5668;&#x7684; forAllRootTasks</span><br><span class="line">                getChildAt(displayNdx).forAllRootTasks(this);</span><br><span class="line">                if (mRemoteException != null) {</span><br><span class="line">                    throw mRemoteException;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        @Override</span><br><span class="line">        public void accept(Task rootTask) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x6267;&#x884C; topRunningActivity</span><br><span class="line">            mTop = rootTask.topRunningActivity();</span><br><span class="line">            // &#x91CD;&#x70B9;*2. &#x6267;&#x884C;accept &#x8BA9;&#x5BB9;&#x5668;&#x4E0B;&#x7684;&#x6BCF;&#x4E2A; ActivityRecord &#x6267;&#x884C;</span><br><span class="line">            rootTask.forAllActivities(this);</span><br><span class="line">        }</span><br><span class="line">        @Override</span><br><span class="line">        public boolean test(ActivityRecord r) {</span><br><span class="line">            ......</span><br><span class="line">            try {</span><br><span class="line">                // &#x91CD;&#x70B9;*3. &#x6267;&#x884C; realStartActivityLocked &#x89E6;&#x53D1;&#x521B;&#x5EFA;LaunchActivityItem</span><br><span class="line">                if (mTaskSupervisor.realStartActivityLocked(r, mApp,</span><br><span class="line">                        mTop == r &amp;&amp; r.getTask().canBeResumed(r) /* andResume */,</span><br><span class="line">                        true /* checkConfig */)) {</span><br><span class="line">                    mHasActivityStarted = true;</span><br><span class="line">                }</span><br><span class="line">            } catch (RemoteException e) {</span><br><span class="line">                Slog.w(TAG, &quot;Exception in new application when starting activity &quot; + mTop, e);</span><br><span class="line">                mRemoteException = e;</span><br><span class="line">                return true;</span><br><span class="line">            }</span><br><span class="line">            return false;</span><br><span class="line">        }</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x91CD;&#x70B9;&#x5206;&#x6790;&#xFF1A;<br>AttachApplicationHelper &#x5B9E;&#x73B0;&#x7C7B;Consumer&#xFF0C;Predicate&#x63A5;&#x53E3;&#x3002; &#x5BF9;&#x5E94;&#x8981;&#x5B9E;&#x73B0;&#x7684;&#x51FD;&#x6570;&#x5206;&#x522B;&#x4E3A;accept&#x548C;test</p>
<ol>
<li>RootWindowContainer &#x7684; child &#x81EA;&#x7136;&#x662F; WindowContainer</li>
</ol>
<p>&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x6709;&#x4E2A;&#x7591;&#x95EE;&#x5C31;&#x662F; forAllRootTasks &#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x65B9;&#x6CD5;&#x6709;2&#x4E2A;&#x91CD;&#x8F7D;&#xFF0C;&#x53C2;&#x6570;&#x5206;&#x522B;&#x4E3A;Consumer &#x63A5;&#x53E3;&#x548C;Predicate &#x63A5;&#x53E3;&#x3002; &#x5F53;&#x524D;&#x7684;AttachApplicationHelper&#x7C7B;&#x8FD9;&#x4E24;&#x4E2A;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;<br>&#x600E;&#x4E48;&#x5224;&#x65AD;&#x6267;&#x884C;&#x7684;&#x662F;&#x54EA;&#x4E2A;&#x5462;&#xFF1F;<br>&#x7B54;&#x6848;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C; &#x53EA;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x6CDB;&#x578B;&#x53C2;&#x6570;&#x5373;&#x53EF;&#x3002;<br>2. &#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x89E3;&#x91CA;&#xFF0C; &#x7B2C;&#x4E8C;&#x6B65;&#x6267;&#x884C; accept&#x56DE;&#x8C03;&#xFF0C; &#x5185;&#x90E8;&#x6267;&#x884C; Task::forAllActivities &#x51FD;&#x6570;&#xFF0C; &#x4F46;&#x662F;Task&#x672C;&#x8EAB;&#x6CA1;&#x6709;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C; &#x8BE5;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5728;&#x7236;&#x7C7B; WindowContainer &#x4E2D;</p>
<ol start="3">
<li>&#x90A3;&#x4E48;&#x903B;&#x8F91;&#x5C31;&#x6765;&#x5230;&#x4E86;&#x6C14;&#x5230;&#x7684;realStartActivityLocked &#xFF0C;&#x5176;&#x5185;&#x90E8;&#x4F1A;&#x6784;&#x5EFA; LaunchActivityItem&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x3010;Activity&#x751F;&#x547D;&#x5468;&#x671F;&#x4E8B;&#x52A1;&#x6267;&#x884C;&#x903B;&#x8F91;&#x3011;&#x6709;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;<br>&#x5728;&#x628A; ActivityTaskSupervisor::realStartActivityLocked&#x65B9;&#x6CD5;&#x770B;&#x4E00;&#x4E0B;&#xFF0C;&#x73B0;&#x5728;&#x5DF2;&#x77E5; setLifecycleStateRequest&#x4E3A;ResumeActivityItem</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskSupervisor </span><br><span class="line"></span><br><span class="line">    boolean realStartActivityLocked(ActivityRecord r, WindowProcessController proc,</span><br><span class="line">            boolean andResume, boolean checkConfig) throws RemoteException {</span><br><span class="line">            //  &#x91CD;&#x70B9;* &#x5224;&#x65AD;&#x662F;&#x5426;&#x6267;&#x884C;&#x5B8C;&#x4E86;pause &#x3002; &#x4E5F;&#x5C31;&#x662F;2&#x4E2A;&#x6761;&#x4EF6;&#x4E4B;&#x4E00;&#xFF0C;&#x5FC5;&#x987B;&#x8981;&#x6267;&#x884C;&#x5B8C;pause&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x540E;&#x9762;</span><br><span class="line">            if (!mRootWindowContainer.allPausedActivitiesComplete()) {</span><br><span class="line">                // While there are activities pausing we skipping starting any new activities until</span><br><span class="line">                // pauses are complete. NOTE: that we also do this for activities that are starting in</span><br><span class="line">                // the paused state because they will first be resumed then paused on the client side.</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES,</span><br><span class="line">                        &quot;realStartActivityLocked: Skipping start of r=%s some activities pausing...&quot;,</span><br><span class="line">                        r);</span><br><span class="line">                return false;</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x521B;&#x5EFA;Activity&#x542F;&#x52A8;&#x4E8B;&#x52A1;.</span><br><span class="line">                final ClientTransaction clientTransaction = ClientTransaction.obtain(proc.getThread(), r.token);</span><br><span class="line">                // &#x5224;&#x65AD;Activity&#x662F;&#x5426;&#x5904;&#x4E8E;&#x5411;&#x524D;&#x8F6C;&#x573A;&#x72B6;&#x6001;</span><br><span class="line">                final boolean isTransitionForward = r.isTransitionForward();</span><br><span class="line">                // &#x83B7;&#x53D6;Activity&#x6240;&#x5728; TaskFragment Token</span><br><span class="line">                final IBinder fragmentToken = r.getTaskFragment().getFragmentToken();</span><br><span class="line">                // &#x91CD;&#x70B9;*2. &#x5C06;&#x6784;&#x5EFA;&#x7684; LaunchActivityItem &#x6DFB;&#x52A0;&#x5230; clientTransaction &#x4E2D;</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        // TODO: Have this take the merged configuration instead of separate global</span><br><span class="line">                        // and override configs.</span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.getFilteredReferrer(r.launchedFromPackage), task.voiceInteractor,</span><br><span class="line">                        proc.getReportedProcState(), r.getSavedState(), r.getPersistentSavedState(),</span><br><span class="line">                        results, newIntents, r.takeOptions(), isTransitionForward,</span><br><span class="line">                        proc.createProfilerInfoIfNeeded(), r.assistToken, activityClientController,</span><br><span class="line">                        r.shareableActivityToken, r.getLaunchedFromBubble(), fragmentToken));</span><br><span class="line">                // &#x91CD;&#x70B9;*3. &#x8BBE;&#x7F6E;&#x9884;&#x671F;&#x7684;&#x6700;&#x7EC8;&#x72B6;&#x6001;</span><br><span class="line">                final ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                if (andResume) {</span><br><span class="line">                    // Resume&#x903B;&#x8F91;,&#x542F;&#x52A8;&#x8D70;&#x7684;&#x8FD9;&#x3002; &#x8868;&#x793A;&#x9700;&#x8981;&#x6267;&#x884C;&#x5230;onCreate</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(isTransitionForward);</span><br><span class="line">                } else {</span><br><span class="line">                    //  Pause &#x903B;&#x8F91;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                }</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line">                // &#x91CD;&#x70B9;*4. &#x8C03;&#x5EA6;&#x4E8B;&#x52A1;&#xFF0C;&#x5C06;clientTransaction&#x6DFB;&#x52A0;&#x5230;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x5668;&#x4E2D;</span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h2 id="2-2-1-LaunchActivityItem-handleLaunchActivity-&#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;"><a href="#2-2-1-LaunchActivityItem-handleLaunchActivity-&#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;" class="headerlink" title="2.2.1 LaunchActivityItem handleLaunchActivity &#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;"></a>2.2.1 LaunchActivityItem handleLaunchActivity &#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;</h2><h3 id="2-2-1-1-&#x8C03;&#x7528;&#x94FE;"><a href="#2-2-1-1-&#x8C03;&#x7528;&#x94FE;" class="headerlink" title="2.2.1.1 &#x8C03;&#x7528;&#x94FE;"></a>2.2.1.1 &#x8C03;&#x7528;&#x94FE;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;LaunchActivityItem::execute</span><br><span class="line">    ActivityThread::handleLaunchActivity</span><br><span class="line">        ActivityThread::performLaunchActivity</span><br><span class="line">            Instrumentation::newActivity --- &#x521B;&#x5EFA;Activity</span><br><span class="line">            Activity::attach  ---&#x5904;&#x7406;Window&#x76F8;&#x5173;</span><br><span class="line">                Window::init</span><br><span class="line">                Window::setWindowManager</span><br><span class="line">            Instrumentation::callActivityOnCreate ---onCreate&#x6D41;&#x7A0B;</span><br><span class="line">                Activity::performCreate</span><br><span class="line">                    Activity::onCreate  --over</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-2-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-2-1-2-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.2.1.2 &#x4E3B;&#x6D41;&#x7A0B;"></a>2.2.1.2 &#x4E3B;&#x6D41;&#x7A0B;</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x770B; LaunchActivityItem::execute</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;# LaunchActivityItem </span><br><span class="line">    public void execute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</span><br><span class="line">        ActivityClientRecord r = new ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">                mPendingResults, mPendingNewIntents, mActivityOptions, mIsForward, mProfilerInfo,</span><br><span class="line">                client, mAssistToken, mShareableActivityToken, mLaunchedFromBubble,</span><br><span class="line">                mTaskFragmentToken);</span><br><span class="line">        client.handleLaunchActivity(r, pendingActions, null /* customIntent */);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684; client &#x662F; ClientTransactionHandler &#x7C7B;&#x578B;&#xFF0C; &#x800C; ActivityThread &#x662F; ClientTransactionHandler&#x5B50;&#x7C7B;</p>
<p><strong>&#x91CD;&#x70B9;&#x662F;&#x8FD9;&#x8FB9;&#x521B;&#x5EFA;&#x4E86;ActivityClientRecord&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8981;&#x627E;&#x7684;token</strong></p>
<p>&#x903B;&#x8F91;&#x6765;&#x5230;&#x5E94;&#x7528;&#x8FDB;&#x7A0B; ActivityThread</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityThread</span><br><span class="line"></span><br><span class="line">    public Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">                PendingTransactionActions pendingActions, Intent customIntent) {</span><br><span class="line">                    ......</span><br><span class="line">                    final Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">    private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {</span><br><span class="line">        ......</span><br><span class="line">                Activity activity = null;</span><br><span class="line">                try {</span><br><span class="line">                    // &#x91CD;&#x70B9;* 1. &#x901A;&#x8FC7;Instrumentation &#x53CD;&#x5C04;&#x521B;&#x5EFA;Activity</span><br><span class="line">                    java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">                    activity = mInstrumentation.newActivity(</span><br><span class="line">                            cl, component.getClassName(), r.intent);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">                try {</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x91CD;&#x70B9;* 2. &#x6267;&#x884C; attach &#x6D41;&#x7A0B;</span><br><span class="line">                    activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">                            r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                            r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                            r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                            r.assistToken, r.shareableActivityToken);</span><br><span class="line">                    if (r.isPersistable()) {</span><br><span class="line">                        mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                    } else {</span><br><span class="line">                        &#x91CD;&#x70B9;* 3. OnCreate&#x6D41;&#x7A0B;</span><br><span class="line">                        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"># Instrumentation</span><br><span class="line">    public void callActivityOnCreate(Activity activity, Bundle icicle) {</span><br><span class="line">        prePerformCreate(activity);</span><br><span class="line">        // onCreate&#x6D41;&#x7A0B;</span><br><span class="line">        activity.performCreate(icicle);</span><br><span class="line">        postPerformCreate(activity);</span><br><span class="line">    }</span><br><span class="line"># Activity</span><br><span class="line">    final void performCreate(Bundle icicle) {</span><br><span class="line">        performCreate(icicle, null);</span><br><span class="line">    }</span><br><span class="line">    final void performCreate(Bundle icicle, PersistableBundle persistentState) {</span><br><span class="line">        ......</span><br><span class="line">        if (persistentState != null) {</span><br><span class="line">            onCreate(icicle, persistentState);</span><br><span class="line">        } else {</span><br><span class="line">            // &#x6267;&#x884C;onCreate</span><br><span class="line">            onCreate(icicle);</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x5199;&#x8FC7;&#x5E94;&#x7528;&#x7684;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x9ED8;&#x8BA4;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x7684;onCreate&#x3002;<br>&#x6D41;&#x7A0B;&#x7ED3;&#x675F;</p>
<p>tip:&#x5728;&#x6DFB;&#x52A0;&#x56DE;&#x8C03;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD8;&#x52A0;&#x4E86;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C; &#x56E0;&#x4E3A; LaunchActivityItem &#x53EA;&#x662F;&#x521B;&#x5EFA;&#xFF0C;&#x4F46;&#x662F;&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x6267;&#x884C;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;<br>&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x90FD;&#x662F;&#x5E0C;&#x671B;&#x6267;&#x884C;&#x5230;onResume&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x8BBE;&#x7F6E; ResumeActivityItem,&#x4E0D;&#x8FC7;&#x4E0D;&#x662F;&#x5206;&#x6790;&#x91CD;&#x70B9;&#xFF0C;&#x53EF;&#x81EA;&#x884C;&#x4E86;&#x89E3;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e21a714e0aa8a5b3425fc1edae62a909.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340464722279661579.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340464722279661579.html" itemprop="url">【Android 13源码分析】Activity启动流程-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T16:57:47+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#xFF0C;&#x672C;&#x7BC7;&#x4E3A;&#x7B2C;&#x4E8C;&#x7BC7;&#x3002;</p>
<p>&#x63A5;<a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a>&#x5728;ActivityStarer::startActivityInner&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;getOrCreateRootTask&#x65B9;&#x6CD5;&#x521B;&#x5EFA;Task&#xFF0C;&#x800C;&#x540E;&#x901A;&#x8FC7;setNewTask&#x65B9;&#x6CD5;&#x5C06;&#x65B0;&#x5EFA;&#x7684;ActivityRecord&#x8FDB;&#x884C;&#x6302;&#x5728;&#x5230;&#x65B0;&#x5EFA;&#x7684;Task&#x4E0A;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x9700;&#x8981;&#x5904;&#x7406;&#x65B0;&#x7684;Activity&#x542F;&#x52A8;&#x548C;&#x663E;&#x793A;&#x903B;&#x8F91;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x7684;&#x6D41;&#x7A0B;&#x7531;resumeFocusedTasksTopActivities&#x6267;&#x884C;&#x3002;</p>
<h1 id="&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities"><a href="#&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities" class="headerlink" title="&#x663E;&#x793A;Activity resumeFocusedTasksTopActivities"></a>&#x663E;&#x793A;Activity resumeFocusedTasksTopActivities</h1><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;RootWindowContainer::resumeFocusedTasksTopActivities</span><br><span class="line">    Task::resumeTopActivityUncheckedLocked</span><br><span class="line">        Task::resumeTopActivityInnerLocked</span><br><span class="line">            TaskFragment::resumeTopActivity </span><br><span class="line">                TaskDisplayArea::pauseBackTasks  --   2.2.1 pause LauncherActivity </span><br><span class="line">                    WindowContainer::forAllLeafTask</span><br><span class="line">                        TaskFragment::forAllLeafTaskFragments</span><br><span class="line">                            TaskFragment::startPausing</span><br><span class="line">                                TaskFragment::startPausing</span><br><span class="line">                                    TaskFragment::schedulePauseActivity --&#x6784;&#x5EFA; PauseActivityItem&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x89E6;&#x53D1;&#x6682;&#x505C;launch</span><br><span class="line">                ActivityTaskManagerService::startProcessAsync     -- 2.2.2&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x7ECF;&#x8FC7;&#x51E0;&#x6B21;&#x8C03;&#x7528;&#x4F1A;&#x6267;&#x884C;&#x5230;TaskFragment::resumeTopActivity&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x975E;&#x5E38;&#x590D;&#x6742;,&#x573A;&#x666F;&#x4E0D;&#x540C;&#x6267;&#x884C;&#x7684;&#x5206;&#x652F;&#x4E5F;&#x4E0D;&#x540C;,&#x503C;&#x5F97;&#x91CD;&#x70B9;&#x5206;&#x6790;&#x3002;&#x800C;&#x4E14;&#x5F88;&#x591A;&#x91CD;&#x8981;&#x7684;&#x903B;&#x8F91;&#x90FD;&#x96C6;&#x4E2D;&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x540E;&#x7EED;&#x4F1A;&#x88AB;&#x91CD;&#x6784;&#x7684;&#x3002;<br>&#x5F53;&#x524D;&#x8FD8;&#x662F;&#x53EA;&#x5206;&#x6790;launcher &#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;&#x573A;&#x666F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    final boolean resumeTopActivity(ActivityRecord prev, ActivityOptions options,</span><br><span class="line">            boolean deferPause) {</span><br><span class="line">                // &#x8FD9;&#x91CC;&#x7684;next&#x8FD4;&#x56DE;&#x7684;&#x662F; &#x7535;&#x8BDD;&#x7684;main activity&#xFF0C;&#x8868;&#x793A;&#x4E0B;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x73B0;&#x5B9E;&#x7684;</span><br><span class="line">                ActivityRecord next = topRunningActivity(true /* focusableOnly */);</span><br><span class="line">                ......</span><br><span class="line">                // &#x5982;&#x679C;&#x8DF3;&#x8FC7;&#x7684;&#x8FD9;&#x4E9B;&#x903B;&#x8F91;&#x90FD;&#x6CA1;&#x6267;&#x884C;return&#xFF0C;&#x5219;&#x6B63;&#x5728;&#x5F00;&#x59CB;&#x6267;&#x884C; resume&#x6D41;&#x7A0B;&#xFF0C;&#x6253;&#x5370;&#x5173;&#x952E;&#x65E5;&#x5FD7;&#x3002;    </span><br><span class="line">                // &#x524D;&#x9762;&#x6D41;&#x7A0B;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x4E5F;&#x6709;&#x54CD;&#x5E94;&#x65E5;&#x5FD7;&#x7684;&#x6253;&#x5370;</span><br><span class="line">                // &#x6253;&#x5370;&#x65E5;&#x5FD7;&#xFF0C;&#x9700;&#x8981;&#x663E;&#x793A;&#x54EA;&#x4E2A;Activity</span><br><span class="line">                if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, &quot;Resuming &quot; + next);</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;* 1. &#x8FD9;&#x91CC;&#x4F1A;&#x5C06; launch&#x7684;Activity pause &#x3002;&#x53C2;&#x6570;&#x662F; &#x7535;&#x8BDD;&#x7684;ActivityRecord</span><br><span class="line">                boolean pausing = !deferPause &amp;&amp; taskDisplayArea.pauseBackTasks(next);</span><br><span class="line">                ......</span><br><span class="line">                if (pausing) {</span><br><span class="line">                    ProtoLog.v(WM_DEBUG_STATES, &quot;resumeTopActivity: Skip resume: need to&quot;+ &quot; start pausing&quot;);</span><br><span class="line">                    if (next.attachedToProcess()) {</span><br><span class="line">                        ......</span><br><span class="line">                    } else if (!next.isProcessRunning()) {</span><br><span class="line">                        // &#x91CD;&#x70B9;*2. &#x8FDB;&#x7A0B;&#x6CA1;&#x6709;&#x8FD0;&#x884C;&#xFF0C;&#x5219;&#x89E6;&#x53D1;&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002; &#x5F53;&#x524D;&#x903B;&#x8F91;&#x80AF;&#x5B9A;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x4E00;&#x6761;</span><br><span class="line">                        final boolean isTop = this == taskDisplayArea.getFocusedRootTask();</span><br><span class="line">                        mAtmService.startProcessAsync(next, false /* knownToBeDead */, isTop,</span><br><span class="line">                            isTop ? HostingRecord.HOSTING_TYPE_NEXT_TOP_ACTIVITY</span><br><span class="line">                                    : HostingRecord.HOSTING_TYPE_NEXT_ACTIVITY);</span><br><span class="line">                    }</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;return&#xFF0C;</span><br><span class="line">                    return true;</span><br><span class="line">                }</span><br><span class="line">                ......</span><br><span class="line">                //&#x540E;&#x9762;&#x8FD8;&#x6709;&#x91CD;&#x8981;&#x903B;&#x8F91;&#xFF0C;&#x5F53;&#x524D;&#x53EF;&#x5FFD;&#x7565;</span><br><span class="line">            }</span><br></pre></td></tr></table></figure>

<p>&#x91CD;&#x70B9;&#x5206;&#x6790;:<br>&#x4E0A;&#x9762;&#x8BF4;&#x8FC7;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x5728;&#x5F53;&#x524D;&#x903B;&#x8F91;&#x6709;2&#x4E2A;&#x4E3B;&#x7EBF;</p>
<ol>
<li>pause&#x5F53;&#x524D;Activity&#xFF0C;&#x4E5F;&#x5C31;&#x662F;launcher</li>
<li>&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;&#x8FDB;&#x7A0B;</li>
</ol>
<p>&#x5728;&#x7B2C;&#x4E00;&#x6B65;&#x5C06;launcher&#x7684;Activity&#x6267;&#x884C;pauser&#xFF0C; &#x8FD9;&#x4E00;&#x6B65;&#x6267;&#x884C;&#x5230;&#x6700;&#x540E;&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B65;&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#xFF0C;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x80AF;&#x5B9A;&#x4E5F;&#x4F1A;&#x6267;&#x884C;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#xFF0C;&#x8FD9;&#x4E48;&#x770B;&#x6765;&#x5C31;&#x6709;2&#x4E2A;&#x5730;&#x65B9;&#x89E6;&#x53D1;&#x4E86;&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x662F;&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x8C01;&#x5148;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x660E;&#x786E;&#x7684;&#x662F;&#xFF0C;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x5FC5;&#x987B;&#x6709;2&#x4E2A;&#x6761;&#x4EF6;&#xFF1A;</p>
<ol>
<li>&#x524D;&#x4E00;&#x4E2A;Activity&#x6267;&#x884C;&#x5B8C;pause</li>
<li>&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6210;</li>
</ol>
<p><strong>&#x6240;&#x4EE5;&#x65E0;&#x8BBA;2&#x4E2A;&#x5206;&#x652F;&#x54EA;&#x4E00;&#x4E2A;&#x5148;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x7B49;&#x540E;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x5B8C;&#x7684;&#x6765;&#x89E6;&#x53D1;&#x540E;&#x7EED;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#x3002;</strong></p>
<p>&#x5148;&#x770B;launcher&#x7684;pause&#x6D41;&#x7A0B;</p>
<ol>
<li><h1 id="pause-&#x6D41;&#x7A0B;-pauseBackTasks"><a href="#pause-&#x6D41;&#x7A0B;-pauseBackTasks" class="headerlink" title="pause &#x6D41;&#x7A0B; pauseBackTasks"></a>pause &#x6D41;&#x7A0B; pauseBackTasks</h1></li>
</ol>
<p>&#x9700;&#x8981;&#x663E;&#x793A;&#x65B0;&#x7684;Activity&#xFF0C;&#x90A3;&#x4E48;&#x4E4B;&#x524D;&#x7684;&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x6267;&#x884C;pause&#x7684;&#xFF0C;&#x5C31;&#x5728;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x3002;&#x53C2;&#x6570;next&#x4E3A;&#x201C;&#x7535;&#x8BDD;&#x7684;&#x201D;ActivityRecord</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskDisplayArea</span><br><span class="line"></span><br><span class="line">    // &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;ActivityRecord&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x88AB;&#x79F0;&#x4E3A;resuming</span><br><span class="line">    boolean pauseBackTasks(ActivityRecord resuming) {</span><br><span class="line">        final int[] someActivityPaused = {0};</span><br><span class="line">        forAllLeafTasks(leafTask -&gt; {</span><br><span class="line">            // Check if the direct child resumed activity in the leaf task needed to be paused if</span><br><span class="line">            // the leaf task is not a leaf task fragment.</span><br><span class="line">            if (!leafTask.isLeafTaskFragment()) {</span><br><span class="line">                // &#x5F53;&#x524D;&#x4E0D;&#x4F1A;&#x8D70;&#x8FD9;&#x91CC;</span><br><span class="line">                final ActivityRecord top = topRunningActivity();</span><br><span class="line">                final ActivityRecord resumedActivity = leafTask.getResumedActivity();</span><br><span class="line">                if (resumedActivity != null &amp;&amp; top.getTaskFragment() != leafTask) {</span><br><span class="line">                    // Pausing the resumed activity because it is occluded by other task fragment.</span><br><span class="line">                    if (leafTask.startPausing(false /* uiSleeping*/, resuming, &quot;pauseBackTasks&quot;)) {</span><br><span class="line">                        someActivityPaused[0]++;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            leafTask.forAllLeafTaskFragments((taskFrag) -&gt; {</span><br><span class="line">                final ActivityRecord resumedActivity = taskFrag.getResumedActivity();</span><br><span class="line">                if (resumedActivity != null &amp;&amp; !taskFrag.canBeResumed(resuming)) {</span><br><span class="line">                    if (taskFrag.startPausing(false /* uiSleeping*/, resuming, &quot;pauseBackTasks&quot;)) {</span><br><span class="line">                        someActivityPaused[0]++;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }, true /* traverseTopToBottom */);</span><br><span class="line">        }, true /* traverseTopToBottom */);</span><br><span class="line">        return someActivityPaused[0] &gt; 0;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>forAllLeafTasks&#x548C;forAllLeafTaskFragments&#x5728;&#x3010;<a href="https://dev.newban.cn/7342330487078699047">WMS/AMS &#x5E38;&#x89C1;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x63D0;&#x53D6;</a>&#x3011;&#x4E2D;&#x6709;&#x89E3;&#x91CA;&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x524D;&#x8FD9;&#x6BB5;&#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8BA9;DefaultTaskDisplayArea&#x4E0B;&#x7684;&#x6BCF;&#x4E2A;&#x53F6;&#x5B50;LeafTaskFragments&#x6267;&#x884C;startPausing&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    boolean startPausing(boolean userLeaving, boolean uiSleeping, ActivityRecord resuming,</span><br><span class="line">            String reason) {</span><br><span class="line">        ......</span><br><span class="line">        // &#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x5F53;&#x524D;TaskFragment&#x548C;mResumedActivity&#x7684;&#x5173;&#x7CFB;&#x3002;&#x540E;&#x9762;&#x4F1A;&#x8D34;&#x4E0A;&#x65E5;&#x5FD7;&#x8BC1;&#x660E;</span><br><span class="line">        ProtoLog.d(WM_DEBUG_STATES, &quot;startPausing: taskFrag =%s &quot; + &quot;mResumedActivity=%s&quot;, this,</span><br><span class="line">                mResumedActivity);</span><br><span class="line">        ......</span><br><span class="line">        //  &#x540E;&#x9762;&#x7684;prev&#x5C31;&#x662F;launcher&#x7684;ActivityRecord&#x4E86;</span><br><span class="line">        ActivityRecord prev = mResumedActivity;</span><br><span class="line">        ......</span><br><span class="line">        // &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Moving to PAUSING: %s&quot;, prev);</span><br><span class="line">        mPausingActivity = prev;</span><br><span class="line">        mLastPausedActivity = prev;</span><br><span class="line">        if (!prev.finishing &amp;&amp; prev.isNoHistory()</span><br><span class="line">                &amp;&amp; !mTaskSupervisor.mNoHistoryActivities.contains(prev)) {</span><br><span class="line">            mTaskSupervisor.mNoHistoryActivities.add(prev);</span><br><span class="line">        }</span><br><span class="line">        // &#x8BBE;&#x7F6E;window&#x72B6;&#x6001;&#x4E3A;PAUSING</span><br><span class="line">        prev.setState(PAUSING, &quot;startPausingLocked&quot;);</span><br><span class="line">        prev.getTask().touchActiveTime();</span><br><span class="line">        ......</span><br><span class="line">        if (prev.attachedToProcess()) {</span><br><span class="line">            // launcher&#x7684;&#x8FDB;&#x7A0B;&#x80AF;&#x5B9A;&#x662F;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;</span><br><span class="line">            if (shouldAutoPip) {</span><br><span class="line">                boolean didAutoPip = mAtmService.enterPictureInPictureMode(</span><br><span class="line">                        prev, prev.pictureInPictureArgs);</span><br><span class="line">                ProtoLog.d(WM_DEBUG_STATES, &quot;Auto-PIP allowed, entering PIP mode &quot;</span><br><span class="line">                        + &quot;directly: %s, didAutoPip: %b&quot;, prev, didAutoPip);</span><br><span class="line">            } else {</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x6839;&#x636E;&#x5806;&#x6808;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x91CC;&#x3002;&#x4E0A;&#x9762;&#x7684;PIP&#x65E5;&#x5FD7;&#x6CA1;&#x8F93;&#x51FA;&#xFF0C;&#x4E5F;&#x80FD;&#x786E;&#x5B9A;&#x662F;&#x8D70;&#x7684;&#x8FD9;&#x4E2A;</span><br><span class="line">                schedulePauseActivity(prev, userLeaving, pauseImmediately, reason);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    void schedulePauseActivity(ActivityRecord prev, boolean userLeaving,</span><br><span class="line">            boolean pauseImmediately, String reason) {</span><br><span class="line">        // &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Enqueueing pending pause: %s&quot;, prev);</span><br><span class="line">        try {</span><br><span class="line">            // &#x8F93;&#x51FA;events &#x65E5;&#x5FD7;</span><br><span class="line">            EventLogTags.writeWmPauseActivity(prev.mUserId, System.identityHashCode(prev),</span><br><span class="line">                    prev.shortComponentName, &quot;userLeaving=&quot; + userLeaving, reason);</span><br><span class="line">            // &#x91CD;&#x70B9;&#x6784;&#x5EFA;&#x5E76;&#x6267;&#x884C;PauseActivityItem</span><br><span class="line">            mAtmService.getLifecycleManager().scheduleTransaction(prev.app.getThread(),</span><br><span class="line">                    prev.token, PauseActivityItem.obtain(prev.finishing, userLeaving,</span><br><span class="line">                            prev.configChangeFlags, pauseImmediately));</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            // Ignore exception, if process died other code will cleanup.</span><br><span class="line">            Slog.w(TAG, &quot;Exception thrown during pause&quot;, e);</span><br><span class="line">            mPausingActivity = null;</span><br><span class="line">            mLastPausedActivity = null;</span><br><span class="line">            mTaskSupervisor.mNoHistoryActivities.remove(prev);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6700;&#x7EC8;&#x5728;TaskFragment::schedulePauseActivity&#x6784;&#x5EFA;&#x5E76;&#x6267;&#x884C;&#x4E86;launcher&#x7684;pause&#x4E8B;&#x4EF6;&#x3002;<br>&#x8FD9;&#x5757;&#x76F8;&#x5173;&#x7684;&#x65E5;&#x5FD7;&#x8F93;&#x5165;&#x5982;&#x56FE;:<br>&#x56E0;&#x4E3A;&#x662F;&#x540E;&#x9762;&#x8865;&#x5145;&#x7684;&#x6240;&#x4EE5;&#x5BF9;&#x8C61;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x662F;&#x80FD;&#x786E;&#x5B9A;&#x8FD9;&#x91CC;&#x5904;&#x7406;&#x7684;TaskFragment&#x548C;mResumedActivity&#x90FD;&#x662F;launcher&#x5BF9;&#x8C61;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d5842087f67b79507da27f0f9546c6f4151dd0ae62db331f6022eb0afb5042c" alt="Plotolog-startPausing.png"></p>
<p>tip:<br>State movement&#x8FD9;&#x6BB5;&#x7684;&#x8F93;&#x51FA;&#x662F;&#x5728;ActivityRecord::setState &#x53EA;&#x6709;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x90FD;&#x4F1A;&#x8F93;&#x51FA;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x91CD;&#x70B9;&#x662F;&#x770B;PauseActivityItem&#x7684;&#x6267;&#x884C;&#x903B;&#x8F91;</p>
<h2 id="1-1-PauseActivityItem"><a href="#1-1-PauseActivityItem" class="headerlink" title="1.1 PauseActivityItem"></a>1.1 PauseActivityItem</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# PauseActivityItem</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void execute(ClientTransactionHandler client, ActivityClientRecord r,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityPause&quot;);</span><br><span class="line">        // &#x91CD;&#x70B9;*1. &#x89E6;&#x53D1; handlePauseActivity &#x6D41;&#x7A0B;</span><br><span class="line">        client.handlePauseActivity(r, mFinished, mUserLeaving, mConfigChanges, pendingActions,</span><br><span class="line">                &quot;PAUSE_ACTIVITY_ITEM&quot;);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getTargetState() {</span><br><span class="line">        return ON_PAUSE;</span><br><span class="line">    }</span><br><span class="line">    //  pauser&#x6267;&#x884C;&#x540E;&#x8C03;&#x7528; postExecute</span><br><span class="line">    @Override</span><br><span class="line">    public void postExecute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        if (mDontReport) {</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        //  &#x91CD;&#x70B9;*2. &#x89E6;&#x53D1;&#x542F;&#x52A8;&#x65B0;&#x7684;Activity</span><br><span class="line">        ActivityClient.getInstance().activityPaused(token);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x9ED8;&#x8BA4;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;ClientTransaction&#x8C03;&#x7528;&#x903B;&#x8F91;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x79FB;&#x6B65;&#x3010;&#x3011;<br>&#x8FD9;&#x91CC;&#x5148;&#x6267;&#x884C;execute &#x7684;&#x903B;&#x8F91;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; launcher&#x7684;pause&#x6D41;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E0D;&#x662F;&#x4E3B;&#x7EBF;&#xFF0C;&#x5355;&#x72EC;&#x89E3;&#x91CA;&#x3010;&#x3011;&#x3002;&#x7136;&#x540E;&#x6267;&#x884C;postExecute&#x3002;&#x8FD9;&#x91CC;&#x4F1A;&#x89E6;&#x53D1;&#x65B0;Activity&#x7684;&#x542F;&#x52A8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityClient</span><br><span class="line"></span><br><span class="line">    public void activityPaused(IBinder token) {</span><br><span class="line">        try {</span><br><span class="line">            getActivityClientController().activityPaused(token);</span><br><span class="line">        } catch (RemoteException e) {</span><br><span class="line">            e.rethrowFromSystemServer();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>getActivityClientController&#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityClientController&#x5BF9;&#x8C61;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityClientController::activityPaused</span><br><span class="line">    ActivityRecord::activityPaused</span><br><span class="line">        TaskFragment::completePause</span><br><span class="line">            RootWindowContainer::resumeFocusedTasksTopActivities       --&#x5206;&#x652F;1 &#xFF0C;&#x518D;&#x6B21;&#x6267;&#x884C; resumeFocusedTasksTopActivities</span><br><span class="line">                RootWindowContainer::resumeFocusedTasksTopActivities</span><br><span class="line">                    Task::resumeTopActivityUncheckedLocked</span><br><span class="line">                        Task::resumeTopActivityInnerLocked</span><br><span class="line">                            TaskFragment::resumeTopActivity</span><br><span class="line">                                ActivityTaskSupervisor::startSpecificActivity                           --&#x89E6;&#x53D1; startSpecificActivity &#x5224;&#x65AD;&#x5E94;&#x7528;&#x662F;&#x5426;&#x521B;&#x5EFA;</span><br><span class="line">            RootWindowContainer::ensureActivitiesVisible              --&#x5206;&#x652F;2</span><br><span class="line">                RootWindowContainer::ensureActivitiesVisible</span><br><span class="line">                    DisplayContent::ensureActivitiesVisible </span><br><span class="line">                        WindowContainer::forAllRootTasks  --&#x5FFD;&#x7565;&#x56FA;&#x5B9A;&#x903B;&#x8F91;</span><br><span class="line">                            Task::ensureActivitiesVisible</span><br><span class="line">                                Task::forAllLeafTasks --&#x5FFD;&#x7565;&#x56FA;&#x5B9A;&#x903B;&#x8F91;</span><br><span class="line">                                    TaskFragment::updateActivityVisibilities</span><br><span class="line">                                        EnsureActivitiesVisibleHelper::process</span><br><span class="line">                                            EnsureActivitiesVisibleHelper::setActivityVisibilityState</span><br><span class="line">                                                EnsureActivitiesVisibleHelper::makeVisibleAndRestartIfNeeded</span><br><span class="line">                                                    ActivityTaskSupervisor::startSpecificActivity       --&#x89E6;&#x53D1; startSpecificActivity &#x5224;&#x65AD;&#x5E94;&#x7528;&#x662F;&#x5426;&#x521B;&#x5EFA;</span><br></pre></td></tr></table></figure>

<p>&#x8C03;&#x7528;&#x5806;&#x6808;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ccf094c52745ad76c8907082aa2d850c58704e25d10c465115859711ef64802e" alt="pause-startProcessAsync.png"></p>
<p>&#x4E0D;&#x662F;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x90FD;&#x8981;&#x53BB;&#x8DDF;&#xFF0C;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#xFF0C;&#x8DDF;&#x8E2A;&#x91CD;&#x70B9;&#x51FD;&#x6570;&#xFF0C;&#x5173;&#x6CE8;&#x91CD;&#x70B9;&#x5904;&#x7406;&#x7684;&#x5730;&#x65B9;&#x5373;&#x53EF;&#x3002; &#x5426;&#x5219;&#x4E0B;&#x4E2A;&#x7248;&#x672C;&#x91CD;&#x6784;&#x540E;&#xFF0C;&#x5C31;&#x5B8C;&#x5168;&#x4E0D;&#x4E00;&#x6837;&#x3002; &#x6240;&#x4EE5;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x91CD;&#x70B9;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x597D;&#x3002;<br>&#x8FD9;&#x8FB9;&#x53C8;2&#x4E2A;&#x5730;&#x65B9;&#x90FD;&#x4F1A;&#x51FA;&#x53D1;ActivityTaskSupervisor::startSpecificActivity&#xFF0C;&#x800C;&#x4E14;&#x90FD;&#x662F;&#x7531;ActivityClientController::activityPaused&#x4E3A;&#x6E90;&#x5934;&#x3002;<br>&#x7531;activityPaused&#x65B9;&#x6CD5;&#x540D;&#x4E5F;&#x80FD;&#x77E5;&#x9053;&#x8FD9;&#x6BB5;&#x903B;&#x8F91;&#x662F;&#x5728;launcher &#x6267;&#x884C;&#x5B8C;pause&#x540E;&#x518D;&#x6267;&#x884C;&#x7684;</p>
<p><strong>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x5206;&#x652F; RootWindowContainer::resumeFocusedTasksTopActivities&#x5230;TaskFragment::resumeTopActivity&#x76F4;&#x63A5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x548C;&#x4E0A;&#x4E00;&#x7BC7;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x6700;&#x540E;&#x6267;&#x884C;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#x800C;&#x5DF2;</strong></p>
<p><strong>pause&#x540E;&#xFF0C;&#x867D;&#x7136;&#x53C8;2&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x4F46;&#x662F;&#x6839;&#x636E;&#x51FD;&#x6570;&#x540D;&#xFF0C;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x80FD;&#x8BA9;&#x4E0B;&#x4E00;&#x4E2A;Activity&#x53EF;&#x89C1;&#x3002;&#x6BD5;&#x7ADF;&#x4E0D;&#x80FD;&#x8BA9;&#x7528;&#x6237;&#x4EC0;&#x4E48;&#x90FD;&#x770B;&#x4E0D;&#x89C1;&#xFF0C; &#x603B;&#x5F97;&#x663E;&#x793A;&#x4E00;&#x4E2A;&#x5427;</strong></p>
<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8FDB;&#x5165;&#x4EE3;&#x7801;&#x5206;&#x6790;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityRecord</span><br><span class="line">    void activityPaused(boolean timeout) {</span><br><span class="line">        ......</span><br><span class="line">            if (pausingActivity == this) {</span><br><span class="line">                // &#x6253;&#x5370;&#x65E5;&#x5FD7;</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES, &quot;Moving to PAUSED: %s %s&quot;, this,</span><br><span class="line">                        (timeout ? &quot;(due to timeout)&quot; : &quot; (pause complete)&quot;));</span><br><span class="line">                mAtmService.deferWindowLayout();</span><br><span class="line">                try {</span><br><span class="line">                    // &#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6CE8;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;null</span><br><span class="line">                    taskFragment.completePause(true /* resumeNext */, null /* resumingActivity */);</span><br><span class="line">                } finally {</span><br><span class="line">                    mAtmService.continueWindowLayout();</span><br><span class="line">                }</span><br><span class="line">                return;</span><br><span class="line">            }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">// &#x6253;&#x5370;&#x5982;&#x4E0B;</span><br><span class="line">WindowManager: Moving to PAUSED: ActivityRecord{1f58beb u0 com.android.launcher3/.uioverrides.QuickstepLauncher} t8}  (pause complete)</span><br><span class="line"></span><br><span class="line">//TaskFragment::completePause</span><br><span class="line"># TaskFragment</span><br><span class="line">    @VisibleForTesting</span><br><span class="line">    void completePause(boolean resumeNext, ActivityRecord resuming) {</span><br><span class="line">        // &#x62FF;&#x5230;&#x5148;&#x53BB;&#x7684;Activity&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x9700;&#x8981; pause&#x7684;</span><br><span class="line">        ActivityRecord prev = mPausingActivity;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Complete pause: %s&quot;, prev);</span><br><span class="line">        if (prev != null) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x8BBE;&#x7F6E;&#x7A97;&#x53E3;&#x72B6;&#x6001;&#x4E3A;PAUSED</span><br><span class="line">            prev.setState(PAUSED, &quot;completePausedLocked&quot;);</span><br><span class="line">            if (prev.finishing) {</span><br><span class="line">                ...... &#x5982;&#x679C;&#x5DF2;&#x7ECF;finish&#xFF0C;&#x4E0A;&#x9762;&#x8FD8;&#x5728;&#x8BBE;&#x7F6E; pause&#xFF0C;&#x90A3;&#x6B63;&#x5E38;&#x5E94;&#x8BE5;&#x662F;&#x8FD8;&#x6CA1;finish</span><br><span class="line">            } else if (prev.hasProcess()) {</span><br><span class="line">                // &#x6253;&#x5370;&#x72B6;&#x6001;&#x65E5;&#x5FD7;</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES, &quot;Enqueue pending stop if needed: %s &quot;</span><br><span class="line">                        + &quot;wasStopping=%b visibleRequested=%b&quot;,  prev,  wasStopping,prev.mVisibleRequested);</span><br><span class="line">            }else {</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            if (resumeNext) {</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;* 1. &#x7B2C;1&#x4E2A;&#x5206;&#x652F;</span><br><span class="line">                mRootWindowContainer.resumeFocusedTasksTopActivities(topRootTask, prev,null /* targetOptions */);</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            // &#x91CD;&#x70B9;* 2. </span><br><span class="line">            mRootWindowContainer.ensureActivitiesVisible(resuming, 0, !PRESERVE_WINDOWS);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x7ED3;&#x5408;&#x524D;&#x9762;TaskFragment::resumeTopActivity&#x7684;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5806;&#x6808;&#x77E5;&#x9053;&#x8FD9;2&#x4E2A;&#x5206;&#x652F;&#x4E5F;&#x4E5F;&#x521B;&#x5EFA;&#x65B0;&#x8FDB;&#x7A0B;&#xFF0C;&#x90A3;&#x5DF2;&#x77E5;3&#x5730;&#x65B9;&#x89E6;&#x53D1;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002;</p>
<p><strong>&#x8FD9;&#x91CC;&#x7684; topRootTask &#x5C31;&#x662F;SourceActivity&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;Activity,prev&#x662F;launcher&#x7684;&#xFF0C;resuming&#x4E3A;null&#x3002;</strong></p>
<h3 id="1-1-1-&#x5206;&#x652F;1-resumeFocusedTasksTopActivities"><a href="#1-1-1-&#x5206;&#x652F;1-resumeFocusedTasksTopActivities" class="headerlink" title="1.1.1 &#x5206;&#x652F;1 resumeFocusedTasksTopActivities"></a>1.1.1 &#x5206;&#x652F;1 resumeFocusedTasksTopActivities</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    final boolean resumeTopActivity(ActivityRecord prev, ActivityOptions options,</span><br><span class="line">            boolean deferPause) {</span><br><span class="line">                ......</span><br><span class="line">                // pause</span><br><span class="line">                boolean pausing = !deferPause &amp;&amp; taskDisplayArea.pauseBackTasks(next);</span><br><span class="line">                ......</span><br><span class="line">                if (pausing) {</span><br><span class="line">                        ...... </span><br><span class="line">                        // &#x542F;&#x52A8;&#x8FDB;&#x7A0B;</span><br><span class="line">                        mAtmService.startProcessAsync(next, false /* knownToBeDead */, isTop,</span><br><span class="line">                            isTop ? HostingRecord.HOSTING_TYPE_NEXT_TOP_ACTIVITY</span><br><span class="line">                                    : HostingRecord.HOSTING_TYPE_NEXT_ACTIVITY);</span><br><span class="line">                    ......</span><br><span class="line">                    //return&#xFF0C;</span><br><span class="line">                    return true;</span><br><span class="line">                }</span><br><span class="line">                // &#x672C;&#x6B21;&#x903B;&#x8F91;&#x8D70;&#x8FD9;</span><br><span class="line">                ......</span><br><span class="line">                // pause &#x903B;&#x8F91;&#x4F1A;&#x518D;&#x6B21;&#x8D70;&#x5230;&#x8FD9;&#xFF0C;&#x65B0;&#x8FDB;&#x7A0B;&#x76EE;&#x524D;&#x8FD8;&#x6CA1;&#x6709;&#x542F;&#x52A8;&#x6240;&#x4EE5;&#x8D70;else</span><br><span class="line">                if (next.attachedToProcess()) {</span><br><span class="line">                    ......</span><br><span class="line">                } else {</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x6253;&#x5370;log</span><br><span class="line">                    ProtoLog.d(WM_DEBUG_STATES, &quot;resumeTopActivity: Restarting %s&quot;, next);</span><br><span class="line">                    // &#x91CD;&#x70B9;* &#x6267;&#x884C;startSpecificActivity</span><br><span class="line">                    mTaskSupervisor.startSpecificActivity(next, true, true);</span><br><span class="line">                }</span><br><span class="line">            }</span><br></pre></td></tr></table></figure>

<p>&#x53C8;&#x662F;TaskFragment::resumeTopActivity&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6B21;&#x662F;&#x76F4;&#x63A5;&#x8D70;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6700;&#x4E0B;&#x9762;&#xFF0C;&#x542F;&#x52A8;Activity&#x3002;</p>
<h3 id="1-1-2-ensureActivitiesVisible&#x5206;&#x652F;"><a href="#1-1-2-ensureActivitiesVisible&#x5206;&#x652F;" class="headerlink" title="1.1.2 ensureActivitiesVisible&#x5206;&#x652F;"></a>1.1.2 ensureActivitiesVisible&#x5206;&#x652F;</h3><p>&#x770B;&#x65B9;&#x6CD5;&#x540D;&#x662F;&#x4E3A;&#x4E86; Activity&#x7684;&#x53EF;&#x89C1;<br>&#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x8C03;&#x7528;&#x94FE;&#xFF0C;&#x4F1A;&#x6267;&#x884C;&#x5230; DisplayContent::ensureActivitiesVisible</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# DisplayContent</span><br><span class="line">    void ensureActivitiesVisible(ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        if (mInEnsureActivitiesVisible) {</span><br><span class="line">            // Don&apos;t do recursive work.</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        mInEnsureActivitiesVisible = true;</span><br><span class="line">        mAtmService.mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            forAllRootTasks(rootTask -&gt; {</span><br><span class="line">                rootTask.ensureActivitiesVisible(starting, configChanges, preserveWindows,</span><br><span class="line">                        notifyClients);</span><br><span class="line">            });</span><br><span class="line">            if (mTransitionController.isCollecting()</span><br><span class="line">                    &amp;&amp; mWallpaperController.getWallpaperTarget() != null) {</span><br><span class="line">                // Also update wallpapers so that their requestedVisibility immediately reflects</span><br><span class="line">                // the changes to activity visibility.</span><br><span class="line">                // TODO(b/206005136): Move visibleRequested logic up to WindowToken.</span><br><span class="line">                mWallpaperController.adjustWallpaperWindows();</span><br><span class="line">            }</span><br><span class="line">        } finally {</span><br><span class="line">            mAtmService.mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">            mInEnsureActivitiesVisible = false;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x62FF;&#x51FA;&#x6765;&#x4E3B;&#x8981;&#x662F;&#x9047;&#x5230;&#x4E86;forAllRootTasks&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x548C;&#x4E4B;&#x524D;&#x7684;forAllLeafTasks&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;&#x5BF9;&#x6BCF;&#x4E2A;rootTask&#x6267;&#x884C;Lambda&#x800C;&#x5DF2;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# Task</span><br><span class="line">    void ensureActivitiesVisible(@Nullable ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            forAllLeafTasks(task -&gt; {</span><br><span class="line">                task.updateActivityVisibilities(starting, configChanges, preserveWindows,</span><br><span class="line">                        notifyClients);</span><br><span class="line">            }, true /* traverseTopToBottom */);</span><br><span class="line"></span><br><span class="line">            if (mTranslucentActivityWaiting != null &amp;&amp;</span><br><span class="line">                    mUndrawnActivitiesBelowTopTranslucent.isEmpty()) {</span><br><span class="line">                // Nothing is getting drawn or everything was already visible, don&apos;t wait for</span><br><span class="line">                // timeout.</span><br><span class="line">                notifyActivityDrawnLocked(null);</span><br><span class="line">            }</span><br><span class="line">        } finally {</span><br><span class="line">            mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x53C8;&#x6709;&#x4E2A;forAllLeafTasks&#xFF0C;&#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x53F6;&#x5B50;Task&#x7684;updateActivityVisibilities&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;Task&#x7684;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x6C14;&#x7236;&#x7C7B;TaskFragmet&#x91CC;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x770B;TaskFragmet&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragmet</span><br><span class="line">    private final EnsureActivitiesVisibleHelper mEnsureActivitiesVisibleHelper =</span><br><span class="line">            new EnsureActivitiesVisibleHelper(this);</span><br><span class="line">    final void updateActivityVisibilities(@Nullable ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            // &#x91CD;&#x70B9;</span><br><span class="line">            mEnsureActivitiesVisibleHelper.process(</span><br><span class="line">                    starting, configChanges, preserveWindows, notifyClients);</span><br><span class="line">        } finally {</span><br><span class="line">            mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x8FD9;&#x4E00;&#x6761;&#x7EBF;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x5904;&#x7406;Activity&#x53EF;&#x89C1;&#x7684;&#x3002; &#x5728;&#x8FD9;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4E13;&#x95E8;&#x7684;&#x7C7B;&#x6765;&#x5904;&#x7406;&#x3002;<br>&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x6267;&#x884C;&#x591A;&#x6B21;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x662F;&#x904D;&#x5386;&#x6BCF;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x5B50;&#x5BB9;&#x5668;&#xFF0C;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x904D;&#x5386;&#x3002;</p>
<h3 id="1-1-3-EnsureActivitiesVisibleHelper-process"><a href="#1-1-3-EnsureActivitiesVisibleHelper-process" class="headerlink" title="1.1.3 EnsureActivitiesVisibleHelper::process"></a>1.1.3 EnsureActivitiesVisibleHelper::process</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# EnsureActivitiesVisibleHelper</span><br><span class="line">    void process(@Nullable ActivityRecord starting, int configChanges, boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        // &#x8C03;&#x7528; reset &#x65B9;&#x6CD5;&#xFF0C;&#x5BF9;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x91CD;&#x7F6E;&#x5904;&#x7406;</span><br><span class="line">        reset(starting, configChanges, preserveWindows, notifyClients);</span><br><span class="line">        ......</span><br><span class="line">        for (int i = mTaskFragment.mChildren.size() - 1; i &gt;= 0; --i) {</span><br><span class="line">            // &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5B50;&#x5143;&#x7D20;</span><br><span class="line">            final WindowContainer child = mTaskFragment.mChildren.get(i);</span><br><span class="line">            // &#x5C06;&#x5F53;&#x524D;&#x5B50;&#x5143;&#x7D20;&#x8F6C;&#x6362;&#x4E3A;TaskFragment,&#x53EA;&#x6709;TaskFragment&#x91CD;&#x5199;&#x4E86;&#xFF0C;Task&#x6216;ActivityRecord&#x4E3A;null</span><br><span class="line">            // Task&#x7684;&#x5B69;&#x5B50;&#x4E00;&#x822C;&#x5C31;&#x662F;ActivityRecord&#x6216;&#x8005;Task</span><br><span class="line">            final TaskFragment childTaskFragment = child.asTaskFragment();</span><br><span class="line">            if (childTaskFragment != null</span><br><span class="line">                    &amp;&amp; childTaskFragment.getTopNonFinishingActivity() != null) {</span><br><span class="line">                ......</span><br><span class="line">            } else {</span><br><span class="line">                // &#x53EA;&#x6709;ActivityRecord&#x91CD;&#x5199;&#x4E86;</span><br><span class="line">                setActivityVisibilityState(child.asActivityRecord(), starting, resumeTopActivity);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void setActivityVisibilityState(ActivityRecord r, ActivityRecord starting,</span><br><span class="line">        final boolean resumeTopActivity) {</span><br><span class="line">        ......</span><br><span class="line">        if (reallyVisible) {</span><br><span class="line">            .......</span><br><span class="line">            if (!r.attachedToProcess()) {</span><br><span class="line">                // &#x4E3B;&#x6D41;&#x7A0B;</span><br><span class="line">                makeVisibleAndRestartIfNeeded(mStarting, mConfigChanges, isTop,</span><br><span class="line">                        resumeTopActivity &amp;&amp; isTop, r);</span><br><span class="line">            } else {</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">        } else {</span><br><span class="line">            if (DEBUG_VISIBILITY) {</span><br><span class="line">                Slog.v(TAG_VISIBILITY, &quot;Make invisible? &quot; + r</span><br><span class="line">                        + &quot; finishing=&quot; + r.finishing + &quot; state=&quot; + r.getState()</span><br><span class="line">                        + &quot; containerShouldBeVisible=&quot; + mContainerShouldBeVisible</span><br><span class="line">                        + &quot; behindFullyOccludedContainer=&quot; + mBehindFullyOccludedContainer</span><br><span class="line">                        + &quot; mLaunchTaskBehind=&quot; + r.mLaunchTaskBehind);</span><br><span class="line">            }</span><br><span class="line">            // &#x4E0D;&#x53EF;&#x89C1;&#x8C03;&#x7528;makeInvisible</span><br><span class="line">            r.makeInvisible();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;r &#x8868;&#x793A;&#x9700;&#x8981;&#x542F;&#x52A8;&#x7684;ActivityRecord&#xFF0C;&#x5F53;&#x524D;&#x6D41;&#x7A0B;&#x8FD8;&#x662F;onPause&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5E76;&#x6CA1;&#x6709;&#x77E5;&#x9053;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x90A3;&#x4E00;&#x6B65;&#xFF0C;&#x6240;&#x4EE5;&#x8FDB;&#x7A0B;&#x662F;&#x6CA1;&#x6709;attached&#x7684;&#x3002;&#x90A3;&#x5C31;&#x4F1A;&#x6267;&#x884C;makeVisibleAndRestartIfNeeded</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;# EnsureActivitiesVisibleHelper</span><br><span class="line">    private void makeVisibleAndRestartIfNeeded(ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean isTop, boolean andResume, ActivityRecord r) {</span><br><span class="line">        ......</span><br><span class="line">        if (!r.mVisibleRequested || r.mLaunchTaskBehind) {</span><br><span class="line">            if (DEBUG_VISIBILITY) {</span><br><span class="line">                Slog.v(TAG_VISIBILITY, &quot;Starting and making visible: &quot; + r);</span><br><span class="line">            }</span><br><span class="line">            // &#x8BBE;&#x7F6E;Visibility</span><br><span class="line">            r.setVisibility(true);</span><br><span class="line">        }</span><br><span class="line">        if (r != starting) {</span><br><span class="line">            mTaskFragment.mTaskSupervisor.startSpecificActivity(r, andResume,</span><br><span class="line">                    true /* checkConfig */);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-ActivityTaskSupervisor-startSpecificActivity"><a href="#1-1-4-ActivityTaskSupervisor-startSpecificActivity" class="headerlink" title="1.1.4 ActivityTaskSupervisor::startSpecificActivity"></a>1.1.4 ActivityTaskSupervisor::startSpecificActivity</h3><p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E5F;&#x88AB;&#x8C03;&#x7528;&#x4E86;2&#x6B21;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskSupervisor</span><br><span class="line"></span><br><span class="line">    void startSpecificActivity(ActivityRecord r, boolean andResume, boolean checkConfig) {</span><br><span class="line">        // Is this activity&apos;s application already running?</span><br><span class="line">        // &#x62FF;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;</span><br><span class="line">        final WindowProcessController wpc =</span><br><span class="line">                mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        boolean knownToBeDead = false;</span><br><span class="line">        //  &#x8FDB;&#x7A0B;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x4E14;&#x4E3B;&#x7EBF;&#x7A0B;&#x5DF2;&#x6267;&#x884C;</span><br><span class="line">        if (wpc != null &amp;&amp; wpc.hasThread()) {</span><br><span class="line">            try {</span><br><span class="line">                // &#x8FDB;&#x7A0B;&#x8FDB;&#x7A0B; &#x5219;&#x6267;&#x884C; realStartActivityLocked &#x6D41;&#x7A0B;</span><br><span class="line">                realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">                return;</span><br><span class="line">            } catch (RemoteException e) {</span><br><span class="line">                Slog.w(TAG, &quot;Exception when starting activity &quot;</span><br><span class="line">                        + r.intent.getComponent().flattenToShortString(), e);1111111111</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">        // &#x5F02;&#x6B65;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;</span><br><span class="line">        mService.startProcessAsync(r, knownToBeDead, isTop,</span><br><span class="line">                isTop ? HostingRecord.HOSTING_TYPE_TOP_ACTIVITY</span><br><span class="line">                        : HostingRecord.HOSTING_TYPE_ACTIVITY);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x6709;2&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x5982;&#x679C;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4E86;&#xFF0C;&#x5219;&#x8D70;realStartActivityLocked&#xFF0C;&#x5426;&#x5219;&#x6267;&#x884C;&#x521B;&#x5EFA;&#x7684;&#x903B;&#x8F91;&#x3002;&#x4E0D;&#x8FC7;&#x5C31;&#x76EE;&#x524D;2&#x4E2A;&#x8C03;&#x7528;&#x7684;&#x5730;&#x65B9;&#x90FD;&#x662F;&#x6267;&#x884C;onPause&#x7684;&#x903B;&#x8F91;&#x6027;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x5236;&#x4F5C;&#x5230;startProcessAsync&#x3002; &#x800C;&#x4E0D;&#x4F1A;&#x8D70;&#x8FDB;realStartActivityLocked</p>
<h1 id="2-&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;"><a href="#2-&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;" class="headerlink" title="2 &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;"></a>2 &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;</h1><p>&#x8FD9;&#x91CC;&#x662F;&#x56DE;&#x5230;&#x6267;&#x884C;pause&#x7684;&#x540C;&#x7EA7;&#x6D41;&#x7A0B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6700;&#x524D;&#x9762;&#x7684;TaskFragment::resumeTopActivity<br>&#x6267;&#x884C;pause&#x540E;&#x4F1A;&#x6267;&#x884C; ActivityTaskManagerService::startProcessAsync,&#x6700;&#x540E;&#x4E5F;&#x662F;&#x901A;&#x8FC7; ActivityManagerService&#x6765;&#x89E6;&#x53D1;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684;&#x3002;<br>&#x770B;&#x770B;AMS&#x8FD9;&#x5757;&#x6267;&#x884C;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x7684;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ATMS  </span><br><span class="line">    void startProcessAsync(ActivityRecord activity, boolean knownToBeDead, boolean isTop,</span><br><span class="line">            String hostingType) {</span><br><span class="line">        try {</span><br><span class="line">            if (Trace.isTagEnabled(TRACE_TAG_WINDOW_MANAGER)) {</span><br><span class="line">                Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, &quot;dispatchingStartProcess:&quot;</span><br><span class="line">                        + activity.processName);</span><br><span class="line">            }</span><br><span class="line">            // &#x53D1;&#x751F;&#x6D88;&#x606F;&#xFF0C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#xFF0C;&#x8C03;&#x7528;ActivityManagerInternal::startProcess</span><br><span class="line">            final Message m = PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,</span><br><span class="line">                    mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,</span><br><span class="line">                    isTop, hostingType, activity.intent.getComponent());</span><br><span class="line">            mH.sendMessage(m);</span><br><span class="line">        } finally {</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">// ActivityManagerInternal::startProcess &#x7684;&#x5B9E;&#x73B0;&#x5728;AMS&#x7684;&#x5185;&#x90E8;&#x7C7B; LocalService &#x4E2D;</span><br><span class="line"># AMS.LocalService </span><br><span class="line">        public void startProcess(String processName, ApplicationInfo info, boolean knownToBeDead,</span><br><span class="line">                boolean isTop, String hostingType, ComponentName hostingName) {</span><br><span class="line">            try {</span><br><span class="line">                if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) {</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;startProcess:&quot;</span><br><span class="line">                            + processName);</span><br><span class="line">                }</span><br><span class="line">                synchronized (ActivityManagerService.this) {</span><br><span class="line">                    // &#x91CD;&#x70B9;&#x8C03;&#x7528;</span><br><span class="line">                    startProcessLocked(processName, info, knownToBeDead, 0 /* intentFlags */,</span><br><span class="line">                            new HostingRecord(hostingType, hostingName, isTop),</span><br><span class="line">                            ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, false /* allowWhileBooting */,</span><br><span class="line">                            false /* isolated */);</span><br><span class="line">                }</span><br><span class="line">            } finally {</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        @GuardedBy(&quot;this&quot;)</span><br><span class="line">        final ProcessRecord startProcessLocked(String processName,</span><br><span class="line">                ApplicationInfo info, boolean knownToBeDead, int intentFlags,</span><br><span class="line">                HostingRecord hostingRecord, int zygotePolicyFlags, boolean allowWhileBooting,</span><br><span class="line">                boolean isolated) {</span><br><span class="line">            return mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,</span><br><span class="line">                    hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, 0 /* isolatedUid */,</span><br><span class="line">                    false /* isSdkSandbox */, 0 /* sdkSandboxClientAppUid */,</span><br><span class="line">                    null /* sdkSandboxClientAppPackage */,</span><br><span class="line">                    null /* ABI override */, null /* entryPoint */,</span><br><span class="line">                    null /* entryPointArgs */, null /* crashHandler */);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"># ProcessList</span><br><span class="line">    boolean startProcessLocked(......) {</span><br><span class="line">                ......</span><br><span class="line">                mService.mProcStartHandler.post(() -&gt; handleProcessStart(</span><br><span class="line">                    app, entryPoint, gids, runtimeFlags, zygotePolicyFlags, mountExternal,</span><br><span class="line">                    requiredAbi, instructionSet, invokeWith, startSeq));     </span><br><span class="line">                ......   </span><br><span class="line">        }</span><br><span class="line">        private void handleProcessStart(......) {</span><br><span class="line">            &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">            final Runnable startRunnable = () -&gt; {</span><br><span class="line">                try {    // &#x8C03;&#x7528; startProcess &#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x83B7;&#x53D6;&#x542F;&#x52A8;&#x7ED3;&#x679C; ProcessStartResult</span><br><span class="line">                        final Process.ProcessStartResult startResult = startProcess(app.getHostingRecord(),</span><br><span class="line">                            entryPoint, app, app.getStartUid(), gids, runtimeFlags, zygotePolicyFlags,</span><br><span class="line">                            mountExternal, app.getSeInfo(), requiredAbi, instructionSet, invokeWith,</span><br><span class="line">                            app.getStartTime());</span><br><span class="line">                         // &#x5728;&#x9501;&#x5B9A; ActivityManagerService &#x540E;&#xFF0C;&#x5904;&#x7406;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x7ED3;&#x679C;</span><br><span class="line">                        synchronized (mService) {</span><br><span class="line">                            handleProcessStartedLocked(app, startResult, startSeq);</span><br><span class="line">                        }</span><br><span class="line">                } catch (RuntimeException e) {</span><br><span class="line">                    ......&#x5F02;&#x5E38;&#x5904;&#x7406;</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            // // &#x5982;&#x679C;&#x6709;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x5E76;&#x4E14;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6B63;&#x5728;&#x6B7B;&#x4EA1;&#x4E2D;</span><br><span class="line">            final ProcessRecord predecessor = app.mPredecessor;</span><br><span class="line">            if (predecessor != null &amp;&amp; predecessor.getDyingPid() &gt; 0) {</span><br><span class="line">                 // &#x901A;&#x8FC7;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">                handleProcessStartWithPredecessor(predecessor, startRunnable);</span><br><span class="line">            } else {</span><br><span class="line">                // &#x5982;&#x679C;&#x6CA1;&#x6709;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6216;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x672A;&#x6B7B;&#x4EA1;&#xFF0C;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">                // &#x8D70;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;</span><br><span class="line">                startRunnable.run();</span><br><span class="line">            }</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p><strong>&#x901A;&#x8FC7; startProcess &#x6765;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;</strong></p>
<p>&#x6267;&#x884C;&#x5B8C;&#x540E;&#x8F93;&#x51FA;&#x65E5;&#x5FD7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;07-26 19:19:05.477  8737  8782 I ActivityManager: Start proc 19643:com.example.myapplication/u0a198 for next-top-activity {com.example.myapplication/com.example.myapplication.MainActivity}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6BB5;&#x65E5;&#x5FD7;&#x662F;&#x5728; ProcessList::handleProcessStart &#x65B9;&#x6CD5;&#x91CC;&#x6784;&#x5EFA;&#x4E86;&#x4E2A;StringBuilder&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x9012;&#x7ED9;AMS::reportUidInfoMessageLocked&#x8FDB;&#x884C;&#x6253;&#x5370;&#x7684;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/015b67c90cb13536e975c4e1ea04bee9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340301649766727721.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340301649766727721.html" itemprop="url">【Android 13源码分析】Activity启动流程-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T13:43:16+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#x3002;</p>
<h1 id="&#x6A21;&#x5757;&#x6846;&#x56FE;"><a href="#&#x6A21;&#x5757;&#x6846;&#x56FE;" class="headerlink" title="&#x6A21;&#x5757;&#x6846;&#x56FE;"></a>&#x6A21;&#x5757;&#x6846;&#x56FE;</h1><h2 id="&#x4E00;&#x7EA7;&#x6846;&#x56FE;"><a href="#&#x4E00;&#x7EA7;&#x6846;&#x56FE;" class="headerlink" title="&#x4E00;&#x7EA7;&#x6846;&#x56FE;"></a>&#x4E00;&#x7EA7;&#x6846;&#x56FE;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/abc07d9563225229aa1aaf5912a804f7e547e15da07d758b43117b2912c449a2" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--&#x4E00;&#x7EA7;&#x6846;&#x56FE;.png"></p>
<p>&#x5BF9;&#x4E8E;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x4E2A;&#x6A21;&#x5757;&#xFF1A;</p>
<p><strong>SourceActivity</strong>&#xFF1A;&#x6267;&#x884C;startActivity&#x65B9;&#x6CD5;&#x7684;Activity&#xFF0C;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x7684;Activity&#xFF0C;&#x5F53;&#x524D;&#x5C31;&#x662F;Launch&#x7684;Activity</p>
<p><strong>TargetActivity</strong>&#xFF1A;&#x9700;&#x8981;&#x88AB;&#x542F;&#x52A8;&#x7684;Activity&#xFF0C;&#x5F53;&#x524D;&#x5C31;&#x662F;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;&#x5728;&#x6E05;&#x5355;&#x6587;&#x4EF6;&#x914D;&#x7F6E;&#x7684;MainActivity</p>
<p><strong>AMS</strong>: &#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x6307;AMS&#x8FD9;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x800C;&#x662F;&#x6307;&#x5904;&#x7406;&#x6574;&#x4E2A;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x7684;&#x7BA1;&#x7406;&#x7C7B;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C; &#x4EE5;&#x5728;&#x516C;&#x53F8;&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C; launch&#x6A21;&#x5757;&#x7684;&#x5F00;&#x53D1;&#xFF0C;&#x5728;&#x5904;&#x7406;&#x4E00;&#x4E2A;bug&#xFF0C;&#x4F46;&#x662F;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x901A;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x80AF;&#x5B9A;&#x662F;&#x9700;&#x8981;&#x627E;&#x5230;&#x901A;&#x8BAF;&#x7EC4;&#x7684;&#x540C;&#x4E8B;&#x6765;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002; &#x4F46;&#x662F;&#x516C;&#x53F8;&#x5F88;&#x5927;&#xFF0C;&#x4ED6;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x901A;&#x8BAF;&#x6A21;&#x5757;&#x662F;&#x8C01;&#x8D1F;&#x8D23;&#xFF0C;&#x66F4;&#x4E0D;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x9700;&#x8981;&#x4EA4;&#x7ED9;&#x901A;&#x8BAF;&#x7EC4;&#x5177;&#x4F53;&#x7684;&#x54EA;&#x4E2A;&#x540C;&#x4E8B;&#x5904;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x8981;&#x6C42;&#x5411;&#x516C;&#x53F8;&#x9886;&#x5BFC;&#xFF08;&#x7BA1;&#x7406;&#xFF09;&#x6C47;&#x62A5;&#xFF1A;&#x9700;&#x8981;&#x901A;&#x8BAF;&#x7EC4;&#x7684;&#x540C;&#x4E8B;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x524D;&#x4F8B;&#x5B50;&#x8BBE;&#x8BA1;&#x5230;launcher&#x548C;&#x901A;&#x8BAF;2&#x4E2A;&#x6A21;&#x5757;&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#xFF0C;&#x8FD8;&#x6D89;&#x53CA;&#x5230;&#x516C;&#x53F8;&#x7684;&#x7BA1;&#x7406;&#x8005;&#x3002;&#x5728;Activity&#x542F;&#x52A8;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#xFF0C; &#x5BF9;&#x4E8E;sourceActivity&#x3001;targetActivity&#x4ED6;&#x4EEC;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x76F4;&#x63A5;&#x4F5C;&#x7528;&#x5BF9;&#x65B9;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E00;&#x6D41;&#x7A0B;&#x9700;&#x8981;AMS&#x6765;&#x505A;&#x7BA1;&#x7406;&#x3002;</p>
<p>&#x5E76;&#x4E14;&#xFF0C;&#x8FD9;3&#x4E2A;&#x6A21;&#x5757;&#x4E5F;&#x5BF9;&#x5E94;3&#x4E2A;&#x8FDB;&#x7A0B;&#xFF0C;&#x5F53;&#x524D;&#x6848;&#x4F8B;&#x6765;&#x8BF4;&#x5206;&#x522B;&#x4E3A;&#xFF1A;launch&#x8FDB;&#x7A0B;&#xFF0C;&#x7535;&#x8BDD;&#x8FDB;&#x7A0B;&#xFF0C;system_service&#x8FDB;&#x7A0B;&#x3002;</p>
<p>&#x8FD9;&#x91CC;AMS&#x5BF9;launch&#x591A;&#x4E86;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x7BAD;&#x5934;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;launch&#x80AF;&#x5B9A;&#x662F;&#x9700;&#x8981;&#x6267;&#x884C;pause&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x6267;&#x884C;pause&#x7684;&#x65F6;&#x673A;launch&#x81EA;&#x8EAB;&#x65E0;&#x6CD5;&#x63A7;&#x5236;&#xFF0C;&#x53EA;&#x80FD;&#x7531;AMS&#x63A7;&#x5236;&#x3002;</p>
<h2 id="&#x4E8C;&#x7EA7;&#x6846;&#x56FE;"><a href="#&#x4E8C;&#x7EA7;&#x6846;&#x56FE;" class="headerlink" title="&#x4E8C;&#x7EA7;&#x6846;&#x56FE;"></a>&#x4E8C;&#x7EA7;&#x6846;&#x56FE;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c81e40e941e6423dd2572a56842ea1f59f4f50be11db051518a20903d1f7e3ed" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--&#x4E8C;&#x7EA7;&#x6846;&#x56FE;.png"></p>
<p>&#x8FD9;&#x91CC;&#x6709;3&#x4E2A;&#x989C;&#x8272;&#xFF0C;&#x4EE3;&#x8868;3&#x4E2A;&#x9636;&#x6BB5;&#x3002;</p>
<p>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>&#x7531;launcher &#x8FDB;&#x7A0B;&#x53D1;&#x8D77;&#x542F;&#x52A8;Activity&#x7684;&#x8BF7;&#x6C42;</li>
<li>AMS&#x5904;&#x7406;&#xFF0C;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;ActivityRecord&#x548C;Task&#xFF0C;&#x5E76;&#x6302;&#x8F7D;&#x5230;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;&#x4E2D;</li>
</ol>
<p>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>AMS &#x89E6;&#x53D1;launcher &#x7684;pause&#x6D41;&#x7A0B;</li>
<li>AMS &#x89E6;&#x53D1;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7684;&#x521B;&#x5EFA;</li>
<li>launcher&#x6267;&#x884C;pause&#x6D41;&#x7A0B;</li>
<li>launcher&#x6267;&#x884C;&#x5B8C;pause&#x540E;&#x6267;&#x884C;&#x8C03;&#x7528;AMS&#x7684;startSpecificActivity&#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;Activity</li>
</ol>
<p>ASM &#x901A;&#x77E5; launcher &#x6267;&#x884C;pause&#x548C;&#x901A;&#x8FC7; Zygote &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x90FD;&#x662F;&#x5F02;&#x6B65;&#x7684;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x6267;&#x884C;&#x7684;&#x987A;&#x5E8F;&#x3002;&#x6240;&#x4EE5;launcher&#x6267;&#x884C;completePause&#x540E;&#x8C03;&#x7528;&#x542F;&#x52A8;Activity&#x65F6;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;&#x8FDB;&#x7A0B;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x3002;</p>
<p>&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#xFF0C;&#x901A;&#x77E5;AMS</li>
<li>AMS&#x89E6;&#x53D1;realStartActivityLocked&#xFF0C;&#x901A;&#x77E5;&#x5E94;&#x7528;&#x542F;&#x52A8;Activity</li>
<li>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x6267;&#x884C;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x751F;&#x547D;&#x5468;&#x671F; &#x8D70;&#x5230;onCreate&#x548C;onResume</li>
</ol>
<p>&#x8FD9;&#x91CC;&#x7B2C;&#x4E8C;&#x6B65;&#xFF0C;&#x91CC;&#x9762;&#x4F1A;&#x5224;&#x65AD;launcher&#x662F;&#x5426;&#x6267;&#x884C;&#x5B8C;pause&#x4E86;&#xFF0C; &#x5982;&#x679C;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x5219;&#x76F4;&#x63A5;return&#x3002;</p>
<p><strong>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x9700;&#x8981;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;Activity&#xFF0C;&#x5FC5;&#x987B;&#x6709;2&#x4E2A;&#x6761;&#x4EF6;&#xFF1A;1. &#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5; 2. launcher&#x6267;&#x884C;&#x5B8C;pause</strong></p>
<p>&#x5728;&#x65B0;&#x7684;Activity&#x663E;&#x793A;&#x524D;&#xFF0C; launch&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x6267;&#x884C;pause&#x7684;&#x3002;</p>
<ol>
<li><h1 id="launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;"><a href="#launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;" class="headerlink" title="launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;"></a>launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;</h1></li>
</ol>
<p>&#x8FD9;&#x4E00;&#x9636;&#x6BB5;&#x8C03;&#x7528;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5806;&#x6808;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/94ddd7d2c822362cd19f4ea901218afc7ac5dbf646482cfccad95e9e703cbba9" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--launch&#x8FDB;&#x7A0B;.png"></p>
<p>&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x6B63;&#x5E38;&#x901A;&#x8FC7; startActivity &#x4F20;&#x9012; intent &#x542F;&#x52A8;Activity&#x7684;&#x6D41;&#x7A0B;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002; &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x5230;Instrumentation::execStartActivity&#x3002;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x8DE8;&#x8FDB;&#x7A0B;&#x4E0E;AMS&#x901A;&#x4FE1;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<p>Activity::startActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;    Activity::startActivity</span><br><span class="line">        Activity::startActivityForResult</span><br><span class="line">            Instrumentation::execStartActivity</span><br><span class="line">                ActivityTaskManagerService::startActivity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x5728;&#x53D1;&#x8D77;&#x542F;&#x52A8;Activity&#x7684;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x7AEF;&#xFF0C;&#x903B;&#x8F91;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#xFF0C;&#x65E0;&#x8BBA;&#x54EA;&#x79CD;&#x53C2;&#x6570;&#x7684; startActivity &#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x90FD;&#x662F;&#x8C03;&#x5230; startActivityForResult &#x65B9;&#x6CD5;&#x3002;<br>&#x7136;&#x540E;&#x5728; Instrumentation &#x6700;&#x540E;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x8DE8;&#x8FDB;&#x7A0B;&#x4F20;&#x9012;&#x5230; system_service &#x8FDB;&#x7A0B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# Activity</span><br><span class="line">    public void startActivityForResult(@RequiresPermission Intent intent, int requestCode,</span><br><span class="line">            @Nullable Bundle options) {</span><br><span class="line">        if (mParent == null) {</span><br><span class="line">            options = transferSpringboardActivityOptions(options);</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    this, mMainThread.getApplicationThread(), mToken, this,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"># Instrumentation</span><br><span class="line">    public ActivityResult execStartActivity(</span><br><span class="line">            Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">            Intent intent, int requestCode, Bundle options) {</span><br><span class="line">        ......</span><br><span class="line">            // &#x5F53;&#x524D;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x5904;&#x7406;&#x7ED3;&#x675F;&#xFF0C;&#x5F00;&#x59CB;&#x4F20;&#x9012;&#x7ED9;ActivityTaskManagerService</span><br><span class="line">            int result = ActivityTaskManager.getService().startActivity(whoThread,</span><br><span class="line">                who.getOpPackageName(), who.getAttributionTag(), intent,</span><br><span class="line">                intent.resolveTypeIfNeeded(who.getContentResolver()), token,</span><br><span class="line">                target != null ? target.mEmbeddedID : null, requestCode, 0, null, options);</span><br><span class="line">            // &#x5BF9;&#x8DE8;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x7684;&#x7ED3;&#x679C;&#x505A;check</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>checkStartActivityResult &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x5982;&#x5E38;&#x89C1;&#x7684;&#x672A;&#x5728;AndroidManifest.xml&#x6CE8;&#x518C;Activity&#x7684;&#x62A5;&#x9519;&#x5C31;&#x5728;&#x8FD9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# Instrumentation</span><br><span class="line">    public static void checkStartActivityResult(int res, Object intent) {</span><br><span class="line">        if (!ActivityManager.isStartResultFatalError(res)) {</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        switch (res) {</span><br><span class="line">            case ActivityManager.START_INTENT_NOT_RESOLVED:</span><br><span class="line">            case ActivityManager.START_CLASS_NOT_FOUND:  // &#x672A;&#x5728;AndroidManifest.xml&#x6CE8;&#x518C;</span><br><span class="line">                if (intent instanceof Intent &amp;&amp; ((Intent)intent).getComponent() != null)</span><br><span class="line">                    throw new ActivityNotFoundException(</span><br><span class="line">                            &quot;Unable to find explicit activity class &quot;</span><br><span class="line">                            + ((Intent)intent).getComponent().toShortString()</span><br><span class="line">                            + &quot;; have you declared this activity in your AndroidManifest.xml&quot;</span><br><span class="line">                            + &quot;, or does your intent not match its declared &lt;intent-filter&gt;?&quot;);</span><br><span class="line">                throw new ActivityNotFoundException(</span><br><span class="line">                        &quot;No Activity found to handle &quot; + intent);</span><br><span class="line">            case ActivityManager.START_PERMISSION_DENIED:</span><br><span class="line">                throw new SecurityException(&quot;Not allowed to start activity &quot;</span><br><span class="line">                        + intent);</span><br><span class="line">            case ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT:</span><br><span class="line">                throw new AndroidRuntimeException(</span><br><span class="line">                        &quot;FORWARD_RESULT_FLAG used while also requesting a result&quot;);</span><br><span class="line">            case ActivityManager.START_NOT_ACTIVITY:</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;PendingIntent is not an activity&quot;);</span><br><span class="line">            case ActivityManager.START_NOT_VOICE_COMPATIBLE:</span><br><span class="line">                throw new SecurityException(</span><br><span class="line">                        &quot;Starting under voice control not allowed for: &quot; + intent);</span><br><span class="line">            case ActivityManager.START_VOICE_NOT_ACTIVE_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Session calling startVoiceActivity does not match active session&quot;);</span><br><span class="line">            case ActivityManager.START_VOICE_HIDDEN_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Cannot start voice activity on a hidden session&quot;);</span><br><span class="line">            case ActivityManager.START_ASSISTANT_NOT_ACTIVE_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Session calling startAssistantActivity does not match active session&quot;);</span><br><span class="line">            case ActivityManager.START_ASSISTANT_HIDDEN_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Cannot start assistant activity on a hidden session&quot;);</span><br><span class="line">            case ActivityManager.START_CANCELED:</span><br><span class="line">                throw new AndroidRuntimeException(&quot;Activity could not be started for &quot;</span><br><span class="line">                        + intent);</span><br><span class="line">            default:</span><br><span class="line">                throw new AndroidRuntimeException(&quot;Unknown error code &quot;</span><br><span class="line">                        + res + &quot; when starting &quot; + intent);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><h1 id="system-service-&#x5904;&#x7406;"><a href="#system-service-&#x5904;&#x7406;" class="headerlink" title="system_service &#x5904;&#x7406;"></a>system_service &#x5904;&#x7406;</h1></li>
</ol>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityTaskManagerService::startActivity</span><br><span class="line">    ActivityTaskManagerService::startActivityAsUser</span><br><span class="line">        ActivityTaskManagerService::startActivityAsUser</span><br><span class="line">            ActivityStartController::obtainStarter</span><br><span class="line">                ActivityStarter::execute</span><br><span class="line">                    ActivityStarter::executeRequest -- &#x6784;&#x5EFA; ActivityRecord --2..1 &#x521B;&#x5EFA;ActivityRecord</span><br><span class="line">                        ActivityStarter::startActivityUnchecked</span><br><span class="line">                            ActivityStarter::startActivityInner        -- 2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner</span><br><span class="line">                                ActivityStarter::getOrCreateRootTask   -- 2.2.1 &#x521B;&#x5EFA;&#x6216;&#x8005;&#x62FF;&#x5230;Task</span><br><span class="line">                                ActivityStarter::setNewTask            -- 2.2.2 &#x5C06;task&#x4E0E;activityRecord &#x7ED1;&#x5B9A;</span><br><span class="line">                                RootWindowContainer::resumeFocusedTasksTopActivities    --2.2.3 &#x663E;&#x793A;Activity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x6D41;&#x7A0B;&#x6765;&#x5230;ActivityTaskManagerService::startActivity&#xFF0C;&#x7ECF;&#x8FC7;2&#x6B21;&#x7B80;&#x5355;&#x7684;&#x8DF3;&#x8F6C;&#x4F1A;&#x6267;&#x884C; startActivityAsUser &#x65B9;&#x6CD5;&#x3002;<br>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4F1A;&#x6784;&#x5EFA;&#x4E00;&#x4E2A; ActivityStartController &#xFF0C;&#x6839;&#x636E;&#x7C7B;&#x540D;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x7C7B;&#x662F;&#x63A7;&#x5236;Activity&#x542F;&#x52A8;&#x3002;</p>
<p>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;    private int startActivityAsUser(IApplicationThread caller, String callingPackage,</span><br><span class="line">            @Nullable String callingFeatureId, Intent intent, String resolvedType,</span><br><span class="line">            IBinder resultTo, String resultWho, int requestCode, int startFlags,</span><br><span class="line">            ProfilerInfo profilerInfo, Bundle bOptions, int userId, boolean validateIncomingUser) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityStartController</span><br><span class="line">            return getActivityStartController().obtainStarter(intent, &quot;startActivityAsUser&quot;)</span><br><span class="line">                .setCaller(caller)</span><br><span class="line">                .setCallingPackage(callingPackage)</span><br><span class="line">                .setCallingFeatureId(callingFeatureId)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setResultTo(resultTo)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setStartFlags(startFlags)</span><br><span class="line">                .setProfilerInfo(profilerInfo)</span><br><span class="line">                .setActivityOptions(bOptions)</span><br><span class="line">                .setUserId(userId)</span><br><span class="line">                .execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ActivityStartController getActivityStartController() {</span><br><span class="line">        return mActivityStartController;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>ActivityStartController::obtainStarter&#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityStarter&#x5BF9;&#x8C61;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStartController</span><br><span class="line">    ActivityStarter obtainStarter(Intent intent, String reason) {</span><br><span class="line">        return mFactory.obtain().setIntent(intent).setReason(reason);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#x5728;ActivityTaskManagerService::startActivityAsUser&#x65B9;&#x6CD5;&#x4E2D;&#x7684;build&#x6A21;&#x5F0F;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x5BF9; ActivityStarter &#x5BF9;&#x8C61;&#x505A;&#x6784;&#x5EFA;&#x3002;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5176; execute &#x65B9;&#x6CD5;&#x3002;<br>&#x7136;&#x540E;&#x8C03;&#x7528; executeRequest &#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line"></span><br><span class="line">    int execute() {</span><br><span class="line">        ......</span><br><span class="line">        res = executeRequest(mRequest);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h2 id="2-1&#x521B;&#x5EFA;ActivityRecord"><a href="#2-1&#x521B;&#x5EFA;ActivityRecord" class="headerlink" title="2.1&#x521B;&#x5EFA;ActivityRecord"></a>2.1&#x521B;&#x5EFA;ActivityRecord</h2><p>ActivityStarter::executeRequest&#x662F;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x5185;&#x90E8;&#x4F1A;&#x521B;&#x5EFA; ActivityRecord &#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A; ActivityRecord &#x5BF9;&#x8C61;&#x6301;&#x6709; token &#xFF0C;&#x8FD9;&#x4E2A;token&#x5C31;&#x662F;&#x4EE5;&#x540E;&#x5206;&#x6790;&#x5176;&#x4ED6;&#x903B;&#x8F91;&#x4E00;&#x76F4;&#x4F1A;&#x51FA;&#x73B0;&#x7684;token&#x3002;</p>
<p>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x4E2D;&#x7684;Activity&#x5728;AMS&#x7684;&#x4EE3;&#x8868;&#x5C31;&#x662F;ActivityRecord</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">  private int executeRequest(Request request) {</span><br><span class="line">        ......</span><br><span class="line">        final ActivityRecord r = new ActivityRecord.Builder(mService)</span><br><span class="line">                .setCaller(callerApp)</span><br><span class="line">                .setLaunchedFromPid(callingPid)</span><br><span class="line">                .setLaunchedFromUid(callingUid)</span><br><span class="line">                .setLaunchedFromPackage(callingPackage)</span><br><span class="line">                .setLaunchedFromFeature(callingFeatureId)</span><br><span class="line">                .setIntent(intent)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setActivityInfo(aInfo)</span><br><span class="line">                .setConfiguration(mService.getGlobalConfiguration())</span><br><span class="line">                .setResultTo(resultRecord)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setComponentSpecified(request.componentSpecified)</span><br><span class="line">                .setRootVoiceInteraction(voiceSession != null)</span><br><span class="line">                .setActivityOptions(checkedOptions)</span><br><span class="line">                .setSourceRecord(sourceRecord)</span><br><span class="line">                .build();</span><br><span class="line">        ......</span><br><span class="line">        // &#x7EE7;&#x7EED;&#x6267;&#x884C;startActivityUnchecked</span><br><span class="line">        mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class="line">                request.voiceInteractor, startFlags, true /* doResume */, checkedOptions,</span><br><span class="line">                inTask, inTaskFragment, restrictedBgActivity, intentGrants);</span><br><span class="line">        ......</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x800C; startActivityUnchecked &#x4E3B;&#x8981;&#x8C03;&#x7528;&#x7684;&#x662F; startActivityInner , &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x6D41;&#x7A0B;&#x7684;&#x5173;&#x952E;&#x70B9;&#x3002;</p>
<h2 id="2-2-&#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner"><a href="#2-2-&#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner" class="headerlink" title="2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner"></a>2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner</h2><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;AMS&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x6700;&#x91CD;&#x8981;&#x7684;&#x51FD;&#x6570;&#x4E4B;&#x4E00;&#xFF0C;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x5230;&#x3010;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x3011;&#x76F8;&#x5173;&#xFF0C;&#x5148;&#x770B;&#x770B;&#x6B63;&#x5E38;&#x5728;launch&#x7684;&#x548C;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x540E;&#x7684;&#x5C42;&#x7EA7;&#x6811;&#x5BF9;&#x6BD4;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/641050b07704bbd27f03b4deeaba61d5afd7f222a8321f47cdd5cef8cd1e3f4e" alt="&#x524D;&#x540E;&#x5C42;&#x7EA7;&#x6811;&#x5BF9;&#x6BD4;.png"></p>
<p>&#x8FD9;&#x91CC;&#x9996;&#x5148;&#x591A;&#x4E86;3&#x4E2A;&#x4E1C;&#x897F;:1&#x4E2A;Task,1&#x4E2A;&#x4E0A;&#x4E00;&#x6B65;&#x521B;&#x5EFA;&#x7684;ActivityRecord&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x5C31;&#x662F;WindowState&#x3002;</p>
<p>&#x53E6;&#x5916;&#x8FD9;&#x4E2A;Task&#x8FD8;&#x79FB;&#x52A8;&#x5230;&#x4E86;<strong>DefaultTaskDisplayArea</strong>&#x7684;&#x6700;&#x9876;&#x90E8;&#x3002;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x521B;&#x5EFA;Task</li>
<li>ActivityRecord&#x6302;&#x5728;&#x5230;&#x8FD9;&#x4E2A;Task&#x4E0B;</li>
<li>&#x5C06;&#x8FD9;&#x4E2A;Task&#x79FB;&#x52A8;&#x5230;&#x6700;&#x4E0A;&#x9762;</li>
</ol>
<p>&#x81F3;&#x4E8E;&#x6700;&#x4E0B;&#x9762;&#x7684;&#x90A3;&#x4E2A; 546fce2 &#x4E3A;&#x4EC0;&#x4E48;&#x662F;WindowState&#x5BF9;&#x8C61;&#xFF0C;&#x53C8;&#x662F;&#x600E;&#x4E48;&#x6302;&#x5728;&#x5230;ActivityRecord&#x4E0A;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x3010;&#x5E94;&#x7528;&#x7684;addWindow&#x6D41;&#x7A0B;&#x3011;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">    int startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">            int startFlags, boolean doResume, ActivityOptions options, Task inTask,</span><br><span class="line">            TaskFragment inTaskFragment, boolean restrictedBgActivity,</span><br><span class="line">            NeededUriGrants intentGrants) {</span><br><span class="line">            ......</span><br><span class="line">            / computeTargetTask&#x5185;&#x90E8;&#x4F1A;&#x6839;&#x636E;&#x5177;&#x4F53;&#x6761;&#x4EF6;&#x8FD4;&#x56DE;Task&#xFF08;&#x6BD4;&#x5982;&#x6807;&#x5FD7;&#x4F4D;FLAG_ACTIVITY_NEW_TASK&#x59D0;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x521B;&#x5EFA;Task   &#xFF09;</span><br><span class="line">            // &#x8FD9;&#x91CC;reusedTask&#x4E3A; null&#xFF0C;&#x56E0;&#x4E3A;&#x662F;&#x65B0;&#x542F;&#x52A8;&#x7684;&#x5E94;&#x7528;&#xFF0C;&#x6240;&#x4EE5;computeTargetTask&#x4E5F;&#x627E;&#x4E0D;&#x5230;task&#xFF0C;&#x6700;&#x7EC8;&#x4E5F;&#x4E3A;null</span><br><span class="line">            /</span><br><span class="line">            final Task targetTask = reusedTask != null ? reusedTask : computeTargetTask();</span><br><span class="line">            // &#x90A3;&#x4E48;newTask&#x4E3A;true&#xFF0C; &#x8868;&#x793A;&#x9700;&#x8981;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;task</span><br><span class="line">            final boolean newTask = targetTask == null;</span><br><span class="line">            // &#x540C;&#x6837;&#x4E3A;null</span><br><span class="line">            mTargetTask = targetTask;</span><br><span class="line">            ......</span><br><span class="line">            if (mTargetRootTask == null) {</span><br><span class="line">            // &#x91CD;&#x70B9;* 1. &#x521B;&#x5EFA;Task   23</span><br><span class="line">            mTargetRootTask = getOrCreateRootTask(mStartActivity, mLaunchFlags, targetTask,</span><br><span class="line">                    mOptions);</span><br><span class="line">            }</span><br><span class="line">            if (newTask) {</span><br><span class="line">                // taskToAffiliate &#x4E3A;null</span><br><span class="line">                final Task taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != null)</span><br><span class="line">                        ? mSourceRecord.getTask() : null;</span><br><span class="line">                // &#x91CD;&#x70B9;* 2. &#x5C06;&#x9700;&#x8981;&#x542F;&#x52A8;&#x7684;ActivityRecord&#x4E0E; &#x65B0;&#x521B;&#x5EFA;&#x7684;Task &#x8FDB;&#x884C;&#x7ED1;&#x5B9A;</span><br><span class="line">                setNewTask(taskToAffiliate);</span><br><span class="line">            } else if (mAddingToTask) {</span><br><span class="line">                addOrReparentStartingActivity(targetTask, &quot;adding to task&quot;);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            if (!mAvoidMoveToFront &amp;&amp; mDoResume) {</span><br><span class="line">                // &#x79FB;&#x52A8;&#x5230;&#x6808;&#x9876; </span><br><span class="line">                mTargetRootTask.getRootTask().moveToFront(&quot;reuseOrNewTask&quot;, targetTask);</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            if (mDoResume) {</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;*3. task &#x5904;&#x7406;&#x5B8C;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x5C06;task&#x9876;&#x90E8;&#x7684;Activity&#x663E;&#x793A;&#xFF08;resume&#xFF09; </span><br><span class="line">                mRootWindowContainer.resumeFocusedTasksTopActivities(</span><br><span class="line">                        mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p>&#x5177;&#x4F53;&#x539F;&#x56E0;&#x5728;&#x4EE3;&#x7801;&#x52A0;&#x4E86;&#x6CE8;&#x91CA;&#xFF0C;&#x90A3;&#x4E48;&#x7B2C;&#x4E00;&#x6B65;&#x5C31;&#x662F;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Task&#x4E86;&#x3002;</p>
<h3 id="2-2-1-&#x521B;&#x5EFA;Task-getOrCreateRootTask"><a href="#2-2-1-&#x521B;&#x5EFA;Task-getOrCreateRootTask" class="headerlink" title="2.2.1 &#x521B;&#x5EFA;Task getOrCreateRootTask"></a>2.2.1 &#x521B;&#x5EFA;Task getOrCreateRootTask</h3><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityStarter::getOrCreateRootTask</span><br><span class="line">    RootWindowContainer::getOrCreateRootTask</span><br><span class="line">        RootWindowContainer::getOrCreateRootTask</span><br><span class="line">            TaskDisplayArea::getOrCreateRootTask</span><br><span class="line">                TaskDisplayArea::getOrCreateRootTask</span><br><span class="line">                    Task::Build     ---&#x521B;&#x5EFA;Task</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">    private Task getOrCreateRootTask(ActivityRecord r, int launchFlags, Task task,</span><br><span class="line">            ActivityOptions aOptions) {</span><br><span class="line">        final boolean onTop =</span><br><span class="line">                (aOptions == null || !aOptions.getAvoidMoveToFront()) &amp;&amp; !mLaunchTaskBehind;</span><br><span class="line">        final Task sourceTask = mSourceRecord != null ? mSourceRecord.getTask() : null;</span><br><span class="line">        return mRootWindowContainer.getOrCreateRootTask(r, aOptions, task, sourceTask, onTop,</span><br><span class="line">                mLaunchParams, launchFlags);</span><br><span class="line">    }</span><br><span class="line">// onTop &#x8868;&#x793A;&#x662F;&#x5426;&#x8981;&#x79FB;&#x5230;&#x5230;&#x5F53;&#x524D;&#x6808;&#x9876;&#xFF0C;&#x90A3;&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x7684;&#xFF0C;&#x65B0;&#x542F;&#x52A8;&#x7684;Activity&#x5F53;&#x524D;&#x8981;&#x518D;&#x6700;&#x4E0A;&#x9762;&#xFF0C;&#x8FD9;&#x91CC; aOptions &#x4E3A;null&#xFF0C;&#x6240;&#x4EE5;&#x4E3A;true</span><br><span class="line">// sourceTask &#x8868;&#x793A;&#x4ECE;&#x54EA;&#x91CC;&#x542F;&#x52A8;&#x7684;&#xFF0C;&#x5F53;&#x524D;launch&#x6240;&#x5728;&#x7684;Task &#x5C31;&#x662F;sourceTask</span><br><span class="line"></span><br><span class="line"># RootWindowContainer</span><br><span class="line">    Task getOrCreateRootTask(@Nullable ActivityRecord r, @Nullable ActivityOptions options,</span><br><span class="line">            @Nullable Task candidateTask, boolean onTop) {</span><br><span class="line">        return getOrCreateRootTask(r, options, candidateTask, null /* sourceTask */, onTop,</span><br><span class="line">                null /* launchParams */, 0 /* launchFlags */);</span><br><span class="line">    }</span><br><span class="line">    Task getOrCreateRootTask(@Nullable ActivityRecord r,</span><br><span class="line">            @Nullable ActivityOptions options, @Nullable Task candidateTask,</span><br><span class="line">            @Nullable Task sourceTask, boolean onTop,</span><br><span class="line">            @Nullable LaunchParamsController.LaunchParams launchParams, int launchFlags) {</span><br><span class="line">            ......</span><br><span class="line">            final int activityType = resolveActivityType(r, options, candidateTask);</span><br><span class="line">            if (taskDisplayArea != null) {</span><br><span class="line">                if (canLaunchOnDisplay(r, taskDisplayArea.getDisplayId())) {</span><br><span class="line">                    // &#x91CD;&#x70B9;*1. &#x4F20;&#x9012;&#x5230;TaskDisplayArea</span><br><span class="line">                    return taskDisplayArea.getOrCreateRootTask(r, options, candidateTask,</span><br><span class="line">                            sourceTask, launchParams, launchFlags, activityType, onTop);</span><br><span class="line">                } else {</span><br><span class="line">                    taskDisplayArea = null;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">    }</span><br><span class="line">// &#x7ECF;&#x8FC7;&#x540C;&#x540D;&#x8C03;&#x7528;&#x540E;&#xFF0C;&#x903B;&#x8F91;&#x8FDB;&#x5165;&#x5230;  TaskDisplayArea</span><br><span class="line"></span><br><span class="line"># TaskDisplayArea</span><br><span class="line">    Task getOrCreateRootTask(int windowingMode, int activityType, boolean onTop,</span><br><span class="line">            @Nullable Task candidateTask, @Nullable Task sourceTask,</span><br><span class="line">            @Nullable ActivityOptions options, int launchFlags) {</span><br><span class="line">            if(....) {</span><br><span class="line">                // &#x62FF;&#x5230;&#x4E4B;&#x524D;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">                return candidateTask.getRootTask();</span><br><span class="line">            }</span><br><span class="line">            ......// &#x7B2C;&#x4E00;&#x6B21;&#x663E;&#x793A;&#x6240;&#x4EE5;&#x662F;&#x65B0;&#x5EFA;Task</span><br><span class="line">            return new Task.Builder(mAtmService)</span><br><span class="line">                .setWindowingMode(windowingMode)</span><br><span class="line">                .setActivityType(activityType)</span><br><span class="line">                .setOnTop(onTop)</span><br><span class="line">                .setParent(this)  // &#x4E3B;&#x8981;&#x8FD9;&#x4E2A;this&#x88AB;&#x8BBE;&#x7F6E;&#x4E3A;Parent&#x3002;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x6302;&#x8F7D;&#x5230;&#x4E86;DefaultTaskDisplayArea&#x4E0B;</span><br><span class="line">                .setSourceTask(sourceTask)</span><br><span class="line">                .setActivityOptions(options)</span><br><span class="line">                .setLaunchFlags(launchFlags)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">// &#x770B;&#x65B9;&#x6CD5;&#x540D;&#x662F;&#x83B7;&#x53D6;&#x6216;&#x521B;&#x5EFA;Task, &#x8FD9;&#x8FB9;&#x662F;&#x65B0;&#x542F;&#x52A8;&#x7684;Activity&#x6240;&#x4EE5;&#x9700;&#x8981;&#x521B;&#x5EFA;Task&#x3002;&#x5982;&#x679C;&#x662F;&#x4EE5;&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x65B9;&#x5F0F;&#x6253;&#x5F00;&#x5E94;&#x7528;&#x5185;&#x7684;&#x53E6;&#x4E00;&#x4E2A;Activity&#xFF0C;&#x5C31;&#x8D70;&#x7684;&#x662F;&#x4E0A;&#x9762;&#x7684; return candidateTask.getRootTask();</span><br><span class="line">&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x771F;&#x6B63;&#x89E6;&#x53D1;Task&#x7684;&#x521B;&#x5EFA;&#x3002;</span><br><span class="line">// &#x53E6;&#x5916;&#x8BBE;&#x7F6E;&#x7684;parent&#x5C31;&#x662F;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x5E94;&#x7528;&#x6240;&#x5728;&#x7684;&#x540D;&#x4E3A;&#x201C;DefaultTaskDisplayArea&#x201D;&#x7684;TaskDisplayArea</span><br><span class="line"># Task</span><br><span class="line">    # Task.Builder</span><br><span class="line">        Task build() {</span><br><span class="line">            if (mParent != null &amp;&amp; mParent instanceof TaskDisplayArea) {</span><br><span class="line">                validateRootTask((TaskDisplayArea) mParent);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            if (mActivityInfo == null) {</span><br><span class="line">                mActivityInfo = new ActivityInfo();</span><br><span class="line">                mActivityInfo.applicationInfo = new ApplicationInfo();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            mUserId = UserHandle.getUserId(mActivityInfo.applicationInfo.uid);</span><br><span class="line">            mTaskAffiliation = mTaskId;</span><br><span class="line">            mLastTimeMoved = System.currentTimeMillis();</span><br><span class="line">            mNeverRelinquishIdentity = true;</span><br><span class="line">            mCallingUid = mActivityInfo.applicationInfo.uid;</span><br><span class="line">            mCallingPackage = mActivityInfo.packageName;</span><br><span class="line">            mResizeMode = mActivityInfo.resizeMode;</span><br><span class="line">            mSupportsPictureInPicture = mActivityInfo.supportsPictureInPicture();</span><br><span class="line">            if (mActivityOptions != null) {</span><br><span class="line">                mRemoveWithTaskOrganizer = mActivityOptions.getRemoveWithTaskOranizer();</span><br><span class="line">            }</span><br><span class="line">            // &#x91CD;&#x70B9;* 1. &#x521B;&#x5EFA;task</span><br><span class="line">            final Task task = buildInner();</span><br><span class="line">            task.mHasBeenVisible = mHasBeenVisible;</span><br><span class="line"></span><br><span class="line">            // Set activity type before adding the root task to TaskDisplayArea, so home task can</span><br><span class="line">            // be cached, see TaskDisplayArea#addRootTaskReferenceIfNeeded().</span><br><span class="line">            if (mActivityType != ACTIVITY_TYPE_UNDEFINED) {</span><br><span class="line">                task.setActivityType(mActivityType);</span><br><span class="line">            }</span><br><span class="line">            // &#x91CD;&#x70B9;* 2. &#x5165;&#x6808; &#x8FD9;&#x91CC;&#x7684; mOnTop&#x4E3A;true</span><br><span class="line">            if (mParent != null) {</span><br><span class="line">                if (mParent instanceof Task) {</span><br><span class="line">                    final Task parentTask = (Task) mParent;</span><br><span class="line">                    parentTask.addChild(task, mOnTop ? POSITION_TOP : POSITION_BOTTOM,</span><br><span class="line">                            (mActivityInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != 0);</span><br><span class="line">                } else {</span><br><span class="line">                    mParent.addChild(task, mOnTop ? POSITION_TOP : POSITION_BOTTOM);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            // Set windowing mode after attached to display area or it abort silently.</span><br><span class="line">            if (mWindowingMode != WINDOWING_MODE_UNDEFINED) {</span><br><span class="line">                task.setWindowingMode(mWindowingMode, true /* creating */);</span><br><span class="line">            }</span><br><span class="line">            // &#x8FD4;&#x56DE;</span><br><span class="line">            return task;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // &#x521B;&#x5EFA;</span><br><span class="line">        Task buildInner() {</span><br><span class="line">            return new Task(mAtmService, mTaskId, mIntent, mAffinityIntent, mAffinity,</span><br><span class="line">                    mRootAffinity, mRealActivity, mOrigActivity, mRootWasReset, mAutoRemoveRecents,</span><br><span class="line">                    mAskedCompatMode, mUserId, mEffectiveUid, mLastDescription, mLastTimeMoved,</span><br><span class="line">                    mNeverRelinquishIdentity, mLastTaskDescription, mLastSnapshotData,</span><br><span class="line">                    mTaskAffiliation, mPrevAffiliateTaskId, mNextAffiliateTaskId, mCallingUid,</span><br><span class="line">                    mCallingPackage, mCallingFeatureId, mResizeMode, mSupportsPictureInPicture,</span><br><span class="line">                    mRealActivitySuspended, mUserSetupComplete, mMinWidth, mMinHeight,</span><br><span class="line">                    mActivityInfo, mVoiceSession, mVoiceInteractor, mCreatedByOrganizer,</span><br><span class="line">                    mLaunchCookie, mDeferTaskAppear, mRemoveWithTaskOrganizer);</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p><strong>&#x5C0F;&#x7ED3;&#xFF1A;</strong></p>
<p>&#x6700;&#x540E;&#x63CF;&#x8FF0;&#x4E00;&#x4E0B;&#x6700;&#x540E;&#x521B;&#x5EFA;&#x7684;2&#x4E2A;&#x91CD;&#x70B9;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li>&#x770B;&#x5230;&#x901A;&#x8FC7;buildInner &#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;task&#xFF0C;&#x800C;buildInner &#x4E5F;&#x5F88;&#x7B80;&#x5355;&#x7C97;&#x66B4;&#xFF0C;&#x901A;&#x8FC7;&#x5404;&#x4E2A;&#x53D8;&#x91CF;&#x76F4;&#x63A5;new Task &#x5BF9;&#x8C61;&#x3002;</li>
<li>mParent &#x4E0D;&#x4E3A;null&#xFF0C; &#x662F; &#x56E0;&#x4E3A;&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019; setParent&#xFF08;this&#xFF09;,&#x5F53;&#x524D;&#x7684;&#x8FD9;&#x4E2A;this&#xFF0C;&#x5C31;&#x662F; getDefaultTaskDisplayArea&#x8FD4;&#x56DE;&#x7684;&#x3002;&#x5C31;&#x662F; 37&#x5C42;&#x7684;&#x7B2C;&#x4E8C;&#x5C42;&#x5E94;&#x7528;Activity&#x5B58;&#x5728;&#x7684;&#x201D;DefaultTaskDisplayArea&#x201D;&#x3002;</li>
</ol>
<p>&#x5728; RootWindowContainer::getOrCreateRootTask &#x4F53;&#x73B0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/816de32ddfd4af4a5cf20a70ba414c909e148e75437ed1d15a40d9a737b87514" alt="&#x521B;&#x5EFA;Task-getOrCreateRootTask.png"></p>
<p>&#x6CE8;&#x610F;log&#x91CC;&#x7684; #17 &#x7684;&#x8FD9;&#x4E2A;Task&#xFF0C;&#x4E0E;&#x524D;&#x9762;&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x65B0;&#x589E;&#x7684;Task,&#x662F;&#x5BF9;&#x5E94;&#x7684;&#x4E0A;&#x7684;&#x3002;&#x800C;&#x4E14;this= DefaultTaskDisplayArea &#x8BF4;&#x660E;&#x4E5F;&#x786E;&#x5B9E;&#x662F;&#x5F80;DefaultTaskDisplayArea&#x91CC;&#x6DFB;&#x52A0;&#x4E86;&#x3002;<br>&#x53E6;&#x5916; log&#x91CC;index&#x4E3A;3&#xFF0C;&#x7ED3;&#x5408;&#x6700;&#x4E0A;&#x9762;&#x7684;&#x524D;&#x540E;&#x5BF9;&#x6BD4;&#xFF0C;&#x8BF4;&#x660E;&#x4E5F;&#x7684;&#x5F80;&#x9876;&#x90E8;&#x6DFB;&#x52A0;&#x3002;</p>
<h3 id="2-2-2-&#x5C06;task&#x4E0E;activityRecord-setNewTask"><a href="#2-2-2-&#x5C06;task&#x4E0E;activityRecord-setNewTask" class="headerlink" title="2.2.2 &#x5C06;task&#x4E0E;activityRecord setNewTask"></a>2.2.2 &#x5C06;task&#x4E0E;activityRecord setNewTask</h3><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;    ActivityStarer::setNewTask</span><br><span class="line">        ActivityStarer::addOrReparentStartingActivity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarer</span><br><span class="line">    private void setNewTask(Task taskToAffiliate) {</span><br><span class="line">        // &#x4E3A;true</span><br><span class="line">        final boolean toTop = !mLaunchTaskBehind &amp;&amp; !mAvoidMoveToFront;</span><br><span class="line">        // &#x5C31;&#x662F;mTargetRootTask,&#x4E5F;&#x5C31;&#x662F;&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">        final Task task = mTargetRootTask.reuseOrCreateTask(</span><br><span class="line">                mNewTaskInfo != null ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                mNewTaskIntent != null ? mNewTaskIntent : mIntent, mVoiceSession,</span><br><span class="line">                mVoiceInteractor, toTop, mStartActivity, mSourceRecord, mOptions);</span><br><span class="line">        task.mTransitionController.collectExistenceChange(task);</span><br><span class="line">        // ActivityRecord&#x7684;&#x6302;&#x8F7D;</span><br><span class="line">        addOrReparentStartingActivity(task, &quot;setTaskFromReuseOrCreateNewTask&quot;);</span><br><span class="line">        // &#x9700;&#x8981;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x6253;&#x5370;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_TASKS, &quot;Starting new activity %s in new task %s&quot;,</span><br><span class="line">                mStartActivity, mStartActivity.getTask());</span><br><span class="line"></span><br><span class="line">        // mLaunchTaskBehind &#x4E3A;false&#xFF0C;&#x6240;&#x4EE5;taskToAffiliate &#x4E3A;null </span><br><span class="line">        if (taskToAffiliate != null) {</span><br><span class="line">            mStartActivity.setTaskToAffiliateWith(taskToAffiliate);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;task &#x548C;mTargetRootTask&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C; &#x8FDB;&#x6E90;&#x7801;&#x8DDF;&#x5230;&#x6D41;&#x7A0B;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x3002;<br>&#x7136;&#x540E;&#x8FDB;&#x5165; addOrReparentStartingActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarer</span><br><span class="line">    private void addOrReparentStartingActivity(@NonNull Task task, String reason) {</span><br><span class="line">        //  newParent = task &#x90FD;&#x662F;&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">        TaskFragment newParent = task;</span><br><span class="line">        ......</span><br><span class="line">        if (mStartActivity.getTaskFragment() == null</span><br><span class="line">                || mStartActivity.getTaskFragment() == newParent) {</span><br><span class="line">            // &#x91CD;&#x70B9;&#xFF0C; &#x5C06; ActivityRecord&#x6302;&#x5728;&#x5230;&#x65B0;&#x521B;&#x5EFA;&#x7684;Task&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x9876;&#x90E8;</span><br><span class="line">            newParent.addChild(mStartActivity, POSITION_TOP);</span><br><span class="line">        } else {</span><br><span class="line">            mStartActivity.reparent(newParent, newParent.getChildCount() /* top */, reason);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x903B;&#x8F91;&#x8BBE;&#x8BA1;&#x5230;&#x7684;Task&#x5C31;&#x662F;&#x4E0A;&#x4E00;&#x6B65;&#x521B;&#x5EFA;&#x7684;Task&#xFF0C;mStartActivity&#x5219;&#x662F;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x5728;&#x4E4B;&#x524D;&#x903B;&#x8F91;&#x521B;&#x5EFA;&#x7684;ActivityRecord&#x3002;</p>
<p><strong>setNewTask&#x7684;&#x5806;&#x6808;&#x4FE1;&#x606F;&#x5982;&#x4E0B;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/d5b867d3024696e4f0b4a8e8ace66c70fee7893f6520664b4f980566a6fc1996" alt="AcvtivityRecord&#x6302;&#x5728;&#x5230;Task.png"></p>
<p>&#x53E6;&#x5916;&#x8FD9;&#x6BB5;&#x903B;&#x8F91;&#x91CC;&#x6709;&#x4E2A;ProtoLog&#x6253;&#x5370;&#xFF0C;&#x65E5;&#x5FD7;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/850b73b8b4ee169e903d5b920ffa720aa48d06b9cf7d94145b4ffdbc0c092c7e" alt="setNewTask&#x7684;ProtoLog.png"></p>
<p><strong>&#x5C0F;&#x7ED3;&#xFF1A;</strong></p>
<p>&#x7ED3;&#x5408;&#x903B;&#x8F91;&#x5206;&#x6790;+&#x5806;&#x6808;&#x4FE1;&#x606F;+ProtoLog&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x8BA4;setNewTask&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x662F;&#x5C06;ActivityRecord&#x6302;&#x5728;&#x5230;Task&#x4E2D;&#xFF0C;&#x800C;&#x4E14;&#x5728;&#x9876;&#x90E8;</p>
<h3 id="2-2-2-3-&#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8;-moveToFront"><a href="#2-2-2-3-&#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8;-moveToFront" class="headerlink" title="2.2.2.3 &#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8; moveToFront"></a>2.2.2.3 &#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8; moveToFront</h3><p>&#x8FD9;&#x91CC;&#x63D0;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;moveToFront&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x524D;&#x9762;&#x521B;&#x5EFA;Task&#x5E76;&#x6DFB;&#x52A0;&#x5230; DefaultTaskDisplayArea &#x65F6;&#x662F;&#x5F80;&#x9876;&#x90E8;&#x6DFB;&#x52A0;&#xFF0C;&#x540E;&#x9762;&#x5C06;ActivityRecord&#x6302;&#x5728;&#x5230;Task,&#x4E5F;&#x662F;&#x6302;&#x5728;&#x5230;&#x5176;&#x9876;&#x90E8;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5176;&#x5B9E;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x3002;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x573A;&#x666F;&#xFF0C;&#x8FD9;&#x91CC;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x91CD;&#x70B9;&#x65B9;&#x6CD5;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;Task::moveToFront                      -- 2.1.3 &#x79FB;&#x52A8;Task</span><br><span class="line">    Task::moveToFrontInner</span><br><span class="line">        TaskDisplayArea::positionChildAt</span><br><span class="line">            TaskDisplayArea::positionChildTaskAt</span><br><span class="line">                ActivityTaskSupervisor::updateTopResumedActivityIfNeeded</span><br><span class="line">                    ActivityRecord::onTopResumedActivityChanged      --&#x89E6;&#x53D1;TopResumedActivityChangeItem</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<p>&#x9996;&#x5148;&#x786E;&#x5B9A;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002; &#x9700;&#x8981;&#x79FB;&#x52A8;&#x5230;&#x9876;&#x90E8;&#x7684;&#x662F;&#x54EA;&#x4E2A;task&#xFF1F; &#x8FD9;&#x4E2A;task&#x6240;&#x5728;&#x7684;&#x662F;&#x5728;&#x54EA;&#x4E2A;task&#xFF1F; &#x8FD9;&#x91CC;&#x8BBE;&#x8BA1;&#x5230;&#x4E86;2&#x4E2A;task<br>&#x5728;ActivityStarter::startActivityInner&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x7684;&#x662F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;mTargetRootTask.getRootTask().moveToFront(&quot;reuseOrNewTask&quot;, targetTask);</span><br></pre></td></tr></table></figure>

<p>&#x5DF2;&#x77E5;mTargetRootTask&#x662F;&#x65B0;&#x521B;&#x5EFA;&#x7ED9;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7528;&#x7684;Task, mTargetRootTask.getRootTask()&#x80AF;&#x5B9A;&#x5C31;&#x662F;&#x8FD8;&#x662F;&#x672C;&#x8EAB;&#x3002;</p>
<p>tip &#xFF1A;getRootTask&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x9876;&#x90E8;&#x7684;Task, &#x5F53;&#x5929;Task&#x4E0A;&#x4E00;&#x5C42;&#x662F;TaskDisplayArea&#x7C7B;&#x578B; &#xFF08;name&#x4E3A;DefaultTaskDisplayArea&#xFF09;<br>&#x800C;mTargetRootTask.getParent&#x8FD4;&#x56DE;&#x7684;&#x7236;&#x5BB9;&#x5668;&#xFF0C;&#x5219;&#x662F; name&#x4E3A;DefaultTaskDisplayArea&#x7684;TaskDisplayArea&#x3002;<br>&#x5177;&#x4F53;&#x4E0D;&#x6DF1;&#x5165;&#xFF0C;&#x4EE5;&#x4E3B;&#x6D41;&#x7A0B;&#x4E3A;&#x4E3B;.&#x3002;</p>
<p><strong>&#x5230;&#x8FD9;&#x91CC;&#xFF0C;AMS&#x5DF2;&#x7ECF;&#x5C06;&#x9700;&#x8981;&#x7684;ActivityRecord&#x548C;Task&#x521B;&#x5EFA;&#x5E76;&#x4E14;&#x6302;&#x8F7D;&#x5230;&#x5C42;&#x7EA7;&#x6811;&#x4E2D;&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x662F;&#x9700;&#x8981;&#x5904;&#x7406;&#x65B0;&#x7684;Activity&#x542F;&#x52A8;&#x548C;&#x663E;&#x793A;&#x903B;&#x8F91;&#x4E86;</strong></p>
<h3 id="2-2-3-&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities"><a href="#2-2-3-&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities" class="headerlink" title="2.2.3 &#x663E;&#x793A;Activity resumeFocusedTasksTopActivities"></a>2.2.3 &#x663E;&#x793A;Activity resumeFocusedTasksTopActivities</h3><p>&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x540E;&#x7EED;&#x6D41;&#x7A0B;&#x5728;&#x4E0B;&#x4E00;&#x7BC7;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/0bf09f6e3ae2b1c7d20cfbb1c0be261d.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340197367515578378.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340197367515578378.html" itemprop="url">如果iconfont停止服务了，我们怎么办</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T09:50:36+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9d9b0890fa0fe742ad1771f22fea3001a66210f000e7b188489bfea67744a753" alt="&#x4E16;&#x754C;&#x6700;&#x5927;&#x7684;&#x65E0;&#x8F90;&#x6469;&#x5929;&#x8F6E;.webp"></p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x4E2A;&#x4EBA;&#x4E00;&#x76F4;&#x90FD;&#x6BD4;&#x8F83;&#x559C;&#x6B22;&#x963F;&#x91CC;&#x5927;&#x4F6C;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x4E9B;&#x7EC4;&#x4EF6;&#x670D;&#x52A1;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x53EA;&#x8BF4;&#x56FE;&#x6807;&#x7BA1;&#x7406;&#x5427;&#xFF0C;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x65F6;&#x5019;&#x6211;&#x662F;&#x4F7F;&#x7528;&#x7684;<a href="/external_links/3d03404d59e5656529e414bbf80b04e4.html" target="blank" rel="noopener">icomoon.io</a> &#x540E;&#x9762;&#x53D1;&#x73B0;<a href="/external_links/14b9e6faed15376ced2bf66eed9a10f2.html" target="blank" rel="noopener">www.iconfont.cn/</a> &#x5728;&#x4EE5;&#x524D;&#x5F00;&#x53D1;&#x662F;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x4E3A;&#x4E86;&#x56FE;&#x7247;&#x7684;&#x8BF7;&#x6C42;&#x5C11;&#x70B9;&#xFF0C;&#x63D0;&#x5347;&#x7F51;&#x7AD9;&#x7684;&#x6027;&#x80FD;&#x4F1A;&#x628A;&#x8FD9;&#x4E9B;&#x5C0F;&#x56FE;&#x6807;&#x505A;&#x5230;&#x4E00;&#x5F20;&#x56FE;&#x4E0A;&#x9762;&#x4E13;&#x4E1A;&#x53EB;&#x6CD5;&#x662F;&#x96EA;&#x78A7;&#x56FE;&#xFF0C;&#x540E;&#x6765;&#x968F;&#x7740;&#x524D;&#x7AEF;&#x53D1;&#x5C55;&#x6709;&#x4E86;&#x5B57;&#x4F53;&#x56FE;&#x6807;&#xFF0C;&#x4E0D;&#x5570;&#x55E6;&#x4E86;&#x5427;&#xFF0C;&#x56DE;&#x5230;&#x6B63;&#x9898;&#xFF0C;&#x7531;&#x4E8E;&#x4E0A;&#x6B21;icofont&#x5B98;&#x7F51;&#x6302;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x7684;&#x9879;&#x76EE;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x6B63;&#x5E38;&#x8FED;&#x4EE3;&#xFF0C;&#x6211;&#x5C31;&#x51B3;&#x5B9A;&#x8981;&#x81EA;&#x5DF1;&#x5F04;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x56FE;&#x6807;&#x7BA1;&#x7406;&#x3002;</p>
<h2 id="&#x9700;&#x6C42;"><a href="#&#x9700;&#x6C42;" class="headerlink" title="&#x9700;&#x6C42;"></a>&#x9700;&#x6C42;</h2><p>&#x4E00;&#x822C;&#x4F7F;&#x7528;&#x9700;&#x8981;&#x7684;&#x662F;&#x628A;&#x8BBE;&#x8BA1;&#x505A;&#x597D;&#x7684;&#x56FE;&#x6807;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x4E0B;&#x8F7D;&#x7684;svg&#x56FE;&#x6807;&#x4E0A;&#x4F20;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#xFF0C;&#x5E76;&#x4E14;&#x6253;&#x5305;&#x6210;&#x4E00;&#x4E2A;js&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#x3002;</p>
<h2 id="&#x51C6;&#x5907;"><a href="#&#x51C6;&#x5907;" class="headerlink" title="&#x51C6;&#x5907;"></a>&#x51C6;&#x5907;</h2><p>&#x90FD;&#x8BF4;&#x5929;&#x4E0B;&#x6587;&#x7AE0;&#x4E00;&#x5927;&#x6284;&#xFF0C;&#x6211;&#x4E5F;&#x662F;&#x53BB;&#x6284;iconfont,&#x6211;&#x628A;iconfont&#x7684;&#x4F7F;&#x7528;demo&#x6253;&#x5F00;&#x7814;&#x7A76;&#x4E86;&#x4E00;&#x4E0B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0f739810422d023d39af2170d02b486277da490fb604be02c0a11f6664cc2e2b" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2795407031b00527c974856d8311a823f66914cae4ccaf6845349f6f22c44112" alt="image.png"></p>
<p>&#x6211;&#x8FD9;&#x91CC;&#x53EA;&#x8BF4;Symbol&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;&#x770B;&#x5230;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5F15;&#x5165;./iconfont.js</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a9ebcba6c0a3ac94fcdf9f6fbb8f5cfc234b3444f02419bb5c733f22d2763812" alt="image.png"></p>
<p>iconfont&#x628A;&#x6211;&#x4EEC;&#x4E0A;&#x4F20;&#x7684;&#x56FE;&#x6807;&#x8FDB;&#x884C;&#x4E86;&#x5220;&#x51CF;&#x4F18;&#x5316;,&#x6700;&#x5916;&#x5C42;&#x5C31;&#x4E00;&#x4E2A;svg&#x6807;&#x7B7E;&#x91CC;&#x9762;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;symbol&#x6807;&#x7B7E;&#x6765;&#x5305;&#x88F9;&#x4E4B;&#x524D;&#x7684;&#x56FE;&#x6807;&#x5185;&#x5BB9;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;symbol&#x7684;id&#x90FD;&#x5BF9;&#x5E94;&#x4E4B;&#x524D;&#x7684;svg&#x56FE;&#x6807;&#x540D;&#x79F0;&#x3002;</p>
<blockquote>
<p>iconfont&#x4E5F;&#x6CA1;&#x6709;&#x5F00;&#x6E90;,&#x5177;&#x4F53;&#x600E;&#x4E48;&#x505A;&#x7684;&#x54B1;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#xFF0C;&#x53EA;&#x80FD;&#x77E5;&#x9053;&#x76EE;&#x524D;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4E86;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x6309;&#x7167;&#x81EA;&#x5DF1;&#x7406;&#x89E3;&#x5F00;&#x59CB;&#x5F00;&#x53D1;&#x5B9E;&#x73B0;&#x4E86;</p>
</blockquote>
<h2 id="&#x524D;&#x7AEF;&#x5F00;&#x53D1;"><a href="#&#x524D;&#x7AEF;&#x5F00;&#x53D1;" class="headerlink" title="&#x524D;&#x7AEF;&#x5F00;&#x53D1;"></a>&#x524D;&#x7AEF;&#x5F00;&#x53D1;</h2><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x524D;&#x7AEF;&#x9700;&#x8981;&#x7684;&#x662F;&#x628A;&#x8BBE;&#x8BA1;&#x7A3F;&#x7684;svg&#x56FE;&#x53D8;&#x6210;symbol&#x91CC;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6253;&#x5F00;svg&#x56FE;<br>&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x6D4B;&#x8BD5;&#x4E0B;&#xFF0C;&#x76F4;&#x63A5;&#x628A;&#x5185;&#x5BB9;&#x590D;&#x5236;&#x7136;&#x540E;&#x7C98;&#x8D34;&#x5E26;&#x4E86;iconfont.js&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x8FD0;&#x884C;demo&#x56FE;&#x6807;&#x6B63;&#x5E38;&#x663E;&#x793A;&#x5C31;&#x8BF4;&#x660E;&#x662F;ok&#x7684;&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x505A;&#x662F;&#x4E0D;&#x884C;&#x7684;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/251bbeaed0fbe470cd8e42560c67f28672aa99c558cf00c745c04ae00e7e4754" alt="image.png"></p>
<p>&#x901A;&#x8FC7;&#x56FE;&#x7247;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x73B0;&#x5728;&#x9700;&#x8981;&#x7684;&#x5C31;&#x662F;&#x628A;svg&#x91CC;&#x9762;&#x7684;path&#x6539;&#x6210;&#x7528;symblo&#x6765;&#x5305;&#x88F9;&#xFF0C;&#x5728;&#x5F00;&#x53D1;&#x4E2D;svg&#x56FE;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7;&#x6587;&#x6863;&#x6D41;&#x4E0A;&#x4F20;&#x4E0A;&#x6765;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x5BF9;&#x6587;&#x6863;&#x6D41;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#xFF0C;&#x5148;&#x628A;&#x6587;&#x6863;&#x6D41;&#x53D8;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x7136;&#x540E;js&#x64CD;&#x4F5C;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FBE;&#x5230;&#x76EE;&#x7684;&#x3002;</p>
<ol>
<li>&#x4F7F;&#x7528;&#x5230;FileReader&#x548C;readAsText&#x83B7;&#x53D6;&#x5230;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801; const fileParse = (file) =&gt; {</span><br><span class="line">   return new Promise((resolve) =&gt; {</span><br><span class="line">     const fileReader = new FileReader();</span><br><span class="line">     fileReader.readAsText(file, &quot;UTF-8&quot;);</span><br><span class="line">     fileReader.onload = (e) =&gt; {</span><br><span class="line">       resolve({ content: e.target?.result, name: file.name })</span><br><span class="line">     }</span><br><span class="line">   })</span><br><span class="line"> }</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x5B57;&#x7B26;&#x64CD;&#x4F5C;&#x62FC;&#x63A5;&#x6211;&#x4F7F;&#x7528;&#x7684;&#x662F;cheerio</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;  const handleUploadSvg = ($, result) =&gt; {</span><br><span class="line">    let index = result.indexOf(&apos;&lt;svg&apos;);</span><br><span class="line">    const str = result.slice(index);</span><br><span class="line">    const svgNode = $(str);</span><br><span class="line"></span><br><span class="line">    $(&apos;svg&apos;).attr(&apos;viewBox&apos;, svgNode.attr(&apos;viewBox&apos;));</span><br><span class="line">    const findPath = svgNode.find(&apos;path&apos;);</span><br><span class="line">    if (!findPath.length) {</span><br><span class="line">      message.error(&apos;&#x56FE;&#x6807;&#x9519;&#x8BEF;&#xFF0C;&#x4E0D;&#x5B58;&#x5728;path&apos;)</span><br><span class="line">      return &apos;&apos;;</span><br><span class="line">    };</span><br><span class="line">    findPath.each((i, el) =&gt; {</span><br><span class="line">      $(el).removeAttr(&apos;id&apos;);</span><br><span class="line">    });</span><br><span class="line">    const gDom = svgNode.find(&apos;g&apos;);</span><br><span class="line"></span><br><span class="line">    gDom.each((i, el) =&gt; {</span><br><span class="line">      const path = $(el).children(&apos;path&apos;);</span><br><span class="line">      const fill = $(el).attr(&apos;fill&apos;);</span><br><span class="line">      if (fill &amp;&amp; fill !== &apos;none&apos; &amp;&amp; path.length &amp;&amp; !$(path[0])?.attr?.(&apos;fill&apos;)) {</span><br><span class="line">        $(path[0])?.attr?.(&apos;fill&apos;, fill)</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">    removeArrtId($, gDom);</span><br><span class="line"></span><br><span class="line">    if (gDom.length) {</span><br><span class="line">      $(&apos;svg&apos;).html(svgNode.html());</span><br><span class="line">    } else {</span><br><span class="line">      $(&apos;svg&apos;).html(svgNode.find(&apos;path&apos;));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return $.html(&quot;svg&quot;)</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;svg&#x6E90;&#x7801;&#xFF0C;&#x56FE;&#x6807;&#x663E;&#x793A;&#x8FD8;&#x662F;flow</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1893028f19b515a865dfda14764f9ced0099b87b24c3376b98dd14e7ad136564" alt="image.png"></p>
<p>&#x7136;&#x540E;&#x6211;&#x628A;&#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x4F20;&#x9001;&#x7ED9;&#x540E;&#x7AEF;&#x5C31;&#x884C;&#x4E86;</p>
<h2 id="&#x540E;&#x7AEF;&#x5F00;&#x53D1;"><a href="#&#x540E;&#x7AEF;&#x5F00;&#x53D1;" class="headerlink" title="&#x540E;&#x7AEF;&#x5F00;&#x53D1;"></a>&#x540E;&#x7AEF;&#x5F00;&#x53D1;</h2><p>&#x540E;&#x7AEF;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x628A;&#x6211;&#x4E0A;&#x4F20;&#x4E0A;&#x6765;&#x7684;svg&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x5230;&#x4E00;&#x8D77;&#xFF0C;&#x7136;&#x540E;&#x4EE5;iconfont.js&#x4E00;&#x6837;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;get&#x63A5;&#x53E3;&#x8FD4;&#x56DE;&#x7ED9;&#x6211;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;,<br>&#x901A;&#x8FC7;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x5C31;&#x8BF4;&#x660E;ok&#x4E86;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/361da9b48b1dd012185535ee3877e20fdb975f7811e33a439b207bf83ed8dc3c" alt="image.png"></p>
<p>&#x5176;&#x4ED6;&#x4E24;&#x79CD;&#x9700;&#x8981;&#x7528;&#x5230;&#x4E9B;&#x7B2C;&#x4E09;&#x65B9;&#x5E93;&#x5F53;&#x65F6;&#x4E5F;&#x6709;&#x987A;&#x4FBF;&#x7814;&#x7A76;&#x770B;&#x5230;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x9700;&#x8981;&#x6211;&#x518D;&#x5199;&#x4E00;&#x7BC7;&#x3002;</p>
<p>&#x6587;&#x7AE0;&#x4E2D;&#x4F1A;&#x6709;&#x4E9B;&#x4E0D;&#x600E;&#x4E48;&#x6E05;&#x6670;&#x6216;&#x8005;&#x6709;&#x95EE;&#x9898;&#x7684;&#x5730;&#x65B9;&#x8FD8;&#x671B;&#x5404;&#x4F4D;&#x5927;&#x4F6C;&#x89C1;&#x8C05;&#xFF0C;&#x521A;&#x521A;&#x5F00;&#x59CB;&#x51B3;&#x5B9A;&#x5199;&#x4E00;&#x4E9B;&#x6280;&#x672F;&#x76F8;&#x5173;&#x6587;&#x7AE0;&#xFF0C;&#x8FD8;&#x5F88;&#x751F;&#x758F;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/a8b7cc75dbc41fafcd798693371e5fc9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340197367515414538.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340197367515414538.html" itemprop="url">零基础入门AI：一键本地运行各种开源大语言模型 - Olla</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T09:33:08+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x4EC0;&#x4E48;&#x662F;-Ollama&#xFF1F;"><a href="#&#x4EC0;&#x4E48;&#x662F;-Ollama&#xFF1F;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F; Ollama&#xFF1F;"></a>&#x4EC0;&#x4E48;&#x662F; Ollama&#xFF1F;</h1><p>Ollama &#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x5730;&#x90E8;&#x7F72;&#x548C;&#x7BA1;&#x7406;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x7531;&#x4E8E;&#x5B83;&#x6781;&#x5927;&#x7684;&#x7B80;&#x5316;&#x4E86;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#x7EC6;&#x8282;&#xFF0C;&#x4E00;&#x7ECF;&#x63A8;&#x51FA;&#x5C31;&#x5E7F;&#x53D7;&#x597D;&#x8BC4;&#xFF0C;&#x76EE;&#x524D;&#x5DF2;&#x5728;github&#x4E0A;&#x83B7;&#x5F97;&#x4E86;46k star&#x3002;</p>
<p>&#x4E0D;&#x7BA1;&#x662F;&#x8457;&#x540D;&#x7684;&#x7F8A;&#x9A7C;&#x7CFB;&#x5217;&#xFF0C;&#x8FD8;&#x662F;&#x6700;&#x65B0;&#x7684;AI&#x65B0;&#x8D35;Mistral&#xFF0C;&#x7B49;&#x7B49;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x90FD;&#x53EF;&#x4EE5;&#x7528;Ollama&#x5B9E;&#x73B0;&#x4E00;&#x952E;&#x5B89;&#x88C5;&#x5E76;&#x8FD0;&#x884C;&#xFF0C;&#x652F;&#x6301;&#x7684;&#x66F4;&#x591A;&#x6A21;&#x578B;&#x7684;&#x5217;&#x8868;&#x53EF;&#x4EE5;&#x67E5;&#x770B;Ollama&#x5B98;&#x7F51;&#x3002;</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Parameters</th>
<th>Size</th>
<th>Download</th>
</tr>
</thead>
<tbody><tr>
<td>Llama 2</td>
<td>7B</td>
<td>3.8GB</td>
<td><code>ollama run llama2</code></td>
</tr>
<tr>
<td>Mistral</td>
<td>7B</td>
<td>4.1GB</td>
<td><code>ollama run mistral</code></td>
</tr>
</tbody></table>
<p>&#x672C;&#x6587;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x5165;&#x95E8;Ollama&#x3002;</p>
<h1 id="&#x5982;&#x4F55;&#x5B89;&#x88C5;-Ollama&#x6846;&#x67B6;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x5B89;&#x88C5;-Ollama&#x6846;&#x67B6;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x5B89;&#x88C5; Ollama&#x6846;&#x67B6;&#xFF1F;"></a>&#x5982;&#x4F55;&#x5B89;&#x88C5; Ollama&#x6846;&#x67B6;&#xFF1F;</h1><p>Ollama&#x652F;&#x6301;&#x5404;&#x4E2A;&#x5E73;&#x53F0;&#xFF1A;Mac&#x3001;Windows &#x548C; Linux&#xFF0C;&#x4E5F;&#x63D0;&#x4F9B;&#x4E86;docker image&#x3002;<br>&#x5728;Ollama&#x5B98;&#x7F51;&#x6216;&#x8005;Github&#x53EF;&#x4EE5;&#x4E0B;&#x8F7D;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x952E;&#x5B89;&#x88C5;Ollama&#x6846;&#x67B6;&#xFF1A;</p>
<ul>
<li><a href="/external_links/234177bbf722239043d3336e8c156bfe.html" target="blank" rel="noopener">macOS</a></li>
<li><a href="/external_links/923a8018b1049b9d03e348d8b242f346.html" target="blank" rel="noopener">Windows</a></li>
<li>Linux: <code>curl -fsSL https://ollama.com/install.sh | sh</code></li>
</ul>
<p>&#x7531;&#x4E8E;Ollama&#x521A;&#x652F;&#x6301;windows&#x4E0D;&#x4E45;&#xFF0C;&#x5728;windows&#x4E0A;&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x8FD8;&#x4E0D;&#x591F;&#x5B8C;&#x5584;&#xFF0C;&#x4EE5;&#x4E0B;&#x6211;&#x5C06;&#x4E3B;&#x8981;&#x4EE5;Linux&#x4E0A;&#x8FD0;&#x884C;Ollama&#x6765;&#x4E3E;&#x4F8B;&#x8BF4;&#x660E;&#x3002;</p>
<h1 id="&#x8FD0;&#x884C;-Ollama-&#x670D;&#x52A1;"><a href="#&#x8FD0;&#x884C;-Ollama-&#x670D;&#x52A1;" class="headerlink" title="&#x8FD0;&#x884C; Ollama &#x670D;&#x52A1;"></a>&#x8FD0;&#x884C; Ollama &#x670D;&#x52A1;</h1><p>&#x5728;Ollama&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C; &#x4E00;&#x822C;&#x4F1A;&#x81EA;&#x52A8;&#x542F;&#x52A8; Ollama &#x670D;&#x52A1;&#xFF0C;&#x800C;&#x4E14;&#x4F1A;&#x81EA;&#x52A8;&#x8BBE;&#x7F6E;&#x4E3A;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;&#x3002;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x662F;&#x5426;Ollama&#x662F;&#x5426;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#x3002;&#x5982;&#x4E0B;&#x4F8B;&#x5B50;&#x4E2D;&#x663E;&#x793A;&#x201C;Active: active (running)&#x201D;&#x8868;&#x793A;Ollama&#x5DF2;&#x7ECF;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;$ systemctl status ollama</span><br><span class="line">&#x25CF; ollama.service - Ollama Service</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/ollama.service; enabled; vendor preset: enabled)</span><br><span class="line">    Drop-In: /etc/systemd/system/ollama.service.d</span><br><span class="line">             &#x2514;&#x2500;environment.conf</span><br><span class="line">     Active: active (running) since Thu 2024-03-07 09:09:39 HKT; 4 days ago</span><br><span class="line">   Main PID: 19975 (ollama)</span><br><span class="line">      Tasks: 29 (limit: 69456)</span><br><span class="line">     Memory: 1.1G</span><br><span class="line">        CPU: 14min 44.702s</span><br><span class="line">     CGroup: /system.slice/ollama.service</span><br><span class="line">             &#x2514;&#x2500;19975 /usr/local/bin/ollama serve</span><br></pre></td></tr></table></figure>

<p>&#x5728;Linux&#x4E0A;&#xFF0C;&#x5982;&#x679C;Ollama&#x672A;&#x542F;&#x52A8;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x542F;&#x52A8; Ollama &#x670D;&#x52A1;&#xFF1A;<code>ollama serve</code>&#xFF0C;&#x6216;&#x8005; <code>sudo systemctl start ollama</code>&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x5206;&#x6790;Linux&#x7684;&#x5B89;&#x88C5;&#x811A;&#x672C;install.sh&#xFF0C;&#x5C31;&#x4F1A;&#x770B;&#x5230;&#x5176;&#x4E2D;&#x5DF2;&#x7ECF;&#x5C06;<code>ollama serve</code>&#x914D;&#x7F6E;&#x4E3A;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x670D;&#x52A1;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>systemctl</code>&#x6765; start / stop ollama&#x8FDB;&#x7A0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    status &quot;Creating ollama systemd service...&quot;</span><br><span class="line">    cat &lt;&lt;EOF | $SUDO tee /etc/systemd/system/ollama.service &gt;/dev/null</span><br><span class="line">[Unit]</span><br><span class="line">Description=Ollama Service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=$BINDIR/ollama serve</span><br><span class="line">User=ollama</span><br><span class="line">Group=ollama</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=3</span><br><span class="line">Environment=&quot;PATH=$PATH&quot;</span><br></pre></td></tr></table></figure>

<p>&#x542F;&#x52A8;Ollama&#x670D;&#x52A1;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5F53;&#x524D;&#x7684;Ollama&#x7248;&#x672C;&#xFF0C;&#x4EE5;&#x53CA;&#x5E38;&#x7528;&#x547D;&#x4EE4;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;~$ ollama -v</span><br><span class="line">ollama version is 0.1.20</span><br><span class="line">~$ ollama --help</span><br><span class="line">Large language model runner</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  ollama [flags]</span><br><span class="line">  ollama [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  serve       Start ollama</span><br><span class="line">  create      Create a model from a Modelfile</span><br><span class="line">  show        Show information for a model</span><br><span class="line">  run         Run a model</span><br><span class="line">  pull        Pull a model from a registry</span><br><span class="line">  push        Push a model to a registry</span><br><span class="line">  list        List models</span><br><span class="line">  cp          Copy a model</span><br><span class="line">  rm          Remove a model</span><br><span class="line">  help        Help about any command</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help      help for ollama</span><br><span class="line">  -v, --version   Show version information</span><br><span class="line"></span><br><span class="line">Use &quot;ollama [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure>

<h1 id="&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;"></a>&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;</h1><p>&#x81F3;&#x6B64;&#xFF0C;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;Ollama&#x6846;&#x67B6;&#x7684;&#x5B89;&#x88C5;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x4E00;&#x6761;&#x547D;&#x4EE4;&#x5728;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;&#x4EE5;&#x8457;&#x540D;&#x7684;&#x7F8A;&#x9A7C;&#x4E3E;&#x4F8B;&#xFF1A;<code>ollama run llama2</code>&#x3002;</p>
<p>&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x4E0B;&#x8F7D;&#x8FC7;&#x6307;&#x5B9A;&#x7684;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#x5C06;&#x4F1A;&#x5148;&#x6267;&#x884C;<code>ollama pull llama2</code>&#xFF0C;&#x5C06;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;&#xFF0C;&#x518D;&#x5728;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;</p>
<p>&#x4E0B;&#x8F7D;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8FD0;&#x884C;&#x6548;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ ollama run llama2</span><br><span class="line">&gt;&gt;&gt; who are you?</span><br><span class="line"></span><br><span class="line">I am LLaMA, an AI assistant developed by Meta AI that can understand and respond to human input in a conversational manner. I am trained on a massive dataset of text from the internet and can </span><br><span class="line">generate human-like responses to a wide range of topics and questions. I can be used to create chatbots, virtual assistants, and other applications that require natural language understanding and</span><br><span class="line">generation capabilities.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Send a message (/? for help)</span><br></pre></td></tr></table></figure>

<h1 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h1><p>Ollama&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;API&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;curl http://localhost:11434/api/generate -d &apos;{</span><br><span class="line">  &quot;model&quot;: &quot;llama2&quot;,</span><br><span class="line">  &quot;prompt&quot;:&quot;Why is the sky blue?&quot;,</span><br><span class="line">  &quot;stream&quot;: false</span><br><span class="line">}&apos;</span><br></pre></td></tr></table></figure>

<p>&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;{</span><br><span class="line">    &quot;model&quot;: &quot;llama2&quot;,</span><br><span class="line">    &quot;created_at&quot;: &quot;2024-02-26T04:35:10.787352404Z&quot;,</span><br><span class="line">    &quot;response&quot;: &quot;The sky appears blue because of a phenomenon called Rayleigh scattering, which occurs when sunlight enters Earth&apos;s atmosphere. The sunlight encounters tiny molecules of gases such as nitrogen and oxygen, which scatter the light in all directions. The shorter wavelengths of light, such as blue and violet, are scattered more than the longer wavelengths, such as red and orange. This is known as Rayleigh scattering, named after Lord Rayleigh, who first described the phenomenon in the late 19th century. As a result of this scattering, the light that reaches our eyes from the sun appears blue, especially when viewed from a distance. The closer we get to the horizon, the more the blue color appears to fade, as the light has to travel through more of the atmosphere, which scatters the shorter wavelengths even more. It&apos;s worth noting that the exact shade of blue can vary depending on the time of day and atmospheric conditions. For example, during sunrise and sunset, when the sun is low in the sky, the sky can take on a more orange or red hue due to the scattering of light by atmospheric particles. So, to summarize, the sky appears blue because of the way light interacts with the tiny molecules of gases in Earth&apos;s atmosphere, particularly nitrogen and oxygen.&quot;,</span><br><span class="line">    &quot;done&quot;: true,</span><br><span class="line">    &quot;total_duration&quot;: 7001870820,</span><br><span class="line">    &quot;load_duration&quot;: 4930376,</span><br><span class="line">    &quot;prompt_eval_duration&quot;: 60907000,</span><br><span class="line">    &quot;eval_count&quot;: 309,</span><br><span class="line">    &quot;eval_duration&quot;: 6931593000</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4F7F;&#x7528;API&#x63A5;&#x53E3;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x66F4;&#x591A;&#x7075;&#x6D3B;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6BD4;&#x5982;&#x4E0E;IDE&#x63D2;&#x4EF6;&#x914D;&#x5408;&#xFF0C;&#x5B9E;&#x73B0;&#x672C;&#x5730;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#xFF0C;&#x53EF;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#x6587;&#x7AE0;&#xFF1A;<br><a href="https://dev.newban.cn/7340461584643112971">&#x96F6;&#x57FA;&#x7840;&#x5165;&#x95E8;AI&#xFF1A;&#x642D;&#x5EFA;&#x672C;&#x5730;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;</a></p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;"></a>&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x8FD0;&#x884C;&#x547D;&#x4EE4;<code>journalctl -u ollama</code>&#xFF0C;&#x5373;&#x53EF;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x65E5;&#x5FD7;&#x3002;</p>
<h2 id="&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;"></a>&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF; <code>OLLAMA_HOST</code> &#x6765;&#x6307;&#x5B9A;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=OLLAMA_HOST=0.0.0.0:11434</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x6B64;&#x914D;&#x7F6E;&#x540E;&#xFF0C;&#x5373;&#x53EF;&#x7531;&#x4E00;&#x53F0;GPU&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x672C;&#x5730;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x670D;&#x52A1;&#x3002;</p>
<h2 id="&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;"><a href="#&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;" class="headerlink" title="&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;"></a>&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF; <code>CUDA_VISIBLE_DEVICES</code> &#x6765;&#x6307;&#x5B9A;&#x8FD0;&#x884C;Ollama&#x7684;GPU&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=CUDA_VISIBLE_DEVICES=1,2</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;"><a href="#&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;" class="headerlink" title="&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;"></a>&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;</h2><p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>macOS: <code>~/.ollama/models</code></li>
<li>Linux: <code>/usr/share/ollama/.ollama/models</code></li>
<li>Windows: <code>C:\Users&lt;username&gt;.ollama\models</code></li>
</ul>
<h2 id="&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;"></a>&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;</h2><p>Linux&#x5E73;&#x53F0;&#x5B89;&#x88C5;Ollama&#x65F6;&#xFF0C;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x65F6;&#x4F1A;&#x521B;&#x5EFA;&#x7528;&#x6237;ollama&#xFF0C;&#x518D;&#x5C06;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5230;&#x8BE5;&#x7528;&#x6237;&#x7684;&#x76EE;&#x5F55;<code>/usr/share/ollama/.ollama/models</code>&#x3002;&#x4F46;&#x7531;&#x4E8E;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5F80;&#x5F80;&#x7279;&#x522B;&#x5927;&#xFF0C;&#x6709;&#x65F6;&#x9700;&#x8981;&#x5C06;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5230;&#x4E13;&#x95E8;&#x7684;&#x6570;&#x636E;&#x76D8;&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x7684;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#x3002;</p>
<p>&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x8BBE;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x201C;OLLAMA_MODELS&#x201D;&#xFF0C;&#x4F46;&#x6211;&#x5728;Linux&#x4E0A;&#x5C1D;&#x8BD5;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x6210;&#x529F;&#x3002;</p>
<p>&#x5206;&#x6790;Linux&#x7248;&#x7684;&#x5B89;&#x88C5;&#x811A;&#x672C;install.sh&#x540E;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x662F;&#x7531;&#x4E8E;&#x5176;&#x4E2D;&#x521B;&#x5EFA;&#x4E86;&#x7528;&#x6237;ollama&#x548C;&#x7528;&#x6237;&#x7EC4;ollama&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5230;&#x4E86;&#x8BE5;&#x7528;&#x6237;&#x7684;&#x76EE;&#x5F55;<code>/usr/share/ollama/.ollama/models</code>&#xFF0C;&#x800C;&#x6211;&#x7684;&#x5E10;&#x6237;&#x5BF9;ollama&#x5E10;&#x6237;&#x7684;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#x5E76;&#x4E0D;&#x80FD;&#x751F;&#x6548;&#xFF0C;&#x5373;&#x4F7F;&#x6211;&#x518D;&#x624B;&#x52A8;&#x5C06;&#x6211;&#x7684;&#x5E10;&#x6237;&#x6DFB;&#x52A0;&#x8FDB;ollama&#x7528;&#x6237;&#x7EC4;&#xFF0C;&#x4E5F;&#x4ECD;&#x7136;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x6743;&#x9650;&#x95EE;&#x9898;&#xFF0C;&#x5BFC;&#x81F4;&#x5BF9;ollama&#x5E10;&#x6237;&#x7684;&#x76EE;&#x5F55;&#x64CD;&#x4F5C;&#x4E0D;&#x751F;&#x6548;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x65B0;&#x5EFA;&#x7684;ollama&#x5E10;&#x6237;&#x5E76;&#x6CA1;&#x6709;&#x7ED9;&#x6211;&#x5E26;&#x6765;&#x989D;&#x5916;&#x7684;&#x4FBF;&#x5229;&#xFF0C;&#x6700;&#x540E;&#x6211;&#x7528;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x6765;&#x5B9E;&#x73B0;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x7684;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF1A;</p>
<ol>
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x53D6;&#x6D88;&#x5176;&#x4E2D;&#x521B;&#x5EFA;&#x7528;&#x6237;ollama&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;# if ! id ollama &gt;/dev/null 2&gt;&amp;1; then </span><br><span class="line">    # status &quot;Creating ollama user...&quot; </span><br><span class="line">    # $SUDO useradd -r -s /bin/false -m -d /usr/share/ollama ollama </span><br><span class="line"># fi </span><br><span class="line"># status &quot;Adding current user to ollama group...&quot; </span><br><span class="line"># $SUDO usermod -a -G ollama $(whoami)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x4F7F;&#x7528;&#x6211;&#x7684;&#x5E10;&#x6237;&#x6765;&#x542F;&#x52A8;ollama&#x670D;&#x52A1;&#xFF0C;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    status &quot;Creating ollama systemd service...&quot;</span><br><span class="line">    cat &lt;&lt;EOF | $SUDO tee /etc/systemd/system/ollama.service &gt;/dev/null</span><br><span class="line">[Unit]</span><br><span class="line">Description=Ollama Service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=$BINDIR/ollama serve</span><br><span class="line">User=&lt;myusername&gt;</span><br><span class="line">Group=&lt;myusername&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x4E2D;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x53D8;&#x91CF;<code>OLLAMA_MODELS</code>&#x6307;&#x5B9A;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x7528;&#x6B64;&#x5B89;&#x88C5;&#x6587;&#x4EF6;&#x6765;&#x5B89;&#x88C5;ollama&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;Environment=&quot;OLLAMA_MODELS=/home/paco/lab/LLM/ollama/OLLAMA_MODELS&quot;</span><br></pre></td></tr></table></figure>

<p>&#x6216;&#x8005;&#x5728;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF;<code>OLLAMA_MODELS</code>&#x6765;&#x6307;&#x5B9A;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=OLLAMA_MODELS=&lt;path&gt;/OLLAMA_MODELS</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/62d4adc0d7ba6b2eb79e434743543698.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340127788053856293.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340127788053856293.html" itemprop="url">工作三年，为什么你还不会排查堆外内存泄漏？（下） 一 排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T08:11:09+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/2c38644c865fe641756f5619d34aecf0c274f90550996002372cae349c7aec77" alt="image.png"></p>
<blockquote>
<p>&#x1F448;&#x1F448;&#x1F448; <strong>&#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x5173;&#x6CE8;&#x54DF;</strong></p>
</blockquote>
<p>&#x672C;&#x6587;&#x662F;<a href="/external_links/b865190bf577074c796a70b00086c411.html" target="blank" rel="noopener">Java&#x6545;&#x969C;&#x6848;&#x4F8B;&#x5206;&#x6790;</a>&#x7684;&#x7B2C;&#x4E09;&#x7BC7;, &#x4E0A;&#x4E00;&#x7BC7;&#x4E2D;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86;&#x4E00;&#x4E2A;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x95EE;&#x9898;: <a href="https://dev.newban.cn/7338388292969283584">&#x5DE5;&#x4F5C;&#x4E09;&#x5E74;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F60;&#x8FD8;&#x4E0D;&#x4F1A;&#x6392;&#x67E5;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;(&#x4E0A;)&#xFF08;&#x6587;&#x672B;&#x9644;&#x8D60;&#x4E00;&#x4E2A;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x5DE5;&#x5177;&#xFF09; - &#x6398;&#x91D1; (juejin.cn)</a>(&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x91CC;&#x662F;&#x4F7F;&#x7528;NMT+PMAP&#x89E3;&#x51B3;&#x7684;&#x975E;Netty&#x9020;&#x6210;&#x7684;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;), &#x800C;&#x4ECA;&#x5929;&#x6211;&#x4EEC;&#x8981;&#x804A;&#x7684;&#x662F;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x4EE4;&#x4EBA;&#x5934;&#x75BC;&#x7684;&#x95EE;&#x9898;&#x2014;&#x2014;<strong>Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;</strong>&#x3002;&#x672C;&#x6587;&#x5C06;&#x5E26;&#x9886;&#x5927;&#x5BB6;&#x8DDF;&#x6211;&#x4E00;&#x8D77;&#x6392;&#x67E5;&#x7EBF;&#x4E0A;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x6848;&#x4F8B;, &#x5E76;&#x4E14;&#x6DF1;&#x5165;&#x4E86;&#x89E3;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#xFF0C;&#x6700;&#x540E;&#x63D0;&#x4F9B;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;<strong>&#x4E09;&#x4E2A;&#x5173;&#x952E;&#x6B65;&#x9AA4;</strong>&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x83B7;&#x5F97;&#x5BF9;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x7684;&#x6DF1;&#x523B;&#x7406;&#x89E3;&#xFF0C;&#x5E76;&#x5B66;&#x4F1A;&#x5982;&#x4F55;&#x6709;&#x6548;&#x5730;&#x9884;&#x9632;&#x548C;&#x89E3;&#x51B3;&#x53EF;&#x80FD;&#x7684;&#x6CC4;&#x6F0F;&#x95EE;&#x9898;.</p>
<p>&#x7ED3;&#x5408;&#x4E0A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;, &#x5982;&#x679C;&#x9762;&#x8BD5;&#x5B98;&#x518D;&#x95EE;&#x4F60;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x601D;&#x8DEF;&#x4F60;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x56DE;&#x7B54;&#x4E86;&#x5427;&#x1F60C;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x770B;&#x5168;&#x6587;&#x4E5F;&#x6CA1;&#x5173;&#x7CFB;&#x54E6;, &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x7ED3;&#x5C3E;&#x90E8;&#x5206;, &#x6211;&#x5E2E;&#x4F60;&#x603B;&#x7ED3;&#x597D;&#x4E86;&#x1F576;.</p>
</blockquote>
<h1 id="&#x4E00;-&#x6392;&#x67E5;&#x8FC7;&#x7A0B;"><a href="#&#x4E00;-&#x6392;&#x67E5;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x4E00;. &#x6392;&#x67E5;&#x8FC7;&#x7A0B;"></a>&#x4E00;. &#x6392;&#x67E5;&#x8FC7;&#x7A0B;</h1><p>&#x8D77;&#x56E0;&#x662F;&#x534A;&#x591C;&#x63A5;&#x5230;&#x673A;&#x5668;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#x544A;&#x8B66;&#x7535;&#x8BDD;, &#x673A;&#x5668;&#x5B95;&#x673A;&#x1F623;&#xFF0C;&#x4E8E;&#x662F;&#x722C;&#x8D77;&#x6765;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x6392;&#x67E5;&#x8FC7;&#x7A0B;.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/a2452e898a7444bae0d1cedf5bca73aee387f5f0df1b5dce359653149e5b842e" alt="image.png"></p>
<h2 id="1-1-&#x521D;&#x6B65;&#x5B9A;&#x4F4D;"><a href="#1-1-&#x521D;&#x6B65;&#x5B9A;&#x4F4D;" class="headerlink" title="1.1 &#x521D;&#x6B65;&#x5B9A;&#x4F4D;"></a>1.1 &#x521D;&#x6B65;&#x5B9A;&#x4F4D;</h2><p>&#x521D;&#x6B65;&#x53D1;&#x73B0;&#x662F;&#x6211;&#x4EEC;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6240;&#x5728;&#x673A;&#x5668;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#xFF0C;&#x4E0A;&#x673A;&#x5668;&#x6392;&#x67E5;&#xFF0C;&#x53D1;&#x73B0;&#x65E5;&#x5FD7;&#x4E2D;&#x6709;&#x5927;&#x91CF;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. Enable advanced leak reporting to find out where the leak occurred. To enable advanced leak reporting, specify the JVM option &apos;-Dio.netty.leakDetectionLevel=advanced&apos; or call ResourceLeakDetector.setLevel()</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x67E5;&#x9605;&#x76F8;&#x5173;&#x6587;&#x6863;&#x548C;&#x6E90;&#x7801;&#xFF0C;&#x5F53;Netty&#x5206;&#x914D;&#x7684;<code>ByteBuf</code>&#x5728;GC&#x524D;&#x6CA1;&#x6709;&#x8C03;&#x7528;<code>release</code>&#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x8BB0;&#x5F55;&#x8FD9;&#x6761;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF0C;&#x8BF4;&#x660E;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x6CA1;&#x6709;&#x91CA;&#x653E;&#xFF0C;&#x4F46;&#x662F;&#x5355;&#x51ED;&#x8FD9;&#x6761;&#x8BB0;&#x5F55;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x5224;&#x65AD;&#x662F;&#x54EA;&#x91CC;&#x51FA;&#x4E86;&#x95EE;&#x9898;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x786E;&#x5B9A;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#x1F914;&#xFF1A;</p>
<p>1&#x3001;&#x8FD9;&#x4E9B;&#x6CC4;&#x6F0F;&#x7684;Buffer&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x5206;&#x914D;&#x7684;&#xFF1F;</p>
<p>2&#x3001;&#x8FD9;&#x4E2A;Buffer&#x6700;&#x540E;&#x662F;&#x8C01;&#x6301;&#x6709;&#x7684;&#xFF1F;</p>
<p>&#x6309;&#x7167;&#x4E0A;&#x9762;Netty&#x7ED9;&#x6211;&#x4EEC;&#x7684;&#x63D0;&#x793A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;<code>-Dio.netty.leakDetectionLevel=advanced</code>&#x53C2;&#x6570;&#xFF0C;Netty&#x9ED8;&#x8BA4;&#x7684;<code>io.netty.leakDetectionLevel</code>&#x53C2;&#x6570;&#x662F;<code>simple</code>&#xFF0C;&#x53EA;&#x80FD;&#x8F93;&#x51FA;&#x4E00;&#x6761;&#x7B80;&#x5355;&#x7684;&#x6CC4;&#x6F0F;&#x8BB0;&#x5F55;&#xFF0C;&#x800C;&#x8981;&#x8F93;&#x51FA;&#x66F4;&#x52A0;&#x8BE6;&#x7EC6;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x8C03;&#x6574;level&#x53C2;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6309;&#x7167;&#x63D0;&#x793A;&#x8BBE;&#x7F6E;&#x4E3A;<code>advanced</code>&#x4E0A;&#x7EBF;&#x540E;&#x540C;&#x65F6;&#x914D;&#x7F6E;&#x544A;&#x8B66;&#x7EE7;&#x7EED;&#x89C2;&#x5BDF;&#x3002;</p>
<h2 id="1-2-&#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;"><a href="#1-2-&#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;" class="headerlink" title="1.2 &#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;"></a>1.2 &#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;</h2><p>&#x679C;&#x4E0D;&#x5176;&#x7136;&#xFF0C;&#x8FC7;&#x4E86;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;&#x65E5;&#x5FD7;&#x91CC;&#x53C8;&#x51FA;&#x73B0;&#x4E86;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x6B21;&#x66F4;&#x52A0;&#x8BE6;&#x7EC6;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x5806;&#x6808;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;[ERROR] epollEventLoopGroup-3-20 - io.netty.util.ResourceLeakDetector : LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. See https://netty.io/wiki/reference-counted-objects.html for more information.</span><br><span class="line">Recent access records:</span><br><span class="line">#1:</span><br><span class="line">        io.netty.buffer.AdvancedLeakAwareByteBuf.readByte(AdvancedLeakAwareByteBuf.java:401)</span><br><span class="line">        com.dianping.cat.message.spi.codec.PlainTextMessageCodec$BufferHelper.read(PlainTextMessageCodec.java:485)</span><br><span class="line">        com.dianping.cat.message.spi.codec.PlainTextMessageCodec.decodeLine(PlainTextMessageCodec.java:184)</span><br><span class="line">        // ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)</span><br><span class="line">        io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)</span><br><span class="line">        io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">        io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">        java.lang.Thread.run(Thread.java:745)</span><br><span class="line">#2:</span><br><span class="line">        io.netty.buffer.AdvancedLeakAwareByteBuf.readByte(AdvancedLeakAwareByteBuf.java:401)</span><br><span class="line">        // ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">Created at:</span><br><span class="line">        io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:402)</span><br><span class="line">        io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:188)</span><br><span class="line">        io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:124)</span><br><span class="line">        io.netty.buffer.AbstractByteBuf.readBytes(AbstractByteBuf.java:871)</span><br><span class="line">        com.dianping.cat.analysis.TcpSocketReceiver$MessageDecoder.decode(TcpSocketReceiver.java:155)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:507)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:446)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276)</span><br><span class="line">		// ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)</span><br><span class="line">        io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)</span><br><span class="line">        io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">        io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">        java.lang.Thread.run(Thread.java:745)</span><br><span class="line">: 3 leak records were discarded because they were duplicates</span><br><span class="line">: 337 leak records were discarded because the leak record count is targeted to 4. Use system property io.netty.leakDetection.targetRecords to increase the limit.</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E9B;&#x5806;&#x6808;&#x9664;&#x4E86;&#x6700;&#x8FD1;&#x7684;&#x8BBF;&#x95EE;&#x8BB0;&#x5F55;&#xFF0C;&#x8FD8;&#x6709;&#x5728;&#x54EA;&#x91CC;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;&#x8FD9;&#x4E0B;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;&#xFF1A;</p>
<p>1&#x3001;&#x8FD9;&#x4E9B;Buffer&#x662F;&#x7528;&#x6237;Java&#x5E94;&#x7528;&#x4E0A;&#x62A5;&#x7684;&#x57CB;&#x70B9;&#x6D88;&#x606F;&#x3002;</p>
<p>2&#x3001;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;Buffer&#x662F;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;Buffer&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E0B;&#x6211;&#x4EEC;&#x7684;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x5904;&#x7406;&#x7528;&#x6237;&#x57CB;&#x70B9;&#x7684;&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/cf76f0c2cc3bf24e85e5fcf498d05371f1d3665914d615de71aa78d401dc1b9b" alt="image.png"></p>
<p>Netty&#x8BB0;&#x5F55;&#x7684;&#x201C;&#x6CC4;&#x6F0F;&#x8BB0;&#x5F55;&#x201D;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7;ByteBuf&#x7684;read/write&#x7B49;&#x64CD;&#x4F5C;&#x8BB0;&#x5F55;&#x7684;, &#x6BD4;&#x5982;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public ByteBuf readBytes(ByteBuf dst, int dstIndex, int length) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak); // &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x5806;&#x6808;</span><br><span class="line">    return super.readBytes(dst, dstIndex, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(byte[] dst) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(byte[] dst, int dstIndex, int length) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst, dstIndex, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(ByteBuffer dst) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4F46;&#x662F;&#x6839;&#x636E;&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x8FF0;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x89E3;&#x6790;ByteBuf&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x4F1A;&#x9001;&#x5230;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#xFF0C;&#x4F46;&#x662F;Netty&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x8FD8;&#x662F;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF01;&#x6240;&#x4EE5;&#x6CC4;&#x6F0F;<strong>&#x4E00;&#x5B9A;&#x53D1;&#x751F;&#x5728;&#x5B58;&#x50A8;&#x4E4B;&#x524D;&#xFF0C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x4E4B;&#x540E;</strong>&#xFF01;&#xFF08;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x53D1;&#x751F;&#x4E86;&#x67D0;&#x4E9B;&#x5F02;&#x5E38;&#x6CA1;&#x6709;<em>catch</em>&#x5BFC;&#x81F4;<em>ByteBuf</em>&#x6CA1;&#x6709;&#x88AB;&#x91CA;&#x653E;&#xFF09;.</p>
<p>&#x597D;&#xFF0C;&#x7F29;&#x5C0F;&#x8303;&#x56F4;&#x4E4B;&#x540E;&#x8BE5;&#x600E;&#x4E48;&#x786E;&#x5B9A;&#x7CBE;&#x786E;&#x4F4D;&#x7F6E;&#x8FDB;&#x884C;&#x6392;&#x67E5;&#x5462;&#xFF1F;</p>
<h2 id="1-3-&#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf-touch"><a href="#1-3-&#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf-touch" class="headerlink" title="1.3 &#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf.touch()"></a>1.3 &#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf.touch()</h2><p>&#x8FD9;&#x5C31;&#x6709;&#x8BF7;ByteBuf&#x63D0;&#x4F9B;&#x7684;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;<code>touch()</code>&#x4E86;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public abstract ByteBuf touch();</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>touch</code>&#x4E2D;Netty&#x4E5F;&#x4F1A;&#x548C;read/write&#x4E00;&#x6837;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x7684;&#x5806;&#x6808;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5728;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x6CC4;&#x6F0F;&#x7684;&#x5730;&#x65B9;&#x52A0;&#x5165;<code>touch</code>&#x5C31;&#x80FD;&#x5728;Netty&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x4E2D;&#x770B;&#x5230;&#x8FD9;&#x4E2A;ByteBuf&#x6700;&#x540E;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x5F15;&#x7528;&#x7684;, &#x5C31;&#x80FD;&#x89E3;&#x51B3;&#x4E86;&#xFF01;&#x95EE;&#x9898;&#x89E3;&#x51B3;&#x4E86;&#x5417;&#xFF1F; &#x5982;&#x89E3;&#xFF01;</p>
<p>&#x5B9E;&#x9645;&#x5206;&#x6790;&#x4EE3;&#x7801;&#x8DEF;&#x5F84;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5F88;&#x53EF;&#x7591;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF08;&#x65B9;&#x6CD5;&#x540D;&#x5C31;&#x53EB;<em>method</em>&#x5427;&#xFF09;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x52A0;&#x5165;&#x591A;&#x4E2A;<code>touch</code>&#xFF0C;&#x4F46;&#x8FD9;&#x6837;&#x5C31;&#x51FA;&#x73B0;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6700;&#x7EC8;&#x5728;Netty&#x65E5;&#x5FD7;&#x91CC;&#x663E;&#x793A;&#x7684;&#x5806;&#x6808;&#x9876;&#x5C42;&#x90FD;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x77E5;&#x9053;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x54EA;&#x4E00;&#x4E2A;<code>touch</code>&#x8F93;&#x51FA;&#x7684;&#xFF0C;&#x8BE5;&#x600E;&#x4E48;&#x533A;&#x5206;&#x5462;&#xFF1F;</p>
<p>&#x53D1;&#x73B0;<em>Netty</em>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5E26;&#x53C2;&#x6570;&#x7684;<em>API</em>&#xFF0C;&#x8FD9;&#x4E2A;<em>API</em>&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public abstract ByteBuf touch(Object hint);</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x67E5;&#x9605;&#x6587;&#x6863;&#x548C;&#x6E90;&#x7801;&#xFF1A;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x80FD;&#x5728;Netty&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A;<code>hint.toString()</code>&#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x8C03;&#x7528;<code>buffer.touch(-5)</code>, &#x90A3;&#x4E48;Netty&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/98904bcae8a8f5de1e121d4907b671655c3bd0efe99941714c14f1258ad64575" alt="image.png"></p>
<p>&#x6211;&#x4EEC;&#x5728;method&#x65B9;&#x6CD5;&#x91CC;&#x7684;&#x5173;&#x952E;&#x5730;&#x65B9;&#x90FD;&#x52A0;&#x4E0A;<code>touch</code>&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x5730;&#x65B9;&#x7684;<code>hint</code>&#x90FD;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6700;&#x540E;&#x7EC8;&#x4E8E;&#x5B9A;&#x4F4D;&#x5230;&#x4E86;&#x539F;&#x56E0;&#xFF01;</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x539F;&#x56E0;&#x7684;&#x5927;&#x81F4;&#x63CF;&#x8FF0;&#xFF1A;</p>
<blockquote>
<p>&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6BCF;&#x4E2A;&#x5C0F;&#x65F6;&#x4F1A;&#x505C;&#x6B62;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#xFF08;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;&#x72B6;&#x6001;&#x4E3A;disable&#xFF09;&#x548C;&#x961F;&#x5217;&#xFF0C;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x548C;&#x961F;&#x5217;&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5728;&#x653E;&#x5165;&#x961F;&#x5217;&#x65F6;<strong>&#x6CA1;&#x6709;&#x5224;&#x65AD;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x7EBF;&#x7A0B;&#x72B6;&#x6001;</strong>&#xFF0C;&#x6BCF;&#x4E2A;&#x5C0F;&#x65F6;&#x521D;&#x653E;&#x5165;&#x961F;&#x5217;&#x7684;ByteBuf&#x6CA1;&#x6709;&#x88AB;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#xFF0C;&#x6700;&#x540E;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF01;</p>
</blockquote>
<p>&#x8FD9;&#x6B21;&#x7ED9;&#x4E86;&#x6211;&#x4EEC;&#x4E00;&#x4E2A;&#x4E0D;&#x5C0F;&#x7684;&#x6559;&#x8BAD;, &#x90A3;&#x4E48;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x4E0B;&#x6B21;&#x518D;&#x51FA;&#x73B0;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;, &#x6211;&#x540E;&#x9762;&#x7ED9;&#x51FA;&#x4E86;&#x4E00;&#x4E9B;&#x5EFA;&#x8BAE;&#x548C;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/e63c8d333cca6c938782a21c1da6637e91bca9391b3f88fdd47418d91ba1d460" alt="image.png"></p>
<h1 id="&#x4E8C;-&#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;"><a href="#&#x4E8C;-&#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;" class="headerlink" title="&#x4E8C;. &#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;"></a>&#x4E8C;. &#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;</h1><p>&#x8FD9;&#x4E00;&#x8282;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x8BB2;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x6B63;&#x786E;&#x7684;&#x7F16;&#x7801;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;, &#x4F46;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x8981;&#x5F04;&#x6E05;&#x695A;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;, &#x4E86;&#x89E3;&#x5B83;&#x7684;&#x5E95;&#x5C42;&#x539F;&#x7406;, &#x7136;&#x540E;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x5DE5;&#x7A0B;&#x4E2D;&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x6765;&#x964D;&#x4F4E;&#x6CC4;&#x6F0F;&#x7684;&#x53EF;&#x80FD;&#x6027;.</p>
<h2 id="2-1-Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;"><a href="#2-1-Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;" class="headerlink" title="2.1 Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;"></a>2.1 Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;</h2><p>Netty&#x521B;&#x5EFA;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x57FA;&#x4E8E;JDK&#x539F;&#x751F;&#x7684;<code>DirectByteBuffer</code>&#x5B9E;&#x73B0;&#xFF0C;&#x5728;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>&#x65F6;&#x80FD;&#x591F;&#x6307;&#x5B9A;&#x662F;&#x5426;&#x4F7F;&#x7528;&#x5E26;<code>Cleaner</code>&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x6307;&#x5B9A;<code>Cleaner</code>&#x7684;&#x8BDD;&#x80FD;&#x5728;&#x81EA;&#x8EAB;&#x88AB;&#x56DE;&#x6536;&#x65F6;&#x91CA;&#x653E;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x5728;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#x901A;&#x8FC7;&#x521B;&#x5EFA;<code>Cleaner</code>&#x5BF9;&#x8C61;&#x2014;&#x2014;&#x4E00;&#x4E2A;&#x865A;&#x5F15;&#x7528;&#x5BF9;&#x8C61;<code>PhantomReference</code>&#xFF0C;&#x5728;<code>DirectByteBuffer</code>&#x88AB;GC&#x65F6;&#xFF0C;<code>ReferenceHandler</code>&#x7EBF;&#x7A0B;&#x4F1A;&#x5BF9;<code>jdk.internal.ref.Cleaner</code>&#x5BF9;&#x8C61;&#x4E13;&#x95E8;&#x5904;&#x7406;&#xFF0C;&#x8C03;&#x7528;&#x5B83;&#x7684;clean&#x65B9;&#x6CD5;&#x91CA;&#x653E;&#x5185;&#x5B58;&#x3002;</p>
<p>&#x4F46;&#x662F;Netty&#x521B;&#x5EFA;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x7684;&#x662F;<code>noCleaner</code>&#x7B56;&#x7565;&#xFF0C;&#x5373;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x4E0D;&#x542B;<code>Cleaner</code>&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x662F;&#xFF1A;</p>
<ul>
<li>&#x8981;&#x89E6;&#x53D1;Cleaner&#x7684;&#x89E6;&#x53D1;&#x5FC5;&#x987B;&#x8981;&#x7B49;Buffer&#x88AB;GC,&#x8FD9;&#x4E2A;&#x662F;&#x4E0D;&#x53EF;&#x63A7;&#x7684;.</li>
<li>&#x5728;&#x4F7F;&#x7528;Cleaner&#x7684;&#x6784;&#x9020;&#x5668;&#x91CC;,&#x5982;&#x679C;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;,&#x4F1A;&#x8C03;&#x7528;<code>System.gc()</code>&#x65B9;&#x6CD5;&#x4E3B;&#x52A8;&#x89E6;&#x53D1;GC,&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4F1A;&#x9020;&#x6210;&#x6027;&#x80FD;&#x95EE;&#x9898;.</li>
</ul>
<p>&#x56E0;&#x6B64;&#x5728;&#x5927;&#x90E8;&#x5206;&#x60C5;&#x51B5;&#x4E0B;(&#x81F3;&#x5C11;&#x5728;OpenJDK&#x91CC;)Netty&#x4F1A;&#x4F7F;&#x7528;noCleaner&#x7B56;&#x7565;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>, &#x6240;&#x4EE5;Netty&#x56DE;&#x6536;Buffer&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x901A;&#x8FC7;&#x4E3B;&#x52A8;release&#x91CA;&#x653E;&#x7684;, &#x800C;<strong>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6B63;&#x786E;release&#x5C31;&#x4F1A;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;</strong>. &#x4F46;&#x5E76;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;release&#x90FD;&#x4F1A;&#x771F;&#x6B63;&#x91CA;&#x653E;, &#x5177;&#x4F53;&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;&#x548C;&#x5F15;&#x7528;&#x5B83;&#x7684;&#x8BA1;&#x6570;&#x6709;&#x5173;, &#x56E0;&#x4E3A;<strong>Netty&#x662F;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x7BA1;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;</strong>, &#x800C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x63A2;&#x8BA8;&#x5F15;&#x7528;&#x8BA1;&#x6570;.</p>
<h2 id="2-2-ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;"><a href="#2-2-ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;" class="headerlink" title="2.2 ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;"></a>2.2 ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;</h2><p>Netty&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x7BA1;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4F7F;&#x7528;&#x5B8C;&#x6210;&#x4E86;&#x4E4B;&#x540E;&#x8981;&#x628A;&#x5B83;&#x5F52;&#x8FD8;&#x7ED9;&#x6C60;&#x5B50;&#xFF08;&#x6216;&#x8005;allocator&#xFF09;&#x3002;ByteBuf&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6700;&#x597D;&#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<p>&#x521D;&#x59CB;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1&#xFF0C;&#x5F53;&#x8C03;&#x7528;<code>release</code>&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8BA1;&#x6570;&#x51CF;&#x4E00;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x521D;&#x59CB;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1</span><br><span class="line">ByteBuf buf = ctx.alloc().directBuffer();</span><br><span class="line">assert buf.refCnt() == 1;</span><br><span class="line"></span><br><span class="line">// &#x5F53;&#x8C03;&#x7528;release&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8BA1;&#x6570;&#x51CF;&#x4E00;</span><br><span class="line">boolean destroyed = buf.release();</span><br><span class="line">assert destroyed;</span><br><span class="line">assert buf.refCnt() == 0;</span><br></pre></td></tr></table></figure>

<p><strong>&#x5F53;&#x8BA1;&#x6570;&#x5230;0&#x65F6;&#xFF0C;<code>release</code>&#x65B9;&#x6CD5;&#x4F1A;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4F1A;&#x88AB;&#x91CA;&#x653E;</strong>&#x3002;</p>
<p>&#x5982;&#x679C;&#x5C1D;&#x8BD5;&#x8BFB;&#x53D6;&#x8BA1;&#x6570;&#x4E3A;0&#x7684;&#x5BF9;&#x8C61;, &#x4F1A;&#x62A5;&#x51FA;<code>IllegalReferenceCountExeception</code> &#x5F02;&#x5E38;, &#x5FC5;&#x987B;&#x6CE8;&#x610F;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;assert buf.refCnt() == 0;</span><br><span class="line">try {</span><br><span class="line">  buf.writeLong(0xdeadbeef);</span><br><span class="line">  throw new Error(&quot;should not reach here&quot;);</span><br><span class="line">} catch (IllegalReferenceCountExeception e) {</span><br><span class="line">  // Expected</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E5F;&#x80FD;&#x901A;&#x8FC7;<code>retain</code>&#x589E;&#x52A0;&#x8BA1;&#x6570;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;ByteBuf buf = ctx.alloc().directBuffer();</span><br><span class="line">assert buf.refCnt() == 1;</span><br><span class="line"></span><br><span class="line">buf.retain();</span><br><span class="line">assert buf.refCnt() == 2;</span><br><span class="line"></span><br><span class="line">boolean destroyed = buf.release();</span><br><span class="line">assert !destroyed;</span><br><span class="line">assert buf.refCnt() == 1;</span><br></pre></td></tr></table></figure>

<p>&#x770B;&#x8D77;&#x6765;&#x5F88;&#x7B80;&#x5355;, &#x4F46;&#x662F;&#x4E00;&#x65E6;<code>ByteBuf</code> &#x5728;<strong>&#x7EBF;&#x7A0B;&#x95F4;&#x4F20;&#x9012;</strong>&#x65F6;&#x5C31;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x4E86;, &#x56E0;&#x4E3A;&#x65E0;&#x6CD5;&#x5F88;&#x597D;&#x786E;&#x5B9A;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x91CA;&#x653E;, &#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x7ED9;&#x51FA;&#x4E00;&#x4E9B;&#x53EF;&#x4EE5;&#x9075;&#x5FAA;&#x7684;&#x89C4;&#x8303;, &#x80FD;&#x5728;&#x6700;&#x5927;&#x7A0B;&#x5EA6;&#x4E0A;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;.</p>
<h2 id="2-3-&#x6700;&#x4F73;&#x5B9E;&#x8DF5;-&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;"><a href="#2-3-&#x6700;&#x4F73;&#x5B9E;&#x8DF5;-&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;" class="headerlink" title="2.3 &#x6700;&#x4F73;&#x5B9E;&#x8DF5;: &#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;"></a>2.3 &#x6700;&#x4F73;&#x5B9E;&#x8DF5;: &#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;</h2><p>&#x4E86;&#x89E3;&#x4E86;Netty&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x673A;&#x5236;&#x540E;, &#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x7ED9;&#x51FA;&#x4E00;&#x4E9B;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;, &#x5728;&#x5DE5;&#x7A0B;&#x4E2D;&#x5408;&#x7406;&#x8FD0;&#x7528;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x53D1;&#x751F;:</p>
<ul>
<li>&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;(&#x201C;&#x7EC4;&#x4EF6;&#x201D;&#x53EF;&#x4EE5;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6216;&#x7EBF;&#x7A0B;)A&#x4F20;&#x9012;&#x7ED9;&#x7EC4;&#x4EF6;B&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5BF9;&#x8C61;, &#x901A;&#x5E38;&#x7EC4;&#x4EF6;A&#x4E0D;&#x9700;&#x8981;&#x91CA;&#x653E;, &#x800C;&#x662F;&#x7531;B&#x51B3;&#x5B9A;&#x8981;&#x4E0D;&#x8981;&#x91CA;&#x653E;.</li>
<li>&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#x6D88;&#x8D39;&#x4E86;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5BF9;&#x8C61;&#x800C;&#x4E14;&#x5B83;&#x4E0D;&#x4F1A;&#x518D;&#x4F20;&#x9012;&#x7ED9;&#x5176;&#x4ED6;&#x7EC4;&#x4EF6;&#x90A3;&#x4E48;&#x7531;&#x8FD9;&#x4E2A;&#x7EC4;&#x4EF6;&#x6765;&#x91CA;&#x653E;.</li>
</ul>
<p>&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ByteBuf a(ByteBuf input) {</span><br><span class="line">    input.writeByte(42);</span><br><span class="line">    return input;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public ByteBuf b(ByteBuf input) {</span><br><span class="line">    try {</span><br><span class="line">        output = input.alloc().directBuffer(input.readableBytes() + 1);</span><br><span class="line">        output.writeBytes(input);</span><br><span class="line">        output.writeByte(42);</span><br><span class="line">        return output;</span><br><span class="line">    } finally {</span><br><span class="line">        input.release();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void c(ByteBuf input) {</span><br><span class="line">    System.out.println(input);</span><br><span class="line">    input.release();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void main() {</span><br><span class="line">    ...</span><br><span class="line">    ByteBuf buf = ...;</span><br><span class="line">    // This will print buf to System.out and destroy it.</span><br><span class="line">    c(b(a(buf)));</span><br><span class="line">    assert buf.refCnt() == 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Action</th>
<th>&#x8C01;&#x5E94;&#x8BE5;&#x91CA;&#x653E;?</th>
<th>&#x8C01;&#x771F;&#x6B63;&#x91CA;&#x653E;&#x4E86;?</th>
</tr>
</thead>
<tbody><tr>
<td><code>main()</code> &#x521B;&#x5EFA;&#x4E86; <code>buf</code></td>
<td><code>buf</code>&#x2192;<code>main()</code></td>
<td></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86; <code>a()</code> &#x4F20;&#x5165;&#x4E86; <code>buf</code></td>
<td><code>buf</code>&#x2192;<code>a()</code></td>
<td></td>
</tr>
<tr>
<td><code>a()</code> &#x8FD4;&#x56DE;&#x4E86; <code>buf</code> .</td>
<td><code>buf</code>&#x2192;<code>main()</code></td>
<td></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86;<code>b()</code> &#x4F20;&#x5165;&#x4E86;buf</td>
<td><code>buf</code>&#x2192;<code>b()</code></td>
<td></td>
</tr>
<tr>
<td><code>b()</code> &#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A; <code>buf</code>&#x7684;copy</td>
<td><code>buf</code>&#x2192;<code>b()</code>, <code>copy</code>&#x2192;<code>main()</code></td>
<td><code>b()</code> &#x91CA;&#x653E;&#x4E86;<code>buf</code></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86;<code>c()</code> &#x4F20;&#x5165;&#x4E86;copy</td>
<td><code>copy</code>&#x2192;<code>c()</code></td>
<td></td>
</tr>
<tr>
<td><code>c()</code> &#x5403;&#x6389;&#x4E86; <code>copy</code></td>
<td><code>copy</code>&#x2192;<code>c()</code></td>
<td><code>c()</code> &#x91CA;&#x653E;&#x4E86;<code>copy</code></td>
</tr>
</tbody></table>
<p>&#x53C2;&#x8003;: <a href="/external_links/bc956cde3c9b8e0296fbee94923840da.html" target="blank" rel="noopener">netty.io/wiki/refere&#x2026;</a></p>
<hr>
<h1 id="&#x56DB;-Tips"><a href="#&#x56DB;-Tips" class="headerlink" title="&#x56DB;. Tips"></a>&#x56DB;. Tips</h1><p>1&#x3001;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x201C;<code>map -histo:live pid</code>&#x201D;&#x624B;&#x52A8;&#x89E6;&#x53D1;FullGC&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x66F4;&#x5FEB;&#x6253;&#x5370;&#x51FA;&#x6765;&#x5426;&#x5219;&#x8981;&#x7B49;&#x5230;&#x5BF9;&#x5E94;region&#x56DE;&#x6536;&#x7684;&#x65F6;&#x5019;&#x624D;&#x80FD;&#x611F;&#x77E5;&#x5230;&#x3002;&#xFF08;Netty&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x662F;&#x7528;WeakReference&#x7684;&#x539F;&#x7406;&#x89E6;&#x53D1;&#x7684;&#xFF09;</p>
<p>2&#x3001;<code>simple</code>&#x548C;<code>advanced</code>&#x7EA7;&#x522B;&#x4E0B;&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x90FD;&#x662F;&#x91C7;&#x6837;&#x89E6;&#x53D1;&#x7684;&#xFF0C;&#x91C7;&#x6837;&#x9891;&#x7387;&#x662F;1/128&#xFF0C;&#x4F46;&#x662F;<code>advanced</code>&#x7EA7;&#x522B;&#x7684;&#x6700;&#x8FD1;&#x4E00;&#x6761;&#x662F;&#x4E00;&#x5B9A;&#x8BB0;&#x5F55;&#x7684;&#x3002;</p>
<hr>
<h1 id="&#x4E94;-Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;"><a href="#&#x4E94;-Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;" class="headerlink" title="&#x4E94;. Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;"></a>&#x4E94;. Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;</h1><table>
<thead>
<tr>
<th>&#x53C2;&#x6570;&#x540D;&#x79F0;</th>
<th>&#x542B;&#x4E49;</th>
<th>&#x5907;&#x6CE8;</th>
</tr>
</thead>
<tbody><tr>
<td><code>io.netty.leakDetectionLevel</code> &#x6216; <code>io.netty.leakDetection.level</code></td>
<td>&#x914D;&#x7F6E;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x68C0;&#x6D4B;&#x7EA7;&#x522B;&#x7684;&#x53C2;&#x6570;, &#x9ED8;&#x8BA4;<code>simple</code></td>
<td><code>io.netty.leakDetectionLevel</code>&#x662F;&#x8001;&#x7248;&#x672C;&#x7684;,&#x63A8;&#x8350;&#x7528;<code>io.netty.leakDetection.level</code></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.targetRecords</code></td>
<td>&#x5982;&#x679C;&#x5F53;&#x524D;&#x4FDD;&#x5B58;&#x7684;&#x8C03;&#x7528;&#x8F68;&#x8FF9;&#x8BB0;&#x5F55;&#x6570;Record&#x5927;&#x4E8E;&#x53C2;&#x6570;<code>io.netty.leakDetection.targetRecords</code>&#x914D;&#x7F6E;&#x7684;&#x503C;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x4EE5;&#x4E00;&#x5B9A;&#x7684;&#x6982;&#x7387;&#xFF08;1/2^n&#xFF09;&#x5220;&#x9664;&#x5934;&#x7ED3;&#x70B9;&#x4E4B;&#x540E;&#x518D;&#x52A0;&#x5165;&#x65B0;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x4E0D;&#x5220;&#x9664;&#x5934;&#x7ED3;&#x70B9;&#x76F4;&#x63A5;&#x65B0;&#x589E;&#x65B0;&#x7684;, &#x9ED8;&#x8BA4;4</td>
<td></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.acquireAndReleaseOnly</code></td>
<td>&#x63A7;&#x5236;&#x662F;&#x5426;&#x53EA;&#x662F;&#x5728;&#x8C03;&#x7528;&#x589E;&#x52A0;&#x6216;&#x51CF;&#x5C11;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#x624D;&#x8C03;&#x7528;<code>record</code>&#x65B9;&#x6CD5;&#x8BB0;&#x5F55;&#x8C03;&#x7528;&#x8F68;&#x8FF9;, &#x9ED8;&#x8BA4;<code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.samplingInterval</code></td>
<td>&#x7EA7;&#x522B;<code>simple</code>&#x548C;<code>advanced</code>&#x4E0B;&#x91C7;&#x6837;&#x9891;&#x7387;, &#x9ED8;&#x8BA4;128</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h1 id="&#x516D;-&#x603B;&#x7ED3;"><a href="#&#x516D;-&#x603B;&#x7ED3;" class="headerlink" title="&#x516D;. &#x603B;&#x7ED3;"></a>&#x516D;. &#x603B;&#x7ED3;</h1><p>&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x6DF1;&#x5165;&#x63A2;&#x8BA8;&#x4E86;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#x4EE5;&#x53CA;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x3002;&#x901A;&#x8FC7;&#x4E86;&#x89E3;Netty&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x53D1;&#x751F;&#x5E76;&#x975E;&#x795E;&#x79D8;&#x83AB;&#x6D4B;&#xFF0C;&#x800C;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5408;&#x7406;&#x7684;&#x7BA1;&#x7406;&#x548C;&#x91CA;&#x653E;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x907F;&#x514D;&#x3002;</p>
<p>&#x7136;&#x800C;&#xFF0C;&#x9884;&#x9632;&#x80DC;&#x4E8E;&#x6CBB;&#x7597;&#x3002;&#x5728;&#x6587;&#x7AE0;&#x672B;&#x5C3E;&#xFF0C;&#x6211;&#x4EEC;&#x5F3A;&#x8C03;&#x4E86;&#x4E00;&#x4E9B;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x548C;&#x9884;&#x9632;&#x63AA;&#x65BD;&#xFF0C;&#x5E0C;&#x671B;&#x8BFB;&#x8005;&#x5728;&#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x4E2D;&#x80FD;&#x591F;&#x66F4;&#x52A0;&#x6CE8;&#x91CD;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF0C;&#x907F;&#x514D;&#x6F5C;&#x5728;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x6765;&#x603B;&#x7ED3;&#x4E0B;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x7684;&#x6392;&#x67E5;&#x65B9;&#x6CD5;, &#x5206;&#x4E3A;&#x4E09;&#x6B65;&#xFF1A;</p>
<p>1&#x3001;&#x63D0;&#x5347;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7EA7;&#x522B;&#x4E3A;<code>advanced</code>&#xFF1A;<code>java -Dio.netty.leakDetection.level=advanced ...</code></p>
<p>2&#x3001;&#x5982;&#x679C;&#x8FD8;&#x4E0D;&#x80FD;&#x5B9A;&#x4F4D;&#xFF0C;&#x5728;&#x5173;&#x952E;&#x4F4D;&#x7F6E;&#x52A0;&#x5165;<code>hint</code>&#x7684;&#x8C03;&#x7528;</p>
<p>3&#x3001;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5185;&#x9700;&#x8981;&#x5B9A;&#x4F4D;&#x7684;&#x5730;&#x65B9;&#x6709;&#x591A;&#x4E2A;&#xFF0C;&#x52A0;&#x5165;<code>hint(&#x4EFB;&#x610F;&#x5B57;&#x7B26;&#x4E32;)</code></p>
<hr>
<p>&#x1F525;&#x5982;&#x679C;&#x611F;&#x89C9;&#x535A;&#x4E3B;&#x7684;&#x6587;&#x7AE0;&#x8FD8;&#x4E0D;&#x9519;&#x7684;&#x8BDD;&#xFF0C;&#x8BF7;&#x1F44D;&#x4E09;&#x8FDE;&#x652F;&#x6301;&#x1F44D;&#x4E00;&#x4E0B;&#x535A;&#x4E3B;&#x54E6;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/777653dc016f46713a655175fa2eb7eeb5fc0d7902f8bf5e8965f569e74e88d6" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/b1e333a96ea731ebe438ed1a8d3a5052.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7339827208086896676.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7339827208086896676.html" itemprop="url">【Android 13源码分析】WindowContaine</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-27T11:38:46+08:00">
                2024-02-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5728;&#x5B89;&#x5353;&#x6E90;&#x7801;&#x7684;&#x8BBE;&#x8BA1;&#x4E2D;&#xFF0C;&#x5C06;&#x5C06;&#x5C4F;&#x5E55;&#x5206;&#x4E3A;&#x4E86;37&#x5C42;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x7A97;&#x53E3;&#x5C06;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x5C42;&#x7EA7;&#x4E2D;&#x663E;&#x793A;&#x3002;<br>&#x5BF9;&#x8FD9;&#x4E00;&#x5757;&#x7684;&#x6982;&#x5FF5;&#x4EE5;&#x53CA;&#x76F8;&#x5173;&#x6E90;&#x7801;&#x505A;&#x4E86;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#xFF0C;&#x6574;&#x7406;&#x51FA;&#x4EE5;&#x4E0B;&#x51E0;&#x7BC7;&#x3002;</p>
<p><a href="https://dev.newban.cn/7339827208086896676">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;WindowContainer&#x7A97;&#x53E3;&#x5C42;&#x7EA7;-1-&#x521D;&#x8BC6;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;</a></p>
<p><a href="https://dev.newban.cn/7338808893529423883">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;WindowContainer&#x7A97;&#x53E3;&#x5C42;&#x7EA7;-2-&#x6784;&#x5EFA;&#x6D41;&#x7A0B;</a></p>
<p><a href="https://dev.newban.cn/7338808893529440267">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;WindowContainer&#x7A97;&#x53E3;&#x5C42;&#x7EA7;-3-&#x5B9E;&#x4F8B;&#x5206;&#x6790;</a></p>
<p>&#x5F53;&#x524D;&#x4E3A;&#x7B2C;&#x4E00;&#x7BC7;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x4ECB;&#x7ECD;&#x3002;</p>
<p>&#x6253;&#x5F00;&#x201C;&#x7535;&#x8BDD;&#x5E94;&#x7528;&#x201D;&#xFF0C;&#x7136;&#x540E;&#x6309;&#x97F3;&#x91CF;&#x952E;&#x51FA;&#x73B0;&#x4E00;&#x4E0B;&#x754C;&#x9762;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0bfdf1b1987164b58313dc6a2180ce52f72ff2decf911cee7d6ed3d3179aac10" alt="&#x7535;&#x8BDD;&#x5E94;&#x7528;&#x6309;&#x97F3;&#x91CF;&#x622A;&#x56FE;.png"></p>
<p>&#x63D0;&#x51FA;2&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x97F3;&#x91CF;&#x7A97;&#x53E3;&#x4F1A;&#x6321;&#x4F4F;&#x5E94;&#x7528;&#x7A97;&#x53E3;&#xFF1F;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x7BA1;&#x6253;&#x5F00;&#x54EA;&#x4E2A;&#x5E94;&#x7528;&#x90FD;&#x80FD;&#x770B;&#x5230;&#x5BFC;&#x822A;&#x680F;&#x548C;&#x72B6;&#x6001;&#x680F;&#xFF1F;</li>
</ol>
<p>&#x518D;&#x770B;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x56FE;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/6a43758d3f1edcfff62e4e99143ffbfa9d4a492b6fdee20cc8bb08569e3047c2" alt="&#x97F3;&#x91CF;&#x622A;&#x56FE;&#x5C4F;&#x5E55;&#x5206;&#x7EA7;.png"></p>
<p>&#x5DE6;&#x8FB9;&#x662F;&#x5C06;&#x7B2C;&#x4E00;&#x5F20;&#x622A;&#x56FE;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#x63D0;&#x51FA;&#x6765;&#x753B;&#x4E86;&#x7684;&#x6A21;&#x62DF;&#x56FE;&#xFF0C; &#x60F3;&#x8C61;&#x4E00;&#x4E0B;&#x6BCF;&#x4E2A;&#x7A97;&#x53E3;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x5168;&#x5C4F;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x7684;&#x524D;&#x540E;&#x987A;&#x5E8F;&#x82E5;&#x53F3;&#x56FE;&#xFF08;&#x6CE8;&#x610F;&#x989C;&#x8272;&#x662F;&#x5BF9;&#x5E94;&#x7684;&#xFF09;&#x3002; &#x5982;&#x679C;&#x8BF4;&#x662F;&#x6309;&#x53F3;&#x8FB9;&#x7684;&#x8FD9;&#x79CD;&#x5C42;&#x7EA7;&#x6392;&#x5E8F;&#xFF0C;&#x90A3;&#x4E48;&#x97F3;&#x91CF;&#x952E;&#x7684;&#x7A97;&#x53E3;&#x548C;&#x72B6;&#x6001;&#x680F;&#x7684;&#x7A97;&#x53E3;&#x5C31;&#x4F1A;&#x6321;&#x4F4F;Activity&#x7684;&#x7A97;&#x53E3;&#x3002;</p>
<p>&#x5728;&#x5B89;&#x5353;&#x4E2D;&#x7A97;&#x53E3;&#x662F;&#x6709;&#x5148;&#x540E;&#x987A;&#x5E8F;&#x7684;&#xFF0C;&#x8D8A;&#x9760;&#x8FD1;&#x7528;&#x6237;&#x7684;&#x5C31;&#x8D8A;&#x9760;&#x524D;&#xFF0C;&#x5C31;&#x80FD;&#x6321;&#x4F4F;&#x5E95;&#x4E0B;&#x7684;&#x7A97;&#x53E3;&#x3002; &#x76EE;&#x524D;&#x8BF4;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x7ED3;&#x8BBA;&#x53EF;&#x80FD;&#x4E3A;&#x65F6;&#x8FC7;&#x65E9;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x5C06;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;</p>
<ol>
<li><h1 id="&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x4ECB;&#x7ECD;"><a href="#&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x4ECB;&#x7ECD;" class="headerlink" title="&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x4ECB;&#x7ECD;"></a>&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x4ECB;&#x7ECD;</h1></li>
</ol>
<h2 id="1-1-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;"><a href="#1-1-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;" class="headerlink" title="1.1 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;"></a>1.1 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;</h2><h3 id="1-1-1-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;&#x6E38;&#x620F;3D&#x4E16;&#x754C;"><a href="#1-1-1-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;&#x6E38;&#x620F;3D&#x4E16;&#x754C;" class="headerlink" title="1.1.1 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;&#x6E38;&#x620F;3D&#x4E16;&#x754C;"></a>1.1.1 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;&#x6E38;&#x620F;3D&#x4E16;&#x754C;</h3><p>&#x4E0B;&#x9762;2&#x4E2A;&#x56FE;&#x6765;&#x81EA;Unity3d&#x5B98;&#x7F51;&#x5F00;&#x53D1;&#x6587;&#x6863;:<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/684d0b6d91c3af9505bbf3daa36f0404ecec21f56df189ded8ef965076960efc" alt="unity&#x6444;&#x50CF;&#x5934;-1.png"><br>&#x6211;&#x4EEC;&#x73A9;&#x7684;&#x738B;&#x8005;&#x8363;&#x8000;&#xFF0C;&#x539F;&#x795E;&#x7B49;&#x6E38;&#x620F;&#x7684;&#x5F00;&#x53D1;&#xFF0C;&#x90FD;&#x662F;&#x7C7B;&#x4F3C;&#x5728;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;3D&#x573A;&#x666F;&#x4E0B;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x5F00;&#x53D1;&#x8005;&#x5C06;&#x4F7F;&#x7528;3D&#x5EFA;&#x6A21;&#x5DE5;&#x5177;&#x6765;&#x521B;&#x5EFA;&#x5730;&#x5F62;&#x3001;&#x5EFA;&#x7B51;&#x3001;&#x690D;&#x88AB;&#x7B49;&#x5730;&#x56FE;&#x5143;&#x7D20;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;&#x6750;&#x8D28;&#x548C;&#x8D34;&#x56FE;&#x6765;&#x589E;&#x5F3A;&#x5730;&#x56FE;&#x7684;&#x89C6;&#x89C9;&#x6548;&#x679C;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#x8FD9;&#x5F20;&#x56FE;&#x7247;&#x91CC;&#x653E;&#x4E86;3&#x4E2A;&#x989C;&#x8272;&#x7684;&#x67F1;&#x5B50;&#x3002; &#x9664;&#x4E86;&#x8FD9;&#x4E9B;&#x7269;&#x4F53;&#x5916;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x6444;&#x50CF;&#x673A;&#xFF08;Camera&#xFF09;&#xFF0C;&#x5B83;&#x662F;&#x7528;&#x6765;&#x6355;&#x6349;&#x753B;&#x9762;&#x7684;&#xFF0C; &#x6BD5;&#x7ADF;&#x624B;&#x673A;&#x5C4F;&#x5E55;&#x662F;2D&#x7684;&#xFF0C;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x8FD9;&#x4E2A;&#x6444;&#x50CF;&#x673A;&#x80FD;&#x6355;&#x6349;&#x5230;&#x7684;&#x753B;&#x9762;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x624B;&#x673A;&#x5C4F;&#x5E55;&#x4E0A;&#x663E;&#x793A;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x5F20;&#x56FE;&#x7247;&#x6355;&#x6349;&#x5230;&#x7684;&#x753B;&#x9762;&#x662F;&#x53F3;&#x4E0B;&#x89D2;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p>&#x50CF;&#x6211;&#x4EEC;&#x73A9;&#x6E38;&#x620F;&#x79FB;&#x52A8;&#x89D2;&#x8272;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x8F6C;&#x52A8;&#x8FD9;&#x4E2A;&#x6444;&#x50CF;&#x673A;&#xFF08;Camera&#xFF09;&#x6765;&#x5B8C;&#x6210;&#x7684;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x8FD9;&#x79CD;&#x56FE;&#x4F1A;&#x66F4;&#x52A0;&#x50CF;&#x4E00;&#x4E2A;&#x6E38;&#x620F;&#x7684;&#x753B;&#x9762;&#x4E00;&#x4E9B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1b45aaaee5276f1c7eceaeb3c31f16754347479755fca7363791f1aab241ea15" alt="unity&#x6444;&#x50CF;&#x5934;-2.png"></p>
<p>&#x901A;&#x8FC7;&#x770B;&#x6E38;&#x620F;&#x5730;&#x56FE;&#x7684;3D&#x5F00;&#x53D1;&#x573A;&#x666F;&#xFF0C;&#x5C31;&#x662F;&#x5E0C;&#x671B;&#x80FD;&#x72D7;&#x66F4;&#x52A0;&#x751F;&#x52A8;&#x7684;&#x7406;&#x89E3;&#x5230;&#x5728;2D&#x7684;&#x624B;&#x673A;&#x5C4F;&#x5E55;&#x4E0B;&#xFF0C;&#x5176;&#x5B9E;&#x6709;&#x4E00;&#x4E2A;3D&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x7684;&#x5B89;&#x5353;&#x5F00;&#x53D1;&#x4E0D;&#x4F1A;&#x50CF;&#x6E38;&#x620F;&#x5F00;&#x53D1;&#x90A3;&#x4E48;&#x590D;&#x6742;&#xFF0C;&#x4F46;&#x662F;&#x539F;&#x7406;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h3 id="1-1-2-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;Android&#x7684;&#x4E09;&#x7EF4;&#x5750;&#x6807;&#x7CFB;"><a href="#1-1-2-&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;Android&#x7684;&#x4E09;&#x7EF4;&#x5750;&#x6807;&#x7CFB;" class="headerlink" title="1.1.2 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;Android&#x7684;&#x4E09;&#x7EF4;&#x5750;&#x6807;&#x7CFB;"></a>1.1.2 &#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x6982;&#x5FF5;&#x2013;Android&#x7684;&#x4E09;&#x7EF4;&#x5750;&#x6807;&#x7CFB;</h3><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/46f7a8ddac7e6efd382929c1ee53e4253d97b0fa5c615398de931fcb04c400dc" alt="Android&#x4E09;&#x7EF4;&#x5750;&#x6807;&#x7CFB;.png"><br>Android&#x5750;&#x6807;&#x7CFB;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x4E09;&#x7EF4;&#x5750;&#x6807;&#xFF0C;Z&#x8F74;&#x5411;&#x4E0A;&#xFF0C;X&#x8F74;&#x5411;&#x53F3;&#xFF0C;Y&#x8F74;&#x5411;&#x4E0B;&#x3002;</p>
<p>&#x7ECF;&#x5E38;&#x542C;&#x5230;&#x7684; Z-Order &#x4E5F;&#x5C31;&#x662F;&#x6307;&#x7A97;&#x53E3;&#x5728;Z&#x8F74;&#x7684;&#x6392;&#x5E8F;&#xFF0C;&#x79BB;&#x7528;&#x6237;&#x8D8A;&#x8FD1;&#xFF0C;Z&#x503C;&#x8D8A;&#x5927;&#x3002;&#x5E76;&#x4E14;&#x80FD;&#x591F;&#x906E;&#x6321;&#x4F4F;&#x540E;&#x9762;&#x7684;&#x7A97;&#x53E3;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x518D;&#x52A0;&#x6DF1;&#x4E00;&#x4E0B;&#x5B89;&#x5353;&#x7A97;&#x53E3;&#x7684;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#xFF0C;&#x4E0B;&#x9762;&#x770B;&#x4E00;&#x5F20;&#x5E94;&#x7528;&#x5F00;&#x53D1;&#x7684;View&#x5C42;&#x7EA7;&#x7684;3D&#x89C6;&#x89D2;&#x3002;</p>
<p><strong>&#x6CE8;&#x610F;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x7247;&#x662F;View&#xFF0C;&#x4E0D;&#x662F;&#x672C;&#x6B21;&#x8981;&#x8BB2;&#x7684;&#x7A97;&#x53E3;&#xFF0C;&#x53EA;&#x662F;&#x4E3A;&#x4E86;&#x52A0;&#x6DF1;&#x4E00;&#x4E0B;&#x5C42;&#x7EA7;&#x5370;&#x8C61;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/4333d3f8b3420080e77562e8da1d3ac916e68fb515a07bdd52cc76f1b793a1b8" alt="APP37&#x5C42;-2.png"></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5728;&#x5E03;&#x5C40;&#x4E86;&#x5199;&#x4E86;37&#x5C42;&#x7EA6;&#x675F;&#x5E03;&#x5C40;&#xFF0C;&#x5176;&#x5B9E;&#x7B2C;3&#x5C42;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x6309;&#x94AE;&#x3002; &#x53F3;&#x4E0A;&#x89D2;&#x6211;&#x4EEC;&#x624B;&#x673A;&#x5C4F;&#x5E55;&#x4E0A;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x6309;&#x94AE;&#x7684;&#x754C;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x53F3;&#x4E0B;&#x89D2;&#x901A;&#x8FC7;Android Studio&#x81EA;&#x5E26;&#x7684;&#x5DE5;&#x5177;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x6574;&#x4E2A;View&#x6811;&#x662F;&#x6709;&#x5F88;&#x591A;&#x5C42;&#x7684;&#xFF08;&#x4EE3;&#x7801;&#x5199;&#x4E86;37&#x5C42;&#xFF09;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x770B;&#x5230;&#x7684;View&#x5C42;&#x7EA7;&#x5176;&#x5B9E;&#x548C;&#x540E;&#x9762;&#x8981;&#x8BB2;&#x5C31;&#x7A97;&#x53E3;&#x5206;&#x5C42;&#xFF0C;&#x662F;&#x6709;&#x76F8;&#x4F3C;&#x4E4B;&#x5904;&#x7684;&#x3002; &#x5C06;&#x8FD9;&#x91CC;&#x662F;37&#x5C42;&#x60F3;&#x8C61;&#x5C42;&#x5B89;&#x5353;&#x5728;&#x7A97;&#x53E3;&#x7684;&#x5206;&#x5C42;&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;</p>
<h2 id="1-2-ViewTree"><a href="#1-2-ViewTree" class="headerlink" title="1.2 ViewTree"></a>1.2 ViewTree</h2><p>&#x4E3A;&#x4E86;&#x540E;&#x7EED;&#x65B9;&#x4FBF;&#x7406;&#x89E3;&#x7A97;&#x53E3;&#x6811;&#xFF0C; &#x5148;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x5B89;&#x5353;&#x5F00;&#x53D1;&#x90FD;&#x77E5;&#x9053;&#x7684;View&#x6811;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/bc3174df54b9dc0a8fd6bcb36a8989fc46b1ef0262438711719d796a91807469" alt="&#x7EA2;&#x7EFF;&#x5E03;&#x5C40;.png"></p>
<p>XML&#x91CC;&#x5982;&#x56FE;&#x5199;&#x4E0B;2&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x7EA2;&#x7EFF;&#x5E03;&#x5C40;&#xFF0C;&#x663E;&#x793A;&#x7684;UI&#x6548;&#x679C;&#x7EFF;&#x8272;&#x7684;&#x4F1A;&#x6321;&#x4F4F;&#x4E00;&#x90E8;&#x5206;&#x7EA2;&#x8272;&#x7684;&#x3002;&#x4F46;&#x662F;&#x7528;&#x5DE5;&#x5177;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x7EA2;&#x8272;&#x63A7;&#x4EF6;&#x5176;&#x5B9E;&#x4E5F;&#x662F;&#x5B8C;&#x6210;&#x7ED8;&#x5236;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/fa55458a8d4aad5e94e5396d0c18bb839fa1e3239398294a7d5a95366e0acec7" alt="&#x7EA2;&#x7EFF;&#x5E03;&#x5C40;&#x56FE;&#x5C42;.png"></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5728;&#x540C;&#x4E00;&#x5C42;&#x7EA7;&#x4E0B;&#xFF0C;&#x5728;ViewGropu&#x5B69;&#x5B50;View&#x6570;&#x7EC4;&#x8FD9;&#x4E2A;&#x96C6;&#x5408;&#x4E2D;&#xFF0C;&#x4E0B;&#x6807;&#x8D8A;&#x5927;&#x7684;View&#x4F1A;&#x6321;&#x4F4F;&#x540E;&#x9762;&#x7684;View&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x5C42; &#x5C42;&#x7EA7;&#x8D8A;&#x9760;&#x524D;&#xFF0C;&#x5C31;&#x4F1A;&#x5F53;&#x521D;&#x540E;&#x9762;&#x7684;View&#x3002;</p>
<p>&#x7EE7;&#x7EED;&#x589E;&#x52A0;&#x51E0;&#x4E2A;View</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/253796b457ab58c149694d50717b5b61a630c7b36cdcb093c4553b55b836a874" alt="&#x7EA2;&#x7EFF;&#x5E03;&#x5C40;&#x65B0;&#x589E;.png"></p>
<ol>
<li>&#x63A7;&#x4EF6;B&#x4E0B;&#x65B0;&#x589E;&#x63A7;&#x4EF6;D&#xFF0C;D&#x4E0B;&#x9762;&#x653E;&#x4E86;&#x4E00;&#x4E2A;&#x6587;&#x672C;&#x63A7;&#x4EF6;G</li>
<li>&#x63A7;&#x4EF6;C&#x4E0B;&#x9762;&#x65B0;&#x589E;&#x4E86;&#x4E00;&#x4E2A;&#x6587;&#x672C;&#x63A7;&#x4EF6;F</li>
</ol>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9749901732a861f381c9b5c1bd7d8b66350caee2dfdc4357c4e0a91a6bdf53a" alt="&#x65B0;&#x589E;&#x63A7;&#x4EF6;&#x540E;&#x7684;&#x4E09;&#x7EF4;&#x89C6;&#x89D2;.jpg"></p>
<p>&#x5DE6;&#x8FB9;&#x770B;&#x5230;&#x5BF9;View&#x505A;&#x4E86;&#x5C42;&#x7EA7;&#x5904;&#x7406;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;ViewTree&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x753B;&#x6210;&#x6811;&#x56FE;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/913c4d949ec3ed1ee1a505b2cff7759f0a1aac98e76023d5d7f621ff6a9b6fd1" alt="Tree.png"></p>
<p>&#x8FD9;&#x4E2A;&#x5C31;&#x662F;View&#x5C42;&#x7684;View&#x6811;&#xFF0C;&#x80FD;&#x6784;&#x5EFA;&#x51FA;View&#x6811;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x5B9A;&#x4E49;&#x4E86;ViewGroup&#x8FD9;&#x4E2A;&#x7C7B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;# View</span><br><span class="line"></span><br><span class="line">   // &#x7236;&#x5BB9;&#x5668;</span><br><span class="line">   protected ViewParent mParent;</span><br><span class="line">	</span><br><span class="line"># ViewGroup</span><br><span class="line">    // &#x6240;&#x6709;&#x5B50;View</span><br><span class="line">    private View[] mChildren;</span><br><span class="line"></span><br><span class="line">    public void addView(View child, int index) {</span><br><span class="line">        ......</span><br><span class="line">        // &#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x662F;&#x901A;&#x8FC7;addInArray &#x5C06;View&#x6DFB;&#x52A0;&#x5230;&#x6570;&#x7EC4;mChildren&#x4E2D;</span><br><span class="line">        addView(child, index, params);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void removeView(View view) {</span><br><span class="line">        ......// &#x672C;&#x8D28;&#x8FD8;&#x662F;&#x4ECE;mChildren&#x79FB;&#x9664;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1362892eaec0dbc6e04dae46f5f936f0a85ab13230761ebbcb35138af222531a" alt="&#x5B89;&#x5353;&#x5E38;&#x89C1;&#x5E03;&#x5C40;.png"></p>
<p>&#x5E94;&#x7528;&#x5E03;&#x5C40;&#x7528;&#x7684;&#x573A;&#x666F;&#x7684;&#x51E0;&#x4E2A;&#x7C7B;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x5171;&#x540C;&#x7684;&#x7236;&#x7C7B;&#x2013;ViewGroup&#x3002;</p>
<p>ViewGroup&#x7EE7;&#x627F;&#x4E86;View,&#x6240;&#x4EE5;&#x6709;&#x7236;&#x4EB2;&#xFF08;mParent&#xFF09;&#xFF0C;&#x81EA;&#x8EAB;&#x5185;&#x90E8;&#x53C8;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;View&#x6570;&#x7EC4;&#xFF08;mChildren&#xFF09;&#x8868;&#x793A;&#x5B83;&#x7684;&#x5B69;&#x5B50;&#x4EEC;&#x3002; &#x4E0A;&#x6709;&#x7236;&#x4EB2;&#x4E0B;&#x6709;&#x4E00;&#x7FA4;&#x5B69;&#x5B50;&#xFF0C;&#x6240;&#x4EE5;&#x80FD;&#x6784;&#x5EFA;&#x51FA;&#x4E00;&#x4E2A;ViewTree&#x3002;</p>
<p>&#x5982;&#x679C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5B69;&#x5B50;&#xFF0C;&#x90A3;&#x662F;&#x7EBF;&#x6027;&#x7ED3;&#x6784;&#xFF0C;&#x56E0;&#x6B64;&#x5B69;&#x5B50;&#x5FC5;&#x987B;&#x662F;&#x591A;&#x4E2A;&#xFF0C;&#x6240;&#x4EE5;ViewGroup&#x4E5F;&#x662F;&#x4E00;&#x4E2A;View&#x7684;&#x5BB9;&#x5668;&#x7C7B;&#x3002; <strong>&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x5B58;&#x5728;&#xFF0C;&#x5F00;&#x53D1;&#x8005;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5D4C;&#x5957;&#x6765;&#x884C;&#x7A0B;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x590D;&#x6742;&#x7684;ViewTree&#x7ED3;&#x6784;</strong><br>&#x8FD9;&#x4E5F;&#x662F;&#x5E94;&#x7528;&#x5F00;&#x53D1;&#x8005;&#x80FD;&#x5199;&#x51FA;&#x5404;&#x79CD;&#x4E30;&#x5BCC;UI&#x7684;&#x57FA;&#x7840;&#x3002;</p>
<p><strong>&#x5728;&#x7A97;&#x53E3;&#x8FD9;&#x4E00;&#x7EA7;&#x522B;&#x7684;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x4E5F;&#x6709;&#x7A97;&#x53E3;&#x6811;&#xFF0C;&#x4E5F;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x5BB9;&#x5668;&#x7ED3;&#x6784;&#x3002;</strong> &#x540E;&#x9762;&#x4F1A;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#xFF0C;&#x5728;&#x4ECB;&#x7ECD;&#x4E4B;&#x524D;&#x5148;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x4EC0;&#x4E48;&#x662F;&#x7A97;&#x53E3;&#x3002;</p>
<p>ViewTree&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x4E5F;&#x662F;&#x771F;&#x5B9E;&#x5B58;&#x5728;&#x7684;&#xFF0C;&#x5728;Activity&#x4E2D;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#x5BF9;&#x5E94;ViewTree&#x7684;&#x53D8;&#x5316;&#x505A;&#x76D1;&#x542C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;    View.getViewTreeObserver().addOnGlobalLayoutListener(</span><br><span class="line">        ......</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="1-3-&#x4EC0;&#x4E48;&#x662F;&#x7A97;&#x53E3;"><a href="#1-3-&#x4EC0;&#x4E48;&#x662F;&#x7A97;&#x53E3;" class="headerlink" title="1.3 &#x4EC0;&#x4E48;&#x662F;&#x7A97;&#x53E3;"></a>1.3 &#x4EC0;&#x4E48;&#x662F;&#x7A97;&#x53E3;</h2><p>&#x4ECE;&#x89C6;&#x89C9;&#x4E0A;&#xFF0C;&#x7528;&#x6237;&#x5728;&#x624B;&#x673A;&#x5C4F;&#x5E55;&#x4E0A;&#x770B;&#x5230;&#x7684;&#x201C;&#x4E00;&#x5757;&#x533A;&#x57DF;&#x201D;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x6BD4;&#x5982;&#x524D;&#x9762;&#x770B;&#x5230;&#x7684;&#x8FD9;&#x5F20;&#x56FE;&#xFF0C;&#x6BCF;&#x4E00;&#x5757;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9a975f09e999fd59e7c4a194e27d83e5140104002ca8249feab191c8fb5089f" alt="&#x622A;&#x56FE;&#x5BF9;&#x5E94;&#x7A97;&#x53E3;.png"></p>
<p>&#x4ECE;&#x4EE3;&#x7801;&#x4E0A;&#x6765;&#x8BF4;&#xFF0C;&#x5E94;&#x7528;&#x7AEF;&#x7684;&#x7A97;&#x53E3;&#x6307;&#x7684;&#x662F;Window&#xFF0C; framework&#x5C42;&#x7684;&#x7A97;&#x53E3;&#x6307;&#x7684;&#x662F;WindowState</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/75167c702d35c3fc8423356665209a9f46d0b9e2960401371b2f891855f67760" alt="&#x7A97;&#x53E3;&#x4E3E;&#x4F8B;-2.png"></p>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x7528;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x7C7B;&#x6765;&#x8868;&#x793A;&#x201C;&#x7A97;&#x53E3;&#x201D;&#x5462;&#xFF1F;</p>
<p>&#x6BD4;&#x5982;&#x8BF4;&#x6709;&#x4E00;&#x4E2A;&#x4EBA;&#xFF0C;&#x4ED6;&#x662F;&#x552F;&#x4E00;&#x7684;&#xFF0C;&#x8EAB;&#x4EFD;&#x8BC1;&#x53F7;&#x662F;&#x4ED6;&#x7684;&#x552F;&#x4E00;&#x8868;&#x793A;&#xFF0C;&#x4F46;&#x662F;&#x4ED6;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x4FDD;&#x5B58;&#x7684;&#x4ED6;&#x7684;&#x6570;&#x636E;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x6BD4;&#x5982;&#x5728;&#x516C;&#x53F8;&#xFF0C;&#x516C;&#x53F8;&#x7CFB;&#x7EDF;&#x5BF9;&#x8FD9;&#x4E2A;&#x4EBA;&#x4FDD;&#x5B58;&#x7684;&#x4E2A;&#x4EBA;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#xFF0C;&#x5728;&#x4EA4;&#x8B66;&#x7CFB;&#x7EDF;&#xFF0C;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x4EBA;&#x7684;&#x8F66;&#x8F86;&#x4FE1;&#x606F;&#x548C;&#x8FDD;&#x7AE0;&#x4FE1;&#x606F;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/47854e640b833696f8437ee48dbe52c1284da94bf8039ff7dabc013ad6070baa" alt="&#x7A97;&#x53E3;&#x4E3E;&#x4F8B;-1.png"></p>
<p>&#x5728;&#x751F;&#x6D3B;&#x4E2D;&#xFF0C;&#x4E0D;&#x540C;&#x7CFB;&#x7EDF;&#x5BF9;&#x4E00;&#x4E2A;&#x4EBA;&#x5173;&#x6CE8;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;&#x5E94;&#x7528;&#x5F00;&#x53D1;&#x8005;&#x4E3A;&#x4E86;&#x964D;&#x4F4E;&#x6A21;&#x5757;&#x7684;&#x4F9D;&#x8D56;&#xFF0C;&#x4E5F;&#x4F1A;&#x6709;&#x8FD9;&#x79CD;&#x8BBE;&#x8BA1;&#x3002;</p>
<ol start="2">
<li><h1 id="&#x521D;&#x8BC6;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;"><a href="#&#x521D;&#x8BC6;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;" class="headerlink" title="&#x521D;&#x8BC6;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;"></a>&#x521D;&#x8BC6;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;</h1></li>
</ol>
<h1 id="2-1-&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#x4ECB;&#x7ECD;"><a href="#2-1-&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#x4ECB;&#x7ECD;" class="headerlink" title="2.1 &#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#x4ECB;&#x7ECD;"></a>2.1 &#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#x4ECB;&#x7ECD;</h1><p>&#x524D;&#x9762;&#x770B;&#x5230;&#x4E86;&#x4E00;&#x4E9B;View&#x6811;&#x6784;&#x5EFA;&#x7684;&#x7C7B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8BF4;&#x7684;&#x5E38;&#x89C1;&#x5E03;&#x5C40;&#xFF0C;&#x73B0;&#x5728;&#x5217;&#x4E3E;&#x6784;&#x5EFA;&#x7A97;&#x53E3;&#x6811;&#x7528;&#x7684;&#x7684;&#x51E0;&#x4E2A;&#x5BB9;&#x5668;&#x7C7B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/5fb012d51982fdfb98eec31e6e8a107148c9e0b024866c32f117148cee075b57" alt="&#x7C7B;-WindowContainer.png"></p>
<p><strong>WindowContainer&#xFF1A;</strong></p>
<p>&#x7C7B;&#x4F3C;ViewGroup&#x7684;&#x5B58;&#x5728;&#xFF0C;&#x662F;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7684;&#x57FA;&#x7C7B;&#xFF0C;&#x540E;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x5176;&#x4ED6;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x7C7B;&#x90FD;&#x662F;&#x5B83;&#x7684;&#x5B50;&#x7C7B;&#x3002;</p>
<p>&#x6709;&#x6CDB;&#x578B;&#x9650;&#x5236;&#xFF0C;&#x8BF4;&#x660E;&#x5BB9;&#x5668;&#x7684;&#x5185;&#x5BB9;&#x662F;&#x6709;&#x9650;&#x5236;&#x7684;</p>
<p>mParent&#xFF1A; &#x4FDD;&#x5B58;&#x5F53;&#x524D;&#x5BB9;&#x5668;&#x7684;&#x7236;&#x7A97;&#x53E3;&#x5F15;&#x7528;&#x3002;</p>
<p>mChildren &#xFF1A;&#x4FDD;&#x5B58;&#x5F53;&#x524D;&#x7A97;&#x53E3;&#x7684;&#x6240;&#x6709;&#x5B69;&#x5B50;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x96C6;&#x5408;&#xFF08;&#x6709;&#x6CDB;&#x578B;&#xFF09;&#x3002;&#x6839;&#x636E;&#x6CE8;&#x91CA;&#xFF0C;&#x5217;&#x8868;&#x540E;&#x9762;&#x7684;&#x5B50;&#x5BB9;&#x5668;&#xFF0C;z-order &#x8D8A;&#x5927;&#xFF0C;&#x79BB;&#x5C4F;&#x5E55;&#x8D8A;&#x8FD1;&#x3002;</p>
<p>&#x7236;&#x7C7B;&#x4E3A;ConfigurationContainer&#xFF0C;&#x5C01;&#x88C5;&#x4E86;&#x914D;&#x7F6E;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5F53;&#x524D;&#x7C7B;&#x5C01;&#x88C5;&#x4E86;&#x5BB9;&#x5668;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9b16f97860e405122738bf83833ce356255fcf9258e36496fedb4124024a9e3" alt="&#x7C7B;-RootWindowContainer.png"></p>
<p><strong>RootWindowContainer&#xFF1A;</strong></p>
<p>&#x6839;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#xFF0C;&#x4E5F;&#x662F;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;&#x7684;&#x6839;&#x3002;&#x7BA1;&#x7406;DisplayContent</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b69d052943551f9f86e4a947e818b6c83a82dda21304ee266bf920f019189413" alt="&#x7C7B;-DisplayContent.png"></p>
<p><strong>DisplayContent&#xFF1A;</strong></p>
<p>&#x4EE3;&#x8868;&#x4E00;&#x4E2A;&#x5C4F;&#x5E55;&#xFF0C;Android&#x662F;&#x652F;&#x6301;&#x591A;&#x5C4F;&#x5E55;&#x7684;&#x3002;</p>
<p>&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x4E3A;&#xFF1A;<br>DisplayContent-&gt;RootDisplayArea-&gt;DisplayArea.Dimmable-&gt;DisplayArea-&gt;WindowContainer</p>
<p>&#x5B69;&#x5B50;&#x4E3A;DisplayArea&#xFF08;&#x8FD9;&#x4E2A;&#x89C4;&#x5219;&#x5B9A;&#x4E49;&#x5728;DisplayArea&#x7684;&#x5B50;&#x7C7B;Dimmable&#x4E2D;&#xFF09;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9dbda08e336b67374f85a30d81fa8ceecd2b9fdfbe6ed2e12162b6ac494cc426" alt="&#x7C7B;-WindowState.png"></p>
<p><strong>WindowState&#xFF1A;</strong></p>
<p>&#x4EE3;&#x8868;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x672C;&#x8EAB;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;&#xFF0C;&#x6BD4;&#x5982;&#x5B50;&#x7A97;&#x53E3;&#x5C31;&#x662F;&#x5B83;&#x7684;&#x5B69;&#x5B50;&#xFF08;Popupwindow&#x573A;&#x666F;&#xFF09;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/6a036471a584b84ebac4169f91b90dac6acd3f9064e42eccea95d9335bf461ab" alt="&#x7C7B;-DisplayArea.png"></p>
<p><strong>DisplayArea&#xFF1A;</strong><br>&#x6CE8;&#x91CA;&#xFF1A;DisplayContent&#x4E0B;&#x7684;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x96C6;&#x5408;&#x3002;</p>
<p>&#x8BF4;&#x4EBA;&#x8BDD;&#xFF1A;&#x8868;&#x793A;&#x4E00;&#x5757;&#x663E;&#x793A;&#x533A;&#x57DF;&#xFF0C;&#x662F;DisplayContent&#x7684;&#x5B50;&#x5BB9;&#x5668;&#x3002;DisplayContent&#x4E0B;&#x5B89;&#x5353;&#x76EE;&#x524D;&#x8BBE;&#x8BA1;&#x4E3A;&#x5206;&#x4E86;37&#x5C42;&#xFF0C;&#x6BCF;&#x4E00;&#x5C42;&#x90FD;&#x662F;&#x4E00;&#x4E2A;DisplayArea&#x3002;</p>
<p>&#x6709;&#x4E09;&#x4E2A;&#x76F4;&#x63A5;&#x5B50;&#x7C7B;&#xFF0C;TaskDisplayArea&#xFF0C;DisplayArea.Tokens&#x548C;DisplayArea.Tokens&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e83c1a75ded77b7fd74184d636e896cb83b61353dec086dacf3e7a1b832a534e" alt="&#x7C7B;-TaskDisplayArea.png"></p>
<p><strong>TaskDisplayArea&#xFF1A;</strong></p>
<p>&#x6CE8;&#x91CA;&#xFF1A;&#x5B69;&#x5B50;&#x53EF;&#x4EE5;&#x662F;Task&#xFF0C;&#x6216;&#x8005;&#x662F;TaskDisplayArea&#x3002;&#xFF08;&#x4E0D;&#x8FC7;&#x76EE;&#x524D;&#x770B;&#x5230;&#x7684;&#x5B69;&#x5B50;&#x90FD;&#x662F;Task&#x7C7B;&#x578B;&#xFF09;&#x3002;</p>
<p>&#x5BF9;&#x5E94;&#x5C42;&#x7EA7;&#x6811;&#x7684;&#x7B2C;&#x4E8C;&#x5C42;&#xFF0C;&#x4E13;&#x95E8;&#x7528;&#x6765;&#x5B58;&#x653E;&#x5E94;&#x7528;&#x7684;&#x7A97;&#x53E3;&#x56FE;&#x5C42;&#xFF0C;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;APP&#x7684;&#x7A97;&#x53E3;&#x90FD;&#x5728;&#x8FD9;&#x3002;&#x4E5F;&#x662F;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;&#x770B;&#x7684;&#x91CD;&#x70B9;&#x533A;&#x57DF;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/58ee650388936667e6303a3ad31aecdafe7a0a8979f929ea9c57ef71c440c47c" alt="&#x7C7B;-DisplayArea.Token.png"></p>
<p><strong>DisplayArea.Token&#xFF1A;</strong></p>
<p>DisplayArea&#x7684;&#x5B50;&#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x5176;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x8868;&#x793A;WindowToken&#x7684;&#x5BB9;&#x5668;&#x3002;WindowToken&#x7684;&#x5B50;&#x7C7B;&#x662F;WindowState</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c0cf42b1f2b13fd462b4cebd8c1b50b81bad98ce503619a77465e1864aff6d6a" alt="&#x7C7B;-DisplayArea.Dimmable.png"></p>
<p><strong>DisplayArea.Dimmable&#xFF1A;</strong></p>
<p>DisplayArea&#x7684;&#x5B50;&#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x5176;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;DisplayContent&#x7684;&#x7236;&#x7C7B;&#xFF0C;&#x5E26;&#x6A21;&#x7CCA;&#x6548;&#x679C;&#x3002;&#x5B69;&#x5B50;&#x662F;DisplayArea&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ea701248b9534deb2bfd01e8aa4105bd5e36a13051ba5fd3f330b24241f35404" alt="&#x7C7B;-ImeContainer.png"></p>
<p><strong>ImeContainer&#xFF1A;</strong></p>
<p>&#x8F93;&#x5165;&#x6CD5;&#x5BB9;&#x5668;&#xFF0C;&#x7236;&#x7C7B;&#x662F;DisplayArea.Token&#xFF0C;&#x90A3;&#x4E48;&#x5B69;&#x5B50;&#x4E5F;&#x662F;WindowToken&#x3002;&#x8F93;&#x5165;&#x6CD5;&#x4E13;&#x7528;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/19eb83697d4af74c9adfb8d51d0c48306324567694e27887c736f1ca718a7829" alt="&#x7C7B;-Task.png"></p>
<p><strong>Task&#xFF1A;</strong></p>
<p>&#x7236;&#x7C7B;TaskFragment&#x7EE7;&#x627F;WindowContainer&#xFF0C;&#x6CDB;&#x578B;&#x6CA1;&#x6709;&#x9650;&#x5236;&#x5B69;&#x5B50;&#x7684;&#x7C7B;&#x578B;&#x3002;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x4E0B;&#x5B69;&#x5B50;&#x662F;Task&#x548C;ActivityRecord&#x7C7B;&#x578B;&#x3002;</p>
<p>&#x5F00;&#x53D1;&#x8FC7;&#x7A0B;&#x4E2D;&#x7ECF;&#x5E38;&#x89C1;&#x5230;&#x7684;&#x7C7B;&#xFF0C;&#x4E5F;&#x662F;&#x5E94;&#x7528;&#x5F00;&#x53D1;&#xFF0C;&#x591A;&#x7A97;&#x53E3;&#x5F00;&#x53D1;&#x7ECF;&#x5E38;&#x4F1A;&#x9047;&#x5230;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/847900364c6a1e7be51767260c369c97b82447db9ee34ee49febb56a0cd67393" alt="&#x7C7B;-WindowToken.png"></p>
<p><strong>WindowToken&#xFF1A;</strong></p>
<p>&#x7406;&#x5668;&#x4E2D;&#x4E00;&#x7EC4;&#x76F8;&#x5173;&#x7A97;&#x53E3;&#x7684;&#x5BB9;&#x5668;&#xFF0C;&#x662F;&#x7A97;&#x53E3;&#x7684;Token,&#x800C;&#x7A97;&#x53E3;&#x7684;&#x5B9A;&#x4E49;WindowState&#x3002;&#x4E00;&#x822C;&#x5728;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;&#x4E2D;WindowToken&#x4E0B;&#x9762;&#x5C31;&#x4F1A;&#x6302;&#x8F7D;&#x4E00;&#x4E2A;WindowState&#x3002;</p>
<p>&#x58C1;&#x7EB8;&#x7528;&#x5230;&#x7684;WallpaperWindowToken&#x4E5F;&#x662F;&#x5176;&#x5B50;&#x7C7B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/27203f4fd618569d02bd7fb7ebb0b22f945e4f4b7a5b4fb5011f4392692b1af2" alt="&#x7C7B;-ActivityRecord.png"></p>
<p><strong>ActivityRecord&#xFF1A;</strong></p>
<p>&#x5BF9;&#x5E94;&#x7740;&#x4E00;&#x4E2A;Activity&#x3002;</p>
<p>&#x662F;WindowToken&#x7684;&#x5B50;&#x7C7B;&#xFF0C;&#x6240;&#x4EE5;&#x5B69;&#x5B50;&#x4E5F;&#x662F;WindowState&#x3002; &#x4ECE;&#x5E94;&#x7528;&#x5F00;&#x53D1;&#x89D2;&#x5EA6;&#xFF0C;&#x4E00;&#x4E2A;Activity&#x4E0B;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;Window&#x3002;&#x5E76;&#x4E14;&#x4E00;&#x822C;&#x4F5C;&#x4E3A;&#x662F;Task&#x7684;&#x5B69;&#x5B50;&#x3002;</p>
<h2 id="2-2-Feature&#x4ECB;&#x7ECD;"><a href="#2-2-Feature&#x4ECB;&#x7ECD;" class="headerlink" title="2.2 Feature&#x4ECB;&#x7ECD;"></a>2.2 Feature&#x4ECB;&#x7ECD;</h2><p>&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x8FD9;&#x4E2A;Feature(&#x7279;&#x5F81;)&#x5462;&#xFF1F;</p>
<p>AOSP&#x65E2;&#x7136;&#x5C06;&#x5C4F;&#x5E55;&#x5206;&#x4E86;37&#x5C42;&#xFF0C;&#x90A3;&#x8BF4;&#x660E;&#x56FE;&#x5C42;&#x4E4B;&#x95F4;&#x662F;&#x6709;&#x533A;&#x522B;&#x7684;&#xFF0C;&#x6709;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;Feature&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x4E00;&#x5C42;&#x662F;&#x4E0D;&#x662F;&#x652F;&#x6301;&#x5355;&#x624B;&#x64CD;&#x4F5C;&#x3002;<br>&#x8FD9;&#x91CC;&#x5217;&#x4E3E;5&#x4E2A;&#x5E38;&#x89C1;&#x7684;Feature&#xFF0C;&#x5DF2;&#x7ECF;&#x5B83;&#x4EEC;&#x6240;&#x5728;&#x7684;&#x5C42;&#x7EA7;&#x3002;</p>
<p><strong>WindowedMagnification</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&#x62E5;&#x6709;&#x7279;&#x5F81;&#x7684;&#x5C42;&#x7EA7;&#xFF1A; 0-31</span><br><span class="line">&#x7279;&#x5F81;&#x63CF;&#x8FF0;&#xFF1A; &#x652F;&#x6301;&#x7A97;&#x53E3;&#x7F29;&#x653E;&#x7684;&#x4E00;&#x5757;&#x533A;&#x57DF;&#xFF0C;&#x4E00;&#x822C;&#x662F;&#x901A;&#x8FC7;&#x8F85;&#x52A9;&#x670D;&#x52A1;&#x8FDB;&#x884C;&#x7F29;&#x5C0F;&#x6216;&#x653E;&#x5927;</span><br></pre></td></tr></table></figure>

<p><strong>HideDisplayCutout</strong></p>
<p>&#x62E5;&#x6709;&#x7279;&#x5F81;&#x7684;&#x5C42;&#x7EA7;&#xFF1A; 0-14 16 18-23 26-35<br>&#x7279;&#x5F81;&#x63CF;&#x8FF0;&#xFF1A;&#x9690;&#x85CF;&#x526A;&#x5207;&#x533A;&#x57DF;&#xFF0C;&#x5373;&#x5728;&#x9ED8;&#x8BA4;&#x663E;&#x793A;&#x8BBE;&#x5907;&#x4E0A;&#x9690;&#x85CF;&#x4E0D;&#x89C4;&#x5219;&#x5F62;&#x72B6;&#x7684;&#x5C4F;&#x5E55;&#x533A;&#x57DF;&#xFF0C;&#x6BD4;&#x5982;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x540E;&#xFF0C;&#x6709;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x7684;&#x56FE;&#x5C42;&#x5C31;&#x4E0D;&#x4F1A;&#x5EF6;&#x4F38;&#x5230;&#x5218;&#x6D77;&#x5C4F;&#x533A;&#x57DF;&#x3002;</p>
<p><strong>OneHanded</strong></p>
<p>&#x62E5;&#x6709;&#x7279;&#x5F81;&#x7684;&#x5C42;&#x7EA7;&#xFF1A;0-23 26-32 34-35<br>&#x7279;&#x5F81;&#x63CF;&#x8FF0;&#xFF1A;&#x8868;&#x793A;&#x652F;&#x6301;&#x5355;&#x624B;&#x64CD;&#x4F5C;&#x7684;&#x56FE;&#x5C42;&#xFF0C;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x5728;&#x624B;&#x673A;&#x4E0A;&#x8FD8;&#x662F;&#x633A;&#x5E38;&#x89C1;&#x7684;</p>
<p><strong>FullscreenMagnification</strong></p>
<p>&#x62E5;&#x6709;&#x7279;&#x5F81;&#x7684;&#x5C42;&#x7EA7;&#xFF1A;0-12 15-23 26-27 29-31 33-35<br>&#x7279;&#x5F81;&#x63CF;&#x8FF0;&#xFF1A;&#x652F;&#x6301;&#x5168;&#x5C4F;&#x5E55;&#x7F29;&#x653E;&#x7684;&#x56FE;&#x5C42;&#xFF0C;&#x548C;&#x4E0A;&#x9762;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;&#x5168;&#x5C4F;&#x7F29;&#x653E;&#xFF0C;&#x524D;&#x9762;&#x90A3;&#x4E2A;&#x53EF;&#x4EE5;&#x5C40;&#x90E8;</p>
<p><strong>ImePlaceholder</strong></p>
<p>&#x62E5;&#x6709;&#x7279;&#x5F81;&#x7684;&#x5C42;&#x7EA7;&#xFF1A; 13-14<br>&#x7279;&#x5F81;&#x63CF;&#x8FF0;&#xFF1A;&#x8F93;&#x5165;&#x6CD5;&#x76F8;&#x5173;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f61bc505951d3ea0915deacd3627fc160f36ff19f4010d6a7607fd956bcce076" alt="Feature&#x6574;&#x7406;.png"></p>
<h1 id="3-WMS&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;"><a href="#3-WMS&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;" class="headerlink" title="3 WMS&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;"></a>3 WMS&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;</h1><p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x6765;&#x770B;&#x83B7;&#x53D6;&#x5230;&#x8BBE;&#x5907;&#x5F53;&#x524D;&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;adb shell dumpsys activity containers</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x5F00;&#x5B8C;&#x673A;&#x540E;&#x7684;launcher&#x5C31;&#x6267;&#x884C;&#x4E86;dump&#x547D;&#x4EE4;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x80FD;&#x5F97;&#x5230;&#x4E0B;&#x9762;&#x8FD9;&#x4E48;&#x4E00;&#x6BB5;&#x8F93;&#x51FA;&#xFF0C;&#x4E4D;&#x4E00;&#x770B;&#x5F88;&#x5BB9;&#x6613;&#x529D;&#x9000;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x4E9B;&#x4E1C;&#x897F;&#x90FD;&#x662F;&#x6709;&#x89C4;&#x5F8B;&#xFF0C;&#x800C;&#x4E14;&#x5F88;&#x7B80;&#x5355;&#x3002;&#x76EE;&#x524D;&#x53EF;&#x4EE5;&#x5148;&#x4E0D;&#x770B;&#xFF0C;&#x7A0D;&#x540E;&#x518D;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;ACTIVITY MANAGER CONTAINERS (dumpsys activity containers)</span><br><span class="line">ROOT type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">  #0 Display 0 name=&quot;Built-in Screen&quot; type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,1600] bounds=[0,0][720,1600]</span><br><span class="line">   #2 Leaf:36:36 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #1 WindowToken{451b2bd type=2024 android.os.BinderProxy@4526826} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 47e1803 ScreenDecorOverlayBottom type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #0 WindowToken{69b9325 type=2024 android.os.BinderProxy@3a8ab1c} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 799b2ab ScreenDecorOverlay type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">   #1 HideDisplayCutout:32:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #2 OneHanded:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 FullscreenMagnification:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 Leaf:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #1 FullscreenMagnification:33:33 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 Leaf:33:33 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #0 OneHanded:32:32 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 Leaf:32:32 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">   #0 WindowedMagnification:0:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #6 HideDisplayCutout:26:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 OneHanded:26:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #2 FullscreenMagnification:29:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 Leaf:29:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #1 Leaf:28:28 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 FullscreenMagnification:26:27 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 Leaf:26:27 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #5 Leaf:24:25 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #1 WindowToken{922c2bc type=2024 android.os.BinderProxy@d50168e} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 48a6245 pip-dismiss-overlay type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 WindowToken{1a3a19a type=2019 android.os.BinderProxy@1ec36bc} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 50a3d66 NavigationBar0 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #4 HideDisplayCutout:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 OneHanded:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 FullscreenMagnification:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 Leaf:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #3 OneHanded:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 FullscreenMagnification:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 Leaf:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 WindowToken{7472fe2 type=2040 android.os.BinderProxy@1bfb9c4} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 4b26f73 NotificationShade type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #2 HideDisplayCutout:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 OneHanded:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 FullscreenMagnification:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 Leaf:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #1 OneHanded:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 FullscreenMagnification:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 Leaf:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 WindowToken{3da7d5c type=2000 android.os.BinderProxy@e2c682e} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 7619865 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">    #0 HideDisplayCutout:0:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">     #0 OneHanded:0:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #1 ImePlaceholder:13:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 ImeContainer type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 WindowToken{1397896 type=2011 android.os.Binder@23bebb1} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #0 d0c3c51 InputMethod type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">      #0 FullscreenMagnification:0:12 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #2 Leaf:3:12 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 WindowToken{82fa61a type=2038 android.os.BinderProxy@2f86adc} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #0 33a873c ShellDropTarget type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #1 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #2 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #0 Task=7 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">          #0 ActivityRecord{bd2b1d4 u0 com.android.launcher3/.uioverrides.QuickstepLauncher} t7} type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">           #1 ae1df9b com.android.launcher3/com.android.launcher3.uioverrides.QuickstepLauncher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">           #0 b9fa2f0 com.android.launcher3/com.android.launcher3.uioverrides.QuickstepLauncher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #1 Task=2 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 Task=3 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #1 Task=6 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #0 Task=5 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">       #0 Leaf:0:1 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">        #0 WallpaperWindowToken{4b4c99a token=android.os.Binder@9258e45} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">         #0 f3495ce com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br></pre></td></tr></table></figure>

<p>&#x5148;&#x770B;&#x770B;&#x70B9;&#x51FB;&#x684C;&#x9762;&#x7684;&#x201C;&#x7535;&#x8BDD;&#x201C;&#x8FDB;&#x5165;&#x7535;&#x8BDD;&#x754C;&#x9762;&#x540E;&#xFF0C;&#x518D;&#x6267;&#x884C;&#x8FD9;&#x4E2A;dump&#x547D;&#x4EE4;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a2de342a5b0a0c54ac1ae08106717c440903d1609590d1847f3d6375a97a9950" alt="&#x542F;&#x52A8;Activity&#x540E;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x5BF9;&#x6BD4;.png"></p>
<p>tips: com.google.android.dialer &#x8FD9;&#x4E2A;&#x5305;&#x540D;&#x662F;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;<br>&#x8FD9;&#x4E2A;&#x533A;&#x522B;&#x5C31;&#x6BD4;&#x8F83;&#x597D;&#x770B;&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x5728;#1 DefaultTaskDisplayArea&#x4E0B;&#x591A;&#x4E86;&#x4E00;&#x4E9B;&#x4E1C;&#x897F;&#x3002;&#x770B;&#x5230;&#x91CC;&#x9762;&#x4E5F;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x662F;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x4E0E;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x7684;Activity&#x76F8;&#x5173;&#x7684;&#x4E1C;&#x897F;&#x3002;<br>&#x7136;&#x540E;&#x518D;&#x6309;&#x4E00;&#x4E0B;&#x97F3;&#x91CF;&#x952E;&#x76D8;&#xFF0C;&#x770B;&#x4E00;&#x4E0B;&#x533A;&#x522B;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/743831234a33a00fb8aa44af7b15bc263a22bb4f912acf5b7be54c8d3184e4c8" alt="&#x6309;&#x97F3;&#x91CF;&#x6309;&#x94AE;&#x540E;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x5BF9;&#x6BD4;.png"></p>
<p>&#x5728;&#x5176;&#x4ED6;&#x7684;&#x573A;&#x666F;&#x6BD4;&#x5982;&#x6309;power&#x51FA;&#x73B0;&#x7684;&#x5F39;&#x7A97;&#xFF0C; &#x51FA;&#x73B0;toast&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6216;&#x8005;&#x8FDB;&#x5165;&#x5206;&#x5C4F;&#x90FD;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;dump&#xFF0C;&#x5BF9;&#x6BD4;&#x4E00;&#x4E0B;&#x5DEE;&#x5F02;&#x3002;<br>&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x6709;&#x4EE5;&#x4E0B;&#x4FE1;&#x606F;&#xFF1A;</p>
<ol>
<li>&#x5F00;&#x5B8C;&#x673A;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x5C31;&#x5B58;&#x5728;</li>
<li>&#x754C;&#x9762;&#x4E0A;&#x6709;&#x76F8;&#x5173;&#x7684;Window&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x4F1A;&#x5728;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x4E0A;&#x4F53;&#x73B0;</li>
<li>&#x4E0D;&#x540C;&#x7684;window&#x4F1A;&#x88AB;&#x6302;&#x5728;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x8FD9;&#x4E2A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x7684;&#x5173;&#x952E;&#x3002;<br>&#x5F53;&#x7136;&#x54EA;&#x4E2A;Window&#x5E94;&#x8BE5;&#x6302;&#x5728;&#x5230;&#x90A3;&#x4E00;&#x5C42;&#xFF0C;&#x600E;&#x4E48;&#x4E2A;&#x5148;&#x540E;&#x987A;&#x5E8F;&#xFF0C;&#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x65E0;&#x9700;&#x8FC7;&#x4E8E;&#x5728;&#x610F;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;&#x4EA7;&#x54C1;&#x8BBE;&#x8BA1;&#x3002;</li>
</ol>
<p>tips: &#x53EF;&#x4EE5;&#x8BD5;&#x8BD5;&#x4E0D;&#x540C;Activity&#x542F;&#x52A8;&#x6A21;&#x5F0F;&#x540E;&#x7684;&#x533A;&#x522B;</p>
<h2 id="3-1-&#x7B80;&#x5355;&#x5206;&#x6790;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;"><a href="#3-1-&#x7B80;&#x5355;&#x5206;&#x6790;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;" class="headerlink" title="3.1 &#x7B80;&#x5355;&#x5206;&#x6790;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;"></a>3.1 &#x7B80;&#x5355;&#x5206;&#x6790;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;</h2><p>&#x73B0;&#x5728;&#x6765;&#x5206;&#x6790;&#x4E0A;&#x9762;&#x90A3;&#x4E00;&#x56E2;&#x8F93;&#x51FA;&#x4FE1;&#x606F;&#x600E;&#x4E48;&#x770B;&#x3002;&#xFF08;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#xFF0C;&#x4ECE;&#x5DE6;&#x5F80;&#x53F3;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">css&#x590D;&#x5236;&#x4EE3;&#x7801;ROOT type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br><span class="line">  #0 Display 0 name=&quot;Built-in Screen&quot; type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,1600] bounds=[0,0][720,1600]</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684;ROOT &#x8868;&#x793A;&#x6839;&#x8282;&#x70B9;&#xFF0C;&#x6682;&#x65F6;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#x3002;&#x4E0B;&#x9762;&#x7684; #0 Display 0 name=&#x201D;Built-in Screen&#x201D;&#x8868;&#x793A;&#x5F53;&#x524D;&#x7684;&#x624B;&#x673A;&#x7684;&#x7B2C;0&#x4E2A;&#x5C4F;&#x5E55;&#xFF0C;&#x76EE;&#x524D;&#x4E5F;&#x53EF;&#x5FFD;&#x7565;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4E0B;&#x9762;&#x90A3;&#x4E00;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x3002;<br>&#x4E0B;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x867D;&#x7136;&#x5F88;&#x957F;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x4E0D;&#x8981;&#x770B;&#x5168;&#x90E8;&#xFF0C;&#x6293;&#x4F4F;&#x51E0;&#x4E2A;&#x70B9;&#x5C31;&#x591F;&#x4E86;&#xFF0C;&#x4EE5;&#x524D;&#x9762;&#x8FD9;&#x6BB5;&#x4E3A;&#x4F8B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801; #2 Leaf:36:36 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1600]</span><br></pre></td></tr></table></figure>

<p><strong>1. &#x770B;&#x6240;&#x5728;&#x4F4D;&#x7F6E; #X</strong></p>
<p>&#x6BCF;&#x4E00;&#x884C;&#x6700;&#x524D;&#x9762;&#x90FD;&#x662F; &#x201C;#+&#x6570;&#x5B57;&#x201D;&#x7684;&#x5F62;&#x5F0F;&#x6253;&#x5934;&#xFF0C;&#x6BD4;&#x5982;&#x73B0;&#x5728;&#x770B;&#x7684;&#x662F; &#x201C;#2 Leaf:36:36&#x201D;&#x8FD9;&#x91CC;&#x7684;&#x6570;&#x5B57;&#x8868;&#x793A;&#x8FD9;&#x4E2A;&#x56FE;&#x5C42;&#x5728;&#x5F53;&#x524D;&#x7236;&#x5BB9;&#x5668;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4ECE;0&#x5F00;&#x59CB;&#x3002;&#x5176;&#x5B9E;&#x548C;ViewGrop&#x6216;&#x8BB8;childView&#x7684;&#x4E00;&#x6837;&#x7684;&#x3002;<br>&#x5F53;&#x524D;&#x8FD9;&#x4E2A;&#x4E3A;#2 &#x6240;&#x4EE5;&#x4ED6;&#x7684;&#x7236;&#x5BB9;&#x5668;&#x4E00;&#x5171;&#x6709;3&#x4E2A;&#x5B50;&#x5BB9;&#x5668;&#xFF0C;&#x5F53;&#x524D;&#x8FD9;&#x4E2A;&#x5904;&#x4E8E;&#x7B2C;&#x4E09;&#x4E2A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6700;&#x4E0A;&#x9762;&#x3002;&#x90A3;&#x4E48;&#x548C;&#x4ED6;&#x540C;&#x7EA7;&#x7684;&#x53E6;&#x5916;2&#x4E2A;&#x600E;&#x4E48;&#x627E;&#x5462;&#xFF1F;<br>&#x9700;&#x8981;&#x5F80;&#x4E0B;&#x770B;&#xFF0C;&#x627E;&#x5230;&#x548C;&#x5F53;&#x524D; #2 &#x524D;&#x9762;&#x7A7A;&#x683C;&#x4E00;&#x6837;&#x591A;&#x7684;#1 &#x548C;#0 &#x5C31;&#x662F;&#x4ED6;&#x540C;&#x7EA7;&#x7684;2&#x4E2A;&#x5BB9;&#x5668;&#x4E86;&#xFF0C;&#x6309;&#x7167;&#x89C4;&#x5219;&#x80FD;&#x80FD;&#x627E;&#x4E0B;&#x9762;&#x8FD9;2&#x4E2A;&#x4E0E;&#x4ED6;&#x540C;&#x7EA7;&#x7684;&#x3002;<br>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x540C;&#x7EA7;&#x5E76;&#x4E0D;&#x662F;&#x5728;&#x540C;&#x4E00;&#x56FE;&#x5C42;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x5C42;&#x7EA7;&#x6811;&#x8FD9;&#x4E2A;&#x6811;&#x7684;&#x7ED3;&#x6784;&#x662F;&#x540C;&#x7EA7;&#x5173;&#x7CFB;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#1 HideDisplayCutout:32:35</span><br><span class="line">#0 WindowedMagnification:0:31</span><br></pre></td></tr></table></figure>

<p><strong>2. &#x5C42;&#x7EA7;name &#x540D;&#x5B57;+&#x8D77;&#x59CB;&#x5C42;&#x7EA7;&#xFF1A;&#x7ED3;&#x675F;&#x5C42;&#x7EA7;</strong><br>&#x6307;&#x7684;&#x662F; &#x201C;Leaf:36:36&#x201D; &#x8FD9;&#x4E00;&#x6BB5;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x4E2A;&#x7684;&#x683C;&#x5F0F;&#x4E3A;&#x201C;&#x5BB9;&#x5668;&#x540D; &#x8D77;&#x59CB;&#x5C42;&#x7EA7;:&#x7ED3;&#x675F;&#x5C42;&#x7EA7;&#x201D;<br>&#x4F53;&#x73B0;&#x5728;&#x5F53;&#x524D;&#x5C31;&#x662F;&#x8FD9;&#x4E2A; #2 &#x7684;&#x5BB9;&#x5668;&#x53EB; &#x201C;Leaf&#x201D;,&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#xFF0C;&#x4E3B;&#x8981;&#x770B;&#x540E;&#x9762;&#x7684;&#x9891;&#x7E41;&#x51FA;&#x73B0;&#x7684;HideDisplayCutout&#xFF0C;ImePlaceholder&#xFF0C;OneHanded&#x7B49;&#x8FD9;&#x4E9B;&#xFF0C;&#x90FD;&#x6709;&#x5177;&#x4F53;&#x7684;&#x610F;&#x4E49;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x6240;&#x6709;&#x7684;&#x4E1C;&#x897F;&#x5728;&#x6E90;&#x7801;&#x4E2D;&#x90FD;&#x80FD;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7801;&#xFF0C; &#x50CF;&#x63D0;&#x5230;&#x7684;HideDisplayCutout&#xFF0C;ImePlaceholder&#xFF0C;OneHanded&#x5728;&#x6E90;&#x7801;&#x4E2D;&#x79F0;&#x4E4B;&#x4E3A;Feature&#xFF08;&#x7279;&#x5F81;&#xFF09;&#xFF0C;&#x5373;&#x8868;&#x793A;&#x5F53;&#x524D;&#x8FD9;&#x4E2A;&#x5BB9;&#x5668;&#x6709;&#x5177;&#x6709;&#x8FD9;&#x4E2A;&#x7279;&#x5F81;&#xFF0C;&#x6682;&#x65F6;&#x77E5;&#x9053;&#x5C31;&#x53EF;&#x4EE5;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x6E90;&#x7801;&#x5BF9;&#x8FD9;&#x4E9B;Feature&#x7684;&#x5177;&#x4F53;&#x5B9A;&#x4E49;&#x3002;<br>&#x7136;&#x540E;&#x5C31;&#x662F;&#x540E;&#x9762;&#x7684;&#x8D77;&#x59CB;&#x5C42;&#x7EA7;:&#x7ED3;&#x675F;&#x5C42;&#x7EA7;&#xFF0C;&#x56E0;&#x4E3A;&#x867D;&#x7136;&#x4E00;&#x5171;&#x662F;&#x5206;&#x4E3A;37&#x5C42;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x662F;&#x8BF4;&#x6709;37&#x4E2A;Feature&#xFF0C;&#x6BD4;&#x5982;&#x201C;#1 ImePlaceholder:13:14 &#x201D; ImePlaceholder&#x770B;&#x7740;&#x5C31;&#x662F;&#x548C;&#x8F93;&#x5165;&#x6CD5;&#x76F8;&#x5173;&#xFF0C;&#x90A3;&#x5C31;&#x4EE3;&#x8868;&#x7740;13&#xFF0C;14&#x90FD;&#x662F;&#x548C;&#x8F93;&#x5165;&#x6CD5;&#x76F8;&#x5173;&#x7684;window&#x3002;<br>android 13&#x76EE;&#x524D;&#x4E00;&#x5171;&#x4E5F;&#x53EA;&#x6709;5&#x4E2A;Feature&#x3002;</p>
<p>&#x53E6;&#x5916;&#x63D0;&#x4E00;&#x4E0B;&#x8FD9;&#x91CC;&#x7684; &#x201C;Leaf&#x201D;&#x4EE3;&#x8868;&#x7684;&#x4E0D;&#x662F;Feature&#xFF0C;&#x800C;&#x4E14;&#x8BF4;&#x5F53;&#x524D;&#x662F;&#x67D0;&#x4E2A;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x8981;&#x6302;&#x7740;&#x5177;&#x4F53;Window&#x7684;&#x3002;</p>
<p><strong>3. &#x770B;&#x5176;&#x4ED6;&#x5C5E;&#x6027;&#xFF0C;&#x6BD4;&#x5982;type&#xFF0C;mode</strong></p>
<p>&#x77E5;&#x9053;&#x4E0A;&#x9762;&#x8FD9;4&#x70B9;&#x57FA;&#x672C;&#x4E0A;&#x5C31;&#x80FD;&#x770B;&#x5230;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x7684;&#x4FE1;&#x606F;&#x4E86;&#xFF0C;&#x5185;&#x5BB9;&#x867D;&#x7136;&#x5F88;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x4E3B;&#x8981;&#x5173;&#x5FC3;&#x7684;&#x8FD8;&#x662F;&#x4E0B;&#x9762;&#x201C;#1 DefaultTaskDisplayArea&#x201D;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x91CC;&#x653E;&#x7684;&#x624D;&#x662F;&#x5E94;&#x7528;&#x76F8;&#x5173;&#x7684;&#x7A97;&#x53E3;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x7CFB;&#x7EDF;&#x7A97;&#x53E3;&#x3002;&#x50CF;&#x5E94;&#x7528;&#x64CD;&#x4F5C;&#xFF0C;&#x5206;&#x5C4F;&#xFF0C;&#x5C0F;&#x7A97;&#xFF0C;&#x81EA;&#x7531;&#x7A97;&#x53E3;&#x64CD;&#x4F5C;&#x5BFC;&#x81F4;&#x5C42;&#x7EA7;&#x6539;&#x53D8;&#x90FD;&#x4F53;&#x73B0;&#x5728;&#x8FD9;&#x4E00;&#x5C42;&#xFF0C;<br>&#x53E6;&#x5916;&#x53EF;&#x4EE5;&#x7559;&#x610F;&#x4E00;&#x4E0B;&#x5982;&#x679C;&#x662F; WindowToken +WindowState&#x7684;&#x90FD;&#x662F;&#x7CFB;&#x7EDF;&#x7A97;&#x53E3;&#xFF0C;&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;        #0 WindowToken{1397896</span><br><span class="line">            #0 d0c3c51 InputMethod</span><br></pre></td></tr></table></figure>

<p>d0c3c51 &#x8FD9;&#x4E2A;&#x5E94;&#x8BE5;&#x662F;WindowState&#x7684;&#x5BF9;&#x8C61;&#x540D;&#xFF0C;&#x540E;&#x9762;&#x7684;InputMethod&#x662F;&#x5177;&#x4F53;&#x7684;&#x7A97;&#x53E3;&#x540D;<br>&#x800C; ActivityRecord+WindowState&#x5C31;&#x662F;&#x5E94;&#x7528;&#x4E86;&#x6BD4;&#x5982;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;         #0 ActivityRecord{91c971c</span><br><span class="line">            #0 9c20028 com.google.android.dialer</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x4E9B;&#x6709;&#x4E2A;&#x5370;&#x8C61;&#x5C31;&#x884C;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x786C;&#x80CC;&#xFF0C;&#x4EE5;&#x540E;&#x770B;&#x7684;&#x591A;&#x4E86;&#x81EA;&#x7136;&#x5C31;&#x6709;&#x611F;&#x89C9;&#x4E86;&#x3002;</p>
<h2 id="3-2-&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x53EF;&#x89C6;&#x5316;"><a href="#3-2-&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x53EF;&#x89C6;&#x5316;" class="headerlink" title="3.2 &#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x53EF;&#x89C6;&#x5316;"></a>3.2 &#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x53EF;&#x89C6;&#x5316;</h2><p>&#x5355;&#x770B;&#x5C42;&#x7EA7;&#x6811;&#x53EF;&#x80FD;&#x8FC7;&#x4E8E;&#x67AF;&#x71E5;&#xFF0C;&#x5728;&#x521A;&#x5F00;&#x59CB;&#x5B66;&#x4E60;&#x7684;&#x65F6;&#x5019;&#x4E00;&#x822C;&#x90FD;&#x4F1A;&#x6839;&#x636E;&#x4FE1;&#x606F;&#x753B;&#x51FA;&#x4E00;&#x4E2A;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x56FE;&#x3002;<br>&#x9996;&#x5148;&#x6839;&#x636E;&#x524D;&#x9762;&#x770B;dump&#x5185;&#x5BB9;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5148;&#x753B;&#x51FA;&#x4E00;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/7f064a2c04c81528b399c510416a80f2f18f50e59877a88efb553bc46e0cbbdb" alt="&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x7B2C;&#x4E00;&#x5C42;.png"></p>
<p>&#x8FD9;&#x91CC;&#x662F;DisplayContent&#x4E0B;&#x7684;3&#x4E2A;&#x5B69;&#x5B50;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5DF2;&#x7ECF;&#x8986;&#x76D6;&#x4E86; 0-36&#x5C42;&#x3002;<br>&#x7136;&#x540E;&#x6309;&#x7167;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5C06;&#x6240;&#x6709;&#x7684;&#x5185;&#x5BB9;&#x90FD;&#x753B;&#x51FA;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E0B;&#x9762;&#x8FD9;&#x5B8C;&#x6574;&#x7684;&#x6811;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/34c6fd44361be2fc984c575531209401ee4bd6c7c282209a2144eadb8c0320c3" alt="&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;.png"></p>
<p><strong>&#x5F3A;&#x70C8;&#x5EFA;&#x8BAE;&#x60F3;&#x5B66;&#x8FD9;&#x4E00;&#x5757;&#x7684;&#x540C;&#x5B66;&#x4E00;&#x5B9A;&#x8981;&#x624B;&#x52A8;&#x753B;&#x51FA;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x56FE;</strong></p>
<p>android&#x7248;&#x672C;&#x76F8;&#x540C;&#xFF0C;&#x753B;&#x51FA;&#x6765;&#x7684;&#x56FE;&#x57FA;&#x672C;&#x4E0A;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EA;&#x4F1A;&#x6839;&#x636E;&#x51FA;&#x73B0;&#x4E0D;&#x540C;&#x7684;Window&#x5728;&#x54CD;&#x5E94;&#x7684;Leaf,&#x4E5F;&#x5C31;&#x662F;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x4F1A;&#x6709;&#x4E0D;&#x540C;&#x3002;<br>&#x8FD9;&#x91CC;&#x5C06;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x989C;&#x8272;&#x6D82;&#x4E0A;&#x4E86;&#xFF0C;&#x53D1;&#x73B0;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x4E0B;&#x8981;&#x4E48;&#x4E3A;&#x7A7A;&#xFF0C;&#x8981;&#x4E48;&#x5C31;&#x662F; WindowToken&#xFF0C;&#x9664;&#x4E86;&#x6700;&#x5E95;&#x5C42;&#x7684;&#x58C1;&#x7EB8;&#xFF0C;&#x5176;&#x5B9E;&#x58C1;&#x7EB8;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x4E0B;&#x7684;WallpaperWindowToken&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x4E5F;&#x662F;&#x7EE7;&#x627F;&#x7684;WindowToken&#x3002;</p>
<p>&#x53EF;&#x80FD;&#x4E4B;&#x524D;&#x901A;&#x8FC7;&#x6587;&#x672C;&#x7684;&#x5F62;&#x5F0F;&#x8FD8;&#x6709;&#x70B9;&#x964C;&#x751F;&#xFF0C;&#x4F46;&#x662F;&#x8F6C;&#x6362;&#x6210;&#x56FE;&#x7247;&#x540E;&#xFF0C;&#x4E00;&#x4E9B;&#x5E38;&#x89C1;&#x7684;&#x4E1C;&#x897F;&#x5C31;&#x90FD;&#x6E05;&#x695A;&#x4E86;&#xFF0C;&#x6BD4;&#x5982;launcher,StatusBar,NavigationBar,Wallpaper</p>
<p>&#x7A97;&#x53E3;&#x6811;&#x548C;View&#x6811;&#x8FD8;&#x662F;&#x6709;&#x5DEE;&#x8DDD;&#x7684;&#xFF0C;View&#x6811;&#x4E0A;&#x90FD;&#x662F;View&#xFF0C;&#x800C;&#x7A97;&#x53E3;&#x6811;&#x4E0A;&#x53EA;&#x6709;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x4E0A;&#x6302;&#x7740;&#x7A97;&#x53E3;&#xFF0C;&#x5176;&#x4ED6;&#x5927;&#x90FD;&#x90FD;&#x662F;&#x4E00;&#x4E9B;&#x5BB9;&#x5668;&#x548C;&#x4E00;&#x4E9B;&#x3002;</p>
<p>&#x7A97;&#x53E3;&#x6811;&#x662F;&#x56FA;&#x5B9A;37&#x5C42;&#x7684;&#xFF0C; &#x7136;&#x540E;&#x5404;&#x4E2A;&#x56FE;&#x5C42;&#x90FD;&#x6709;&#x81EA;&#x5DF1;&#x652F;&#x6301;&#x7684;Feature&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x4EE3;&#x7801;&#x4E2D;&#x56FA;&#x5B9A;&#x597D;&#x7684;&#x3002; &#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x5F00;&#x53D1;&#x4E2D;&#x518D;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x7A97;&#x53E3;&#x6839;&#x636E;&#x9700;&#x6C42;&#x6302;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x53F6;&#x5B50;&#x8282;&#x70B9;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E2A;&#x548C;View&#x6811;&#x662F;&#x6709;&#x533A;&#x522B;&#x7684;&#x3002;</p>
<h2 id="3-3-&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;"><a href="#3-3-&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;" class="headerlink" title="3.3 &#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;"></a>3.3 &#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;</h2><p><strong>&#x65B9;&#x4FBF;&#x7BA1;&#x7406;</strong><br>&#x5728;&#x5199;&#x5E94;&#x7528;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x4F1A;&#x8FD9;&#x6837;&#x5B9A;&#x4E49;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x8BF4;&#x67D0;&#x4E2A;&#x4E1A;&#x52A1;&#x7684;View&#x65E0;&#x8BBA;&#x600E;&#x4E48;&#x5199;&#xFF0C;&#x4ED6;&#x5C31;&#x53EA;&#x80FD;&#x5728;&#x81EA;&#x5DF1;&#x6240;&#x5728;&#x7684;&#x201C;&#x5C42;&#x7EA7;&#x201D;&#x4E0A;&#x663E;&#x793A;&#xFF0C;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x5176;&#x4ED6;&#x3002;</p>
<p>&#x7A97;&#x53E3;&#x8FD9;&#x6837;&#x8BBE;&#x8BA1;&#x7684;&#x539F;&#x56E0;&#x53EF;&#x80FD;&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x5728;&#x8FDC;&#x53E4;&#x65F6;&#x671F;&#x7A97;&#x53E3;&#x7684;&#x987A;&#x5E8F;&#x597D;&#x50CF;&#x662F;&#x7ECF;&#x8FC7;&#x89C4;&#x5219;&#x8BA1;&#x7B97;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x79CD;&#x8BA1;&#x7B97;&#x5F88;&#x9EBB;&#x70E6;&#x51FA;&#x4E86;&#x95EE;&#x9898;&#x4E5F;&#x4E0D;&#x597D;&#x5B9A;&#x4F4D;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x7684;&#x8FD9;&#x79CD;&#x8BBE;&#x8BA1;&#x5C31;&#x5F88;&#x5408;&#x7406;&#xFF0C;&#x7B26;&#x5408;&#x201C;&#x5355;&#x4E00;&#x539F;&#x5219;&#x201D;&#xFF0C;&#x5404;&#x4E2A;&#x7C7B;&#x578B;&#x7684;&#x7A97;&#x53E3;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x5C42;&#x7EA7;&#x4E0A;&#xFF0C;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x5176;&#x4ED6;&#x3002;</p>
<p><strong>&#x65B9;&#x4FBF;&#x529F;&#x80FD;&#x5F00;&#x53D1;</strong><br>&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x4F18;&#x70B9;&#x6211;&#x8BA4;&#x4E3A;&#x662F;&#x8FD9;&#x79CD;&#x8BBE;&#x8BA1;&#x4E3A;&#x5C0F;&#x7A97;&#xFF0C;&#x5206;&#x5C4F;&#x8FD9;&#x79CD;&#x529F;&#x80FD;&#x63D0;&#x4F9B;&#x4E86;&#x5F00;&#x53D1;&#x7684;&#x4FBF;&#x5229;&#xFF0C;&#x56E0;&#x4E3A;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x5BF9;&#x5E94;&#x7684;&#x7A97;&#x53E3;&#x79FB;&#x52A8;&#x5230;&#x6240;&#x5728;&#x7684;Task&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</p>
<p>&#x50CF;&#x73B0;&#x5728;&#x7684;Activity&#x542F;&#x52A8;&#xFF0C;&#x5728;system_service&#x8FDB;&#x7A0B;&#x7684;&#x5904;&#x7406;&#x7684;&#x5F88;&#x591A;&#x903B;&#x8F91;&#x90FD;&#x662F;&#x56F4;&#x7ED5;&#x7740;&#x8FD9;&#x4E2A;&#x5C42;&#x7EA7;&#x6811;&#x6765;&#x505A;&#x7684;&#x3002;<br>&#x6BD4;&#x5982;&#x770B;&#x4E00;&#x773C;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x548C;&#x201C;&#x77ED;&#x4FE1;&#x201D;2&#x4E2A;&#x5E94;&#x7528;&#x8FDB;&#x884C;&#x5206;&#x5C4F;&#x64CD;&#x4F5C;&#x7684;&#x524D;&#x540E;&#x5BF9;&#x6BD4;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/649464f62949ca7a6eee126a5893d57b98df0eb6f75bf12e9e206e8875fa454e" alt="&#x5206;&#x5C4F;&#x524D;&#x540E;&#x5BB9;&#x5668;&#x5BF9;&#x6BD4;.png"></p>
<p>&#x901A;&#x8FC7;&#x5BF9;&#x6BD4;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;</p>
<ol>
<li>Task=5,6 &#x8FD9;2&#x4E2A;Task&#x662F;&#x5206;&#x5C4F;&#x7528;&#x5230;&#x7684;Task,&#x5B83;&#x4EEC;&#x6709;&#x5171;&#x540C;&#x7684;&#x7236;&#x4EB2;&#x2013; Task =4&#x3002; &#x8FD9;3&#x4E2A;Task &#x5728;&#x5F00;&#x673A;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;&#x9ED8;&#x8BA4;&#x5728;DefaultTaskDisplayArea&#x5B69;&#x5B50;&#x91CC;&#x662F;&#x6700;&#x540E;&#x9762;&#x3002;</li>
<li>&#x542F;&#x52A8;&#x5206;&#x5C4F;&#x540E;&#x5176;&#x5B9E;&#x5BF9;&#x5E94;&#x7A97;&#x53E3;&#x5BB9;&#x5668;&#x8FD9;&#x8FB9;&#x505A;&#x4E86;2&#x4EF6;&#x4E8B;<ol>
<li>&#x5C06;Task=4 &#x79FB;&#x5230;&#x6808;&#x9876;</li>
<li>&#x5C06;2&#x4E2A;&#x5206;&#x5C4F;&#x5E94;&#x7528;&#x7684;Task&#x5206;&#x522B;&#x79FB;&#x5230;&#x5230;Task5,6 &#x4E0B;</li>
</ol>
</li>
</ol>
<p>&#x8FD9;&#x6837;&#x5206;&#x5C4F;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/88c35e9a0596d0163dc5e878784264b6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7339741848079466534.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7339741848079466534.html" itemprop="url">阿里 P7二面：Redis 执行 Lua，能保证原子性吗？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-26T21:30:08+08:00">
                2024-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x4F60;&#x597D;&#xFF0C;&#x6211;&#x662F;<strong>&#x733F;java</strong>&#x3002;</p>
<p>Redis &#x548C; Lua&#xFF0C;&#x4E24;&#x4E2A;&#x770B;&#x4F3C;&#x98CE;&#x6D41;&#x9A6C;&#x4E0D;&#x76F8;&#x53CA;&#x7684;&#x6280;&#x672F;&#x70B9;&#xFF0C;&#x4E3A;&#x4F55;&#x80FD;&#x4EA7;&#x751F;&#x201C;&#x7231;&#x201D;&#x7684;&#x706B;&#x82B1;&#xFF0C;&#x6210;&#x4E3A;&#x5DE5;&#x4F5C;&#x5F00;&#x53D1;&#x4E2D;&#x7684;&#x9EC4;&#x91D1;&#x642D;&#x6863;&#xFF1F;&#x6280;&#x672F;&#x9762;&#x8BD5;&#x4E2D;&#x66F4;&#x662F;&#x9AD8;&#x9891;&#x51FA;&#x73B0;&#xFF0C;Redis &#x6267;&#x884C; Lua &#x5230;&#x5E95;&#x80FD;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;&#x4ECA;&#x5929;&#x5C31;&#x6765;&#x804A;&#x4E00;&#x804A;&#x3002; </p>
<p>&#x8981;&#x60F3;&#x5F04;&#x6E05;&#x695A;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x9700;&#x8981;&#x5BF9;&#x201C;&#x539F;&#x5B50;&#x6027;&#x201D;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x6709;&#x4E00;&#x4E2A;&#x6E05;&#x6670;&#x7684;&#x8BA4;&#x8BC6;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x9996;&#x5148;&#x8981;&#x5206;&#x6790;&#x7684;&#x662F;&#x539F;&#x5B50;&#x6027;&#x7684;&#x6982;&#x5FF5;&#x3002;</p>
<h1 id="&#x4E00;&#x3001;&#x539F;&#x5B50;&#x6027;"><a href="#&#x4E00;&#x3001;&#x539F;&#x5B50;&#x6027;" class="headerlink" title="&#x4E00;&#x3001;&#x539F;&#x5B50;&#x6027;"></a>&#x4E00;&#x3001;&#x539F;&#x5B50;&#x6027;</h1><h2 id="&#x901A;&#x5E38;&#x610F;&#x4E49;&#x7684;&#x539F;&#x5B50;&#x6027;"><a href="#&#x901A;&#x5E38;&#x610F;&#x4E49;&#x7684;&#x539F;&#x5B50;&#x6027;" class="headerlink" title="&#x901A;&#x5E38;&#x610F;&#x4E49;&#x7684;&#x539F;&#x5B50;&#x6027;"></a>&#x901A;&#x5E38;&#x610F;&#x4E49;&#x7684;&#x539F;&#x5B50;&#x6027;</h2><p>&#x901A;&#x5E38;&#x610F;&#x4E49;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x8BF4;&#x7684;&#x539F;&#x5B50;&#x6027;&#x662F;&#x6307;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93; RDBMS&#xFF08;&#x6BD4;&#x5982; MySQL&#xFF09;&#x7684;&#x539F;&#x5B50;&#x6027;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; ACID&#xFF08;Atomicity&#x3001;Consistency&#x3001;Isolation&#x3001;Durability&#xFF09;&#x4E2D; Atomicity&#x8FD9;&#x4E00;&#x9879;&#x7279;&#x6027;&#x3002;</p>
<p>ACID &#x4E2D;&#x7684;&#x539F;&#x5B50;&#x6027;&#x6307;&#xFF1A;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x6267;&#x884C;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x4E0D;&#x6267;&#x884C;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x4EE5;&#x94F6;&#x884C;&#x8F6C;&#x8D26;&#xFF0C;&#x8D26;&#x6237;A &#x7ED9;&#x8D26;&#x6237;B &#x8F6C;&#x8D26;100&#x5143;&#x4E3A;&#x4F8B;&#x6765;&#x89E3;&#x91CA;&#x539F;&#x5B50;&#x6027;&#xFF1A;</p>
<ol>
<li>&#x8D26;&#x6237;A &#x51CF;&#x53BB;100&#x5143;&#xFF1B;</li>
<li>&#x8D26;&#x6237;B &#x589E;&#x52A0;100&#x5143;&#xFF1B;</li>
</ol>
<p>&#x539F;&#x5B50;&#x6027;&#x662F;&#x6307;&#x4E0A;&#x9762;&#x4E24;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x6267;&#x884C;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x4E0D;&#x6267;&#x884C;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x8D26;&#x6237;A &#x51CF;&#x53BB; 100&#x5143;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x8D26;&#x6237;B &#x5FC5;&#x987B;&#x589E;&#x52A0;100&#x5143;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x8BE5;&#x64CD;&#x4F5C;&#x5C31;&#x4E0D;&#x5177;&#x5907;&#x539F;&#x5B50;&#x6027;&#x3002;Java&#x4EE3;&#x7801;&#x7B80;&#x8981;&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/86202c298fdf2fb097455b85e2820bd160c2a463a74196ee661c55067e4af827" alt="&#x56FE;&#x7247;"></p>
<h2 id="Lua-&#x539F;&#x5B50;&#x6027;"><a href="#Lua-&#x539F;&#x5B50;&#x6027;" class="headerlink" title="Lua &#x539F;&#x5B50;&#x6027;"></a>Lua &#x539F;&#x5B50;&#x6027;</h2><p>&#x5728;&#x5206;&#x6790; Lua&#x7684;&#x539F;&#x5B50;&#x6027;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x770B; Lua&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x4E0B;&#x56FE;&#x6458;&#x81EA; Lua&#x5B98;&#x65B9;&#x63CF;&#x8FF0;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/78758d65a66c0106f262939bf0c30209139c149865ec8b0fa6936b0ea856e29b" alt="image.png"></p>
<p>&#x4ECE;&#x5B98;&#x65B9;&#x63CF;&#x8FF0;&#x53EF;&#x4EE5;&#x5F97;&#x77E5;&#xFF1A;Lua &#x662F;&#x4E00;&#x79CD;&#x529F;&#x80FD;&#x5F3A;&#x5927;&#x3001;&#x9AD8;&#x6548;&#x3001;&#x8F7B;&#x91CF;&#x7EA7;&#x3001;&#x53EF;&#x5D4C;&#x5165;&#x7684;&#x811A;&#x672C;&#x8BED;&#x8A00;&#x3002;&#x5B83;&#x652F;&#x6301;&#x8FC7;&#x7A0B;&#x7F16;&#x7A0B;&#x3001;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#x3001;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x3001;&#x6570;&#x636E;&#x9A71;&#x52A8;&#x7F16;&#x7A0B;&#x548C;&#x6570;&#x636E;&#x63CF;&#x8FF0;&#x3002; Lua &#x5C06;&#x7B80;&#x5355;&#x7684;&#x8FC7;&#x7A0B;&#x8BED;&#x6CD5;&#x4E0E;&#x57FA;&#x4E8E;&#x5173;&#x8054;&#x6570;&#x7EC4;&#x548C;&#x53EF;&#x6269;&#x5C55;&#x8BED;&#x4E49;&#x7684;&#x5F3A;&#x5927;&#x6570;&#x636E;&#x63CF;&#x8FF0;&#x7ED3;&#x6784;&#x76F8;&#x7ED3;&#x5408;&#x3002;Lua &#x662F;&#x52A8;&#x6001;&#x7C7B;&#x578B;&#x7684;&#xFF0C;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x57FA;&#x4E8E;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x865A;&#x62DF;&#x673A;&#x89E3;&#x91CA;&#x5B57;&#x8282;&#x7801;&#x6765;&#x8FD0;&#x884C;&#xFF0C;&#x5E76;&#x5177;&#x6709;&#x81EA;&#x52A8;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x548C;&#x589E;&#x91CF;&#x5783;&#x573E;&#x56DE;&#x6536;&#x529F;&#x80FD;&#xFF0C;&#x4F7F;&#x5176;&#x6210;&#x4E3A;&#x914D;&#x7F6E;&#x3001;&#x811A;&#x672C;&#x7F16;&#x5199;&#x548C;&#x5FEB;&#x901F;&#x539F;&#x578B;&#x8BBE;&#x8BA1;&#x7684;&#x7406;&#x60F3;&#x9009;&#x62E9;&#x3002;</p>
<p>Lua &#x672C;&#x8EAB;&#x5E76;&#x6CA1;&#x6709;&#x63D0;&#x4F9B;&#x5BF9;&#x4E8E;&#x539F;&#x5B50;&#x6027;&#x7684;&#x76F4;&#x63A5;&#x652F;&#x6301;&#xFF0C;&#x5B83;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x811A;&#x672C;&#x8BED;&#x8A00;&#xFF0C;&#x901A;&#x5E38;&#x662F;&#x5D4C;&#x5165;&#x5230;&#x5176;&#x4ED6;&#x5BBF;&#x4E3B;&#x7A0B;&#x5E8F;&#x4E2D;&#x8FD0;&#x884C;&#xFF0C;&#x6BD4;&#x5982; Redis&#x3002;</p>
<p>&#x5728; Redis&#x4E2D;&#x6267;&#x884C; Lua&#x7684;&#x539F;&#x5B50;&#x6027;&#x662F;&#x6307;&#xFF1A;&#x6574;&#x4E2A; Lua&#x811A;&#x672C;&#x5728;&#x6267;&#x884C;&#x671F;&#x95F4;&#xFF0C;&#x4F1A;&#x88AB;&#x5F53;&#x4F5C;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#xFF0C;&#x4E0D;&#x4F1A;&#x88AB;&#x5176;&#x4ED6;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x547D;&#x4EE4;&#x6253;&#x65AD;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x5BF9; Redis&#x6267;&#x884C; Lua&#x7684;&#x539F;&#x5B50;&#x6027;&#x6709;&#x4E00;&#x4E2A;&#x611F;&#x5B98;&#x4E0A;&#x7684;&#x8BA4;&#x8BC6;&#xFF0C;&#x8FD9;&#x91CC;&#x4EE5; Lua&#x811A;&#x672C;&#x4E2D;&#x9700;&#x8981;&#x5B8C;&#x6210; <code>SET key1 value1</code> &#x548C; <code>INCRBY key2 value2</code> &#x548C; <code>SET key3 value3</code> &#x4E09;&#x4E2A;&#x547D;&#x4EE4;&#x4E3A;&#x4F8B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/bc087cd20fc6d8bcc9406c8958d4265f2ff33847c2acf7699a763b31bd9ffeb3" alt="&#x56FE;&#x7247;"></p>
<p>&#x4E0A;&#x8FF0;&#x4F8B;&#x5B50;&#xFF0C;&#x6574;&#x4E2A; luaScript &#x5B57;&#x7B26;&#x4E32;&#x811A;&#x672C;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#x88AB;&#x6267;&#x884C;&#x4E14;&#x4E0D;&#x88AB;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x6253;&#x65AD;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x539F;&#x5B50;&#x6027;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x597D;&#x4E86;&#xFF0C;&#x603B;&#x7ED3;&#x4E0B; ACID&#x7684;&#x539F;&#x5B50;&#x6027;&#x548C; Redis&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x539F;&#x5B50;&#x6027;&#x5728;&#x6982;&#x5FF5;&#x4E0A;&#x7684;&#x5DEE;&#x5F02;&#xFF1A;</p>
<ul>
<li>ACID&#x7684;&#x539F;&#x5B50;&#x6027;&#x662F;&#x6307;&#xFF1A;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x8981;&#x4E48;&#x5168;&#x6267;&#x884C;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x4E0D;&#x6267;&#x884C;&#xFF1B;</li>
<li>Redis&#x4E2D;&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x539F;&#x5B50;&#x6027;&#x662F;&#x6307;&#xFF1A;Lua&#x811A;&#x672C;&#x4F1A;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#x6267;&#x884C;&#x4E14;&#x4E0D;&#x88AB;&#x5176;&#x4ED6;&#x5BA2;&#x6237;&#x7AEF;&#x6253;&#x65AD;&#xFF0C;&#x81F3;&#x4E8E; Lua&#x811A;&#x672C;&#x91CC;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x662F;&#x5426;&#x5FC5;&#x987B;&#x5168;&#x90E8;&#x6210;&#x529F;&#xFF0C;&#x6216;&#x8005;&#x5168;&#x90E8;&#x5931;&#x8D25;&#xFF0C;&#x5E76;&#x4E0D;&#x8981;&#x6C42;&#x3002;&#x5173;&#x4E8E;&#x8FD9;&#x4E00;&#x70B9;&#xFF0C;&#x5728;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x5185;&#x5BB9;&#x4E5F;&#x4F1A;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#xFF1B;</li>
</ul>
<p>&#x5728;&#x5206;&#x6790;&#x539F;&#x5B50;&#x6027;&#x6982;&#x5FF5;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x201C;&#x539F;&#x5B50;&#x6027;&#x201D;&#x5176;&#x5B9E;&#x662F;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x4E00;&#x9879;&#x7279;&#x6027;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5206;&#x6790; Redis&#x7684;&#x4E8B;&#x52A1;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;Redis-&#x4E8B;&#x52A1;"><a href="#&#x4E8C;&#x3001;Redis-&#x4E8B;&#x52A1;" class="headerlink" title="&#x4E8C;&#x3001;Redis &#x4E8B;&#x52A1;"></a>&#x4E8C;&#x3001;Redis &#x4E8B;&#x52A1;</h2><p>&#x4E0B;&#x56FE;&#x662F; Redis&#x5B98;&#x65B9;&#x5BF9;&#x4E8B;&#x52A1;&#x63CF;&#x8FF0;&#x7684;&#x6458;&#x8981;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/eaf3d9830fab2a70cc55b5be910c3d55db0b287b4f3e1e813d331ba9bc93c2aa" alt="&#x56FE;&#x7247;"></p>
<p>&#x6587;&#x6863;&#x770B;&#x8D77;&#x6765;&#x5F88;&#x957F;&#xFF0C;&#x603B;&#x7ED3;&#x6210;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A;Redis &#x4E8B;&#x52A1;&#x5141;&#x8BB8;&#x6267;&#x884C;&#x4E00;&#x6279;&#x547D;&#x4EE4;&#xFF0C;&#x901A;&#x8FC7;&#x6267;&#x884C; MULTI&#x547D;&#x4EE4;&#x5F00;&#x542F;&#x4E8B;&#x52A1;&#xFF0C;&#x6267;&#x884C; EXEC&#x547D;&#x4EE4;&#x7ED3;&#x675F;&#x4E8B;&#x52A1;&#xFF0C;WATCH &#x548C; DISCARD &#x914D;&#x5408;&#x4E8B;&#x52A1;&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD; CAS(check-and-set) &#x4E50;&#x89C2;&#x9501;&#x7684;&#x673A;&#x5236;&#x3002;WATCH &#x7528;&#x4E8E;&#x76D1;&#x542C; Key&#xFF0C;&#x5982;&#x679C;&#x88AB;&#x76D1;&#x542C;&#x7684; Key&#x6709;&#x4EFB;&#x4F55;&#x4E00;&#x4E2A;&#x53D1;&#x751F;&#x53D8;&#x5316;&#xFF0C;&#x5219;&#x4E2D;&#x6B62;&#x4E8B;&#x52A1;&#xFF08;&#x88AB;&#x52A8;&#x5173;&#x95ED;&#x4E8B;&#x52A1;&#xFF09;&#xFF0C;&#x800C; DISCARD &#x7528;&#x4E8E;&#x4E3B;&#x52A8;&#x4E2D;&#x6B62;&#x4E8B;&#x52A1;&#x3002;</p>
<h2 id="MULTI-EXEC"><a href="#MULTI-EXEC" class="headerlink" title="MULTI/EXEC"></a>MULTI/EXEC</h2><p>&#x7528;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x6765;&#x7406;&#x89E3; MULTI/EXEC&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/a1f68d019bbf0e0e690985dce37a01f1fcf9bb0ba08a07e6ee4b1505b08932ba" alt="&#x56FE;&#x7247;"></p>
<p>&#x901A;&#x8FC7;&#x6267;&#x884C;&#x7684;&#x7ED3;&#x679C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF1A;Redis&#x7684;&#x4E8B;&#x52A1;&#x662F;&#x4EE5; MULTI&#x547D;&#x4EE4;&#x5F00;&#x542F;&#xFF0C;&#x4EE5; EXEC&#x547D;&#x4EE4;&#x7ED3;&#x675F;&#xFF0C;&#x671F;&#x95F4;&#x6240;&#x6709;&#x7684;&#x547D;&#x4EE4;&#x90FD;&#x662F;&#x5148;&#x8FDB;&#x5165;&#x961F;&#x5217;&#xFF0C;&#x53EA;&#x6709;&#x6267;&#x884C; EXEC&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x628A;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x547D;&#x4EE4;&#x987A;&#x5E8F;&#x4E32;&#x884C;&#x6267;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6240;&#x6709;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x5305;&#x62EC;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;&#x5728; EXEC &#x6267;&#x884C;&#x540E;&#xFF0C;&#x5373;&#x4F7F;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#x6709;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5931;&#x8D25;&#xFF0C;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x547D;&#x4EE4;&#x4E5F;&#x4F1A;&#x88AB;&#x5904;&#x7406;&#xFF0C;Redis &#x4E0D;&#x4F1A;&#x505C;&#x6B62;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x547D;&#x4EE4;&#x3002;</p>
<p>DISCARD &#x548C; WATCH &#x4E5F;&#x662F; Redis &#x4E2D;&#x7528;&#x4E8E;&#x4E8B;&#x52A1;&#x7684;&#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#xFF0C;&#x5B83;&#x4EEC;&#x4E0E; MULTI &#x548C; EXEC &#x4E00;&#x8D77;&#x4F7F;&#x7528;&#xFF0C;&#x63D0;&#x4F9B;&#x66F4;&#x590D;&#x6742;&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x673A;&#x5236;&#x3002;</p>
<h2 id="WATCH"><a href="#WATCH" class="headerlink" title="WATCH"></a>WATCH</h2><p>WATCH &#x547D;&#x4EE4;&#x7528;&#x4E8E;&#x76D1;&#x542C;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A; Key&#xFF0C;&#x5982;&#x679C;&#x5728;&#x6267;&#x884C;&#x4E8B;&#x52A1;&#x671F;&#x95F4;&#x8FD9;&#x4E9B; Key&#x4E2D;&#x4EFB;&#x4F55;&#x4E00;&#x4E2A;Key&#x7684; value&#x88AB;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x4FEE;&#x6539;&#xFF0C;&#x5F53;&#x524D;&#x6574;&#x4E2A;&#x4E8B;&#x52A1;&#x5C06;&#x4F1A;&#x88AB;&#x4E2D;&#x6B62;&#x3002;&#xFF08;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF1A;&#x4F4E;&#x4E8E; 6.0.9 &#x7684; Redis &#x7248;&#x672C;&#xFF0C;Key&#x8FC7;&#x671F;&#x4E0D;&#x4F1A;&#x4E2D;&#x6B62;&#x4E8B;&#x52A1;&#xFF09;</p>
<p>&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF1A;&#x4E8B;&#x52A1;1 watch key1 key2&#xFF0C;&#x4E8B;&#x52A1;2&#x5728;&#x4E8B;&#x52A1;1&#x6267;&#x884C;&#x671F;&#x95F4;&#x4FEE;&#x6539; key2 = 10&#xFF0C;&#x5F53;&#x4E8B;&#x52A1;1&#x6267;&#x884C; exec&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x56E0;&#x4E3A; watch&#x76D1;&#x542C;&#x5230; key2&#x88AB;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#xFF08;&#x4E8B;&#x52A1;2&#xFF09;&#x4FEE;&#x6539;&#x4E86;(value=10) &#xFF0C; &#x56E0;&#x6B64;&#x4E8B;&#x52A1;1&#x88AB;&#x53D6;&#x6D88;&#xFF0C;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x547D;&#x4EE4;&#x88AB;&#x6E05;&#x9664;&#xFF0C;&#x5373; <code>set key1 value1</code> &#x548C; <code>incrby key 2</code>&#x4E24;&#x6761;&#x547D;&#x4EE4;&#x90FD;&#x4E0D;&#x6267;&#x884C;&#xFF0C;key2&#x7684; value&#x8FD8;&#x662F;10&#xFF1B;</p>
<table>
<thead>
<tr>
<th>&#x4E8B;&#x52A1;1</th>
<th>&#x4E8B;&#x52A1;2</th>
</tr>
</thead>
<tbody><tr>
<td>watch key1 key2</td>
<td></td>
</tr>
<tr>
<td>multi</td>
<td></td>
</tr>
<tr>
<td>set key1 value1</td>
<td></td>
</tr>
<tr>
<td>incrby key2 2</td>
<td>set key2 10</td>
</tr>
<tr>
<td>exec</td>
<td></td>
</tr>
<tr>
<td>keys * // &#x53EA;&#x6709;key2=10</td>
<td>keys * // &#x53EA;&#x6709;key2=10</td>
</tr>
</tbody></table>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/7082db3b93f8bc2b899fc4104461f7efa3089a2804355e1678a8232877d3c6ed" alt="&#x56FE;&#x7247;"></p>
<h2 id="DISCARD"><a href="#DISCARD" class="headerlink" title="DISCARD"></a>DISCARD</h2><p>DISCARD &#x547D;&#x4EE4;&#x7528;&#x4E8E;&#x4E2D;&#x6B62;&#x4E8B;&#x52A1;&#x3002;</p>
<p>&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF0C;&#x6267;&#x884C; DISCARD&#x547D;&#x4EE4;&#x540E;&#xFF0C;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x88AB;&#x4E2D;&#x6B62;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6267;&#x884C; EXEC &#x65F6;&#x4F1A;&#x62A5;&#x201C;ERR EXEC without MULTI&#x201D;&#x9519;&#x8BEF;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/e077829459af9f64ae55c2db2e2d7e112c79c2c5ee032c522222c950b4da0a67" alt="&#x56FE;&#x7247;"></p>
<h2 id="&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x9519;&#x8BEF;"><a href="#&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x9519;&#x8BEF;" class="headerlink" title="&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x9519;&#x8BEF;"></a>&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x9519;&#x8BEF;</h2><p>&#x4E8B;&#x52A1;&#x4E2D;&#x4E3B;&#x8981;&#x4F1A;&#x51FA;&#x73B0;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p>
<ol>
<li>&#x4E8B;&#x52A1;&#x547D;&#x4EE4;&#x8FDB;&#x5165;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E4B;&#x524D;&#x51FA;&#x9519;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x547D;&#x4EE4;&#x8BED;&#x6CD5;&#x9519;&#x8BEF;&#xFF08;&#x53C2;&#x6570;&#x9519;&#x8BEF;&#x3001;&#x547D;&#x4EE4;&#x540D;&#x79F0;&#x9519;&#x8BEF;&#x7B49;&#xFF09;&#xFF0C;&#x6216;&#x8005;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x60C5;&#x51B5;&#xFF0C;&#x6BD4;&#x5982;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#x3002;&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF0C;&#x547D;&#x4EE4;<code>incr key2 1/0</code> &#x5728;&#x8FDB;&#x5165;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E4B;&#x524D;&#x62A5;&#x9519;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x88AB;&#x4E2D;&#x6B62;&#xFF0C;&#x6267;&#x884C; EXEC&#x547D;&#x4EE4;&#x4F1A;&#x62A5;&#x9519;&#xFF1A;</li>
</ol>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/eafc161c01842e0ed4af4a1e68b105ceb4c4c0bc7f50fa0c3656bbe30f3df6ff" alt="&#x56FE;&#x7247;"><br>2. &#x8C03;&#x7528; EXEC &#x547D;&#x4EE4;&#x540E;&#xFF0C;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5931;&#x8D25;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x503C;&#x8FDB;&#x884C;&#x52A0;1&#x64CD;&#x4F5C;&#x3002;&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF0C;key&#x7684; value&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x5F53;&#x5BF9; key &#x6267;&#x884C;<code>incr key</code> &#x64CD;&#x4F5C;&#x65F6;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x8BE5;&#x6761;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5931;&#x8D25;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/3202803f628c364ac5854bf0f96b1884f9b95ab71718c009c85ee83a3474db74" alt="&#x56FE;&#x7247;"></p>
<h2 id="&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;"><a href="#&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;" class="headerlink" title="&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;"></a>&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;</h2><p><strong>Redis&#x7684;&#x4E8B;&#x52A1;&#x4E0D;&#x652F;&#x6301;&#x56DE;&#x6EDA;&#x3002;</strong> &#x5B98;&#x65B9;&#x8BF4;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/25cfaeaa6f099aa117bddc0d1b5edf1de8db7614a953a14631f2cea81d0e3927" alt="&#x56FE;&#x7247;"></p>
<p>Redis &#x4E0D;&#x652F;&#x6301;&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;&#xFF0C;&#x56E0;&#x4E3A;&#x652F;&#x6301;&#x56DE;&#x6EDA;&#x4F1A;&#x5BF9; Redis &#x7684;&#x7B80;&#x5355;&#x6027;&#x548C;&#x6027;&#x80FD;&#x4EA7;&#x751F;&#x91CD;&#x5927;&#x5F71;&#x54CD;&#x3002;</p>
<p>&#x5B98;&#x65B9;&#x8BF4;&#x660E;&#x7B80;&#x660E;&#x627C;&#x8981;&#xFF0C;&#x5176;&#x5B9E;&#xFF0C;&#x591A;&#x52A0;&#x601D;&#x8003;&#x4E5F;&#x80FD;&#x7406;&#x89E3;&#xFF1A;&#x201D;Redis&#x201D; &#x662F; &#x201C;REmote DIctionary Server&#x201D; &#x7684;&#x7F29;&#x5199;&#xFF0C;&#x7FFB;&#x8BD1;&#x4E3A;&#x201C;&#x8FDC;&#x7A0B;&#x5B57;&#x5178;&#x670D;&#x52A1;&#x201D;&#xFF0C;&#x8BBE;&#x8BA1;&#x7684;&#x521D;&#x8877;&#x662F;&#x7528;&#x4E8E;&#x7F13;&#x5B58;&#xFF0C;&#x8FFD;&#x6C42;&#x5FEB;&#x901F;&#x9AD8;&#x6548;&#x3002;&#x800C;&#x4E86;&#x89E3;&#x8FC7; ACID&#x4E8B;&#x52A1;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x5E94;&#x8BE5;&#x80FD;&#x660E;&#x767D;&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;&#x7684;&#x590D;&#x6742;&#x5EA6;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;Redis&#x4E0D;&#x652F;&#x6301;&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;&#x4F3C;&#x4E4E;&#x4E5F;&#x5408;&#x60C5;&#x5408;&#x7406;&#x3002;</p>
<p>&#x5230;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x5BF9; Redis&#x4E8B;&#x52A1;&#x505A;&#x4E2A;&#x5C0F;&#x7ED3;&#xFF1A;Redis&#x7684;&#x4E8B;&#x52A1;&#x7531; MULTI/EXEC &#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x5B8C;&#x6210;&#xFF0C;WATCH/DISCARD &#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x7684;&#x52A0;&#x6301;&#xFF0C;&#x7ED9; Redis&#x4E8B;&#x52A1;&#x63D0;&#x4F9B;&#x4E86; CAS &#x4E50;&#x89C2;&#x9501;&#x673A;&#x5236;&#x3002;Redis &#x4E8B;&#x52A1;&#x4E0D;&#x652F;&#x6301;&#x56DE;&#x6EDA;&#xFF0C;&#x5B83;&#x548C;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#xFF08;&#x6BD4;&#x5982; MySQL&#xFF09;&#x7684;&#x4E8B;&#x52A1;&#xFF08;ACID&#xFF09;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h2 id="&#x4E09;&#x3001;Redis-&#x5982;&#x4F55;&#x6267;&#x884C;-Lua&#xFF1F;"><a href="#&#x4E09;&#x3001;Redis-&#x5982;&#x4F55;&#x6267;&#x884C;-Lua&#xFF1F;" class="headerlink" title="&#x4E09;&#x3001;Redis &#x5982;&#x4F55;&#x6267;&#x884C; Lua&#xFF1F;"></a>&#x4E09;&#x3001;Redis &#x5982;&#x4F55;&#x6267;&#x884C; Lua&#xFF1F;</h2><p>&#x5206;&#x6790;&#x5B8C;&#x539F;&#x5B50;&#x6027;&#x548C; Redis&#x4E8B;&#x52A1;&#x8FD9;&#x4E9B;&#x7406;&#x8BBA;&#x77E5;&#x8BC6;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5F97;&#x52A8;&#x624B;&#x5B9E;&#x64CD;&#xFF0C;&#x770B;&#x770B; Redis&#x662F;&#x5982;&#x4F55;&#x6267;&#x884C; Lua&#x7684;&#x3002;</p>
<p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Redis&#x6267;&#x884C; Lua&#x5E38;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x6709; 2&#x79CD;&#xFF1A;</p>
<ol>
<li>&#x539F;&#x751F;&#x547D;&#x4EE4;&#xFF0C;&#x6BD4;&#x5982; EVAL/EVALSHA&#x547D;&#x4EE4;&#x7B49;&#xFF1B;</li>
<li>&#x7F16;&#x7A0B;&#x5DE5;&#x5177;&#xFF0C;&#x6BD4;&#x5982;&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x4E2D;&#x63D0;&#x4F9B;&#x7684;&#x4E09;&#x65B9;&#x5DE5;&#x5177;&#x5305;&#x6216;&#x7C7B;&#x5E93;&#xFF1B;</li>
</ol>
<p>&#x5728;&#x7F16;&#x5199; Lua&#x811A;&#x672C;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x533A;&#x5206; redis.call() &#x548C; redis.pcall() &#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x7684;&#x4F7F;&#x7528;&#x3002;</p>
<h2 id="EVAL"><a href="#EVAL" class="headerlink" title="EVAL"></a>EVAL</h2><p>&#x8BED;&#x6CD5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">css&#x590D;&#x5236;&#x4EE3;&#x7801;EVAL script numkeys [key [key ...]] [arg [arg ...]]</span><br></pre></td></tr></table></figure>

<p>EVAL&#x8BED;&#x6CD5;&#x5F88;&#x7B80;&#x5355;&#xFF0C;EVAL script numkeys &#x662F;&#x5FC5;&#x586B;&#x9879;&#xFF0C;[key [key &#x2026;]] [arg [arg &#x2026;]]&#x662F;&#x9009;&#x586B;&#x9879;&#x3002;</p>
<p>&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#x622A;&#x56FE;&#xFF0C;&#x5206;&#x522B;&#x5C55;&#x793A;&#x4E86;&#x4E0D;&#x4F20;Key&#xFF0C;&#x4F20; 1&#x4E2A;key &#x548C; 2&#x4E2A; key 3&#x79CD;&#x573A;&#x666F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/804c600427fa1189c09fe8193d0f8da5fd8fd97127970a9a2a93826513692caa" alt="&#x56FE;&#x7247;"></p>
<p>&#x4E0B;&#x56FE;&#x793A;&#x4F8B;&#x5C55;&#x793A;&#x4E86; [key [key &#x2026;]] [arg [arg &#x2026;]] &#x548C; numkeys &#x5339;&#x914D;&#x9519;&#x8BEF;&#x65F6;&#x62A5;&#x9519;&#x7684;&#x573A;&#x666F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/c118a2841ea254280cfbfeb457e3a6e5887780e3243f58285fbf7293660f362a" alt="&#x56FE;&#x7247;"></p>
<h2 id="redis-call"><a href="#redis-call" class="headerlink" title="redis.call()"></a>redis.call()</h2><p>redis.call() &#x7528;&#x4E8E;&#x6267;&#x884C; Redis&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5F53;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x51FA;&#x9519;&#x65F6;&#xFF0C;&#x4F1A;&#x963B;&#x65AD;&#x6574;&#x4E2A;&#x811A;&#x672C;&#x6267;&#x884C;&#xFF0C;&#x5E76;&#x5C06;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</p>
<p>&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF1A;&#x5F53;&#x6267;&#x884C;<code>INCRBY key2 1/0</code> &#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x4F1A;&#x629B;&#x5F02;&#x5E38;&#xFF0C;&#x540E;&#x7EED;&#x6D41;&#x7A0B;&#x88AB;&#x963B;&#x65AD;&#xFF0C;&#x5373;<code>SET key3 value3</code>&#x6CA1;&#x6709;&#x88AB;&#x6267;&#x884C;&#x3002;</p>
<p>Redis&#x539F;&#x751F;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x793A;&#x4F8B;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;EVAL&#xA0;&quot;redis.call(&apos;SET&apos;,&#xA0;&apos;key1&apos;,&#xA0;&apos;value1&apos;);&#xA0;redis.call(&apos;INCRBY&apos;,&#xA0;&apos;key2&apos;,&#xA0;1/0);&#xA0;redis.call(&apos;SET&apos;,&#xA0;&apos;key3&apos;,&#xA0;&apos;value3&apos;)&quot;&#xA0;0</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/8350bf3de88b45afe662d7110475922b8c89561966a8619726985f83e4c3665c" alt="&#x56FE;&#x7247;"></p>
<p>&#x4F7F;&#x7528; Jedis&#x6846;&#x67B6;&#x6267;&#x884C; Lua&#x793A;&#x4F8B;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/e526a0b8dff16487a9a8fc76f263797c988cd7ad2e687c774f16dd5596ff3b8d" alt="&#x56FE;&#x7247;"></p>
<p>&#x67E5;&#x770B; Lua&#x6267;&#x884C;&#x540E;&#x5404;&#x4E2A;key&#x7684;&#x503C;&#xFF0C;&#x622A;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/b63acbaefafc8c9c362fd222f37ed3bc0f0c2c8e406c4cec38d43fdf1c037148" alt="&#x56FE;&#x7247;"></p>
<h2 id="redis-pcall"><a href="#redis-pcall" class="headerlink" title="redis.pcall()"></a>redis.pcall()</h2><p>redis.pcall() &#x4E5F;&#x7528;&#x4E8E;&#x6267;&#x884C; Redis&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5F53;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x51FA;&#x9519;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x963B;&#x65AD;&#x811A;&#x672C;&#x7684;&#x6267;&#x884C;&#xFF0C;&#x800C;&#x662F;&#x5185;&#x90E8;&#x6355;&#x83B7;&#x9519;&#x8BEF;&#xFF0C;&#x5E76;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x540E;&#x7EED;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
<p>&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#xFF1A;&#x5F53;&#x6267;&#x884C;<code>INCRBY key2 1/0</code> &#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x629B;&#x5F02;&#x5E38;&#xFF0C;&#x540E;&#x7EED;&#x6D41;&#x7A0B;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF0C;&#x5373;<code>SET key3 value3</code> &#x4E5F;&#x88AB;&#x6267;&#x884C;&#x3002;</p>
<p>Redis&#x539F;&#x751F;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x793A;&#x4F8B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;EVAL &quot;redis.pcall(&apos;SET&apos;, &apos;key1&apos;, &apos;value1&apos;); redis.pcall(&apos;INCRBY&apos;, &apos;key2&apos;, 1/0); redis.pcall(&apos;SET&apos;, &apos;key3&apos;, &apos;value3&apos;)&quot; 0</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/60af1d806ff7fad1bdf627dd3dab341edd7b0007a45877414aea708b68ae05eb" alt="&#x56FE;&#x7247;"></p>
<p>&#x4F7F;&#x7528; Jedis&#x6846;&#x67B6;&#x6267;&#x884C; Lua&#x793A;&#x4F8B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/cfa169c73a632f41ed8803069310e28d55cde0c6db850e2c6ac7defbdc93a579" alt="&#x56FE;&#x7247;"></p>
<p>&#x5BF9;&#x4E8E; Lua&#x4E2D; redis.call() &#x548C; redis.pcall() &#x5982;&#x4F55;&#x9009;&#x62E9;&#xFF0C;&#x9700;&#x8981;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x4E1A;&#x52A1;&#x6765;&#x5224;&#x65AD;&#xFF0C;&#x6807;&#x51C6;&#x662F;&#xFF1A;&#x5F53; Lua&#x811A;&#x672C;&#x4E2D;&#x67D0;&#x6761;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x51FA;&#x9519;&#x65F6;&#xFF0C;&#x662F;&#x5426;&#x9700;&#x8981;&#x963B;&#x65AD;&#x540E;&#x7EED;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x3002;</p>
<h2 id="&#x56DB;&#x3001;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;"><a href="#&#x56DB;&#x3001;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;" class="headerlink" title="&#x56DB;&#x3001;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;"></a>&#x56DB;&#x3001;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;</h2><p>&#x9996;&#x5148;&#xFF0C;&#x53EF;&#x4EE5;&#x80AF;&#x5B9A;&#x7684;&#x662F;&#xFF1A;<strong>Redis&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;</strong>&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD9;&#x548C; Redis Server&#x7684;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x5BC6;&#x4E0D;&#x53EF;&#x5206;&#x3002;</p>
<p>Redis&#x662F;&#x5178;&#x578B;&#x7684; C/S(Client/Server) &#x6A21;&#x578B;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/58369f4c4548637d4ce3cdc48931de743f04b3dc9d5388462d4e426cfca8aa3e" alt="&#x56FE;&#x7247;"></p>
<p>&#x56E0;&#x6B64;&#xFF0C;Redis &#x901A;&#x5E38;&#x6709; 3&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#xFF0C;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x4E0D;&#x540C;&#xFF0C;&#x539F;&#x5B50;&#x6027;&#x7684;&#x4FDD;&#x8BC1;&#x4E5F;&#x4E0D;&#x4E00;&#x6837;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/a855d0a1f1b23895889e00b51173370d3f21c28522df5800a121e6d0684d123c" alt="&#x56FE;&#x7247;"></p>
<h2 id="&#x5355;&#x673A;&#x90E8;&#x7F72;"><a href="#&#x5355;&#x673A;&#x90E8;&#x7F72;" class="headerlink" title="&#x5355;&#x673A;&#x90E8;&#x7F72;"></a>&#x5355;&#x673A;&#x90E8;&#x7F72;</h2><p>&#x4E0D;&#x7BA1; Lua&#x811A;&#x672C;&#x4E2D;&#x64CD;&#x4F5C;&#x7684; key&#x662F;&#x4E0D;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF0C;&#x90FD;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</p>
<h2 id="&#x4E3B;&#x4ECE;&#x90E8;&#x7F72;"><a href="#&#x4E3B;&#x4ECE;&#x90E8;&#x7F72;" class="headerlink" title="&#x4E3B;&#x4ECE;&#x90E8;&#x7F72;"></a>&#x4E3B;&#x4ECE;&#x90E8;&#x7F72;</h2><p>Redis &#x4E3B;&#x4ECE;&#x590D;&#x5236;&#x662F;&#x7528;&#x4E8E;&#x5C06;&#x4E3B;&#x8282;&#x70B9;&#x7684;&#x6570;&#x636E;&#x540C;&#x6B65;&#x5230;&#x4ECE;&#x8282;&#x70B9;&#xFF0C;&#x4EE5;&#x4FDD;&#x6301;&#x6570;&#x636E;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x3002;&#x800C;Redis&#x7684;&#x6240;&#x6709;&#x5199;&#x64CD;&#x4F5C;&#x90FD;&#x5728;&#x4E3B;&#x8282;&#x70B9;&#x4E0A;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4E0D;&#x7BA1; Lua&#x811A;&#x672C;&#x4E2D;&#x64CD;&#x4F5C;&#x7684; key&#x662F;&#x4E0D;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF0C;&#x90FD;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF1A;&#x5F53;&#x4E3B;&#x8282;&#x70B9;&#x6267;&#x884C;&#x5199;&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x4ECE;&#x8282;&#x70B9;&#x4F1A;&#x5F02;&#x6B65;&#x5730;&#x590D;&#x5236;&#x8FD9;&#x4E9B;&#x5199;&#x64CD;&#x4F5C;&#x3002;&#x5728;&#x8FD9;&#x4E2A;&#x590D;&#x5236;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4ECE;&#x8282;&#x70B9;&#x7684;&#x6570;&#x636E;&#x53EF;&#x80FD;&#x4E0E;&#x4E3B;&#x8282;&#x70B9;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x5EF6;&#x8FDF;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x5728; Lua &#x811A;&#x672C;&#x4E2D;&#x5305;&#x542B;&#x8BFB;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x4E14;&#x8BE5;&#x811A;&#x672C;&#x5728;&#x4E3B;&#x8282;&#x70B9;&#x4E0A;&#x6267;&#x884C;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x8BFB;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x5728;&#x4ECE;&#x8282;&#x70B9;&#x4E0A;&#x6267;&#x884C;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x8BFB;&#x5230;&#x7A0D;&#x6709;&#x5EF6;&#x8FDF;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<h2 id="Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;"><a href="#Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;" class="headerlink" title="Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;"></a>Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;</h2><p>&#x5982;&#x679C; Lua&#x811A;&#x672C;&#x64CD;&#x4F5C;&#x7684; key&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF0C;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</p>
<p>&#x5982;&#x679C;&#x64CD;&#x4F5C;&#x7684; Key&#x4E0D;&#x76F8;&#x540C;&#xFF0C;&#x53EF;&#x80FD;&#x88AB; hash &#x5230;&#x4E0D;&#x540C;&#x7684; slot&#xFF0C;&#x4E5F;&#x53EF;&#x80FD; hash &#x5230;&#x76F8;&#x540C;&#x7684; slot&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4E00;&#x5B9A;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x5728; Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#x4F7F;&#x7528; Lua&#x811A;&#x672C;&#x65F6;&#x4E00;&#x5B9A;&#x8981;&#x6CE8;&#x610F;&#xFF1A;Lua&#x811A;&#x672C;&#x4E2D;&#x64CD;&#x4F5C;&#x7684;&#x662F;&#x540C;&#x4E00;&#x4E2A; Key&#xFF1B;</p>
<h2 id="&#x539F;&#x5B50;&#x6027;&#x4FDD;&#x8BC1;"><a href="#&#x539F;&#x5B50;&#x6027;&#x4FDD;&#x8BC1;" class="headerlink" title="&#x539F;&#x5B50;&#x6027;&#x4FDD;&#x8BC1;"></a>&#x539F;&#x5B50;&#x6027;&#x4FDD;&#x8BC1;</h2><p>&#x8FD9;&#x91CC;&#x4EE5; Redis&#x5355;&#x673A;&#x90E8;&#x7F72;&#x4E3A;&#x4F8B;&#xFF1A;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5E26;&#x6709; Lua&#x811A;&#x672C;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;Redis&#x4F1A;&#x628A;&#x8BE5;&#x811A;&#x672C;&#x5F53;&#x4F5C;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#xFF0C;&#x7136;&#x540E;&#x52A0;&#x8F7D;&#x5230;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x4E3A; Redis&#x8BFB;&#x5199;&#x547D;&#x4EE4;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#x64CD;&#x4F5C;&#xFF08;&#x5173;&#x4E8E; Redis&#x7684;&#x5355;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x548C;&#x591A;&#x8DEF;&#x590D;&#x7528;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x4F1A;&#x5728;&#x5176;&#x4ED6;&#x7684;&#x6587;&#x7AE0;&#x4E2D;&#x8BB2;&#x89E3;&#xFF09;&#xFF0C;&#x6700;&#x7EC8;&#xFF0C;Lua&#x811A;&#x672C;&#x7684;&#x8BFB;&#x5199;&#x5728; Redis&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x5730;&#x62BD;&#x8C61;&#x6210;&#x4E0B;&#x56FE;&#xFF0C;&#x6240;&#x6709;&#x7684; Lua&#x811A;&#x672C;&#x4F1A;&#x6309;&#x7167;&#x8FDB;&#x5165;&#x987A;&#x5E8F;&#x653E;&#x5165;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x4E32;&#x884C;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4FDD;&#x8BC1;&#x6BCF;&#x4E2A; Lua&#x4E0D;&#x4F1A;&#x88AB;&#x5176;&#x4ED6;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x6253;&#x65AD;&#xFF0C;&#x4ECE;&#x800C;&#x4FDD;&#x8BC1;&#x4E86;&#x539F;&#x5B50;&#x6027;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/377f39667c64a83e273a7f7acee52c0980d98fb877a033a2101d2c339525fb8b" alt="&#x56FE;&#x7247;"></p>
<h2 id="&#x4E94;&#x3001;&#x9762;&#x8BD5;&#x8BE5;&#x5982;&#x4F55;&#x56DE;&#x7B54;&#xFF1F;"><a href="#&#x4E94;&#x3001;&#x9762;&#x8BD5;&#x8BE5;&#x5982;&#x4F55;&#x56DE;&#x7B54;&#xFF1F;" class="headerlink" title="&#x4E94;&#x3001;&#x9762;&#x8BD5;&#x8BE5;&#x5982;&#x4F55;&#x56DE;&#x7B54;&#xFF1F;"></a>&#x4E94;&#x3001;&#x9762;&#x8BD5;&#x8BE5;&#x5982;&#x4F55;&#x56DE;&#x7B54;&#xFF1F;</h2><p>&#x5728;&#x9762;&#x8BD5;&#x4E2D;&#xFF0C;Redis &#x6267;&#x884C; Lua&#x811A;&#x672C;&#x65F6;&#xFF0C;&#x80FD;&#x5426;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5982;&#x4F55;&#x4F5C;&#x7B54;&#xFF1F;</p>
<ol>
<li>&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x9700;&#x8981;&#x89E3;&#x91CA;&#x8FD9;&#x91CC;&#x7684;&#x539F;&#x5B50;&#x6027;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5B83;&#x548C;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x4E8B;&#x52A1; ACID&#x4E2D;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x7684;&#x5DEE;&#x5F02;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x6D88;&#x9664;&#x539F;&#x5B50;&#x6027;&#x5728;&#x5177;&#x4F53;&#x8F7D;&#x4F53;&#xFF08;RDBMS/NoSQL&#xFF09;&#x4E0A;&#x6982;&#x5FF5;&#x7684;&#x5DEE;&#x5F02;&#xFF1B;</li>
<li>&#x7B2C;&#x4E8C;&#x6B65;&#xFF0C;&#x9700;&#x8981;&#x89E3;&#x91CA; Redis&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x8BF4;&#x660E; RDBMS/NoSQL &#x5728;&#x4E8B;&#x52A1;&#x4E0A;&#x7684;&#x5DEE;&#x5F02;&#x70B9;&#xFF1B;</li>
<li>&#x7B2C;&#x4E09;&#x6B65;&#xFF0C;&#x9700;&#x8981;&#x89E3;&#x91CA; Redis&#x5728;&#x4E0D;&#x540C;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x4E0B;&#x539F;&#x5B50;&#x6027;&#x80FD;&#x5426;&#x4FDD;&#x8BC1;&#x3002;Redis&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x6709;3&#x79CD;&#xFF1A;&#x5355;&#x673A;&#x90E8;&#x7F72;&#xFF0C;&#x4E3B;&#x4ECE;&#x90E8;&#x7F72;&#xFF0C;Cluster&#x96C6;&#x7FA4;&#x90E8;&#x7F72;&#xFF0C;&#x9700;&#x8981;&#x8BF4;&#x660E;&#x5728;&#x54EA;&#x4E9B;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x4E0B;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF0C;&#x54EA;&#x4E9B;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</li>
<li>&#x7B2C;&#x56DB;&#x6B65;&#xFF0C;&#x89E3;&#x91CA; Redis &#x6267;&#x884C; Lua&#x811A;&#x672C;&#x662F;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF1B;</li>
<li>&#x7B2C;&#x4E94;&#x6B65;&#xFF0C;&#x5206;&#x6790;&#x4E0B; Redis&#x7684;&#x5355;&#x7EBF;&#x7A0B;&#x6A21;&#x578B; &#x548C; IO&#x591A;&#x8DEF;&#x590D;&#x7528;&#x6A21;&#x578B;&#xFF08;&#x52A0;&#x5206;&#x9879;&#xFF09;&#xFF0C;&#x8FD9;&#x6B65;&#x662F;&#x53EF;&#x9009;&#x9879;&#xFF1B;</li>
</ol>
<h2 id="&#x516D;&#x3001;Why-Lua&#xFF1F;"><a href="#&#x516D;&#x3001;Why-Lua&#xFF1F;" class="headerlink" title="&#x516D;&#x3001;Why Lua&#xFF1F;"></a>&#x516D;&#x3001;Why Lua&#xFF1F;</h2><p>&#x65E2;&#x7136; Redis&#x4E8B;&#x52A1;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x9700;&#x8981; Lua&#x811A;&#x672C;&#x5462;&#xFF1F;</p>
<ol>
<li>Lua &#x662F;&#x4E00;&#x79CD;&#x5D4C;&#x5165;&#x5F0F;&#x8BED;&#x8A00;&#xFF0C;&#x662F; Redis&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x7684;&#x811A;&#x672C;&#x8BED;&#x8A00;&#xFF1B;</li>
<li>Lua &#x811A;&#x672C;&#x4E00;&#x822C;&#x6BD4; MULTI/EXEC &#x66F4;&#x5FEB;&#x3001;&#x66F4;&#x7B80;&#x5355;&#xFF1B;</li>
<li>Redis &#x4E8B;&#x52A1;&#x4E2D;&#xFF0C;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x547D;&#x4EE4;&#x90FD;&#x5FC5;&#x987B;&#x5728; EXEC&#x547D;&#x4EE4;&#x6267;&#x884C;&#x624D;&#x4F1A;&#x88AB;&#x6267;&#x884C;&#xFF0C;&#x5BF9;&#x4E8E;&#x591A;&#x4E2A;&#x547D;&#x4EE4;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#xFF0C;&#x6BD4;&#x5982;&#x540E;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E0A;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x7ED3;&#x679C;&#x7684;&#x573A;&#x666F;&#xFF0C;Redis&#x4E8B;&#x52A1;&#x65E0;&#x6CD5;&#x6EE1;&#x8DB3;&#xFF0C;&#x56E0;&#x6B64; Lua &#x811A;&#x672C;&#x66F4;&#x9002;&#x5408;&#x590D;&#x6742;&#x7684;&#x573A;&#x666F;&#xFF1B;</li>
<li>Redis &#x4E8B;&#x52A1;&#x80FD;&#x505A;&#x7684; Lua&#x80FD;&#x505A;&#xFF0C;Redis&#x4E8B;&#x52A1;&#x505A;&#x4E0D;&#x5230;&#x7684; Lua&#x4E5F;&#x80FD;&#x505A;&#xFF1B;</li>
</ol>
<h2 id="&#x4E03;&#x3001;Lua&#x6CE8;&#x610F;&#x4E8B;&#x9879;"><a href="#&#x4E03;&#x3001;Lua&#x6CE8;&#x610F;&#x4E8B;&#x9879;" class="headerlink" title="&#x4E03;&#x3001;Lua&#x6CE8;&#x610F;&#x4E8B;&#x9879;"></a>&#x4E03;&#x3001;Lua&#x6CE8;&#x610F;&#x4E8B;&#x9879;</h2><p>Redis&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x65F6;&#xFF0C;Lua&#x7684;&#x7F16;&#x5199;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x70B9;&#xFF1A;</p>
<ol>
<li>&#x4E0D;&#x8981;&#x5728; Lua&#x811A;&#x672C;&#x4E2D;&#x4F7F;&#x7528;&#x963B;&#x585E;&#x547D;&#x4EE4;&#xFF08;&#x5982;BLPOP&#x3001;BRPOP&#x7B49;&#xFF09;&#x3002;&#x56E0;&#x6B64;&#x8FD9;&#x4E9B;&#x547D;&#x4EE4;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4; Redis&#x670D;&#x52A1;&#x5668;&#x5728;&#x6267;&#x884C;&#x811A;&#x672C;&#x671F;&#x95F4;&#x88AB;&#x963B;&#x585E;&#xFF0C;&#x65E0;&#x6CD5;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x8BF7;&#x6C42;&#xFF1B;</li>
<li>&#x4E0D;&#x8981;&#x7F16;&#x5199;&#x8FC7;&#x957F;&#x7684; Lua&#x811A;&#x672C;&#x3002;&#x56E0;&#x4E3A; Redis&#x8BFB;&#x5199;&#x547D;&#x4EE4;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF0C;&#x8FC7;&#x957F;&#x7684;&#x811A;&#x672C;&#xFF0C;&#x52A0;&#x8F7D;&#xFF0C;&#x89E3;&#x6790;&#xFF0C;&#x8FD0;&#x884C;&#x4F1A;&#x6BD4;&#x8F83;&#x8017;&#x65F6;&#xFF0C;&#x5BFC;&#x81F4;&#x5176;&#x4ED6;&#x547D;&#x4EE4;&#x7684;&#x5EF6;&#x8FDF;&#x5EF6;&#x8FDF;&#x589E;&#x52A0;&#xFF1B;</li>
<li>&#x4E0D;&#x8981;&#x5728; Lua&#x811A;&#x672C;&#x4E2D;&#x8FDB;&#x884C;&#x590D;&#x6742;&#x8017;&#x65F6;&#x7684;&#x903B;&#x8F91;&#xFF1B;&#x56E0;&#x4E3A; Redis&#x8BFB;&#x5199;&#x547D;&#x4EE4;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#x7684;&#xFF0C;&#x957F;&#x65F6;&#x95F4;&#x8FD0;&#x884C;&#x811A;&#x672C;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x5176;&#x4ED6;&#x547D;&#x4EE4;&#x7684;&#x5EF6;&#x8FDF;&#x589E;&#x52A0;&#xFF1B;</li>
<li>Lua&#x811A;&#x672C;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x533A;&#x5206; redis.call() &#x548C; redis.pcall() &#x547D;&#x4EE4;&#xFF1B;</li>
<li>Lua &#x7D22;&#x5F15;&#x8868;&#x4ECE;&#x7D22;&#x5F15; 1 &#x5F00;&#x59CB;&#xFF0C;&#x800C;&#x4E0D;&#x662F; 0&#xFF1B;</li>
</ol>
<h2 id="&#x516B;&#x3001;&#x603B;&#x7ED3;"><a href="#&#x516B;&#x3001;&#x603B;&#x7ED3;" class="headerlink" title="&#x516B;&#x3001;&#x603B;&#x7ED3;"></a>&#x516B;&#x3001;&#x603B;&#x7ED3;</h2><ul>
<li>&#x539F;&#x5B50;&#x6027;&#x9700;&#x8981;&#x533A;&#x5206;&#x5177;&#x4F53;&#x4F7F;&#x7528;&#x7684;&#x8F7D;&#x4F53;&#xFF0C;&#x5728;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#xFF08;&#x6BD4;&#x5982; MySQL)&#xFF09;&#x548C; No SQL&#xFF08;&#x6BD4;&#x5982;Redis&#xFF09;&#x4E2D;&#xFF0C;&#x539F;&#x5B50;&#x6027;&#x7684;&#x6982;&#x5FF5;&#x662F;&#x4E0D;&#x76F8;&#x540C;&#x7684;&#xFF1B;</li>
<li>Redis&#x7684;&#x4E8B;&#x52A1;&#xFF08;MULTI/ESXEC&#xFF09;&#x548C;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#xFF08;&#x6BD4;&#x5982; MySQL&#xFF09;&#x7684;&#x4E8B;&#x52A1;&#xFF08;ACID&#xFF09;&#x4E5F;&#x662F;&#x4E0D;&#x76F8;&#x540C;&#x7684;&#xFF1B;</li>
<li>ACID&#x7684;&#x539F;&#x5B50;&#x6027;&#x6307;&#xFF1A;&#x547D;&#x4EE4;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x6267;&#x884C;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x4E0D;&#x6267;&#x884C;&#xFF1B;</li>
<li>Redis&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x7684;&#x539F;&#x5B50;&#x6027;&#x6307;&#xFF1A;Lua&#x811A;&#x672C;&#x4F1A;&#x5F53;&#x4F5C;&#x4E00;&#x4E2A;&#x6574;&#x4F53;&#x88AB;&#x6267;&#x884C;&#x4E14;&#x4E0D;&#x88AB;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x6253;&#x65AD;&#xFF0C;&#x4F46;&#x662F; Lua &#x811A;&#x672C;&#x91CC;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x65E0;&#x6CD5;&#x4FDD;&#x8BC1;&#x201C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x6267;&#x884C;&#xFF0C;&#x8981;&#x4E48;&#x5168;&#x90E8;&#x4E0D;&#x6267;&#x884C;&#x201D;&#xFF1B;</li>
<li>Lua&#x811A;&#x672C;&#x4F7F;&#x7528; redis.pcall() &#x6267;&#x884C;&#x547D;&#x4EE4;&#x51FA;&#x9519;&#x65F6;&#x4F1A;&#x88AB;catch&#xFF0C;&#x540E;&#x7EED;&#x547D;&#x4EE4;&#x4F1A;&#x6B63;&#x5E38;&#x6267;&#x884C;&#xFF1B;</li>
<li>Lua&#x811A;&#x672C;&#x4F7F;&#x7528; redis.call() &#x6267;&#x884C;&#x547D;&#x4EE4;&#x51FA;&#x9519;&#x65F6;&#x4F1A;&#x629B;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x540E;&#x7EED;&#x547D;&#x4EE4;&#x4F1A;&#x88AB;&#x963B;&#x65AD;&#xFF1B;</li>
<li>Lua &#x811A;&#x672C;&#x4E00;&#x822C;&#x6BD4; MULTI/EXEC &#x66F4;&#x5FEB;&#x3001;&#x66F4;&#x7B80;&#x5355;&#xFF1B;</li>
<li>Redis&#x7684;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x51B3;&#x5B9A;&#x4E86; Redis&#x6267;&#x884C; Lua&#x811A;&#x672C;&#x662F;&#x5426;&#x80FD;&#x4FDD;&#x8BC1;&#x539F;&#x5B50;&#x6027;&#xFF0C;&#x7F16;&#x5199; Lua&#x811A;&#x672C;&#x65F6;&#xFF0C;&#x7279;&#x522B;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x5728;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4E2D;&#x662F;&#x5426;&#x8981;&#x6C42;&#x64CD;&#x4F5C;&#x540C;&#x4E00;&#x4E2A; key&#xFF1B;</li>
</ul>
<h2 id="&#x4E5D;&#x3001;&#x53C2;&#x8003;&#x8D44;&#x6599;"><a href="#&#x4E5D;&#x3001;&#x53C2;&#x8003;&#x8D44;&#x6599;" class="headerlink" title="&#x4E5D;&#x3001;&#x53C2;&#x8003;&#x8D44;&#x6599;"></a>&#x4E5D;&#x3001;&#x53C2;&#x8003;&#x8D44;&#x6599;</h2><p>Scripting with Lua&#xFF1A;<a href="/external_links/da33af706e1e0384cec274f1e840a23f.html" target="blank" rel="noopener">redis.io/docs/intera&#x2026;</a></p>
<p>Atomicity with Lua&#xFF1A;<a href="/external_links/659f13706ac279684483fbdf518bf089.html" target="blank" rel="noopener">developer.redis.com/develop/jav&#x2026;</a></p>
<p>Redis Transactions&#xFF1A;<a href="/external_links/43c2e4bdb37bf6c38b713c132ce08293.html" target="blank" rel="noopener">redis.io/docs/intera&#x2026;</a></p>
<p>The Programming Language Lua&#xFF1A;<a href="/external_links/d4eae30a9ecd0455aeb7074f95c0026c.html" target="blank" rel="noopener">www.lua.org/</a></p>
<h2 id="&#x5341;&#x3001;&#x6E29;&#x99A8;&#x63D0;&#x793A;"><a href="#&#x5341;&#x3001;&#x6E29;&#x99A8;&#x63D0;&#x793A;" class="headerlink" title="&#x5341;&#x3001;&#x6E29;&#x99A8;&#x63D0;&#x793A;"></a>&#x5341;&#x3001;&#x6E29;&#x99A8;&#x63D0;&#x793A;</h2><ul>
<li>&#x672C;&#x6587;&#x57FA;&#x4E8E; Redis&#x670D;&#x52A1;&#x5668;&#x7248;&#x672C;&#x4E3A;7.0.4&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x53EF;&#x80FD;&#x7565;&#x6709;&#x5DEE;&#x5F02;&#xFF1B;</li>
<li>&#x672C;&#x6587;&#x6240;&#x6709;&#x793A;&#x4F8B;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x5355;&#x673A;&#x73AF;&#x5883;&#x8FD0;&#x884C;&#xFF1B;</li>
<li>Redis&#x7684;&#x547D;&#x4EE4;&#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#xFF0C;&#x4F46;&#x662F; Key &#x548C; Value &#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#xFF1B;</li>
</ul>
<p>&#x5982;&#x679C;&#x4F60;&#x53D1;&#x73B0;&#x6587;&#x7AE0;&#x4E2D;&#x5B58;&#x5728;&#x7F3A;&#x70B9;&#x548C;&#x9519;&#x8BEF;&#xFF0C;&#x6B22;&#x8FCE;&#x6279;&#x8BC4;&#x6307;&#x6B63;&#x3002;&#x5982;&#x679C;&#x4F60;&#x89C9;&#x5F97;&#x6587;&#x7AE0;&#x5BF9;&#x4F60;&#x6709;&#x5E2E;&#x52A9;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF0C;&#x70B9;&#x8D5E;&#xFF0C;&#x8BC4;&#x8BBA;&#xFF0C;&#x6216;&#x8005;&#x8F6C;&#x53D1;&#x7ED9;&#x66F4;&#x591A;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#xFF0C;&#x83B7;&#x53D6;&#x66F4;&#x591A;&#x5E72;&#x8D27;&#x8D44;&#x6599;&#x79C1;&#x4FE1;&#x6211;&#x3002;</p>
<h5 id="&#x539F;&#x521B;&#x597D;&#x6587;&#xFF1A;"><a href="#&#x539F;&#x521B;&#x597D;&#x6587;&#xFF1A;" class="headerlink" title="&#x539F;&#x521B;&#x597D;&#x6587;&#xFF1A;"></a>&#x539F;&#x521B;&#x597D;&#x6587;&#xFF1A;</h5><ul>
<li><a href="/external_links/d4ed9a63d427c52885152a52d6627010.html" target="blank" rel="noopener">&#x7F8E;&#x56E2;&#x4E00;&#x9762;&#xFF1A;Git &#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF1F;(&#x63A8;&#x8350;&#x9605;&#x8BFB;&#xFF09;</a></li>
<li><a href="/external_links/41e2b46ff276cec76014cd7cc2469f8f.html" target="blank" rel="noopener">&#x5F53;&#x4E0B;&#x73AF;&#x5883;&#xFF0C;&#x7A0B;&#x5E8F;&#x5458;&#x9700;&#x8981;&#x4FEE;&#x70BC;&#x7684; 3&#x9879;&#x6280;&#x80FD;</a></li>
<li><a href="/external_links/878269604046ef1921c58cbdd70d4bf7.html" target="blank" rel="noopener">AI&#x662F;&#x6253;&#x5DE5;&#x4EBA;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x5C31;&#x4E1A;&#x98CE;&#x53E3;&#x5417;?</a></li>
<li><a href="/external_links/8fc88688c3a589e46f39a82386a3b10e.html" target="blank" rel="noopener">&#x548C;&#x65AF;&#x5766;&#x798F;&#x535A;&#x58EB;&#x5199;&#x4EE3;&#x7801;&#x7684;&#x4E00;&#x4E2A;&#x6708;</a></li>
<li><a href="/external_links/7312650ae8295b9c156ebfd76075e17a.html" target="blank" rel="noopener">&#x809D;&#x4E86;&#x4E00;&#x5468;&#xFF0C;&#x8FD9;&#x4E0B;&#x5F7B;&#x5E95;&#x628A; MySQL&#x7684;&#x9501;&#x641E;&#x61C2;&#x4E86;</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/9969c9554e98948f7ba98137477080b9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7339709247750242355.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7339709247750242355.html" itemprop="url">一次线上Xxl-Job定时任务调度失败的排查与解决 问题 调</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-26T14:55:33+08:00">
                2024-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x95EE;&#x9898;"><a href="#&#x95EE;&#x9898;" class="headerlink" title="&#x95EE;&#x9898;"></a>&#x95EE;&#x9898;</h1><p><strong>&#x573A;&#x666F;</strong>&#xFF1A;&#x6BCF;&#x9694;&#x4E00;&#x5206;&#x949F;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;<br><strong>&#x73B0;&#x8C61;</strong>&#xFF1A;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x5EA6;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x5EA6;<strong>&#x5FC5;&#x4F1A;&#x5931;&#x8D25;</strong>&#x3002;&#x4F46;&#x662F;&#x7B49;&#x5F85;&#x7B2C;&#x4E09;&#x6B21;&#x8C03;&#x5EA6;&#x540E;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;<strong>&#x5374;&#x662F;&#x7B2C;&#x4E09;&#x6B21;&#x8C03;&#x5EA6;</strong>&#x7684;&#x65F6;&#x95F4;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/46e29915a414c58b224dcdb26e9c7424ab3cdbabdc9fb241091bc2bf08835149" alt="image.png"><br>&#x5947;&#x602A;&#x7684;&#x662F;&#xFF0C;&#x53EA;&#x6709;&#x6BCF;&#x9694;&#x4E00;&#x5206;&#x949F;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x7684;&#x4EFB;&#x52A1;&#x624D;&#x4F1A;&#x8FD9;&#x6837;&#xFF0C;&#x5176;&#x4ED6;&#x95F4;&#x9694;&#x4E00;&#x79D2;&#x6216;&#x8005;&#x4E00;&#x5C0F;&#x65F6;&#x7684;&#x53C8;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;<br>&#x67D0;&#x6B21;&#x8C03;&#x5EA6;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/74c68d742c9a35f9ea1952af67564d6ddb12983a609dc40e4c41dfb367813204" alt="image.png"></p>
<h1 id="&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x8C03;&#x5EA6;&#x539F;&#x7406;"><a href="#&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x8C03;&#x5EA6;&#x539F;&#x7406;" class="headerlink" title="&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x8C03;&#x5EA6;&#x539F;&#x7406;"></a>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x8C03;&#x5EA6;&#x539F;&#x7406;</h1><blockquote>
<p>&#x7EBF;&#x4E0A;xxl-job&#x7248;&#x672C;&#xFF1A;2.2.0-SNAPSHOT</p>
</blockquote>
<p>&#x5728;&#x6392;&#x67E5;&#x539F;&#x56E0;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x7248;&#x672C;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5BF9;&#x4EFB;&#x52A1;&#x7684;&#x8C03;&#x5EA6;&#x4EE5;&#x53CA;&#x6267;&#x884C;&#x6709;&#x4E86;&#x4E00;&#x4E9B;&#x4E86;&#x89E3;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9d652178e4dfa167f6dc55bd5a3ed10e2f41a32cdf15303049e1000c36453559" alt="image.png"><br>&#x6267;&#x884C;&#x5668;&#x5185;&#x90E8;&#x4F1A;&#x5F00;&#x542F;&#x4E00;&#x4E2A;http&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7528;&#x4E8E;&#x63A5;&#x53D7;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x3002;&#x6BCF;&#x6B21;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x90FD;&#x4F1A;&#x590D;&#x7528;Http&#x8FDE;&#x63A5;&#xFF0C;&#x907F;&#x514D;&#x591A;&#x6B21;&#x8FDE;&#x63A5;&#x6D88;&#x8017;&#x8D44;&#x6E90;&#x3002;<br>&#x8C03;&#x5EA6;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x4ECE;&#x8FDE;&#x63A5;&#x6C60;&#x4E2D;&#x83B7;&#x53D6;&#x8FDE;&#x63A5;</li>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x53D1;&#x9001;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#xFF08;&#x5E26;&#x6709;<strong>RequestId</strong>&#xFF0C;<strong>JobLogId</strong>&#xFF09;&#xFF0C;&#x5E76;&#x963B;&#x585E;&#x7EBF;&#x7A0B;&#x7B49;&#x5F85;&#x6267;&#x884C;&#x5668;&#x54CD;&#x5E94;</li>
<li>&#x6267;&#x884C;&#x5668;&#x8FD4;&#x56DE;&#x8C03;&#x5EA6;&#x54CD;&#x5E94;&#xFF0C;&#x5E76;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</li>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x6536;&#x5230;&#x8C03;&#x5EA6;&#x54CD;&#x5E94;&#xFF0C;&#x6839;&#x636E;&#x56DE;&#x4F20;&#x7684;<strong>RequestId</strong>&#xFF0C;&#x56DE;&#x5199;&#x6570;&#x636E;&#x5E93;&#x8C03;&#x53D6;&#x72B6;&#x6001;&#x3002;</li>
<li>&#x6267;&#x884C;&#x5668;&#x6267;&#x884C;&#x4EFB;&#x52A1;&#x540E;&#xFF0C;&#x56DE;&#x8C03;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x66F4;&#x65B0;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x72B6;&#x6001;&#x63A5;&#x53E3;&#xFF0C;&#x6839;&#x636E;<strong>JobLogId</strong>&#x56DE;&#x5199;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;&#x3002;</li>
</ol>
<h1 id="&#x6839;&#x636E;&#x5F02;&#x5E38;&#x5806;&#x8F7D;&#x5B9A;&#x4F4D;&#x95EE;&#x9898;"><a href="#&#x6839;&#x636E;&#x5F02;&#x5E38;&#x5806;&#x8F7D;&#x5B9A;&#x4F4D;&#x95EE;&#x9898;" class="headerlink" title="&#x6839;&#x636E;&#x5F02;&#x5E38;&#x5806;&#x8F7D;&#x5B9A;&#x4F4D;&#x95EE;&#x9898;"></a>&#x6839;&#x636E;&#x5F02;&#x5E38;&#x5806;&#x8F7D;&#x5B9A;&#x4F4D;&#x95EE;&#x9898;</h1><p>&#x6839;&#x636E;&#x5F02;&#x5E38;&#x5806;&#x6808;<code>XxlRpcFutureResponse.java:117</code>&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x4F4D;&#x4E8E;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x540E;&#xFF0C;&#x4ECE;Future&#x83B7;&#x53D6;&#x5F02;&#x6B65;&#x7ED3;&#x679C;&#x7684;get&#x65B9;&#x6CD5;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/fbe2df9ba6d1125d6f80e711f24fa09178f8172aa56e1bdb8ec941ecbc424089" alt="image.png"><br>futureResponse&#x7684;get&#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x662F;<strong>&#x4F11;&#x7720;&#x8C03;&#x5EA6;&#x7EBF;&#x7A0B;</strong>&#xFF08;&#x9ED8;&#x8BA4;&#x4F11;&#x7720;1&#x79D2;&#xFF09;&#xFF0C;&#x7B49;&#x5F85;&#x6267;&#x884C;&#x5668;&#x54CD;&#x5E94;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x3002;&#x7EBF;&#x7A0B;&#x88AB;&#x5524;&#x9192;&#x540E;&#x53BB;&#x68C0;&#x67E5;&#x672C;&#x6B21;&#x8C03;&#x5EA6;&#x662F;&#x5426;&#x5B8C;&#x6210;&#xFF0C;&#x8981;&#x662F;&#x6CA1;&#x6709;&#x5B8C;&#x6210;&#xFF0C;&#x5C31;&#x629B;&#x51FA;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x7684;&#x9519;&#x8BEF;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/5cae64badedbbff247722d4bf89db7816aa1c941c5cf3da721b2696cda9b7808" alt="image.png"><br>&#x4ECE;&#x4E0A;&#x9762;&#x903B;&#x8F91;&#x53EF;&#x4EE5;&#x63A8;&#x65AD;&#x51FA;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x662F;<strong>&#x6210;&#x529F;&#x53D1;&#x9001;&#x8C03;&#x7528;&#x8BF7;&#x6C42;</strong>&#x51FA;&#x53BB;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x6267;&#x884C;&#x5668;<strong>&#x6CA1;&#x6709;&#x54CD;&#x5E94;</strong>&#x5BFC;&#x81F4;&#x7684;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x9519;&#x8BEF;&#x3002;<br>&#x90A3;&#x4E48;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6267;&#x884C;&#x5668;&#x6CA1;&#x6709;&#x54CD;&#x5E94;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x5C31;&#x5F97;&#x53BB;&#x770B;&#x770B;&#x6267;&#x884C;&#x5668;&#x90A3;&#x8FB9;&#x7684;&#x60C5;&#x51B5;&#x4E86;&#x3002;</p>
<hr>
<p>&#x7531;&#x4E8E;xxl-job&#x4E2D;&#x5904;&#x7406;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x7684;Netty&#x5904;&#x7406;&#x5668;&#x5E76;&#x6CA1;&#x6709;&#x6253;&#x5370;&#x5177;&#x4F53;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8981;&#x4F7F;&#x7528;<strong>Arthas</strong>&#x6765;&#x89C2;&#x5BDF;Netty&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x7684;&#x6267;&#x884C;&#x60C5;&#x51B5;&#x4E86;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e38c821dbfe0ce4953745dc7a2d99c0fd46e2783b2bdd04736c68c6f1ccc4b39" alt="image.png"></p>
<h1 id="&#x4F7F;&#x7528;Arthas&#x89C2;&#x5BDF;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x6267;&#x884C;&#x60C5;&#x51B5;"><a href="#&#x4F7F;&#x7528;Arthas&#x89C2;&#x5BDF;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x6267;&#x884C;&#x60C5;&#x51B5;" class="headerlink" title="&#x4F7F;&#x7528;Arthas&#x89C2;&#x5BDF;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x6267;&#x884C;&#x60C5;&#x51B5;"></a>&#x4F7F;&#x7528;Arthas&#x89C2;&#x5BDF;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x6267;&#x884C;&#x60C5;&#x51B5;</h1><p>&#x4F7F;&#x7528;arthas&#x7684;watch&#x547D;&#x4EE4;&#x89C2;&#x5BDF;&#x6267;&#x884C;&#x5668;&#x63A5;&#x6536;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x60C5;&#x51B5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;watch com.xxl.rpc.remoting.net.impl.netty_http.server.NettyHttpServerHandler channelRead0 &apos;{params}&apos; -x 2</span><br></pre></td></tr></table></figure>

<h2 id="&#x5206;&#x6790;&#x65E5;&#x5FD7;"><a href="#&#x5206;&#x6790;&#x65E5;&#x5FD7;" class="headerlink" title="&#x5206;&#x6790;&#x65E5;&#x5FD7;"></a>&#x5206;&#x6790;&#x65E5;&#x5FD7;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a317821e506c9a2b834451b8513d4be513489eaa02e7a22fc37fd67852136a6b" alt="image.png"><br>&#x6574;&#x7406;&#x4E00;&#x4E0B;&#x65E5;&#x5FD7;&#xFF0C;&#x5728;&#x95EE;&#x9898;&#x4EA7;&#x751F;&#x7684;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x5185;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x8FD9;&#x8FB9;&#x7684;Netty&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x5668;&#x53EA;&#x6536;&#x5230;&#x4E86;&#x4E09;&#x4E2A;&#x8BF7;&#x6C42;</p>
<table>
<thead>
<tr>
<th>&#x65F6;&#x95F4;&#x70B9;</th>
<th>channel&#x8FDC;&#x7A0B;&#x5730;&#x5740;&#x4FE1;&#x606F;</th>
<th>&#x8BF7;&#x6C42;&#x4FE1;&#x606F;</th>
</tr>
</thead>
<tbody><tr>
<td>18:02:00</td>
<td>R:/127.0.0.6:41163</td>
<td>POST / HTTP/1.1;content-length: 626</td>
</tr>
<tr>
<td>18:02:30</td>
<td>R:/127.0.0.6:41163</td>
<td>POST / HTTP/1.1;content-length: 159</td>
</tr>
<tr>
<td>18:04:00</td>
<td>R:/127.0.0.6:52551</td>
<td>POST / HTTP/1.1;content-length: 626</td>
</tr>
</tbody></table>
<p>&#x8C03;&#x7528;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x70B9;&#x6BD4;&#x8F83;&#x5947;&#x602A;</p>
<ol>
<li><strong>18:02:30&#x6536;&#x5230;&#x4E86;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;</strong></li>
</ol>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x70B9;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6536;&#x5230;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x7684;&#x5462;&#xFF1F;&#x800C;&#x4E14;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x8BF7;&#x6C42;&#x5927;&#x5C0F;&#x4E0E;&#x6B63;&#x5E38;&#x7684;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x7684;&#x5927;&#x5C0F;&#x8FD8;&#x4E00;&#x6837;&#xFF0C;&#x4EC5;&#x6709;159&#x5B57;&#x8282;&#x3002;&#x8FD9;&#x4E48;&#x5C0F;&#x7684;&#x8BF7;&#x6C42;&#x4F53;&#xFF0C;&#x8BA9;&#x6211;&#x60F3;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x4E1C;&#x897F;&#xFF1A;<strong>&#x5FC3;&#x8DF3;&#x5305;</strong>&#x3002;<br>&#x5728;RPC&#x6846;&#x67B6;&#x4E2D;&#xFF0C;&#x4E3A;&#x4E86;&#x76D1;&#x6D4B;&#x901A;&#x4FE1;&#x901A;&#x9053;&#x7684;&#x6B63;&#x5E38;&#x4EE5;&#x53CA;&#x8282;&#x70B9;&#x7684;&#x5065;&#x5EB7;&#xFF0C;&#x4F1A;&#x5B9A;&#x65F6;&#x5411;&#x8282;&#x70B9;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5305;&#xFF0C;&#x7528;&#x4E8E;&#x5224;&#x65AD;&#x901A;&#x9053;&#x662F;&#x5426;&#x6B63;&#x5E38;&#x8FDE;&#x63A5;&#x3002;<br>&#x867D;&#x7136;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x4E0E;&#x6267;&#x884C;&#x5668;&#x7528;&#x7684;&#x662F;Http&#x8BF7;&#x6C42;&#xFF0C;&#x4F46;&#x662F;<code>xxl-job</code>&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x8D44;&#x6E90;&#x6D6A;&#x8D39;&#xFF0C;&#x4F7F;&#x7528;&#x4E86;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;&#x4E8E;&#x662F;&#x4E5F;&#x5F15;&#x5165;&#x4E86;&#x5FC3;&#x8DF3;&#x76D1;&#x6D4B;&#x3002;&#x5F53;&#x901A;&#x9053;&#x5728;30&#x79D2;&#x5185;&#x6CA1;&#x6709;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x5C31;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/8b2fd3532d537fd84248b36df0dca42612d44b247faa06990d0f113b366770fe" alt="image.png"><br>&#x5728;&#x6267;&#x884C;&#x5668;&#x4E5F;&#x80FD;&#x770B;&#x5230;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x7684;&#x65E5;&#x5FD7;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/884995201d3d59a366d733f33d72eb281593a3efab2da03d53495d2e497b87b5" alt="image.png"><br>&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x6709;&#x70B9;&#x5947;&#x602A;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x53EA;&#x5728;18:02:30&#x5206;&#x6536;&#x5230;&#x5462;&#xFF1F;18:03:30&#x6CA1;&#x6709;&#x6536;&#x5230;&#x5462;&#xFF1F;<br>&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5C31;&#x8DDF;&#x4E0B;&#x9762;&#x7684;&#x95EE;&#x9898;&#x6709;&#x6240;&#x5173;&#x8054;&#x4E86;&#x3002;</p>
<ol start="2">
<li><strong>channel&#x8FDC;&#x7A0B;&#x5730;&#x5740;&#x7684;IP&#x4E0D;&#x592A;&#x5BF9;&#x52B2;&#xFF0C;&#x5C45;&#x7136;&#x662F;&#x672C;&#x5730;&#x5730;&#x5740;&#x5E76;&#x975E;&#x662F;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x7684;&#x5730;&#x5740;</strong></li>
</ol>
<p>&#x7ECF;&#x6211;&#x4E86;&#x89E3;&#x540E;&#xFF0C;&#x516C;&#x53F8;&#x7684;K8S&#x73AF;&#x5883;&#x4E2D;&#x5F15;&#x5165;&#x4E86;<code>Istio</code>&#x8FDB;&#x884C;&#x670D;&#x52A1;&#x6CBB;&#x7406;&#xFF0C;&#x5176;&#x4E2D;&#x8FDB;&#x51FA;Pod&#x7684;&#x6D41;&#x91CF;&#x90FD;&#x4F1A;&#x88AB;Envoy&#x4EE3;&#x7406;&#xFF0C;&#x6240;&#x4EE5;<code>127.0.0.6</code>&#x6B63;&#x662F;<strong>Envoy</strong>&#x7684;IP&#x5730;&#x5740;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0181dd02a783bcfaee162117f9ab7d499b519cfe688730538d04ca122ef4e432" alt="image.png"></p>
<blockquote>
<p>Envoy&#x662F;&#x4E00;&#x4E2A;&#x7531;Lyft&#x5F00;&#x53D1;&#x7684;&#x9AD8;&#x6027;&#x80FD;&#x3001;&#x53EF;&#x6269;&#x5C55;&#x7684;&#x4EE3;&#x7406;&#xFF08;Proxy&#xFF09;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;&#x5FAE;&#x670D;&#x52A1;&#x67B6;&#x6784;&#x4E2D;&#x7684;&#x7F51;&#x7EDC;&#x901A;&#x4FE1;&#x3002;&#x5B83;&#x88AB;&#x8BBE;&#x8BA1;&#x6210;&#x53EF;&#x7528;&#x4E8E;&#x591A;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x90E8;&#x7F72;&#x573A;&#x666F;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;&#x4E30;&#x5BCC;&#x7684;&#x529F;&#x80FD;&#x96C6;&#xFF0C;&#x5982;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3001;&#x6D41;&#x91CF;&#x8DEF;&#x7531;&#x3001;&#x6545;&#x969C;&#x6062;&#x590D;&#x3001;&#x5B89;&#x5168;&#x8BA4;&#x8BC1;&#x7B49;&#x3002;</p>
</blockquote>
<h2 id="&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;"><a href="#&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;" class="headerlink" title="&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;"></a>&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;</h2><p>&#x6536;&#x96C6;&#x65E5;&#x5FD7;&#x7684;&#x65F6;&#x95F4;&#x6BB5;&#x6B63;&#x597D;&#x5904;&#x4E8E;&#x95EE;&#x9898;&#x53D1;&#x751F;&#x7684;&#x4E00;&#x4E2A;&#x533A;&#x95F4;&#x5185;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x6BB5;&#x5185;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x60C5;&#x51B5;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0dfc5d12ff0206a066739f33d0c64c25a4a540a61402218e41ab4ad0f41ea319" alt="image.png"></p>
<ol>
<li>18:02&#x5206;&#x7684;&#x4EFB;&#x52A1;&#x6B63;&#x5E38;&#x8C03;&#x5EA6;&#x5E76;&#x6267;&#x884C;&#x6210;&#x529F;&#x4E86;&#x3002;</li>
<li>18:03&#x5206;&#x7684;&#x4EFB;&#x52A1;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x7684;&#x56DE;&#x586B;&#x662F;&#x7531;&#x6267;&#x884C;&#x5668;&#x9488;&#x5BF9;JobLogId&#x6765;&#x8FDB;&#x884C;&#x5339;&#x914D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x80FD;&#x5F97;&#x51FA;&#x4E00;&#x4E2A;&#x7ED3;&#x8BBA;03&#x5206;&#x53D1;&#x9001;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x5728;04&#x5206;&#x6536;&#x5230;&#x4E86;&#x5E76;&#x89E6;&#x53D1;&#x4E86;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x3002;</li>
<li>18:04&#x5206;&#x7684;&#x4EFB;&#x52A1;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#xFF0C;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x60C5;&#x51B5;&#x3002;</li>
</ol>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x622A;&#x81F3;&#x76EE;&#x524D;&#x80FD;&#x5F97;&#x5230;&#x7684;&#x4FE1;&#x606F;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;</p>
<ol>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x4F1A;&#x5728;&#x901A;&#x9053;30&#x79D2;&#x5185;&#x6CA1;&#x6709;&#x8BFB;&#x5199;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5411;&#x5404;&#x4E2A;&#x6267;&#x884C;&#x5668;&#x53D1;&#x9001;&#x4E00;&#x4E2A;<strong>&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;</strong>&#x3002;</li>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x53D1;&#x9001;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x540E;&#xFF0C;&#x540E;&#x7EED;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x90FD;<strong>&#x65E0;&#x6CD5;&#x8FDB;&#x5165;&#x6267;&#x884C;&#x5668;</strong>&#x4E2D;&#x3002;</li>
<li>&#x56E0;&#x4E3A;&#x6267;&#x884C;&#x5668;&#x670D;&#x52A1;&#x90E8;&#x7F72;&#x5728;K8S&#x4E2D;&#xFF0C;&#x800C;&#x4E14;K8S&#x4E2D;&#x5F15;&#x5165;&#x4E86;<code>Istio</code>&#xFF0C;&#x5BFC;&#x81F4;&#x8FDB;&#x5165;Pod&#x7684;&#x6D41;&#x91CF;&#x90FD;&#x4F1A;&#x88AB;<strong>Envoy&#x4EE3;&#x7406;</strong>&#x3002;</li>
<li>&#x8BE5;&#x95EE;&#x9898;&#x7684;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x5EA6;&#x867D;&#x7136;&#x5931;&#x8D25;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x4F1A;&#x5728;&#x7B2C;&#x4E09;&#x6B21;&#x8C03;&#x5EA6;&#x65F6;&#x88AB;&#x6267;&#x884C;&#x5668;&#x6210;&#x529F;&#x63A5;&#x6536;&#x5E76;&#x5904;&#x7406;&#x3002;</li>
</ol>
<p>&#x597D;&#x50CF;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7A81;&#x7834;&#x70B9;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x771F;&#x6B63;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x7684;&#x95EE;&#x9898;&#x3002;&#x4E0D;&#x8FC7;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7740;&#x91CD;&#x53BB;&#x770B;&#x770B;<strong>Envoy</strong>&#xFF0C;&#x56E0;&#x4E3A;&#x76EE;&#x524D;&#x8FDB;&#x5165;&#x5230;Pod&#x7684;&#x6D41;&#x91CF;&#x90FD;&#x4F1A;&#x88AB;&#x5B83;&#x7ED9;&#x4EE3;&#x7406;&#xFF0C;&#x53BB;&#x89C2;&#x5BDF;&#x4E00;&#x4E0B;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x53D1;&#x751F;&#x65F6;Envoy&#x7684;&#x65E5;&#x5FD7;&#x3002;</p>
<h1 id="Envoy&#x65E5;&#x5FD7;"><a href="#Envoy&#x65E5;&#x5FD7;" class="headerlink" title="Envoy&#x65E5;&#x5FD7;"></a>Envoy&#x65E5;&#x5FD7;</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;[2024-02-21T18:02:00.026Z] &quot;POST / HTTP/1.1&quot; 200 - via_upstream - &quot;-&quot; 626 176 1 0 &quot;-&quot; &quot;-&quot; &quot;d9313e61-6530-4c08-aae2-fd864930ea31&quot; &quot;ebc-portal.ebc-bpm.svc.cluster.local&quot; &quot;10.64.195.45:7666&quot; inbound|7666|| 127.0.0.6:48733 10.64.195.45:7666 10.64.217.207:45584 - default</span><br><span class="line">[2024-02-21T18:02:30.055Z] &quot;POST / HTTP/1.1&quot; 503 UC upstream_reset_before_response_started{connection_termination} - &quot;-&quot; 159 95 90031 - &quot;-&quot; &quot;-&quot; &quot;3de88bd6-41cf-4078-a381-3542b460dd90&quot; &quot;ebc-portal.ebc-bpm.svc.cluster.local&quot; &quot;10.64.195.45:7666&quot; inbound|7666|| 127.0.0.6:48733 10.64.195.45:7666 10.64.217.207:45584 - default</span><br><span class="line">[2024-02-21T18:04:00.087Z] &quot;POST / HTTP/1.1&quot; 200 - via_upstream - &quot;-&quot; 626 176 1 0 &quot;-&quot; &quot;-&quot; &quot;25dac8f9-8364-42bd-8fdd-d08285ed1632&quot; &quot;ebc-portal.ebc-bpm.svc.cluster.local&quot; &quot;10.64.195.45:7666&quot; inbound|7666|| 127.0.0.6:39739 10.64.195.45:7666 10.64.217.207:45584 - default</span><br><span class="line">[2024-02-21T18:04:00.088Z] &quot;POST / HTTP/1.1&quot; 0 DC downstream_remote_disconnect - &quot;-&quot; 159 0 1 - &quot;-&quot; &quot;-&quot; &quot;bfa7dcee-123f-4582-9368-84edcb8476c7&quot; &quot;ebc-portal.ebc-bpm.svc.cluster.local&quot; &quot;10.64.195.45:7666&quot; inbound|7666|| 127.0.0.6:39739 10.64.195.45:7666 10.64.217.207:45584 - default</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x6BD4;&#x8F83;&#x5F02;&#x5E38;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x6709;&#x4E24;&#x6BB5;&#x5206;&#x522B;&#x662F;18:02:30&#x4EE5;&#x53CA;&#x7B2C;&#x4E8C;&#x4E2A;18:04:00&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x54CD;&#x5E94;&#x7801;&#x90FD;&#x4E0D;&#x662F;&#x6B63;&#x5E38;&#x7684;<code>200</code>&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x5F02;&#x5E38;&#x7684;&#x539F;&#x56E0;&#x3002;</p>
<h2 id="&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E00;"><a href="#&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E00;" class="headerlink" title="&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E00;"></a>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E00;</h2><blockquote>
<p>[2024-02-21T18:02:30.055Z] &#x201C;POST / HTTP/1.1&#x201D; 503 UC upstream_reset_before_response_started{connection_termination} - &#x201C;-&#x201C; 159 95 90031 - &#x201C;-&#x201C; &#x201C;-&#x201C; &#x201C;3de88bd6-41cf-4078-a381-3542b460dd90&#x201D; &#x201C;ebc-portal.ebc-bpm.svc.cluster.local&#x201D; &#x201C;10.64.195.45:7666&#x201D; inbound|7666|| 127.0.0.6:48733 10.64.195.45:7666 10.64.217.207:45584 - default</p>
</blockquote>
<p>&#x63D0;&#x53D6;&#x4E00;&#x4E0B;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x65E5;&#x5FD7;&#x7FFB;&#x8BD1;&#x4E00;&#x4E0B;&#x3002;</p>
<ul>
<li>&#x201C;2024-02-21T18:02:30&#x201D;&#xFF1A;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;Envoy&#x65F6;&#x95F4;</li>
<li>&#x201C;503&#x201D; &#x672C;&#x6B21;&#x8BF7;&#x6C42;&#x6700;&#x7EC8;&#x7684;&#x54CD;&#x5E94;&#x7801;</li>
<li>&#x201C;UC upstream_reset_before_response_started{connection_termination}&#x201D;&#xFF1A;<code>UC</code>&#x4EE3;&#x8868;<strong>Upstream Connection</strong>&#xFF0C;&#x4E0A;&#x6E38;&#x670D;&#x52A1;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x4FE1;&#x606F;&#x4E3A;&#x4E0A;&#x6E38;&#x670D;&#x52A1;&#x5728;&#x54CD;&#x5E94;&#x4E4B;&#x524D;&#x91CD;&#x7F6E;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;<strong>&#x8FDE;&#x63A5;&#x88AB;&#x7EC8;&#x6B62;</strong>&#x4E86;&#x3002;</li>
<li>&#x201C;159 95 90031 -&#x201C;&#xFF1A;159&#x662F;&#x8BF7;&#x6C42;&#x4F53;&#x5927;&#x5C0F;&#xFF0C;&#x8BF4;&#x660E;&#x662F;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#xFF1B;95&#x662F;&#x54CD;&#x5E94;&#x4F53;&#x5927;&#x5C0F;&#xFF1B;90031&#x662F;&#x8BF7;&#x6C42;&#x4ECE; Envoy &#x5230;&#x76EE;&#x6807;&#x670D;&#x52A1;&#x7684;&#x6301;&#x7EED;&#x65F6;&#x95F4;</li>
</ul>
<p>&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#x6BD4;&#x8F83;&#x5F02;&#x5E38;&#x7684;&#x70B9;&#x6709;&#x4E09;&#x4E2A;&#xFF1A;</p>
<ol>
<li><strong>&#x8FD4;&#x56DE;&#x4E86;</strong><code>503</code><strong>&#x54CD;&#x5E94;&#x7801;</strong></li>
</ol>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x8FD4;&#x56DE;503&#x54CD;&#x5E94;&#x7801;&#x5462;&#xFF1F;&#x6211;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x6267;&#x884C;&#x5668;&#x7684;Netty&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x5668;&#x4E2D;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;503&#x72B6;&#x6001;&#x7801;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;503&#x54CD;&#x5E94;&#x7801;&#x5C31;&#x53EF;&#x80FD;&#x662F;Envoy&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7684;&#x3002;<br>&#x6211;&#x4FEE;&#x6539;&#x4E86;&#x4E00;&#x4E0B;Envoy&#x65E5;&#x5FD7;&#x7B49;&#x7EA7;&#xFF0C;&#x627E;&#x5230;&#x672C;&#x6B21;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;Debug&#x7B49;&#x7EA7;&#x7684;&#x65E5;&#x5FD7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;2024-02-21T18:02:30.846361Z debug envoy router [C32432][S12678816626782510759] cluster &apos;inbound|7666||&apos; match for URL &apos;/&apos;</span><br><span class="line">2024-02-21T18:02:30.846396Z debug envoy router [C32432][S12678816626782510759] router decoding headers:</span><br><span class="line">&apos;:authority&apos;, &apos;ebc-portal.ebc-bpm.svc.cluster.local&apos;</span><br><span class="line">&apos;:path&apos;, &apos;/&apos;</span><br><span class="line">&apos;:method&apos;, &apos;POST&apos;</span><br><span class="line">&apos;:scheme&apos;, &apos;http&apos;</span><br><span class="line">&apos;content-length&apos;, &apos;159&apos;</span><br><span class="line">&apos;x-forwarded-proto&apos;, &apos;http&apos;</span><br><span class="line">&apos;x-request-id&apos;, &apos;ab261a30-679c-403d-be2b-12b161810f28&apos;</span><br><span class="line">2024-02-21T18:02:30.846434Z debug envoy router [C32432][S12678816626782510759] pool ready</span><br><span class="line">2024-02-21T18:02:30.846469Z debug envoy http [C32432][S12678816626782510759] request end stream</span><br><span class="line">2024-02-21T18:04:00.877035Z debug envoy router [C32432][S12678816626782510759] upstream reset: reset reason: connection termination, transport failure reason:</span><br><span class="line">2024-02-21T18:04:00.877095Z debug envoy http [C32432][S12678816626782510759] Sending local reply with details upstream_reset_before_response_started{connection_termination}</span><br><span class="line">2024-02-21T18:04:00.877148Z debug envoy http [C32432][S12678816626782510759] encoding headers via codec (end_stream=false):</span><br><span class="line">&apos;:status&apos;, &apos;503&apos;</span><br><span class="line">&apos;content-length&apos;, &apos;95&apos;</span><br><span class="line">&apos;content-type&apos;, &apos;text/plain&apos;</span><br><span class="line">&apos;date&apos;, &apos;Mon, 21 Feb 2024 18:04:00 GMT&apos;</span><br><span class="line">&apos;server&apos;, &apos;istio-envoy&apos;</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x8FD9;&#x884C;&#x65E5;&#x5FD7;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;</p>
<blockquote>
<p>Sending local reply with details upstream_reset_before_response_started{connection_termination}</p>
</blockquote>
<p>&#x672C;&#x6B21;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x4ECE;<code>18:02:30</code>&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#xFF0C;<code>18:04:00</code>Envoy&#x53D1;&#x73B0;&#x4E0A;&#x6E38;&#x670D;&#x52A1;&#x5668;&#x8FDE;&#x63A5;&#x7EC8;&#x6B62;&#xFF0C;&#x4E8E;&#x662F;&#x81EA;&#x5DF1;&#x6784;&#x9020;&#x4E86;&#x4E00;&#x4E2A;<code>503</code>&#x54CD;&#x5E94;&#x7801;&#x7684;&#x54CD;&#x5E94;&#x4F53;&#x8FD4;&#x56DE;&#x7ED9;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x3002;</p>
<ol start="2">
<li><strong>&#x8BF7;&#x6C42;&#x65F6;&#x95F4;90031&#x6BEB;&#x79D2;</strong></li>
</ol>
<p>&#x672C;&#x6B21;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;&#x592A;&#x957F;&#x4E86;&#xFF0C;&#x627E;&#x4E86;&#x4E00;&#x4E0B;&#x6267;&#x884C;&#x5668;&#x4E2D;Netty&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x5668;&#x5BF9;&#x4E8E;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x53D1;&#x73B0;<code>xxl-job</code>&#x5728;&#x8FD9;&#x4E2A;&#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x662F;<strong>&#x4E0D;&#x4F1A;&#x5BF9;&#x5FC3;&#x8DF3;&#x505A;&#x4EFB;&#x4F55;&#x5904;&#x7406;</strong>&#x7684;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/60de4ed4e6f3629832b3b7cafa3b481280b0e68ea6552d816e36d7952553ec66" alt="image.png"><br>&#x5BFC;&#x81F4;&#x4E00;&#x76F4;&#x4E0D;&#x4F1A;&#x8FD4;&#x56DE;Http&#x54CD;&#x5E94;&#xFF0C;&#x800C;&#x4E14;&#x5728;Envoy&#x4E2D;&#x8981;&#x662F;&#x6CA1;&#x6709;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x6CA1;&#x6709;&#x6536;&#x5230;&#x54CD;&#x5E94;&#x7684;&#x8BDD;&#xFF0C;&#x4F1A;&#x8BA4;&#x4E3A;&#x8BE5;&#x8BF7;&#x6C42;&#x4ECD;&#x5728;&#x5904;&#x7406;&#x4E2D;&#x7684;&#x3002;&#x76F4;&#x5230;&#x8FBE;&#x5230;Envoy&#x7684;&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x624D;&#x4F1A;&#x53D6;&#x6D88;&#x8FD9;&#x6B21;&#x8BF7;&#x6C42;&#x3002;</p>
<ol start="3">
<li><strong>&#x4E0A;&#x6E38;&#x670D;&#x52A1;&#x7EC8;&#x6B62;&#x4E86;&#x8FDE;&#x63A5;</strong></li>
</ol>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x70B9;<code>2024-02-21T18:04:00</code>&#x6267;&#x884C;&#x5668;&#x4E2D;&#x6253;&#x5370;&#x4E86;&#x4E00;&#x884C;&#x65E5;&#x5FD7;&#xFF0C;&#x63D0;&#x793A;&#x6267;&#x884C;&#x5668;&#x5173;&#x95ED;&#x4E86;&#x7A7A;&#x95F2;&#x8FDE;&#x63A5;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/4e56ddebd4f494e50df4f9c3714a8073191872c454f714a636960af763bee2ec" alt="image.png"><br>&#x627E;&#x4E86;&#x4E00;&#x4E0B;&#x8BE5;&#x884C;&#x65E5;&#x5FD7;&#x5728;&#x6E90;&#x7801;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x7684;&#x524D;&#x63D0;&#x662F;90&#x79D2;&#x5185;&#x901A;&#x9053;<strong>&#x6CA1;&#x6709;&#x8FDB;&#x884C;&#x8BFB;&#x5199;</strong>&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;&#x5668;&#x89C9;&#x5F97;&#x8BE5;&#x8FDE;&#x63A5;&#x901A;&#x9053;&#x5DF2;&#x7ECF;&#x5F02;&#x5E38;&#x4E86;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;Envoy&#x4F1A;&#x63D0;&#x793A;&#x4E0A;&#x6E38;&#x670D;&#x52A1;&#x7EC8;&#x6B62;&#x4E86;&#x8FDE;&#x63A5;&#x7684;&#x539F;&#x56E0;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e6a63c93545b16a49b3bf2022bb28b91e07bf8ff8084ae603f3b541485d7a2ff" alt="image.png"></p>
<h2 id="&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E8C;"><a href="#&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E8C;" class="headerlink" title="&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E8C;"></a>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E8C;</h2><blockquote>
<p>[2024-02-21T18:04:00.088Z] &#x201C;POST / HTTP/1.1&#x201D; 0 DC downstream_remote_disconnect - &#x201C;-&#x201C; 159 0 1 - &#x201C;-&#x201C; &#x201C;-&#x201C; &#x201C;bfa7dcee-123f-4582-9368-84edcb8476c7&#x201D; &#x201C;ebc-portal.ebc-bpm.svc.cluster.local&#x201D; &#x201C;10.64.195.45:7666&#x201D; inbound|7666|| 127.0.0.6:39739 10.64.195.45:7666 10.64.217.207:45584 - default</p>
</blockquote>
<ul>
<li>&#x201C;2024-02-21T18:04:00&#x201D;&#xFF1A;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;Envoy&#x65F6;&#x95F4;</li>
<li>&#x201C;0&#x201D;&#xFF1A;&#x672C;&#x6B21;&#x8BF7;&#x6C42;&#x6700;&#x7EC8;&#x7684;&#x54CD;&#x5E94;&#x7801;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x672C;&#x6B21;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x7684;&#x8BF7;&#x6C42;&#x5E76;&#x6CA1;&#x6709;&#x5B8C;&#x6210;</li>
<li>&#x201C;DC downstream_remote_disconnect&#x201D;&#xFF1A;<code>DC</code>&#x4EE3;&#x8868;<strong>Downstream Connection</strong>&#xFF0C;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x4FE1;&#x606F;&#x4E3A;<strong>&#x4E0B;&#x6E38;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x7EC8;&#x6B62;&#x4E86;&#x8FDE;&#x63A5;</strong>&#x3002;</li>
<li>&#x201C;159 0 1 - &#x201C;&#xFF1A;159&#x662F;&#x8BF7;&#x6C42;&#x4F53;&#x5927;&#x5C0F;&#xFF0C;&#x8BF4;&#x660E;&#x662F;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#xFF1B;0&#x662F;&#x54CD;&#x5E94;&#x4F53;&#x5927;&#x5C0F;&#xFF1B;1&#x662F;&#x8BF7;&#x6C42;&#x4ECE; Envoy &#x5230;&#x76EE;&#x6807;&#x670D;&#x52A1;&#x7684;&#x6301;&#x7EED;&#x65F6;&#x95F4;&#x3002;</li>
</ul>
<p>&#x5728;&#x8FD9;&#x884C;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x6307;&#x7684;&#x6B63;&#x662F;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#xFF0C;&#x6B64;&#x523B;&#x67E5;&#x770B;&#x4E00;&#x4E0B;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x6253;&#x5370;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x629B;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;<code>XxlRpcException</code>&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x4ECE;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x6536;&#x5230;&#x4E86;&#x4E00;&#x4E2A;<strong>&#x65E0;&#x6548;&#x54CD;&#x5E94;&#x7801;</strong>&#x5BFC;&#x81F4;&#x7684;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/837e1ccb79e06233a08ca2f4bc535c12dcc4188272d1c0d22598fd940ea84ec5" alt="image.png"><br>&#x7167;&#x846B;&#x82A6;&#x753B;&#x74E2;&#xFF0C;&#x6211;&#x4E5F;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x4F4D;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x4F4D;&#x7F6E;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a034e9595862a445807f1626c63c485e82f1e23fc6b3f1a86b4b2c8b21fb2483" alt="output.png"><br>&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x7684;&#x629B;&#x51FA;&#x662F;&#x7531;&#x4E8E;&#x6267;&#x884C;&#x5668;&#x8FD4;&#x56DE;&#x4E86;&#x975E;<code>200</code>&#x72B6;&#x6001;&#x7801;&#x7684;&#x54CD;&#x5E94;&#xFF0C;&#x7ED3;&#x5408;<strong>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x4E00;</strong>&#x4E2D;Envoy&#x751F;&#x6210;&#x7684;<code>503</code>&#x54CD;&#x5E94;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x63A8;&#x65AD;&#x51FA;&#xFF0C;&#x6B63;&#x662F;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;<code>503</code>&#x54CD;&#x5E94;&#xFF0C;&#x5BFC;&#x81F4;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x5173;&#x95ED;&#x4E86;&#x4E0E;&#x6267;&#x884C;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x901A;&#x9053;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x8BE5;&#x8FDE;&#x63A5;&#x901A;&#x9053;&#x662F;&#x4E0E;<strong>Pod&#x4E2D;Envoy</strong>&#x7684;&#x8FDE;&#x63A5;&#x901A;&#x9053;&#x3002;</p>
<h1 id="&#x539F;&#x56E0;"><a href="#&#x539F;&#x56E0;" class="headerlink" title="&#x539F;&#x56E0;"></a>&#x539F;&#x56E0;</h1><p>&#x7ECF;&#x8FC7;&#x4E86;&#x4E0A;&#x9762;&#x5BF9;&#x4E8E;&#x8BE5;&#x95EE;&#x9898;&#x7684;&#x7EC6;&#x81F4;&#x5206;&#x6790;&#x6392;&#x67E5;&#xFF0C;&#x7EC8;&#x4E8E;&#x627E;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4EA7;&#x751F;&#x7684;&#x539F;&#x56E0;&#x4E86;&#x3002;<br>&#x7531;&#x4E8E;&#x8BE5;&#x7248;&#x672C;<code>xxl-job</code>&#x5728;Http&#x534F;&#x8BAE;&#x4E0B;&#x7684;RPC&#x8C03;&#x7528;&#x4E2D;&#xFF0C;<strong>&#x7F3A;&#x5C11;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x7684;&#x54CD;&#x5E94;</strong>&#x5BFC;&#x81F4;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x4E24;&#x4E2A;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x6D41;&#x7A0B;&#x88AB;Envoy&#x7ED9;&#x4EE3;&#x7406;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4EA7;&#x751F;&#x4E86;&#x8BE5;&#x95EE;&#x9898;&#x3002;<br>&#x670D;&#x52A1;&#x8FC1;&#x79FB;&#x81F3;K8S&#x540E;&#xFF0C;&#x5F15;&#x8FDB;&#x4E86;Istio&#x670D;&#x52A1;&#x6CBB;&#x7406;&#xFF0C;&#x7ED9;&#x6BCF;&#x4E2A;Pod&#x90FD;&#x5BFC;&#x5165;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x5BB9;&#x5668;Envoy&#xFF0C;&#x7528;&#x4E8E;&#x4EE3;&#x7406;&#x8FDB;&#x51FA;Pod&#x7684;&#x6D41;&#x91CF;&#x3002;<br>Envoy&#x5728;&#x8F6C;&#x53D1;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5230;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x540E;&#xFF0C;&#x4F1A;&#x7B49;&#x5F85;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x4E0A;&#x6709;&#x591A;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x4F1A;&#x88AB;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x5230;&#x524D;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x54CD;&#x5E94;&#x8FD4;&#x56DE;&#x3002;&#x5E76;&#x4E14;&#x7531;&#x4E8E;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;<strong>&#x4F7F;&#x7528;&#x8FDE;&#x63A5;&#x6C60;</strong>&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;&#x90FD;<strong>&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;</strong>&#xFF0C;&#x5C31;&#x4F1A;&#x5BFC;&#x81F4;&#x8BF7;&#x6C42;&#x5728;Envoy&#x963B;&#x585E;&#x4E86;&#x3002;<br>&#x5F53;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x8BE5;&#x8BF7;&#x6C42;&#x88AB;Envoy&#x8F6C;&#x53D1;&#x7ED9;&#x6267;&#x884C;&#x5668;&#x540E;&#xFF0C;Envoy&#x4F1A;&#x7B49;&#x5F85;&#x6267;&#x884C;&#x5668;&#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x7ED3;&#x679C;&#x3002;&#x7531;&#x4E8E;&#x6267;&#x884C;&#x5668;&#x6536;&#x5230;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;<strong>&#x4E0D;&#x4F1A;&#x8FDB;&#x884C;&#x4EFB;&#x4F55;&#x64CD;&#x4F5C;</strong>&#xFF0C;&#x5BFC;&#x81F4;Envoy&#x4E2D;&#x5FC3;&#x4F1A;&#x4E00;&#x76F4;&#x7B49;&#x5F85;&#x5FC3;&#x8DF3;&#x54CD;&#x5E94;&#xFF0C;<strong>&#x963B;&#x585E;</strong>&#x540E;&#x7EED;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x3002;<br>&#x7531;&#x4E8E;Envoy&#x963B;&#x585E;&#x4E86;&#x540E;&#x7EED;&#x6B63;&#x5E38;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#xFF0C;&#x5BFC;&#x81F4;&#x6267;&#x884C;&#x5668;&#x4E0E;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x7684;&#x8FDE;&#x63A5;&#x5728;90S&#x5185;&#x6CA1;&#x6709;<strong>&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;</strong>&#xFF0C;&#x4E8E;&#x662F;&#x6267;&#x884C;&#x5668;&#x5C31;&#x4F1A;&#x5C06;&#x8BE5;&#x8FDE;&#x63A5;&#x901A;&#x9053;&#x5173;&#x95ED;&#x3002;<br><strong>&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x8DEF;&#x5F84;&#xFF1A;</strong></p>
<ol>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x4E0E;&#x6267;&#x884C;&#x5668;&#x6B63;&#x5E38;&#x8FDE;&#x63A5;&#x3002;</li>
<li>&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x5EA6;&#xFF0C;&#x6210;&#x529F;&#x8C03;&#x5EA6;&#x5E76;&#x6267;&#x884C;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x3002;</li>
<li>&#x7ECF;&#x8FC7;30S&#x540E;&#xFF0C;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x5230;&#x6267;&#x884C;&#x5668;&#x3002;</li>
<li>Envoy&#x4EE3;&#x7406;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x5E76;&#x8F6C;&#x53D1;&#x5230;&#x6267;&#x884C;&#x5668;&#x3002;</li>
<li>&#x6267;&#x884C;&#x5668;&#x5FFD;&#x7565;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FD4;&#x56DE;Http&#x54CD;&#x5E94;&#x3002;&#x5BFC;&#x81F4;Envoy&#x963B;&#x585E;&#x672C;&#x6761;Http&#x8FDE;&#x63A5;&#xFF0C;&#x4EE5;&#x81F3;&#x4E8E;&#x540E;&#x7EED;&#x7684;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;&#x65E0;&#x6CD5;&#x8FDB;&#x5165;&#x6267;&#x884C;&#x5668;&#x3002;</li>
<li>&#x6267;&#x884C;&#x5668;90&#x79D2;&#x540E;&#x53D1;&#x73B0;&#x548C;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x7684;Http&#x8FDE;&#x63A5;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x4E8E;&#x662F;&#x5173;&#x95ED;&#x8BE5;&#x6761;Http&#x8FDE;&#x63A5;&#x3002;</li>
<li>Envoy&#x7B49;&#x5F85;&#x5FC3;&#x8DF3;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53D1;&#x73B0;&#x8F6C;&#x53D1;&#x7684;&#x8BF7;&#x6C42;&#x88AB;&#x5F02;&#x5E38;&#x5173;&#x95ED;&#xFF0C;&#x4E8E;&#x662F;&#x81EA;&#x5DF1;&#x6784;&#x9020;&#x4E86;&#x4E00;&#x4E2A;503&#x7684;&#x54CD;&#x5E94;&#x53D1;&#x9001;&#x7ED9;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x3002;&#x6784;&#x9020;&#x5B8C;503&#x54CD;&#x5E94;&#x540E;&#xFF0C;&#x6309;&#x987A;&#x5E8F;&#x5904;&#x7406;&#x8BE5;&#x901A;&#x9053;&#x540E;&#x7EED;&#x8BF7;&#x6C42;&#xFF0C;&#x6B64;&#x65F6;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x5EA6;&#x88AB;&#x8F6C;&#x53D1;&#x5230;&#x6267;&#x884C;&#x5668;&#x4E2D;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x5EA6;&#x88AB;&#x6267;&#x884C;&#x5668;&#x6B63;&#x5E38;&#x5904;&#x7406;&#x3002;</li>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x6536;&#x5230;503&#x7684;&#x54CD;&#x5E94;&#x540E;&#xFF0C;&#x5185;&#x90E8;Netty&#x7684;&#x5904;&#x7406;&#x5668;&#x4F1A;&#x629B;&#x51FA;&#x4E00;&#x4E2A;XxlRpcException&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x5BFC;&#x81F4;&#x5728;&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x4E5F;&#x4F1A;&#x5173;&#x95ED;&#x4E0E;&#x6267;&#x884C;&#x5668;&#x7684;http&#x8FDE;&#x63A5;&#xFF0C;&#x5BFC;&#x81F4;&#x7B2C;&#x4E09;&#x6B21;&#x8C03;&#x5EA6;&#x5931;&#x8D25;&#x3002;</li>
</ol>
<h1 id="&#x89E3;&#x51B3;&#x529E;&#x6CD5;"><a href="#&#x89E3;&#x51B3;&#x529E;&#x6CD5;" class="headerlink" title="&#x89E3;&#x51B3;&#x529E;&#x6CD5;"></a>&#x89E3;&#x51B3;&#x529E;&#x6CD5;</h1><p>&#x8BE5;&#x95EE;&#x9898;&#x7684;&#x6839;&#x56E0;&#x662F;&#x7531;&#x4E8E;&#x5728;&#x8BE5;&#x7248;&#x672C;<code>xxl-job</code>&#x5728;Http&#x534F;&#x8BAE;&#x4E0B;&#x7684;RPC&#x8C03;&#x7528;&#x4E2D;&#xFF0C;<strong>&#x7F3A;&#x5C11;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x7684;&#x54CD;&#x5E94;</strong>&#x5BFC;&#x81F4;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x4E24;&#x4E2A;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x6D41;&#x7A0B;&#x88AB;Envoy&#x7ED9;&#x4EE3;&#x7406;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4EA7;&#x751F;&#x4E86;&#x8BE5;&#x95EE;&#x9898;&#x3002;<br>&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x6709;&#x4E24;&#x4E2A;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x5728;&#x6267;&#x884C;&#x5668;&#x7AEF;&#x589E;&#x52A0;&#x5FC3;&#x8DF3;&#x8BF7;&#x6C42;&#x54CD;&#x5E94;</li>
<li>&#x8C03;&#x5EA6;&#x4E2D;&#x5FC3;&#x548C;&#x6267;&#x884C;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x6D41;&#x91CF;&#x4E0D;&#x518D;&#x7ECF;&#x8FC7;Envoy&#x4EE3;&#x7406;</li>
</ol>
<p>&#x7531;&#x4E8E;<code>xxl-job</code>&#x5728;&#x8BE5;&#x7248;&#x672C;&#x4E0B;&#x7684;<code>xxl-rpc</code>&#x5DF2;&#x7ECF;&#x4E24;&#x5E74;&#x6CA1;&#x6709;&#x66F4;&#x65B0;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x770B;&#x770B;&#x600E;&#x4E48;&#x5C06;&#x4E24;&#x4E2A;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x6D41;&#x91CF;&#x4E0D;&#x8D70;Envoy&#x4EE3;&#x7406;&#x3002;<br>&#x6B64;&#x65F6;Istio&#x670D;&#x52A1;&#x6CBB;&#x7406;&#x4E2D;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x89D2;&#x8272;<code>Sidecar</code>&#x51FA;&#x73B0;&#x4E86;&#x3002;</p>
<h2 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h2><blockquote>
<p>Sidecar&#x7684;&#x4F5C;&#x7528;&#xFF1A;<br>&#x53EF;&#x4EE5;&#x62E6;&#x622A;Pod&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5165;&#x53E3;&#x548C;&#x51FA;&#x53E3;&#x6D41;&#x91CF;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;Istio&#x7684;&#x8DEF;&#x7531;&#x89C4;&#x5219;&#x5C06;&#x6D41;&#x91CF;&#x8DEF;&#x7531;&#x5230;&#x6B63;&#x786E;&#x7684;&#x670D;&#x52A1;&#x3002;</p>
</blockquote>
<p>&#x5728;k8s&#x4E2D;&#x7684;<code>Istio</code>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>Sidecar</code>&#xFF0C;&#x8BBE;&#x7F6E;&#x8C03;&#x7528;&#x6267;&#x884C;&#x5668;xxl-job&#x7684;http&#x7AEF;&#x53E3;&#x7684;&#x6D41;&#x91CF;&#x4E0D;&#x7ECF;&#x8FC7;&#x4EFB;&#x4F55;<code>Istio</code>&#x529F;&#x80FD;&#x3002;<br>&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;apiVersion: networking.istio.io/v1beta1</span><br><span class="line">kind: Sidecar</span><br><span class="line">metadata:</span><br><span class="line">  name: direct-xxl-job-my-app</span><br><span class="line">  namespace: ebc-bpm</span><br><span class="line">spec:</span><br><span class="line">  # &#x5165;&#x53E3;&#x6D41;&#x91CF;&#x8BBE;&#x7F6E;</span><br><span class="line">  ingress:</span><br><span class="line">  # &#x76F4;&#x63A5;&#x8F6C;&#x53D1;&#x5230;Pod&#x5BB9;&#x5668;&#x7684;7679&#x63A5;&#x53E3;</span><br><span class="line">  - defaultEndpoint: 127.0.0.1:7679</span><br><span class="line">    port:</span><br><span class="line">      name: direct-access-port</span><br><span class="line">      number: 7679</span><br><span class="line">      protocol: TCP</span><br><span class="line">  # &#x5BF9;&#x5E94;&#x7684;&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;</span><br><span class="line">  workloadSelector:</span><br><span class="line">    labels:</span><br><span class="line">      app: my-app</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684;&#x8FD9;&#x4E2A;Sidecar&#x914D;&#x7F6E;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x5C06;&#x5E26;&#x6709;&#x6807;&#x7B7E;<code>app=my-app</code>&#x5E94;&#x7528;&#x7684;<strong>7679&#x7AEF;&#x53E3;TCP&#x5165;&#x53E3;&#x6D41;&#x91CF;</strong>&#x91CD;&#x5B9A;&#x5411;&#x5230;Pod&#x4E2D;&#x7684;<strong>7679&#x7AEF;&#x53E3;</strong>&#xFF0C;&#x4E0D;&#x518D;&#x7ECF;&#x8FC7;<code>Envoy</code>&#x7684;&#x4EE3;&#x7406;&#x3002;<br>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;K8S&#x73AF;&#x5883;&#x4E2D;&#xFF0C;&#x914D;&#x7F6E;Sidecar&#x6765;&#x63A7;&#x5236;&#x6D41;&#x91CF;&#x662F;&#x5426;&#x88AB;Enovy&#x4EE3;&#x7406;&#xFF0C;&#x5C31;&#x80FD;&#x6709;&#x6548;&#x7684;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4E86;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/192792911a11f4c8d4d1c7133811ade1.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7339416321908457481.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7339416321908457481.html" itemprop="url">Rust Web 框架入门和对比 最适合使用的 Rust W</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-26T10:50:45+08:00">
                2024-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2d0f81a938c7e92358157d61e064f93f5284a29870998d3f4c5f81e5d1fb031b" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<h1 id="&#x6700;&#x9002;&#x5408;&#x4F7F;&#x7528;&#x7684;-Rust-Web-&#x6846;&#x67B6;"><a href="#&#x6700;&#x9002;&#x5408;&#x4F7F;&#x7528;&#x7684;-Rust-Web-&#x6846;&#x67B6;" class="headerlink" title="&#x6700;&#x9002;&#x5408;&#x4F7F;&#x7528;&#x7684; Rust Web &#x6846;&#x67B6;"></a>&#x6700;&#x9002;&#x5408;&#x4F7F;&#x7528;&#x7684; Rust Web &#x6846;&#x67B6;</h1><p>&#x5728; Web &#x5F00;&#x53D1;&#x7684;&#x53D8;&#x5316;&#x7684;&#x6D6A;&#x6F6E;&#x4E2D;&#xFF0C;Rust &#x5DF2;&#x6210;&#x4E3A;&#x6784;&#x5EFA;&#x5B89;&#x5168;&#x548C;&#x9AD8;&#x6027;&#x80FD;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x9996;&#x9009;&#x8BED;&#x8A00;&#x3002;&#x968F;&#x7740; Rust &#x7684;&#x6D41;&#x884C;&#xFF0C;&#x4E00;&#x7CFB;&#x5217;&#x65E8;&#x5728;&#x5229;&#x7528;&#x5176;&#x4F18;&#x52BF;&#x7684; Web &#x6846;&#x67B6;&#x4E5F;&#x5728;&#x4E0D;&#x65AD;&#x51FA;&#x73B0;&#x3002;&#x672C;&#x6587;&#x6BD4;&#x8F83;&#x4E86;&#x4E00;&#x4E9B;&#x6700;&#x597D;&#x7684; Rust &#x6846;&#x67B6;&#xFF0C;&#x91CD;&#x70B9;&#x4ECB;&#x7ECD;&#x4E86;&#x5B83;&#x4EEC;&#x5404;&#x81EA;&#x7684;&#x4F18;&#x70B9;&#x548C;&#x7F3A;&#x70B9;&#xFF0C;&#x4EE5;&#x5E2E;&#x52A9;&#x60A8;&#x4E3A;&#x9879;&#x76EE;&#x505A;&#x51FA;&#x660E;&#x667A;&#x7684;&#x51B3;&#x7B56;&#x3002;&#x5B83;&#x8FD8;&#x9700;&#x8981;&#x7559;&#x5FC3;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x53EF;&#x80FD;&#x4F1A;&#x6539;&#x53D8;&#x6211;&#x4EEC;&#x5728; Rust &#x4E2D;&#x6784;&#x5EFA; Web &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x5927;&#x591A;&#x6570; Web &#x6846;&#x67B6;&#x4E4D;&#x4E00;&#x770B;&#x5728;&#x4F7F;&#x7528;&#x4E0A;&#x975E;&#x5E38;&#x76F8;&#x4F3C;&#xFF0C;&#x4F46;&#x5B9E;&#x9645;&#x5DEE;&#x5F02;&#x66F4;&#x52A0;&#x7EC6;&#x5FAE;&#x548C;&#x7410;&#x788E;&#x3002;&#x6211;&#x5E0C;&#x671B;&#x5F3A;&#x8C03;&#x6587;&#x672C;&#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x5DEE;&#x5F02;&#xFF0C;&#x4F46;&#x4E3A;&#x4E86;&#x8BA9;&#x60A8;&#x6709;&#x66F4;&#x597D;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x6211;&#x8FD8;&#x5C55;&#x793A;&#x4E86;&#x6BCF;&#x4E2A;&#x6846;&#x67B6;&#x7684;&#x793A;&#x4F8B;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x4E9B;&#x6846;&#x67B6;&#x7684;&#x4F5C;&#x7528;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x7B80;&#x5355;&#x7684; hello world&#x3002;&#x6240;&#x6709;&#x793A;&#x4F8B;&#x5747;&#x53D6;&#x81EA;&#x5404;&#x81EA;&#x7684; GitHub &#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x53E6;&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x4E2A;&#x5217;&#x8868;&#x7EDD;&#x4E0D;&#x662F;&#x8BE6;&#x5C3D;&#x7684;&#xFF0C;&#x6211;&#x80AF;&#x5B9A;&#x9519;&#x8FC7;&#x4E86;&#x4E00;&#x4E9B;&#x73B0;&#x6709;&#x7684;&#x6846;&#x67B6;&#x3002;&#x5982;&#x679C;&#x60A8;&#x60F3;&#x5305;&#x542B;&#x60A8;&#x6700;&#x559C;&#x6B22;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x8BF7;&#x5728; Twitter &#x6216; Mastodon &#x4E0A;&#x4E0E;&#x6211;&#x8054;&#x7CFB;&#x3002;</p>
<h2 id="&#x6D41;&#x884C;&#x7684;-Rust-&#x6846;&#x67B6;"><a href="#&#x6D41;&#x884C;&#x7684;-Rust-&#x6846;&#x67B6;" class="headerlink" title="&#x6D41;&#x884C;&#x7684; Rust &#x6846;&#x67B6;"></a>&#x6D41;&#x884C;&#x7684; Rust &#x6846;&#x67B6;</h2><h3 id="Axum"><a href="#Axum" class="headerlink" title="Axum"></a>Axum</h3><p>Axum &#x662F;&#x4E00;&#x4E2A;&#x5728; Rust &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x5177;&#x6709;&#x7279;&#x6B8A;&#x5730;&#x4F4D;&#x7684; Web &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6846;&#x67B6;&#x3002;&#x5B83;&#x662F; Tokio &#x9879;&#x76EE;&#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x8BE5;&#x9879;&#x76EE;&#x662F;&#x4F7F;&#x7528; Rust &#x7F16;&#x5199;&#x5F02;&#x6B65;&#x7F51;&#x7EDC;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x3002; Axum &#x4E0D;&#x4EC5;&#x4F7F;&#x7528; Tokio &#x4F5C;&#x4E3A;&#x5176;&#x5F02;&#x6B65;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x4E0E; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5176;&#x4ED6;&#x5E93;&#x96C6;&#x6210;&#xFF0C;&#x5229;&#x7528; Hyper &#x4F5C;&#x4E3A;&#x5176; HTTP &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5E76;&#x4F7F;&#x7528; Tower &#x4F5C;&#x4E3A;&#x4E2D;&#x95F4;&#x4EF6;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x5C31;&#x80FD;&#x591F;&#x91CD;&#x7528; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x73B0;&#x6709;&#x5E93;&#x548C;&#x5DE5;&#x5177;&#x3002;</p>
<p>Axum &#x8FD8;&#x81F4;&#x529B;&#x4E8E;&#x5728;&#x4E0D;&#x4F9D;&#x8D56;&#x5B8F;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x63D0;&#x4F9B;&#x4E00;&#x6D41;&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x4F53;&#x9A8C;&#xFF0C;&#x800C;&#x662F;&#x5229;&#x7528; Rust &#x7684;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x6765;&#x63D0;&#x4F9B;&#x5B89;&#x5168;&#x4E14;&#x7B26;&#x5408;&#x4EBA;&#x4F53;&#x5DE5;&#x7A0B;&#x5B66;&#x7684; API&#x3002;&#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x7279;&#x5F81;&#x6765;&#x5B9A;&#x4E49;&#x6846;&#x67B6;&#x7684;&#x6838;&#x5FC3;&#x62BD;&#x8C61;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x4F8B;&#x5982; <code>Handler</code> &#x7279;&#x5F81;&#xFF0C;&#x5B83;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x5141;&#x8BB8;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x8F7B;&#x677E;&#x5730;&#x4ECE;&#x8F83;&#x5C0F;&#x7684;&#x7EC4;&#x4EF6;&#x7EC4;&#x6210;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x8FD9;&#x4E9B;&#x7EC4;&#x4EF6;&#x53EF;&#x4EE5;&#x5728;&#x591A;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x91CD;&#x590D;&#x4F7F;&#x7528;&#x3002;</p>
<p>Axum &#x4E2D;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53D7;&#x8BF7;&#x6C42;&#x5E76;&#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E0E;&#x5176;&#x4ED6;&#x540E;&#x7AEF;&#x6846;&#x67B6;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x5229;&#x7528; Axum &#x7684; <code>FromRequest</code> trait&#xFF0C;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x5E94;&#x4ECE;&#x8BF7;&#x6C42;&#x4E2D;&#x63D0;&#x53D6;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x3002;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x9700;&#x8981;&#x5B9E;&#x73B0; <code>IntoResponse</code> trait&#xFF0C;&#x5E76;&#x4E14;&#x5DF2;&#x7ECF;&#x6709;&#x8BB8;&#x591A;&#x7C7B;&#x578B;&#x5B9E;&#x73B0;&#x4E86;&#x6B64;trait&#xFF0C;&#x5305;&#x62EC;&#x5141;&#x8BB8;&#x8F7B;&#x677E;&#x66F4;&#x6539;&#x7684;&#x5143;&#x7EC4;&#x7C7B;&#x578B;&#xFF0C;&#x4F8B;&#x5982;&#x54CD;&#x5E94;&#x7684;&#x72B6;&#x6001;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x66FE;&#x7ECF;&#x4F7F;&#x7528;&#x8FC7; Rust &#x7684;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x3001;&#x6CDB;&#x578B;&#xFF0C;&#x5C24;&#x5176;&#x662F;trait&#x4E2D;&#x7684;&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#xFF08;&#x6216;&#x66F4;&#x5177;&#x4F53;&#x5730;&#x8BF4;&#xFF1A;&#x8FD4;&#x56DE;&#x7684; <code>Future</code> &#xFF09;&#xFF0C;&#x60A8;&#x5C31;&#x4F1A;&#x77E5;&#x9053;&#x5F53;&#x60A8;&#x4E0D;&#x6EE1;&#x8DB3; trait &#x7EA6;&#x675F;(bound) &#x65F6;&#xFF0C;Rust &#x7684;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#x4F1A;&#x53D8;&#x5F97;&#x591A;&#x4E48;&#x590D;&#x6742;&#x3002;&#x5C24;&#x5176;&#x662F;&#x5F53;&#x60A8;&#x5C1D;&#x8BD5;&#x9002;&#x914D; &#x62BD;&#x8C61; trait &#x7EA6;&#x675F;(bound)&#x65F6;&#xFF0C;&#x7ECF;&#x5E38;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#xFF1A;&#x60A8;&#x4F1A;&#x770B;&#x5230;&#x4E00;&#x5835;&#x96BE;&#x4EE5;&#x7834;&#x8BD1;&#x7684;&#x6587;&#x672C;&#x5899;&#x3002;&#x6539;&#x53D8;&#x51E0;&#x884C;&#x7684;&#x987A;&#x5E8F;&#xFF0C;&#x5C31;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4F5C;&#x7528;&#x4E86;&#xFF01; Axum &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x8F85;&#x52A9;&#x5B8F;&#x7684;&#x5E93;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x9519;&#x8BEF;&#x5B9A;&#x4F4D;&#x5230;&#x5B9E;&#x9645;&#x53D1;&#x751F;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4ECE;&#x800C;&#x66F4;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#x51FA;&#x4E86;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x3002;</p>
<p>Axum &#x505A;&#x4E86;&#x5F88;&#x591A;&#x6B63;&#x786E;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x5E76;&#x4E14;&#x5F88;&#x5BB9;&#x6613;&#x542F;&#x52A8;&#x6267;&#x884C;&#x5927;&#x91CF;&#x64CD;&#x4F5C;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x4E9B;&#x4E8B;&#x9879;&#x3002;&#x8BE5;&#x7248;&#x672C;&#x4ECD;&#x4F4E;&#x4E8E; 1.0&#xFF0C;Axum &#x56E2;&#x961F;&#x53EF;&#x4EE5;&#x4ECE;&#x6839;&#x672C;&#x4E0A;&#x66F4;&#x6539;&#x7248;&#x672C;&#x4E4B;&#x95F4;&#x7684; API&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5D29;&#x6E83;&#x3002;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x8FD9;&#x5C31;&#x662F; 0.x &#x7248;&#x672C;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#xFF0C;&#x4F46;&#x6709;&#x4E9B;&#x66F4;&#x6539;&#x4F3C;&#x4E4E;&#x975E;&#x5E38;&#x5FAE;&#x5999;&#xFF0C;&#x4F46;&#x9700;&#x8981;&#x60A8;&#x5F00;&#x53D1;&#x4E00;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x601D;&#x7EF4;&#x6A21;&#x578B;&#x6765;&#x4E86;&#x89E3;&#x5E95;&#x5C42;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#x3002;&#x5982;&#x679C;&#x60A8;&#x5305;&#x542B;&#x4E00;&#x4E2A; <code>Timeout</code> &#x5C42;&#xFF08;&#x5185;&#x7F6E;&#x5728; Tower &#x4E2D;&#xFF09;&#xFF0C;&#x5B83;&#x5728;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x4E2D;&#x53EF;&#x4EE5;&#x8F7B;&#x677E;&#x5DE5;&#x4F5C;&#xFF0C;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x4E2D;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x6355;&#x83B7;&#x6240;&#x6709;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x4E2D;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7ED1;&#x5B9A;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x3002;&#x8FD9;&#x4E0D;&#x662F;&#x4EC0;&#x4E48;&#x5927;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x5F53;&#x60A8;&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x5DE5;&#x4F5C;&#x6216;&#x4F7F;&#x7528;&#x6700;&#x65B0;&#x7248;&#x672C;&#x542F;&#x52A8;&#x9879;&#x76EE;&#x5E76;&#x4E14;&#x4E8B;&#x60C5;&#x7A81;&#x7136;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x4EE4;&#x4EBA;&#x6CAE;&#x4E27;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x867D;&#x7136;&#x60A8;&#x80FD;&#x591F;&#x5229;&#x7528;&#x6574;&#x4E2A; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#xFF0C;&#x4F46;&#x6709;&#x65F6;&#x60A8;&#x9700;&#x8981;&#x5904;&#x7406;&#x7C98;&#x5408;&#x7C7B;&#x578B;&#x548C;&#x7279;&#x5F81;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x4F7F;&#x7528; Tokio &#x51FD;&#x6570;&#x3002;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x662F;&#x4F7F;&#x7528;&#x4EFB;&#x4F55;&#x4E0E;&#x6D41;&#x548C;&#xFF08;&#x7F51;&#x7EDC;&#xFF09;&#x5957;&#x63A5;&#x5B57;&#x76F8;&#x5173;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p>&#x597D;&#x7684;&#x4F8B;&#x5B50;&#x4F1A;&#x6709;&#x6240;&#x5E2E;&#x52A9;&#xFF0C;&#x4F46;&#x60A8;&#x9700;&#x8981;&#x6301;&#x7EED;&#x8DDF;&#x8E2A;&#x3002;</p>
<p>&#x5C3D;&#x7BA1;&#x5982;&#x6B64;&#xFF0C;Axum &#x662F;&#x6211;&#x4E2A;&#x4EBA;&#x6700;&#x559C;&#x6B22;&#x7684;&#xFF0C;&#x4E5F;&#x662F;&#x6211;&#x7528;&#x4E8E; Shuttle Launchpad &#x7684;&#x6846;&#x67B6;&#x3002;&#x6211;&#x559C;&#x6B22;&#x5B83;&#x7684;&#x8868;&#x73B0;&#x529B;&#x548C;&#x80CC;&#x540E;&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x901A;&#x8FC7;&#x7406;&#x89E3;&#x6B63;&#x786E;&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x6211;&#x60F3;&#x89E3;&#x51B3;&#x7684;&#x95EE;&#x9898;&#x90FD;&#x662F;&#x6211;&#x65E0;&#x6CD5;&#x51ED;&#x76F4;&#x89C9;&#x5B8C;&#x6210;&#x7684;&#x3002;&#x5982;&#x679C;&#x60A8;&#x60F3;&#x4E86;&#x89E3; Axum &#x6982;&#x5FF5;&#xFF0C;&#x8BF7;&#x67E5;&#x770B;&#x6211;&#x7684; Tokio + &#x5FAE;&#x670D;&#x52A1;&#x7814;&#x8BA8;&#x4F1A;&#x4E0A;&#x7684;&#x5E7B;&#x706F;&#x7247;&#x3002;</p>
<h4 id="Axum-Example"><a href="#Axum-Example" class="headerlink" title="Axum Example"></a>Axum Example</h4><p>Axum &#x4ED3;&#x5E93;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x77ED;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x4E86;&#x4E00;&#x4E2A; WebSocket &#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x8BE5;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x4F1A;&#x56DE;&#x663E;&#x5B83;&#x6536;&#x5230;&#x7684;&#x4EFB;&#x4F55;&#x6D88;&#x606F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;#[tokio::main]</span><br><span class="line">async fn main() {</span><br><span class="line">    let listener = tokio::net::TcpListener::bind(&quot;127.0.0.1:3000&quot;)</span><br><span class="line">        .await</span><br><span class="line">        .unwrap();</span><br><span class="line">    println!(&quot;listening on {}&quot;, listener.local_addr().unwrap());</span><br><span class="line">    axum::serve(listener, app()).await.unwrap();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">fn app() -&gt; Router {</span><br><span class="line">    // WebSocket routes can generally be tested in two ways:</span><br><span class="line">    //</span><br><span class="line">    // - Integration tests where you run the server and connect with a real WebSocket client.</span><br><span class="line">    // - Unit tests where you mock the socket as some generic send/receive type</span><br><span class="line">    //</span><br><span class="line">    // Which version you pick is up to you. Generally we recommend the integration test version</span><br><span class="line">    // unless your app has a lot of setup that makes it hard to run in a test.</span><br><span class="line">    Router::new()</span><br><span class="line">        .route(&quot;/integration-testable&quot;, get(integration_testable_handler))</span><br><span class="line">        .route(&quot;/unit-testable&quot;, get(unit_testable_handler))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// A WebSocket handler that echos any message it receives.</span><br><span class="line">//</span><br><span class="line">// This one we&apos;ll be integration testing so it can be written in the regular way.</span><br><span class="line">async fn integration_testable_handler(ws: WebSocketUpgrade) -&gt; Response {</span><br><span class="line">    ws.on_upgrade(integration_testable_handle_socket)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">async fn integration_testable_handle_socket(mut socket: WebSocket) {</span><br><span class="line">    while let Some(Ok(msg)) = socket.recv().await {</span><br><span class="line">        if let Message::Text(msg) = msg {</span><br><span class="line">            if socket</span><br><span class="line">                .send(Message::Text(format!(&quot;You said: {msg}&quot;)))</span><br><span class="line">                .await</span><br><span class="line">                .is_err()</span><br><span class="line">            {</span><br><span class="line">                break;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Axum&#x603B;&#x7ED3;"><a href="#Axum&#x603B;&#x7ED3;" class="headerlink" title="Axum&#x603B;&#x7ED3;"></a>Axum&#x603B;&#x7ED3;</h4><ul>
<li>Macro-free API.</li>
<li>&#x5229;&#x7528; Tokio&#x3001;Tower &#x548C; Hyper &#x5EFA;&#x7ACB;&#x5F3A;&#x5927;&#x7684;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x3002;</li>
<li>&#x5F88;&#x68D2;&#x7684;&#x5F00;&#x53D1;&#x8005;&#x7ECF;&#x9A8C;&#x3002;</li>
<li>&#x4ECD;&#x5904;&#x4E8E; 0.x &#x7248;&#x672C;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x751F;&#x91CD;&#x5927;&#x66F4;&#x6539;&#x3002;</li>
</ul>
<h3 id="Actix-Web-Actix"><a href="#Actix-Web-Actix" class="headerlink" title="Actix Web Actix"></a>Actix Web Actix</h3><p>Actix Web &#x662F; Rust &#x7684; Web &#x6846;&#x67B6;&#x4E4B;&#x4E00;&#xFF0C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E86;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x56E0;&#x6B64;&#x975E;&#x5E38;&#x53D7;&#x6B22;&#x8FCE;&#x3002;&#x4E0E;&#x4EFB;&#x4F55;&#x4F18;&#x79C0;&#x7684;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x4E00;&#x6837;&#xFF0C;&#x5B83;&#x7ECF;&#x5386;&#x4E86;&#x591A;&#x6B21;&#x8FED;&#x4EE3;&#xFF0C;&#x4F46;&#x5B83;&#x5DF2;&#x7ECF;&#x8FBE;&#x5230;&#x4E86; 0 &#x4EE5;&#x4E0A;&#x7684;&#x4E3B;&#x8981;&#x7248;&#x672C;&#xFF0C;&#x5E76;&#x4FDD;&#x6301;&#x4E86;&#x7A33;&#x5B9A;&#x6027;&#x4FDD;&#x8BC1;&#xFF1A;&#x5728;&#x4E3B;&#x8981;&#x7248;&#x672C;&#x5185;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x786E;&#x4FDD;&#x6CA1;&#x6709;&#x91CD;&#x5927;&#x66F4;&#x6539;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8C08;&#x8BBA; Actix Web &#x65F6;&#xFF0C;&#x5F88;&#x5BB9;&#x6613;&#x5047;&#x8BBE;&#x5B83;&#x662F;&#x57FA;&#x4E8E; <code>actix</code> actor &#x8FD0;&#x884C;&#x65F6;&#x7684;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5DF2;&#x7ECF;&#x6709; 4 &#x5E74;&#x591A;&#x6CA1;&#x6709;&#x53D1;&#x751F;&#x4E86;&#xFF1B; Actix Web &#x4E2D;&#x552F;&#x4E00;&#x9700;&#x8981; actor &#x7684;&#x5269;&#x4F59;&#x90E8;&#x5206;&#x662F; WebSocket&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x6B63;&#x5728;&#x52AA;&#x529B;&#x5B8C;&#x5168;&#x5220;&#x9664;&#x5176;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A; <code>actix</code> <strong>&#x65E0;&#x6CD5;&#x4E0E;&#x73B0;&#x4EE3;&#x5F02;&#x6B65; Rust</strong> &#x4E16;&#x754C;&#x5F88;&#x597D;&#x5730;&#x914D;&#x5408;&#x3002;&#x66F4;&#x5E7F;&#x6CDB;&#x7684; Actix &#x9879;&#x76EE;&#x548C; GitHub org &#x63D0;&#x4F9B;&#x4E86;&#x8BB8;&#x591A;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x5E76;&#x53D1;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5E93;&#xFF0C;&#x4ECE;&#x8F83;&#x4F4E;&#x7EA7;&#x522B;&#x7684; TCP &#x670D;&#x52A1;&#x5668;&#x6784;&#x5EFA;&#x5668;&#xFF0C;&#x5230; HTTP / Web &#x5C42;&#xFF0C;&#x4E00;&#x76F4;&#x5230;&#x9759;&#x6001;&#x6587;&#x4EF6;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x548C;&#x4F1A;&#x8BDD;&#x7BA1;&#x7406;crate&#x3002;</p>
<p>&#x4E4D;&#x4E00;&#x770B;&#xFF0C;Actix Web &#x770B;&#x8D77;&#x6765;&#x4E0E; Rust &#x4E2D;&#x7684;&#x5176;&#x4ED6; Web &#x6846;&#x67B6;&#x975E;&#x5E38;&#x719F;&#x6089;&#x3002;&#x60A8;&#x4F7F;&#x7528;&#x5B8F;&#x6765;&#x5B9A;&#x4E49; HTTP &#x65B9;&#x6CD5;&#x548C;&#x8DEF;&#x7531;&#xFF08;&#x5982; Rocket&#xFF09;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x63D0;&#x53D6;&#x5668;&#x4ECE;&#x8BF7;&#x6C42;&#x4E2D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF08;&#x5982; Axum&#xFF09;&#x3002;&#x4E0E; Axum &#x7684;&#x76F8;&#x4F3C;&#x4E4B;&#x5904;&#x662F;&#x60CA;&#x4EBA;&#x7684;&#xFF0C;&#x5728;&#x6982;&#x5FF5;&#x548C;&#x7279;&#x5F81;&#x7684;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#x4E0A;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002;&#x6700;&#x5927;&#x7684;&#x533A;&#x522B;&#x662F; Actix Web &#x5E76;&#x6CA1;&#x6709;&#x5C06;&#x81EA;&#x5DF1;&#x4E0E; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x8054;&#x7CFB;&#x5F97;&#x592A;&#x7D27;&#x5BC6;&#x3002;&#x867D;&#x7136; Tokio &#x4ECD;&#x7136;&#x662F; Actix Web &#x4E0B;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x4F46;&#x8BE5;&#x6846;&#x67B6;&#x5177;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x62BD;&#x8C61;&#x548C;&#x7279;&#x5F81;&#xFF0C;&#x4EE5;&#x53CA;&#x81EA;&#x5DF1;&#x7684;crate&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x3002;&#x8FD9;&#x6709;&#x4F18;&#x70B9;&#x4E5F;&#x6709;&#x7F3A;&#x70B9;&#x3002;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x4E8B;&#x7269;&#x901A;&#x5E38;&#x53EF;&#x4EE5;&#x5F88;&#x597D;&#x5730;&#x534F;&#x540C;&#x5DE5;&#x4F5C;&#xFF0C;&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x4F1A;&#x9519;&#x8FC7; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x5DF2;&#x7ECF;&#x63D0;&#x4F9B;&#x7684;&#x8BB8;&#x591A;&#x4E8B;&#x7269;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x611F;&#x5230;&#x5947;&#x602A;&#x7684;&#x4E00;&#x4EF6;&#x4E8B;&#x662F; Actix Web &#x5B9E;&#x73B0;&#x4E86;&#x81EA;&#x5DF1;&#x7684; Service trait&#xFF0C;&#x5B83;&#x4E0E; Tower &#x7684;&#x57FA;&#x672C;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x4ECD;&#x7136;&#x4E0D;&#x517C;&#x5BB9;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740; Tower &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5927;&#x591A;&#x6570;&#x53EF;&#x7528;&#x4E2D;&#x95F4;&#x4EF6;&#x4E0D;&#x9002;&#x7528;&#x4E8E; Actix&#x3002;</p>
<p>&#x540C;&#x6837;&#x6709;&#x8DA3;&#x7684;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x5728; Actix Web &#x4E2D;&#x81EA;&#x884C;&#x5B9E;&#x73B0;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x4EFB;&#x52A1;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x4F1A;&#x9047;&#x5230;&#x8FD0;&#x884C;&#x6846;&#x67B6;&#x4E2D;&#x6240;&#x6709;&#x5185;&#x5BB9;&#x7684; Actor &#x6A21;&#x578B;&#x3002;&#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x60A8;&#x53EF;&#x80FD;&#x4E0D;&#x60F3;&#x5904;&#x7406;&#x7684;&#x590D;&#x6742;&#x6027;&#x3002;</p>
<p>&#x4F46; Actix Web &#x5468;&#x56F4;&#x7684;&#x793E;&#x533A;&#x63D0;&#x4F9B;&#x4E86;&#x8FD9;&#x4E00;&#x70B9;&#x3002;&#x8BE5;&#x6846;&#x67B6;&#x652F;&#x6301; HTTP/2 &#x548C; Websocket &#x5347;&#x7EA7;&#xFF0C;&#x5B83;&#x5177;&#x6709; Web &#x6846;&#x67B6;&#x4E2D;&#x6700;&#x5E38;&#x89C1;&#x4EFB;&#x52A1;&#x7684;&#x5305;&#x548C;&#x6307;&#x5357;&#xFF0C;&#x4F18;&#x79C0;&#x7684;&#xFF08;&#x6211;&#x7684;&#x610F;&#x601D;&#x662F;&#x4F18;&#x79C0;&#x7684;&#xFF09;&#x6587;&#x6863;&#xFF0C;&#x800C;&#x4E14;&#x901F;&#x5EA6;&#x5F88;&#x5FEB;&#x3002; Actix Web &#x7684;&#x6D41;&#x884C;&#x662F;&#x6709;&#x539F;&#x56E0;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x4FDD;&#x6301;&#x7248;&#x672C;&#x4FDD;&#x8BC1;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x662F;&#x60A8;&#x73B0;&#x5728;&#x7684;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;</p>
<h4 id="Actix-Web-Example"><a href="#Actix-Web-Example" class="headerlink" title="Actix Web Example"></a>Actix Web Example</h4><p>Actix Web &#x4E2D;&#x7684;&#x7B80;&#x5355; WebSocket &#x56DE;&#x663E;&#x670D;&#x52A1;&#x5668;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;use actix::{Actor, StreamHandler};</span><br><span class="line">use actix_web::{web, App, Error, HttpRequest, HttpResponse, HttpServer};</span><br><span class="line">use actix_web_actors::ws;</span><br><span class="line"></span><br><span class="line">/// Define HTTP actor</span><br><span class="line">struct MyWs;</span><br><span class="line"></span><br><span class="line">impl Actor for MyWs {</span><br><span class="line">    type Context = ws::WebsocketContext&lt;Self&gt;;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/// Handler for ws::Message message</span><br><span class="line">impl StreamHandler&lt;Result&lt;ws::Message, ws::ProtocolError&gt;&gt; for MyWs {</span><br><span class="line">    fn handle(&amp;mut self, msg: Result&lt;ws::Message, ws::ProtocolError&gt;, ctx: &amp;mut Self::Context) {</span><br><span class="line">        match msg {</span><br><span class="line">            Ok(ws::Message::Ping(msg)) =&gt; ctx.pong(&amp;msg),</span><br><span class="line">            Ok(ws::Message::Text(text)) =&gt; ctx.text(text),</span><br><span class="line">            Ok(ws::Message::Binary(bin)) =&gt; ctx.binary(bin),</span><br><span class="line">            _ =&gt; (),</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">async fn index(req: HttpRequest, stream: web::Payload) -&gt; Result&lt;HttpResponse, Error&gt; {</span><br><span class="line">    let resp = ws::start(MyWs {}, &amp;req, stream);</span><br><span class="line">    println!(&quot;{:?}&quot;, resp);</span><br><span class="line">    resp</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[actix_web::main]</span><br><span class="line">async fn main() -&gt; std::io::Result&lt;()&gt; {</span><br><span class="line">    HttpServer::new(|| App::new().route(&quot;/ws/&quot;, web::get().to(index)))</span><br><span class="line">        .bind((&quot;127.0.0.1&quot;, 8080))?</span><br><span class="line">        .run()</span><br><span class="line">        .await</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Actix-Web-&#x603B;&#x7ED3;"><a href="#Actix-Web-&#x603B;&#x7ED3;" class="headerlink" title="Actix Web &#x603B;&#x7ED3;"></a>Actix Web &#x603B;&#x7ED3;</h4><ul>
<li>&#x5F3A;&#x5927;&#x3001;&#x72EC;&#x7ACB;&#x7684;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x3002;</li>
<li>Actor model based.</li>
<li>&#x901A;&#x8FC7;&#x4E3B;&#x8981;&#x7248;&#x672C;&#x4FDD;&#x8BC1;&#x5B9E;&#x73B0;&#x7A33;&#x5B9A;&#x7684; API&#x3002;</li>
<li>&#x5F88;&#x68D2;&#x7684;&#x6587;&#x6863;&#x3002;</li>
</ul>
<h3 id="Rocket"><a href="#Rocket" class="headerlink" title="Rocket"></a>Rocket</h3><p>Rocket &#x957F;&#x671F;&#x4EE5;&#x6765;&#x4E00;&#x76F4;&#x662F; Rust Web &#x6846;&#x67B6;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x660E;&#x661F;&#xFF0C;&#x5B83;&#x5BF9;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x4F53;&#x9A8C;&#x7684;&#x6001;&#x5EA6;&#x6BEB;&#x65E0;&#x6B49;&#x610F;&#xFF0C;&#x5BF9;&#x719F;&#x6089;&#x7684;&#x73B0;&#x6709;&#x6982;&#x5FF5;&#x7684;&#x4F9D;&#x8D56;&#xFF0C;&#x4EE5;&#x53CA;&#x63D0;&#x4F9B;&#x5305;&#x542B;&#x4E30;&#x5BCC;&#x5185;&#x7F6E;&#x529F;&#x80FD;&#x7684;&#x4F53;&#x9A8C;&#x7684;&#x96C4;&#x5FC3;&#x52C3;&#x52C3;&#x7684;&#x76EE;&#x6807;&#x3002;</p>
<p>&#x5F53;&#x60A8;&#x8FDB;&#x5165;&#x4ED6;&#x4EEC;&#x6F02;&#x4EAE;&#x7684;&#x7F51;&#x7AD9;&#x65F6;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B83;&#x7684;&#x91CE;&#x5FC3;&#xFF1A;&#x57FA;&#x4E8E;&#x5B8F;&#x7684;&#x8DEF;&#x7531;&#x3001;&#x5185;&#x7F6E;&#x8868;&#x5355;&#x5904;&#x7406;&#x3001;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x548C;&#x72B6;&#x6001;&#x7BA1;&#x7406;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x4EE5;&#x53CA;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x6A21;&#x677F;&#x7248;&#x672C;&#xFF01; Rocket &#x786E;&#x5B9E;&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x6784;&#x5EFA; Web &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6240;&#x9700;&#x7684;&#x4E00;&#x5207;&#x3002;</p>
<p>&#x7136;&#x800C;&#xFF0C;Rocket&#x7684;&#x91CE;&#x5FC3;&#x5374;&#x4ED8;&#x51FA;&#x4E86;&#x4EE3;&#x4EF7;&#x3002;&#x867D;&#x7136;&#x4ECD;&#x5728;&#x79EF;&#x6781;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x4F46;&#x53D1;&#x5E03;&#x5E76;&#x4E0D;&#x50CF;&#x4EE5;&#x524D;&#x90A3;&#x4E48;&#x9891;&#x7E41;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x8BE5;&#x6846;&#x67B6;&#x7684;&#x7528;&#x6237;&#x4F1A;&#x9519;&#x8FC7;&#x5F88;&#x591A;&#x91CD;&#x8981;&#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x7531;&#x4E8E;&#x91C7;&#x7528;&#x4E86;&#x5305;&#x542B;&#x4E30;&#x5BCC;&#x5185;&#x7F6E;&#x529F;&#x80FD;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x60A8;&#x8FD8;&#x9700;&#x8981;&#x4E86;&#x89E3; Rocket &#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#x3002; Rocket &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6709;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x6784;&#x5EFA;&#x5757;&#x4EE5;&#x7279;&#x5B9A;&#x65B9;&#x5F0F;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x95EE;&#x9898;&#x6240;&#x5728;&#x3002;</p>
<p>Rocket &#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x68D2;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x5F00;&#x59CB; Rust Web &#x5F00;&#x53D1;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;&#x5C31;&#x6211;&#x4E2A;&#x4EBA;&#x800C;&#x8A00;&#xFF0C;&#x6211;&#x5BF9; Rocket &#x60C5;&#x6709;&#x72EC;&#x949F;&#xFF0C;&#x5E0C;&#x671B;&#x5B83;&#x7684;&#x53D1;&#x5C55;&#x80FD;&#x591F;&#x52A0;&#x5FEB;&#x3002;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x8BB8;&#x591A;&#x4EBA;&#x6765;&#x8BF4;&#xFF0C;Rocket &#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDB;&#x5165; Rust &#x7684;&#x4EBA;&#xFF0C;&#x7528;&#x5B83;&#x8FDB;&#x884C;&#x5F00;&#x53D1;&#x4ECD;&#x7136;&#x5F88;&#x6709;&#x8DA3;&#x3002;&#x5C3D;&#x7BA1;&#x5982;&#x6B64;&#xFF0C;&#x6211;&#x901A;&#x5E38;&#x4F9D;&#x8D56; Rocket &#x4E2D;&#x4E0D;&#x53EF;&#x7528;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4E0D;&#x4F1A;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#x5B83;&#x3002;</p>
<h4 id="Rocket-Example"><a href="#Rocket-Example" class="headerlink" title="Rocket Example"></a>Rocket Example</h4><p>Rocket &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x77ED;&#x793A;&#x4F8B;&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;&#x793A;&#x4F8B;&#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x7684;&#x8868;&#x5355;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;#[derive(Debug, FromForm)]</span><br><span class="line">struct Password&lt;&apos;v&gt; {</span><br><span class="line">    #[field(validate = len(6..))]</span><br><span class="line">    #[field(validate = eq(self.second))]</span><br><span class="line">    first: &amp;&apos;v str,</span><br><span class="line">    #[field(validate = eq(self.first))]</span><br><span class="line">    second: &amp;&apos;v str,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[derive(Debug, FromForm)]</span><br><span class="line">#[allow(dead_code)]</span><br><span class="line">struct Submission&lt;&apos;v&gt; {</span><br><span class="line">    #[field(validate = len(1..))]</span><br><span class="line">    title: &amp;&apos;v str,</span><br><span class="line">    date: Date,</span><br><span class="line">    #[field(validate = len(1..=250))]</span><br><span class="line">    r#abstract: &amp;&apos;v str,</span><br><span class="line">    #[field(validate = ext(ContentType::PDF))]</span><br><span class="line">    file: TempFile&lt;&apos;v&gt;,</span><br><span class="line">    ready: bool,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[derive(Debug, FromForm)]</span><br><span class="line">#[allow(dead_code)]</span><br><span class="line">struct Account&lt;&apos;v&gt; {</span><br><span class="line">    #[field(validate = len(1..))]</span><br><span class="line">    name: &amp;&apos;v str,</span><br><span class="line">    password: Password&lt;&apos;v&gt;,</span><br><span class="line">    #[field(validate = contains(&apos;@&apos;).or_else(msg!(&quot;invalid email address&quot;)))]</span><br><span class="line">    email: &amp;&apos;v str,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[derive(Debug, FromForm)]</span><br><span class="line">#[allow(dead_code)]</span><br><span class="line">struct Submit&lt;&apos;v&gt; {</span><br><span class="line">    account: Account&lt;&apos;v&gt;,</span><br><span class="line">    submission: Submission&lt;&apos;v&gt;,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[get(&quot;/&quot;)]</span><br><span class="line">fn index() -&gt; Template {</span><br><span class="line">    Template::render(&quot;index&quot;, &amp;Context::default())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// NOTE: We use `Contextual` here because we want to collect all submitted form</span><br><span class="line">// fields to re-render forms with submitted values on error. If you have no such</span><br><span class="line">// need, do not use `Contextual`. Use the equivalent of `Form&lt;Submit&lt;&apos;_&gt;&gt;`.</span><br><span class="line">#[post(&quot;/&quot;, data = &quot;&lt;form&gt;&quot;)]</span><br><span class="line">fn submit&lt;&apos;r&gt;(form: Form&lt;Contextual&lt;&apos;r, Submit&lt;&apos;r&gt;&gt;&gt;) -&gt; (Status, Template) {</span><br><span class="line">    let template = match form.value {</span><br><span class="line">        Some(ref submission) =&gt; {</span><br><span class="line">            println!(&quot;submission: {:#?}&quot;, submission);</span><br><span class="line">            Template::render(&quot;success&quot;, &amp;form.context)</span><br><span class="line">        }</span><br><span class="line">        None =&gt; Template::render(&quot;index&quot;, &amp;form.context),</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    (form.context.status(), template)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[launch]</span><br><span class="line">fn rocket() -&gt; _ {</span><br><span class="line">    rocket::build()</span><br><span class="line">        .mount(&quot;/&quot;, routes![index, submit])</span><br><span class="line">        .attach(Template::fairing())</span><br><span class="line">        .mount(&quot;/&quot;, FileServer::from(relative!(&quot;/static&quot;)))</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Rocket-&#x603B;&#x7ED3;"><a href="#Rocket-&#x603B;&#x7ED3;" class="headerlink" title="Rocket &#x603B;&#x7ED3;"></a>Rocket &#x603B;&#x7ED3;</h4><ul>
<li>&#x4E30;&#x5BCC;&#x7684;&#x5185;&#x7F6E;&#x529F;&#x80FD;&#x3002;</li>
<li>Great developer experience.</li>
<li>&#x4E0D;&#x50CF;&#x4EE5;&#x524D;&#x90A3;&#x6837;&#x79EF;&#x6781;&#x53D1;&#x5C55;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x521D;&#x5B66;&#x8005;&#x6765;&#x8BF4;&#x4ECD;&#x7136;&#x662F;&#x4E00;&#x4E2A;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;</li>
</ul>
<h2 id="&#x9C9C;&#x4E3A;&#x4EBA;&#x77E5;&#x4F46;&#x4ECD;&#x7136;&#x4EE4;&#x4EBA;&#x5174;&#x594B;&#x7684;-Rust-&#x6846;&#x67B6;"><a href="#&#x9C9C;&#x4E3A;&#x4EBA;&#x77E5;&#x4F46;&#x4ECD;&#x7136;&#x4EE4;&#x4EBA;&#x5174;&#x594B;&#x7684;-Rust-&#x6846;&#x67B6;" class="headerlink" title="&#x9C9C;&#x4E3A;&#x4EBA;&#x77E5;&#x4F46;&#x4ECD;&#x7136;&#x4EE4;&#x4EBA;&#x5174;&#x594B;&#x7684; Rust &#x6846;&#x67B6;"></a>&#x9C9C;&#x4E3A;&#x4EBA;&#x77E5;&#x4F46;&#x4ECD;&#x7136;&#x4EE4;&#x4EBA;&#x5174;&#x594B;&#x7684; Rust &#x6846;&#x67B6;</h2><h3 id="Warp"><a href="#Warp" class="headerlink" title="Warp"></a>Warp</h3><p>hello&#xFF0C;Warp&#xFF01;&#x4F60;&#x662F;&#x4E00;&#x5934;&#x7F8E;&#x4E3D;&#x3001;&#x5947;&#x602A;&#x3001;&#x5F3A;&#x5927;&#x7684;&#x91CE;&#x517D;&#x3002; Warp &#x662F;&#x4E00;&#x4E2A;&#x6784;&#x5EFA;&#x5728; Tokio &#x4E4B;&#x4E0A;&#x7684; Web &#x6846;&#x67B6;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x597D;&#x7684;&#x6846;&#x67B6;&#x3002;&#x5B83;&#x4E5F;&#x4E0E;&#x6211;&#x4EEC;&#x8FC4;&#x4ECA;&#x4E3A;&#x6B62;&#x770B;&#x5230;&#x7684;&#x5176;&#x4ED6;&#x6846;&#x67B6;&#x6709;&#x5F88;&#x5927;&#x4E0D;&#x540C;&#x3002;</p>
<p>Warp &#x4E0E; Axum &#x6709;&#x4E00;&#x4E9B;&#x5171;&#x540C;traits&#xFF08;&#x54C8;&#x54C8;&#xFF01;&#xFF09;&#xFF1A;&#x5B83;&#x57FA;&#x4E8E; Tokio &#x548C; Hyper &#x6784;&#x5EFA;&#xFF0C;&#x5E76;&#x4F7F;&#x7528; Tower &#x4E2D;&#x95F4;&#x4EF6;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x5B83;&#x7684;&#x65B9;&#x6CD5;&#x5374;&#x975E;&#x5E38;&#x4E0D;&#x540C;&#x3002; Warp &#x662F;&#x5EFA;&#x7ACB;&#x5728; <code>Filter</code> trait&#x4E4B;&#x4E0A;&#x7684;&#x3002;</p>
<p>&#x5728; Warp &#x4E2D;&#xFF0C;&#x60A8;&#x6784;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x4E8E;&#x4F20;&#x5165;&#x8BF7;&#x6C42;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x7BA1;&#x9053;&#xFF0C;&#x5E76;&#x4E14;&#x8BF7;&#x6C42;&#x901A;&#x8FC7;&#x7BA1;&#x9053;&#x4F20;&#x9012;&#xFF0C;&#x76F4;&#x5230;&#x5230;&#x8FBE;&#x672B;&#x5C3E;&#x3002;&#x8FC7;&#x6EE4;&#x5668;&#x53EF;&#x4EE5;&#x94FE;&#x63A5;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7EC4;&#x5408;&#x3002;&#x8FD9;&#x4F7F;&#x60A8;&#x53EF;&#x4EE5;&#x6784;&#x5EFA;&#x975E;&#x5E38;&#x590D;&#x6742;&#x4F46;&#x4ECD;&#x7136;&#x6613;&#x4E8E;&#x7406;&#x89E3;&#x7684;&#x7BA1;&#x9053;&#x3002;</p>
<p>Warp &#x4E5F;&#x6BD4; Axum &#x66F4;&#x63A5;&#x8FD1; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x53EF;&#x4EE5;&#x5904;&#x7406;&#x66F4;&#x591A;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x7C98;&#x5408;&#x7279;&#x5F81;&#x7684; Tokio &#x7ED3;&#x6784;&#x548C;&#x6982;&#x5FF5;&#x3002;</p>
<p>Warp &#x91C7;&#x7528;&#x975E;&#x5E38;&#x5B9E;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x662F;&#x60A8;&#x7684;&#x7F16;&#x7A0B;&#x98CE;&#x683C;&#xFF0C;&#x60A8;&#x4E00;&#x5B9A;&#x4F1A;&#x559C;&#x6B22; Warp &#x7684;&#x8868;&#x73B0;&#x529B;&#x548C;&#x53EF;&#x7EC4;&#x5408;&#x6027;&#x3002;&#x5F53;&#x4F60;&#x67E5;&#x770B;&#x4E00;&#x6BB5; Warp &#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x5B83;&#x901A;&#x5E38;&#x8BFB;&#x8D77;&#x6765;&#x5C31;&#x50CF;&#x4E00;&#x4E2A;&#x6B63;&#x5728;&#x53D1;&#x751F;&#x7684;&#x6545;&#x4E8B;&#xFF0C;&#x8FD9;&#x5728; Rust &#x4E2D;&#x8D77;&#x4F5C;&#x7528;&#x662F;&#x6709;&#x8DA3;&#x548C;&#x4EE4;&#x4EBA;&#x60CA;&#x5947;&#x7684;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x60F3;&#x5728; RRust Analyzer&#x8BBE;&#x7F6E;&#x4E2D;&#x5173;&#x95ED; &#x7C7B;&#x578B;&#x5D4C;&#x5957; (inlay) &#x63D0;&#x793A;&#x3002;&#x7531;&#x4E8E;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x4E0D;&#x540C;&#x7684;&#x51FD;&#x6570;&#x548C;&#x8FC7;&#x6EE4;&#x5668;&#x90FD;&#x88AB;&#x94FE;&#x63A5;&#x5728;&#x4E00;&#x8D77;&#xFF0C;Warp &#x4E2D;&#x7684; &#x7C7B;&#x578B; &#x53D8;&#x5F97;&#x975E;&#x5E38;&#x957F;&#x4E14;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x800C;&#x4E14;&#x4E5F;&#x96BE;&#x4EE5;&#x7834;&#x8BD1;&#x3002;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x662F;&#x96BE;&#x4EE5;&#x7406;&#x89E3;&#x7684;&#x4E00;&#x5806;&#x6D88;&#x606F;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x867D;&#x7136;&#x8FC7;&#x6EE4;&#x5668;&#x6982;&#x5FF5;&#x5728;&#x60A8;&#x5B8C;&#x6210;&#x540E;&#x5F88;&#x68D2;&#xFF0C;&#x4F46;&#x6709;&#x65F6;&#x60A8;&#x5E0C;&#x671B;&#x62E5;&#x6709;&#x4E0E;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x6846;&#x67B6;&#x4E00;&#x8D77;&#x83B7;&#x5F97;&#x7684;&#x58F0;&#x660E;&#x6027;&#x8DEF;&#x7531;&#x5668;&#x3001;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x548C;&#x63D0;&#x53D6;&#x5668;&#x6837;&#x5F0F;&#x3002;</p>
<p>Warp &#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x68D2;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x6211;&#x559C;&#x6B22;&#x5B83;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x5B83;&#x4E0D;&#x662F;&#x6700;&#x9002;&#x5408;&#x521D;&#x5B66;&#x8005;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x4E5F;&#x4E0D;&#x662F;&#x6700;&#x6D41;&#x884C;&#x7684;&#x6846;&#x67B6;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x53EF;&#x80FD;&#x5F88;&#x96BE;&#x627E;&#x5230;&#x5E2E;&#x52A9;&#x548C;&#x8D44;&#x6E90;&#x3002;&#x4F46;&#x5BF9;&#x4E8E;&#x5FEB;&#x901F;&#x4E14;&#x5C0F;&#x578B;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x5F88;&#x6709;&#x8DA3;&#xFF0C;&#x800C;&#x4E14;&#x5B83;&#x7684;&#x5B9E;&#x9A8C;&#x98CE;&#x683C;&#x53EF;&#x80FD;&#x4F1A;&#x7ED9;&#x60A8;&#x5E26;&#x6765;&#x65B0;&#x7684;&#x60F3;&#x6CD5;&#xFF01;</p>
<h4 id="Warp-Example"><a href="#Warp-Example" class="headerlink" title="Warp Example"></a>Warp Example</h4><p>&#x6765;&#x81EA;&#x793A;&#x4F8B;&#x5B58;&#x50A8;&#x5E93;&#x7684; websocket &#x804A;&#x5929;&#x7684;&#x6F14;&#x793A;&#x793A;&#x4F8B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;static NEXT_USER_ID: AtomicUsize = AtomicUsize::new(1);</span><br><span class="line"></span><br><span class="line">/// Our state of currently connected users.</span><br><span class="line">///</span><br><span class="line">/// - Key is their id</span><br><span class="line">/// - Value is a sender of `warp::ws::Message`</span><br><span class="line">type Users = Arc&lt;RwLock&lt;HashMap&lt;usize, mpsc::UnboundedSender&lt;Message&gt;&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">#[tokio::main]</span><br><span class="line">async fn main() {</span><br><span class="line">    let users = Users::default();</span><br><span class="line">    // Turn our &quot;state&quot; into a new Filter...</span><br><span class="line">    let users = warp::any().map(move || users.clone());</span><br><span class="line"></span><br><span class="line">    // GET /chat -&gt; websocket upgrade</span><br><span class="line">    let chat = warp::path(&quot;chat&quot;)</span><br><span class="line">        // The `ws()` filter will prepare Websocket handshake...</span><br><span class="line">        .and(warp::ws())</span><br><span class="line">        .and(users)</span><br><span class="line">        .map(|ws: warp::ws::Ws, users| {</span><br><span class="line">            // This will call our function if the handshake succeeds.</span><br><span class="line">            ws.on_upgrade(move |socket| user_connected(socket, users))</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">    // GET / -&gt; index html</span><br><span class="line">    let index = warp::path::end().map(|| warp::reply::html(INDEX_HTML));</span><br><span class="line"></span><br><span class="line">    let routes = index.or(chat);</span><br><span class="line"></span><br><span class="line">    warp::serve(routes).run(([127, 0, 0, 1], 3030)).await;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">async fn user_connected(ws: WebSocket, users: Users) {</span><br><span class="line">    // Use a counter to assign a new unique ID for this user.</span><br><span class="line">    let my_id = NEXT_USER_ID.fetch_add(1, Ordering::Relaxed);</span><br><span class="line"></span><br><span class="line">    eprintln!(&quot;new chat user: {}&quot;, my_id);</span><br><span class="line"></span><br><span class="line">    // Split the socket into a sender and receive of messages.</span><br><span class="line">    let (mut user_ws_tx, mut user_ws_rx) = ws.split();</span><br><span class="line"></span><br><span class="line">    let (tx, rx) = mpsc::unbounded_channel();</span><br><span class="line">    let mut rx = UnboundedReceiverStream::new(rx);</span><br><span class="line"></span><br><span class="line">    tokio::task::spawn(async move {</span><br><span class="line">        while let Some(message) = rx.next().await {</span><br><span class="line">            user_ws_tx</span><br><span class="line">                .send(message)</span><br><span class="line">                .unwrap_or_else(|e| {</span><br><span class="line">                    eprintln!(&quot;websocket send error: {}&quot;, e);</span><br><span class="line">                })</span><br><span class="line">                .await;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    // Save the sender in our list of connected users.</span><br><span class="line">    users.write().await.insert(my_id, tx);</span><br><span class="line"></span><br><span class="line">    // Return a `Future` that is basically a state machine managing</span><br><span class="line">    // this specific user&apos;s connection.</span><br><span class="line"></span><br><span class="line">    // Every time the user sends a message, broadcast it to</span><br><span class="line">    // all other users...</span><br><span class="line">    while let Some(result) = user_ws_rx.next().await {</span><br><span class="line">        let msg = match result {</span><br><span class="line">            Ok(msg) =&gt; msg,</span><br><span class="line">            Err(e) =&gt; {</span><br><span class="line">                eprintln!(&quot;websocket error(uid={}): {}&quot;, my_id, e);</span><br><span class="line">                break;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        user_message(my_id, msg, &amp;users).await;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // user_ws_rx stream will keep processing as long as the user stays</span><br><span class="line">    // connected. Once they disconnect, then...</span><br><span class="line">    user_disconnected(my_id, &amp;users).await;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">async fn user_message(my_id: usize, msg: Message, users: &amp;Users) {</span><br><span class="line">    // Skip any non-Text messages...</span><br><span class="line">    let msg = if let Ok(s) = msg.to_str() {</span><br><span class="line">        s</span><br><span class="line">    } else {</span><br><span class="line">        return;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    let new_msg = format!(&quot;&lt;User#{}&gt;: {}&quot;, my_id, msg);</span><br><span class="line"></span><br><span class="line">    // New message from this user, send it to everyone else (except same uid)...</span><br><span class="line">    for (&amp;uid, tx) in users.read().await.iter() {</span><br><span class="line">        if my_id != uid {</span><br><span class="line">            if let Err(_disconnected) = tx.send(Message::text(new_msg.clone())) {</span><br><span class="line">                // The tx is disconnected, our `user_disconnected` code</span><br><span class="line">                // should be happening in another task, nothing more to</span><br><span class="line">                // do here.</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">async fn user_disconnected(my_id: usize, users: &amp;Users) {</span><br><span class="line">    eprintln!(&quot;good bye user: {}&quot;, my_id);</span><br><span class="line"></span><br><span class="line">    // Stream closed up, so remove from the user list</span><br><span class="line">    users.write().await.remove(&amp;my_id);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Warp-&#x603B;&#x7ED3;"><a href="#Warp-&#x603B;&#x7ED3;" class="headerlink" title="Warp &#x603B;&#x7ED3;"></a>Warp &#x603B;&#x7ED3;</h4><ul>
<li>Functional approach. &#x51FD;&#x6570;&#x5F0F;&#x65B9;&#x6CD5;&#x3002;</li>
<li>Very expressive. &#x975E;&#x5E38;&#x5BCC;&#x6709;&#x8868;&#x73B0;&#x529B;&#x3002;</li>
<li>&#x9760;&#x8FD1; Tokio&#x3001;Tower &#x548C; Hyper&#xFF0C;&#x62E5;&#x6709;&#x5F3A;&#x5927;&#x7684;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x3002;</li>
<li>&#x4E0D;&#x662F;&#x6700;&#x9002;&#x5408;&#x521D;&#x5B66;&#x8005;&#x7684;&#x6846;&#x67B6;&#x3002;</li>
</ul>
<h3 id="Tide"><a href="#Tide" class="headerlink" title="Tide"></a>Tide</h3><p>Tide &#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7B80;&#x7EA6;&#x7684; Web &#x6846;&#x67B6;&#xFF0C;&#x6784;&#x5EFA;&#x5728; <code>async-std</code> &#x8FD0;&#x884C;&#x65F6;&#x4E4B;&#x4E0A;&#x3002;&#x7B80;&#x7EA6;&#x7684;&#x65B9;&#x6CD5;&#x610F;&#x5473;&#x7740;&#x60A8;&#x5C06;&#x83B7;&#x5F97;&#x975E;&#x5E38;&#x5C0F;&#x7684; API &#x8868;&#x9762;&#x3002; Tide &#x4E2D;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x662F; <code>async fn</code> &#xFF0C;&#x5B83;&#x63A5;&#x53D7; <code>Request</code> &#x5E76;&#x8FD4;&#x56DE; <code>Response</code> &#x7684; <code>tide::Result</code> &#x3002;&#x63D0;&#x53D6;&#x6570;&#x636E;&#x6216;&#x53D1;&#x9001;&#x6B63;&#x786E;&#x7684;&#x54CD;&#x5E94;&#x683C;&#x5F0F;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x3002;</p>
<p>&#x867D;&#x7136;&#x8FD9;&#x5BF9;&#x60A8;&#x6765;&#x8BF4;&#x53EF;&#x80FD;&#x662F;&#x66F4;&#x591A;&#x7684;&#x5DE5;&#x4F5C;&#xFF0C;&#x4F46;&#x5B83;&#x4E5F;&#x66F4;&#x76F4;&#x63A5;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x63A7;&#x5236;&#x6B63;&#x5728;&#x53D1;&#x751F;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x5BF9;&#x4E8E;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#xFF0C;&#x80FD;&#x591F;&#x5982;&#x6B64;&#x63A5;&#x8FD1; HTTP &#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x662F;&#x4E00;&#x4EF6;&#x4EE4;&#x4EBA;&#x9AD8;&#x5174;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x5E76;&#x4E14;&#x4F7F;&#x4E8B;&#x60C5;&#x53D8;&#x5F97;&#x66F4;&#x5BB9;&#x6613;&#x3002;</p>
<p>&#x5B83;&#x7684;&#x4E2D;&#x95F4;&#x4EF6;&#x65B9;&#x6CD5;&#x4E0E;&#x60A8;&#x4ECE; Tower &#x4E2D;&#x4E86;&#x89E3;&#x5230;&#x7684;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46; Tide &#x516C;&#x5F00;&#x4E86;&#x5F02;&#x6B65;&#x7279;&#x5F81;&#x7BB1;&#xFF0C;&#x4F7F;&#x5B9E;&#x65BD;&#x53D8;&#x5F97;&#x66F4;&#x52A0;&#x5BB9;&#x6613;&#x3002;&#x7531;&#x4E8E; Tide &#x662F;&#x7531;&#x4E5F;&#x53C2;&#x4E0E; Rust &#x5F02;&#x6B65;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x7684;&#x4EBA;&#x4EEC;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EF;&#x4EE5;&#x671F;&#x671B;&#x50CF;&#x6700;&#x8FD1;&#x767B;&#x9646; Nightly &#x7684;&#x7279;&#x5F81;&#x4E2D;&#x7684;&#x9002;&#x5F53;&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#x4E4B;&#x7C7B;&#x7684;&#x4E1C;&#x897F;&#x5F88;&#x5FEB;&#x5C31;&#x4F1A;&#x88AB;&#x91C7;&#x7528;&#x3002;</p>
<h4 id="Tide-Example"><a href="#Tide-Example" class="headerlink" title="Tide Example"></a>Tide Example</h4><p>&#x6765;&#x81EA;&#x793A;&#x4F8B;&#x5B58;&#x50A8;&#x5E93;&#x7684;&#x7528;&#x6237;&#x4F1A;&#x8BDD;&#x793A;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;#[async_std::main]</span><br><span class="line">async fn main() -&gt; Result&lt;(), std::io::Error&gt; {</span><br><span class="line">    femme::start();</span><br><span class="line">    let mut app = tide::new();</span><br><span class="line">    app.with(tide::log::LogMiddleware::new());</span><br><span class="line"></span><br><span class="line">    app.with(tide::sessions::SessionMiddleware::new(</span><br><span class="line">        tide::sessions::MemoryStore::new(),</span><br><span class="line">        std::env::var(&quot;TIDE_SECRET&quot;)</span><br><span class="line">            .expect(</span><br><span class="line">                &quot;Please provide a TIDE_SECRET value of at \                      least 32 bytes in order to run this example&quot;,</span><br><span class="line">            )</span><br><span class="line">            .as_bytes(),</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    app.with(tide::utils::Before(</span><br><span class="line">        |mut request: tide::Request&lt;()&gt;| async move {</span><br><span class="line">            let session = request.session_mut();</span><br><span class="line">            let visits: usize = session.get(&quot;visits&quot;).unwrap_or_default();</span><br><span class="line">            session.insert(&quot;visits&quot;, visits + 1).unwrap();</span><br><span class="line">            request</span><br><span class="line">        },</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    app.at(&quot;/&quot;).get(|req: tide::Request&lt;()&gt;| async move {</span><br><span class="line">        let visits: usize = req.session().get(&quot;visits&quot;).unwrap();</span><br><span class="line">        Ok(format!(&quot;you have visited this website {} times&quot;, visits))</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    app.at(&quot;/reset&quot;)</span><br><span class="line">        .get(|mut req: tide::Request&lt;()&gt;| async move {</span><br><span class="line">            req.session_mut().destroy();</span><br><span class="line">            Ok(tide::Redirect::new(&quot;/&quot;))</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">    app.listen(&quot;127.0.0.1:8080&quot;).await?;</span><br><span class="line"></span><br><span class="line">    Ok(())</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Tide-&#x603B;&#x7ED3;"><a href="#Tide-&#x603B;&#x7ED3;" class="headerlink" title="Tide &#x603B;&#x7ED3;"></a>Tide &#x603B;&#x7ED3;</h4><ul>
<li>Minimalistic approach. &#x7B80;&#x7EA6;&#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
<li>Uses <code>async-std</code> runtime. &#x4F7F;&#x7528; <code>async-std</code> &#x8FD0;&#x884C;&#x65F6;&#x3002;</li>
<li>Simple handler functions.  </li>
</ul>
<p>&#x7B80;&#x5355;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;</p>
<ul>
<li>Playground of async features.</li>
</ul>
<h3 id="Poem"><a href="#Poem" class="headerlink" title="Poem"></a>Poem</h3><blockquote>
<p>A program is like a poem, you cannot write a poem without writing it. &#x2014; Dijkstra</p>
</blockquote>
<p>Poem &#x7684;&#x81EA;&#x8FF0;&#x6587;&#x4EF6;&#x7528;&#x8FD9;&#x4E9B;&#x8BDD;&#x5411;&#x60A8;&#x81F4;&#x610F;&#x3002; Poem &#x58F0;&#x79F0;&#x662F;&#x4E00;&#x4E2A;&#x529F;&#x80FD;&#x9F50;&#x5168;&#x4E14;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#x7684; Web &#x6846;&#x67B6;&#x3002;&#x5927;&#x80C6;&#x7684;&#x4E3B;&#x5F20;&#xFF0C;&#x4F46;Poem&#x4F3C;&#x4E4E;&#x5151;&#x73B0;&#x4E86;&#x3002;&#x4E4D;&#x4E00;&#x770B;&#xFF0C;&#x5B83;&#x7684;&#x7528;&#x6CD5;&#x4E0E; Axum &#x975E;&#x5E38;&#x76F8;&#x4F3C;&#xFF0C;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x662F;&#x60A8;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x5B8F;&#x6765;&#x6807;&#x8BB0;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;&#x5B83;&#x8FD8;&#x57FA;&#x4E8E; Tokio &#x548C; Hyper &#x6784;&#x5EFA;&#xFF0C;&#x4E0E; Tower &#x4E2D;&#x95F4;&#x4EF6;&#x5B8C;&#x5168;&#x517C;&#x5BB9;&#xFF0C;&#x540C;&#x65F6;&#x4ECD;&#x7136;&#x66B4;&#x9732;&#x81EA;&#x5DF1;&#x7684;&#x4E2D;&#x95F4;&#x4EF6;&#x7279;&#x5F81;&#x3002;</p>
<p>Poem &#x7684;&#x4E2D;&#x95F4;&#x4EF6;&#x7279;&#x6027;&#x4E5F;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x6613;&#x7528;&#x3002;&#x60A8;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4E3A;&#x6240;&#x6709;&#x6216;&#x7279;&#x5B9A;&#x7684; <code>Endpoint</code> &#x5B9E;&#x73B0;&#x8BE5;&#x7279;&#x5F81;&#xFF08;Poem &#x8868;&#x8FBE;&#x53EF;&#x4EE5;&#x5904;&#x7406; HTTP &#x8BF7;&#x6C42;&#x7684;&#x6240;&#x6709;&#x5185;&#x5BB9;&#x7684;&#x65B9;&#x5F0F;&#xFF09;&#xFF0C;&#x6216;&#x8005;&#x60A8;&#x53EA;&#x7F16;&#x5199;&#x4E00;&#x4E2A;&#x63A5;&#x53D7; <code>Endpoint</code> &#x4F5C;&#x4E3A;&#x7684;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#x8303;&#x56F4;&#x3002;&#x5728;&#x4E0E;&#x5854;&#x548C;&#x670D;&#x52A1;&#x7279;&#x5F81;&#x6253;&#x4EA4;&#x9053;&#x5E76;&#x6709;&#x65F6;&#x6323;&#x624E;&#x4E86;&#x8FD9;&#x4E48;&#x957F;&#x65F6;&#x95F4;&#x4E4B;&#x540E;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x80A1;&#x65B0;&#x9C9C;&#x7A7A;&#x6C14;&#x3002;</p>
<p>Poem &#x4E0D;&#x4EC5;&#x4E0E;&#x66F4;&#x5E7F;&#x6CDB;&#x7684;&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x8BB8;&#x591A;&#x529F;&#x80FD;&#x517C;&#x5BB9;&#xFF0C;&#x800C;&#x4E14;&#x5B83;&#x672C;&#x8EAB;&#x4E5F;&#x5145;&#x6EE1;&#x4E86;&#x529F;&#x80FD;&#xFF0C;&#x5305;&#x62EC;&#x5BF9; OpenAPI &#x548C; Swagger &#x6587;&#x6863;&#x7684;&#x5B8C;&#x5168;&#x652F;&#x6301;&#x3002;&#x800C;&#x4E14;&#x5B83;&#x4E0D;&#x4EC5;&#x9650;&#x4E8E;&#x57FA;&#x4E8E;HTTP&#x7684;Web&#x670D;&#x52A1;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x57FA;&#x4E8E;Tonic&#x7684;gRPC&#x670D;&#x52A1;&#xFF0C;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;Lambda&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x65E0;&#x9700;&#x5207;&#x6362;&#x6846;&#x67B6;&#x3002;&#x6DFB;&#x52A0;&#x5BF9; OpenTelemetry&#x3001;Redis&#x3001;Prometheus &#x7B49;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x52FE;&#x9009;&#x4F01;&#x4E1A;&#x7EA7;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x73B0;&#x4EE3; Web &#x6846;&#x67B6;&#x7684;&#x6240;&#x6709;&#x6846;&#x3002;</p>
<p>Poem &#x4ECD;&#x5904;&#x4E8E; 0.x &#x7248;&#x672C;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x5B83;&#x4FDD;&#x6301;&#x52BF;&#x5934;&#x5E76;&#x63D0;&#x4F9B;&#x53EF;&#x9760;&#x7684; 1.0&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x6846;&#x67B6;&#xFF01;</p>
<h4 id="Poem-Example"><a href="#Poem-Example" class="headerlink" title="Poem Example"></a>Poem Example</h4><p>&#x6765;&#x81EA;&#x793A;&#x4F8B;&#x5B58;&#x50A8;&#x5E93;&#x7684; websocket &#x804A;&#x5929;&#x7684;&#x7F29;&#x5199;&#x7248;&#x672C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">rust&#x590D;&#x5236;&#x4EE3;&#x7801;#[handler]</span><br><span class="line">fn ws(</span><br><span class="line">    Path(name): Path&lt;String&gt;,</span><br><span class="line">    ws: WebSocket,</span><br><span class="line">    sender: Data&lt;&amp;tokio::sync::broadcast::Sender&lt;String&gt;&gt;,</span><br><span class="line">) -&gt; impl IntoResponse {</span><br><span class="line">    let sender = sender.clone();</span><br><span class="line">    let mut receiver = sender.subscribe();</span><br><span class="line">    ws.on_upgrade(move |socket| async move {</span><br><span class="line">        let (mut sink, mut stream) = socket.split();</span><br><span class="line"></span><br><span class="line">        tokio::spawn(async move {</span><br><span class="line">            while let Some(Ok(msg)) = stream.next().await {</span><br><span class="line">                if let Message::Text(text) = msg {</span><br><span class="line">                    if sender.send(format!(&quot;{name}: {text}&quot;)).is_err() {</span><br><span class="line">                        break;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        tokio::spawn(async move {</span><br><span class="line">            while let Ok(msg) = receiver.recv().await {</span><br><span class="line">                if sink.send(Message::Text(msg)).await.is_err() {</span><br><span class="line">                    break;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    })</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#[tokio::main]</span><br><span class="line">async fn main() -&gt; Result&lt;(), std::io::Error&gt; {</span><br><span class="line">    let app = Route::new().at(&quot;/&quot;, get(index)).at(</span><br><span class="line">        &quot;/ws/:name&quot;,</span><br><span class="line">        get(ws.data(tokio::sync::broadcast::channel::&lt;String&gt;(32).0)),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Server::new(TcpListener::bind(&quot;127.0.0.1:3000&quot;))</span><br><span class="line">        .run(app)</span><br><span class="line">        .await</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Poem-&#x603B;&#x7ED3;"><a href="#Poem-&#x603B;&#x7ED3;" class="headerlink" title="Poem &#x603B;&#x7ED3;"></a>Poem &#x603B;&#x7ED3;</h4><ul>
<li>&#x5E9E;&#x5927;&#x7684;&#x529F;&#x80FD;&#x96C6;&#x3002;</li>
<li>&#x4E0E; Tokio &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x517C;&#x5BB9;&#x3002;</li>
<li>&#x4FBF;&#x4E8E;&#x4F7F;&#x7528;&#x3002;</li>
<li>&#x9002;&#x7528;&#x4E8E; gRPC &#x548C; Lambda&#x3002;</li>
</ul>
<h2 id="&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;"><a href="#&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;" class="headerlink" title="&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;"></a>&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;</h2><h3 id="Pavex"><a href="#Pavex" class="headerlink" title="Pavex"></a>Pavex</h3><p>&#x6700;&#x521D;&#x6211;&#x8BF4;&#x8FC7;&#x6240;&#x6709; Rust Web &#x6846;&#x67B6;&#x4E4D;&#x4E00;&#x770B;&#x90FD;&#x975E;&#x5E38;&#x76F8;&#x4F3C;&#x3002;&#x4ED6;&#x4EEC;&#x5728;&#x7EC6;&#x5FAE;&#x5DEE;&#x522B;&#x4E0A;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;&#x6709;&#x65F6;&#x751A;&#x81F3;&#x6BD4;&#x5176;&#x4ED6;&#x4EBA;&#x505A;&#x5F97;&#x66F4;&#x597D;&#x3002;</p>
<p>Pavex &#x662F;&#x8BE5;&#x89C4;&#x5219;&#x7684;&#x4F8B;&#x5916;&#x3002;&#x76EE;&#x524D;&#xFF0C;Pavex &#x7684;&#x5B9E;&#x65BD;&#x8005;&#x6B63;&#x662F; Luca Palmieri&#xFF0C;&#x4ED6;&#x662F;&#x5E7F;&#x53D7;&#x6B22;&#x8FCE;&#x7684;&#x300A;&#x96F6;&#x5230;&#x751F;&#x4EA7;&#x300B;&#x4E00;&#x4E66;&#x7684;&#x4F5C;&#x8005;&#x3002;&#x53EF;&#x4EE5;&#x6BEB;&#x65E0;&#x7591;&#x95EE;&#x5730;&#x8BF4;&#xFF0C;Luca &#x77E5;&#x9053;&#x4ED6;&#x5728;&#x505A;&#x4EC0;&#x4E48;&#xFF0C;&#x4ED6;&#x6240;&#x6709;&#x7684;&#x60F3;&#x6CD5;&#x548C;&#x7ECF;&#x9A8C;&#x90FD;&#x878D;&#x5165;&#x5230;&#x4E86; Pavex &#x4E2D;&#x3002;</p>
<p>Pavex &#x6709;&#x7740;&#x663E;&#x7740;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x81EA;&#x5DF1;&#x89C6;&#x4E3A;&#x6784;&#x5EFA; Rust API &#x7684;&#x4E13;&#x7528;&#x7F16;&#x8BD1;&#x5668;&#x3002;&#x5B83;&#x9700;&#x8981;&#x5BF9;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5E94;&#x8BE5;&#x6267;&#x884C;&#x7684;&#x64CD;&#x4F5C;&#x8FDB;&#x884C;&#x9AD8;&#x7EA7;&#x63CF;&#x8FF0;&#xFF0C;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684; API Server SDK &#x5305;&#xFF0C;&#x53EF;&#x4F9B;&#x914D;&#x7F6E;&#x548C;&#x542F;&#x52A8;&#x3002;</p>
<p>Pavex &#x4ECD;&#x5904;&#x4E8E;&#x65E9;&#x671F;&#x9636;&#x6BB5;&#xFF0C;&#x4F46;&#x5B83;&#x7EDD;&#x5BF9;&#x662F;&#x4E00;&#x4E2A;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x9879;&#x76EE;&#x3002;&#x67E5;&#x770B; Luca &#x7684;&#x535A;&#x5BA2;&#x6587;&#x7AE0;&#x4E86;&#x89E3;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x6B63;&#x5982;&#x60A8;&#x6240;&#x770B;&#x5230;&#x7684;&#xFF0C;Rust Web &#x6846;&#x67B6;&#x7684;&#x4E16;&#x754C;&#x975E;&#x5E38;&#x591A;&#x6837;&#x5316;&#x3002;&#x6CA1;&#x6709;&#x4E00;&#x79CD;&#x4E07;&#x80FD;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x9009;&#x62E9;&#x6700;&#x9002;&#x5408;&#x60A8;&#x9700;&#x6C42;&#x7684;&#x6846;&#x67B6;&#x3002;&#x5982;&#x679C;&#x60A8;&#x521A;&#x521A;&#x5F00;&#x59CB;&#xFF0C;&#x6211;&#x5EFA;&#x8BAE;&#x60A8;&#x4F7F;&#x7528; Actix &#x6216; Axum&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x6700;&#x9002;&#x5408;&#x521D;&#x5B66;&#x8005;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x5E76;&#x4E14;&#x6709;&#x5F88;&#x68D2;&#x7684;&#x6587;&#x6863;&#x3002;&#x5C31;&#x6211;&#x4E2A;&#x4EBA;&#x800C;&#x8A00;&#xFF0C;&#x6211;&#x5BF9; Pavex &#x5C06;&#x5E26;&#x6765;&#x4EC0;&#x4E48;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x8BF4;&#x5B9E;&#x8BDD;&#xFF0C;&#x5728;&#x6210;&#x4E3A; Axum &#x7684;&#x957F;&#x671F;&#x7528;&#x6237;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x771F;&#x7684;&#x5F88;&#x60F3;&#x770B;&#x770B; Poem&#x3002;</p>
<p><a href="/external_links/24fa49b5b8a06e4c03ef3ab56bfc3ed8.html" target="blank" rel="noopener">&#x539F;&#x6587;&#x5730;&#x5740;:Best Rust Web Frameworks to Use in 2023</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/275c76e627f1fb57697726e2bffca3ff.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../78/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../78/">78</a><span class="page-number current">79</span><a class="page-number" href="../80/">80</a><span class="space">&hellip;</span><a class="page-number" href="../399/">399</a><a class="extend next" rel="next" href="../80/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">3990</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1304</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
