<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/145/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/145/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035986652719742989.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035986652719742989.html" itemprop="url">mica-mqtt 120 发布完善集群功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:42:00+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x4E00;&#x3001;&#x7B80;&#x4ECB;"><a href="#&#x4E00;&#x3001;&#x7B80;&#x4ECB;" class="headerlink" title="&#x4E00;&#x3001;&#x7B80;&#x4ECB;"></a>&#x4E00;&#x3001;&#x7B80;&#x4ECB;</h2><p><strong>mica-mqtt</strong> &#x57FA;&#x4E8E; <strong>t-io</strong> &#x5B9E;&#x73B0;&#x7684;<strong>&#x7B80;&#x5355;</strong>&#x3001;<strong>&#x4F4E;&#x5EF6;&#x8FDF;</strong>&#x3001;<strong>&#x9AD8;&#x6027;&#x80FD;</strong> &#x7684; mqtt &#x7269;&#x8054;&#x7F51;&#x5F00;&#x6E90;&#x7EC4;&#x4EF6;&#x3002;<strong>&#x4F7F;&#x7528;&#x8BE6;&#x89C1; mica-mqtt gitee &#x6E90;&#x7801;</strong> <a href="/external_links/9ae8a8b779313dfafaaa0d2555e97c44.html" target="blank" rel="noopener">mica-mqtt-example &#x6A21;&#x5757;</a>&#x3002;</p>
<p><strong>mica-mqtt</strong> &#x66F4;&#x52A0;&#x6613;&#x4E8E;&#x96C6;&#x6210;&#x5230;&#x5DF2;&#x6709;&#x670D;&#x52A1;&#x548C;&#x4E8C;&#x6B21;&#x5F00;&#x53D1;&#xFF0C;&#x964D;&#x4F4E;&#x81EA;&#x7814;&#x7269;&#x8054;&#x7F51;&#x5E73;&#x53F0;&#x5F00;&#x53D1;&#x6210;&#x672C;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;&#x529F;&#x80FD;"><a href="#&#x4E8C;&#x3001;&#x529F;&#x80FD;" class="headerlink" title="&#x4E8C;&#x3001;&#x529F;&#x80FD;"></a>&#x4E8C;&#x3001;&#x529F;&#x80FD;</h2><ul>
<li>&#x652F;&#x6301; MQTT v3.1&#x3001;v3.1.1 &#x4EE5;&#x53CA; v5.0 &#x534F;&#x8BAE;&#x3002;</li>
<li>&#x652F;&#x6301; websocket mqtt &#x5B50;&#x534F;&#x8BAE;&#xFF08;&#x652F;&#x6301; mqtt.js&#xFF09;&#x3002;</li>
<li>&#x652F;&#x6301; http rest api&#xFF0C;<a href="/external_links/99ec2facf82ca962f8e83d02c2327642.html" target="blank" rel="noopener">http api &#x6587;&#x6863;&#x8BE6;&#x89C1;</a>&#x3002;</li>
<li>&#x652F;&#x6301; MQTT client &#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
<li>&#x652F;&#x6301; MQTT server &#x670D;&#x52A1;&#x7AEF;&#x3002;</li>
<li>&#x652F;&#x6301; MQTT &#x9057;&#x5631;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x652F;&#x6301; MQTT &#x4FDD;&#x7559;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x652F;&#x6301;&#x81EA;&#x5B9A;&#x4E49;&#x6D88;&#x606F;&#xFF08;mq&#xFF09;&#x5904;&#x7406;&#x8F6C;&#x53D1;&#x5B9E;&#x73B0;&#x96C6;&#x7FA4;&#x3002;</li>
<li>MQTT &#x5BA2;&#x6237;&#x7AEF; &#x963F;&#x91CC;&#x4E91; mqtt &#x8FDE;&#x63A5; demo&#x3002;</li>
<li>&#x652F;&#x6301; GraalVM &#x7F16;&#x8BD1;&#x6210;&#x672C;&#x673A;&#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x3002;</li>
<li>&#x652F;&#x6301; Spring boot &#x9879;&#x76EE;&#x5FEB;&#x901F;&#x63A5;&#x5165;&#xFF08;mica-mqtt-spring-boot-starter&#xFF09;&#x3002;</li>
<li>mica-mqtt-spring-boot-starter &#x652F;&#x6301;&#x5BF9;&#x63A5; Prometheus + Grafana&#x3002;</li>
<li>&#x57FA;&#x4E8E; redis pub/sub &#x5B9E;&#x73B0;&#x96C6;&#x7FA4;&#xFF0C;&#x8BE6;&#x89C1; <a href="/external_links/7f11dff50a188027300d948799a2fe67.html" target="blank" rel="noopener">mica-mqtt-broker &#x6A21;&#x5757;</a>&#x3002;</li>
</ul>
<h2 id="&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x573A;&#x666F;"><a href="#&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x573A;&#x666F;" class="headerlink" title="&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x573A;&#x666F;"></a>&#x4E09;&#x3001;&#x4F7F;&#x7528;&#x573A;&#x666F;</h2><ul>
<li>&#x7269;&#x8054;&#x7F51;&#xFF08;&#x4E91;&#x7AEF;&#xFF09;</li>
<li>&#x7269;&#x8054;&#x7F51;&#xFF08;&#x8FB9;&#x7F18;&#x7AEF;&#xFF09;</li>
<li>&#x7FA4;&#x7EC4;&#x7C7B; IM</li>
<li>&#x6D88;&#x606F;&#x63A8;&#x9001;</li>
</ul>
<h2 id="&#x56DB;&#x3001;&#x5F85;&#x529E;"><a href="#&#x56DB;&#x3001;&#x5F85;&#x529E;" class="headerlink" title="&#x56DB;&#x3001;&#x5F85;&#x529E;"></a>&#x56DB;&#x3001;&#x5F85;&#x529E;</h2><ul>
<li>&#x4F18;&#x5316;&#x5904;&#x7406; mqtt session&#xFF0C;&#x4EE5;&#x53CA;&#x652F;&#x6301;&#x90E8;&#x5206; mqtt v5.0 &#x65B0;&#x7279;&#x6027;&#x3002;</li>
<li>&#x57FA;&#x4E8E; easy-rule + druid sql &#x89E3;&#x6790;&#xFF0C;&#x5B9E;&#x73B0;&#x89C4;&#x5219;&#x5F15;&#x64CE;&#x3002;</li>
</ul>
<h2 id="&#x4E94;&#x3001;&#x66F4;&#x65B0;&#x8BB0;&#x5F55;"><a href="#&#x4E94;&#x3001;&#x66F4;&#x65B0;&#x8BB0;&#x5F55;" class="headerlink" title="&#x4E94;&#x3001;&#x66F4;&#x65B0;&#x8BB0;&#x5F55;"></a>&#x4E94;&#x3001;&#x66F4;&#x65B0;&#x8BB0;&#x5F55;</h2><ul>
<li>:sparkles: mqtt-mqtt-core client IMqttClientConnectListener &#x6DFB;&#x52A0; onDisconnect &#x65B9;&#x6CD5;&#x3002;gitee #I4JT1D &#x611F;&#x8C22; <code>@willianfu</code> &#x540C;&#x5B66;&#x53CD;&#x9988;&#x3002;</li>
<li>:sparkles: mica-mqtt-core server IMqttMessageListener &#x63A5;&#x53E3;&#x8C03;&#x6574;&#xFF0C;&#x4E0D;&#x517C;&#x5BB9;&#x8001;&#x7248;&#x672C;&#x3002;</li>
<li>:sparkles: mica-mqtt-broker &#x8C03;&#x6574;&#x4E0A;&#x4E0B;&#x884C;&#x6D88;&#x606F;&#x901A;&#x9053;&#x3002;</li>
<li>:sparkles: mica-mqtt-broker &#x6DFB;&#x52A0;&#x8282;&#x70B9;&#x7BA1;&#x7406;&#xFF0C;&#x62BD;&#x8C61;&#x4E1A;&#x52A1;&#x5C42;&#xFF0C;&#x65B9;&#x4FBF;&#x63A5;&#x5165;&#xFF0C;&#x540E;&#x7EED;&#x7248;&#x672C;&#x4F1A;&#x5BF9;&#x63A5;&#x89C4;&#x5219;&#x5F15;&#x64CE;&#x3002;</li>
<li>:sparkles: mica-mqtt-broker &#x8C03;&#x6574;&#x9ED8;&#x8BA4;&#x7684; Message &#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;&#xFF0C;&#x4E0D;&#x517C;&#x5BB9;&#x8001;&#x7248;&#x672C;&#x3002;</li>
<li>:sparkles: mica-mqtt-broker &#x4F18;&#x5316;&#x8BBE;&#x5907;&#x4E0A;&#x4E0B;&#x7EBF;&#xFF0C;&#x5904;&#x7406;&#x8282;&#x70B9;&#x505C;&#x673A;&#x7684;&#x60C5;&#x51B5;&#x3002;</li>
<li>:sparkles: &#x62BD;&#x53D6; mica-mqtt-model &#x6A21;&#x5757;&#xFF0C;&#x65B9;&#x4FBF;&#x540E;&#x671F;&#x652F;&#x6301;&#x6D88;&#x606F;&#x6865;&#x63A5;&#xFF0C;Message &#x6DFB;&#x52A0;&#x9ED8;&#x8BA4;&#x7684;&#x6D88;&#x606F;&#x5E8F;&#x5217;&#x5316;&#x3002; gitee #I4ECEO</li>
<li>:sparkles: mica-mqtt-model &#x5B8C;&#x5584; Message &#x6D88;&#x606F;&#x6A21;&#x578B;&#xFF0C;&#x65B9;&#x4FBF;&#x96C6;&#x7FA4;&#x3002;</li>
<li>:bug: mica-mqtt-core MqttClient &#x4FEE;&#x590D; ssl &#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#xFF0C;&#x611F;&#x8C22; <code>@hjkJOJO</code> &#x540C;&#x5B66;&#x53CD;&#x9988;&#x3002;</li>
<li>:bug: &#x4FEE;&#x590D; websocket mqtt.js &#x9700;&#x8981;&#x62C6;&#x5305; gitee #I4JYJX &#x611F;&#x8C22; <code>@Symous</code> &#x540C;&#x5B66;&#x53CD;&#x9988;&#x3002;</li>
<li>:memo: &#x5B8C;&#x5584; mica-mqtt-broker README.md&#xFF0C;&#x6DFB;&#x52A0;&#x4E8C;&#x5F00;&#x8BF4;&#x660E;&#x3002;</li>
<li>:memo: &#x7EDF;&#x4E00; mica-mqtt server ip &#x6587;&#x6863;&#x3002;</li>
<li>:memo: &#x66F4;&#x65B0; README.md</li>
<li>:arrow_up: &#x5347;&#x7EA7; tio &#x5230; 3.7.5.v20211028-RELEASE AioDecodeException &#x6539;&#x4E3A; TioDecodeException&#xFF0C;</li>
</ul>
<h2 id="&#x516D;&#x3001;&#x91CD;&#x8981;&#x66F4;&#x65B0;&#x8BF4;&#x660E;"><a href="#&#x516D;&#x3001;&#x91CD;&#x8981;&#x66F4;&#x65B0;&#x8BF4;&#x660E;" class="headerlink" title="&#x516D;&#x3001;&#x91CD;&#x8981;&#x66F4;&#x65B0;&#x8BF4;&#x660E;"></a>&#x516D;&#x3001;&#x91CD;&#x8981;&#x66F4;&#x65B0;&#x8BF4;&#x660E;</h2><h3 id="6-1-&#x5BA2;&#x6237;&#x7AEF;-IMqttClientConnectListener-&#x6DFB;&#x52A0;-onDisconnect-&#x65B9;&#x6CD5;"><a href="#6-1-&#x5BA2;&#x6237;&#x7AEF;-IMqttClientConnectListener-&#x6DFB;&#x52A0;-onDisconnect-&#x65B9;&#x6CD5;" class="headerlink" title="6.1 &#x5BA2;&#x6237;&#x7AEF; IMqttClientConnectListener &#x6DFB;&#x52A0; onDisconnect &#x65B9;&#x6CD5;"></a>6.1 &#x5BA2;&#x6237;&#x7AEF; IMqttClientConnectListener &#x6DFB;&#x52A0; onDisconnect &#x65B9;&#x6CD5;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public interface IMqttClientConnectListener {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x76D1;&#x542C;&#x5230;&#x6D88;&#x606F;</span><br><span class="line">     *</span><br><span class="line">     * @param context     ChannelContext</span><br><span class="line">     * @param isReconnect &#x662F;&#x5426;&#x91CD;&#x8FDE;</span><br><span class="line">     */</span><br><span class="line">    void onConnected(ChannelContext context, boolean isReconnect);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x8FDE;&#x63A5;&#x5173;&#x95ED;&#x524D;&#x89E6;&#x53D1;&#x672C;&#x65B9;&#x6CD5;</span><br><span class="line">     *</span><br><span class="line">     * @param channelContext the channelContext</span><br><span class="line">     * @param throwable      the throwable &#x6709;&#x53EF;&#x80FD;&#x4E3A;&#x7A7A;</span><br><span class="line">     * @param remark         the remark &#x6709;&#x53EF;&#x80FD;&#x4E3A;&#x7A7A;</span><br><span class="line">     * @param isRemove       is removed</span><br><span class="line">     */</span><br><span class="line">    void onDisconnect(ChannelContext channelContext, Throwable throwable, String remark, boolean isRemove);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="6-2-&#x670D;&#x52A1;&#x7AEF;-IMqttMessageListener-onMessage-&#x53C2;&#x6570;&#x8C03;&#x6574;"><a href="#6-2-&#x670D;&#x52A1;&#x7AEF;-IMqttMessageListener-onMessage-&#x53C2;&#x6570;&#x8C03;&#x6574;" class="headerlink" title="6.2 &#x670D;&#x52A1;&#x7AEF; IMqttMessageListener onMessage &#x53C2;&#x6570;&#x8C03;&#x6574;"></a>6.2 &#x670D;&#x52A1;&#x7AEF; IMqttMessageListener onMessage &#x53C2;&#x6570;&#x8C03;&#x6574;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@FunctionalInterface</span><br><span class="line">public interface IMqttMessageListener {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x76D1;&#x542C;&#x5230;&#x6D88;&#x606F;</span><br><span class="line">     *</span><br><span class="line">     * @param context  ChannelContext</span><br><span class="line">     * @param clientId clientId</span><br><span class="line">     * @param message  Message</span><br><span class="line">     */</span><br><span class="line">    void onMessage(ChannelContext context, String clientId, Message message);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="6-3-Message-&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x5C5E;&#x6027;"><a href="#6-3-Message-&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x5C5E;&#x6027;" class="headerlink" title="6.3 Message &#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x5C5E;&#x6027;"></a>6.3 Message &#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x66F4;&#x591A;&#x5C5E;&#x6027;</h3><p>&#x4E3A;&#x4E86;&#x4EE5;&#x540E;&#x7248;&#x672C;&#x66F4;&#x65B9;&#x4FBF;&#x7684;&#x5BF9;&#x63A5;&#x89C4;&#x5219;&#x5F15;&#x64CE;&#x5BF9; Message &#x4E2D;&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x4E86;&#x6269;&#x5145;&#xFF0C;&#x5E76;&#x4E14;&#x5185;&#x7F6E; DefaultMessageSerializer &#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x57FA;&#x4E8E; <code>ByteBuffer</code> &#x8FDB;&#x884C;&#x7684;&#x7C7B;&#x534F;&#x8BAE;&#x89E3;&#x6790;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x901F;&#x5EA6;&#x66F4;&#x5FEB;&#xFF0C;&#x62A5;&#x6587;&#x66F4;&#x5C0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;byte[] data = DefaultMessageSerializer.INSTANCE.serialize(message);</span><br><span class="line">Message message1 = DefaultMessageSerializer.INSTANCE.deserialize(data);</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E03;&#x3001;Spring-boot-&#x5FEB;&#x901F;&#x63A5;&#x5165;"><a href="#&#x4E03;&#x3001;Spring-boot-&#x5FEB;&#x901F;&#x63A5;&#x5165;" class="headerlink" title="&#x4E03;&#x3001;Spring boot &#x5FEB;&#x901F;&#x63A5;&#x5165;"></a>&#x4E03;&#x3001;Spring boot &#x5FEB;&#x901F;&#x63A5;&#x5165;</h2><h3 id="7-1-&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"><a href="#7-1-&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;" class="headerlink" title="7.1 &#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"></a>7.1 &#x6DFB;&#x52A0;&#x4F9D;&#x8D56;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;net.dreamlu&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mica-mqtt-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x793A;&#x4F8B;"><a href="#7-2-&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x793A;&#x4F8B;" class="headerlink" title="7.2 &#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x793A;&#x4F8B;"></a>7.2 &#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x793A;&#x4F8B;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;mqtt:</span><br><span class="line">  server:</span><br><span class="line">    enabled: true               # &#x662F;&#x5426;&#x5F00;&#x542F;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;true</span><br><span class="line">    ip: 0.0.0.0                 # &#x670D;&#x52A1;&#x7AEF; ip &#x9ED8;&#x8BA4;&#xFF1A;0.0.0.0</span><br><span class="line">    port: 5883                  # &#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;1883</span><br><span class="line">    name: Mica-Mqtt-Server      # &#x540D;&#x79F0;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;Mica-Mqtt-Server</span><br><span class="line">    buffer-allocator: HEAP      # &#x5806;&#x5185;&#x5B58;&#x548C;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;&#x5806;&#x5185;&#x5B58;</span><br><span class="line">    heartbeat-timeout: 120000   # &#x5FC3;&#x8DF3;&#x8D85;&#x65F6;&#xFF0C;&#x5355;&#x4F4D;&#x6BEB;&#x79D2;&#xFF0C;&#x9ED8;&#x8BA4;: 1000 * 120</span><br><span class="line">    read-buffer-size: 8092      # &#x63A5;&#x6536;&#x6570;&#x636E;&#x7684; buffer size&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;8092</span><br><span class="line">    max-bytes-in-message: 8092  # &#x6D88;&#x606F;&#x89E3;&#x6790;&#x6700;&#x5927; bytes &#x957F;&#x5EA6;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;8092</span><br><span class="line">    debug: true                 # &#x5982;&#x679C;&#x5F00;&#x542F; prometheus &#x6307;&#x6807;&#x6536;&#x96C6;&#x5EFA;&#x8BAE;&#x5173;&#x95ED;</span><br><span class="line">    websocket-enable: true      # &#x5F00;&#x542F; websocket &#x5B50;&#x534F;&#x8BAE;&#xFF0C;&#x9ED8;&#x8BA4;&#x5F00;&#x542F;</span><br><span class="line">    websocket-port: 8083        # websocket &#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;8083</span><br></pre></td></tr></table></figure>

<h3 id="7-3-&#x670D;&#x52A1;&#x7AEF;&#x53EF;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#xFF08;&#x6CE8;&#x518C;&#x6210;-Spring-Bean-&#x5373;&#x53EF;&#xFF09;"><a href="#7-3-&#x670D;&#x52A1;&#x7AEF;&#x53EF;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#xFF08;&#x6CE8;&#x518C;&#x6210;-Spring-Bean-&#x5373;&#x53EF;&#xFF09;" class="headerlink" title="7.3 &#x670D;&#x52A1;&#x7AEF;&#x53EF;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#xFF08;&#x6CE8;&#x518C;&#x6210; Spring Bean &#x5373;&#x53EF;&#xFF09;"></a>7.3 &#x670D;&#x52A1;&#x7AEF;&#x53EF;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;&#xFF08;&#x6CE8;&#x518C;&#x6210; Spring Bean &#x5373;&#x53EF;&#xFF09;</h3><table>
<thead>
<tr>
<th>&#x63A5;&#x53E3;</th>
<th>&#x662F;&#x5426;&#x5FC5;&#x987B;</th>
<th>&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody><tr>
<td>IMqttServerUniqueIdService</td>
<td>&#x5426;</td>
<td>&#x7528;&#x4E8E; clientId &#x4E0D;&#x552F;&#x4E00;&#x65F6;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;&#x5B9E;&#x73B0;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#xFF0C;&#x540E;&#x7EED;&#x63A5;&#x53E3;&#x4F7F;&#x7528;&#x5B83;&#x66FF;&#x4EE3; clientId</td>
</tr>
<tr>
<td>IMqttServerAuthHandler</td>
<td>&#x662F;</td>
<td>&#x7528;&#x4E8E;&#x670D;&#x52A1;&#x7AEF;&#x8BA4;&#x8BC1;</td>
</tr>
<tr>
<td>IMqttServerSubscribeValidator</td>
<td>&#x662F;</td>
<td>1.1.3 &#x65B0;&#x589E;&#xFF0C;&#x7528;&#x4E8E;&#x670D;&#x52A1;&#x7AEF;&#x8BA2;&#x9605;&#x6821;&#x9A8C;</td>
</tr>
<tr>
<td>IMqttMessageListener</td>
<td>&#x662F;</td>
<td>&#x6D88;&#x606F;&#x76D1;&#x542C;</td>
</tr>
<tr>
<td>IMqttConnectStatusListener</td>
<td>&#x662F;</td>
<td>&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x76D1;&#x542C;</td>
</tr>
<tr>
<td>IMqttSessionManager</td>
<td>&#x5426;</td>
<td>session &#x7BA1;&#x7406;</td>
</tr>
<tr>
<td>IMqttMessageStore</td>
<td>&#x96C6;&#x7FA4;&#x662F;&#xFF0C;&#x5355;&#x673A;&#x5426;</td>
<td>&#x9057;&#x5631;&#x548C;&#x4FDD;&#x7559;&#x6D88;&#x606F;&#x5B58;&#x50A8;</td>
</tr>
<tr>
<td>AbstractMqttMessageDispatcher</td>
<td>&#x96C6;&#x7FA4;&#x662F;&#xFF0C;&#x5355;&#x673A;&#x5426;</td>
<td>&#x6D88;&#x606F;&#x8F6C;&#x53D1;&#xFF0C;&#xFF08;&#x9057;&#x5631;&#x3001;&#x4FDD;&#x7559;&#x6D88;&#x606F;&#x8F6C;&#x53D1;&#xFF09;</td>
</tr>
<tr>
<td>IpStatListener</td>
<td>&#x5426;</td>
<td>t-io ip &#x72B6;&#x6001;&#x76D1;&#x542C;</td>
</tr>
</tbody></table>
<h3 id="7-4-Prometheus-Grafana-&#x76D1;&#x63A7;&#x5BF9;&#x63A5;"><a href="#7-4-Prometheus-Grafana-&#x76D1;&#x63A7;&#x5BF9;&#x63A5;" class="headerlink" title="7.4 Prometheus + Grafana &#x76D1;&#x63A7;&#x5BF9;&#x63A5;"></a>7.4 Prometheus + Grafana &#x76D1;&#x63A7;&#x5BF9;&#x63A5;</h3><p>&#x5F97;&#x76CA;&#x4E8E; <strong>t-io</strong> &#x826F;&#x597D;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x76D1;&#x63A7;&#x6307;&#x6807;&#x76F4;&#x63A5;&#x5BF9;&#x63A5;&#x7684; <strong>t-iostat</strong>&#xFF0C;&#x76EE;&#x524D;&#x652F;&#x6301;&#x4E0B;&#x5217;&#x6307;&#x6807;&#xFF0C;&#x540E;&#x671F;&#x4F1A;&#x4E0D;&#x65AD;&#x5B8C;&#x5584;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x652F;&#x6301;&#x5F97;&#x6307;&#x6807;</th>
<th>&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody><tr>
<td>mqtt_connections_accepted</td>
<td>&#x5171;&#x63A5;&#x53D7;&#x8FC7;&#x8FDE;&#x63A5;&#x6570;</td>
</tr>
<tr>
<td>mqtt_connections_closed</td>
<td>&#x5173;&#x95ED;&#x8FC7;&#x7684;&#x8FDE;&#x63A5;&#x6570;</td>
</tr>
<tr>
<td>mqtt_connections_size</td>
<td>&#x5F53;&#x524D;&#x8FDE;&#x63A5;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_handled_packets</td>
<td>&#x5DF2;&#x5904;&#x7406;&#x6D88;&#x606F;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_handled_bytes</td>
<td>&#x5DF2;&#x5904;&#x7406;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_received_packets</td>
<td>&#x5DF2;&#x63A5;&#x6536;&#x6D88;&#x606F;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_received_bytes</td>
<td>&#x5DF2;&#x5904;&#x7406;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_send_packets</td>
<td>&#x5DF2;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6570;</td>
</tr>
<tr>
<td>mqtt_messages_send_bytes</td>
<td>&#x5DF2;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;</td>
</tr>
</tbody></table>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/caae1b7604d9a41adc33dffbeac1f2eae4cb41420146127717c3909410235ddc" alt="mqtt&#x76D1;&#x63A7;1.jpg"></p>
<p>&#x5173;&#x4E8E; <strong>mica-mqtt-spring-boot-starter</strong> &#x66F4;&#x591A;&#x8BF7;&#x67E5;&#x770B;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/750d83567edcf156cc48073d367ad684.html" target="blank" rel="noopener">gitee.com/596392912/m&#x2026;</a></p>
<h2 id="&#x516B;&#x3001;&#x666E;&#x901A;-java-&#x9879;&#x76EE;&#x63A5;&#x5165;"><a href="#&#x516B;&#x3001;&#x666E;&#x901A;-java-&#x9879;&#x76EE;&#x63A5;&#x5165;" class="headerlink" title="&#x516B;&#x3001;&#x666E;&#x901A; java &#x9879;&#x76EE;&#x63A5;&#x5165;"></a>&#x516B;&#x3001;&#x666E;&#x901A; java &#x9879;&#x76EE;&#x63A5;&#x5165;</h2><h3 id="8-1-maven-&#x4F9D;&#x8D56;"><a href="#8-1-maven-&#x4F9D;&#x8D56;" class="headerlink" title="8.1 maven &#x4F9D;&#x8D56;"></a>8.1 maven &#x4F9D;&#x8D56;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801; &lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;net.dreamlu&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;mica-mqtt-core&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;1.2.0&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-mica-mqtt-&#x5BA2;&#x6237;&#x7AEF;"><a href="#8-2-mica-mqtt-&#x5BA2;&#x6237;&#x7AEF;" class="headerlink" title="8.2 mica-mqtt &#x5BA2;&#x6237;&#x7AEF;"></a>8.2 mica-mqtt &#x5BA2;&#x6237;&#x7AEF;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801; // &#x521D;&#x59CB;&#x5316; mqtt &#x5BA2;&#x6237;&#x7AEF;</span><br><span class="line"> MqttClient client = MqttClient.create()</span><br><span class="line">     .ip(&quot;127.0.0.1&quot;)</span><br><span class="line">     .port(1883)                     // &#x9ED8;&#x8BA4;&#xFF1A;1883</span><br><span class="line">     .username(&quot;admin&quot;)</span><br><span class="line">     .password(&quot;123456&quot;)</span><br><span class="line">     .version(MqttVersion.MQTT_5)    // &#x9ED8;&#x8BA4;&#xFF1A;3_1_1</span><br><span class="line">     .clientId(&quot;xxxxxx&quot;)             // &#x9ED8;&#x8BA4;&#xFF1A;MICA-MQTT- &#x524D;&#x7F00;&#x548C; 36&#x8FDB;&#x5236;&#x7684;&#x7EB3;&#x79D2;&#x6570;</span><br><span class="line">     .connect();                     // &#x8FDE;&#x63A5;</span><br><span class="line"> </span><br><span class="line">     // &#x6D88;&#x606F;&#x8BA2;&#x9605;&#xFF0C;&#x540C;&#x7C7B;&#x65B9;&#x6CD5; subxxx</span><br><span class="line">     client.subQos0(&quot;/test/#&quot;, (topic, payload) -&gt; {</span><br><span class="line">         logger.info(topic + &apos;\t&apos; + ByteBufferUtil.toString(payload));</span><br><span class="line">     });</span><br><span class="line">     // &#x53D6;&#x6D88;&#x8BA2;&#x9605;</span><br><span class="line">     client.unSubscribe(&quot;/test/#&quot;);</span><br><span class="line"> </span><br><span class="line">     // &#x53D1;&#x9001;&#x6D88;&#x606F;</span><br><span class="line">     client.publish(&quot;/test/client&quot;, ByteBuffer.wrap(&quot;mica&#x6700;&#x725B;&#x76AE;&quot;.getBytes(StandardCharsets.UTF_8)));</span><br><span class="line"> </span><br><span class="line">     // &#x65AD;&#x5F00;&#x8FDE;&#x63A5;</span><br><span class="line">     client.disconnect();</span><br><span class="line">     // &#x91CD;&#x8FDE;</span><br><span class="line">     client.reconnect();</span><br><span class="line">     // &#x505C;&#x6B62;</span><br><span class="line">     client.stop();</span><br></pre></td></tr></table></figure>

<h3 id="8-3-mica-mqtt-&#x670D;&#x52A1;&#x7AEF;"><a href="#8-3-mica-mqtt-&#x670D;&#x52A1;&#x7AEF;" class="headerlink" title="8.3 mica-mqtt &#x670D;&#x52A1;&#x7AEF;"></a>8.3 mica-mqtt &#x670D;&#x52A1;&#x7AEF;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x6CE8;&#x610F;&#xFF1A;&#x4E3A;&#x4E86;&#x80FD;&#x63A5;&#x53D7;&#x66F4;&#x591A;&#x94FE;&#x63A5;&#xFF08;&#x964D;&#x4F4E;&#x5185;&#x5B58;&#xFF09;&#xFF0C;&#x8BF7;&#x6DFB;&#x52A0; jvm &#x53C2;&#x6570; -Xss129k</span><br><span class="line">MqttServer mqttServer = MqttServer.create()</span><br><span class="line">    // &#x9ED8;&#x8BA4;&#xFF1A;0.0.0.0</span><br><span class="line">    .ip(&quot;0.0.0.0&quot;)</span><br><span class="line">    // &#x9ED8;&#x8BA4;&#xFF1A;1883</span><br><span class="line">    .port(1883)</span><br><span class="line">    // &#x9ED8;&#x8BA4;&#x4E3A;&#xFF1A; 8092&#xFF08;mqtt &#x9ED8;&#x8BA4;&#x6700;&#x5927;&#x6D88;&#x606F;&#x5927;&#x5C0F;&#xFF09;&#xFF0C;&#x4E3A;&#x4E86;&#x964D;&#x4F4E;&#x5185;&#x5B58;&#x53EF;&#x4EE5;&#x51CF;&#x5C0F;&#x5C0F;&#x6B64;&#x53C2;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x6D88;&#x606F;&#x8FC7;&#x5927; t-io &#x4F1A;&#x5C1D;&#x8BD5;&#x89E3;&#x6790;&#x591A;&#x6B21;&#xFF08;&#x5EFA;&#x8BAE;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x4E1A;&#x52A1;&#x60C5;&#x51B5;&#x800C;&#x5B9A;&#xFF09;</span><br><span class="line">    .readBufferSize(512)</span><br><span class="line">    // &#x6D88;&#x606F;&#x76D1;&#x542C;</span><br><span class="line">    .messageListener((context, clientId, message) -&gt; {</span><br><span class="line">        logger.info(&quot;clientId:{} message:{} payload:{}&quot;, clientId, message, ByteBufferUtil.toString(message.getPayload()));</span><br><span class="line">    })</span><br><span class="line">    .debug() // &#x5F00;&#x542F; t-io debug &#x4FE1;&#x606F;&#x65E5;&#x5FD7;</span><br><span class="line">    .start();</span><br><span class="line"></span><br><span class="line">// &#x53D1;&#x9001;&#x7ED9;&#x67D0;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;</span><br><span class="line">mqttServer.publish(&quot;clientId&quot;,&quot;/test/123&quot;, ByteBuffer.wrap(&quot;mica&#x6700;&#x725B;&#x76AE;&quot;.getBytes()));</span><br><span class="line"></span><br><span class="line">// &#x53D1;&#x9001;&#x7ED9;&#x6240;&#x6709;&#x5728;&#x7EBF;&#x76D1;&#x542C;&#x8FD9;&#x4E2A; topic &#x7684;&#x5BA2;&#x6237;&#x7AEF;</span><br><span class="line">mqttServer.publishAll(&quot;/test/123&quot;, ByteBuffer.wrap(&quot;mica&#x6700;&#x725B;&#x76AE;&quot;.getBytes()));</span><br><span class="line"></span><br><span class="line">// &#x505C;&#x6B62;&#x670D;&#x52A1;</span><br><span class="line">mqttServer.stop();</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E5D;&#x3001;&#x96C6;&#x7FA4;&#x6F14;&#x793A;&#x89C6;&#x9891;"><a href="#&#x4E5D;&#x3001;&#x96C6;&#x7FA4;&#x6F14;&#x793A;&#x89C6;&#x9891;" class="headerlink" title="&#x4E5D;&#x3001;&#x96C6;&#x7FA4;&#x6F14;&#x793A;&#x89C6;&#x9891;"></a>&#x4E5D;&#x3001;&#x96C6;&#x7FA4;&#x6F14;&#x793A;&#x89C6;&#x9891;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/b8fc3d23af7e09977b31bf802de1cbb20009953a824a3a8dee9d739ca3bd11bf" alt="mica-mqtt&#x96C6;&#x7FA4;.gif"></p>
<blockquote>
<p>&#x5173;&#x6CE8;&#x300A;mica&#x5FAE;&#x670D;&#x52A1;&#x4E13;&#x680F;&#x300B;&#xFF0C;&#x66F4;&#x591A;<strong>&#x7CBE;&#x5F69;&#x5185;&#x5BB9;</strong>&#x6BCF;&#x5929;&#x7B49;&#x4F60;&#x6765;&#x53D1;&#x73B0;&#xFF01;</p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/db8cb1983e7c1cd86d321b7452a37dfd.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035985259439063047.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035985259439063047.html" itemprop="url">关于Nginx你了解多少了呢 写在前面 Nginx负载均衡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:37:22+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x8FD9;&#x662F;&#x6211;&#x53C2;&#x4E0E;11&#x6708;&#x66F4;&#x6587;&#x6311;&#x6218;&#x7684;&#x7B2C;27&#x5929;&#xFF0C;&#x6D3B;&#x52A8;&#x8BE6;&#x60C5;&#x67E5;&#x770B;&#xFF1A;<a href="https://dev.newban.cn/7023643374569816095">2021&#x6700;&#x540E;&#x4E00;&#x6B21;&#x66F4;&#x6587;&#x6311;&#x6218;</a></p>
</blockquote>
<h1 id="&#x5199;&#x5728;&#x524D;&#x9762;"><a href="#&#x5199;&#x5728;&#x524D;&#x9762;" class="headerlink" title="&#x5199;&#x5728;&#x524D;&#x9762;"></a>&#x5199;&#x5728;&#x524D;&#x9762;</h1><p>&#x5173;&#x4E8E;Nginx&#x4F60;&#x4E86;&#x89E3;&#x591A;&#x5C11;&#x4E86;&#x5462;&#xFF1F;</p>
<p>&#x4ECA;&#x5929;&#x6211;&#x60F3;&#x5206;&#x4EAB;&#x4E00;&#x4E0B;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x548C;&#x955C;&#x50CF;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<h1 id="Nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;"><a href="#Nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;" class="headerlink" title="Nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;"></a>Nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;</h1><h2 id="nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x4ECB;&#x7ECD;"><a href="#nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x4ECB;&#x7ECD;" class="headerlink" title="nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x4ECB;&#x7ECD;"></a>nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x4ECB;&#x7ECD;</h2><p>&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x610F;&#x601D;&#x662F;&#x5728;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4F5C;&#x4E3A;&#x8C03;&#x5EA6;&#x8005;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x6240;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x7531;&#x8C03;&#x5EA6;&#x8005;&#x63A5;&#x6536;&#xFF0C;&#x8C03;&#x5EA6;&#x8005;&#x518D;&#x6839;&#x636E;&#x6BCF;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8D1F;&#x8F7D;&#x60C5;&#x51B5;&#xFF0C;&#x5C06;&#x8BF7;&#x6C42;&#x5206;&#x914D;&#x7ED9;&#x5BF9;&#x5E94;&#x7684;&#x670D;&#x52A1;&#x5668;&#x53BB;&#x5904;&#x7406;&#xFF1B;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x8C03;&#x5EA6;&#x8005;&#x5982;&#x4F55;&#x5408;&#x7406;&#x5206;&#x914D;&#x4EFB;&#x52A1;&#xFF0C;&#x4FDD;&#x8BC1;&#x6240;&#x6709;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x6027;&#x80FD;&#x5145;&#x5206;&#x53D1;&#x6325;&#xFF0C;&#x4ECE;&#x800C;&#x4FDD;&#x6301;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;&#x6574;&#x4F53;&#x6027;&#x80FD;&#x6700;&#x4F18;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x95EE;&#x9898;&#x4E86;&#x3002;</p>
<h2 id="nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x65B9;&#x5F0F;"><a href="#nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x65B9;&#x5F0F;" class="headerlink" title="nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x65B9;&#x5F0F;"></a>nginx&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x65B9;&#x5F0F;</h2><h3 id="1&#x3001;&#x8F6E;&#x8BE2;"><a href="#1&#x3001;&#x8F6E;&#x8BE2;" class="headerlink" title="1&#x3001;&#x8F6E;&#x8BE2;"></a>1&#x3001;&#x8F6E;&#x8BE2;</h3><p>&#x8F6E;&#x8BE2;&#x65B9;&#x5F0F;&#x662F;Nginx&#x8D1F;&#x8F7D;&#x9ED8;&#x8BA4;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x90FD;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#x5206;&#x914D;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x4E0A;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;Down&#x6389;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x52A8;&#x5254;&#x9664;&#xFF0C;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x540E;&#x8F6E;&#x8BAD;10001&#x670D;&#x52A1;&#x548C;10002&#x670D;&#x52A1;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vbscript&#x590D;&#x5236;&#x4EE3;&#x7801;upstream dalaoyang-server{</span><br><span class="line">    server localhost:10001;</span><br><span class="line">    server localhost:10002;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2&#x3001;&#x6743;&#x91CD;"><a href="#2&#x3001;&#x6743;&#x91CD;" class="headerlink" title="2&#x3001;&#x6743;&#x91CD;"></a>2&#x3001;&#x6743;&#x91CD;</h3><p>&#x6307;&#x5B9A;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x6743;&#x91CD;&#x6BD4;&#x4F8B;&#xFF0C;weight&#x548C;&#x8BBF;&#x95EE;&#x6BD4;&#x7387;&#x6210;&#x6B63;&#x6BD4;&#xFF0C;&#x901A;&#x5E38;&#x7528;&#x4E8E;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x673A;&#x5668;&#x6027;&#x80FD;&#x4E0D;&#x7EDF;&#x4E00;&#xFF0C;&#x5C06;&#x6027;&#x80FD;&#x597D;&#x7684;&#x5206;&#x914D;&#x6743;&#x91CD;&#x9AD8;&#x6765;&#x53D1;&#x6325;&#x670D;&#x52A1;&#x5668;&#x6700;&#x5927;&#x6027;&#x80FD;&#xFF0C;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x540E;10002&#x670D;&#x52A1;&#x7684;&#x8BBF;&#x95EE;&#x6BD4;&#x7387;&#x4F1A;&#x662F;10001&#x670D;&#x52A1;&#x7684;&#x4E8C;&#x500D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;upstream dalaoyang-server{</span><br><span class="line">    server localhost:10001 weight=1;</span><br><span class="line">    server localhost:10002 weight=2;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3&#x3001;iphash"><a href="#3&#x3001;iphash" class="headerlink" title="3&#x3001;iphash"></a>3&#x3001;iphash</h3><p>&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x90FD;&#x6839;&#x636E;&#x8BBF;&#x95EE;ip&#x7684;hash&#x7ED3;&#x679C;&#x5206;&#x914D;&#xFF0C;&#x7ECF;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x6BCF;&#x4E2A;&#x8BBF;&#x5BA2;&#x56FA;&#x5B9A;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#xFF0C;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#xFF08;ip_hash&#x53EF;&#x4EE5;&#x548C;weight&#x914D;&#x5408;&#x4F7F;&#x7528;&#xFF09;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;upstream dalaoyang-server{</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:10001 weight=1;</span><br><span class="line">    server localhost:10002 weight=2;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4&#x3001;&#x6700;&#x5C11;&#x8FDE;&#x63A5;"><a href="#4&#x3001;&#x6700;&#x5C11;&#x8FDE;&#x63A5;" class="headerlink" title="4&#x3001;&#x6700;&#x5C11;&#x8FDE;&#x63A5;"></a>4&#x3001;&#x6700;&#x5C11;&#x8FDE;&#x63A5;</h3><p>&#x5C06;&#x8BF7;&#x6C42;&#x5206;&#x914D;&#x5230;&#x8FDE;&#x63A5;&#x6570;&#x6700;&#x5C11;&#x7684;&#x670D;&#x52A1;&#x4E0A;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;upstream dalaoyang-server{</span><br><span class="line">    least_conn;</span><br><span class="line">    server localhost:10001 weight=1;</span><br><span class="line">    server localhost:10002 weight=2;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="5&#x3001;fair"><a href="#5&#x3001;fair" class="headerlink" title="5&#x3001;fair"></a>5&#x3001;fair</h3><p>&#x6309;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x5668;&#x7684;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x6765;&#x5206;&#x914D;&#x8BF7;&#x6C42;&#xFF0C;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x77ED;&#x7684;&#x4F18;&#x5148;&#x5206;&#x914D;&#x3002;&#x9700;&#x8981;&#x63D2;&#x4EF6;&#x6765;&#x5E2E;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;upstream dalaoyang-server{</span><br><span class="line">    server localhost:10001 weight=1;</span><br><span class="line">    server localhost:10002 weight=2;</span><br><span class="line">    fair;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="Nginx&#x914D;&#x7F6E;"><a href="#Nginx&#x914D;&#x7F6E;" class="headerlink" title="Nginx&#x914D;&#x7F6E;"></a>Nginx&#x914D;&#x7F6E;</h2><p>&#x4EE5;&#x8F6E;&#x8BE2;&#x4E3A;&#x4F8B;&#xFF0C;&#x5982;&#x4E0B;&#x662F;nginx.conf&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;worker_processes 1;</span><br><span class="line">events{</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http{</span><br><span class="line">    upstream dalaoyang-server{</span><br><span class="line">        server localhost:10001;</span><br><span class="line">        server localhost:10002;</span><br><span class="line">    }</span><br><span class="line">    server{</span><br><span class="line">        listen       10000;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / {</span><br><span class="line">            proxy_pass http://dalaoyang-server;</span><br><span class="line">            proxy_redirect default;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="Nginx&#x955C;&#x50CF;&#x670D;&#x52A1;&#x5668;"><a href="#Nginx&#x955C;&#x50CF;&#x670D;&#x52A1;&#x5668;" class="headerlink" title="Nginx&#x955C;&#x50CF;&#x670D;&#x52A1;&#x5668;"></a>Nginx&#x955C;&#x50CF;&#x670D;&#x52A1;&#x5668;</h1><p>Nginx&#x7684;proxy_store&#x4F5C;&#x7528;&#x662F;&#x76F4;&#x63A5;&#x628A;&#x9759;&#x6001;&#x6587;&#x4EF6;&#x5728;&#x672C;&#x5730;&#x786C;&#x76D8;&#x521B;&#x5EFA;&#x5E76;&#x8BFB;&#x53D6;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E03;&#x725B;&#x6216;&#x8005;&#x53C8;&#x62CD;&#x8FD9;&#x6837;&#x7684;&#x955C;&#x50CF;CDN&#x529F;&#x80FD;&#xFF0C;&#x9996;&#x6B21;&#x8BBF;&#x95EE;&#x4F1A;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x6E90;&#x7AD9;&#x7684;&#x9759;&#x6001;&#x56FE;&#x7247;&#x7B49;&#x6587;&#x4EF6;&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x8BBF;&#x95EE;&#x5C31;&#x662F;&#x76F4;&#x63A5;&#x4ECE;CDN&#x670D;&#x52A1;&#x5668;&#x8BFB;&#x53D6;&#xFF0C;&#x52A0;&#x5FEB;&#x4E86;&#x901F;&#x5EA6;&#x3002;</p>
<p>&#x9700;&#x8981;&#x914D;&#x7F6E;&#x4E00;&#x4E0B;&#x53C2;&#x6570;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;#&#x542F;&#x7528;&#x7F13;&#x5B58;&#x5230;&#x672C;&#x5730;&#x7684;&#x529F;&#x80FD;</span><br><span class="line">proxy_storeon;</span><br><span class="line">#&#x8868;&#x793A;&#x7528;&#x6237;&#x8BFB;&#x5199;&#x6743;&#x9650;&#xFF0C;&#x5982;&#x679C;&#x5728;error&#x4E2D;&#x62A5;&#x8DEF;&#x5F84;&#x4E0D;&#x5141;&#x8BB8;&#x8BBF;&#x95EE;&#x7684;&#x8BDD;&#x5C31;&#x7528;&quot;chomod-Ra+rw&quot;&#x5C06;&#x4E0B;&#x9762;&#x914D;&#x7F6E;&#x7684;&#x8DEF;&#x5F84;&#x6539;&#x4E3A;&#x76F8;&#x5E94;&#x7684;&#x6743;&#x9650;</span><br><span class="line">proxy_store_access user:rw group:rw all:rw;</span><br><span class="line">#&#x6B64;&#x5904;&#x4E3A;&#x6587;&#x4EF6;&#x7684;&#x7F13;&#x5B58;&#x8DEF;&#x5F84;&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x662F;&#x548C;url&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x4E00;&#x81F4;&#x7684;</span><br><span class="line">proxy_temp_path &#x7F13;&#x5B58;&#x76EE;&#x5F55;;</span><br><span class="line">#&#x5728;&#x4E0A;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x4E4B;&#x540E;&#xFF0C;&#x867D;&#x7136;&#x6587;&#x4EF6;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x4E86;&#x672C;&#x5730;&#x78C1;&#x76D8;&#x4E0A;&#xFF0C;&#x4F46;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x4ECD;&#x4F1A;&#x5411;&#x8FDC;&#x7AEF;&#x62C9;&#x53D6;&#x6587;&#x4EF6;&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x53BB;&#x8FDC;&#x7AEF;&#x62C9;&#x53D6;&#x6587;&#x4EF6;&#xFF0C;&#x8FD8;&#x5FC5;&#x987B;&#x589E;&#x52A0;&#xFF1A;</span><br><span class="line">if(!-e $request_filename){</span><br><span class="line">    proxy_pass http://192.168.10.10;</span><br><span class="line">}</span><br><span class="line">&#x6CE8;&#xFF1A;&quot;!-e$request_filename&quot;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x5339;&#x914D;&#x7F13;&#x5B58;&#x76EE;&#x5F55;&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#x4E0E;&#x6E90;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x5B58;&#x5728;&#x3002;</span><br><span class="line">&quot;http://192.168.10.10&quot;&#x6E90;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x9ED8;&#x8BA4;&#x7AEF;&#x53E3;80&#xFF0C;&#x5982;&#x76D1;&#x542C;&#x5176;&#x4ED6;&#x7AEF;&#x53E3;&#xFF0C;&#x6B64;&#x5904;&#x8981;&#x6307;&#x51FA;&#xFF0C;&#x4F8B;&#x5982;4000&#x7AEF;&#x53E3;&#xFF0C;http://192.168.10.10:4000</span><br></pre></td></tr></table></figure>

<p>&#x6574;&#x4F53;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF08;&#x4FEE;&#x6539;nginx&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;nginx.conf&#xFF09;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;location / {</span><br><span class="line">//&#x8FD9;&#x91CC;&#x7684;location&#x662F;&#x8981;&#x6362;&#x6210;&#x81EA;&#x5DF1;&#x7ECF;&#x8FC7;&#x7CBE;&#x786E;&#x5339;&#x914D;&#x7684;location&#xFF0C;</span><br><span class="line">//&#x6BD4;&#x5982;&#x8981;&#x7F13;&#x5B58;&#x56FE;&#x7247;&#x8981;&#x5199;&#x6210;&quot;location~*\.(gif|jpg|jepg|png|bmp)${&quot;</span><br><span class="line">expires 3d;    //&#x6240;&#x6709;&#x94FE;&#x63A5;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x7F13;&#x5B58;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x4E3A;3&#x5929;</span><br><span class="line">proxy_set_header Accept-Encoding &apos;&apos;;</span><br><span class="line">root /home/mpeg/nginx;  //&#x6B64;&#x76EE;&#x5F55;&#x4E3A;&#x670D;&#x52A1;&#x5668;&#x7684;&#x6839;&#x76EE;&#x5F55;&#xFF0C;&#x4E0B;&#x9762;&#x7684;if&#x8BED;&#x53E5;&#x5C31;&#x662F;&#x5224;&#x65AD;&#x6B64;&#x76EE;&#x5F55;&#x4E0B;&#x662F;&#x5426;&#x6709;&#x54CD;&#x5E94;&#x7684;&#x6587;&#x4EF6;</span><br><span class="line">proxy_store on;   //&#x8868;&#x793A;&#x5F00;&#x542F;&#x7F13;&#x5B58;</span><br><span class="line">proxy_store_access user:rw group:rw all:rw;   //&#x8868;&#x793A;&#x7528;&#x6237;&#x8BFB;&#x5199;&#x6743;&#x9650;</span><br><span class="line">proxy_temp_path /home/mpeg/nginx;  //&#x6B64;&#x5904;&#x4E3A;&#x6587;&#x4EF6;&#x7684;&#x7F13;&#x5B58;&#x8DEF;&#x5F84;&#xFF0C;&#x8FD9;&#x4E2A;&#x8DEF;&#x5F84;&#x662F;&#x548C;url&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x4E00;&#x81F4;&#x7684;</span><br><span class="line">    if(!-e $request_filename){</span><br><span class="line">        proxy_pass http://192.168.0.1;  //&#x6B64;&#x5904;&#x4E3A;&#x8981;&#x88AB;&#x4EE3;&#x7406;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5730;&#x5740;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="&#x5F26;&#x5916;&#x4E4B;&#x97F3;"><a href="#&#x5F26;&#x5916;&#x4E4B;&#x97F3;" class="headerlink" title="&#x5F26;&#x5916;&#x4E4B;&#x97F3;"></a>&#x5F26;&#x5916;&#x4E4B;&#x97F3;</h1><p>&#x611F;&#x8C22;&#x4F60;&#x7684;&#x9605;&#x8BFB;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x611F;&#x89C9;&#x5B66;&#x5230;&#x4E86;&#x4E1C;&#x897F;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x70B9;&#x8D5E;&#xFF0C;&#x5173;&#x6CE8;&#x3002;&#x4E5F;&#x6B22;&#x8FCE;&#x6709;&#x95EE;&#x9898;&#x6211;&#x4EEC;&#x4E0B;&#x9762;&#x8BC4;&#x8BBA;&#x4EA4;&#x6D41;</p>
<p>&#x52A0;&#x6CB9;&#xFF01; &#x6211;&#x4EEC;&#x4E0B;&#x671F;&#x518D;&#x89C1;&#xFF01;</p>
<p>&#x7ED9;&#x5927;&#x5BB6;&#x5206;&#x4EAB;&#x51E0;&#x4E2A;&#x6211;&#x524D;&#x9762;&#x5199;&#x7684;&#x51E0;&#x7BC7;&#x9A9A;&#x64CD;&#x4F5C;</p>
<p><a href="https://dev.newban.cn/6998145943119855624">copy&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x6709;&#x70B9;&#x9A9A;&#xFF01;</a></p>
<p><a href="https://dev.newban.cn/6985049438540529694">&#x5E72;&#x8D27;&#xFF01;SpringBoot&#x5229;&#x7528;&#x76D1;&#x542C;&#x4E8B;&#x4EF6;&#xFF0C;&#x5B9E;&#x73B0;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/05d8b0d7e5a2df4b29af15b263adc015.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035984305893408805.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035984305893408805.html" itemprop="url">网络协议-TCP的四次挥手 结束语</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:34:56+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://dev.newban.cn/7033976124547792927">&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E; &#x201C;&#x7F51;&#x7EDC;&#x534F;&#x8BAE;&#x5FC5;&#x77E5;&#x5FC5;&#x4F1A;</a></p>
<p><strong>&#x5C71;&#x6709;&#x5CF0;&#x9876;&#xFF0C;&#x6D77;&#x6709;&#x5F7C;&#x5CB8;&#xFF0C;&#x6F2B;&#x6F2B;&#x957F;&#x8DEF;&#xFF0C;&#x7EC8;&#x6709;&#x56DE;&#x8F6C;&#xFF0C;&#x4F59;&#x5473;&#x82E6;&#x6DA9;&#xFF0C;&#x7EC8;&#x4F1A;&#x6709;&#x56DE;&#x7518;&#x3002;&#x522B;&#x88AB;&#x773C;&#x524D;&#x7684;&#x78E8;&#x96BE;&#x6253;&#x8D25;&#x4E86;&#xFF0C;&#x6216;&#x8BB8;&#x5149;&#x660E;&#x5C31;&#x5728;&#x4F60;&#x653E;&#x5F03;&#x524D;&#x7684;&#x90A3;&#x4E00;&#x523B;&#x3002;&#x5E26;&#x7740;&#x6109;&#x5FEB;&#x7684;&#x5FC3;&#x60C5;&#x505A;&#x4E00;&#x4E2A;&#x6109;&#x5FEB;&#x7684;&#x68A6;&#xFF0C;&#x9192;&#x6765;&#x540E;&#xFF0C;&#x53C8;&#x662F;&#x65B0;&#x7684;&#x4E00;&#x5929;&#x3002;</strong></p>
<p><strong>&#x4E16;&#x754C;&#x4E0A;&#x4EFB;&#x4F55;&#x7684;&#x4E66;&#x7C4D;&#x90FD;&#x4E0D;&#x80FD;&#x5E26;&#x7ED9;&#x4F60;&#x597D;&#x8FD0;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x4EEC;&#x80FD;&#x8BA9;&#x4F60;&#x6084;&#x6084;&#x7684;&#x6210;&#x4E3A;&#x4F60;&#x81EA;&#x5DF1;&#x7684;</strong></p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>TCP&#x4F4D;&#x4E8E;&#x4F20;&#x8F93;&#x5C42;,&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x9760;&#x7684;&#x8FDE;&#x63A5;&#x670D;&#x52A1;,&#x4E3A;&#x4E86;&#x51C6;&#x786E;&#x7684;&#x4F20;&#x8F93;&#x6570;&#x636E;,TCP&#x91C7;&#x7528;&#x4E86;&#x4E09;&#x6B21;&#x63E1;&#x624B;,&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7B56;&#x7565;. &#x8FD9;&#x91CC;&#x8BB2;&#x7684;&#x662F;&#x56DB;&#x6B21;&#x6325;&#x624B;(&#x4E5F;&#x53EB;&#x56DB;&#x6B21;&#x63E1;&#x624B;)</p>
<h2 id="TCP&#x9996;&#x90E8;&#x683C;&#x5F0F;"><a href="#TCP&#x9996;&#x90E8;&#x683C;&#x5F0F;" class="headerlink" title="TCP&#x9996;&#x90E8;&#x683C;&#x5F0F;"></a>TCP&#x9996;&#x90E8;&#x683C;&#x5F0F;</h2><p>TCP&#x9996;&#x90E8;&#x6570;&#x636E;&#x683C;&#x5F0F;,&#x901A;&#x5E38;&#x662F;20&#x4E2A;&#x5B57;&#x8282;&#x518D;&#x52A0;&#x53EF;&#x53D8;&#x5B57;&#x6BB5;,&#x5176;&#x4E2D;&#x6709;6&#x4E2A;&#x7279;&#x6B8A;&#x7684;&#x6807;&#x8BC6;bit,&#x5206;&#x522B;&#x662F;<code>URG</code>,<code>ACK</code>,<code>PSH</code>,<code>RST</code>,<code>SYN</code>,<code>FIN</code>&#x7B49;,&#x4F4D;&#x7F6E;&#x89C1;&#x4E0B;&#x56FE;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/7912fbefa965e82808afd7e3e9913cb92bd11ef57076fa4e60d4db4c9048e36f" alt="image.png"></p>
<table>
<thead>
<tr>
<th>&#x6807;&#x8BC6;&#x4F4D;</th>
<th>&#x542B;&#x4E49;</th>
</tr>
</thead>
<tbody><tr>
<td>URG</td>
<td>&#x7D27;&#x6025;&#x6307;&#x9488;&#x6709;&#x6548;</td>
</tr>
<tr>
<td>ACK</td>
<td>&#x786E;&#x8BA4;&#x5E8F;&#x53F7;&#x6709;&#x6548;</td>
</tr>
<tr>
<td>PSH</td>
<td>&#x63A5;&#x6536;&#x65B9;&#x5E94;&#x8BE5;&#x5C3D;&#x5FEB;&#x5C06;&#x8FD9;&#x4E2A;&#x62A5;&#x6587;&#x6BB5;&#x4EA4;&#x7ED9;&#x5E94;&#x7528;&#x5C42;</td>
</tr>
<tr>
<td>RST</td>
<td>&#x590D;&#x4F4D;,&#x5173;&#x95ED;&#x5F02;&#x5E38;&#x8FDE;&#x63A5;</td>
</tr>
<tr>
<td>SYN</td>
<td>&#x540C;&#x6B65;&#x5E8F;&#x53F7;&#x7528;&#x6765;&#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;</td>
</tr>
<tr>
<td>FIN</td>
<td>&#x53D1;&#x7AEF;&#x5B8C;&#x6210;&#x53D1;&#x9001;&#x4EFB;&#x52A1;</td>
</tr>
<tr>
<td>&#x2026;</td>
<td></td>
</tr>
</tbody></table>
<p>&#x672C;&#x6587;&#x4E2D;&#x7528;&#x5230;&#x7684;&#x6807;&#x8BC6;&#x4F4D;&#x662F; <code>ACK</code> <code>FIN</code>, &#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;bit&#x4F4D;&#x8BBE;&#x7F6E;&#x4E3A;1,&#x5426;&#x5219;&#x9ED8;&#x8BA4;&#x4E3A;0. &#x4E5F;&#x7528;&#x5230;&#x4E86;<code>32&#x4F4D;&#x5E8F;&#x53F7;</code>(<code>Sequence number</code>)&#x548C;<code>32&#x4F4D;&#x786E;&#x8BA4;&#x5E8F;&#x53F7;</code>(<code>Acknowledgment number</code>),&#x8FD9;&#x91CC;&#x662F;&#x7528;&#x6765;&#x5B58;&#x653E;&#x53CC;&#x53D1;&#x7684;&#x521D;&#x59CB;&#x5E8F;&#x5217;&#x53F7;(<code>ISN</code>)&#x7684;.</p>
<p>&#x5927;&#x5199;&#x7684;<code>ACK</code> <code>FIN</code>&#x4EE3;&#x8868;&#x6807;&#x5FD7;&#x4F4D;,<br>&#x5C0F;&#x5199;&#x7684;<code>seq</code>&#x4EE3;&#x8868;<code>Sequence number</code>,<br>&#x5C0F;&#x5199;&#x7684;<code>ack</code>&#x4EE3;&#x8868;<code>Acknowledgment number</code>,</p>
<h2 id="&#x56DB;&#x6B21;&#x6325;&#x624B;"><a href="#&#x56DB;&#x6B21;&#x6325;&#x624B;" class="headerlink" title="&#x56DB;&#x6B21;&#x6325;&#x624B;"></a>&#x56DB;&#x6B21;&#x6325;&#x624B;</h2><h3 id="&#x901A;&#x4FD7;&#x7684;&#x8BF4;"><a href="#&#x901A;&#x4FD7;&#x7684;&#x8BF4;" class="headerlink" title="&#x901A;&#x4FD7;&#x7684;&#x8BF4;"></a>&#x901A;&#x4FD7;&#x7684;&#x8BF4;</h3><p>&#x4EE5;&#x5BA2;&#x6237;&#x7AEF;&#x5148;&#x65AD;&#x5F00;&#x7684;&#x8BDD;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;: &#x6211;&#x6570;&#x636E;&#x53D1;&#x9001;&#x5B8C;&#x4E86;,&#x53EF;&#x4EE5;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x4E86;.</p>
<p>&#x670D;&#x52A1;&#x7AEF;: &#x6536;&#x5230;&#x4E86;,&#x7B49;&#x6211;&#x53D1;&#x9001;&#x5B8C;&#x6570;&#x636E;.</p>
<p>&#x670D;&#x52A1;&#x7AEF;: &#x6211;&#x6570;&#x636E;&#x53D1;&#x9001;&#x5B8C;&#x4E86;,&#x6211;&#x4E5F;&#x53EF;&#x4EE5;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x4E86;.</p>
<p>&#x5BA2;&#x6237;&#x7AEF;: &#x6536;&#x5230;&#x4E86;.</p>
<p>&#x968F;&#x540E;&#x670D;&#x52A1;&#x7AEF;&#x5173;&#x95ED;&#x8FDE;&#x63A5;, &#x5BA2;&#x6237;&#x7AEF;&#x7B49;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x540E;&#x4E5F;&#x5173;&#x95ED;&#x4E86;&#x8FDE;&#x63A5;.</p>
<h3 id="&#x6B63;&#x5E38;&#x7684;&#x8BF4;"><a href="#&#x6B63;&#x5E38;&#x7684;&#x8BF4;" class="headerlink" title="&#x6B63;&#x5E38;&#x7684;&#x8BF4;"></a>&#x6B63;&#x5E38;&#x7684;&#x8BF4;</h3><p>&#x4EE5;&#x5BA2;&#x6237;&#x7AEF;&#x5148;&#x65AD;&#x5F00;&#x4E3A;&#x4F8B;:</p>
<p>&#x5728;&#x56DB;&#x6B21;&#x6325;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;,&#x4F1A;&#x4F7F;&#x7528;<code>ACK</code> <code>FIN</code>,<code>seq</code>&#x548C;<code>ack</code>.</p>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x63E1;&#x624B;(&#x5BA2;&#x6237;&#x7AEF;): &#x53D1;&#x9001;&#x8BF7;&#x6C42;,TCP&#x4E2D;&#x8BBE;&#x7F6E;<code>FIN</code>=1 ,<code>seq</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x672C;&#x673A;&#x7684;<code>ISN</code>.</p>
<p>&#x7B2C;&#x4E8C;&#x6B21;&#x63E1;&#x624B;(&#x670D;&#x52A1;&#x7AEF;): &#x6536;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x4E4B;&#x540E;,&#x53D1;&#x9001;&#x8BF7;&#x6C42;,TCP&#x4E2D;&#x8BBE;&#x7F6E;<code>ACK</code>=1 ,<code>seq</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x672C;&#x673A;&#x7684;<code>ISN</code>,&#x5E76;&#x5C06;<code>ack</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;<code>ISN</code>+1</p>
<p>&#x7B2C;&#x4E09;&#x6B21;&#x63E1;&#x624B;(&#x670D;&#x52A1;&#x7AEF;): &#x7B49;&#x670D;&#x52A1;&#x7AEF;&#x6570;&#x636E;&#x4F20;&#x9001;&#x5B8C;&#x6210;&#x4E4B;&#x540E;, &#x53D1;&#x9001;&#x8BF7;&#x6C42;, TCP&#x4E2D;&#x8BBE;&#x7F6E;<code>ACK</code>=1 <code>FIN</code>=1, <code>seq</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x672C;&#x673A;&#x7684;&#x53E6;&#x4E00;&#x4E2A;<code>ISN</code>(&#x53EB;<code>ISN2</code>) ,<code>ack</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;<code>ISN</code>+1</p>
<p>&#x7B2C;&#x56DB;&#x6B21;&#x63E1;&#x624B;(&#x5BA2;&#x6237;&#x7AEF;): &#x5BA2;&#x6237;&#x7AEF;&#x6536;&#x5230;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#x540E;, &#x53D1;&#x9001;&#x8BF7;&#x6C42;, TCP&#x4E2D;&#x8BBE;&#x7F6E;<code>ACK</code>=1 , <code>seq</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x672C;&#x673A;&#x7684;<code>ISN</code>+1 ,<code>ack</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x670D;&#x52A1;&#x5668;&#x7684;<code>ISN2</code>+1</p>
<p>&#x670D;&#x52A1;&#x7AEF;&#x5173;&#x95ED;&#x8FDE;&#x63A5;,&#x5BA2;&#x6237;&#x7AEF;&#x7B49;&#x5F85;2MSL&#x65F6;&#x95F4;&#x4E4B;&#x540E;&#x518D;&#x6B21;&#x5173;&#x95ED;.</p>
<p>&#x56FE;&#x5982;&#x4E0B;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/a8e51f2872dd41fdadca754ab445a1d827ded8e668c58f117b18c9b5a67bb13b" alt="image.png"></p>
<p>&#x793A;&#x4F8B;&#x5982;&#x4E0B;<br>20.1.0.1&#x662F;&#x6211;&#x7684;&#x7535;&#x8111;,20.1.0.128&#x7535;&#x8111;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x673A;</p>
<p>&#x5728;128&#x4E0A;&#x4F7F;&#x7528;tcpdump&#x76D1;&#x542C;ens33(&#x865A;&#x62DF;&#x673A;&#x7F51;&#x5361;)&#x7684;80(nginx)&#x7AEF;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">css&#x590D;&#x5236;&#x4EE3;&#x7801;tcpdump -i ens33 port 80 and host 20.1.0.1 -S -n</span><br></pre></td></tr></table></figure>

<p>&#x5728;1&#x7535;&#x8111;&#x4E0A;&#x4F7F;&#x7528;telnet&#x8BF7;&#x6C42;20.1.0.128&#x7684;80&#x7AEF;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;telnet 20.1.0.128 80</span><br></pre></td></tr></table></figure>

<p>&#x4E4B;&#x540E;<code>Ctrl+C</code>&#x4E4B;&#x540E;</p>
<p>tcpdump&#x76D1;&#x542C;&#x65E5;&#x5FD7;&#x5982;&#x4E0B;</p>
<p><code>Ctrl+C</code>&#x7684;&#x6570;&#x636E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;10:33:19.377458 IP 20.1.0.1.58633 &gt; 20.1.0.128.http: Flags [P.], seq 2066280967:2066280968, ack 3607501457, win 2053, length 1: HTTP</span><br><span class="line">10:33:19.377573 IP 20.1.0.128.http &gt; 20.1.0.1.58633: Flags [.], ack 2066280968, win 229, length 0</span><br><span class="line">10:33:19.377855 IP 20.1.0.128.http &gt; 20.1.0.1.58633: Flags [P.], seq 3607501457:3607501766, ack 2066280968, win 229, length 309: HTTP: HTTP/1.1 400 Bad Request</span><br></pre></td></tr></table></figure>

<p>&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7684;&#x6570;&#x636E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;10:33:19.378017 IP 20.1.0.128.http &gt; 20.1.0.1.58633: Flags [F.], seq 3607501766, ack 2066280968, win 229, length 0</span><br><span class="line">10:33:19.378079 IP 20.1.0.1.58633 &gt; 20.1.0.128.http: Flags [.], ack 3607501767, win 2051, length 0</span><br><span class="line">10:33:19.382138 IP 20.1.0.1.58633 &gt; 20.1.0.128.http: Flags [F.], seq 2066280968, ack 3607501767, win 2051, length 0</span><br><span class="line">10:33:19.382234 IP 20.1.0.128.http &gt; 20.1.0.1.58633: Flags [.], ack 2066280969, win 229, length 0</span><br></pre></td></tr></table></figure>

<h2 id="&#x9488;&#x5BF9;&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7684;&#x653B;&#x51FB;"><a href="#&#x9488;&#x5BF9;&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7684;&#x653B;&#x51FB;" class="headerlink" title="&#x9488;&#x5BF9;&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7684;&#x653B;&#x51FB;"></a>&#x9488;&#x5BF9;&#x56DB;&#x6B21;&#x6325;&#x624B;&#x7684;&#x653B;&#x51FB;</h2><h2 id="FIN-Flood"><a href="#FIN-Flood" class="headerlink" title="FIN Flood"></a>FIN Flood</h2><h2 id="RST-Flood"><a href="#RST-Flood" class="headerlink" title="RST Flood"></a>RST Flood</h2><p>&#x2026;</p>
<h1 id="&#x7ED3;&#x675F;&#x8BED;"><a href="#&#x7ED3;&#x675F;&#x8BED;" class="headerlink" title="&#x7ED3;&#x675F;&#x8BED;"></a>&#x7ED3;&#x675F;&#x8BED;</h1><p><strong>&#x5C3D;&#x4FE1;&#x4E66;&#x5219;&#x4E0D;&#x5982;&#xFF0C;&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#xFF0C;&#x7EAF;&#x5C5E;&#x4E00;&#x5BB6;&#x4E4B;&#x8A00;&#xFF0C;&#x56E0;&#x4E2A;&#x4EBA;&#x80FD;&#x529B;&#x6709;&#x9650;&#xFF0C;&#x96BE;&#x514D;&#x6709;&#x758F;&#x6F0F;&#x548C;&#x9519;&#x8BEF;&#x4E4B;&#x5904;&#xFF0C;&#x5982;&#x53D1;&#x73B0;bug&#x6216;&#x8005;&#x6709;&#x66F4;&#x597D;&#x7684;&#x5EFA;&#x8BAE;&#xFF0C;&#x6B22;&#x8FCE;&#x6279;&#x8BC4;&#x6307;&#x6B63;&#xFF0C;&#x4E0D;&#x541D;&#x611F;&#x6FC0;</strong></p>
<p><strong>&#x5982;&#x679C;&#x60A8;&#x559C;&#x6B22;&#x6211;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x53EF;&#x4EE5;[&#x5173;&#x6CE8;]+[&#x70B9;&#x8D5E;]+[&#x8BC4;&#x8BBA;]&#xFF0C;&#x60A8;&#x7684;&#x4E09;&#x8FDE;&#x662F;&#x6211;&#x524D;&#x8FDB;&#x7684;&#x52A8;&#x529B;&#xFF0C;&#x671F;&#x5F85;&#x4E0E;&#x60A8;&#x5171;&#x540C;&#x6210;&#x957F;~</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;    &#x4F5C;&#x8005;&#xFF1A;ZOUZDC</span><br><span class="line">    &#x94FE;&#x63A5;&#xFF1A;https://juejin.cn/post/7028963866063306760</span><br><span class="line">    &#x6765;&#x6E90;&#xFF1A;&#x7A00;&#x571F;&#x6398;&#x91D1;</span><br><span class="line">    &#x8457;&#x4F5C;&#x6743;&#x5F52;&#x4F5C;&#x8005;&#x6240;&#x6709;&#x3002;&#x5546;&#x4E1A;&#x8F6C;&#x8F7D;&#x8BF7;&#x8054;&#x7CFB;&#x4F5C;&#x8005;&#x83B7;&#x5F97;&#x6388;&#x6743;&#xFF0C;&#x975E;&#x5546;&#x4E1A;&#x8F6C;&#x8F7D;&#x8BF7;&#x6CE8;&#x660E;&#x51FA;&#x5904;&#x3002;</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/24eef808237b0a34033bb3a22f6d907a.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035983899788312589.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035983899788312589.html" itemprop="url">【kafka】 丢消息处理总结 丢消息</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:32:35+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x8FD9;&#x662F;&#x6211;&#x53C2;&#x4E0E;11&#x6708;&#x66F4;&#x6587;&#x6311;&#x6218;&#x7684;&#x7B2C;28&#x5929;&#xFF0C;&#x6D3B;&#x52A8;&#x8BE6;&#x60C5;&#x67E5;&#x770B;&#xFF1A;<a href="https://dev.newban.cn/7023643374569816095/">2021&#x6700;&#x540E;&#x4E00;&#x6B21;&#x66F4;&#x6587;&#x6311;&#x6218;</a>&#x300D;</p>
<h1 id="&#x4E22;&#x6D88;&#x606F;"><a href="#&#x4E22;&#x6D88;&#x606F;" class="headerlink" title="&#x4E22;&#x6D88;&#x606F;"></a>&#x4E22;&#x6D88;&#x606F;</h1><p>&#x53C2;&#x8003;&#xFF1A;</p>
<ul>
<li><a href="https://dev.newban.cn/6844904094021189639">juejin.cn/post/684490&#x2026;</a></li>
<li><a href="/external_links/3b667106b5ae35003885f53067d29da8.html" target="blank" rel="noopener">blog.csdn.net/qq_34495753&#x2026;</a></li>
</ul>
<p>&#x751F;&#x4EA7;&#x8005;&#x7AEF;&#x3001;&#x6D88;&#x8D39;&#x8005;&#x7AEF;&#x3001;kafka&#x7AEF;&#xFF0C;&#x90FD;&#x6709;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x4E22;&#x6D88;&#x606F;&#x7684;&#x60C5;&#x51B5;&#x3002;</p>
<h2 id="&#x751F;&#x4EA7;&#x8005;&#x7AEF;"><a href="#&#x751F;&#x4EA7;&#x8005;&#x7AEF;" class="headerlink" title="&#x751F;&#x4EA7;&#x8005;&#x7AEF;"></a>&#x751F;&#x4EA7;&#x8005;&#x7AEF;</h2><p>&#x539F;&#x56E0;&#xFF1A;</p>
<ul>
<li>&#x7F51;&#x7EDC;&#x4E0D;&#x7A33;&#x5B9A;</li>
<li>&#x6216;&#x3002;&#x3002;&#x3002;</li>
</ul>
<p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;</p>
<ul>
<li>&#x76D1;&#x542C;&#x56DE;&#x8C03;&#x4E8B;&#x4EF6;&#xFF0C;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x5219;&#x91CD;&#x53D1;&#xFF0C;&#x6301;&#x7EED;&#x5931;&#x8D25;&#x5219;&#x9700;&#x8981;&#x68C0;&#x67E5;&#x53D1;&#x751F;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x7684;&#x60C5;&#x51B5;&#x3002;</li>
</ul>
<h2 id="&#x6D88;&#x8D39;&#x8005;&#x7AEF;"><a href="#&#x6D88;&#x8D39;&#x8005;&#x7AEF;" class="headerlink" title="&#x6D88;&#x8D39;&#x8005;&#x7AEF;"></a>&#x6D88;&#x8D39;&#x8005;&#x7AEF;</h2><p>&#x6D88;&#x8D39;&#x8005;&#x7AEF;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x7684;&#x60C5;&#x51B5;&#x53EF;&#x80FD;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>pull&#x5230;&#x4E86;&#x67D0;&#x6D88;&#x606F;&#x540E;&#xFF0C;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x7684;limit&#x8FC7;&#x4E86;&#x4F46;&#x8FD8;&#x6CA1;&#x5904;&#x7406;&#x5B8C;&#xFF0C;&#x968F;&#x540E;&#x63D0;&#x4EA4;&#x4E86;offset&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x518D;&#x505A;&#x5904;&#x7406;&#xFF1B;<ul>
<li>&#x7136;&#x800C;&#xFF0C;&#x5728;&#x63D0;&#x4EA4;&#x4E4B;&#x540E;&#x6D88;&#x8D39;&#x8005;&#x5D29;&#x6E83;&#x4E86;&#xFF0C;&#x6B64;&#x65F6;&#x672C;&#x5E94;&#x8BE5;&#x88AB;&#x6D88;&#x8D39;&#x7684;&#x90A3;&#x4E2A;offset&#x4F4D;&#x7F6E;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x65E0;&#x6CD5;&#x88AB;&#x5904;&#x7406;&#x3002;</li>
</ul>
</li>
</ul>
<p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;</p>
<ul>
<li>&#x7981;&#x6B62;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;offset&#xFF0C;&#x8F6C;&#x7531;&#x6D88;&#x8D39;&#x5B8C;&#x4E4B;&#x540E;&#x624B;&#x52A8;&#x63D0;&#x4EA4;offset&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x5C31;&#x662F;&#xFF1A;&#x5982;&#x679C;&#x6D88;&#x8D39;&#x5B8C;&#x4E86;&#xFF0C;&#x5728;&#x63D0;&#x4EA4;offset&#x7684;&#x65F6;&#x5019;&#x6D88;&#x8D39;&#x8005;&#x5D29;&#x6E83;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x6D88;&#x606F;&#x4F1A;&#x88AB;&#x6D88;&#x8D39;&#x4E24;&#x6B21;&#x3002;</li>
<li>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF1A;&#x7531;&#x4E8E;&#x6D88;&#x8D39;&#x8005;&#x7AEF;&#x66F4;&#x65B0;offset&#x548C;&#x6D88;&#x8D39;&#x5E76;&#x4E0D;&#x662F;&#x539F;&#x5B50;&#x6027;&#x7684;&#xFF0C;&#x5728;&#x5D29;&#x6E83;&#x7684;&#x72B6;&#x51B5;&#x4E0B;&#x65E0;&#x6CD5;&#x4FDD;&#x8BC1;&#x6D88;&#x606F;<strong>&#x6709;&#x4E14;&#x4EC5;&#x6709;</strong>&#x6D88;&#x8D39;&#x4E00;&#x6B21;&#xFF0C;&#x56E0;&#x6B64;&#x6D88;&#x8D39;&#x7AEF;<strong>&#x5FC5;&#x987B;</strong>&#x4FDD;&#x8BC1;&#x5E42;&#x7B49;&#x6027;&#xFF0C;&#x52A0;&#x4E0A;&#x624B;&#x52A8;&#x66F4;&#x65B0;offset&#xFF0C;&#x624D;&#x80FD;&#x4FDD;&#x8BC1;&#x6D88;&#x606F;&#x4E0D;&#x4E22;&#x5931;&#x3002;</li>
</ul>
<h2 id="kafka&#x7AEF;"><a href="#kafka&#x7AEF;" class="headerlink" title="kafka&#x7AEF;"></a>kafka&#x7AEF;</h2><p>kafka&#x4E22;&#x6D88;&#x606F;&#x7684;&#x6700;&#x5927;&#x53EF;&#x80FD;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x524D;&#x63D0;&#x77E5;&#x8BC6;&#xFF1A;kafka&#x7684;&#x5206;&#x533A;&#x3001;&#x591A;&#x526F;&#x672C;&#x673A;&#x5236;&#x3002;</li>
</ul>
<p>&#x5206;&#x533A;&#x4E2D;&#x7684;leader&#x526F;&#x672C;&#xFF0C;&#x5728;&#x5F80;follower&#x526F;&#x672C;&#x540C;&#x6B65;&#x65F6;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;<strong>&#x5B8C;&#x5168;&#x540C;&#x6B65;&#x6700;&#x65B0;&#x7684;&#x6D88;&#x606F;</strong>&#xFF0C;&#x5C31;&#x6302;&#x6389;&#x4E86;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x8FD9;&#x4E9B;&#x6CA1;&#x6709;&#x540C;&#x6B65;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x81EA;&#x7136;&#x5C31;&#x53D6;&#x4E0D;&#x5230;&#x4E86;&#x3002;</p>
<p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#xFF1A;</p>
<ul>
<li>&#x786E;&#x4FDD;<strong>&#x5728;&#x6240;&#x6709;&#x526F;&#x672C;&#x4E2D;</strong>&#x90FD;&#x4E0D;&#x4F1A;&#x6709;&#x672A;&#x540C;&#x6B65;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;&#x60C5;&#x51B5;&#x3002;</li>
</ul>
<p>&#x8FD9;&#x79CD;&#x89E3;&#x51B3;&#x65B9;&#x5F0F;&#x662F;&#x5728;&#x751F;&#x4EA7;&#x8005;&#x7AEF;&#x628A;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x7ED9;&#x6240;&#x6709;&#x526F;&#x672C;&#xFF0C;&#x786E;&#x4FDD;&#x526F;&#x672C;&#x90FD;&#x63A5;&#x6536;&#x5230;&#x624D;&#x7B97;&#x53D1;&#x9001;&#x6210;&#x529F;&#x3002;</p>
<p>&#x8FD9;&#x79CD;&#x89E3;&#x51B3;&#x65B9;&#x5F0F;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#xFF1A;<strong>acks = all</strong>(&#x9ED8;&#x8BA4;acks= 1,&#x4EE3;&#x8868;leader&#x526F;&#x672C;&#x63A5;&#x6536;&#x4E4B;&#x540E;&#x5C31;&#x7B97;&#x6210;&#x529F;)</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4F1A;&#x5BFC;&#x81F4;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x7684;&#x6548;&#x7387;&#x4E0B;&#x964D;&#x3002;</p>
<pre><code>+ &#x5728;ACK = all&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9700;&#x8981;&#x8BB0;&#x5F97;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x4E1C;&#x897F;&#x9700;&#x8981;&#x914D;&#x7F6E;&#xFF1A;**min.insync.replicas = m**
    - &#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x8868;&#x793A;&#xFF0C;&#x6D88;&#x606F;&#x81F3;&#x5C11;&#x8981;&#x88AB;&#x5199;&#x5165;&#x5230;m&#x4E2A;&#x526F;&#x672C;&#xFF0C;&#x624D;&#x53EF;&#x4EE5;&#x7ED9;&#x751F;&#x4EA7;&#x8005;&#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x6210;&#x529F;&#x3002;
+ &#x540C;&#x65F6;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x548C;&#x8FD9;&#x4E2A;&#x6709;&#x5173;&#xFF1A;**replication.factor= 3**
    - &#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x8868;&#x793A;&#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x7684;&#x526F;&#x672C;&#x6570;&#x3002;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;kafka&#x7684;&#x5065;&#x58EE;&#x6027;&#xFF0C;&#x5206;&#x533A;&#x526F;&#x672C;&#x6570;&#x5FC5;&#x987B;&#x5927;&#x4E8E;&#x4E0A;&#x9762;&#x914D;&#x7F6E;&#x7684;&#x6700;&#x5C0F;&#x5199;&#x5165;&#x5206;&#x533A;&#x6570;&#xFF0C;&#x5426;&#x5219;&#x53EA;&#x8981;&#x6709;&#x526F;&#x672C;&#x6302;&#x4E86;&#xFF0C;&#x5C31;&#x4F1A;&#x5BFC;&#x81F4;&#x4E2D;&#x95F4;&#x4EF6;&#x65E0;&#x6CD5;&#x5199;&#x5165;&#x6D88;&#x606F;&#x3002;</code></pre><ul>
<li>&#x786E;&#x4FDD;&#x6CA1;&#x6709;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;&#x526F;&#x672C;&#xFF0C;&#x5728;leader&#x5B95;&#x673A;&#x540E;&#x7684;&#x9009;&#x4E3E;&#x4E2D;&#x4E0D;&#x4F1A;&#x88AB;&#x9009;&#x4E3A;&#x65B0;leader&#x3002;</li>
</ul>
<p>&#x8FD9;&#x4E2A;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x9700;&#x8981;&#x914D;&#x7F6E;<strong>unclean.leader.election.enable = false</strong>&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/4fe61dc9a04ce40328f908a9a32691ed.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035983730967576590.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035983730967576590.html" itemprop="url">DNS网络协议初探 DNS协议初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:31:55+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DNS&#x534F;&#x8BAE;&#x521D;&#x63A2;"><a href="#DNS&#x534F;&#x8BAE;&#x521D;&#x63A2;" class="headerlink" title="DNS&#x534F;&#x8BAE;&#x521D;&#x63A2;"></a>DNS&#x534F;&#x8BAE;&#x521D;&#x63A2;</h1><p><strong>&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E; &#x201C;<a href="https://dev.newban.cn/7033976124547792927">&#x7F51;&#x7EDC;&#x534F;&#x8BAE;&#x5FC5;&#x77E5;&#x5FC5;&#x4F1A;</a>&#x201D;&#x5F81;&#x6587;&#x6D3B;&#x52A8;</strong></p>
<blockquote>
<p>DNS &#x4F7F;&#x7528;TCP&#x8FD8;&#x662F;UDP&#x534F;&#x8BAE;&#xFF1F;</p>
<p>DNS &#x8FED;&#x4EE3;&#x67E5;&#x8BE2; &#x548C; &#x9012;&#x5F52;&#x67E5;&#x8BE2; &#x662F;&#x4EC0;&#x4E48;&#xFF1F;</p>
<p>&#x5982;&#x4F55;&#x6784;&#x5EFA;DNS&#x62A5;&#x6587;&#xFF1F;</p>
</blockquote>
<ol>
<li>&#x4EC0;&#x4E48;&#x662F;DNS</li>
</ol>
<hr>
<p>&#x200B; DNS: (Domain Name System) &#x57DF;&#x540D;&#x7CFB;&#x7EDF;&#xFF0C; &#x7528;&#x6237;&#x5728;&#x4F7F;&#x7528;&#x5E38;&#x7528;&#x7F51;&#x7EDC;&#x8F6F;&#x4EF6;&#xFF0C;&#x4F8B;&#x5982;: &#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x90AE;&#x4EF6; &#x7B49;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E9B;&#x670D;&#x52A1;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x670D;&#x52A1;&#x5668;&#x7684;ip&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x8FD9;&#x4E2A;&#x96BE;&#x4EE5;&#x8BB0;&#x5FC6;&#xFF0C;&#x5927;&#x5BB6;&#x66F4;&#x559C;&#x6B22;&#x6613;&#x8BFB;&#x3001;&#x6709;&#x4E00;&#x5B9A;&#x542B;&#x4E49;&#x7684;&#x540D;&#x5B57;&#xFF0C;DNS&#x5C31;&#x80FD;&#x6EE1;&#x8DB3;&#x8FD9;&#x4E2A;&#x8981;&#x6C42;&#xFF0C;&#x5B9E;&#x73B0;&#x5C06;&#x57DF;&#x540D;&#x6620;&#x5C04;&#x4E3A;IP&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x79F0;&#x4E3A;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x3002;&#x76EE;&#x524D;&#x4E92;&#x8054;&#x7F51; DNS&#x4E3A;&#x5206;&#x5E03;&#x5F0F;&#x6570;&#x636E;&#x5E93;, &#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x5206;&#x5E03;&#x5728;&#x4E16;&#x754C;&#x5404;&#x5730;&#xFF0C;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4E5F;&#x53EA;&#x5B58;&#x50A8;&#x4E86;&#x90E8;&#x5206;&#x57DF;&#x540D;&#x4FE1;&#x606F;&#x3002;</p>
<h3 id="1-1-&#x57DF;&#x540D;&#x5C42;&#x6B21;&#x5316;"><a href="#1-1-&#x57DF;&#x540D;&#x5C42;&#x6B21;&#x5316;" class="headerlink" title="1.1 &#x57DF;&#x540D;&#x5C42;&#x6B21;&#x5316;"></a>1.1 &#x57DF;&#x540D;&#x5C42;&#x6B21;&#x5316;</h3><p>&#x200B; &#x57DF;&#x540D;&#x7ED3;&#x6784;&#x7531;&#x6807;&#x53F7;&#x5E8F;&#x5217;&#x7EC4;&#x6210;&#xFF0C;&#x6807;&#x70B9;&#x7B26;&#x53F7;&#x7528;&#x70B9;&#x9694;&#x5F00;, &#x4F8B;&#x5982;: <code>juejin.cn.</code> <code>www.jd.com.</code> &#x53EF;&#x603B;&#x7ED3;&#x4E3A;: <code>....&#x4E09;&#x7EA7;&#x57DF;&#x540D;.&#x4E8C;&#x7EA7;&#x57DF;&#x540D;.&#x9876;&#x7EA7;&#x57DF;&#x540D;.&#x6839;&#x57DF;&#x540D;(&#x53EF;&#x7701;&#x7565;)</code></p>
<p>&#x6839;</p>
<p>&#x622A;&#x6B62;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#xFF0C;&#x5168;&#x7403;&#x4E0A;&#x5171;&#x6709;13&#x4E2A;&#x6839;&#x670D;&#x52A1;&#x5668; &#xFF0C;&#x4ECE; a - m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# yum -y install bind-utils</span><br><span class="line"># dig | grep root | awk &apos;{print $NF}&apos; | sort</span><br><span class="line">a.root-servers.net.</span><br><span class="line">b.root-servers.net.</span><br><span class="line">c.root-servers.net.</span><br><span class="line">d.root-servers.net.</span><br><span class="line">e.root-servers.net.</span><br><span class="line">f.root-servers.net.</span><br><span class="line">g.root-servers.net.</span><br><span class="line">h.root-servers.net.</span><br><span class="line">i.root-servers.net.</span><br><span class="line">j.root-servers.net.</span><br><span class="line">k.root-servers.net.</span><br><span class="line">l.root-servers.net.</span><br><span class="line">m.root-servers.net.</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>&#x9876;&#x7EA7;&#x57DF;&#x540D;&#x5206;&#x7C7B;:</p>
<ul>
<li>&#x56FD;&#x5BB6;&#x9876;&#x7EA7;&#x57DF;&#x540D;nTLD<ul>
<li>cn: &#x8868;&#x793A;&#x4E2D;&#x56FD;</li>
<li>us: &#x8868;&#x793A;&#x7F8E;&#x56FD;</li>
<li>jp: &#x8868;&#x793A;&#x65E5;&#x672C;</li>
<li>&#x2026;</li>
</ul>
</li>
<li>&#x901A;&#x7528;&#x9876;&#x7EA7;&#x57DF;&#x540D;gTLD<ul>
<li>com: &#x8868;&#x793A;&#x5DE5;&#x5546;&#x4F01;&#x4E1A;</li>
<li>net: &#x8868;&#x793A;&#x7F51;&#x7EDC;&#x63D0;&#x4F9B;&#x5546;</li>
<li>gov: &#x653F;&#x5E9C;&#x4E13;&#x7528;</li>
<li>&#x2026;</li>
</ul>
</li>
<li>&#x57FA;&#x7840;&#x7ED3;&#x6784;&#x57DF;&#x540D;<ul>
<li>arpa</li>
</ul>
</li>
</ul>
<h3 id="1-2-&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;"><a href="#1-2-&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;" class="headerlink" title="1.2 &#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;"></a>1.2 &#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;</h3><p>&#x200B; &#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x4EE5;&#x533A;&#x4E3A;&#x5355;&#x4F4D;&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;: 1. &#x6839;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668; 2. &#x9876;&#x7EA7;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668; 3. &#x6743;&#x5A01;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668; 4. &#x4E2D;&#x95F4;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;</p>
<p><strong>&#x6839;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;</strong></p>
<p>&#x5168;&#x7403;&#x5171;&#x6709;13&#x4E2A;&#x6839;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x53EF;&#x901A;&#x8FC7; <code>dig</code> &#x83B7;&#x53D6;&#x3002;</p>
<p><strong>&#x9876;&#x7EA7;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;</strong></p>
<p>TLD&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x8BE5;&#x9876;&#x7EA7;&#x57DF;&#x540D;&#x4E0B;&#x7684;&#x4E8C;&#x7EA7;&#x57DF;&#x540D;&#x3002;</p>
<p><strong>&#x6743;&#x5A01;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;</strong></p>
<p>&#x8D1F;&#x8F7D;&#x4E00;&#x4E2A;&#x533A;&#x7684;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4FDD;&#x5B58;&#x8BE5;&#x533A;&#x7684;&#x57DF;&#x540D; &#x548C; IP&#x5730;&#x5740;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x3002;</p>
<p><strong>&#x4E2D;&#x95F4;&#x670D;&#x52A1;&#x5668;</strong></p>
<p>&#x4E0D;&#x5C5E;&#x4E8E;&#x5982;&#x4E0A;&#x4E09;&#x79CD;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5C31;&#x662F;&#x4E2D;&#x95F4;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<h3 id="1-3-&#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x6765;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;"><a href="#1-3-&#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x6765;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;" class="headerlink" title="1.3 &#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x6765;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;"></a>1.3 &#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x6765;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x5668;&#x5206;&#x7C7B;</h3><p>&#x672C;&#x6B21;&#x67E5;&#x8BE2;&#xFF0C;DNS&#x670D;&#x52A1;&#x5668;&#x4FE1;&#x606F;&#x5982;&#x4E0B;</p>
<ul>
<li>&#x672C;&#x5730;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;: 61.139.2.69</li>
<li>&#x6839;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;: a.root-servers.net (198.41.0.4#53)</li>
<li>&#x9876;&#x7EA7;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;: g.dns.cn (66.198.183.65#53)</li>
<li>&#x6743;&#x5A01;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;: vip4.alidns.com (47.113.183.36#53)</li>
</ul>
<p>&#x5229;&#x7528;dig&#x8FFD;&#x8E2A;&#x65E5;&#x5FD7;&#x5982;&#x4E0B;</p>
<blockquote>
<p>dig +trace &#x53EF;&#x4EE5;&#x8FFD;&#x8E2A;&#x8BF7;&#x6C42;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# dig +trace juejin.cn. @61.139.2.69 </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 &lt;&lt;&gt;&gt; +trace juejin.cn. @61.139.2.69</span><br><span class="line">;; global options: +cmd</span><br><span class="line">.                       28351   IN      NS      a.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      b.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      c.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      d.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      e.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      f.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      g.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      h.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      i.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      j.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      k.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      l.root-servers.net.</span><br><span class="line">.                       28351   IN      NS      m.root-servers.net.</span><br><span class="line">;; Received 228 bytes from 61.139.2.69#53(61.139.2.69) in 3 ms</span><br><span class="line"></span><br><span class="line">cn.                     172800  IN      NS      c.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      g.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      b.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      ns.cernet.net.</span><br><span class="line">cn.                     172800  IN      NS      e.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      f.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      a.dns.cn.</span><br><span class="line">cn.                     172800  IN      NS      d.dns.cn.</span><br><span class="line">cn.                     86400   IN      DS      57724 8 2 5D0423633EB24A499BE78AA22D1C0C9BA36218FF49FD95A4CDF1A4AD 97C67044</span><br><span class="line">cn.                     86400   IN      RRSIG   DS 8 1 86400 20211211170000 20211128160000 14748 . gM8pprqRpkmDpcu6kNU5kffmW1jo9dmT/CjK7g9dUH4F2purVO1Txiyr RszAgzMWe7HmxeLLEN1s0p2vxbQvQ0uQZn7DMA5eJWbNf/rINyT6vmMK BndvUuTJ74wnEkiXY8Cviim597TEFWl5w7Z9Bn0FwM2nzt5OHBDben24 Fca3vbIXK3Q2n1cDbpO01We/VbiUrgcxlNAxm68wC8gWwLypFNFDXw5V tHVwwX4NsKG1si6n5lyuKramPj+GM9YV/htDNSZKzjEyHTrp/lfwQoxX Eju+cOhmFvnnSFRLS+9EyVmil+i822M2QyVbLhmwjkW8pdER+RxXd+pv vrm6gA==</span><br><span class="line">;; Received 700 bytes from 198.41.0.4#53(a.root-servers.net) in 223 ms</span><br><span class="line"></span><br><span class="line">juejin.cn.              86400   IN      NS      vip3.alidns.com.</span><br><span class="line">juejin.cn.              86400   IN      NS      vip4.alidns.com.</span><br><span class="line">3QDAQA092EE5BELP64A74EBNB8J53D7E.cn. 21600 IN NSEC3 1 1 10 AEF123AB 3QM14FQ32F1CJFTP8D3J5BCTNP5BIELO NS SOA RRSIG DNSKEY NSEC3PARAM</span><br><span class="line">3QDAQA092EE5BELP64A74EBNB8J53D7E.cn. 21600 IN RRSIG NSEC3 8 2 21600 20211225190654 20211125181736 38388 cn. B735xzQYqVTspNxPes9yYW+EnnN1GuaKhRhI4UuowLiDdRqwrk1I/+3F aqzWerS2SUO+nhzcSzl+NeiIwBBuOjyh/NgF15e1WBHvc8PR2cG3HXSo rD3usJlX1rlaOZH6EP5k/VkMSktveAeJo3foOF104UXuljG0yRQqp+4v sh0=</span><br><span class="line">DEFPMSCATA3DEUN2HJMIGDHN15FBH1AM.cn. 21600 IN NSEC3 1 1 10 AEF123AB DGCV05BN5EJCBB4F86S87BCR5CJOA3IC NS DS RRSIG</span><br><span class="line">DEFPMSCATA3DEUN2HJMIGDHN15FBH1AM.cn. 21600 IN RRSIG NSEC3 8 2 21600 20211225184833 20211125181738 38388 cn. ghEDLlzom97T/4SL7znLbN5PKD0qyInh6VgcDw6dZPmoDy7eDd0Gk1Vw VoSSnn7dBp7AK8zEkAygKg28QiNFgPlWDlUtM37R3H3OGqfnJRiJ7R85 n/HSMchAunBtMgkSrtmXUVryzUm5inyi/FxH2iVc4fgGQZlLNmZr5BG+ lqQ=</span><br><span class="line">;; Received 577 bytes from 66.198.183.65#53(g.dns.cn) in 274 ms</span><br><span class="line"></span><br><span class="line">juejin.cn.              600     IN      CNAME   juejin.cn.w.cdngslb.com.</span><br><span class="line">;; Received 75 bytes from 47.113.183.36#53(vip4.alidns.com) in 46 ms</span><br><span class="line"></span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>&#x89E3;&#x6790;&#x8BF7;&#x6C42;&#x56FE;&#x5927;&#x81F4;&#x5982;&#x4E0B;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/7781948c18aa7b1d5c7f24b0f3294c6430f893d485f305047c597552a1a4a83a" alt="image.png"></p>
<h3 id="1-4-DNS&#x9012;&#x5F52;&#x89E3;&#x6790;&#x548C;&#x8FED;&#x4EE3;&#x89E3;&#x6790;"><a href="#1-4-DNS&#x9012;&#x5F52;&#x89E3;&#x6790;&#x548C;&#x8FED;&#x4EE3;&#x89E3;&#x6790;" class="headerlink" title="1.4 DNS&#x9012;&#x5F52;&#x89E3;&#x6790;&#x548C;&#x8FED;&#x4EE3;&#x89E3;&#x6790;"></a>1.4 DNS&#x9012;&#x5F52;&#x89E3;&#x6790;&#x548C;&#x8FED;&#x4EE3;&#x89E3;&#x6790;</h3><p>&#x9012;&#x5F52;&#x67E5;&#x8BE2;: &#x5728;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x82E5;&#x6CA1;&#x6709;&#x88AB;&#x67E5;&#x8BE2;&#x7684;&#x57DF;&#x540D;&#x4FE1;&#x606F;&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x4EE3;&#x7406;&#x67E5;&#x8BE2;&#xFF0C;&#x76F4;&#x81F3;&#x67E5;&#x8BE2;&#x5230;IP&#x5730;&#x5740;/&#x6216;&#x8005;&#x662F;&#x67E5;&#x8BE2;&#x5931;&#x8D25; &#xFF0C; &#x7136;&#x540E;&#x8FD4;&#x56DE;&#x7ED9;&#x672C;&#x5730;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<p>&#x8FED;&#x4EE3;&#x67E5;&#x8BE2;: &#x4E0D;&#x4F1A;&#x8FDB;&#x884C;&#x4EE3;&#x7406;&#x67E5;&#x8BE2;&#x8BF7;&#x6C42;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x7ED3;&#x679C;&#x6216;&#x8005;&#x662F;&#x4E0B;&#x4E00;&#x8DF3;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7ED9;&#x672C;&#x5730;&#x57DF;&#x540D;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<p>&#x56FE;&#x793A;</p>
<p>&#x8FED;&#x4EE3;&#x67E5;&#x8BE2;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/7c48e284f10ee35ab37837749cfb4fd454aec64de63e3b008b0f85263696633e" alt="image.png"></p>
<p>&#x9012;&#x5F52;&#x67E5;&#x8BE2;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/91f7a05d2b1e2e1e2441e0c6c57129ef21e2b03afcb7c4586e2d7be7a3dbef81" alt="image.png"></p>
<ol start="2">
<li>DNS&#x62A5;&#x6587;&#x89E3;&#x6790;</li>
</ol>
<hr>
<blockquote>
<p>&#x53C2;&#x8003; rfc1035 <a href="/external_links/b4efd23528fdb249e1a9fd94e508189b.html" target="blank" rel="noopener">datatracker.ietf.org/doc/html/rf&#x2026;</a></p>
</blockquote>
<p><strong>&#x8BF7;&#x6C42;&#x62A5;&#x6587;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/3cf7e1e243c0afe0d0ffc82b6d59e784757ecf122b97c91d4b454c22925cc41f" alt="image.png"></p>
<p><strong>&#x54CD;&#x5E94;&#x62A5;&#x6587;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/d5f9033ec584431365423135236dd669bf6d6cc1a015040d590f96ba569de0c8" alt="image.png"></p>
<h3 id="2-1-DNS-&#x6574;&#x4E2A;&#x62A5;&#x6587;&#x683C;&#x5F0F;"><a href="#2-1-DNS-&#x6574;&#x4E2A;&#x62A5;&#x6587;&#x683C;&#x5F0F;" class="headerlink" title="2.1 DNS &#x6574;&#x4E2A;&#x62A5;&#x6587;&#x683C;&#x5F0F;"></a>2.1 DNS &#x6574;&#x4E2A;&#x62A5;&#x6587;&#x683C;&#x5F0F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;    +---------------------+</span><br><span class="line">    |        Header       |</span><br><span class="line">    +---------------------+</span><br><span class="line">    |       Question      | the question for the name server</span><br><span class="line">    +---------------------+</span><br><span class="line">    |        Answer       | RRs answering the question</span><br><span class="line">    +---------------------+</span><br><span class="line">    |      Authority      | RRs pointing toward an authority</span><br><span class="line">    +---------------------+</span><br><span class="line">    |      Additional     | RRs holding additional information</span><br><span class="line">    +---------------------+</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Head-&#x8BF7;&#x6C42;&#x5934;"><a href="#2-2-Head-&#x8BF7;&#x6C42;&#x5934;" class="headerlink" title="2.2 Head: &#x8BF7;&#x6C42;&#x5934;"></a>2.2 Head: &#x8BF7;&#x6C42;&#x5934;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;                                    1  1  1  1  1  1</span><br><span class="line">      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                      ID                       |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                    QDCOUNT                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                    ANCOUNT                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                    NSCOUNT                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                    ARCOUNT                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br></pre></td></tr></table></figure>

<p><strong>ID: 16bit &#x67E5;&#x8BE2;/&#x54CD;&#x5E94;&#x7F16;&#x53F7;</strong></p>
<p>&#x4F5C;&#x4E3A; &#x67E5;&#x8BE2; &#x548C; &#x5E94;&#x7B54;&#x6807;&#x8BC6;ID</p>
<p><strong>QR: 1bit &#x62A5;&#x6587;&#x7C7B;&#x578B;</strong></p>
<p>0: &#x67E5;&#x8BE2;</p>
<p>1: &#x54CD;&#x5E94;</p>
<p><strong>Opcode: 4bit &#x67E5;&#x8BE2;&#x7684;&#x7C7B;&#x578B;</strong></p>
<p>0: &#x6807;&#x51C6;&#x67E5;&#x8BE2;</p>
<p>1: &#x53CD;&#x67E5;&#x8BE2;</p>
<p>2: &#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#x8BF7;&#x6C42;</p>
<p>3-15: &#x6682;&#x65F6;&#x95F2;&#x7F6E;</p>
<p><strong>AA: 1bit &#x6743;&#x5A01;&#x5E94;&#x7B54;</strong></p>
<p>1: &#x662F;</p>
<p>0: &#x5426;</p>
<p><strong>TC: 1bit &#x8D85;&#x51FA;&#x6700;&#x5927;&#x5141;&#x8BB8;&#x7684;&#x957F;&#x5EA6;(UDP&#x5305;&#x4E3A;512&#x5B57;&#x8282;)</strong></p>
<blockquote>
<p>UDP &#x5305;&#x4E3A; 512 &#x5B57;&#x8282;&#xFF0C;&#x82E5;&#x8FD4;&#x56DE;&#x62A5;&#x6587;&#x8D85;&#x8FC7;512&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5C06;&#x72B6;&#x6001;&#x6807;&#x5FD7;&#x4F4D; TC &#x7F6E;&#x4E3A;1 &#x7136;&#x540E;&#x5C06;&#x62A5;&#x6587;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x6536;&#x5230;&#x540E;&#x4F1A;&#x518D;&#x6B21;&#x4F7F;&#x7528; TCP &#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x8BF7;&#x6C42;</p>
</blockquote>
<p>1: &#x8D85;&#x51FA;&#x6700;&#x5927;&#x957F;&#x5EA6;&#xFF0C;&#x622A;&#x65AD;</p>
<p>0: &#x6B63;&#x5E38;</p>
<p><strong>RD: 1bit &#x671F;&#x671B;&#x9012;&#x5F52;&#x67E5;&#x8BE2;</strong></p>
<p>1: &#x9700;&#x8981;&#x9012;&#x5F52;&#x67E5;&#x8BE2;</p>
<p>0: &#x4E0D;&#x9700;&#x8981;&#x9012;&#x5F52;&#x67E5;&#x8BE2;</p>
<p><strong>RA: 1bit &#x53EF;&#x7528;&#x9012;&#x5F52; &#xFF0C; &#x7528;&#x4E8E;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x4E2D;</strong></p>
<p>1: &#x652F;&#x6301;&#x9012;&#x5F52;</p>
<p>0: &#x4E0D;&#x652F;&#x6301;&#x9012;&#x5F52;</p>
<p><strong>Z: 3bit</strong></p>
<p>&#x4FDD;&#x7559;</p>
<p><strong>RCODE: 4bit &#x54CD;&#x5E94;&#x4EE3;&#x7801;</strong></p>
<p>0: &#x6CA1;&#x6709;&#x9519;&#x8BEF;</p>
<p>1: &#x683C;&#x5F0F;&#x9519;&#x8BEF;</p>
<p>2: &#x670D;&#x52A1;&#x5668;&#x6545;&#x969C;</p>
<p>3: &#x540D;&#x79F0;&#x9519;&#x8BEF;</p>
<p>4: &#x4E0D;&#x652F;&#x6301;&#x8BF7;&#x6C42;&#x7C7B;&#x578B;&#x7684;&#x67E5;&#x8BE2;</p>
<p>5: &#x670D;&#x52A1;&#x5668;&#x62D2;&#x7EDD;&#x67E5;&#x8BE2;</p>
<p>6-15: &#x5907;&#x7528;</p>
<h3 id="2-3-Question-&#x67E5;&#x8BE2;&#x8BF7;&#x6C42;"><a href="#2-3-Question-&#x67E5;&#x8BE2;&#x8BF7;&#x6C42;" class="headerlink" title="2.3 Question &#x67E5;&#x8BE2;&#x8BF7;&#x6C42;"></a>2.3 Question &#x67E5;&#x8BE2;&#x8BF7;&#x6C42;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;                                    1  1  1  1  1  1</span><br><span class="line">      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                                               |</span><br><span class="line">    /                     QNAME                     /</span><br><span class="line">    /                                               /</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                     QTYPE                     |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                     QCLASS                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br></pre></td></tr></table></figure>

<p><strong>QNAME: &#x8868;&#x793A;&#x67E5;&#x8BE2;&#x7684;&#x57DF;&#x540D;</strong></p>
<p>&#x6BCF;&#x4E2A;&#x6807;&#x7B7E;&#x7531;&#x4E00;&#x4E2A;8&#x5B57;&#x8282;&#x7684;&#x957F;&#x5EA6; &#x548C; &#x54CD;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x7EC4;&#x6210;</p>
<p>&#x4F8B;&#x5982; juejin.com</p>
<p>&#x5728;&#x62A5;&#x6587;&#x4E2D;QNAME&#x5E94;&#x8BE5;&#x5C55;&#x793A;&#x4E3A;</p>
<p>6 <code>j u e j in</code> 3 <code>c o m</code> 0</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/98b0f13837556a0a1033f8a89cc6b1be00bde2a37bed1941d795c1cfec9b9392" alt="image.png"></p>
<p><strong>QTYPE: 16bit &#x8BF7;&#x6C42;&#x7684;&#x7C7B;&#x578B;</strong></p>
<p>1: A</p>
<p>2: NS</p>
<p>3: MD</p>
<p>4: MF</p>
<p>5: CNAME</p>
<p>6: SOA</p>
<p>7: MB</p>
<p>8: MG</p>
<p>9: MR</p>
<p>10: NULL</p>
<p>11: WKS</p>
<p>12: PTR</p>
<p>13: HINFO</p>
<p>14: MINFO</p>
<p>15: MX</p>
<p>16: TXT</p>
<p><strong>QCLASS: 16bit &#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x5F0F;</strong></p>
<p>1: &#x4E00;&#x822C;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;</p>
<p>2: CSNET</p>
<p>3: CHAOS</p>
<p>4: Hesiod</p>
<h3 id="2-4-Answer-&#x54CD;&#x5E94;&#x62A5;&#x6587;"><a href="#2-4-Answer-&#x54CD;&#x5E94;&#x62A5;&#x6587;" class="headerlink" title="2.4 Answer &#x54CD;&#x5E94;&#x62A5;&#x6587;"></a>2.4 Answer &#x54CD;&#x5E94;&#x62A5;&#x6587;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;                                    1  1  1  1  1  1</span><br><span class="line">      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                                               |</span><br><span class="line">    /                                               /</span><br><span class="line">    /                      NAME                     /</span><br><span class="line">    |                                               |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                      TYPE                     |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                     CLASS                     |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                      TTL                      |</span><br><span class="line">    |                                               |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    |                   RDLENGTH                    |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|</span><br><span class="line">    /                     RDATA                     /</span><br><span class="line">    /                                               /</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br></pre></td></tr></table></figure>

<p>**NAEM: 16bit **</p>
<p>&#x8D44;&#x6E90;&#x8BB0;&#x5F55;&#x57DF;&#x540D; &#xFF0C; &#x91C7;&#x7528; 2&#x4E2A;byte &#x6765;&#x8868;&#x793A; , CO &#x4E3A;&#x56FA;&#x5B9A;&#x6807;&#x8BB0;&#x4F4D;,&#x4EE3;&#x8868;&#x540E;&#x9762;&#x7684;&#x503C;&#x4E3A;&#x504F;&#x79FB;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">    | 1  1|                OFFSET                   |</span><br><span class="line">    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br></pre></td></tr></table></figure>

<p><strong>TYPE 16bit</strong></p>
<p>RDATA&#x8D44;&#x6E90;&#x7C7B;&#x578B;</p>
<p><strong>CLASS: 16bit</strong></p>
<p>&#x8BF7;&#x6C42;&#x7C7B;&#x578B;</p>
<p><strong>TTL&#xFF1A; 32bit</strong></p>
<p>&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;&#x4E3A;0&#x5219;&#x4E0D;&#x80FD;&#x7F13;&#x5B58;</p>
<p><strong>RDLENGTH: 16bit</strong></p>
<p>RDATA&#x5B57;&#x8282;&#x6570;</p>
<p><strong>RDATA: RDLENGTH byte</strong></p>
<p>&#x8D44;&#x6E90;&#x8BB0;&#x5F55;&#x503C;</p>
<ol start="3">
<li>DNS golang &#x4EE3;&#x7801;&#x6848;&#x4F8B;</li>
</ol>
<hr>
<h3 id="3-1-&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x62A5;&#x6587;"><a href="#3-1-&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x62A5;&#x6587;" class="headerlink" title="3.1 &#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x62A5;&#x6587;"></a>3.1 &#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x62A5;&#x6587;</h3><p>&#x83B7;&#x53D6;/&#x751F;&#x6210;A&#x8BB0;&#x5F55;&#x62A5;&#x6587;Demo &#x4EE3;&#x7801;&#x653E;&#x5728;&#x4E86; gitee &#x4E0A; <a href="/external_links/ec78dd902f441811864658db28e5bf1b.html" target="blank" rel="noopener">gitee.com/pdudo/Sampl&#x2026;</a></p>
<p>&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">golang&#x590D;&#x5236;&#x4EE3;&#x7801;package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;gitee.com/pdudo/SampleDNSTool&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	var dnsInfo SampleDNSTool.DNSInfo</span><br><span class="line"></span><br><span class="line">	udpconn ,err := net.ListenUDP(&quot;udp&quot;,&amp;net.UDPAddr{</span><br><span class="line">		IP: net.IPv4(0,0,0,0),</span><br><span class="line">		Port: 53,</span><br><span class="line">	})</span><br><span class="line">	</span><br><span class="line">	if err != nil {</span><br><span class="line">		log.Fatal(&quot;listen udp error&quot; , err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	for {</span><br><span class="line">		buf := make([]byte,1024)</span><br><span class="line">		n , err := udpconn.Read(buf[:])</span><br><span class="line">		if err != nil {</span><br><span class="line">			log.Println(&quot;udpconn error &quot; , err)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		dnsInfo.GetHeader(buf[:n])</span><br><span class="line">		dnsInfo.GetQuestion(buf[:n])</span><br><span class="line"></span><br><span class="line">		fmt.Println(&quot;DNS &#x67E5;&#x8BE2;ID&#xFF1A; &quot; ,dnsInfo.Header.ID ,</span><br><span class="line">			&quot;HeaderStatus:&quot; , dnsInfo.Header.HeaderStatus ,</span><br><span class="line">			&quot;QCount:&quot; , dnsInfo.Header.QCOUNT,</span><br><span class="line">			&quot;Qname:&quot; , dnsInfo.QueryInfo.QNAMEString ,</span><br><span class="line">			&quot;QTYPE:&quot;,dnsInfo.QueryInfo.QTYPE ,</span><br><span class="line">			&quot;QCLASS:&quot;,dnsInfo.QueryInfo.QCLASS)</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x542F;&#x52A8;&#x670D;&#x52A1;&#x5668; &#x5E76;&#x4E14; &#x4F7F;&#x7528;nslookup&#x6A21;&#x62DF;&#x8BF7;&#x6C42;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# go build</span><br><span class="line"># ./testDNSQuery</span><br></pre></td></tr></table></figure>

<p>&#x5BA2;&#x6237;&#x7AEF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# nslookup juejin.com 127.0.0.1</span><br><span class="line">;; connection timed out; no servers could be reached</span><br><span class="line"></span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>&#x7A0B;&#x5E8F;&#x8F93;&#x51FA;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# ./testDNSQuery</span><br><span class="line">DNS &#x67E5;&#x8BE2;ID&#xFF1A;  27284 HeaderStatus: {0 0 0 0 1 0 0 0} QCount: 1 Qname: juejin.com QTYPE: 1 QCLASS: 1</span><br><span class="line">DNS &#x67E5;&#x8BE2;ID&#xFF1A;  27284 HeaderStatus: {0 0 0 0 1 0 0 0} QCount: 1 Qname: juejin.com QTYPE: 1 QCLASS: 1</span><br><span class="line">DNS &#x67E5;&#x8BE2;ID&#xFF1A;  27284 HeaderStatus: {0 0 0 0 1 0 0 0} QCount: 1 Qname: juejin.com QTYPE: 1 QCLASS: 1</span><br></pre></td></tr></table></figure>

<p>&#x751F;&#x6210;&#x54CD;&#x5E94;&#x62A5;&#x6587;</p>
<p>&#x4FEE;&#x6539;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">golang&#x590D;&#x5236;&#x4EE3;&#x7801;package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;gitee.com/pdudo/SampleDNSTool&quot;</span><br><span class="line">    &quot;log&quot;</span><br><span class="line">    &quot;net&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line"></span><br><span class="line">    var dnsInfo SampleDNSTool.DNSInfo</span><br><span class="line"></span><br><span class="line">    udpconn ,err := net.ListenUDP(&quot;udp&quot;,&amp;net.UDPAddr{</span><br><span class="line">        IP: net.IPv4(0,0,0,0),</span><br><span class="line">        Port: 53,</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    if err != nil {</span><br><span class="line">        log.Fatal(&quot;listen udp error&quot; , err)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    for {</span><br><span class="line">        buf := make([]byte,1024)</span><br><span class="line">        n , fromudpaddr , err := udpconn.ReadFromUDP(buf[:])</span><br><span class="line">        if err != nil {</span><br><span class="line">            log.Println(&quot;udpconn error &quot; , err)</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        dnsInfo.GetHeader(buf[:n])</span><br><span class="line">        dnsInfo.GetQuestion(buf[:n])</span><br><span class="line"></span><br><span class="line">        fmt.Println(&quot;DNS&#x6536;&#x5230;&#x8BF7;&#x6C42; &#xFF0C; &#x67E5;&#x8BE2;ID&#xFF1A; &quot; ,dnsInfo.Header.ID ,</span><br><span class="line">            &quot;HeaderStatus:&quot; , dnsInfo.Header.HeaderStatus ,</span><br><span class="line">            &quot;QCount:&quot; , dnsInfo.Header.QCOUNT,</span><br><span class="line">            &quot;Qname:&quot; , dnsInfo.QueryInfo.QNAMEString ,</span><br><span class="line">            &quot;QTYPE:&quot;,dnsInfo.QueryInfo.QTYPE ,</span><br><span class="line">            &quot;QCLASS:&quot;,dnsInfo.QueryInfo.QCLASS)</span><br><span class="line"></span><br><span class="line">        // &#x6784;&#x5EFA;&#x56DE;&#x590D;&#x62A5;&#x6587;</span><br><span class="line">        if (1 == dnsInfo.QueryInfo.QTYPE) {</span><br><span class="line">            ip := make([]byte,4)</span><br><span class="line">            ip[0] = 192</span><br><span class="line">            ip[1] = 168</span><br><span class="line">            ip[2] = 111</span><br><span class="line">            ip[3] = 129</span><br><span class="line">            res :=  dnsInfo.GenerateAnswers(buf[:n],ip,0,1)</span><br><span class="line"></span><br><span class="line">            //udpconn.Write(res)</span><br><span class="line">            udpconn.WriteToUDP(res,fromudpaddr)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5229;&#x7528;nslookup&#x67E5;&#x770B;&#x6548;&#x679C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# nslookup juejin.com 127.0.0.1</span><br><span class="line">Server:         127.0.0.1</span><br><span class="line">Address:        127.0.0.1#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:   juejin.com</span><br><span class="line">Address: 192.168.111.129</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;var code = &quot;df7cfb57-4300-4caa-a3bc-3a489833b53c&quot;</span><br></pre></td></tr></table></figure>

<p><strong>&#x5B8C;</strong></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/6c9c29c7c45908d2840629a83312f904.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035979455809978376.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035979455809978376.html" itemprop="url">关于knife4j的文档自动注册功能的解决 1 存在问题 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:14:35+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x8FD9;&#x662F;&#x6211;&#x53C2;&#x4E0E;11&#x6708;&#x66F4;&#x6587;&#x6311;&#x6218;&#x7684;&#x7B2C;20&#x5929;&#xFF0C;&#x6D3B;&#x52A8;&#x8BE6;&#x60C5;&#x67E5;&#x770B;&#xFF1A;<a href="https://dev.newban.cn/7023643374569816095">11&#x6708;&#x66F4;&#x6587;&#x6311;&#x6218;</a></p>
<h1 id="1-&#x5B58;&#x5728;&#x95EE;&#x9898;"><a href="#1-&#x5B58;&#x5728;&#x95EE;&#x9898;" class="headerlink" title="1 &#x5B58;&#x5728;&#x95EE;&#x9898;"></a>1 &#x5B58;&#x5728;&#x95EE;&#x9898;</h1><p>&#x4E0A;&#x4E00;&#x7BC7;,&#x5173;&#x4E8E;knife4j&#x6574;&#x5408;&#x5FAE;&#x670D;&#x52A1;&#x805A;&#x5408;&#x6587;&#x6863;, &#x5728;&#x65E5;&#x5E38;&#x9879;&#x76EE;&#x4E2D;,&#x4F7F;&#x7528;&#x7B80;&#x5355;,&#x65B9;&#x4FBF;, &#x53EF;&#x662F;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x95EE;&#x9898;, &#x5C31;&#x662F;&#x9700;&#x8981;&#x5728;&#x6587;&#x6863;&#x670D;&#x52A1;&#x4E2D;,&#x624B;&#x52A8;&#x7684;&#x914D;&#x7F6E;&#x5176;&#x4ED6;&#x670D;&#x52A1;&#x7684;&#x8DEF;&#x7531;&#x5730;&#x5740;,&#x800C;&#x4E14;, &#x6BCF;&#x6B21;&#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x670D;&#x52A1;,&#x90FD;&#x9700;&#x8981;&#x914D;&#x7F6E;,&#x4F7F;&#x7528;&#x8D77;&#x6765;&#x4E0D;&#x662F;&#x5F88;&#x7075;&#x6D3B;&#x4FBF;&#x6377;,&#x90A3;&#x6709;&#x6CA1;&#x6709;&#x89E3;&#x51B3;&#x65B9;&#x6848;, &#x6587;&#x6863;&#x670D;&#x52A1;,&#x4E3B;&#x52A8;&#x53BB;nacos&#x4E2D;&#x83B7;&#x53D6;&#x670D;&#x52A1;,&#x81EA;&#x52A8;&#x6CE8;&#x518C;&#x5230;&#x6587;&#x6863;&#x670D;&#x52A1;&#x7684;&#x5462;?, &#x7B54;&#x6848;&#x662F;&#x80AF;&#x5B9A;&#x7684;, &#x5BF9;&#x4E8E;&#x8FD9;&#x4E00;&#x5757;,knife4j&#x5DE5;&#x5177;&#x63D0;&#x4F9B;&#x4E86;&#x76F8;&#x5173;&#x7684;&#x5165;&#x53E3;.</p>
<h1 id="2-&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#2-&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="2 &#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>2 &#x89E3;&#x51B3;&#x65B9;&#x6848;</h1><p>&#x5BF9;&#x4E8E;&#x4E0A;&#x6B21;&#x7684;knife4j&#x6574;&#x5408;&#x5FAE;&#x670D;&#x52A1;&#x805A;&#x5408;&#x6587;&#x6863;&#x6587;&#x7AE0;&#x505A;&#x589E;&#x5F3A;&#x529F;&#x80FD;, &#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x53EF;&#x590D;&#x7528;&#x4E4B;&#x524D;&#x7684;, &#x672C;&#x6B21;&#x53EA;&#x5BF9;&#x6587;&#x6863;&#x670D;&#x52A1;&#x6539;&#x9020;&#x5373;&#x53EF;.</p>
<h4 id="&#x6587;&#x6863;&#x670D;&#x52A1;&#x6848;&#x5217;"><a href="#&#x6587;&#x6863;&#x670D;&#x52A1;&#x6848;&#x5217;" class="headerlink" title="&#x6587;&#x6863;&#x670D;&#x52A1;&#x6848;&#x5217;"></a>&#x6587;&#x6863;&#x670D;&#x52A1;&#x6848;&#x5217;</h4><p><strong>Nacos&#x670D;&#x52A1;&#x7C7B;</strong></p>
<p>&#x4E3B;&#x8981;&#x5904;&#x7406;nacos&#x4E2D;&#x670D;&#x52A1;&#x5B9E;&#x4F8B;,&#x5305;&#x62EC;&#x9274;&#x6743;,nacos&#x914D;&#x7F6E;&#x7B49;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DocNacosService extends NacosService {</span><br><span class="line"></span><br><span class="line">    Logger logger = LoggerFactory.getLogger(NacosService.class);</span><br><span class="line">    /**</span><br><span class="line">     * Nacos&#x83B7;&#x53D6;&#x5B9E;&#x4F8B;&#x5217;&#x8868;OpenAPI&#x63A5;&#x53E3;&#xFF0C;&#x8BE6;&#x60C5;&#x53C2;&#x8003;&#xFF1A;https://nacos.io/zh-cn/docs/open-api.html</span><br><span class="line">     */</span><br><span class="line">    private static final String NACOS_INSTANCE_LIST_API = &quot;/v1/ns/instance/list&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * &#x670D;&#x52A1;&#x540D;&#x79F0;</span><br><span class="line">     */</span><br><span class="line">    private final String serviceUrl;</span><br><span class="line">    /**</span><br><span class="line">     * Nacos&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x9274;&#x6743;,&#x53C2;&#x8003;issue&#xFF1A;https://gitee.com/xiaoym/knife4j/issues/I28IF9 since 2.0.9</span><br><span class="line">     */</span><br><span class="line">    private final String accessToken;</span><br><span class="line">    /**</span><br><span class="line">     * Nacos&#x914D;&#x7F6E;</span><br><span class="line">     */</span><br><span class="line">    private final NacosRoute nacosRoute;</span><br><span class="line"></span><br><span class="line">    public DocNacosService(String serviceUrl, String accessToken,</span><br><span class="line">            NacosRoute nacosRoute) {</span><br><span class="line">        super(serviceUrl, accessToken, nacosRoute);</span><br><span class="line">        this.serviceUrl = serviceUrl;</span><br><span class="line">        this.accessToken = accessToken;</span><br><span class="line">        this.nacosRoute = nacosRoute;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Optional&lt;NacosInstance&gt; call() throws Exception {</span><br><span class="line">        List&lt;String&gt; params = new ArrayList&lt;&gt;();</span><br><span class="line">        params.add(&quot;serviceName=&quot; + nacosRoute.getServiceName());</span><br><span class="line">        //&#x9ED8;&#x8BA4;&#x805A;&#x5408;&#x65F6;&#x53EA;&#x8FD4;&#x56DE;&#x5065;&#x5EB7;&#x5B9E;&#x4F8B;</span><br><span class="line">        params.add(&quot;healthyOnly=true&quot;);</span><br><span class="line">        if (StrUtil.isNotBlank(nacosRoute.getGroupName())) {</span><br><span class="line">            params.add(&quot;groupName=&quot; + nacosRoute.getGroupName());</span><br><span class="line">        }</span><br><span class="line">        if (StrUtil.isNotBlank(nacosRoute.getNamespaceId())) {</span><br><span class="line">            params.add(&quot;namespaceId=&quot; + nacosRoute.getNamespaceId());</span><br><span class="line">        }</span><br><span class="line">        if (StrUtil.isNotBlank(nacosRoute.getClusters())) {</span><br><span class="line">            params.add(&quot;clusters=&quot; + nacosRoute.getClusters());</span><br><span class="line">        }</span><br><span class="line">        //Nacos&#x9274;&#x6743; since2.0.9</span><br><span class="line">        if (StrUtil.isNotBlank(this.accessToken)) {</span><br><span class="line">            params.add(&quot;accessToken=&quot; + this.accessToken);</span><br><span class="line">        }</span><br><span class="line">        String parameter = CollectionUtil.join(params, &quot;&amp;&quot;);</span><br><span class="line">        String api = serviceUrl + NACOS_INSTANCE_LIST_API + &quot;?&quot; + parameter;</span><br><span class="line">        if (logger.isDebugEnabled()) {</span><br><span class="line">            logger.debug(&quot;Nacos API:{}&quot;, api);</span><br><span class="line">        }</span><br><span class="line">        HttpGet get = new HttpGet(api);</span><br><span class="line">        CloseableHttpResponse response = getClient().execute(get);</span><br><span class="line">        if (response != null) {</span><br><span class="line">            int statusCode = response.getStatusLine().getStatusCode();</span><br><span class="line">            if (logger.isDebugEnabled()) {</span><br><span class="line">                logger.debug(&quot;Nacos Response Status:{}&quot;, statusCode);</span><br><span class="line">            }</span><br><span class="line">            if (statusCode == HttpStatus.SC_OK) {</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), &quot;UTF-8&quot;);</span><br><span class="line">                if (StrUtil.isNotBlank(content)) {</span><br><span class="line">                    if (logger.isDebugEnabled()) {</span><br><span class="line">                        logger.debug(&quot;Response Content:{}&quot;, content);</span><br><span class="line">                    }</span><br><span class="line">                    JsonElement jsonElement = JsonParser.parseString(content);</span><br><span class="line">                    if (jsonElement != null &amp;&amp; jsonElement.isJsonObject()) {</span><br><span class="line">                        JsonElement instances = jsonElement.getAsJsonObject().get(&quot;hosts&quot;);</span><br><span class="line">                        if (instances != null &amp;&amp; instances.isJsonArray()) {</span><br><span class="line">                            Type type = new TypeToken&lt;List&lt;NacosInstance&gt;&gt;() {</span><br><span class="line">                            }.getType();</span><br><span class="line">                            List&lt;NacosInstance&gt; nacosInstances = new Gson()</span><br><span class="line">                                    .fromJson(instances, type);</span><br><span class="line">                            if (CollectionUtil.isNotEmpty(nacosInstances)) {</span><br><span class="line">                                NacosInstance nacosInstance = nacosInstances.stream().findAny()</span><br><span class="line">                                        .get();</span><br><span class="line">                                nacosInstance.setServiceName(nacosRoute.getServiceName());</span><br><span class="line">                                return Optional.of(nacosInstance);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } else {</span><br><span class="line">                get.abort();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return Optional.empty();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>Nacos&#x670D;&#x52A1;&#x8D44;&#x6E90;&#x5E93;&#x7C7B;</strong></p>
<p>&#x4E3B;&#x8981;&#x662F;&#x521D;&#x59CB;&#x5316;nacos&#x8D44;&#x6E90;&#x5E93;, &#x4ECE;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x83B7;&#x53D6;,&#x4ECE;nacos&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x52A0;&#x8F7D;&#x5230;&#x672C;&#x5730;&#x8D44;&#x6E90;&#x5E93;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DocNacosRepository extends NacosRepository {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DiscoveryClient discoveryClient;</span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment environment;</span><br><span class="line"></span><br><span class="line">    private volatile boolean stop = false;</span><br><span class="line">    private Thread thread;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(NacosRepository.class);</span><br><span class="line"></span><br><span class="line">    private NacosSetting nacosSetting;</span><br><span class="line"></span><br><span class="line">    final ThreadPoolExecutor threadPoolExecutor = ThreadUtil.newExecutor(5, 5);</span><br><span class="line"></span><br><span class="line">    private Map&lt;String, NacosInstance&gt; nacosInstanceMap = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public DocNacosRepository(</span><br><span class="line">            NacosSetting nacosSetting) {</span><br><span class="line">        super(nacosSetting);</span><br><span class="line">        this.nacosSetting = nacosSetting;</span><br><span class="line"></span><br><span class="line">        if (nacosSetting != null &amp;&amp; CollectionUtil.isNotEmpty(nacosSetting.getRoutes())) {</span><br><span class="line">            initNacos(nacosSetting);</span><br><span class="line">            applyRoutes(nacosSetting);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x521D;&#x59CB;&#x5316; nacos&#x914D;&#x7F6E;&#x5C5E;&#x6027;</span><br><span class="line">     */</span><br><span class="line">    private void applyRoutes(NacosSetting nacosSetting) {</span><br><span class="line">        if (CollectionUtil.isNotEmpty(nacosInstanceMap)) {</span><br><span class="line">            nacosSetting.getRoutes().forEach(nacosRoute -&gt; {</span><br><span class="line">                if (nacosRoute.getRouteAuth() == null || !nacosRoute.getRouteAuth().isEnable()) {</span><br><span class="line">                    nacosRoute.setRouteAuth(nacosSetting.getRouteAuth());</span><br><span class="line">                }</span><br><span class="line">                this.routeMap.put(nacosRoute.pkId(), new SwaggerRoute(nacosRoute,</span><br><span class="line">                        nacosInstanceMap.get(nacosRoute.getServiceName())));</span><br><span class="line">            });</span><br><span class="line">            nacosSetting.getRoutes().forEach(nacosRoute -&gt; this.routeMap.put(nacosRoute.pkId(),</span><br><span class="line">                    new SwaggerRoute(nacosRoute,</span><br><span class="line">                            nacosInstanceMap.get(nacosRoute.getServiceName()))));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void initNacos(NacosSetting nacosSetting) {</span><br><span class="line">        List&lt;Future&lt;Optional&lt;NacosInstance&gt;&gt;&gt; optionalList = new ArrayList&lt;&gt;();</span><br><span class="line">        nacosSetting.initAccessToken();</span><br><span class="line">        nacosSetting.getRoutes().forEach(nacosRoute -&gt; optionalList.add(threadPoolExecutor</span><br><span class="line">                .submit(new NacosService(nacosSetting.getServiceUrl(), nacosSetting.getSecret(),</span><br><span class="line">                        nacosRoute))));</span><br><span class="line">        optionalList.stream().forEach(optionalFuture -&gt; {</span><br><span class="line">            try {</span><br><span class="line">                Optional&lt;NacosInstance&gt; nacosInstanceOptional = optionalFuture.get();</span><br><span class="line">                if (nacosInstanceOptional.isPresent()) {</span><br><span class="line">                    nacosInstanceMap.put(nacosInstanceOptional.get().getServiceName(),</span><br><span class="line">                            nacosInstanceOptional.get());</span><br><span class="line">                }</span><br><span class="line">            } catch (Exception e) {</span><br><span class="line">                logger.error(&quot;nacos get error:&quot; + e.getMessage(), e);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public NacosSetting getNacosSetting() {</span><br><span class="line">        return nacosSetting;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public BasicAuth getAuth(String header) {</span><br><span class="line">        BasicAuth basicAuth = null;</span><br><span class="line">        if (nacosSetting != null &amp;&amp; CollectionUtil.isNotEmpty(nacosSetting.getRoutes())) {</span><br><span class="line">            if (nacosSetting.getRouteAuth() != null &amp;&amp; nacosSetting.getRouteAuth().isEnable()) {</span><br><span class="line">                basicAuth = nacosSetting.getRouteAuth();</span><br><span class="line">                //&#x5224;&#x65AD;route&#x670D;&#x52A1;&#x4E2D;&#x662F;&#x5426;&#x518D;&#x5355;&#x72EC;&#x914D;&#x7F6E;</span><br><span class="line">                BasicAuth routeBasicAuth = getAuthByRoute(header, nacosSetting.getRoutes());</span><br><span class="line">                if (routeBasicAuth != null) {</span><br><span class="line">                    basicAuth = routeBasicAuth;</span><br><span class="line">                }</span><br><span class="line">            } else {</span><br><span class="line">                basicAuth = getAuthByRoute(header, nacosSetting.getRoutes());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return basicAuth;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void start() {</span><br><span class="line">        logger.info(&quot;start Nacos hearbeat Holder thread.&quot;);</span><br><span class="line">        thread = new Thread(() -&gt; {</span><br><span class="line">            while (!stop) {</span><br><span class="line">                try {</span><br><span class="line">                    ThreadUtil.sleep(HEART_BEAT_DURATION);</span><br><span class="line">                    logger.debug(&quot;nacos hearbeat start working...&quot;);</span><br><span class="line">                    this.nacosSetting.initAccessToken();</span><br><span class="line"></span><br><span class="line">                    List&lt;NacosRoute&gt; routes = this.nacosSetting.getRoutes();</span><br><span class="line">                    // yaml&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6CA1;&#x6709;&#x8DEF;&#x7531;,&#x5219;&#x81EA;&#x52A8;&#x4ECE;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x53BB;&#x83B7;&#x53D6;&#x5728;&#x7EBF;&#x670D;&#x52A1;,&#x8F6C;&#x4E3A;route</span><br><span class="line">                    if (CollectionUtil.isEmpty(routes)) {</span><br><span class="line">                        routes = getServiceToRouteList();</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    //&#x6821;&#x9A8C;&#x8BE5;&#x670D;&#x52A1;&#x662F;&#x5426;&#x5728;&#x7EBF;</span><br><span class="line">                    routes.forEach(nacosRoute -&gt; {</span><br><span class="line">                        try {</span><br><span class="line">                            NacosService nacosService = new DocNacosService(</span><br><span class="line">                                    this.nacosSetting.getServiceUrl(),</span><br><span class="line">                                    this.nacosSetting.getSecret(), nacosRoute);</span><br><span class="line">                            //&#x5355;&#x7EBF;&#x7A0B;check&#x5373;&#x53EF;</span><br><span class="line">                            Optional&lt;NacosInstance&gt; nacosInstanceOptional = nacosService.call();</span><br><span class="line">                            if (nacosInstanceOptional.isPresent()) {</span><br><span class="line">                                this.routeMap.put(nacosRoute.pkId(),</span><br><span class="line">                                        new SwaggerRoute(nacosRoute, nacosInstanceOptional.get()));</span><br><span class="line">                            } else {</span><br><span class="line">                                //&#x5F53;&#x524D;&#x670D;&#x52A1;&#x4E0B;&#x7EBF;&#xFF0C;&#x5254;&#x9664;</span><br><span class="line">                                this.routeMap.remove(nacosRoute.pkId());</span><br><span class="line">                            }</span><br><span class="line">                        } catch (Exception e) {</span><br><span class="line">                            //&#x53D1;&#x751F;&#x5F02;&#x5E38;,&#x5254;&#x9664;&#x670D;&#x52A1;</span><br><span class="line">                            this.routeMap.remove(nacosRoute.pkId());</span><br><span class="line">                            logger.debug(e.getMessage(), e);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    logger.debug(e.getMessage(), e);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        thread.setDaemon(true);</span><br><span class="line">        thread.start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x4ECE;nacos&#x4E2D;&#x83B7;&#x53D6;&#x670D;&#x52A1;&#x5217;&#x8868;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private List&lt;NacosRoute&gt; getServiceToRouteList() {</span><br><span class="line">        List&lt;NacosRoute&gt; nacosRouteList = Lists.newArrayList();</span><br><span class="line">        List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">        if (CollectionUtil.isEmpty(services)){</span><br><span class="line">            return nacosRouteList;</span><br><span class="line">        }</span><br><span class="line">        for (String service : services) {</span><br><span class="line">            NacosRoute nacosRoute = new NacosRoute();</span><br><span class="line">            nacosRoute.setGroupName(environment.getProperty(&quot;spring.cloud.nacos.discovery.group&quot;));</span><br><span class="line">            nacosRoute.setNamespaceId(environment.getProperty(&quot;spring.cloud.nacos.discovery.namespace&quot;));</span><br><span class="line">            nacosRoute.setClusters(environment.getProperty(&quot;spring.cloud.nacos.discovery.cluster-name&quot;));</span><br><span class="line">            nacosRoute.setName(service);</span><br><span class="line">            nacosRoute.setServiceName(service);</span><br><span class="line">            nacosRoute.setServicePath(service);</span><br><span class="line">            nacosRoute.setLocation(&quot;/v2/api-docs&quot;);</span><br><span class="line">            nacosRouteList.add(nacosRoute);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return nacosRouteList;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() {</span><br><span class="line">        logger.info(&quot;stop Nacos heartbeat Holder thread.&quot;);</span><br><span class="line">        this.stop = true;</span><br><span class="line">        if (thread != null) {</span><br><span class="line">            ThreadUtil.interrupt(thread, true);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x8DEF;&#x7531;&#x5206;&#x53D1;&#x7C7B;</strong></p>
<p>&#x4E3B;&#x8981;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x8DEF;&#x7531;&#x8F6C;&#x53D1;&#x7B49;, &#x5BF9;&#x4E8E;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;, &#x53EF;&#x4EE5;&#x6839;&#x636E;&#x4E1A;&#x52A1;&#x7684;&#x4E0D;&#x540C;,&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x72B6;&#x6001;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DocRouteDispatcher extends RouteDispatcher {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x8BF7;&#x6C42;&#x5934;</span><br><span class="line">     */</span><br><span class="line">    public static final String ROUTE_PROXY_HEADER_NAME = &quot;knfie4j-gateway-request&quot;;</span><br><span class="line">    public static final String ROUTE_PROXY_HEADER_BASIC_NAME = &quot;knife4j-gateway-basic-request&quot;;</span><br><span class="line">    public static final String OPENAPI_GROUP_ENDPOINT = &quot;/swagger-resources&quot;;</span><br><span class="line">    public static final String OPENAPI_GROUP_INSTANCE_ENDPOINT = &quot;/swagger-instance&quot;;</span><br><span class="line">    public static final String ROUTE_BASE_PATH = &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    Logger logger = LoggerFactory.getLogger(RouteDispatcher.class);</span><br><span class="line">    /**</span><br><span class="line">     * &#x5F53;&#x524D;&#x9879;&#x76EE;&#x7684;contextPath</span><br><span class="line">     */</span><br><span class="line">    private String rootPath;</span><br><span class="line"></span><br><span class="line">    private RouteRepository routeRepository;</span><br><span class="line"></span><br><span class="line">    private RouteExecutor routeExecutor;</span><br><span class="line"></span><br><span class="line">    private RouteCache&lt;String, SwaggerRoute&gt; routeCache;</span><br><span class="line"></span><br><span class="line">    private Set&lt;String&gt; ignoreHeaders = new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public DocRouteDispatcher(RouteRepository routeRepository,</span><br><span class="line">            RouteCache&lt;String, SwaggerRoute&gt; routeRouteCache,</span><br><span class="line">            ExecutorEnum executorEnum,</span><br><span class="line">            String rootPath) {</span><br><span class="line">        super(routeRepository, routeRouteCache, executorEnum, rootPath);</span><br><span class="line"></span><br><span class="line">        this.routeRepository = routeRepository;</span><br><span class="line">        this.routeCache = routeRouteCache;</span><br><span class="line">        this.rootPath = rootPath;</span><br><span class="line">        initExecutor(executorEnum);</span><br><span class="line">        ignoreHeaders.addAll(Arrays.asList(new String[]{</span><br><span class="line">                &quot;host&quot;, &quot;content-length&quot;, ROUTE_PROXY_HEADER_NAME, ROUTE_PROXY_HEADER_BASIC_NAME, &quot;Request-Origion&quot;</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void initExecutor(ExecutorEnum executorEnum) {</span><br><span class="line">        if (executorEnum == null) {</span><br><span class="line">            throw new IllegalArgumentException(&quot;ExecutorEnum can not be empty&quot;);</span><br><span class="line">        }</span><br><span class="line">        switch (executorEnum) {</span><br><span class="line">            case APACHE:</span><br><span class="line">                this.routeExecutor = new ApacheClientExecutor();</span><br><span class="line">                break;</span><br><span class="line">            case OKHTTP:</span><br><span class="line">                this.routeExecutor = new OkHttpClientExecutor();</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                throw new UnsupportedOperationException(&quot;UnSupported ExecutorType:&quot; + executorEnum.name());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean checkRoute(String header) {</span><br><span class="line">        if (StrUtil.isNotBlank(header)) {</span><br><span class="line">            SwaggerRoute swaggerRoute = routeRepository.getRoute(header);</span><br><span class="line">            if (swaggerRoute != null) {</span><br><span class="line">                return StrUtil.isNotBlank(swaggerRoute.getUri());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void execute(HttpServletRequest request, HttpServletResponse response) {</span><br><span class="line">        try {</span><br><span class="line">            RouteRequestContext routeContext = new RouteRequestContext();</span><br><span class="line">            this.buildContext(routeContext, request);</span><br><span class="line">            RouteResponse routeResponse = routeExecutor.executor(routeContext);</span><br><span class="line">            writeResponseStatus(routeResponse, response);</span><br><span class="line">            // todo</span><br><span class="line">            //  &#x8BF7;&#x6C42;/v2/api-docs  &#x54CD;&#x5E94;&#x72B6;&#x6001;&#x8BBE;&#x4E3A;200 &#x4E0D;&#x629B;&#x51FA;&#x5176;&#x4ED6;&#x72B6;&#x6001;</span><br><span class="line">            if(response.getStatus()!=200 &amp;&amp; request.getRequestURI().equals(&quot;/v2/api-docs&quot;)){</span><br><span class="line">                response.setStatus(200);</span><br><span class="line">            }</span><br><span class="line">            writeResponseHeader(routeResponse, response);</span><br><span class="line">            writeBody(routeResponse, response);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            logger.error(&quot;has Error:{}&quot;, e.getMessage());</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            //write Default</span><br><span class="line">            writeDefault(request, response, e.getMessage());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void writeDefault(HttpServletRequest request, HttpServletResponse response, String errMsg) {</span><br><span class="line">        response.setContentType(&quot;application/json&quot;);</span><br><span class="line">        response.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        try {</span><br><span class="line">            PrintWriter printWriter = response.getWriter();</span><br><span class="line">            Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">            map.put(&quot;message&quot;, errMsg);</span><br><span class="line">            // todo</span><br><span class="line">            //  &#x8BF7;&#x6C42;/v2/api-docs  &#x54CD;&#x5E94;&#x72B6;&#x6001;&#x8BBE;&#x4E3A;200 &#x4E0D;&#x629B;&#x51FA;&#x5176;&#x4ED6;&#x72B6;&#x6001;</span><br><span class="line">            map.put(&quot;code&quot;, &quot;200&quot;);</span><br><span class="line">            map.put(&quot;path&quot;, request.getRequestURI());</span><br><span class="line">            new JSONObject(map).write(printWriter);</span><br><span class="line">            printWriter.close();</span><br><span class="line">        } catch (IOException e) {</span><br><span class="line">            //ignore</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Write &#x54CD;&#x5E94;&#x72B6;&#x6001;&#x7801;</span><br><span class="line">     *</span><br><span class="line">     * @param routeResponse routeResponse</span><br><span class="line">     * @param response      response</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void writeResponseStatus(RouteResponse routeResponse, HttpServletResponse response) {</span><br><span class="line">        if (routeResponse != null) {</span><br><span class="line">            response.setStatus(routeResponse.getStatusCode());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Write&#x54CD;&#x5E94;&#x5934;</span><br><span class="line">     *</span><br><span class="line">     * @param routeResponse route&#x54CD;&#x5E94;&#x5BF9;&#x8C61;</span><br><span class="line">     * @param response &#x54CD;&#x5E94;response</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void writeResponseHeader(RouteResponse routeResponse, HttpServletResponse response) {</span><br><span class="line">        if (routeResponse != null) {</span><br><span class="line">            if (CollectionUtil.isNotEmpty(routeResponse.getHeaders())) {</span><br><span class="line">                for (HeaderWrapper header : routeResponse.getHeaders()) {</span><br><span class="line">                    if (!StrUtil.equalsIgnoreCase(header.getName(), &quot;Transfer-Encoding&quot;)) {</span><br><span class="line">                        response.addHeader(header.getName(), header.getValue());</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            if (logger.isDebugEnabled()) {</span><br><span class="line">                logger.debug(&quot;&#x54CD;&#x5E94;&#x7C7B;&#x578B;:{},&#x54CD;&#x5E94;&#x7F16;&#x7801;:{}&quot;, routeResponse.getContentType(), routeResponse.getCharsetEncoding());</span><br><span class="line">            }</span><br><span class="line">            response.setContentType(routeResponse.getContentType());</span><br><span class="line">            if (routeResponse.getContentLength() &gt; 0) {</span><br><span class="line">                response.setContentLengthLong(routeResponse.getContentLength());</span><br><span class="line">            }</span><br><span class="line">            response.setCharacterEncoding(routeResponse.getCharsetEncoding().displayName());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x54CD;&#x5E94;&#x5185;&#x5BB9;</span><br><span class="line">     *</span><br><span class="line">     * @param routeResponse route&#x54CD;&#x5E94;&#x5BF9;&#x8C61;</span><br><span class="line">     * @param response &#x54CD;&#x5E94;&#x5BF9;&#x8C61;</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void writeBody(RouteResponse routeResponse, HttpServletResponse response) throws IOException {</span><br><span class="line">        if (routeResponse != null) {</span><br><span class="line">            if (routeResponse.success()) {</span><br><span class="line">                InputStream inputStream = routeResponse.getBody();</span><br><span class="line">                if (inputStream != null) {</span><br><span class="line">                    int read = -1;</span><br><span class="line">                    byte[] bytes = new byte[1024 * 1024];</span><br><span class="line">                    ServletOutputStream outputStream = response.getOutputStream();</span><br><span class="line">                    while ((read = inputStream.read(bytes)) != -1) {</span><br><span class="line">                        outputStream.write(bytes, 0, read);</span><br><span class="line">                    }</span><br><span class="line">                    IoUtil.close(inputStream);</span><br><span class="line">                    IoUtil.close(outputStream);</span><br><span class="line">                }</span><br><span class="line">            } else {</span><br><span class="line">                String text = routeResponse.text();</span><br><span class="line">                if (StrUtil.isNotBlank(text)) {</span><br><span class="line">                    PrintWriter printWriter = response.getWriter();</span><br><span class="line">                    printWriter.write(text);</span><br><span class="line">                    printWriter.close();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6784;&#x5EFA;&#x8DEF;&#x7531;&#x7684;&#x8BF7;&#x6C42;&#x4E0A;&#x4E0B;&#x6587;</span><br><span class="line">     *</span><br><span class="line">     * @param routeRequestContext &#x8BF7;&#x6C42;&#x4E0A;&#x4E0B;&#x6587;</span><br><span class="line">     * @param request &#x8BF7;&#x6C42;&#x5BF9;&#x8C61;</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void buildContext(RouteRequestContext routeRequestContext, HttpServletRequest request) throws IOException {</span><br><span class="line">        // &#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x662F;&#x5426;basic&#x8BF7;&#x6C42;</span><br><span class="line">        String basicHeader = request.getHeader(ROUTE_PROXY_HEADER_BASIC_NAME);</span><br><span class="line">        if (StrUtil.isNotBlank(basicHeader)) {</span><br><span class="line">            BasicAuth basicAuth = routeRepository.getAuth(basicHeader);</span><br><span class="line">            if (basicAuth != null) {</span><br><span class="line">                //&#x589E;&#x52A0;Basic&#x8BF7;&#x6C42;&#x5934;</span><br><span class="line">                routeRequestContext.addHeader(&quot;Authorization&quot;, RouteUtils.authorize(basicAuth.getUsername(),</span><br><span class="line">                        basicAuth.getPassword()));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        SwaggerRoute swaggerRoute = getRoute(request.getHeader(ROUTE_PROXY_HEADER_NAME));</span><br><span class="line">        //String uri=&quot;http://knife4j.xiaominfo.com&quot;;</span><br><span class="line">        String uri = swaggerRoute.getUri();</span><br><span class="line">        if (StrUtil.isBlank(uri)) {</span><br><span class="line">            throw new RuntimeException(&quot;Uri is Empty&quot;);</span><br><span class="line">        }</span><br><span class="line">        String host = URI.create(uri).getHost();</span><br><span class="line">        String fromUri = request.getRequestURI();</span><br><span class="line">        StringBuilder requestUrlBuilder = new StringBuilder();</span><br><span class="line">        requestUrlBuilder.append(uri);</span><br><span class="line">        // &#x5224;&#x65AD;&#x5F53;&#x524D;&#x805A;&#x5408;&#x9879;&#x76EE;&#x7684;contextPath</span><br><span class="line">        if (StrUtil.isNotBlank(this.rootPath) &amp;&amp; !StrUtil.equals(this.rootPath, ROUTE_BASE_PATH)) {</span><br><span class="line">            fromUri = fromUri.replaceFirst(this.rootPath, &quot;&quot;);</span><br><span class="line">        }</span><br><span class="line">        // &#x5224;&#x65AD;servicePath</span><br><span class="line">        if (StrUtil.isNotBlank(swaggerRoute.getServicePath()) &amp;&amp; !StrUtil.equals(swaggerRoute.getServicePath(),</span><br><span class="line">                ROUTE_BASE_PATH)) {</span><br><span class="line">            if (StrUtil.startWith(fromUri, swaggerRoute.getServicePath())) {</span><br><span class="line">                //&#x5B9E;&#x9645;&#x5728;&#x8BF7;&#x6C42;&#x65F6;,&#x5254;&#x9664;servicePath,&#x5426;&#x5219;&#x4F1A;&#x9020;&#x6210;404</span><br><span class="line">                fromUri = fromUri.replaceFirst(swaggerRoute.getServicePath(), &quot;&quot;);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        requestUrlBuilder.append(fromUri);</span><br><span class="line">        //String requestUrl=uri+fromUri;</span><br><span class="line">        String requestUrl = requestUrlBuilder.toString();</span><br><span class="line">        if (logger.isDebugEnabled()) {</span><br><span class="line">            logger.debug(&quot;&#x76EE;&#x6807;&#x8BF7;&#x6C42;Url:{},&#x8BF7;&#x6C42;&#x7C7B;&#x578B;:{},Host:{}&quot;, requestUrl, request.getMethod(), host);</span><br><span class="line">        }</span><br><span class="line">        routeRequestContext.setOriginalUri(fromUri);</span><br><span class="line">        routeRequestContext.setUrl(requestUrl);</span><br><span class="line">        routeRequestContext.setMethod(request.getMethod());</span><br><span class="line">        Enumeration&lt;String&gt; enumeration = request.getHeaderNames();</span><br><span class="line">        while (enumeration.hasMoreElements()) {</span><br><span class="line">            String key = enumeration.nextElement();</span><br><span class="line">            String value = request.getHeader(key);</span><br><span class="line">            if (!ignoreHeaders.contains(key.toLowerCase())) {</span><br><span class="line">                routeRequestContext.addHeader(key, value);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        routeRequestContext.addHeader(&quot;Host&quot;, host);</span><br><span class="line">        Enumeration&lt;String&gt; params = request.getParameterNames();</span><br><span class="line">        while (params.hasMoreElements()) {</span><br><span class="line">            String name = params.nextElement();</span><br><span class="line">            String value = request.getParameter(name);</span><br><span class="line">            //logger.info(&quot;param-name:{},value:{}&quot;,name,value);</span><br><span class="line">            routeRequestContext.addParam(name, value);</span><br><span class="line">        }</span><br><span class="line">        // &#x589E;&#x52A0;&#x6587;&#x4EF6;&#xFF0C;sinc 2.0.9</span><br><span class="line">        try {</span><br><span class="line">            Collection&lt;Part&gt; parts=request.getParts();</span><br><span class="line">            if (CollectionUtil.isNotEmpty(parts)){</span><br><span class="line">                parts.forEach(part -&gt; routeRequestContext.addPart(part));</span><br><span class="line">            }</span><br><span class="line">        } catch (ServletException e) {</span><br><span class="line">            //ignore</span><br><span class="line">            logger.warn(&quot;get part error,message:&quot;+e.getMessage());</span><br><span class="line">        }</span><br><span class="line">        routeRequestContext.setRequestContent(request.getInputStream());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public SwaggerRoute getRoute(String header) {</span><br><span class="line">        //&#x53BB;&#x9664;&#x7F13;&#x5B58;&#x673A;&#x5236;&#xFF0C;&#x7531;&#x4E8E;Eureka&#x4EE5;&#x53CA;Nacos&#x8BBE;&#x7ACB;&#x4E86;&#x5FC3;&#x8DF3;&#x68C0;&#x6D4B;&#x673A;&#x5236;&#xFF0C;&#x670D;&#x52A1;&#x5728;&#x591A;&#x8282;&#x70B9;&#x90E8;&#x7F72;&#x65F6;&#xFF0C;&#x8282;&#x70B9;ip&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x53D8;&#x5316;,&#x5BFC;&#x81F4;&#x8C03;&#x8BD5;&#x6700;&#x7EC8;&#x8F6C;&#x53D1;&#x7ED9;&#x5DF2;&#x7ECF;&#x4E0B;&#x7EBF;&#x7684;&#x670D;&#x52A1;</span><br><span class="line">        //since 2.0.9</span><br><span class="line">        SwaggerRoute swaggerRoute = routeRepository.getRoute(header);</span><br><span class="line">        return swaggerRoute;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;SwaggerRoute&gt; getRoutes() {</span><br><span class="line">        return routeRepository.getRoutes();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>Nacos&#x914D;&#x7F6E;&#x7C7B;</strong></p>
<p>&#x81EA;&#x52A8;&#x914D;&#x7F6E;, &#x5C06;nacos&#x8D44;&#x6E90;&#x5E93;,&#x8DEF;&#x7531;&#x5206;&#x53D1;&#x7B49;&#x52A0;&#x8F7D;&#x5230;&#x5BB9;&#x5668;&#x4E2D;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Configuration</span><br><span class="line">@AutoConfigureAfter(Knife4jAggregationAutoConfiguration.class)</span><br><span class="line">@ConditionalOnProperty(name = &quot;knife4j.enableAggregation&quot;, havingValue = &quot;true&quot;)</span><br><span class="line">public class DocNacosConfiguration {</span><br><span class="line"></span><br><span class="line">    final Environment environment;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public DocNacosConfiguration(Environment environment) {</span><br><span class="line">        this.environment = environment;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Primary</span><br><span class="line">    @Bean(initMethod = &quot;start&quot;, destroyMethod = &quot;close&quot;)</span><br><span class="line">    @ConditionalOnProperty(name = &quot;knife4j.nacos.enable&quot;, havingValue = &quot;true&quot;)</span><br><span class="line">    @RefreshScope</span><br><span class="line">    public NacosRepository customNacosRepository(</span><br><span class="line">            @Autowired Knife4jAggregationProperties customKnife4jAggregationProperties) {</span><br><span class="line">        return new DocNacosRepository(customKnife4jAggregationProperties.getNacos());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x914D;&#x5408;nacos&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x52A8;&#x6001;&#x5237;&#x65B0;</span><br><span class="line">     */</span><br><span class="line">    @Primary</span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;knife4j&quot;)</span><br><span class="line">    @RefreshScope</span><br><span class="line">    @ConditionalOnProperty(name = &quot;knife4j.nacos.enable&quot;, havingValue = &quot;true&quot;)</span><br><span class="line">    public Knife4jAggregationProperties customKnife4jAggregationProperties() {</span><br><span class="line">        return new Knife4jAggregationProperties();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    @ConditionalOnProperty(name = &quot;knife4j.nacos.enable&quot;, havingValue = &quot;true&quot;)</span><br><span class="line">    public RouteDispatcher customRouteDispatcher(@Autowired RouteRepository routeRepository,</span><br><span class="line">            @Autowired RouteCache&lt;String, SwaggerRoute&gt; routeCache) {</span><br><span class="line">        //&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x7684;contextPath</span><br><span class="line">        String contextPath = environment.getProperty(&quot;server.servlet.context-path&quot;);</span><br><span class="line">        if (StrUtil.isBlank(contextPath)) {</span><br><span class="line">            contextPath = &quot;/&quot;;</span><br><span class="line">        }</span><br><span class="line">        if (StrUtil.isNotBlank(contextPath) &amp;&amp; !StrUtil</span><br><span class="line">                .equals(contextPath, RouteDispatcher.ROUTE_BASE_PATH)) {</span><br><span class="line">            //&#x5224;&#x65AD;&#x662F;&#x5426;/&#x5F00;&#x5934;</span><br><span class="line">            if (!StrUtil.startWith(contextPath, RouteDispatcher.ROUTE_BASE_PATH)) {</span><br><span class="line">                contextPath = RouteDispatcher.ROUTE_BASE_PATH + contextPath;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return new DocRouteDispatcher(routeRepository, routeCache, ExecutorEnum.APACHE,</span><br><span class="line">                contextPath);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x670D;&#x52A1;&#x542F;&#x52A8;&#x7C7B;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@EnableDiscoveryClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">@Slf4j</span><br><span class="line">public class Application {</span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">        log.info(&quot;&#x542F;&#x52A8;&#x6210;&#x529F;&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x914D;&#x7F6E;&#x6587;&#x4EF6;application.yml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yml&#x590D;&#x5236;&#x4EE3;&#x7801;server:</span><br><span class="line">  port: 8000</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr:  127.0.0.1:8848 # &#x914D;&#x7F6E;nacos &#x670D;&#x52A1;&#x7AEF;&#x5730;&#x5740;</span><br><span class="line">  application:</span><br><span class="line">    name: knife4j-doc # &#x670D;&#x52A1;&#x540D;&#x79F0;</span><br><span class="line"></span><br><span class="line">knife4j:</span><br><span class="line">  # &#x5F00;&#x542F;&#x805A;&#x5408;</span><br><span class="line">  enableAggregation: true</span><br><span class="line">  nacos:</span><br><span class="line">    enable: true</span><br><span class="line">    serviceUrl: http://localhost:8848/nacos</span><br></pre></td></tr></table></figure>

<p><strong>&#x914D;&#x7F6E;&#x6587;&#x4EF6;spring.factories</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">factories&#x590D;&#x5236;&#x4EE3;&#x7801;org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">com.cf.config.DocNacosConfiguration</span><br></pre></td></tr></table></figure>

<p><strong>&#x6D4B;&#x8BD5;</strong></p>
<p><strong>&#x6D4B;&#x8BD5;&#x6B65;&#x9AA4;</strong></p>
<p>1 &#x542F;&#x52A8;nacos&#x670D;&#x52A1;</p>
<p>2 &#x542F;&#x52A8;&#x4E24;&#x4E2A;Demo&#x4E1A;&#x52A1;&#x670D;&#x52A1;</p>
<p>3 &#x542F;&#x52A8;&#x6587;&#x6863;&#x670D;&#x52A1;</p>
<p>4 &#x672C;&#x5730;&#x8BBF;&#x95EE; <a href="/external_links/a47ddbac3052d31a02f6b5ad6c61c345.html" target="blank" rel="noopener">http://localhost:8000/doc.html</a></p>
<p><strong>&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;</strong></p>
<p>1 &#x6D4B;&#x8BD5;&#x7ED3;&#x679C;, &#x53D1;&#x73B0;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x7684;&#x5728;&#x7EBF;&#x6587;&#x6863;&#x548C;&#x6587;&#x6863;&#x670D;&#x52A1;&#x5B8C;&#x7F8E;&#x805A;&#x5408;.</p>
<p>2 &#x901A;&#x8FC7;&#x6D4B;&#x8BD5;, &#x4E0B;&#x7EBF;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x670D;&#x52A1;, &#x6587;&#x6863;&#x670D;&#x52A1;&#x4E2D;,&#x4E5F;&#x4F1A;&#x5254;&#x9664;&#x6389;&#x76F8;&#x5E94;&#x7684;&#x5728;&#x6587;&#x6863;.</p>
<p>3 &#x5C06;&#x5728;&#x7EBF;&#x6587;&#x6863;&#x8F6C;&#x4E3A;&#x79BB;&#x7EBF;&#x6587;&#x6863;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;, &#x529F;&#x80FD;&#x6B63;&#x5E38;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/f86f321fb9e2b066cbb966a5bc0bb6fd.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035977546407608350.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035977546407608350.html" itemprop="url">看了就能用的HTML+Freemarker小知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:10:41+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5927;&#x5BB6;&#x597D;&#xFF0C;&#x6211;&#x662F;&#x201C;Java&#x5206;&#x5E03;&#x5F0F;&#x67B6;&#x6784;&#x5B9E;&#x6218;&#x201D;&#x7684;&#x4F5C;&#x8005;Jamesfu&#x3002;</p>
<h4 id="&#x95EE;&#x9898;&#x8D77;&#x6E90;"><a href="#&#x95EE;&#x9898;&#x8D77;&#x6E90;" class="headerlink" title="&#x95EE;&#x9898;&#x8D77;&#x6E90;"></a>&#x95EE;&#x9898;&#x8D77;&#x6E90;</h4><p>&#x6700;&#x8FD1;&#x5728;&#x6309;&#x5DE5;&#x4FE1;&#x90E8;&#x8981;&#x6C42;&#x5BF9;&#x7F51;&#x7AD9;&#x505A;&#x9002;&#x8001;&#x5316;&#x65E0;&#x969C;&#x788D;&#x6D4F;&#x89C8;&#x6539;&#x9020;&#x3002;&#x5728;&#x6539;&#x9020;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;Bug&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/51847f77f7d0cb8cec983ef082e930616010efd123ff35d78c7f3cb20cf0f716" alt="image.png"><br>&#x7ECF;&#x8FC7;&#x591A;&#x8F6E;&#x6392;&#x67E5;&#xFF0C;&#x6700;&#x7EC8;&#x5B9A;&#x4F4D;&#x5230;&#x7F51;&#x7AD9;&#x53D8;&#x7070;&#x76F8;&#x5173;&#x7684;&#x4E00;&#x6BB5;freemarker&#x4EE3;&#x7801;&#xFF0C;&#x53D1;&#x73B0;&#x5B83;&#x7684;ELSE&#x5206;&#x652F;&#x8F93;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;<code>&lt;span&gt;&lt;/span&gt;</code>&#x6807;&#x7B7E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;[#assign nowTime = .now?string[&quot;hhmmSSsss&quot;]/]</span><br><span class="line">[#if checkGrayScale]</span><br><span class="line">    [#if grayScaleType?? &amp;&amp; 1==grayScaleType]</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">          var isHomeGrayByTemplate = true</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/assets/css/homeGrayscale.css?t=${nowTime?number}&quot;/&gt;</span><br><span class="line">    [#elseif grayScaleType?? &amp;&amp; 2==grayScaleType]</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">          var isHomeGrayByTemplate = false</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/assets/css/grayscale.css?t=${nowTime?number}&quot;/&gt;</span><br><span class="line">    [/#if]</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;/static/assets/third/jquery.gray.min.js?t=${nowTime?number}&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; defer=&quot;defer&quot; src=&quot;/static/assets/js/grayScale.js?t=${nowTime?number}&quot;&gt;&lt;/script&gt;</span><br><span class="line">[#else]</span><br><span class="line">    &lt;span&gt;&lt;/span&gt;</span><br><span class="line">[/#if]</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x63A8;&#x65AD;&#x5C31;&#x662F;&#x8FD9;&#x91CC;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x4E3A;span&#x6807;&#x7B7E;&#x662F;&#x9700;&#x8981;&#x6E32;&#x67D3;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x51FA;&#x73B0;&#x5728;&#x4E86;body&#x6807;&#x7B7E;&#x4E2D;&#xFF0C;&#x4E0D;&#x80FD;&#x51FA;&#x73B0;&#x5728;head&#x6807;&#x7B7E;&#x4E2D;&#x3002;&#x7ECF;&#x8FC7;&#x591A;&#x8F6E;&#x6D4B;&#x8BD5;&#x53D1;&#x73B0;&#x786E;&#x5B9E;&#x662F;&#x8FD9;&#x91CC;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<h4 id="&#x7ED3;&#x8BBA;"><a href="#&#x7ED3;&#x8BBA;" class="headerlink" title="&#x7ED3;&#x8BBA;"></a>&#x7ED3;&#x8BBA;</h4><ol>
<li>&#x5728;HTML <code>&lt;head&gt;&lt;/head&gt;</code>&#x6807;&#x7B7E;&#x4E2D;&#x4E0D;&#x8981;&#x51FA;&#x73B0;&#x5177;&#x4F53;&#x7684;&#x9700;&#x8981;&#x6E32;&#x67D3;&#x7684;HTML&#x6807;&#x7B7E;&#xFF0C;&#x6BD4;&#x5982;<code>&lt;span&gt;&lt;/span&gt;</code>&#x7B49;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x51FA;&#x73B0;&#x6E32;&#x67D3;&#x6807;&#x7B7E;&#x4EE5;&#x540E;&#x7684;&#x5185;&#x5BB9;&#x90FD;&#x4F1A;&#x8F93;&#x51FA;&#x5230;<code>&lt;body&gt;&lt;/body&gt;</code>&#x6807;&#x7B7E;&#x4E2D;&#x3002;</li>
<li><code>&#x5728;freemarker&#x6A21;&#x677F;&#x4E2D;&#xFF0C;&#x5982;&#x679C;ELSE&#x5206;&#x6790;&#x4E0D;&#x8F93;&#x51FA;&#x4EFB;&#x4F55;&#x5185;&#x5BB9;&#xFF0C;&#x53D1;&#x73B0;freemarker&#x4E0D;&#x4F1A;&#x8F93;&#x51FA;&#x7A7A;&#x6587;&#x4EF6;&#xFF0C;&#x5373;&#x4E0D;&#x66F4;&#x65B0;&#x9759;&#x6001;&#x5316;&#x6587;&#x4EF6;</code>&#xFF0C;&#x56E0;&#x6B64;&#x5728;ELSE&#x5206;&#x652F;&#x4E2D;&#x8FD8;&#x5FC5;&#x987B;&#x8F93;&#x51FA;&#x70B9;&#x4EC0;&#x4E48;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x51B3;&#x5B9A;&#x8F93;&#x51FA;&#x4E00;&#x4E2A;&#x7A7A;script&#x6807;&#x7B7E;&#xFF0C;&#x6700;&#x7EC8;&#x95EE;&#x9898;&#x5F97;&#x5230;&#x89E3;&#x51B3;&#x3002;</li>
</ol>
<p>&#x6700;&#x7EC8;&#x63D0;&#x4EA4;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;[#assign nowTime = .now?string[&quot;hhmmSSsss&quot;]/]</span><br><span class="line">[#if checkGrayScale]</span><br><span class="line">    [#if grayScaleType?? &amp;&amp; 1==grayScaleType]</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">          var isHomeGrayByTemplate = true</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/assets/css/homeGrayscale.css?t=${nowTime?number}&quot;/&gt;</span><br><span class="line">    [#elseif grayScaleType?? &amp;&amp; 2==grayScaleType]</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">          var isHomeGrayByTemplate = false</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/assets/css/grayscale.css?t=${nowTime?number}&quot;/&gt;</span><br><span class="line">    [/#if]</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;/static/assets/third/jquery.gray.min.js?t=${nowTime?number}&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; defer=&quot;defer&quot; src=&quot;/static/assets/js/grayScale.js?t=${nowTime?number}&quot;&gt;&lt;/script&gt;</span><br><span class="line">[#else]</span><br><span class="line">    &lt;script&gt;&lt;/script&gt;</span><br><span class="line">[/#if]</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/f5aaa95614c6daf0136800d0b8582b37.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035976690232885284.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035976690232885284.html" itemprop="url">网络编程学习2--套接字、地址</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T21:05:20+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>socket&#x82F1;&#x6587;&#x610F;&#x601D;&#x662F;&#x201D;&#x63D2;&#x53E3;&#x201D;,&#x5728;&#x7F51;&#x7EDC;&#x7F16;&#x7A0B;&#x4E2D;,&#x5B83;&#x7684;&#x5BD3;&#x610F;&#x662F;&#x53EF;&#x4EE5;<strong>&#x901A;&#x8FC7;&#x63D2;&#x53E3;&#x63A5;&#x5165;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5FEB;&#x901F;&#x5B8C;&#x6210;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x548C;&#x6570;&#x636E;&#x6536;&#x53D1;</strong>.</p>
<h2 id="&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5DE5;&#x4F5C;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;"><a href="#&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5DE5;&#x4F5C;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;" class="headerlink" title="&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5DE5;&#x4F5C;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;"></a>&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5DE5;&#x4F5C;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/8d0181fbce75efb5cfdf63b62f85d5eb9fc2f82692b07d4bc90b256ac50215ed" alt="&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5DE5;&#x4F5C;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;.png"><br>&#x670D;&#x52A1;&#x5668;&#x7AEF;:</p>
<ol>
<li>&#x521D;&#x59CB;&#x5316;socket(&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x524D;,&#x670D;&#x52A1;&#x5668;&#x5FC5;&#x987B;&#x5148;&#x521D;&#x59CB;&#x5316;&#x597D;).</li>
<li>&#x6267;&#x884C;bind&#x51FD;&#x6570;(&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x670D;&#x52A1;&#x80FD;&#x529B;&#x7ED1;&#x5B9A;&#x5230;&#x4E00;&#x4E2A;&#x4F17;&#x6240;&#x5468;&#x77E5;&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x4E0A;)</li>
<li>&#x6267;&#x884C;listen&#x64CD;&#x4F5C;(&#x5C06;&#x539F;&#x5148;&#x7684;socket&#x8F6C;&#x6362;&#x4E3A;&#x670D;&#x52A1;&#x7AEF;&#x7684;socket)</li>
<li>&#x670D;&#x52A1;&#x5668;&#x963B;&#x585E;&#x5728;accept&#x4E0A;,&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x7684;&#x5230;&#x6765;</li>
</ol>
<p>&#x5BA2;&#x6237;&#x7AEF;:</p>
<ol>
<li>&#x521D;&#x59CB;&#x5316;socket</li>
<li>&#x6267;&#x884C;connect&#x5411;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;(&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x9884;&#x5148;&#x77E5;&#x9053;&#x7684;).</li>
</ol>
<p>&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x540E;,&#x5C31;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x4E86;.</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x7A0B;&#x5411;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x53D1;&#x8D77; write &#x5B57;&#x8282;&#x6D41;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x5185;&#x6838;&#x534F;&#x8BAE;&#x6808;&#x5C06;&#x5B57;&#x8282;&#x6D41;&#x901A;&#x8FC7;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x4F20;&#x8F93;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4ECE;&#x5185;&#x6838;&#x5F97;&#x5230;&#x4FE1;&#x606F;&#xFF0C;&#x5C06;&#x5B57;&#x8282;&#x6D41;&#x4ECE;&#x5185;&#x6838;&#x8BFB;&#x5165;&#x5230;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x5E76;&#x5F00;&#x59CB;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x518D;&#x5C06;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x4EE5;&#x540C;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x5199;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;<strong>&#x4E00;&#x65E6;&#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#xFF0C;&#x6570;&#x636E;&#x7684;&#x4F20;&#x8F93;&#x5C31;&#x4E0D;&#x518D;&#x662F;&#x5355;&#x5411;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x53CC;&#x5411;&#x7684;</strong>&#xFF0C;&#x8FD9;&#x4E5F;&#x662F; TCP &#x7684;&#x4E00;&#x4E2A;&#x663E;&#x8457;&#x7279;&#x6027;&#x3002;</p>
<p>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5B8C;&#x6210;&#x4EA4;&#x4E92;&#x540E;,&#x9700;&#x8981;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x65F6;,&#x5C31;&#x4F1A;&#x6267;&#x884C;close&#x51FD;&#x6570;.&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x6B64;&#x65F6;&#x4F1A;&#x901A;&#x8FC7;&#x539F;&#x5148;&#x7684;&#x8FDE;&#x63A5;&#x94FE;&#x8DEF;&#x5411;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x53D1;&#x9001;&#x4E00;&#x4E2A; FIN &#x5305;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x4E4B;&#x540E;&#x6267;&#x884C;&#x88AB;&#x52A8;&#x5173;&#x95ED;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6574;&#x4E2A;&#x94FE;&#x8DEF;&#x5904;&#x4E8E;<strong>&#x534A;&#x5173;&#x95ED;&#x72B6;&#x6001;</strong>&#xFF0C;&#x6B64;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4E5F;&#x4F1A;&#x6267;&#x884C; close &#x51FD;&#x6570;&#xFF0C;&#x6574;&#x4E2A;&#x94FE;&#x8DEF;&#x624D;&#x4F1A;&#x771F;&#x6B63;&#x5173;&#x95ED;&#x3002;&#x534A;&#x5173;&#x95ED;&#x7684;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x53D1;&#x8D77; close &#x8BF7;&#x6C42;&#x7684;&#x4E00;&#x65B9;&#x5728;&#x6CA1;&#x6709;&#x6536;&#x5230;&#x5BF9;&#x65B9; FIN &#x5305;&#x4E4B;&#x524D;&#x90FD;&#x8BA4;&#x4E3A;&#x8FDE;&#x63A5;&#x662F;&#x6B63;&#x5E38;&#x7684;&#xFF1B;&#x800C;&#x5728;&#x5168;&#x5173;&#x95ED;&#x7684;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x53CC;&#x65B9;&#x90FD;&#x611F;&#x77E5;&#x8FDE;&#x63A5;&#x5DF2;&#x7ECF;&#x5173;&#x95ED;&#x3002;</p>
<p>&#x4EE5;&#x4E0A;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x901A;&#x8FC7;socket&#x6765;&#x5B8C;&#x6210;&#x7684;,<strong>socket&#x662F;&#x7528;&#x6765;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;,&#x4F20;&#x8F93;&#x6570;&#x636E;&#x7684;&#x552F;&#x4E00;&#x9014;&#x5F84;</strong>.</p>
<h2 id="socket&#x5730;&#x5740;&#x683C;&#x5F0F;"><a href="#socket&#x5730;&#x5740;&#x683C;&#x5F0F;" class="headerlink" title="socket&#x5730;&#x5740;&#x683C;&#x5F0F;"></a>socket&#x5730;&#x5740;&#x683C;&#x5F0F;</h2><p>&#x5728;&#x4F7F;&#x7528;socket&#x65F6;,&#x9996;&#x5148;&#x8981;&#x89E3;&#x51B3;&#x53CC;&#x65B9;&#x7684;<strong>&#x5BFB;&#x5740;&#x95EE;&#x9898;</strong>,&#x7531;&#x4E8E;&#x9700;&#x8981;socket&#x7684;&#x5730;&#x5740;&#x6765;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;,&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x9700;&#x8981;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x5730;&#x5740;. &#x5C31;&#x50CF;&#x6253;&#x7535;&#x8BDD;(&#x4F7F;&#x7528;socket&#x8FDB;&#x884C;&#x901A;&#x4FE1;)&#x65F6;&#x9996;&#x5148;&#x9700;&#x8981;&#x67E5;&#x627E;&#x7535;&#x8BDD;&#x7C3F;(&#x5BFB;&#x5740;)&#xFF0C;&#x627E;&#x5230;&#x4F60;&#x60F3;&#x8981;&#x8054;&#x7CFB;&#x7684;&#x90A3;&#x4E2A;&#x4EBA;&#xFF0C;&#x4F60;&#x624D;&#x53EF;&#x4EE5;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x5F00;&#x59CB;&#x4EA4;&#x6D41;</p>
<h3 id="&#x901A;&#x7528;sokcet&#x5730;&#x5740;&#x683C;&#x5F0F;"><a href="#&#x901A;&#x7528;sokcet&#x5730;&#x5740;&#x683C;&#x5F0F;" class="headerlink" title="&#x901A;&#x7528;sokcet&#x5730;&#x5740;&#x683C;&#x5F0F;"></a>&#x901A;&#x7528;sokcet&#x5730;&#x5740;&#x683C;&#x5F0F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;/* POSIX.1g &#x89C4;&#x8303;&#x89C4;&#x5B9A;&#x4E86;&#x5730;&#x5740;&#x65CF;&#x4E3A;2&#x5B57;&#x8282;&#x7684;&#x503C;.  */</span><br><span class="line">typedef unsigned short int sa_family_t;</span><br><span class="line">/* &#x63CF;&#x8FF0;&#x901A;&#x7528;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;  */</span><br><span class="line">struct sockaddr{</span><br><span class="line">    sa_family_t sa_family;  /* &#x5730;&#x5740;&#x65CF;.  16-bit*/</span><br><span class="line">    char sa_data[14];   /* &#x5177;&#x4F53;&#x7684;&#x5730;&#x5740;&#x503C; 112-bit */</span><br><span class="line">  };</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x91CC;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5;&#x662F;<strong>&#x5730;&#x5740;&#x65CF;</strong>&#xFF0C;&#x5B83;&#x8868;&#x793A;<strong>&#x4F7F;&#x7528;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x5BF9;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x89E3;&#x91CA;&#x548C;&#x4FDD;&#x5B58;</strong>&#xFF0C;&#x597D;&#x6BD4;&#x7535;&#x8BDD;&#x7C3F;&#x91CC;&#x7684;&#x624B;&#x673A;&#x53F7;&#x683C;&#x5F0F;&#xFF0C;&#x6216;&#x8005;&#x662F;&#x56FA;&#x8BDD;&#x683C;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E24;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x957F;&#x5EA6;&#x548C;&#x542B;&#x4E49;&#x90FD;&#x662F;&#x4E0D;&#x540C;&#x7684;.&#x5730;&#x5740;&#x65CF;&#x5728; glibc &#x91CC;&#x7684;&#x5B9A;&#x4E49;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x5E38;&#x7528;&#x7684;&#x6709;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#xFF1A;</p>
<ul>
<li>AF_LOCAL&#xFF1A;&#x8868;&#x793A;&#x7684;&#x662F;&#x672C;&#x5730;&#x5730;&#x5740;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x662F; Unix &#x5957;&#x63A5;&#x5B57;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;<strong>&#x4E00;&#x822C;&#x7528;&#x4E8E;&#x672C;&#x5730; socket &#x901A;&#x4FE1;</strong>&#xFF0C;&#x5F88;&#x591A;&#x60C5;&#x51B5;&#x4E0B;&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x6210; AF_UNIX&#x3001;AF_FILE&#xFF1B;</li>
<li>AF_INET&#xFF1A;&#x56E0;&#x7279;&#x7F51;&#x4F7F;&#x7528;&#x7684; IPv4 &#x5730;&#x5740;&#xFF1B;</li>
<li>AF_INET6&#xFF1A;&#x56E0;&#x7279;&#x7F51;&#x4F7F;&#x7528;&#x7684; IPv6 &#x5730;&#x5740;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x7684; AF_ &#x8868;&#x793A;&#x7684;&#x542B;&#x4E49;&#x662F; Address Family&#xFF0C;&#x5373;&#x5730;&#x5740;&#x65CF;, &#x4F46;&#x662F;&#x5F88;&#x591A;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x4F1A;&#x770B;&#x5230;&#x4EE5; PF_ &#x8868;&#x793A;&#x7684;&#x5B8F;&#xFF0C;&#x6BD4;&#x5982; PF_INET&#x3001;PF_INET6 &#x7B49;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A; PF_ &#x7684;&#x610F;&#x601D;&#x662F; Protocol Family&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x534F;&#x8BAE;&#x65CF;&#x7684;&#x610F;&#x601D;&#x3002;&#x6211;&#x4EEC;&#x7528; AF_xxx &#x8FD9;&#x6837;&#x7684;&#x503C;&#x6765;&#x521D;&#x59CB;&#x5316; socket &#x5730;&#x5740;&#xFF0C;&#x7528; PF_xxx &#x8FD9;&#x6837;&#x7684;&#x503C;&#x6765;&#x521D;&#x59CB;&#x5316; socket&#x3002;&#x6211;&#x4EEC;&#x5728;<code>&lt;sys/socket.h&gt;</code>&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#x53EF;&#x4EE5;&#x6E05;&#x6670;&#x5730;&#x770B;&#x5230;&#xFF0C;&#x8FD9;<strong>&#x4E24;&#x4E2A;&#x503C;&#x672C;&#x8EAB;&#x5C31;&#x662F;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x7684;</strong>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;/* &#x5404;&#x79CD;&#x5730;&#x5740;&#x65CF;&#x7684;&#x5B8F;&#x5B9A;&#x4E49;  */</span><br><span class="line">#define AF_UNSPEC PF_UNSPEC</span><br><span class="line">#define AF_LOCAL  PF_LOCAL</span><br><span class="line">#define AF_UNIX   PF_UNIX</span><br><span class="line">#define AF_FILE   PF_FILE</span><br><span class="line">#define AF_INET   PF_INET</span><br><span class="line">#define AF_AX25   PF_AX25</span><br><span class="line">#define AF_IPX    PF_IPX</span><br><span class="line">#define AF_APPLETALK  PF_APPLETALK</span><br><span class="line">#define AF_NETROM PF_NETROM</span><br><span class="line">#define AF_BRIDGE PF_BRIDGE</span><br><span class="line">#define AF_ATMPVC PF_ATMPVC</span><br><span class="line">#define AF_X25    PF_X25</span><br><span class="line">#define AF_INET6  PF_INET6</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x7528;&#x5730;&#x5740;&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x901A;&#x7528;&#x7684;&#x610F;&#x601D;&#x662F;<strong>&#x9002;&#x7528;&#x4E8E;&#x591A;&#x79CD;&#x5730;&#x5740;&#x65CF;</strong>.</p>
<h3 id="IPv4-socket&#x5730;&#x5740;&#x683C;&#x5F0F;"><a href="#IPv4-socket&#x5730;&#x5740;&#x683C;&#x5F0F;" class="headerlink" title="IPv4 socket&#x5730;&#x5740;&#x683C;&#x5F0F;"></a>IPv4 socket&#x5730;&#x5740;&#x683C;&#x5F0F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;/* IPV4&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#xFF0C;32bit&#x503C;.  */</span><br><span class="line">typedef uint32_t in_addr_t;</span><br><span class="line">struct in_addr</span><br><span class="line">  {</span><br><span class="line">    in_addr_t s_addr;</span><br><span class="line">  };</span><br><span class="line">  </span><br><span class="line">/* &#x63CF;&#x8FF0;IPV4&#x7684;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x683C;&#x5F0F;  */</span><br><span class="line">struct sockaddr_in</span><br><span class="line">  {</span><br><span class="line">    sa_family_t sin_family; /* 16-bit */  /* &#x5730;&#x5740;&#x65CF; */</span><br><span class="line">    in_port_t sin_port;     /* &#x7AEF;&#x53E3;&#x53F7;  16-bit*/</span><br><span class="line">    struct in_addr sin_addr;    /* Internet address. 32-bit */ /* &#x5177;&#x4F53;&#x7684;&#x5730;&#x5740;&#x503C;(IPv4&#x7684;&#x5730;&#x5740;&#x662F;32bit&#x7684;) */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* &#x8FD9;&#x91CC;&#x4EC5;&#x4EC5;&#x7528;&#x4F5C;&#x5360;&#x4F4D;&#x7B26;&#xFF0C;&#x4E0D;&#x505A;&#x5B9E;&#x9645;&#x7528;&#x5904;  */</span><br><span class="line">    unsigned char sin_zero[8];</span><br><span class="line">  };</span><br></pre></td></tr></table></figure>

<p>&#x548C;&#x901A;&#x7528;&#x5730;&#x5740;&#x683C;&#x5F0F;&#x4E00;&#x6837;,&#x90FD;&#x6709;&#x4E00;&#x4E2A;16bit&#x7684;sin_family&#x5B57;&#x6BB5;,&#x5BF9;&#x4E8E;IPv4&#x6765;&#x8BF4;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#x5C31;&#x662F;AF_INET.  </p>
<p>&#x5BF9;&#x4E8E;&#x7AEF;&#x53E3;&#x53F7;,&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7AEF;&#x53E3;&#x53F7;&#x6700;&#x591A;&#x662F; 16-bit&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6700;&#x5927;&#x652F;&#x6301; 2 &#x7684; 16 &#x6B21;&#x65B9;&#xFF0C;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x662F; 65536&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x77E5;&#x9053;<strong>&#x652F;&#x6301;&#x5BFB;&#x5740;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x6700;&#x591A;&#x5C31;&#x662F; 65535</strong>&#x3002;&#x6709;&#x4E00;&#x4E9B;<strong>&#x4FDD;&#x7559;&#x7AEF;&#x53E3;</strong>,&#x5373;&#x7EA6;&#x5B9A;&#x4FD7;&#x6210;&#x7684;,&#x5DF2;&#x7ECF;&#x88AB;&#x5BF9;&#x5E94;&#x670D;&#x52A1;&#x5E7F;&#x4E3A;&#x4F7F;&#x7528;&#x7684;&#x7AEF;&#x53E3;,&#x5982;ssh&#x7684;22&#x7AEF;&#x53E3;,http&#x7684;80&#x7AEF;&#x53E3;,&#x4E00;&#x822C;&#x800C;&#x8A00;,<strong>&#x5927;&#x4E8E;5000&#x7684;&#x7AEF;&#x53E3;</strong>&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x7AEF;&#x53E3;&#x4F7F;&#x7528;.</p>
<p>glibc&#x5B9A;&#x4E49;&#x7684;&#x4FDD;&#x7559;&#x7AEF;&#x53E3;&#x5982;&#x4E0B;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;</span><br><span class="line">/* Standard well-known ports.  */</span><br><span class="line">enum</span><br><span class="line">  {</span><br><span class="line">    IPPORT_ECHO = 7,    /* Echo service.  */</span><br><span class="line">    IPPORT_DISCARD = 9,   /* Discard transmissions service.  */</span><br><span class="line">    IPPORT_SYSTAT = 11,   /* System status service.  */</span><br><span class="line">    IPPORT_DAYTIME = 13,  /* Time of day service.  */</span><br><span class="line">    IPPORT_NETSTAT = 15,  /* Network status service.  */</span><br><span class="line">    IPPORT_FTP = 21,    /* File Transfer Protocol.  */</span><br><span class="line">    IPPORT_TELNET = 23,   /* Telnet protocol.  */</span><br><span class="line">    IPPORT_SMTP = 25,   /* Simple Mail Transfer Protocol.  */</span><br><span class="line">    IPPORT_TIMESERVER = 37, /* Timeserver service.  */</span><br><span class="line">    IPPORT_NAMESERVER = 42, /* Domain Name Service.  */</span><br><span class="line">    IPPORT_WHOIS = 43,    /* Internet Whois service.  */</span><br><span class="line">    IPPORT_MTP = 57,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    IPPORT_TFTP = 69,   /* Trivial File Transfer Protocol.  */</span><br><span class="line">    IPPORT_RJE = 77,</span><br><span class="line">    IPPORT_FINGER = 79,   /* Finger service.  */</span><br><span class="line">    IPPORT_TTYLINK = 87,</span><br><span class="line">    IPPORT_SUPDUP = 95,   /* SUPDUP protocol.  */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    IPPORT_EXECSERVER = 512,  /* execd service.  */</span><br><span class="line">    IPPORT_LOGINSERVER = 513, /* rlogind service.  */</span><br><span class="line">    IPPORT_CMDSERVER = 514,</span><br><span class="line">    IPPORT_EFSSERVER = 520,</span><br><span class="line"></span><br><span class="line">    /* UDP ports.  */</span><br><span class="line">    IPPORT_BIFFUDP = 512,</span><br><span class="line">    IPPORT_WHOSERVER = 513,</span><br><span class="line">    IPPORT_ROUTESERVER = 520,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* Ports less than this value are reserved for privileged processes.  */</span><br><span class="line">    IPPORT_RESERVED = 1024,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* Ports greater this value are reserved for (non-privileged) servers.  */</span><br><span class="line">    IPPORT_USERRESERVED = 5000</span><br></pre></td></tr></table></figure>

<h3 id="IPv6-socket&#x5730;&#x5740;&#x683C;&#x5F0F;"><a href="#IPv6-socket&#x5730;&#x5740;&#x683C;&#x5F0F;" class="headerlink" title="IPv6 socket&#x5730;&#x5740;&#x683C;&#x5F0F;"></a>IPv6 socket&#x5730;&#x5740;&#x683C;&#x5F0F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;struct sockaddr_in6</span><br><span class="line">  {</span><br><span class="line">    sa_family_t sin6_family; /* 16-bit */ /* &#x5730;&#x5740;&#x65CF; &#x503C;&#x4E3A;AF_INET6 */</span><br><span class="line">    in_port_t sin6_port;  /* &#x4F20;&#x8F93;&#x7AEF;&#x53E3;&#x53F7; # 16-bit */</span><br><span class="line">    uint32_t sin6_flowinfo; /* IPv6&#x6D41;&#x63A7;&#x4FE1;&#x606F; 32-bit*/</span><br><span class="line">    struct in6_addr sin6_addr;  /* IPv6&#x5730;&#x5740;128-bit */</span><br><span class="line">    uint32_t sin6_scope_id; /* IPv6&#x57DF;ID 32-bit */</span><br><span class="line">  };</span><br></pre></td></tr></table></figure>

<p>&#x6574;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x957F;&#x5EA6;&#x662F; 28 &#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5176;&#x4E2D;&#x6D41;&#x63A7;&#x4FE1;&#x606F;&#x548C;&#x57DF; ID &#x5148;&#x4E0D;&#x7528;&#x7BA1;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x5B57;&#x6BB5;&#xFF0C;&#x4E00;&#x4E2A;&#x5728; glibc &#x7684;&#x5B98;&#x7F51;&#x4E0A;&#x6839;&#x672C;&#x6CA1;&#x51FA;&#x73B0;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x662F;&#x5F53;&#x524D;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5B57;&#x6BB5;&#x3002;&#x8FD9;&#x91CC;&#x7684;&#x5730;&#x5740;&#x65CF;&#x663E;&#x7136;&#x5E94;&#x8BE5;&#x662F; AF_INET6&#xFF0C;&#x7AEF;&#x53E3;&#x540C; IPv4 &#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x5173;&#x952E;&#x7684;&#x5730;&#x5740;&#x4ECE; 32 &#x4F4D;&#x5347;&#x7EA7;&#x5230; 128 &#x4F4D;&#xFF0C;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x5C31;&#x5927;&#x5230;&#x6050;&#x6016;&#x4E86;&#xFF0C;&#x5B8C;&#x5168;&#x89E3;&#x51B3;&#x4E86;&#x5BFB;&#x5740;&#x6570;&#x5B57;&#x4E0D;&#x591F;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<h3 id="&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;"><a href="#&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;" class="headerlink" title="&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;"></a>&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;</h3><p>&#x524D;&#x9762;&#x7684;IPv4&#x548C;IPv6&#x5730;&#x5740;&#x683C;&#x5F0F;&#x90FD;&#x662F;<strong>&#x56E0;&#x7279;&#x7F51;socket&#x7684;&#x683C;&#x5F0F;</strong>,&#x800C;&#x672C;&#x5730;socket&#x683C;&#x5F0F;&#x662F;&#x7528;&#x6765;&#x4F5C;&#x4E3A;<strong>&#x672C;&#x5730;&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;</strong>&#x7684;,&#x4E5F;&#x5C31;&#x662F;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684; AF_LOCAL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;struct sockaddr_un {</span><br><span class="line">    unsigned short sun_family; /* &#x56FA;&#x5B9A;&#x4E3A; AF_LOCAL */</span><br><span class="line">    char sun_path[108];   /* &#x8DEF;&#x5F84;&#x540D; */</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<h3 id="&#x51E0;&#x79CD;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x6BD4;&#x8F83;"><a href="#&#x51E0;&#x79CD;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x6BD4;&#x8F83;" class="headerlink" title="&#x51E0;&#x79CD;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x6BD4;&#x8F83;"></a>&#x51E0;&#x79CD;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x6BD4;&#x8F83;</h3><p>IPv4&#x548C;IPv6&#x7684;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x957F;&#x5EA6;&#x662F;&#x56FA;&#x5B9A;&#x7684;,&#x800C;&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x957F;&#x5EA6;&#x662F;&#x53EF;&#x53D8;&#x7684;.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/4671d01811ddb5dd0a49730bdeefe5314440cf6a343115f700fc4f5017857ec3" alt="&#x51E0;&#x79CD;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x7684;&#x6BD4;&#x8F83;.png"></p>
<h3 id="&#x95EE;&#x9898;"><a href="#&#x95EE;&#x9898;" class="headerlink" title="&#x95EE;&#x9898;"></a>&#x95EE;&#x9898;</h3><ol>
<li>&#x8FD9;&#x4E9B;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x5171;&#x6027;?<br>&#x90FD;&#x5177;&#x6709;&#x5730;&#x5740;&#x65CF;&#x5B57;&#x6BB5;&#x548C;&#x5730;&#x5740;&#x5B57;&#x6BB5;(&#x672C;&#x5730;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x4E2D;,&#x8DEF;&#x5F84;&#x540D;&#x5373;&#x662F;&#x5730;&#x5740;).  </li>
</ol>
<p>&#x901A;&#x8FC7;&#x901A;&#x7528;socket&#x5730;&#x5740;&#x683C;&#x5F0F;&#x6765;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;,&#x7136;&#x540E;&#x901A;&#x8FC7;&#x5730;&#x5740;&#x65CF;&#x5B57;&#x6BB5;&#x6765;&#x786E;&#x5B9A;&#x5177;&#x4F53;&#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#x7684;&#x5730;&#x5740;.<br>2. &#x4E3A;&#x4EC0;&#x4E48;&#x672C;&#x5730;socket&#x683C;&#x5F0F;&#x4E0D;&#x9700;&#x8981;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x800C; IPv4 &#x548C; IPv6 socket&#x683C;&#x5F0F;&#x5374;&#x9700;&#x8981;&#x7AEF;&#x53E3;&#x53F7;?<br>&#x5728;unix&#x7CFB;&#x7EDF;&#x4E2D;,&#x4E00;&#x5207;&#x7686;&#x6587;&#x4EF6;,<strong>socket&#x4E5F;&#x662F;&#x6587;&#x4EF6;</strong>.  </p>
<p>&#x672C;&#x5730;socket&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x5728;<strong>&#x8BBF;&#x95EE;&#x672C;&#x5730;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;</strong>,&#x6839;&#x636E;<strong>&#x6587;&#x4EF6;&#x8DEF;&#x5F84;</strong>&#x5C31;&#x53EF;&#x4EE5;&#x533A;&#x5206;,&#x6240;&#x4EE5;&#x4E0D;&#x9700;&#x8981;&#x7AEF;&#x53E3;&#x53F7;.&#x800C;&#x8FDC;&#x7A0B;socket&#x662F;&#x76F4;&#x63A5;<strong>&#x5C06;&#x4E00;&#x6BB5;&#x5B57;&#x8282;&#x6D41;&#x53D1;&#x9001;&#x5230;&#x8FDC;&#x7A0B;&#x8BA1;&#x7B97;&#x673A;&#x7684;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;</strong>,&#x800C;&#x8FDC;&#x7A0B;&#x8BA1;&#x7B97;&#x673A;&#x53EF;&#x80FD;<strong>&#x540C;&#x65F6;&#x6709;&#x591A;&#x4E2A;&#x8FDB;&#x7A0B;&#x5728;&#x8FDB;&#x884C;&#x76D1;&#x542C;</strong>,&#x6240;&#x4EE5;&#x9700;&#x8981;<strong>&#x7528;&#x7AEF;&#x53E3;&#x53F7;&#x6807;&#x5FD7;&#x53D1;&#x7ED9;&#x54EA;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;</strong>.</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/63fbafbb96be25086913a7aae46aee26.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035975489906802702.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035975489906802702.html" itemprop="url">某小厂Java面试题：深拷贝和浅拷贝区别了解吗？什么是引用拷</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T20:58:52+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5927;&#x5BB6;&#x597D;&#xFF0C;&#x6211;&#x662F;Guide&#xFF01;</p>
<p>&#x4ECA;&#x5929;&#x7ED9;&#x5927;&#x5BB6;&#x5206;&#x4EAB;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x57FA;&#x7840;&#x4E5F;&#x662F;&#x975E;&#x5E38;&#x5E38;&#x89C1;&#x7684; Java &#x9762;&#x8BD5;&#x9898;&#xFF1A;&#x201C;&#x6DF1;&#x62F7;&#x8D1D;&#x548C;&#x6D45;&#x62F7;&#x8D1D;&#x533A;&#x522B;&#x4E86;&#x89E3;&#x5417;&#xFF1F;&#x4EC0;&#x4E48;&#x662F;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#xFF1F;&#x201D;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x672C;&#x6587;&#x4E5F;&#x5DF2;&#x7ECF;&#x653E;&#x5230;&#x4E86;&#x6211;&#x7684;&#x7F51;&#x7AD9;&#xFF1A;<a href="/external_links/f682610dae38626751155b8ca5cc662b.html" target="blank" rel="noopener">javaguide.cn/</a> &#x3002;</p>
<p>&#x5173;&#x4E8E;&#x6DF1;&#x62F7;&#x8D1D;&#x548C;&#x6D45;&#x62F7;&#x8D1D;&#x533A;&#x522B;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x5148;&#x7ED9;&#x7ED3;&#x8BBA;&#xFF1A;</p>
<ul>
<li><strong>&#x6D45;&#x62F7;&#x8D1D;</strong>&#xFF1A;&#x6D45;&#x62F7;&#x8D1D;&#x4F1A;&#x5728;&#x5806;&#x4E0A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5BF9;&#x8C61;&#xFF08;&#x533A;&#x522B;&#x4E8E;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#x7684;&#x4E00;&#x70B9;&#xFF09;&#xFF0C;&#x4E0D;&#x8FC7;&#xFF0C;&#x5982;&#x679C;&#x539F;&#x5BF9;&#x8C61;&#x5185;&#x90E8;&#x7684;&#x5C5E;&#x6027;&#x662F;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x7684;&#x8BDD;&#xFF0C;&#x6D45;&#x62F7;&#x8D1D;&#x4F1A;&#x76F4;&#x63A5;&#x590D;&#x5236;&#x5185;&#x90E8;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x5730;&#x5740;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x62F7;&#x8D1D;&#x5BF9;&#x8C61;&#x548C;&#x539F;&#x5BF9;&#x8C61;&#x5171;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x5BF9;&#x8C61;&#x3002;</li>
<li><strong>&#x6DF1;&#x62F7;&#x8D1D;</strong> &#xFF1A;&#x6DF1;&#x62F7;&#x8D1D;&#x4F1A;&#x5B8C;&#x5168;&#x590D;&#x5236;&#x6574;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x62EC;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x6240;&#x5305;&#x542B;&#x7684;&#x5185;&#x90E8;&#x5BF9;&#x8C61;&#x3002;</li>
</ul>
<p>&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x8BBA;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x7406;&#x89E3;&#x7684;&#x8BDD;&#x4E5F;&#x6CA1;&#x5173;&#x7CFB;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x6848;&#x4F8B;&#xFF01;</p>
<p><strong>&#x6D45;&#x62F7;&#x8D1D;</strong></p>
<p>&#x6D45;&#x62F7;&#x8D1D;&#x7684;&#x793A;&#x4F8B;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5B9E;&#x73B0;&#x4E86; <code>Cloneable</code> &#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x91CD;&#x5199;&#x4E86; <code>clone()</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p><code>clone()</code> &#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x7684;&#x662F;&#x7236;&#x7C7B; <code>Object</code> &#x7684; <code>clone()</code> &#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class Address implements Cloneable{</span><br><span class="line">    private final String name;</span><br><span class="line">    // &#x7701;&#x7565;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3001;Getter&amp;Setter&#x65B9;&#x6CD5;</span><br><span class="line">    @Override</span><br><span class="line">    public Address clone() {</span><br><span class="line">        try {</span><br><span class="line">            return (Address) super.clone();</span><br><span class="line">        } catch (CloneNotSupportedException e) {</span><br><span class="line">            throw new AssertionError();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public class Person implements Cloneable {</span><br><span class="line">    private Address address;</span><br><span class="line">    // &#x7701;&#x7565;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3001;Getter&amp;Setter&#x65B9;&#x6CD5;</span><br><span class="line">    @Override</span><br><span class="line">    public Person clone() {</span><br><span class="line">        try {</span><br><span class="line">            Person person = (Person) super.clone();</span><br><span class="line">            return person;</span><br><span class="line">        } catch (CloneNotSupportedException e) {</span><br><span class="line">            throw new AssertionError();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6D4B;&#x8BD5; &#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;Person person1 = new Person(new Address(&quot;&#x6B66;&#x6C49;&quot;));</span><br><span class="line">Person person1Copy = person1.clone();</span><br><span class="line">// true</span><br><span class="line">System.out.println(person1.getAddress() == person1Copy.getAddress());</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x8F93;&#x51FA;&#x7ED3;&#x6784;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C; <code>person1</code> &#x7684;&#x514B;&#x9686;&#x5BF9;&#x8C61;&#x548C; <code>person1</code> &#x4F7F;&#x7528;&#x7684;&#x4ECD;&#x7136;&#x662F;&#x540C;&#x4E00;&#x4E2A; <code>Address</code> &#x5BF9;&#x8C61;&#x3002;</p>
<p><strong>&#x6DF1;&#x62F7;&#x8D1D;</strong></p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x5BF9; <code>Person</code> &#x7C7B;&#x7684; <code>clone()</code> &#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF0C;&#x8FDE;&#x5E26;&#x7740;&#x8981;&#x628A; <code>Person</code> &#x5BF9;&#x8C61;&#x5185;&#x90E8;&#x7684; <code>Address</code> &#x5BF9;&#x8C61;&#x4E00;&#x8D77;&#x590D;&#x5236;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public Person clone() {</span><br><span class="line">    try {</span><br><span class="line">        Person person = (Person) super.clone();</span><br><span class="line">        person.setAddress(person.getAddress().clone());</span><br><span class="line">        return person;</span><br><span class="line">    } catch (CloneNotSupportedException e) {</span><br><span class="line">        throw new AssertionError();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6D4B;&#x8BD5; &#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;Person person1 = new Person(new Address(&quot;&#x6B66;&#x6C49;&quot;));</span><br><span class="line">Person person1Copy = person1.clone();</span><br><span class="line">// false</span><br><span class="line">System.out.println(person1.getAddress() == person1Copy.getAddress());</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x8F93;&#x51FA;&#x7ED3;&#x6784;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x867D;&#x7136; <code>person1</code> &#x7684;&#x514B;&#x9686;&#x5BF9;&#x8C61;&#x548C; <code>person1</code> &#x5305;&#x542B;&#x7684; <code>Address</code> &#x5BF9;&#x8C61;&#x5DF2;&#x7ECF;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x4E86;&#x3002;</p>
<p><strong>&#x90A3;&#x4EC0;&#x4E48;&#x662F;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#x5462;&#xFF1F;</strong> &#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#x5C31;&#x662F;&#x4E24;&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x5F15;&#x7528;&#x6307;&#x5411;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x6211;&#x4E13;&#x95E8;&#x753B;&#x4E86;&#x4E00;&#x5F20;&#x56FE;&#x6765;&#x63CF;&#x8FF0;&#x6D45;&#x62F7;&#x8D1D;&#x3001;&#x6DF1;&#x62F7;&#x8D1D;&#x3001;&#x5F15;&#x7528;&#x62F7;&#x8D1D;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/fb0716875d6840414bc146cc28381e91009f22fe7cb1cda4a0dd032bb3d283eb" alt="shallow&amp;deep-copy.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/a80aacca0ce0a4bc1d28a326337ffe60.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7035975330225455135.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7035975330225455135.html" itemprop="url">Netty编程（十）—— 参数优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-29T20:57:59+08:00">
                2021-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x8FD9;&#x662F;&#x6211;&#x53C2;&#x4E0E;11&#x6708;&#x66F4;&#x6587;&#x6311;&#x6218;&#x7684;&#x7B2C;28&#x5929;&#xFF0C;&#x6D3B;&#x52A8;&#x8BE6;&#x60C5;&#x67E5;&#x770B;&#xFF1A;<a href="https://dev.newban.cn/7023643374569816095/">2021&#x6700;&#x540E;&#x4E00;&#x6B21;&#x66F4;&#x6587;&#x6311;&#x6218;</a></p>
<h2 id="CONNECT-TIMEOUT-MILLIS"><a href="#CONNECT-TIMEOUT-MILLIS" class="headerlink" title="CONNECT_TIMEOUT_MILLIS"></a>CONNECT_TIMEOUT_MILLIS</h2><ul>
<li>&#x5C5E;&#x4E8E; <strong>SocketChannal</strong> &#x7684;&#x53C2;&#x6570;</li>
<li>&#x7528;&#x5728;<strong>&#x5BA2;&#x6237;&#x7AEF;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;</strong>&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x6307;&#x5B9A;&#x6BEB;&#x79D2;&#x5185;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#xFF0C;&#x4F1A;&#x629B;&#x51FA; timeout &#x5F02;&#x5E38;</li>
<li><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;Netty &#x4E2D;&#x4E0D;&#x8981;&#x7528;&#x6210;&#x4E86;SO_TIMEOUT &#x4E3B;&#x8981;&#x7528;&#x5728;&#x963B;&#x585E; IO&#xFF0C;&#x800C; Netty &#x662F;&#x975E;&#x963B;&#x585E; IO</li>
</ul>
<h3 id="&#x4F7F;&#x7528;"><a href="#&#x4F7F;&#x7528;" class="headerlink" title="&#x4F7F;&#x7528;"></a>&#x4F7F;&#x7528;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class TestParam {</span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        // SocketChannel 5s&#x5185;&#x672A;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x5C31;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        new Bootstrap().option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000);</span><br><span class="line">        </span><br><span class="line">        // ServerSocketChannel 5s&#x5185;&#x672A;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x5C31;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        new ServerBootstrap().option(ChannelOption.CONNECT_TIMEOUT_MILLIS,5000);</span><br><span class="line">        // SocketChannel 5s&#x5185;&#x672A;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x5C31;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        new ServerBootstrap().childOption(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8FC7; <code>Bootstrap.option</code> &#x51FD;&#x6570;&#x6765;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;<strong>&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x4F5C;&#x7528;&#x4E8E; SocketChannel</strong></li>
<li>&#x670D;&#x52A1;&#x5668;&#x901A;&#x8FC7;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang&#x590D;&#x5236;&#x4EE3;&#x7801;ServerBootstrap.</span><br></pre></td></tr></table></figure>

<p>&#x6765;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x4E0D;&#x540C;&#x7684; Channel &#x9700;&#x8981;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;</p>
<pre><code>+ &#x901A;&#x8FC7; `option` &#x6765;&#x914D;&#x7F6E; **ServerSocketChannel** &#x4E0A;&#x7684;&#x53C2;&#x6570;
+ &#x901A;&#x8FC7; `childOption` &#x6765;&#x914D;&#x7F6E; **SocketChannel** &#x4E0A;&#x7684;&#x53C2;&#x6570;</code></pre><h3 id="&#x6E90;&#x7801;&#x5206;&#x6790;"><a href="#&#x6E90;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x6E90;&#x7801;&#x5206;&#x6790;"></a>&#x6E90;&#x7801;&#x5206;&#x6790;</h3><p>&#x5BA2;&#x6237;&#x7AEF;&#x4E2D;&#x8FDE;&#x63A5;&#x670D;&#x52A1;&#x5668;&#x7684;&#x7EBF;&#x7A0B;&#x662F; NIO &#x7EBF;&#x7A0B;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x7684;&#x662F;&#x4E3B;&#x7EBF;&#x7A0B;&#x3002;&#x8FD9;&#x662F;&#x5982;&#x4F55;&#x505A;&#x5230;&#x8D85;&#x65F6;&#x5224;&#x65AD;&#x4EE5;&#x53CA;&#x7EBF;&#x7A0B;&#x901A;&#x4FE1;&#x7684;&#x5462;&#xFF1F;</p>
<p><code>AbstractNioChannel.AbstractNioUnsafe.connect</code>&#x65B9;&#x6CD5;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public final void connect(</span><br><span class="line">                final SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise) {</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    // Schedule connect timeout.</span><br><span class="line">    // &#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF0C;&#x901A;&#x8FC7;option&#x65B9;&#x6CD5;&#x4F20;&#x5165;&#x7684;CONNECT_TIMEOUT_MILLIS&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;</span><br><span class="line">    int connectTimeoutMillis = config().getConnectTimeoutMillis();</span><br><span class="line">    // &#x5982;&#x679C;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x5927;&#x4E8E;0</span><br><span class="line">    if (connectTimeoutMillis &gt; 0) {</span><br><span class="line">        // &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x5EF6;&#x65F6;connectTimeoutMillis&#xFF08;&#x8BBE;&#x7F6E;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x65F6;&#x95F4;&#xFF09;&#x540E;&#x6267;&#x884C;</span><br><span class="line">        // schedule(Runnable command, long delay, TimeUnit unit)</span><br><span class="line">        connectTimeoutFuture = eventLoop().schedule(new Runnable() {</span><br><span class="line">            @Override</span><br><span class="line">            public void run() {</span><br><span class="line">                // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;Promise&#x8FDB;&#x884C;NIO&#x7EBF;&#x7A0B;&#x4E0E;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x7684;&#x901A;&#x4FE1;</span><br><span class="line">                // &#x5982;&#x679C;&#x8D85;&#x65F6;&#xFF0C;&#x5219;&#x901A;&#x8FC7;tryFailure&#x65B9;&#x6CD5;&#x5C06;&#x5F02;&#x5E38;&#x653E;&#x5165;Promise&#x4E2D;</span><br><span class="line">                // &#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x629B;&#x51FA;</span><br><span class="line">                ChannelPromise connectPromise = AbstractNioChannel.this.connectPromise;</span><br><span class="line">                ConnectTimeoutException cause = new ConnectTimeoutException(&quot;connection timed out: &quot; + remoteAddress);</span><br><span class="line">                if (connectPromise != null &amp;&amp; connectPromise.tryFailure(cause)) {</span><br><span class="line">                    close(voidPromise());</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }, connectTimeoutMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">   	...</span><br><span class="line">        </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8D85;&#x65F6;&#x7684;&#x5224;&#x65AD;<strong>&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7; Eventloop &#x7684; schedule &#x65B9;&#x6CD5;&#x548C; Promise &#x5171;&#x540C;&#x5B9E;&#x73B0;&#x7684;</strong></p>
<ul>
<li>schedule &#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x5EF6;&#x8FDF;<code>connectTimeoutMillis</code>&#x79D2;&#x540E;&#x6267;&#x884C;&#x8BE5;&#x65B9;&#x6CD5;</li>
<li>&#x5982;&#x679C;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x5185;&#x6CA1;&#x6709;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x5219;&#x4F1A;&#x6267;&#x884C;&#x5176;&#x4E2D;&#x7684;&#x4EFB;&#x52A1;<ul>
<li>&#x4EFB;&#x52A1;&#x8D1F;&#x8D23;&#x521B;&#x5EFA; <code>ConnectTimeoutException</code> &#x5F02;&#x5E38;&#xFF0C;&#x5E76;&#x5C06;&#x5F02;&#x5E38;&#x901A;&#x8FC7; Pormise &#x4F20;&#x7ED9;&#x4E3B;&#x7EBF;&#x7A0B;&#x5E76;&#x629B;&#x51FA;</li>
</ul>
</li>
</ul>
<h2 id="SO-BACKLOG"><a href="#SO-BACKLOG" class="headerlink" title="SO_BACKLOG"></a>SO_BACKLOG</h2><p>&#x8BE5;&#x53C2;&#x6570;&#x662F; <strong>ServerSocketChannel</strong> &#x7684;&#x53C2;&#x6570;&#xFF0C;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;</p>
<h3 id="&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x4E0E;&#x8FDE;&#x63A5;&#x961F;&#x5217;"><a href="#&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x4E0E;&#x8FDE;&#x63A5;&#x961F;&#x5217;" class="headerlink" title="&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x4E0E;&#x8FDE;&#x63A5;&#x961F;&#x5217;"></a>&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x4E0E;&#x8FDE;&#x63A5;&#x961F;&#x5217;</h3><p>&#x7B2C;&#x4E00;&#x6B21;&#x63E1;&#x624B;&#x65F6;&#xFF0C;&#x56E0;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x8FDE;&#x63A5;&#x8FD8;&#x672A;&#x5B8C;&#x5168;&#x5EFA;&#x7ACB;&#xFF0C;&#x4E0E;&#x8FD9;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x4F1A;&#x88AB;&#x653E;&#x5165;<strong>&#x534A;&#x8FDE;&#x63A5;&#x961F;&#x5217;</strong>&#x4E2D;</p>
<p><a href="/external_links/a869857c32155cd0505951d6496c3f69.html" target="blank" rel="noopener"><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/715bfea3d88b357d826be446c6edbb7138c802cf6dfc009ec49bcfc1f318ebf5" alt="img"></a></p>
<p>&#x5F53;&#x5B8C;&#x6210;&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x4EE5;&#x540E;&#xFF0C;&#x8FDE;&#x63A5;&#x4F1A;&#x88AB;&#x653E;&#x5165;<strong>&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217;&#x4E2D;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/2d9a0a6f831d066d874707cbfc80b8401fb3237ef6504e89f50394e8cb74ef74" alt="img"></p>
<p>&#x670D;&#x52A1;&#x5668;&#x5904;&#x7406;Accept&#x4E8B;&#x4EF6;&#x662F;&#x5728;TCP&#x4E09;&#x6B21;&#x63E1;&#x624B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x4E4B;&#x540E;&#x3002;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x4ECE;&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217;&#x4E2D;&#x83B7;&#x53D6;&#x8FDE;&#x63A5;&#x5E76;&#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/f6505ca1b0c02ef433dd12992b0e6b942df9367515637a0a8328586809f66cfc" alt="img"></p>
<p>&#x5728; linux 2.2 &#x4E4B;&#x524D;&#xFF0C;backlog &#x5927;&#x5C0F;&#x5305;&#x62EC;&#x4E86;&#x4E24;&#x4E2A;&#x961F;&#x5217;&#x7684;&#x5927;&#x5C0F;&#xFF0C;<strong>&#x5728; linux 2.2 &#x4E4B;&#x540E;&#xFF0C;&#x5206;&#x522B;&#x7528;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x6765;&#x63A7;&#x5236;</strong></p>
<ul>
<li>&#x534A;&#x8FDE;&#x63A5;&#x961F;&#x5217; - sync queue<ul>
<li>&#x5927;&#x5C0F;&#x901A;&#x8FC7; /proc/sys/net/ipv4/tcp_max_syn_backlog &#x6307;&#x5B9A;&#xFF0C;&#x5728; <code>syncookies</code> &#x542F;&#x7528;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x903B;&#x8F91;&#x4E0A;&#x6CA1;&#x6709;&#x6700;&#x5927;&#x503C;&#x9650;&#x5236;&#xFF0C;&#x8FD9;&#x4E2A;&#x8BBE;&#x7F6E;&#x4FBF;&#x88AB;&#x5FFD;&#x7565;</li>
</ul>
</li>
<li>&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217; - accept queue<ul>
<li>&#x5176;&#x5927;&#x5C0F;&#x901A;&#x8FC7; /proc/sys/net/core/somaxconn &#x6307;&#x5B9A;&#xFF0C;&#x5728;&#x4F7F;&#x7528; listen &#x51FD;&#x6570;&#x65F6;&#xFF0C;<strong>&#x5185;&#x6838;&#x4F1A;&#x6839;&#x636E;&#x4F20;&#x5165;&#x7684; backlog &#x53C2;&#x6570;&#x4E0E;&#x7CFB;&#x7EDF;&#x53C2;&#x6570;&#xFF0C;&#x53D6;&#x4E8C;&#x8005;&#x7684;&#x8F83;&#x5C0F;&#x503C;</strong></li>
<li>&#x5982;&#x679C; accpet queue &#x961F;&#x5217;&#x6EE1;&#x4E86;&#xFF0C;server &#x5C06;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x62D2;&#x7EDD;&#x8FDE;&#x63A5;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x5230; client</li>
</ul>
</li>
</ul>
<h3 id="&#x4F5C;&#x7528;"><a href="#&#x4F5C;&#x7528;" class="headerlink" title="&#x4F5C;&#x7528;"></a>&#x4F5C;&#x7528;</h3><p>&#x5728;Netty&#x4E2D;&#xFF0C;<code>SO_BACKLOG</code>&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8BBE;&#x7F6E;&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217;&#x7684;&#x5927;&#x5C0F;&#x3002;<strong>&#x5F53;&#x5904;&#x7406;Accept&#x7684;&#x901F;&#x7387;&#x5C0F;&#x4E8E;&#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#x7684;&#x901F;&#x7387;&#x65F6;&#xFF0C;&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217;&#x4E2D;&#x5806;&#x79EF;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x5927;&#x4E8E;<code>SO_BACKLOG</code>&#x8BBE;&#x7F6E;&#x7684;&#x503C;&#x662F;&#xFF0C;&#x4FBF;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;</strong></p>
<p><strong>&#x8BBE;&#x7F6E;&#x65B9;&#x5F0F;&#x5982;&#x4E0B;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x8BBE;&#x7F6E;&#x5168;&#x8FDE;&#x63A5;&#x961F;&#x5217;&#xFF0C;&#x5927;&#x5C0F;&#x4E3A;2</span><br><span class="line">new ServerBootstrap().option(ChannelOption.SO_BACKLOG, 2);</span><br></pre></td></tr></table></figure>

<h3 id="&#x9ED8;&#x8BA4;&#x503C;"><a href="#&#x9ED8;&#x8BA4;&#x503C;" class="headerlink" title="&#x9ED8;&#x8BA4;&#x503C;"></a>&#x9ED8;&#x8BA4;&#x503C;</h3><p>backlog&#x53C2;&#x6570;&#x5728;<code>NioSocketChannel.doBind</code>&#x65B9;&#x6CD5;&#x88AB;&#x4F7F;&#x7528;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">protected void doBind(SocketAddress localAddress) throws Exception {</span><br><span class="line">    if (PlatformDependent.javaVersion() &gt;= 7) {</span><br><span class="line">        javaChannel().bind(localAddress, config.getBacklog());</span><br><span class="line">    } else {</span><br><span class="line">        javaChannel().socket().bind(localAddress, config.getBacklog());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5176;&#x4E2D;backlog&#x88AB;&#x4FDD;&#x5B58;&#x5728;&#x4E86;<code>DefaultServerSocketChannelConfig</code>&#x914D;&#x7F6E;&#x7C7B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;private volatile int backlog = NetUtil.SOMAXCONN;</span><br></pre></td></tr></table></figure>

<p>&#x5177;&#x4F53;&#x7684;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;SOMAXCONN = AccessController.doPrivileged(new PrivilegedAction&lt;Integer&gt;() {</span><br><span class="line">    @Override</span><br><span class="line">    public Integer run() {</span><br><span class="line">        // Determine the default somaxconn (server socket backlog) value of the platform.</span><br><span class="line">        // The known defaults:</span><br><span class="line">        // - Windows NT Server 4.0+: 200</span><br><span class="line">        // - Linux and Mac OS X: 128</span><br><span class="line">        int somaxconn = PlatformDependent.isWindows() ? 200 : 128;</span><br><span class="line">        File file = new File(&quot;/proc/sys/net/core/somaxconn&quot;);</span><br><span class="line">        BufferedReader in = null;</span><br><span class="line">        try {</span><br><span class="line">            // file.exists() may throw a SecurityException if a SecurityManager is used, so execute it in the</span><br><span class="line">            // try / catch block.</span><br><span class="line">            // See https://github.com/netty/netty/issues/4936</span><br><span class="line">            if (file.exists()) {</span><br><span class="line">                in = new BufferedReader(new FileReader(file));</span><br><span class="line">                // &#x5C06;somaxconn&#x8BBE;&#x7F6E;&#x4E3A;Linux&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;&#x7684;&#x503C;</span><br><span class="line">                somaxconn = Integer.parseInt(in.readLine());</span><br><span class="line">                if (logger.isDebugEnabled()) {</span><br><span class="line">                    logger.debug(&quot;{}: {}&quot;, file, somaxconn);</span><br><span class="line">                }</span><br><span class="line">            } else {</span><br><span class="line">                ...</span><br><span class="line">            }</span><br><span class="line">            ...</span><br><span class="line">        }  </span><br><span class="line">        // &#x8FD4;&#x56DE;backlog&#x7684;&#x503C;</span><br><span class="line">        return somaxconn;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>backlog&#x7684;&#x503C;&#x4F1A;&#x6839;&#x636E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x6765;</li>
</ul>
<p>&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x9ED8;&#x8BA4;&#x503C;</p>
<pre><code>+ Windows 200
+ Linux/Mac OS 128</code></pre><ul>
<li><strong>&#x5982;&#x679C;&#x914D;&#x7F6E;&#x6587;&#x4EF6;<code>/proc/sys/net/core/somaxconn</code>&#x5B58;&#x5728;</strong>&#xFF0C;&#x4F1A;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x5C06;backlog&#x7684;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6307;&#x5B9A;&#x7684;</li>
</ul>
<h2 id="TCP-NODELAY"><a href="#TCP-NODELAY" class="headerlink" title="TCP_NODELAY"></a>TCP_NODELAY</h2><ul>
<li>&#x5C5E;&#x4E8E; <strong>SocketChannal</strong> &#x53C2;&#x6570;</li>
<li>&#x56E0;&#x4E3A; Nagle &#x7B97;&#x6CD5;&#xFF0C;&#x6570;&#x636E;&#x5305;&#x4F1A;&#x5806;&#x79EF;&#x5230;&#x4E00;&#x5B9A;&#x7684;&#x6570;&#x91CF;&#x540E;&#x4E00;&#x8D77;&#x53D1;&#x9001;&#xFF0C;&#x8FD9;&#x5C31;<strong>&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x6570;&#x636E;&#x7684;&#x53D1;&#x9001;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x5EF6;&#x65F6;</strong></li>
<li><strong>&#x8BE5;&#x53C2;&#x6570;&#x9ED8;&#x8BA4;&#x4E3A;false</strong>&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5E0C;&#x671B;&#x7684;&#x53D1;&#x9001;&#x88AB;&#x5EF6;&#x65F6;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5C06;&#x8BE5;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;true</li>
</ul>
<h2 id="SO-SNDBUF-amp-SO-RCVBUF"><a href="#SO-SNDBUF-amp-SO-RCVBUF" class="headerlink" title="SO_SNDBUF &amp; SO_RCVBUF"></a>SO_SNDBUF &amp; SO_RCVBUF</h2><ul>
<li>SO_SNDBUF &#x5C5E;&#x4E8E; <strong>SocketChannal</strong> &#x53C2;&#x6570;</li>
<li>SO_RCVBUF <strong>&#x65E2;&#x53EF;&#x7528;&#x4E8E; SocketChannal &#x53C2;&#x6570;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;&#x4E8E; ServerSocketChannal &#x53C2;&#x6570;</strong>&#xFF08;&#x5EFA;&#x8BAE;&#x8BBE;&#x7F6E;&#x5230; ServerSocketChannal &#x4E0A;&#xFF09;</li>
<li>&#x8BE5;&#x53C2;&#x6570;&#x7528;&#x4E8E;<strong>&#x6307;&#x5B9A;&#x63A5;&#x6536;&#x65B9;&#x4E0E;&#x53D1;&#x9001;&#x65B9;&#x7684;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x5927;&#x5C0F;</strong>&#xFF0C;&#x4E0D;&#x8FC7;&#x4E0D;&#x5EFA;&#x8BAE;&#x53BB;&#x8C03;&#x6574;&#x8FD9;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x4E5F;&#x4E0D;&#x5E94;&#x8BE5;&#x8FC7;&#x5927;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x5360;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x7F13;&#x51B2;&#x533A;</li>
</ul>
<h2 id="ALLOCATOR"><a href="#ALLOCATOR" class="headerlink" title="ALLOCATOR"></a>ALLOCATOR</h2><ul>
<li>&#x5C5E;&#x4E8E; <strong>SocketChannal</strong> &#x53C2;&#x6570;</li>
<li>&#x7528;&#x6765;&#x914D;&#x7F6E; ByteBuf &#x662F;&#x6C60;&#x5316;&#x8FD8;&#x662F;&#x975E;&#x6C60;&#x5316;&#xFF0C;&#x662F;&#x76F4;&#x63A5;&#x5185;&#x5B58;&#x8FD8;&#x662F;&#x5806;&#x5185;&#x5B58;</li>
</ul>
<h3 id="&#x4F7F;&#x7528;-1"><a href="#&#x4F7F;&#x7528;-1" class="headerlink" title="&#x4F7F;&#x7528;"></a>&#x4F7F;&#x7528;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x9009;&#x62E9;ALLOCATOR&#x53C2;&#x6570;&#xFF0C;&#x8BBE;&#x7F6E;SocketChannel&#x4E2D;&#x5206;&#x914D;&#x7684;ByteBuf&#x7C7B;&#x578B;</span><br><span class="line">// &#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E00;&#x4E2A;ByteBufAllocator&#xFF0C;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x751F;&#x6210;&#x7684; ByteBuf &#x7684;&#x7C7B;&#x578B;</span><br><span class="line">new ServerBootstrap().childOption(ChannelOption.ALLOCATOR, new PooledByteBufAllocator());</span><br></pre></td></tr></table></figure>

<p><strong>ByteBufAllocator&#x7C7B;&#x578B;</strong></p>
<ul>
<li>&#x6C60;&#x5316;&#x5E76;&#x4F7F;&#x7528;&#x76F4;&#x63A5;&#x5185;&#x5B58;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;// true&#x8868;&#x793A;&#x4F7F;&#x7528;&#x76F4;&#x63A5;&#x5185;&#x5B58;</span><br><span class="line">new PooledByteBufAllocator(true);</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x6C60;&#x5316;&#x5E76;&#x4F7F;&#x7528;&#x5806;&#x5185;&#x5B58;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;// false&#x8868;&#x793A;&#x4F7F;&#x7528;&#x5806;&#x5185;&#x5B58;</span><br><span class="line">new PooledByteBufAllocator(false);</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x975E;&#x6C60;&#x5316;&#x5E76;&#x4F7F;&#x7528;&#x76F4;&#x63A5;&#x5185;&#x5B58;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;// ture&#x8868;&#x793A;&#x4F7F;&#x7528;&#x76F4;&#x63A5;&#x5185;&#x5B58;</span><br><span class="line">new UnpooledByteBufAllocator(true);</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x975E;&#x6C60;&#x5316;&#x5E76;&#x4F7F;&#x7528;&#x5806;&#x5185;&#x5B58;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;// false&#x8868;&#x793A;&#x4F7F;&#x7528;&#x5806;&#x5185;&#x5B58;</span><br><span class="line">new UnpooledByteBufAllocator(false);</span><br></pre></td></tr></table></figure>

<h2 id="RCVBUF-ALLOCATOR"><a href="#RCVBUF-ALLOCATOR" class="headerlink" title="RCVBUF_ALLOCATOR"></a>RCVBUF_ALLOCATOR</h2><ul>
<li>&#x5C5E;&#x4E8E; <strong>SocketChannal</strong> &#x53C2;&#x6570;</li>
<li><strong>&#x63A7;&#x5236; Netty &#x63A5;&#x6536;&#x7F13;&#x51B2;&#x533A;&#x5927;&#x5C0F;</strong></li>
<li>&#x8D1F;&#x8D23;&#x5165;&#x7AD9;&#x6570;&#x636E;&#x7684;&#x5206;&#x914D;&#xFF0C;&#x51B3;&#x5B9A;&#x5165;&#x7AD9;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;&#xFF08;&#x5E76;&#x53EF;&#x52A8;&#x6001;&#x8C03;&#x6574;&#xFF09;&#xFF0C;<strong>&#x7EDF;&#x4E00;&#x91C7;&#x7528; direct &#x76F4;&#x63A5;&#x5185;&#x5B58;</strong>&#xFF0C;&#x5177;&#x4F53;&#x6C60;&#x5316;&#x8FD8;&#x662F;&#x975E;&#x6C60;&#x5316;&#x7531; allocator &#x51B3;&#x5B9A;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/234ae2936177e9d26070c9c486c945ad.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../144/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../144/">144</a><span class="page-number current">145</span><a class="page-number" href="../146/">146</a><span class="space">&hellip;</span><a class="page-number" href="../399/">399</a><a class="extend next" rel="next" href="../146/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">3990</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1304</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
