<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/181/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/181/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7007289199904686094.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7007289199904686094.html" itemprop="url">完蛋，公司被一条 update 语句干趴了！</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-13T13:43:47+08:00">
                2021-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5927;&#x5BB6;&#x597D;&#xFF0C;&#x6211;&#x662F;&#x5C0F;&#x6797;&#x3002;</p>
<p>&#x6628;&#x665A;&#x5728;&#x7FA4;&#x5212;&#x6C34;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x770B;&#x5230;&#x6709;&#x4F4D;&#x8BFB;&#x8005;&#x8BF4;&#x4E86;&#x8FD9;&#x4E48;&#x4E00;&#x4EF6;&#x4E8B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/aa2380fc54c2eaf3e13e759bf7d4ed0fbde0716a9670839397573c2a04252aa0" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x5927;&#x6982;&#x5C31;&#x662F;&#xFF0C;&#x5728;&#x7EBF;&#x4E0A;&#x6267;&#x884C;&#x4E00;&#x6761; update &#x8BED;&#x53E5;&#x4FEE;&#x6539;&#x6570;&#x636E;&#x5E93;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;where &#x6761;&#x4EF6;&#x6CA1;&#x6709;&#x5E26;&#x4E0A;&#x7D22;&#x5F15;&#xFF0C;&#x5BFC;&#x81F4;&#x4E1A;&#x52A1;&#x76F4;&#x63A5;&#x5D29;&#x4E86;&#xFF0C;&#x88AB;&#x8001;&#x677F;&#x6559;&#x8BAD;&#x4E86;&#x4E00;&#x6CE2;</p>
<p>&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x770B;&#x770B;&#xFF1A;</p>
<ul>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x7684;&#x4E8B;&#x6545;&#xFF1F;</li>
<li>&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x4E8B;&#x6545;&#x7684;&#x53D1;&#x751F;&#xFF1F;</li>
</ul>
<p>&#x8BF4;&#x4E2A;&#x524D;&#x63D0;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8BF4;&#x7684;&#x6848;&#x4F8B;&#x90FD;&#x662F;&#x57FA;&#x4E8E; InnoDB &#x5B58;&#x50A8;&#x5F15;&#x64CE;&#xFF0C;&#x4E14;&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x662F;&#x53EF;&#x91CD;&#x590D;&#x8BFB;&#x3002;</p>
<h3 id="&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x7684;&#x4E8B;&#x6545;&#xFF1F;"><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x7684;&#x4E8B;&#x6545;&#xFF1F;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x7684;&#x4E8B;&#x6545;&#xFF1F;"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x7684;&#x4E8B;&#x6545;&#xFF1F;</h3><p>InnoDB &#x5B58;&#x50A8;&#x5F15;&#x64CE;&#x7684;&#x9ED8;&#x8BA4;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x662F;&#x300C;&#x53EF;&#x91CD;&#x590D;&#x8BFB;&#x300D;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x4E0B;&#xFF0C;&#x5728;&#x591A;&#x4E2A;&#x4E8B;&#x52A1;&#x5E76;&#x53D1;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x51FA;&#x73B0;&#x5E7B;&#x8BFB;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6240;&#x8C13;&#x7684;&#x5E7B;&#x8BFB;&#x662F;&#x6307;&#x5728;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#x4E0B;&#xFF0C;&#x8FDE;&#x7EED;&#x6267;&#x884C;&#x4E24;&#x6B21;&#x540C;&#x6837;&#x7684;&#x67E5;&#x8BE2;&#x8BED;&#x53E5;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x7684;&#x67E5;&#x8BE2;&#x8BED;&#x53E5;&#x53EF;&#x80FD;&#x4F1A;&#x8FD4;&#x56DE;&#x4E4B;&#x524D;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x884C;&#x3002;</p>
<p>&#x56E0;&#x6B64; InnoDB &#x5B58;&#x50A8;&#x5F15;&#x64CE;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x4E86;&#x884C;&#x9501;&#xFF0C;&#x901A;&#x8FC7; next-key &#x9501;&#xFF08;&#x8BB0;&#x5F55;&#x9501;&#x548C;&#x95F4;&#x9699;&#x9501;&#x7684;&#x7EC4;&#x5408;&#xFF09;&#x6765;&#x9501;&#x4F4F;&#x8BB0;&#x5F55;&#x672C;&#x8EAB;&#x548C;&#x8BB0;&#x5F55;&#x4E4B;&#x95F4;&#x7684;&#x201C;&#x95F4;&#x9699;&#x201D;&#xFF0C;&#x9632;&#x6B62;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x5728;&#x8FD9;&#x4E2A;&#x8BB0;&#x5F55;&#x4E4B;&#x95F4;&#x63D2;&#x5165;&#x65B0;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x4E86;&#x5E7B;&#x8BFB;&#x73B0;&#x8C61;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x6267;&#x884C; update &#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x4F1A;&#x5BF9;&#x8BB0;&#x5F55;&#x52A0;&#x72EC;&#x5360;&#x9501;&#xFF08;X &#x9501;&#xFF09;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x5BF9;&#x6301;&#x6709;&#x72EC;&#x5360;&#x9501;&#x7684;&#x8BB0;&#x5F55;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x65F6;&#x662F;&#x4F1A;&#x88AB;&#x963B;&#x585E;&#x7684;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x8FD9;&#x4E2A;&#x9501;&#x5E76;&#x4E0D;&#x662F;&#x6267;&#x884C;&#x5B8C; update &#x8BED;&#x53E5;&#x5C31;&#x4F1A;&#x91CA;&#x653E;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x4F1A;&#x7B49;&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#x65F6;&#x624D;&#x4F1A;&#x91CA;&#x653E;&#x3002;</p>
<p>&#x5728; InnoDB &#x4E8B;&#x52A1;&#x4E2D;&#xFF0C;&#x5BF9;&#x8BB0;&#x5F55;&#x52A0;&#x9501;&#x5E26;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#x662F; next-key &#x9501;&#xFF0C;&#x4F46;&#x662F;&#x4F1A;&#x56E0;&#x4E3A;&#x4E00;&#x4E9B;&#x6761;&#x4EF6;&#x4F1A;&#x9000;&#x5316;&#x6210;&#x95F4;&#x9699;&#x9501;&#xFF0C;&#x6216;&#x8005;&#x8BB0;&#x5F55;&#x9501;&#x3002;&#x52A0;&#x9501;&#x7684;&#x4F4D;&#x7F6E;&#x51C6;&#x786E;&#x7684;&#x8BF4;&#xFF0C;&#x9501;&#x662F;&#x52A0;&#x5728;&#x7D22;&#x5F15;&#x4E0A;&#x7684;&#x800C;&#x975E;&#x884C;&#x4E0A;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#xFF0C;&#x5728; update &#x8BED;&#x53E5;&#x7684; where &#x6761;&#x4EF6;&#x4F7F;&#x7528;&#x4E86;&#x552F;&#x4E00;&#x7D22;&#x5F15;&#xFF0C;&#x90A3;&#x4E48; next-key &#x9501;&#x4F1A;&#x9000;&#x5316;&#x6210;&#x8BB0;&#x5F55;&#x9501;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x53EA;&#x4F1A;&#x7ED9;&#x4E00;&#x884C;&#x8BB0;&#x5F55;&#x52A0;&#x9501;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x5F20;&#x6570;&#x636E;&#x5E93;&#x8868;&#xFF0C;&#x5176;&#x4E2D; id &#x4E3A;&#x4E3B;&#x952E;&#x7D22;&#x5F15;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/26194aacb4e98494bcba3ba3487d1206edb36c68343f48964c22182f22fdc633" alt></p>
<p>&#x5047;&#x8BBE;&#x6709;&#x4E24;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/d52e426e8893e2f690bb479b63a4919024f1af7a327ae681a764e3492ebfe6fe" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E8B;&#x52A1; A &#x7684; update &#x8BED;&#x53E5;&#x4E2D; where &#x662F;&#x7B49;&#x503C;&#x67E5;&#x8BE2;&#xFF0C;&#x5E76;&#x4E14; id &#x662F;&#x552F;&#x4E00;&#x7D22;&#x5F15;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x4F1A;&#x5BF9; id = 1 &#x8FD9;&#x6761;&#x8BB0;&#x5F55;&#x52A0;&#x9501;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x4E8B;&#x52A1; B &#x7684;&#x66F4;&#x65B0;&#x64CD;&#x4F5C;&#x5E76;&#x4E0D;&#x4F1A;&#x963B;&#x585E;&#x3002;</p>
<p>&#x4F46;&#x662F;&#xFF0C;<strong>&#x5728; update &#x8BED;&#x53E5;&#x7684; where &#x6761;&#x4EF6;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7D22;&#x5F15;&#xFF0C;&#x5C31;&#x4F1A;&#x5168;&#x8868;&#x626B;&#x63CF;&#xFF0C;&#x4E8E;&#x662F;&#x5C31;&#x4F1A;&#x5BF9;&#x6240;&#x6709;&#x8BB0;&#x5F55;&#x52A0;&#x4E0A; next-key &#x9501;&#xFF08;&#x8BB0;&#x5F55;&#x9501; + &#x95F4;&#x9699;&#x9501;&#xFF09;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x628A;&#x6574;&#x4E2A;&#x8868;&#x9501;&#x4F4F;&#x4E86;</strong>&#x3002;</p>
<p>&#x5047;&#x8BBE;&#x6709;&#x4E24;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/bebb798eecf9c2f820a8648091441db745ee5663167c3daf1b2f43f304382903" alt></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8FD9;&#x6B21;&#x4E8B;&#x52A1; B &#x7684; update &#x8BED;&#x53E5;&#x88AB;&#x963B;&#x585E;&#x4E86;&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x4E8B;&#x52A1; A&#x7684; update &#x8BED;&#x53E5;&#x4E2D; where &#x6761;&#x4EF6;&#x6CA1;&#x6709;&#x7D22;&#x5F15;&#x5217;&#xFF0C;&#x6240;&#x6709;&#x8BB0;&#x5F55;&#x90FD;&#x4F1A;&#x88AB;&#x52A0;&#x9501;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x6761; update &#x8BED;&#x53E5;&#x4EA7;&#x751F;&#x4E86; 4 &#x4E2A;&#x8BB0;&#x5F55;&#x9501;&#x548C; 5 &#x4E2A;&#x95F4;&#x9699;&#x9501;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x9501;&#x4F4F;&#x4E86;&#x5168;&#x8868;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/bc0f5eaab08f342af01883c0b4786d538d21417c449da1aed7c38c19b2c89f56" alt></p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x5F53;&#x5728;&#x6570;&#x636E;&#x91CF;&#x975E;&#x5E38;&#x5927;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8868;&#x6267;&#x884C; update &#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7D22;&#x5F15;&#xFF0C;&#x5C31;&#x4F1A;&#x7ED9;&#x5168;&#x8868;&#x7684;&#x52A0;&#x4E0A; next-key &#x9501;&#xFF0C; &#x90A3;&#x4E48;&#x9501;&#x5C31;&#x4F1A;&#x6301;&#x7EED;&#x5F88;&#x957F;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x76F4;&#x5230;&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#xFF0C;&#x800C;&#x8FD9;&#x671F;&#x95F4;&#x9664;&#x4E86; <code>select ... from</code> &#x8BED;&#x53E5;&#xFF0C;&#x5176;&#x4ED6;&#x8BED;&#x53E5;&#x90FD;&#x4F1A;&#x88AB;&#x9501;&#x4F4F;&#x4E0D;&#x80FD;&#x6267;&#x884C;&#xFF0C;&#x4E1A;&#x52A1;&#x4F1A;&#x56E0;&#x6B64;&#x505C;&#x6EDE;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7B49;&#x7740;&#x4F60;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x8001;&#x677F;&#x7684;&#x6328;&#x9A82;&#x3002;</p>
<p>&#x90A3; update &#x8BED;&#x53E5;&#x7684; where &#x5E26;&#x4E0A;&#x7D22;&#x5F15;&#x5C31;&#x80FD;&#x907F;&#x514D;&#x5168;&#x8868;&#x8BB0;&#x5F55;&#x52A0;&#x9501;&#x4E86;&#x5417;&#xFF1F;</p>
<p>&#x5E76;&#x4E0D;&#x662F;&#x3002;</p>
<p><strong>&#x5173;&#x952E;&#x8FD8;&#x5F97;&#x770B;&#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x5728;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x79CD;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x6700;&#x7EC8;&#x9009;&#x62E9;&#x7684;&#x662F;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#xFF0C;&#x8FD8;&#x662F;&#x5168;&#x8868;&#x626B;&#x63CF;&#xFF0C;&#x5982;&#x679C;&#x8D70;&#x4E86;&#x5168;&#x8868;&#x626B;&#x63CF;&#xFF0C;&#x5C31;&#x4F1A;&#x5BF9;&#x5168;&#x8868;&#x7684;&#x8BB0;&#x5F55;&#x52A0;&#x9501;&#x4E86;</strong>&#x3002;</p>
<h3 id="&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x4E8B;&#x6545;&#x7684;&#x53D1;&#x751F;&#xFF1F;"><a href="#&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x4E8B;&#x6545;&#x7684;&#x53D1;&#x751F;&#xFF1F;" class="headerlink" title="&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x4E8B;&#x6545;&#x7684;&#x53D1;&#x751F;&#xFF1F;"></a>&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x4E8B;&#x6545;&#x7684;&#x53D1;&#x751F;&#xFF1F;</h3><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06; MySQL &#x91CC;&#x7684; <code>sql_safe_updates</code> &#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x4E3A; 1&#xFF0C;&#x5F00;&#x542F;&#x5B89;&#x5168;&#x66F4;&#x65B0;&#x6A21;&#x5F0F;&#x3002;</p>
<blockquote>
<p>&#x5B98;&#x65B9;&#x7684;&#x89E3;&#x91CA;&#xFF1A;<br>If set to 1, MySQL aborts UPDATE or DELETE statements that do not use a key in the WHERE clause or a LIMIT clause. (Specifically, UPDATE statements must have a WHERE clause that uses a key or a LIMIT clause, or both. DELETE statements must have both.) This makes it possible to catch UPDATE or DELETE statements where keys are not used properly and that would probably change or delete a large number of rows. The default value is 0.</p>
</blockquote>
<p>&#x5927;&#x81F4;&#x7684;&#x610F;&#x601D;&#x662F;&#xFF0C;&#x5F53; sql_safe_updates &#x8BBE;&#x7F6E;&#x4E3A; 1 &#x65F6;&#x3002;</p>
<p>update &#x8BED;&#x53E5;&#x5FC5;&#x987B;&#x6EE1;&#x8DB3;&#x5982;&#x4E0B;&#x6761;&#x4EF6;&#x4E4B;&#x4E00;&#x624D;&#x80FD;&#x6267;&#x884C;&#x6210;&#x529F;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528; where&#xFF0C;&#x5E76;&#x4E14; where &#x6761;&#x4EF6;&#x4E2D;&#x5FC5;&#x987B;&#x6709;&#x7D22;&#x5F15;&#x5217;&#xFF1B;</li>
<li>&#x4F7F;&#x7528; limit&#xFF1B;</li>
<li>&#x540C;&#x65F6;&#x4F7F;&#x7528; where &#x548C; limit&#xFF0C;&#x6B64;&#x65F6; where &#x6761;&#x4EF6;&#x4E2D;&#x53EF;&#x4EE5;&#x6CA1;&#x6709;&#x7D22;&#x5F15;&#x5217;&#xFF1B;</li>
</ul>
<p>delete &#x8BED;&#x53E5;&#x5FC5;&#x987B;&#x6EE1;&#x8DB3;&#x5982;&#x4E0B;&#x6761;&#x4EF6;&#x4E4B;&#x4E00;&#x624D;&#x80FD;&#x6267;&#x884C;&#x6210;&#x529F;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528; where&#xFF0C;&#x5E76;&#x4E14; where &#x6761;&#x4EF6;&#x4E2D;&#x5FC5;&#x987B;&#x6709;&#x7D22;&#x5F15;&#x5217;&#xFF1B;</li>
<li>&#x540C;&#x65F6;&#x4F7F;&#x7528; where &#x548C; limit&#xFF0C;&#x6B64;&#x65F6; where &#x6761;&#x4EF6;&#x4E2D;&#x53EF;&#x4EE5;&#x6CA1;&#x6709;&#x7D22;&#x5F15;&#x5217;&#xFF1B;</li>
</ul>
<p>&#x5982;&#x679C; where &#x6761;&#x4EF6;&#x5E26;&#x4E0A;&#x4E86;&#x7D22;&#x5F15;&#x5217;&#xFF0C;&#x4F46;&#x662F;&#x4F18;&#x5316;&#x5668;&#x6700;&#x7EC8;&#x626B;&#x63CF;&#x9009;&#x62E9;&#x7684;&#x662F;&#x5168;&#x8868;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7D22;&#x5F15;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>force index([index_name])</code> &#x53EF;&#x4EE5;&#x544A;&#x8BC9;&#x4F18;&#x5316;&#x5668;&#x4F7F;&#x7528;&#x54EA;&#x4E2A;&#x7D22;&#x5F15;&#xFF0C;&#x4EE5;&#x6B64;&#x907F;&#x514D;&#x6709;&#x51E0;&#x7387;&#x9501;&#x5168;&#x8868;&#x5E26;&#x6765;&#x7684;&#x9690;&#x60A3;&#x3002;</p>
<h3 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h3><p>&#x4E0D;&#x8981;&#x5C0F;&#x770B;&#x4E00;&#x6761; update &#x8BED;&#x53E5;&#xFF0C;&#x5728;&#x751F;&#x4EA7;&#x673A;&#x4E0A;&#x4F7F;&#x7528;&#x4E0D;&#x5F53;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x4E1A;&#x52A1;&#x505C;&#x6EDE;&#xFF0C;&#x751A;&#x81F3;&#x5D29;&#x6E83;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8981;&#x6267;&#x884C; update &#x8BED;&#x53E5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x786E;&#x4FDD; where &#x6761;&#x4EF6;&#x4E2D;&#x5E26;&#x4E0A;&#x4E86;&#x7D22;&#x5F15;&#x5217;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x6D4B;&#x8BD5;&#x673A;&#x786E;&#x8BA4;&#x8BE5;&#x8BED;&#x53E5;&#x662F;&#x5426;&#x8D70;&#x7684;&#x662F;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#xFF0C;&#x9632;&#x6B62;&#x56E0;&#x4E3A;&#x626B;&#x63CF;&#x5168;&#x8868;&#xFF0C;&#x800C;&#x5BF9;&#x8868;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x8BB0;&#x5F55;&#x52A0;&#x4E0A;&#x9501;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6253;&#x5F00; MySQL sql_safe_updates &#x53C2;&#x6570;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x9884;&#x9632; update &#x64CD;&#x4F5C;&#x65F6; where &#x6761;&#x4EF6;&#x6CA1;&#x6709;&#x5E26;&#x4E0A;&#x7D22;&#x5F15;&#x5217;&#x3002;</p>
<p>&#x5982;&#x679C;&#x53D1;&#x73B0;&#x5373;&#x4F7F;&#x5728; where &#x6761;&#x4EF6;&#x4E2D;&#x5E26;&#x4E0A;&#x4E86;&#x5217;&#x7D22;&#x5F15;&#x5217;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x8D70;&#x7684;&#x8FD8;&#x662F;&#x5168;&#x6807;&#x626B;&#x63CF;&#xFF0C;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x5C31;&#x8981;&#x4F7F;&#x7528; <code>force index([index_name])</code> &#x53EF;&#x4EE5;&#x544A;&#x8BC9;&#x4F18;&#x5316;&#x5668;&#x4F7F;&#x7528;&#x54EA;&#x4E2A;&#x7D22;&#x5F15;&#x3002;</p>
<p>&#x8FD9;&#x6B21;&#x5C31;&#x8BF4;&#x5230;&#x8FD9;&#x5566;&#xFF0C;&#x4E0B;&#x6B21;&#x8981;&#x5C0F;&#x5FC3;&#x70B9;&#xFF0C;&#x522B;&#x518D;&#x88AB;&#x8001;&#x677F;&#x6328;&#x9A82;&#x5566;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/5f974c8874012edcebf852fd58d5df83.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7006821354397761543.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7006821354397761543.html" itemprop="url">Mac安装java opencv依赖并在intellij上配</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-12T07:46:44+08:00">
                2021-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x8FD1;&#x671F;&#x7533;&#x8BF7;&#x9A7E;&#x7167;&#x65F6;&#xFF0C;&#x60F3;&#x7740;&#x75AB;&#x60C5;&#x4E0D;&#x51FA;&#x95E8;&#x81EA;&#x5DF1;&#x62CD;&#x7167;PS&#x4E86;&#x4E00;&#x6CE2;&#xFF0C;&#x7ED3;&#x679C;&#x5E02;&#x653F;&#x5385;&#x5927;&#x59D0;&#x7528;&#x6807;&#x5C3A;&#x4E00;&#x91CF;&#x53D1;&#x73B0;p&#x7684;&#x51E0;&#x5F20;&#x7167;&#x7247;&#x8981;&#x4E0D;&#x5C31;&#x662F;&#x5934;&#x5927;&#x4E86;&#xFF0C;&#x8981;&#x4E0D;&#x5C31;&#x662F;&#x8863;&#x670D;&#x548C;&#x80CC;&#x666F;&#x989C;&#x8272;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x597D;&#x51E0;&#x5F20;&#x7167;&#x7247;&#x7ADF;&#x7136;&#x6CA1;&#x4E00;&#x5F20;&#x80FD;&#x7528;&#x7684;&#xFF0C;&#x65E0;&#x5948;&#x53EA;&#x80FD;&#x91CD;&#x6765;&#x4E00;&#x6B21;&#x3002;&#x75DB;&#x5B9A;&#x601D;&#x75DB;&#xFF0C;&#x51B3;&#x5B9A;&#x5F00;&#x4E00;&#x4E2A;&#x5C0F;&#x9879;&#x76EE;&#xFF0C;&#x6765;&#x81EA;&#x52A8;&#x5C06;&#x7EAF;&#x8272;&#x80CC;&#x666F;&#x7684;&#x5355;&#x4EBA;&#x7167;&#x8F93;&#x51FA;&#x6210;&#x7B26;&#x5408;&#x6807;&#x51C6;&#x7684;id&#x7167;&#x7247;&#x3002;</p>
<p>&#x8BF4;&#x641E;&#x5C31;&#x641E;&#xFF0C;&#x56E0;&#x4E3A;&#x540E;&#x7AEF;&#x6BD4;&#x8F83;&#x719F;&#x6089;Java&#x5C31;&#x51B3;&#x5B9A;&#x7528;Java&#x3002;&#xFF08;&#x5176;&#x5B9E;&#x56FE;&#x50CF;&#x5904;&#x7406;&#x76F8;&#x5173;&#x7684;&#x9879;&#x76EE;&#x7528;c++&#x5199;&#x5E94;&#x8BE5;&#x4F1A;&#x65B9;&#x4FBF;&#x5F88;&#x591A;&#xFF09;&#x90A3;&#x9996;&#x5148;&#x8981;&#x914D;&#x7F6E;&#x597D;&#x672C;&#x5730;&#x7528;java+opencv&#x7684;&#x73AF;&#x5883;&#x4E86;&#xFF0C;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x4E0B;&#x8F7D;&#x5B89;&#x88C5;opencv&#x7684;java&#x5305;&#x7136;&#x540E;&#x914D;&#x7F6E;&#x5230;intellij&#x4E0A;&#x3002;&#x4EE5;&#x4E0B;&#x662F;&#x5177;&#x4F53;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>Mac&#x4E0A;&#x9700;&#x5148;&#x5B89;&#x88C5;&#x547D;&#x4EE4;&#x5DE5;&#x5177;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;xcode-select&#xA0;--install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x5B89;&#x88C5;Ant&#xFF0C;&#x5FC5;&#x987B;&#x5B89;&#x88C5;&#xFF08;&#x4E4B;&#x524D;&#x81EA;&#x5DF1;&#x60F3;&#x7740;&#x7528;maven&#x8DF3;&#x8FC7;&#x4E86;&#xFF0C;&#x7ED3;&#x679C;&#x5BFC;&#x81F4;&#x6700;&#x7EC8;&#x6CA1;&#x6709;&#x751F;&#x6210;&#x9700;&#x8981;&#x7684;java&#x6587;&#x4EF6;&#x5939;&#xFF09;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;brew&#xA0;install&#xA0;ant</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>&#x63A5;&#x4E0B;&#x6765;&#x9700;&#x8981;&#x8FD0;&#x884C;<code>brew edit opencv</code>&#x5148;&#x4FEE;&#x6539;opnecv&#x7684;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#xFF0C; &#x5C06;<code>-DBUILD_opencv_java=OFF</code> &#x6539;&#x4E3A; <code>-DBUILD_opencv_java=ON</code>&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x4E4B;&#x540E;&#x751F;&#x6210;&#x9700;&#x8981;&#x7684;jar&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x5B89;&#x88C5;opencv&#xFF0C;&#x5982;&#x679C;&#x4E4B;&#x524D;&#x6709;&#x5B89;&#x88C5;&#x8FC7;&#x4F46;&#x662F;&#x6CA1;&#x6709;jar&#x6587;&#x4EF6;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x8FD0;&#x884C;<code>brew reinstall --build-from-source opencv</code>&#x6765;&#x91CD;&#x88C5;&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;brew&#xA0;install&#xA0;--build-from-source&#xA0;opencv</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>&#x5B89;&#x88C5;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x5728;<code>/usr/local/Cellar/opencv/4.5.3_2/share/java/opencv4</code>&#x4E0B;&#x4F1A;&#x6709;&#x4E24;&#x4E2A;&#x9700;&#x8981;&#x7684;&#x6587;&#x4EF6;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;libopencv_java453.dylib</span><br><span class="line">opencv-453.jar</span><br></pre></td></tr></table></figure>

<p>6.&#x5728;intellij&#x4E2D;&#x5C06;&#x4E0A;&#x9762;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;&#x914D;&#x7F6E;&#x4E3A;VM Options</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/a3283c5aafc7efc410540a50510d6fc0d510fe8240a6b8f6fa446a791ba857d1" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f059810fe5e2ca834181991cb973b5241fcc9a3d3a32387f5251ab00de8fb205" alt="image.png"></p>
<p>7.&#x5728;&#x9700;&#x8981;&#x4F7F;&#x7528;opencv api&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x52A0;&#x5165;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x4EE5;&#x52A0;&#x8F7D;opencv&#x6A21;&#x5757;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;System.loadLibrary(Core.NATIVE_LIBRARY_NAME);</span><br></pre></td></tr></table></figure>

<p>&#x5E38;&#x89C1;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>&#x914D;&#x7F6E;&#x5B8C;&#x540E;&#x8FD0;&#x884C;&#x62A5;&#x9519;[no opencv_java453 in java.library.path]&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x662F;jar&#x6587;&#x4EF6;&#x6CA1;&#x6709;&#x627E;&#x5230;&#xFF0C;&#x9700;&#x8981;&#x786E;&#x8BA4;&#x8DEF;&#x5F84;&#x914D;&#x7F6E;&#x6B63;&#x786E;&#xFF0C;&#x5E76;&#x4E14;&#x9700;&#x8981;&#x7684;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x5728;&#x76F8;&#x5E94;&#x8DEF;&#x5F84;&#x4E0B;</li>
<li>&#x914D;&#x7F6E;&#x5B8C;&#x6210;&#x540E;&#x9047;&#x5230;&#x62A5;&#x9519;UnsatisfiedLinkError: &#x2018;long org.opencv.imgcodecs.Imgcodecs.imread_1(java.lang.String)&#x2019;&#xFF0C;&#x4E4B;&#x4E2D;&#x60C5;&#x51B5;&#x662F;opencv&#x6A21;&#x5757;&#x6CA1;&#x6709;&#x52A0;&#x8F7D;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x6B63;&#x786E;&#x94FE;&#x63A5;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/7742c5db35eb562a74ad777876508431.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7006697028591829023.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7006697028591829023.html" itemprop="url">LeetCode【14、最长公共前缀】（简单）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-11T23:25:33+08:00">
                2021-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x9898;&#x76EE;&#x63CF;&#x8FF0;"><a href="#&#x9898;&#x76EE;&#x63CF;&#x8FF0;" class="headerlink" title="&#x9898;&#x76EE;&#x63CF;&#x8FF0;"></a>&#x9898;&#x76EE;&#x63CF;&#x8FF0;</h2><blockquote>
<p>&#x8FD9;&#x662F; <code>LeetCode</code> &#x4E0A;&#x7684; <a href="/external_links/606ccafc3d2f1383065df5022220c1a7.html" target="blank" rel="noopener">14. &#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;</a>&#xFF0C;&#x96BE;&#x5EA6;&#x4E3A; <strong>&#x7B80;&#x5355;</strong>&#x3002;</p>
<p>&#x5173;&#x952E;&#x5B57;&#xFF1A; <code>&#x5B57;&#x7B26;&#x4E32;</code></p>
</blockquote>
<p>&#x7F16;&#x5199;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x67E5;&#x627E;&#x5B57;&#x7B26;&#x4E32;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x516C;&#x5171;&#x524D;&#x7F00;&#xFF0C;&#x8FD4;&#x56DE;&#x7A7A;&#x5B57;&#x7B26;&#x4E32; <code>&quot;&quot;</code>&#x3002;</p>
<p><strong>&#x793A;&#x4F8B; 1&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;&#x8F93;&#x5165;&#xFF1A;strs = [&quot;flower&quot;,&quot;flow&quot;,&quot;flight&quot;]</span><br><span class="line">&#x8F93;&#x51FA;&#xFF1A;&quot;fl&quot;</span><br></pre></td></tr></table></figure>

<p><strong>&#x793A;&#x4F8B; 2&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;&#x8F93;&#x5165;&#xFF1A;strs = [&quot;dog&quot;,&quot;racecar&quot;,&quot;car&quot;]</span><br><span class="line">&#x8F93;&#x51FA;&#xFF1A;&quot;&quot;</span><br><span class="line">&#x89E3;&#x91CA;&#xFF1A;&#x8F93;&#x5165;&#x4E0D;&#x5B58;&#x5728;&#x516C;&#x5171;&#x524D;&#x7F00;&#x3002;</span><br></pre></td></tr></table></figure>

<p><strong>&#x63D0;&#x793A;&#xFF1A;</strong></p>
<ul>
<li><code>1 &lt;= strs.length &lt;= 200</code></li>
<li><code>0 &lt;= strs[i].length &lt;= 200</code></li>
<li><code>strs[i]</code> &#x4EC5;&#x7531;&#x5C0F;&#x5199;&#x82F1;&#x6587;&#x5B57;&#x6BCD;&#x7EC4;&#x6210;</li>
</ul>
<hr>
<h2 id="&#x5212;&#x91CD;&#x70B9;"><a href="#&#x5212;&#x91CD;&#x70B9;" class="headerlink" title="&#x5212;&#x91CD;&#x70B9;"></a>&#x5212;&#x91CD;&#x70B9;</h2><ol>
<li>&#x4E0D;&#x5B58;&#x5728;&#x8FD4;&#x56DE;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<hr>
<h2 id="&#x89E3;&#x9898;&#x601D;&#x8DEF;"><a href="#&#x89E3;&#x9898;&#x601D;&#x8DEF;" class="headerlink" title="&#x89E3;&#x9898;&#x601D;&#x8DEF;"></a>&#x89E3;&#x9898;&#x601D;&#x8DEF;</h2><h3 id="&#x65B9;&#x6CD5;1&#xFF1A;"><a href="#&#x65B9;&#x6CD5;1&#xFF1A;" class="headerlink" title="&#x65B9;&#x6CD5;1&#xFF1A;"></a>&#x65B9;&#x6CD5;1&#xFF1A;</h3><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x904D;&#x5386;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x6B21;&#x62FF;&#x5230;&#x4E24;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x83B7;&#x53D6;&#x516C;&#x5171;&#x524D;&#x7F00;&#xFF0C;&#x518D;&#x7528;&#x8FD9;&#x4E2A;&#x516C;&#x5171;&#x524D;&#x7F00;&#x4E0E;&#x4E0B;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x516C;&#x5171;&#x524D;&#x7F00;&#xFF0C;&#x4E00;&#x76F4;&#x5230;&#x6700;&#x540E;&#x5F97;&#x5230;&#x7684;&#x5C31;&#x662F;&#x6240;&#x6709;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;&#x3002;&#x4E00;&#x65E6;&#x6CA1;&#x6709;&#x516C;&#x5171;&#x524D;&#x7F00;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x7A7A;&#x3001;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x6BD4;&#x8F83;&#x540E;&#x9762;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;class Solution {</span><br><span class="line">    public String longestCommonPrefix(String[] strs) {</span><br><span class="line">        // &#x7279;&#x6B8A;&#x60C5;&#x51B5;&#x5224;&#x65AD;</span><br><span class="line">        int len = strs.length;</span><br><span class="line">        String first = strs[0];</span><br><span class="line">        if (len == 1) {</span><br><span class="line">            return first;</span><br><span class="line">        }</span><br><span class="line">        // &#x5B9A;&#x4E49;&#x6700;&#x5C0F;&#x516C;&#x5171;&#x524D;&#x7F00;</span><br><span class="line">        String ans = first;</span><br><span class="line">        for (int i = 1; i &lt; len; i++) {</span><br><span class="line">            ans = getPrefix(ans, strs[i]);</span><br><span class="line">            if (ans.length() == 0) {</span><br><span class="line">                break;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return ans;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public String getPrefix(String s1, String s2) {</span><br><span class="line">        int len = Math.min(s1.length(), s2.length());</span><br><span class="line">        int index = 0;</span><br><span class="line">        while (index &lt; len &amp;&amp; s1.charAt(index) == s2.charAt(index)) {</span><br><span class="line">            ++index;</span><br><span class="line">        }</span><br><span class="line">        return s1.substring(0, index);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#xFF1A;O(mn)</li>
<li>&#x7A7A;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#xFF1A;O(1)</li>
</ul>
<h3 id="&#x65B9;&#x6CD5;2&#xFF1A;"><a href="#&#x65B9;&#x6CD5;2&#xFF1A;" class="headerlink" title="&#x65B9;&#x6CD5;2&#xFF1A;"></a>&#x65B9;&#x6CD5;2&#xFF1A;</h3><p>&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x53D6;&#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x770B;&#x4F5C;&#x4E00;&#x4E2A;&#x4E8C;&#x7EF4;&#x7684;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x3002;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x540C;&#x4E00;&#x4F4D;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;&#x5982;&#x679C;&#x90FD;&#x76F8;&#x540C;&#x5219;&#x6DFB;&#x52A0;&#x8BE5;&#x5B57;&#x7B26;&#x5230;&#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;&#x4E2D;&#xFF0C;&#x4E00;&#x65E6;&#x6709;&#x4E00;&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;class Solution {</span><br><span class="line">    public String longestCommonPrefix(String[] strs) {</span><br><span class="line">        String ans = &quot;&quot;;</span><br><span class="line">        int len = strs.length;</span><br><span class="line">        String first = strs[0];</span><br><span class="line">        if (len == 1) {</span><br><span class="line">            return first;</span><br><span class="line">        }</span><br><span class="line">        for (int i = 0; i &lt; 200; i++) {</span><br><span class="line">            // &#x5224;&#x65AD;&#x5F53;&#x524D;&#x904D;&#x5386;&#x7684;&#x4F4D;&#x6570;&#x662F;&#x4E0D;&#x662F;&#x8D85;&#x8FC7;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x8D85;&#x8FC7;&#x6216;&#x8005;&#x6B63;&#x597D;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">            if (i &gt;= first.length()) {</span><br><span class="line">                return ans;</span><br><span class="line">            }</span><br><span class="line">            // &#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x6240;&#x7684;&#x904D;&#x5386;&#x5230;&#x7684;&#x4F4D;&#x7684;&#x503C;</span><br><span class="line">            char c = first.charAt(i);</span><br><span class="line">            for (int j = 1; j &lt; len; j++) {</span><br><span class="line">                // &#x8D85;&#x51FA;&#x957F;&#x5EA6;&#x6216;&#x8005;&#x548C;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x4E0D;&#x540C;&#x5219;&#x8FD4;&#x56DE;</span><br><span class="line">                if (i &gt;= strs[j].length() || strs[j].charAt(i) != c) {</span><br><span class="line">                    return ans;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            // &#x7B26;&#x5408;&#x6761;&#x4EF6;&#x5219;&#x5C06;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x62FC;&#x5230;&#x6700;&#x957F;&#x516C;&#x5171;&#x524D;&#x7F00;</span><br><span class="line">            ans += String.valueOf(c);</span><br><span class="line">        }</span><br><span class="line">        return ans;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#xFF1A;O(mn)</li>
<li>&#x7A7A;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#xFF1A;O(1)</li>
</ul>
<hr>
<h2 id="&#x5F15;&#x7528;"><a href="#&#x5F15;&#x7528;" class="headerlink" title="&#x5F15;&#x7528;"></a>&#x5F15;&#x7528;</h2><p>&#x6211;&#x7684; <code>github</code> &#x4ED3;&#x5E93;&#x5DF2;&#x7ECF;&#x540C;&#x6B65;&#x5EFA;&#x7ACB;&#xFF0C;<a href="/external_links/1c31795387df74fe29f465c337368b04.html" target="blank" rel="noopener">&#x70B9;&#x51FB;&#x8BBF;&#x95EE;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/9bf7c1e3f5fadbfa4591f7b141f697c2.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7005944458734731294.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7005944458734731294.html" itemprop="url">prometheus告警规则管理 什么是Rule</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-09T22:45:34+08:00">
                2021-09-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x5FAE;&#x578B;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x8FD0;&#x7EF4;&#x5F00;&#x53D1;&#x6545;&#x4E8B;&#xFF0C;&#x4F5C;&#x8005;&#xFF1A;&#x590F;&#x8001;&#x5E08;</p>
</blockquote>
<h1 id="&#x4EC0;&#x4E48;&#x662F;Rule"><a href="#&#x4EC0;&#x4E48;&#x662F;Rule" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F;Rule"></a>&#x4EC0;&#x4E48;&#x662F;Rule</h1><p>Prometheus&#x652F;&#x6301;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;Rule&#x89C4;&#x5219;&#x3002; Rule&#x5206;&#x4E3A;&#x4E24;&#x7C7B;&#xFF0C;&#x4E00;&#x7C7B;&#x662F;Recording Rule&#xFF0C;&#x53E6;&#x4E00;&#x7C7B;&#x662F;Alerting Rule&#x3002;Recording Rule&#x7684;&#x4E3B;&#x8981;&#x76EE;&#x7684;&#x662F;&#x901A;&#x8FC7;PromQL&#x53EF;&#x4EE5;&#x5B9E;&#x65F6;&#x5BF9;Prometheus&#x4E2D;&#x91C7;&#x96C6;&#x5230;&#x7684;&#x6837;&#x672C;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#xFF0C;&#x805A;&#x5408;&#x4EE5;&#x53CA;&#x5176;&#x5B83;&#x5404;&#x79CD;&#x8FD0;&#x7B97;&#x64CD;&#x4F5C;&#x3002;&#x800C;&#x5728;&#x67D0;&#x4E9B;PromQL&#x8F83;&#x4E3A;&#x590D;&#x6742;&#x4E14;&#x8BA1;&#x7B97;&#x91CF;&#x8F83;&#x5927;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;PromQL&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;Prometheus&#x54CD;&#x5E94;&#x8D85;&#x65F6;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x8FD9;&#x65F6;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x80FD;&#x591F;&#x7C7B;&#x4F3C;&#x4E8E;&#x540E;&#x53F0;&#x6279;&#x5904;&#x7406;&#x7684;&#x673A;&#x5236;&#x80FD;&#x591F;&#x5728;&#x540E;&#x53F0;&#x5B8C;&#x6210;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x8FD0;&#x7B97;&#x7684;&#x8BA1;&#x7B97;&#xFF0C;&#x5BF9;&#x4E8E;&#x4F7F;&#x7528;&#x8005;&#x800C;&#x8A00;&#x53EA;&#x9700;&#x8981;&#x67E5;&#x8BE2;&#x8FD9;&#x4E9B;&#x8FD0;&#x7B97;&#x7ED3;&#x679C;&#x5373;&#x53EF;&#x3002;Prometheus&#x901A;&#x8FC7;Recoding Rule&#x89C4;&#x5219;&#x652F;&#x6301;&#x8FD9;&#x79CD;&#x540E;&#x53F0;&#x8BA1;&#x7B97;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5BF9;&#x590D;&#x6742;&#x67E5;&#x8BE2;&#x7684;&#x6027;&#x80FD;&#x4F18;&#x5316;&#xFF0C;&#x63D0;&#x9AD8;&#x67E5;&#x8BE2;&#x6548;&#x7387;&#x3002;&#x4ECA;&#x5929;&#x4E3B;&#x8981;&#x5E26;&#x6765;&#x544A;&#x8B66;&#x7684;&#x5206;&#x6790;&#x3002;Prometheus&#x4E2D;&#x7684;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x5141;&#x8BB8;&#x4F60;&#x57FA;&#x4E8E;PromQL&#x8868;&#x8FBE;&#x5F0F;&#x5B9A;&#x4E49;&#x544A;&#x8B66;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#xFF0C;Prometheus&#x540E;&#x7AEF;&#x5BF9;&#x8FD9;&#x4E9B;&#x89E6;&#x53D1;&#x89C4;&#x5219;&#x8FDB;&#x884C;&#x5468;&#x671F;&#x6027;&#x8BA1;&#x7B97;&#xFF0C;&#x5F53;&#x6EE1;&#x8DB3;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#x540E;&#x5219;&#x4F1A;&#x89E6;&#x53D1;&#x544A;&#x8B66;&#x901A;&#x77E5;&#x3002;</p>
<h2 id="&#x4EC0;&#x4E48;&#x662F;&#x544A;&#x8B66;Rule"><a href="#&#x4EC0;&#x4E48;&#x662F;&#x544A;&#x8B66;Rule" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F;&#x544A;&#x8B66;Rule"></a>&#x4EC0;&#x4E48;&#x662F;&#x544A;&#x8B66;Rule</h2><p>&#x544A;&#x8B66;&#x662F;prometheus&#x7684;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x529F;&#x80FD;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x4ECE;&#x6E90;&#x7801;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x5206;&#x6790;&#x4E0B;&#x544A;&#x8B66;&#x7684;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#x3002;</p>
<h3 id="&#x600E;&#x4E48;&#x5B9A;&#x4E49;&#x544A;&#x8B66;Rule"><a href="#&#x600E;&#x4E48;&#x5B9A;&#x4E49;&#x544A;&#x8B66;Rule" class="headerlink" title="&#x600E;&#x4E48;&#x5B9A;&#x4E49;&#x544A;&#x8B66;Rule"></a>&#x600E;&#x4E48;&#x5B9A;&#x4E49;&#x544A;&#x8B66;Rule</h3><p>&#x4E00;&#x6761;&#x5178;&#x578B;&#x7684;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line">  - alert: HighErrorRate</span><br><span class="line">    #&#x6307;&#x6807;&#x9700;&#x8981;&#x5728;&#x89E6;&#x53D1;&#x544A;&#x8B66;&#x4E4B;&#x524D;&#x7684;10&#x5206;&#x949F;&#x5185;&#x5927;&#x4E8E;0.5&#x3002;</span><br><span class="line">    expr: job:request_latency_seconds:mean5m{job=&quot;myjob&quot;} &gt; 0.5</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: High request latency</span><br><span class="line">      description: description info</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x4E00;&#x7EC4;&#x76F8;&#x5173;&#x7684;&#x89C4;&#x5219;&#x8BBE;&#x7F6E;&#x5B9A;&#x4E49;&#x5728;&#x4E00;&#x4E2A;group&#x4E0B;&#x3002;&#x5728;&#x6BCF;&#x4E00;&#x4E2A;group&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x591A;&#x4E2A;&#x544A;&#x8B66;&#x89C4;&#x5219;(rule)&#x3002;&#x4E00;&#x6761;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x4E3B;&#x8981;&#x7531;&#x4EE5;&#x4E0B;&#x51E0;&#x90E8;&#x5206;&#x7EC4;&#x6210;&#xFF1A;</p>
<ul>
<li>alert&#xFF1A;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x7684;&#x540D;&#x79F0;&#x3002;</li>
<li>expr&#xFF1A;&#x57FA;&#x4E8E;PromQL&#x8868;&#x8FBE;&#x5F0F;&#x544A;&#x8B66;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#xFF0C;&#x7528;&#x4E8E;&#x8BA1;&#x7B97;&#x662F;&#x5426;&#x6709;&#x65F6;&#x95F4;&#x5E8F;&#x5217;&#x6EE1;&#x8DB3;&#x8BE5;&#x6761;&#x4EF6;&#x3002;</li>
<li>for&#xFF1A;&#x8BC4;&#x4F30;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#xFF0C;&#x53EF;&#x9009;&#x53C2;&#x6570;&#x3002;&#x7528;&#x4E8E;&#x8868;&#x793A;&#x53EA;&#x6709;&#x5F53;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#x6301;&#x7EED;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#x624D;&#x53D1;&#x9001;&#x544A;&#x8B66;&#x3002;&#x5728;&#x7B49;&#x5F85;&#x671F;&#x95F4;&#x65B0;&#x4EA7;&#x751F;&#x544A;&#x8B66;&#x7684;&#x72B6;&#x6001;&#x4E3A;pending&#x3002;</li>
<li>labels&#xFF1A;&#x81EA;&#x5B9A;&#x4E49;&#x6807;&#x7B7E;&#xFF0C;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x6307;&#x5B9A;&#x8981;&#x9644;&#x52A0;&#x5230;&#x544A;&#x8B66;&#x4E0A;&#x7684;&#x4E00;&#x7EC4;&#x9644;&#x52A0;&#x6807;&#x7B7E;&#x3002;</li>
<li>annotations&#xFF1A;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x4E00;&#x7EC4;&#x9644;&#x52A0;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x5982;&#x7528;&#x4E8E;&#x63CF;&#x8FF0;&#x544A;&#x8B66;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x7684;&#x6587;&#x5B57;&#x7B49;&#xFF0C;annotations&#x7684;&#x5185;&#x5BB9;&#x5728;&#x544A;&#x8B66;&#x4EA7;&#x751F;&#x65F6;&#x4F1A;&#x4E00;&#x540C;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x53D1;&#x9001;&#x5230;Alertmanager&#x3002;</li>
</ul>
<h3 id="Rule&#x7BA1;&#x7406;&#x5668;"><a href="#Rule&#x7BA1;&#x7406;&#x5668;" class="headerlink" title="Rule&#x7BA1;&#x7406;&#x5668;"></a>Rule&#x7BA1;&#x7406;&#x5668;</h3><p>&#x89C4;&#x5219;&#x7BA1;&#x7406;&#x5668;&#x4F1A;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x57FA;&#x4E8E;&#x89C4;&#x5219;PromQL&#x8868;&#x8FBE;&#x5F0F;&#x544A;&#x8B66;&#x7684;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#xFF0C;&#x7528;&#x4E8E;&#x8BA1;&#x7B97;&#x662F;&#x5426;&#x6709;&#x65F6;&#x95F4;&#x5E8F;&#x5217;&#x6EE1;&#x8DB3;&#x8BE5;&#x6761;&#x4EF6;&#x3002;&#x5728;&#x6EE1;&#x8DB3;&#x6539;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x5C06;&#x544A;&#x8B66;&#x4FE1;&#x606F;&#x53D1;&#x9001;&#x7ED9;&#x544A;&#x8B66;&#x670D;&#x52A1;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;type Manager struct {</span><br><span class="line">	opts     *ManagerOptions //&#x5916;&#x90E8;&#x7684;&#x4F9D;&#x8D56;</span><br><span class="line">	groups   map[string]*Group //&#x5F53;&#x524D;&#x7684;&#x89C4;&#x5219;&#x7EC4;</span><br><span class="line">	mtx      sync.RWMutex //&#x89C4;&#x5219;&#x7BA1;&#x7406;&#x5668;&#x8BFB;&#x5199;&#x9501;</span><br><span class="line">	block    chan struct{} </span><br><span class="line">	done     chan struct{} </span><br><span class="line">	restored bool </span><br><span class="line"></span><br><span class="line">	logger log.Logger </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>opts&#xFF08;*ManagerOptions&#x7C7B;&#x578B;&#xFF09;&#xFF1A;&#x8BB0;&#x5F55;&#x4E86;Manager&#x5B9E;&#x4F8B;&#x4F7F;&#x7528;&#x5230;&#x7684;&#x5176;&#x4ED6;&#x6A21;&#x5757;&#xFF0C;&#x4F8B;&#x5982;storage&#x6A21;&#x5757;&#x3001;notify&#x6A21;&#x5757;&#x7B49;&#x3002;</li>
<li>groups&#xFF08;map[string]*Group&#x7C7B;&#x578B;&#xFF09;&#xFF1A;&#x8BB0;&#x5F55;&#x4E86;&#x6240;&#x6709;&#x7684;rules.Group&#x5B9E;&#x4F8B;&#xFF0C;&#x5176;&#x4E2D;key&#x7531;rules.Group&#x7684;&#x540D;&#x79F0;&#x53CA;&#x5176;&#x6240;&#x5728;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6784;&#x6210;&#x3002;</li>
<li>mtx&#xFF08;sync.RWMutex&#x7C7B;&#x578B;&#xFF09;&#xFF1A;&#x5728;&#x8BFB;&#x5199;groups&#x5B57;&#x6BB5;&#x65F6;&#x90FD;&#x9700;&#x8981;&#x83B7;&#x53D6;&#x8BE5;&#x9501;&#x8FDB;&#x884C;&#x540C;&#x6B65;&#x3002;</li>
</ul>
<h3 id="&#x8BFB;&#x53D6;Rule&#x7EC4;&#x914D;&#x7F6E;"><a href="#&#x8BFB;&#x53D6;Rule&#x7EC4;&#x914D;&#x7F6E;" class="headerlink" title="&#x8BFB;&#x53D6;Rule&#x7EC4;&#x914D;&#x7F6E;"></a>&#x8BFB;&#x53D6;Rule&#x7EC4;&#x914D;&#x7F6E;</h3><p>&#x5728;Prometheus Server&#x542F;&#x52A8;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x4F1A;&#x8C03;&#x7528;Manager.Update&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#x52A0;&#x8F7D;Rule&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5E76;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x5176;&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x3002;</p>
<ul>
<li>&#x8C03;&#x7528;Manager.LoadGroups&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#x52A0;&#x8F7D;&#x5E76;&#x89E3;&#x6790;Rule&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x6700;&#x7EC8;&#x5F97;&#x5230;rules.Group&#x5B9E;&#x4F8B;&#x96C6;&#x5408;&#x3002;</li>
<li>&#x505C;&#x6B62;&#x539F;&#x6709;&#x7684;rules.Group&#x5B9E;&#x4F8B;&#xFF0C;&#x542F;&#x52A8;&#x65B0;&#x7684;rules.Group&#x5B9E;&#x4F8B;&#x3002;&#x5176;&#x4E2D;&#x4F1A;&#x4E3A;&#x6BCF;&#x4E2A;rules.Group&#x5B9E;&#x4F8B;&#x542F;&#x52A8;&#x4E00;&#x4E2A;goroutine&#xFF0C;&#x5B83;&#x4F1A;&#x5173;&#x8054;rules.Group&#x5B9E;&#x4F8B;&#x4E0B;&#x7684;&#x5168;&#x90E8;PromQL&#x67E5;&#x8BE2;&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;func (m *Manager) Update(interval time.Duration, files []string, externalLabels labels.Labels, externalURL string) error {</span><br><span class="line">	m.mtx.Lock()</span><br><span class="line">	defer m.mtx.Unlock()</span><br><span class="line">    // &#x4ECE;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x4E2D;&#x52A0;&#x8F7D;&#x89C4;&#x5219;</span><br><span class="line">	groups, errs := m.LoadGroups(interval, externalLabels, externalURL, files...)</span><br><span class="line">	if errs != nil {</span><br><span class="line">		for _, e := range errs {</span><br><span class="line">			level.Error(m.logger).Log(&quot;msg&quot;, &quot;loading groups failed&quot;, &quot;err&quot;, e)</span><br><span class="line">		}</span><br><span class="line">		return errors.New(&quot;error loading rules, previous rule set restored&quot;)</span><br><span class="line">	}</span><br><span class="line">	m.restored = true</span><br><span class="line"></span><br><span class="line">	var wg sync.WaitGroup</span><br><span class="line">    //&#x5FAA;&#x73AF;&#x904D;&#x5386;&#x89C4;&#x5219;&#x7EC4;</span><br><span class="line">	for _, newg := range groups {</span><br><span class="line">		// If there is an old group with the same identifier,</span><br><span class="line">		// check if new group equals with the old group, if yes then skip it.</span><br><span class="line">		// If not equals, stop it and wait for it to finish the current iteration.</span><br><span class="line">		// Then copy it into the new group.</span><br><span class="line">        //&#x6839;&#x636E;&#x65B0;&#x7684;rules.Group&#x7684;&#x4FE1;&#x606F;&#x83B7;&#x53D6;&#x89C4;&#x5219;&#x7EC4;&#x540D;</span><br><span class="line">		gn := GroupKey(newg.file, newg.name)</span><br><span class="line">        //&#x6839;&#x636E;&#x89C4;&#x5219;&#x7EC4;&#x540D;&#x83B7;&#x53D6;&#x5230;&#x8001;&#x7684;&#x89C4;&#x5219;&#x7EC4;&#x5E76;&#x5220;&#x9664;&#x539F;&#x6709;&#x7684;rules.Group&#x5B9E;&#x4F8B;</span><br><span class="line">		oldg, ok := m.groups[gn]</span><br><span class="line">		delete(m.groups, gn)</span><br><span class="line"></span><br><span class="line">		if ok &amp;&amp; oldg.Equals(newg) {</span><br><span class="line">			groups[gn] = oldg</span><br><span class="line">			continue</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		wg.Add(1)</span><br><span class="line">        //&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;rules.Group&#x5B9E;&#x4F8B;&#x542F;&#x52A8;&#x4E00;&#x4E2A;goroutine</span><br><span class="line">		go func(newg *Group) {</span><br><span class="line">			if ok {</span><br><span class="line">				oldg.stop()</span><br><span class="line">                //&#x5C06;&#x8001;&#x7684;&#x89C4;&#x5219;&#x7EC4;&#x4E2D;&#x7684;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x590D;&#x5236;&#x5230;&#x65B0;&#x7684;&#x89C4;&#x5219;&#x7EC4;</span><br><span class="line">				newg.CopyState(oldg)</span><br><span class="line">			}</span><br><span class="line">			wg.Done()</span><br><span class="line">			// Wait with starting evaluation until the rule manager</span><br><span class="line">			// is told to run. This is necessary to avoid running</span><br><span class="line">			// queries against a bootstrapping storage.</span><br><span class="line">			&lt;-m.block</span><br><span class="line">            //&#x8C03;&#x7528;rules.Group.run()&#x65B9;&#x6CD5;&#xFF0C;&#x5F00;&#x59CB;&#x5468;&#x671F;&#x6027;&#x7684;&#x6267;&#x884C;PromQl&#x8BED;&#x53E5;</span><br><span class="line">			newg.run(m.opts.Context)</span><br><span class="line">		}(newg)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	// Stop remaining old groups.</span><br><span class="line">    //&#x505C;&#x6B62;&#x6240;&#x6709;&#x8001;&#x89C4;&#x5219;&#x7EC4;&#x7684;&#x670D;&#x52A1;</span><br><span class="line">	wg.Add(len(m.groups))</span><br><span class="line">	for n, oldg := range m.groups {</span><br><span class="line">		go func(n string, g *Group) {</span><br><span class="line">			g.markStale = true</span><br><span class="line">			g.stop()</span><br><span class="line">			if m := g.metrics; m != nil {</span><br><span class="line">				m.IterationsMissed.DeleteLabelValues(n)</span><br><span class="line">				m.IterationsScheduled.DeleteLabelValues(n)</span><br><span class="line">				m.EvalTotal.DeleteLabelValues(n)</span><br><span class="line">				m.EvalFailures.DeleteLabelValues(n)</span><br><span class="line">				m.GroupInterval.DeleteLabelValues(n)</span><br><span class="line">				m.GroupLastEvalTime.DeleteLabelValues(n)</span><br><span class="line">				m.GroupLastDuration.DeleteLabelValues(n)</span><br><span class="line">				m.GroupRules.DeleteLabelValues(n)</span><br><span class="line">				m.GroupSamples.DeleteLabelValues((n))</span><br><span class="line">			}</span><br><span class="line">			wg.Done()</span><br><span class="line">		}(n, oldg)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">    //&#x66F4;&#x65B0;&#x89C4;&#x5219;&#x7BA1;&#x7406;&#x5668;&#x4E2D;&#x7684;&#x89C4;&#x5219;&#x7EC4;</span><br><span class="line">	m.groups = groups </span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x8FD0;&#x884C;Rule&#x7EC4;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;"><a href="#&#x8FD0;&#x884C;Rule&#x7EC4;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;" class="headerlink" title="&#x8FD0;&#x884C;Rule&#x7EC4;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;"></a>&#x8FD0;&#x884C;Rule&#x7EC4;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;</h3><p>&#x89C4;&#x5219;&#x7EC4;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF08;Group.run&#xFF09;&#xFF1A;&#x8FDB;&#x5165;Group.run&#x65B9;&#x6CD5;&#x540E;&#x5148;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x7B49;&#x5F85;&#xFF0C;&#x4EE5;&#x4F7F;&#x89C4;&#x5219;&#x7684;&#x8FD0;&#x7B97;&#x65F6;&#x95F4;&#x5728;&#x540C;&#x4E00;&#x65F6;&#x523B;&#xFF0C;&#x5468;&#x671F;&#x4E3A;g.interval;&#x7136;&#x540E;&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;&#xFF1A;iter&#xFF0C;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x4E3A;g.interval&#xFF1B;&#x5728;iter&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;g.Eval&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x5C42;&#x6B21;&#x7684;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x8C03;&#x5EA6;&#x3002;<br>&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x7684;&#x8C03;&#x5EA6;&#x5468;&#x671F;g.interval&#x6709;prometheus.yml&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;global&#x4E2D;&#x7684; [ evaluation_interval: | default = 1m ]&#x6307;&#x5B9A;&#x3002;<br>&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;func (g *Group) run(ctx context.Context) {</span><br><span class="line">	defer close(g.terminated)</span><br><span class="line"></span><br><span class="line">	// Wait an initial amount to have consistently slotted intervals.</span><br><span class="line">	evalTimestamp := g.EvalTimestamp(time.Now().UnixNano()).Add(g.interval)</span><br><span class="line">	select {</span><br><span class="line">	case &lt;-time.After(time.Until(evalTimestamp))://&#x521D;&#x59CB;&#x5316;&#x7B49;&#x5F85;</span><br><span class="line">	case &lt;-g.done:</span><br><span class="line">		return</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	ctx = promql.NewOriginContext(ctx, map[string]interface{}{</span><br><span class="line">		&quot;ruleGroup&quot;: map[string]string{</span><br><span class="line">			&quot;file&quot;: g.File(),</span><br><span class="line">			&quot;name&quot;: g.Name(),</span><br><span class="line">		},</span><br><span class="line">	})</span><br><span class="line">    //&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#x7EC4;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x8C03;&#x5EA6;&#x7B97;&#x6CD5;</span><br><span class="line">	iter := func() {</span><br><span class="line">		g.metrics.IterationsScheduled.WithLabelValues(GroupKey(g.file, g.name)).Inc()</span><br><span class="line"></span><br><span class="line">		start := time.Now()</span><br><span class="line">        //&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x7684;&#x5165;&#x53E3;</span><br><span class="line">		g.Eval(ctx, evalTimestamp)</span><br><span class="line">		timeSinceStart := time.Since(start)</span><br><span class="line"></span><br><span class="line">		g.metrics.IterationDuration.Observe(timeSinceStart.Seconds())</span><br><span class="line">		g.setEvaluationTime(timeSinceStart)</span><br><span class="line">		g.setLastEvaluation(start)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	// The assumption here is that since the ticker was started after having</span><br><span class="line">	// waited for `evalTimestamp` to pass, the ticks will trigger soon</span><br><span class="line">	// after each `evalTimestamp + N * g.interval` occurrence.</span><br><span class="line">	tick := time.NewTicker(g.interval) //&#x8BBE;&#x7F6E;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x5B9A;&#x65F6;&#x5668;</span><br><span class="line">	defer tick.Stop()</span><br><span class="line"></span><br><span class="line">	defer func() {</span><br><span class="line">		if !g.markStale {</span><br><span class="line">			return</span><br><span class="line">		}</span><br><span class="line">		go func(now time.Time) {</span><br><span class="line">			for _, rule := range g.seriesInPreviousEval {</span><br><span class="line">				for _, r := range rule {</span><br><span class="line">					g.staleSeries = append(g.staleSeries, r)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			// That can be garbage collected at this point.</span><br><span class="line">			g.seriesInPreviousEval = nil</span><br><span class="line">			// Wait for 2 intervals to give the opportunity to renamed rules</span><br><span class="line">			// to insert new series in the tsdb. At this point if there is a</span><br><span class="line">			// renamed rule, it should already be started.</span><br><span class="line">			select {</span><br><span class="line">			case &lt;-g.managerDone:</span><br><span class="line">			case &lt;-time.After(2 * g.interval):</span><br><span class="line">				g.cleanupStaleSeries(ctx, now)</span><br><span class="line">			}</span><br><span class="line">		}(time.Now())</span><br><span class="line">	}()</span><br><span class="line">    //&#x8C03;&#x7528;&#x89C4;&#x5219;&#x7EC4;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x7684;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;</span><br><span class="line">	iter()</span><br><span class="line">	if g.shouldRestore {</span><br><span class="line">		// If we have to restore, we wait for another Eval to finish.</span><br><span class="line">		// The reason behind this is, during first eval (or before it)</span><br><span class="line">		// we might not have enough data scraped, and recording rules would not</span><br><span class="line">		// have updated the latest values, on which some alerts might depend.</span><br><span class="line">		select {</span><br><span class="line">		case &lt;-g.done:</span><br><span class="line">			return</span><br><span class="line">		case &lt;-tick.C:</span><br><span class="line">			missed := (time.Since(evalTimestamp) / g.interval) - 1</span><br><span class="line">			if missed &gt; 0 {</span><br><span class="line">				g.metrics.IterationsMissed.WithLabelValues(GroupKey(g.file, g.name)).Add(float64(missed))</span><br><span class="line">				g.metrics.IterationsScheduled.WithLabelValues(GroupKey(g.file, g.name)).Add(float64(missed))</span><br><span class="line">			}</span><br><span class="line">			evalTimestamp = evalTimestamp.Add((missed + 1) * g.interval)</span><br><span class="line">			iter()</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		g.RestoreForState(time.Now())</span><br><span class="line">		g.shouldRestore = false</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	for {</span><br><span class="line">		select {</span><br><span class="line">		case &lt;-g.done:</span><br><span class="line">			return</span><br><span class="line">		default:</span><br><span class="line">			select {</span><br><span class="line">			case &lt;-g.done:</span><br><span class="line">				return</span><br><span class="line">			case &lt;-tick.C:</span><br><span class="line">				missed := (time.Since(evalTimestamp) / g.interval) - 1</span><br><span class="line">				if missed &gt; 0 {</span><br><span class="line">					g.metrics.IterationsMissed.WithLabelValues(GroupKey(g.file, g.name)).Add(float64(missed))</span><br><span class="line">					g.metrics.IterationsScheduled.WithLabelValues(GroupKey(g.file, g.name)).Add(float64(missed))</span><br><span class="line">				}</span><br><span class="line">				evalTimestamp = evalTimestamp.Add((missed + 1) * g.interval)</span><br><span class="line">                //&#x8C03;&#x7528;&#x89C4;&#x5219;&#x7EC4;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x7684;&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;</span><br><span class="line">				iter()</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x8FD0;&#x884C;Rule&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;"><a href="#&#x8FD0;&#x884C;Rule&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;" class="headerlink" title="&#x8FD0;&#x884C;Rule&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;"></a>&#x8FD0;&#x884C;Rule&#x8C03;&#x5EA6;&#x65B9;&#x6CD5;</h3><p>&#x89C4;&#x5219;&#x7EC4;&#x5BF9;&#x5177;&#x4F53;&#x89C4;&#x5219;&#x7684;&#x8C03;&#x5EA6;&#x5728;Group.Eval&#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x5728;Group.Eval&#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x5C06;&#x89C4;&#x5219;&#x7EC4;&#x4E0B;&#x7684;&#x6BCF;&#x6761;&#x89C4;&#x5219;&#x901A;&#x8FC7;QueryFunc&#x5C06;&#xFF08;promQL&#xFF09;&#x653E;&#x5230;&#x67E5;&#x8BE2;&#x5F15;&#x64CE;&#xFF08;queryEngine&#xFF09;&#x4E2D;&#x6267;&#x884C;&#xFF0C;&#x5982;&#x679C;&#x88AB;&#x6267;&#x884C;&#x7684;&#x662F;AlertingRule&#x7C7B;&#x578B;&#xFF0C;&#x90A3;&#x4E48;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x6307;&#x6807;&#x4F1A;&#x88AB;NotifyFunc&#x7EC4;&#x4EF6;&#x53D1;&#x9001;&#x7ED9;&#x544A;&#x8B66;&#x670D;&#x52A1;&#xFF1B;&#x5982;&#x679C;&#x662F;RecordingRule&#x7C7B;&#x578B;&#xFF0C;&#x6700;&#x540E;&#x5C06;&#x6539;&#x7ED3;&#x679C;&#x6307;&#x6807;&#x5B58;&#x50A8;&#x5230;Prometheus&#x7684;&#x50A8;&#x5B58;&#x7BA1;&#x7406;&#x5668;&#x4E2D;&#xFF0C;&#x5E76;&#x5BF9;&#x8FC7;&#x671F;&#x6307;&#x6807;&#x8FDB;&#x884C;&#x5B58;&#x50A8;&#x6807;&#x8BB0;&#x5904;&#x7406;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;// Eval runs a single evaluation cycle in which all rules are evaluated sequentially.</span><br><span class="line">func (g *Group) Eval(ctx context.Context, ts time.Time) {</span><br><span class="line">	var samplesTotal float64</span><br><span class="line">    &#x904D;&#x5386;&#x5F53;&#x524D;&#x89C4;&#x5219;&#x7EC4;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x89C4;&#x5219;</span><br><span class="line">	for i, rule := range g.rules {</span><br><span class="line">		select {</span><br><span class="line">		case &lt;-g.done:</span><br><span class="line">			return</span><br><span class="line">		default:</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		func(i int, rule Rule) {</span><br><span class="line">			sp, ctx := opentracing.StartSpanFromContext(ctx, &quot;rule&quot;)</span><br><span class="line">			sp.SetTag(&quot;name&quot;, rule.Name())</span><br><span class="line">			defer func(t time.Time) {</span><br><span class="line">				sp.Finish()</span><br><span class="line">                //&#x66F4;&#x65B0;&#x670D;&#x52A1;&#x6307;&#x6807;-&#x89C4;&#x5219;&#x7684;&#x6267;&#x884C;&#x65F6;&#x95F4;</span><br><span class="line">				since := time.Since(t)</span><br><span class="line">				g.metrics.EvalDuration.Observe(since.Seconds())</span><br><span class="line">				rule.SetEvaluationDuration(since)</span><br><span class="line">                //&#x8BB0;&#x5F55;&#x672C;&#x6B21;&#x89C4;&#x5219;&#x6267;&#x884C;&#x7684;&#x8017;&#x65F6;</span><br><span class="line">				rule.SetEvaluationTimestamp(t)</span><br><span class="line">			}(time.Now())</span><br><span class="line">            //&#x8BB0;&#x5F55;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x7684;&#x6B21;&#x6570;</span><br><span class="line">			g.metrics.EvalTotal.WithLabelValues(GroupKey(g.File(), g.Name())).Inc()</span><br><span class="line">            //&#x8FD0;&#x7B97;&#x89C4;&#x5219;</span><br><span class="line">			vector, err := rule.Eval(ctx, ts, g.opts.QueryFunc, g.opts.ExternalURL)</span><br><span class="line">			if err != nil {</span><br><span class="line">                //&#x89C4;&#x5219;&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#x540E;&#xFF0C;&#x7EC8;&#x6B62;&#x67E5;&#x8BE2;</span><br><span class="line">				rule.SetHealth(HealthBad)</span><br><span class="line">				rule.SetLastError(err)</span><br><span class="line">                //&#x8BB0;&#x5F55;&#x67E5;&#x8BE2;&#x5931;&#x8D25;&#x7684;&#x6B21;&#x6570;</span><br><span class="line">				g.metrics.EvalFailures.WithLabelValues(GroupKey(g.File(), g.Name())).Inc()</span><br><span class="line"></span><br><span class="line">				// Canceled queries are intentional termination of queries. This normally</span><br><span class="line">				// happens on shutdown and thus we skip logging of any errors here.</span><br><span class="line">				if _, ok := err.(promql.ErrQueryCanceled); !ok {</span><br><span class="line">					level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Evaluating rule failed&quot;, &quot;rule&quot;, rule, &quot;err&quot;, err)</span><br><span class="line">				}</span><br><span class="line">				return</span><br><span class="line">			}</span><br><span class="line">			samplesTotal += float64(len(vector))</span><br><span class="line">            //&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x544A;&#x8B66;&#x7C7B;&#x578B;&#x89C4;&#x5219;</span><br><span class="line">			if ar, ok := rule.(*AlertingRule); ok {</span><br><span class="line">                &#x53D1;&#x9001;&#x544A;&#x8B66;</span><br><span class="line">				ar.sendAlerts(ctx, ts, g.opts.ResendDelay, g.interval, g.opts.NotifyFunc)</span><br><span class="line">			}</span><br><span class="line">			var (</span><br><span class="line">				numOutOfOrder = 0</span><br><span class="line">				numDuplicates = 0</span><br><span class="line">			)</span><br><span class="line">          //&#x6B64;&#x5904;&#x4E3A;Recording&#x83B7;&#x53D6;&#x5B58;&#x50A8;&#x5668;&#x6307;&#x6807;</span><br><span class="line">			app := g.opts.Appendable.Appender(ctx)</span><br><span class="line">			seriesReturned := make(map[string]labels.Labels, len(g.seriesInPreviousEval[i]))</span><br><span class="line">			defer func() {</span><br><span class="line">				if err := app.Commit(); err != nil {</span><br><span class="line">					rule.SetHealth(HealthBad)</span><br><span class="line">					rule.SetLastError(err)</span><br><span class="line">					g.metrics.EvalFailures.WithLabelValues(GroupKey(g.File(), g.Name())).Inc()</span><br><span class="line"></span><br><span class="line">					level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Rule sample appending failed&quot;, &quot;err&quot;, err)</span><br><span class="line">					return</span><br><span class="line">				}</span><br><span class="line">				g.seriesInPreviousEval[i] = seriesReturned</span><br><span class="line">			}()</span><br><span class="line"></span><br><span class="line">			for _, s := range vector {</span><br><span class="line">				if _, err := app.Append(0, s.Metric, s.T, s.V); err != nil {</span><br><span class="line">					rule.SetHealth(HealthBad)</span><br><span class="line">					rule.SetLastError(err)</span><br><span class="line"></span><br><span class="line">					switch errors.Cause(err) {</span><br><span class="line">                        &#x50A8;&#x5B58;&#x6307;&#x6807;&#x8FD4;&#x56DE;&#x7684;&#x5404;&#x79CD;&#x9519;&#x8BEF;&#x7801;&#x5904;&#x7406;</span><br><span class="line">					case storage.ErrOutOfOrderSample:</span><br><span class="line">						numOutOfOrder++</span><br><span class="line">						level.Debug(g.logger).Log(&quot;msg&quot;, &quot;Rule evaluation result discarded&quot;, &quot;err&quot;, err, &quot;sample&quot;, s)</span><br><span class="line">					case storage.ErrDuplicateSampleForTimestamp:</span><br><span class="line">						numDuplicates++</span><br><span class="line">						level.Debug(g.logger).Log(&quot;msg&quot;, &quot;Rule evaluation result discarded&quot;, &quot;err&quot;, err, &quot;sample&quot;, s)</span><br><span class="line">					default:</span><br><span class="line">						level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Rule evaluation result discarded&quot;, &quot;err&quot;, err, &quot;sample&quot;, s)</span><br><span class="line">					}</span><br><span class="line">				} else {</span><br><span class="line">                    &#x7F13;&#x5B58;&#x89C4;&#x5219;&#x8FD0;&#x7B97;&#x540E;&#x7684;&#x7ED3;&#x679C;&#x6307;&#x6807;</span><br><span class="line">					seriesReturned[s.Metric.String()] = s.Metric</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			if numOutOfOrder &gt; 0 {</span><br><span class="line">				level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Error on ingesting out-of-order result from rule evaluation&quot;, &quot;numDropped&quot;, numOutOfOrder)</span><br><span class="line">			}</span><br><span class="line">			if numDuplicates &gt; 0 {</span><br><span class="line">				level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Error on ingesting results from rule evaluation with different value but same timestamp&quot;, &quot;numDropped&quot;, numDuplicates)</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			for metric, lset := range g.seriesInPreviousEval[i] {</span><br><span class="line">				if _, ok := seriesReturned[metric]; !ok {</span><br><span class="line">                    //&#x8BBE;&#x7F6E;&#x8FC7;&#x671F;&#x6307;&#x6807;&#x7684;&#x6307;&#x6807;&#x503C;</span><br><span class="line">					// Series no longer exposed, mark it stale.</span><br><span class="line">					_, err = app.Append(0, lset, timestamp.FromTime(ts), math.Float64frombits(value.StaleNaN))</span><br><span class="line">					switch errors.Cause(err) {</span><br><span class="line">					case nil:</span><br><span class="line">					case storage.ErrOutOfOrderSample, storage.ErrDuplicateSampleForTimestamp:</span><br><span class="line">						// Do not count these in logging, as this is expected if series</span><br><span class="line">						// is exposed from a different rule.</span><br><span class="line">					default:</span><br><span class="line">						level.Warn(g.logger).Log(&quot;msg&quot;, &quot;Adding stale sample failed&quot;, &quot;sample&quot;, metric, &quot;err&quot;, err)</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}(i, rule)</span><br><span class="line">	}</span><br><span class="line">	if g.metrics != nil {</span><br><span class="line">		g.metrics.GroupSamples.WithLabelValues(GroupKey(g.File(), g.Name())).Set(samplesTotal)</span><br><span class="line">	}</span><br><span class="line">	g.cleanupStaleSeries(ctx, ts)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7136;&#x540E;&#x5C31;&#x662F;&#x89C4;&#x5219;&#x7684;&#x5177;&#x4F53;&#x6267;&#x884C;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5148;&#x53EA;&#x770B;AlertingRule&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x9996;&#x5148;&#x770B;&#x4E0B;AlertingRule&#x7684;&#x7ED3;&#x6784;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;// An AlertingRule generates alerts from its vector expression.</span><br><span class="line">type AlertingRule struct {</span><br><span class="line">    // The name of the alert.</span><br><span class="line">    name string</span><br><span class="line">    // The vector expression from which to generate alerts.</span><br><span class="line">    vector parser.Expr</span><br><span class="line">    // The duration for which a labelset needs to persist in the expression</span><br><span class="line">    // output vector before an alert transitions from Pending to Firing state.</span><br><span class="line">    holdDuration time.Duration</span><br><span class="line">    // Extra labels to attach to the resulting alert sample vectors.</span><br><span class="line">    labels labels.Labels</span><br><span class="line">    // Non-identifying key/value pairs.</span><br><span class="line">    annotations labels.Labels</span><br><span class="line">    // External labels from the global config.</span><br><span class="line">    externalLabels map[string]string</span><br><span class="line">    // true if old state has been restored. We start persisting samples for ALERT_FOR_STATE</span><br><span class="line">    // only after the restoration.</span><br><span class="line">    restored bool</span><br><span class="line">    // Protects the below.</span><br><span class="line">    mtx sync.Mutex</span><br><span class="line">    // Time in seconds taken to evaluate rule.</span><br><span class="line">    evaluationDuration time.Duration</span><br><span class="line">    // Timestamp of last evaluation of rule.</span><br><span class="line">    evaluationTimestamp time.Time</span><br><span class="line">    // The health of the alerting rule.</span><br><span class="line">    health RuleHealth</span><br><span class="line">    // The last error seen by the alerting rule.</span><br><span class="line">    lastError error</span><br><span class="line">    // A map of alerts which are currently active (Pending or Firing), keyed by</span><br><span class="line">    // the fingerprint of the labelset they correspond to.</span><br><span class="line">    active map[uint64]*Alert</span><br><span class="line">    logger log.Logger</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;active&#x5B57;&#x6BB5;&#x4E86;&#xFF0C;&#x5B83;&#x4FDD;&#x5B58;&#x4E86;&#x6267;&#x884C;&#x89C4;&#x5219;&#x540E;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x544A;&#x8B66;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x5177;&#x4F53;&#x662F;&#x5426;&#x544A;&#x8B66;&#x8FD8;&#x8981;&#x6267;&#x884C;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x903B;&#x8F91;&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x544A;&#x8B66;&#x6761;&#x4EF6;&#x3002;&#x5177;&#x4F53;&#x6267;&#x884C;&#x7684;&#x903B;&#x8F91;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;func (r *AlertingRule) Eval(ctx context.Context, ts time.Time, query QueryFunc, externalURL *url.URL) (promql.Vector, error) {</span><br><span class="line">    res, err := query(ctx, r.vector.String(), ts)</span><br><span class="line">    if err != nil {</span><br><span class="line">        r.SetHealth(HealthBad)</span><br><span class="line">        r.SetLastError(err)</span><br><span class="line">        return nil, err</span><br><span class="line">    }</span><br><span class="line">    // ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x521B;&#x5EFA;Manager&#x65F6;&#x4F20;&#x5165;&#x7684;QueryFunc&#x51FD;&#x6570;&#x6267;&#x884C;&#x89C4;&#x5219;&#x914D;&#x7F6E;&#x4E2D;&#x7684;expr&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x5F97;&#x5230;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x7ED3;&#x679C;&#x662F;&#x6EE1;&#x8DB3;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x6307;&#x6807;&#x7684;&#x96C6;&#x5408;&#x3002;<br>&#x6BD4;&#x5982;&#x914D;&#x7F6E;&#x7684;&#x89C4;&#x5219;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;cpu_usage &gt; 90</span><br></pre></td></tr></table></figure>

<p>&#x90A3;&#x4E48;&#x67E5;&#x51FA;&#x6765;&#x7684;&#x7ED3;&#x679C;&#x53EF;&#x80FD;&#x662F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;cpu_usage{instance=&quot;192.168.0.11&quot;} 91</span><br><span class="line">cpu_usage{instance=&quot;192.168.0.12&quot;} 92</span><br></pre></td></tr></table></figure>

<p>&#x7136;&#x540E;&#x904D;&#x5386;&#x67E5;&#x8BE2;&#x5230;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x6839;&#x636E;&#x6307;&#x6807;&#x7684;&#x6807;&#x7B7E;&#x751F;&#x6210;&#x4E00;&#x4E2A;hash&#x503C;&#xFF0C;&#x7136;&#x540E;&#x5224;&#x65AD;&#x8FD9;&#x4E2A;hash&#x503C;&#x662F;&#x5426;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF08;&#x5373;&#x4E4B;&#x524D;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x6709;&#x76F8;&#x540C;&#x7684;&#x6307;&#x6807;&#x6570;&#x636E;&#x8FD4;&#x56DE;&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x66F4;&#x65B0;&#x4E0A;&#x6B21;&#x7684;value&#x53CA;annotations&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;alert&#x5E76;&#x4FDD;&#x5B58;&#x81F3;&#x8BE5;&#x89C4;&#x5219;&#x4E0B;&#x7684;active alert&#x5217;&#x8868;&#x4E2D;&#x3002;<br>&#x7136;&#x540E;&#x904D;&#x5386;&#x89C4;&#x5219;&#x7684;active alert&#x5217;&#x8868;&#xFF0C;&#x6839;&#x636E;&#x89C4;&#x5219;&#x7684;&#x6301;&#x7EED;&#x65F6;&#x957F;&#x914D;&#x7F6E;&#x3001;alert&#x7684;&#x4E0A;&#x6B21;&#x89E6;&#x53D1;&#x65F6;&#x95F4;&#x3001;alert&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3001;&#x672C;&#x6B21;&#x67E5;&#x8BE2;alert&#x662F;&#x5426;&#x4F9D;&#x7136;&#x5B58;&#x5728;&#x7B49;&#x4FE1;&#x606F;&#x6765;&#x4FEE;&#x6539;alert&#x7684;&#x72B6;&#x6001;&#x3002;&#x5177;&#x4F53;&#x89C4;&#x5219;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x5982;&#x679C;alert&#x4E4B;&#x524D;&#x5B58;&#x5728;&#xFF0C;&#x4F46;&#x672C;&#x6B21;&#x6267;&#x884C;&#x65F6;&#x4E0D;&#x5B58;&#x5728;<ol>
<li>&#x72B6;&#x6001;&#x662F;StatePending&#x6216;&#x8005;&#x672C;&#x6B21;&#x68C0;&#x67E5;&#x65F6;&#x95F4;&#x8DDD;&#x79BB;&#x4E0A;&#x6B21;&#x89E6;&#x53D1;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;15&#x5206;&#x949F;&#xFF08;15&#x5206;&#x949F;&#x4E3A;&#x5199;&#x6B7B;&#x7684;&#x5E38;&#x91CF;&#xFF09;&#xFF0C;&#x5219;&#x5C06;&#x8BE5;alert&#x4ECE;active&#x5217;&#x8868;&#x4E2D;&#x5220;&#x9664;</li>
<li>&#x72B6;&#x6001;&#x4E0D;&#x4E3A;StateInactive&#x7684;alert&#x4FEE;&#x6539;&#x4E3A;StateInactive</li>
</ol>
</li>
<li>&#x5982;&#x679C;alert&#x4E4B;&#x524D;&#x5B58;&#x5728;&#x5E76;&#x4E14;&#x672C;&#x6B21;&#x6267;&#x884C;&#x4ECD;&#x7136;&#x5B58;&#x5728;<ol>
<li>alert&#x7684;&#x72B6;&#x6001;&#x662F;StatePending&#x5E76;&#x4E14;&#x672C;&#x6B21;&#x68C0;&#x67E5;&#x8DDD;&#x79BB;&#x4E0A;&#x6B21;&#x89E6;&#x53D1;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;&#x914D;&#x7F6E;&#x7684;for&#x6301;&#x7EED;&#x65F6;&#x957F;&#xFF0C;&#x90A3;&#x4E48;&#x72B6;&#x6001;&#x4FEE;&#x6539;&#x4E3A;StateFiring</li>
</ol>
</li>
<li>&#x5176;&#x4F59;&#x60C5;&#x51B5;&#x4FEE;&#x6539;alert&#x7684;&#x72B6;&#x6001;&#x4E3A;StatePending</li>
</ol>
<p>&#x4E0A;&#x9762;&#x90A3;&#x4E00;&#x6B65;&#x53EA;&#x662F;&#x4FEE;&#x6539;&#x4E86;alert&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x6267;&#x884C;&#x53D1;&#x9001;&#x544A;&#x8B66;&#x64CD;&#x4F5C;&#x3002;&#x4E0B;&#x9762;&#x624D;&#x662F;&#x771F;&#x6B63;&#x8981;&#x6267;&#x884C;&#x544A;&#x8B66;&#x64CD;&#x4F5C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">go&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x5224;&#x65AD;&#x89C4;&#x5219;&#x662F;&#x5426;&#x662F;alert&#x89C4;&#x5219;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x5219;&#x53D1;&#x9001;&#x544A;&#x8B66;&#x4FE1;&#x606F;&#xFF08;&#x5177;&#x4F53;&#x662F;&#x5426;&#x771F;&#x6B63;&#x53D1;&#x9001;&#x7531;ar.sendAlerts&#x4E2D;&#x7684;&#x903B;&#x8F91;&#x5224;&#x65AD;&#xFF09;</span><br><span class="line">if ar, ok := rule.(*AlertingRule); ok {</span><br><span class="line">    ar.sendAlerts(ctx, ts, g.opts.ResendDelay, g.interval, g.opts.NotifyFunc)</span><br><span class="line">}</span><br><span class="line">// .......</span><br><span class="line">func (r *AlertingRule) sendAlerts(ctx context.Context, ts time.Time, resendDelay time.Duration, interval time.Duration, notifyFunc NotifyFunc) {</span><br><span class="line">    alerts := []*Alert{}</span><br><span class="line">    r.ForEachActiveAlert(func(alert *Alert) {</span><br><span class="line">        if alert.needsSending(ts, resendDelay) {</span><br><span class="line">            alert.LastSentAt = ts</span><br><span class="line">            // Allow for two Eval or Alertmanager send failures.</span><br><span class="line">            delta := resendDelay</span><br><span class="line">            if interval &gt; resendDelay {</span><br><span class="line">                delta = interval</span><br><span class="line">            }</span><br><span class="line">            alert.ValidUntil = ts.Add(4 * delta)</span><br><span class="line">            anew := *alert</span><br><span class="line">            alerts = append(alerts, &amp;anew)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    notifyFunc(ctx, r.vector.String(), alerts...)</span><br><span class="line">}</span><br><span class="line">func (a *Alert) needsSending(ts time.Time, resendDelay time.Duration) bool {</span><br><span class="line">    if a.State == StatePending {</span><br><span class="line">        return false</span><br><span class="line">    }</span><br><span class="line">    // if an alert has been resolved since the last send, resend it</span><br><span class="line">    if a.ResolvedAt.After(a.LastSentAt) {</span><br><span class="line">        return true</span><br><span class="line">    }</span><br><span class="line">    return a.LastSentAt.Add(resendDelay).Before(ts)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6982;&#x62EC;&#x4E00;&#x4E0B;&#x4EE5;&#x4E0A;&#x903B;&#x8F91;&#x5C31;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x5982;&#x679C;alert&#x7684;&#x72B6;&#x6001;&#x662F;StatePending&#xFF0C;&#x5219;&#x4E0D;&#x53D1;&#x9001;&#x544A;&#x8B66;</li>
<li>&#x5982;&#x679C;alert&#x7684;&#x5DF2;&#x7ECF;&#x88AB;&#x89E3;&#x51B3;&#xFF0C;&#x90A3;&#x4E48;&#x518D;&#x6B21;&#x53D1;&#x9001;&#x544A;&#x8B66;&#x6807;&#x8BC6;&#x8BE5;&#x6761;&#x4FE1;&#x606F;&#x5DF2;&#x7ECF;&#x88AB;&#x89E3;&#x51B3;</li>
<li>&#x5982;&#x679C;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#x8DDD;&#x79BB;&#x4E0A;&#x6B21;&#x53D1;&#x9001;&#x544A;&#x8B66;&#x7684;&#x65F6;&#x95F4;&#x5927;&#x4E8E;&#x914D;&#x7F6E;&#x7684;&#x91CD;&#x65B0;&#x53D1;&#x9001;&#x5EF6;&#x65F6;&#x65F6;&#x95F4;&#xFF08;ResendDelay&#xFF09;&#xFF0C;&#x5219;&#x53D1;&#x9001;&#x544A;&#x8B66;&#xFF0C;&#x5426;&#x5219;&#x4E0D;&#x53D1;&#x9001;</li>
</ol>
<p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;prometheus&#x7684;&#x544A;&#x8B66;&#x6D41;&#x7A0B;&#x3002;&#x5B66;&#x4E60;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x4E3B;&#x8981;&#x662F;&#x95EE;&#x4E86;&#x80FD;&#x591F;&#x5BF9;prometheus&#x7684;rules&#x76F8;&#x5173;&#x7684;&#x505A;&#x4E8C;&#x6B21;&#x5F00;&#x53D1;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;LoadGroups&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#xFF0C;&#x8BA9;&#x5176;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x4FA7;&#x52A0;&#x8F7D;&#x5B9A;&#x4E49;&#x5728;mysql&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x52A8;&#x6001;&#x5B9E;&#x73B0;&#x544A;&#x8B66;&#x89C4;&#x5219;&#x66F4;&#x65B0;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/1aef0a2ccff60eae214a1e1fc5344939.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7005438980455923726.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7005438980455923726.html" itemprop="url">Kafka（五）springboot集成kafka</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-08T14:04:05+08:00">
                2021-09-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x6211;&#x6B63;&#x5728;&#x53C2;&#x52A0;&#x4E2D;&#x79CB;&#x521B;&#x610F;&#x6295;&#x7A3F;&#x5927;&#x8D5B;&#xFF0C;&#x8BE6;&#x60C5;&#x8BF7;&#x770B;&#xFF1A;<a href="https://dev.newban.cn/7003154195826081800">&#x4E2D;&#x79CB;&#x521B;&#x610F;&#x6295;&#x7A3F;&#x5927;&#x8D5B;</a> &#x3002;</p>
<h2 id="&#x4E00;&#x3001;&#x6DFB;&#x52A0;kafka&#x4F9D;&#x8D56;"><a href="#&#x4E00;&#x3001;&#x6DFB;&#x52A0;kafka&#x4F9D;&#x8D56;" class="headerlink" title="&#x4E00;&#x3001;&#x6DFB;&#x52A0;kafka&#x4F9D;&#x8D56;"></a>&#x4E00;&#x3001;&#x6DFB;&#x52A0;kafka&#x4F9D;&#x8D56;</h2><p>&#x5728;<a href="/external_links/2d7a27642b88ccaf08491d6c9dbd9183.html" target="blank" rel="noopener">mvnrepository.com/&#x4E2D;&#x641C;&#x7D22;kafka&#xFF0C;&#x6211;&#x4EEC;&#x2026;</a></p>
<p>&#x8FD9;&#x91CC;&#x9762;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x70B9;&#x7248;&#x672C;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x53C2;&#x8003;&#x4E0B;&#x56FE;&#x505A;&#x5BF9;&#x6BD4;&#xFF0C;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x7684;springboot&#x652F;&#x6301;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x7684;kafka&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/dc27b95ae6ba26452baf0dcca450b90437cebc54828d6a950f5a73385747431d" alt="image.png"></p>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x53BB;&#x5B98;&#x65B9;&#x770B;&#x8FD9;&#x4E2A;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#xFF1A;<a href="/external_links/1fd057e0a38cb4dc75b478038dfd1d8c.html" target="blank" rel="noopener">spring.io/projects/sp&#x2026;</a></p>
<p>&#x5BF9;&#x6BD4;&#x4E0A;&#x56FE;&#x53BB;maven&#x4ED3;&#x5E93;&#x627E;&#x76F8;&#x5E94;&#x7248;&#x672C;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#xFF1A;<a href="/external_links/2d7a27642b88ccaf08491d6c9dbd9183.html" target="blank" rel="noopener">mvnrepository.com/</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/7d45a3cd432bcf9a6151b3b68835c12ea935ee6161803639e0db384c014396c3" alt="image.png"></p>
<p>&#x6211;&#x7684;springboot&#x7248;&#x672C;&#x662F;2.2.5&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;kafka&#x7684;&#x7248;&#x672C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;!-- https://mvnrepository.com/artifact/org.springframework.kafka/spring-kafka --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.3.5.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x7248;&#x672C;&#x4E0D;&#x5BF9;&#x5E94;&#x4F1A;&#x6709;&#x5F88;&#x591A;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x901A;&#x5E38;kafka&#x7684;&#x7248;&#x672C;&#x8981;&#x6BD4;springboot&#x9AD8;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x6BD4;&#x5982;2.2.5&#x5219;kafka&#x662F;2.3.5&#x8FD9;&#x6837;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x6587;&#x4EF6;"><a href="#&#x4E8C;&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x6587;&#x4EF6;" class="headerlink" title="&#x4E8C;&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x6587;&#x4EF6;"></a>&#x4E8C;&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</h2><p>&#x6211;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x5171;&#x5DE5;&#x7A0B;&#x6A21;&#x62DF;&#x751F;&#x4EA7;&#x8005;&#x548C;&#x6D88;&#x8D39;&#x8005;&#x3002;<br>&#x6211;&#x7684;springboot&#x5DE5;&#x7A0B;&#x4F7F;&#x7528;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x662F;yaml&#x7C7B;&#x578B;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6309;&#x7167;&#x5982;&#x4E0B;&#x65B9;&#x5F0F;&#x6DFB;&#x52A0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;spring:</span><br><span class="line">  kafka:</span><br><span class="line">    bootstrap-servers: 192.168.184.134:9092,192.168.184.135:9092,192.168.184.136:9092</span><br><span class="line">    producer:</span><br><span class="line">      # &#x53D1;&#x751F;&#x9519;&#x8BEF;&#x540E;&#xFF0C;&#x6D88;&#x606F;&#x91CD;&#x53D1;&#x7684;&#x6B21;&#x6570;&#x3002;</span><br><span class="line">      retries: 0</span><br><span class="line">      # &#x952E;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;</span><br><span class="line">      key-serializer: org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">      # &#x503C;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;</span><br><span class="line">      value-serializer: org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">    consumer:</span><br><span class="line">      group-id: test</span><br><span class="line">      # &#x952E;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;</span><br><span class="line">      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">      # &#x503C;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;</span><br><span class="line">      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">    listener:</span><br><span class="line">      # &#x4F46;&#x6D88;&#x8D39;&#x8005;&#x76D1;&#x542C;&#x7684;topic&#x4E0D;&#x5B58;&#x5728;&#x65F6;&#xFF0C;&#x4FDD;&#x8BC1;&#x80FD;&#x591F;&#x662F;&#x9879;&#x76EE;&#x542F;&#x52A8;</span><br><span class="line">      missing-topics-fatal: false</span><br></pre></td></tr></table></figure>

<p>&#x914D;&#x7F6E;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5148;&#x96C6;&#x6210;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x9010;&#x6E10;&#x589E;&#x52A0;&#x914D;&#x7F6E;&#x3002;</p>
<h2 id="&#x4E09;&#x3001;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;"><a href="#&#x4E09;&#x3001;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;" class="headerlink" title="&#x4E09;&#x3001;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;"></a>&#x4E09;&#x3001;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;</h2><h4 id="3-1&#x751F;&#x4EA7;&#x8005;"><a href="#3-1&#x751F;&#x4EA7;&#x8005;" class="headerlink" title="3.1&#x751F;&#x4EA7;&#x8005;"></a>3.1&#x751F;&#x4EA7;&#x8005;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;package com.cloud.bssp.message.kafka.producer;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * kafka&#x751F;&#x4EA7;&#x8005;</span><br><span class="line"> *</span><br><span class="line"> * @author weirx</span><br><span class="line"> * @date 2021/02/03 14:22</span><br><span class="line"> **/</span><br><span class="line">@Component</span><br><span class="line">public class KafkaProducer {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private KafkaTemplate kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * kafka&#x6D88;&#x606F;&#x53D1;&#x9001;</span><br><span class="line">     * @param</span><br><span class="line">     * @author weirx</span><br><span class="line">     * @return void</span><br><span class="line">     * @date: 2021/2/3</span><br><span class="line">     */</span><br><span class="line">    public void send(String topic){</span><br><span class="line">        kafkaTemplate.send(topic,&quot;hello kafka&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="3-2&#x6D88;&#x8D39;&#x8005;"><a href="#3-2&#x6D88;&#x8D39;&#x8005;" class="headerlink" title="3.2&#x6D88;&#x8D39;&#x8005;"></a>3.2&#x6D88;&#x8D39;&#x8005;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;package com.cloud.bssp.message.kafka.consumer;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line">import org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * kafka&#x6D88;&#x8D39;&#x8005;</span><br><span class="line"> *</span><br><span class="line"> * @author weirx</span><br><span class="line"> * @date 2021/02/03 15:01</span><br><span class="line"> **/</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class KafkaConsumer {</span><br><span class="line"></span><br><span class="line">    @KafkaListener(topics = {&quot;test-kafka&quot;})</span><br><span class="line">    public void consumer(ConsumerRecord&lt;?, ?&gt; record) {</span><br><span class="line">        Optional&lt;?&gt; kafkaMessage = Optional.ofNullable(record.value());</span><br><span class="line">        if (kafkaMessage.isPresent()) {</span><br><span class="line">            Object message = kafkaMessage.get();</span><br><span class="line">            log.info(&quot;----------------- record =&quot; + record);</span><br><span class="line">            log.info(&quot;------------------ message =&quot; + message);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="3-3&#x6D4B;&#x8BD5;&#x7C7B;"><a href="#3-3&#x6D4B;&#x8BD5;&#x7C7B;" class="headerlink" title="3.3&#x6D4B;&#x8BD5;&#x7C7B;"></a>3.3&#x6D4B;&#x8BD5;&#x7C7B;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;package com.cloud.bssp.message.kafka;</span><br><span class="line"></span><br><span class="line">import com.cloud.bssp.message.kafka.producer.KafkaProducer;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * kafka&#x6D4B;&#x8BD5;&#x7C7B;</span><br><span class="line"> *</span><br><span class="line"> * @author weirx</span><br><span class="line"> * @date 2021/02/03 15:03</span><br><span class="line"> **/</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;test/kafka&quot;)</span><br><span class="line">public class TestKafka {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private KafkaProducer producer;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/send/{topic}&quot;)</span><br><span class="line">    public void send(@PathVariable String topic){</span><br><span class="line">        producer.send(topic);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;&#x3001;&#x6D4B;&#x8BD5;"><a href="#&#x56DB;&#x3001;&#x6D4B;&#x8BD5;" class="headerlink" title="&#x56DB;&#x3001;&#x6D4B;&#x8BD5;"></a>&#x56DB;&#x3001;&#x6D4B;&#x8BD5;</h2><p>&#x8FD9;&#x91CC;&#x6211;&#x5C06;topic&#x4F5C;&#x4E3A;&#x4E86;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x4F20;&#x9012;&#xFF0C;&#x65B9;&#x4FBF;&#x6211;&#x4EEC;&#x89C2;&#x5BDF;&#x3002;<br>&#x6211;&#x4EEC;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;http://localhost:8085/test/kafka/send/test-kafka</span><br></pre></td></tr></table></figure>

<p>&#x770B;&#x4E0B;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x6D88;&#x8D39;&#x8005;&#x8F93;&#x51FA;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;2021-02-03 17:12:44.654  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 5, leaderEpoch = 0, offset = 0, CreateTime = 1612343564622, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:12:44.654  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x4E0A;&#x7ED3;&#x679C;&#x770B;&#x5230;&#xFF1A;<br>topic&#xFF1A;test-kafka<br>partition&#xFF1A;5<br>offset&#xFF1A;0</p>
<p>&#x6211;&#x4EEC;&#x4ECE;kafkatool&#x4E2D;&#x770B;&#x770B;&#x7ED3;&#x679C;&#xFF0C;&#x5728;&#x5206;&#x533A;5&#x4E2D;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x6761;&#x6D88;&#x606F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/3fba24dff758b1b463742a26298451621d20ab1ae04917eddfb0d667901ef0dd" alt="image.png"></p>
<p>&#x8FD9;&#x91CC;&#x4E3A;&#x4EC0;&#x4E48;&#x6709;10&#x4E2A;&#x5206;&#x533A;&#x5462;&#xFF1F;&#x5728;&#x4E0A;&#x4E00;&#x7AE0;&#x8282;&#x6211;&#x4EEC;&#x642D;&#x5EFA;kafka&#x96C6;&#x7FA4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9ED8;&#x8BA4;&#x7ED9;&#x4E86;10&#x4E2A;partition&#xFF0C;&#x5173;&#x4E8E;partition&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x5728;&#x6211;&#x4EEC;&#x5B66;&#x4F1A;&#x4F7F;&#x7528;&#x540E;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x7AE0;&#x8282;&#x4F1A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;</p>
<p>offset&#x662F;&#x5F53;&#x524D;partition&#x4E2D;&#x7684;&#x6570;&#x636E;&#x4E2A;&#x6570;&#x7684;&#x504F;&#x79FB;&#x91CF;&#xFF0C;&#x4ECE;0&#x5F00;&#x59CB;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x53D1;&#x9001;10&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x4F7F;&#x6D88;&#x606F;&#x518D;&#x6B21;&#x53D1;&#x9001;&#x5230;partition5&#x4E2D;&#x3002;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;2021-02-03 17:15:17.129  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 9, leaderEpoch = 0, offset = 0, CreateTime = 1612343717117, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:15:17.129  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:20:45.456  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 0, leaderEpoch = 0, offset = 0, CreateTime = 1612344045453, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:20:45.456  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:12.999  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 4, leaderEpoch = 0, offset = 0, CreateTime = 1612344072988, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:12.999  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:15.983  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 3, leaderEpoch = 0, offset = 0, CreateTime = 1612344075980, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:15.983  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:16.799  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 2, leaderEpoch = 0, offset = 0, CreateTime = 1612344076796, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:16.799  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:17.614  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 1, leaderEpoch = 0, offset = 0, CreateTime = 1612344077612, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:17.614  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:18.487  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 8, leaderEpoch = 0, offset = 0, CreateTime = 1612344078484, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:18.487  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:19.527  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 7, leaderEpoch = 0, offset = 0, CreateTime = 1612344079524, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:19.527  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:20.505  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 6, leaderEpoch = 0, offset = 0, CreateTime = 1612344080500, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:20.505  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br><span class="line">2021-02-03 17:21:21.440  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ----------------- record =ConsumerRecord(topic = test-kafka, partition = 5, leaderEpoch = 0, offset = 1, CreateTime = 1612344081437, serialized key size = -1, serialized value size = 11, headers = RecordHeaders(headers = [], isReadOnly = false), key = null, value = hello kafka)</span><br><span class="line">2021-02-03 17:21:21.440  INFO 5080 --- [ntainer#0-0-C-1] c.c.b.m.kafka.consumer.KafkaConsumer     : ------------------ message =hello kafka</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x4E0A;&#x7ED3;&#x679C;&#xFF0C;&#x53C8;&#x53D1;&#x9001;&#x4E86;10&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x6D88;&#x606F;&#x968F;&#x673A;&#x7684;&#x8D1F;&#x8F7D;&#x5230;&#x6BCF;&#x4E2A;partition&#x4E2D;&#xFF0C;&#x7B2C;10&#x6761;&#x518D;&#x6B21;&#x8BB0;&#x5F55;&#x5230;&#x4E86;partition 5&#x4E2D;&#xFF0C;&#x5176;offset&#x52A0;1&#x4E86;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/6516eb384b68726c13bd9fbaf3e468c5371cc5cac68f61a1a9f387df9c9293a9" alt="image.png"></p>
<hr>
<p>&#x5230;&#x6B64;&#x4E3A;&#x6B62;&#xFF0C;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;springboot&#x548C;kafka&#x7684;&#x96C6;&#x6210;&#x4E86;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x9010;&#x6E10;&#x6DF1;&#x5165;&#x5230;&#x6BCF;&#x4E2A;&#x7279;&#x6027;&#x548C;&#x7EC4;&#x4EF6;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/6b2ffe9e2c91a450f892e389895ded5e.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7005375860509245471.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7005375860509245471.html" itemprop="url">50行代码串行Promise，koa洋葱模型原来是这么实现？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-08T09:57:28+08:00">
                2021-09-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>&#x524D;&#x8A00;</li>
</ol>
<hr>
<p>&#x5927;&#x5BB6;&#x597D;&#xFF0C;&#x6211;&#x662F;<a href="/external_links/2e94e5f617ec57b813b3f7922f4fcea6.html" target="blank" rel="noopener">&#x82E5;&#x5DDD;</a>&#x3002;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x6211;&#x7684;<a href="/external_links/b71f781539ee782c62d55f94d7a81dc5.html" target="blank" rel="noopener">&#x516C;&#x4F17;&#x53F7;&#x82E5;&#x5DDD;&#x89C6;&#x91CE;</a>&#xFF0C;&#x6700;&#x8FD1;&#x7EC4;&#x7EC7;&#x4E86;<a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener"><strong>&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x6D3B;&#x52A8;</strong></a>&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x52A0;&#x6211;&#x5FAE;&#x4FE1; <a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener">ruochuan12</a> &#x53C2;&#x4E0E;&#xFF0C;&#x957F;&#x671F;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x5199;&#x7684;<a href="/external_links/fedfaff5eac6f4a3b25ab39b65554b53.html" target="blank" rel="noopener">&#x300A;&#x5B66;&#x4E60;&#x6E90;&#x7801;&#x6574;&#x4F53;&#x67B6;&#x6784;&#x7CFB;&#x5217;&#x300B;</a> &#x5305;&#x542B;<code>jQuery</code>&#x3001;<code>underscore</code>&#x3001;<code>lodash</code>&#x3001;<code>vuex</code>&#x3001;<code>sentry</code>&#x3001;<code>axios</code>&#x3001;<code>redux</code>&#x3001;<code>koa</code>&#x3001;<code>vue-devtools</code>&#x3001;<code>vuex4</code>&#x5341;&#x4F59;&#x7BC7;&#x6E90;&#x7801;&#x6587;&#x7AE0;&#x3002;&#x5176;&#x4E2D;&#x6700;&#x65B0;&#x7684;&#x4E24;&#x7BC7;&#x662F;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/6997943192851054606">Vue 3.2 &#x53D1;&#x5E03;&#x4E86;&#xFF0C;&#x90A3;&#x5C24;&#x96E8;&#x6EAA;&#x662F;&#x600E;&#x4E48;&#x53D1;&#x5E03; Vue.js &#x7684;&#xFF1F;</a></p>
<p><a href="https://dev.newban.cn/6994976281053888519">&#x521D;&#x5B66;&#x8005;&#x4E5F;&#x80FD;&#x770B;&#x61C2;&#x7684; Vue3 &#x6E90;&#x7801;&#x4E2D;&#x90A3;&#x4E9B;&#x5B9E;&#x7528;&#x7684;&#x57FA;&#x7840;&#x5DE5;&#x5177;&#x51FD;&#x6570;</a></p>
<p>&#x5199;&#x76F8;&#x5BF9;&#x5F88;&#x96BE;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x8017;&#x8D39;&#x4E86;&#x81EA;&#x5DF1;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x7CBE;&#x529B;&#xFF0C;&#x4E5F;&#x6CA1;&#x6536;&#x83B7;&#x591A;&#x5C11;&#x9605;&#x8BFB;&#x70B9;&#x8D5E;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4EF6;&#x633A;&#x53D7;&#x6253;&#x51FB;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x4ECE;&#x9605;&#x8BFB;&#x91CF;&#x548C;&#x8BFB;&#x8005;&#x53D7;&#x76CA;&#x65B9;&#x9762;&#x6765;&#x770B;&#xFF0C;&#x4E0D;&#x80FD;&#x4FC3;&#x8FDB;&#x4F5C;&#x8005;&#x6301;&#x7EED;&#x8F93;&#x51FA;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x8F6C;&#x53D8;&#x601D;&#x8DEF;&#xFF0C;&#x5199;&#x4E00;&#x4E9B;&#x76F8;&#x5BF9;&#x901A;&#x4FD7;&#x6613;&#x61C2;&#x7684;&#x6587;&#x7AE0;&#x3002;<strong>&#x5176;&#x5B9E;&#x6E90;&#x7801;&#x4E5F;&#x4E0D;&#x662F;&#x60F3;&#x8C61;&#x7684;&#x90A3;&#x4E48;&#x96BE;&#xFF0C;&#x81F3;&#x5C11;&#x6709;&#x5F88;&#x591A;&#x770B;&#x5F97;&#x61C2;</strong>&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x5199;&#x8FC7; koa &#x6E90;&#x7801;&#x6587;&#x7AE0;<a href="https://dev.newban.cn/6844904088220467213">&#x5B66;&#x4E60; koa &#x6E90;&#x7801;&#x7684;&#x6574;&#x4F53;&#x67B6;&#x6784;&#xFF0C;&#x6D45;&#x6790;koa&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x539F;&#x7406;&#x548C;co&#x539F;&#x7406;</a>&#x6BD4;&#x8F83;&#x957F;&#xFF0C;&#x8BFB;&#x8005;&#x670B;&#x53CB;&#x5927;&#x6982;&#x7387;&#x770B;&#x4E0D;&#x5B8C;&#xFF0C;&#x6240;&#x4EE5;&#x672C;&#x6587;&#x4ECE;<code>koa-compose</code>50&#x884C;&#x6E90;&#x7801;&#x8BB2;&#x8FF0;&#x3002;</p>
<p>&#x672C;&#x6587;&#x6D89;&#x53CA;&#x5230;&#x7684; <a href="/external_links/36e9c84a07468eb0d8a7751996482266.html" target="blank" rel="noopener">koa-compose &#x4ED3;&#x5E93;</a> &#x6587;&#x4EF6;&#xFF0C;&#x6574;&#x4E2A;<code>index.js</code>&#x6587;&#x4EF6;&#x4EE3;&#x7801;&#x884C;&#x6570;&#x867D;&#x7136;&#x4E0D;&#x5230; <code>50</code> &#x884C;&#xFF0C;&#x800C;&#x4E14;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;<code>test/test.js</code>&#x6587;&#x4EF6; <code>300</code> &#x4F59;&#x884C;&#xFF0C;&#x4F46;&#x975E;&#x5E38;&#x503C;&#x5F97;&#x6211;&#x4EEC;&#x5B66;&#x4E60;&#x3002;</p>
<p>&#x6B4C;&#x5FB7;&#x66FE;&#x8BF4;&#xFF1A;&#x8BFB;&#x4E00;&#x672C;&#x597D;&#x4E66;&#xFF0C;&#x5C31;&#x662F;&#x5728;&#x548C;&#x9AD8;&#x5C1A;&#x7684;&#x4EBA;&#x8C08;&#x8BDD;&#x3002; &#x540C;&#x7406;&#x53EF;&#x5F97;&#xFF1A;&#x8BFB;&#x6E90;&#x7801;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x548C;&#x4F5C;&#x8005;&#x7684;&#x4E00;&#x79CD;&#x5B66;&#x4E60;&#x4EA4;&#x6D41;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x9605;&#x8BFB;&#x672C;&#x6587;&#xFF0C;&#x4F60;&#x5C06;&#x5B66;&#x5230;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;1. &#x719F;&#x6089; koa-compose &#x4E2D;&#x95F4;&#x4EF6;&#x6E90;&#x7801;&#x3001;&#x53EF;&#x4EE5;&#x5E94;&#x5BF9;&#x9762;&#x8BD5;&#x5B98;&#x76F8;&#x5173;&#x95EE;&#x9898;</span><br><span class="line">2. &#x5B66;&#x4F1A;&#x4F7F;&#x7528;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5;&#x6E90;&#x7801;</span><br><span class="line">3. &#x5B66;&#x4F1A; jest &#x90E8;&#x5206;&#x7528;&#x6CD5;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x73AF;&#x5883;&#x51C6;&#x5907;</li>
</ol>
<hr>
<h3 id="2-1-&#x514B;&#x9686;-koa-compose-&#x9879;&#x76EE;"><a href="#2-1-&#x514B;&#x9686;-koa-compose-&#x9879;&#x76EE;" class="headerlink" title="2.1 &#x514B;&#x9686; koa-compose &#x9879;&#x76EE;"></a>2.1 &#x514B;&#x9686; koa-compose &#x9879;&#x76EE;</h3><p><a href="/external_links/72fc7905a7d5326cce087f7e0acc8394.html" target="blank" rel="noopener">&#x672C;&#x6587;&#x4ED3;&#x5E93;&#x5730;&#x5740; koa-compose-analysis</a>&#xFF0C;&#x6C42;&#x4E2A;<code>star</code>~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x514B;&#x9686;&#x6211;&#x7684;&#x4ED3;&#x5E93;&#xFF0C;&#x6211;&#x7684;&#x4ED3;&#x5E93;&#x4FDD;&#x7559;&#x7684; compose &#x4ED3;&#x5E93;&#x7684; git &#x8BB0;&#x5F55;</span><br><span class="line">git clone https://github.com/lxchuan12/koa-compose-analysis.git</span><br><span class="line">cd koa-compose/compose</span><br><span class="line">npm i</span><br></pre></td></tr></table></figure>

<p>&#x987A;&#x5E26;&#x8BF4;&#x4E0B;&#xFF1A;&#x6211;&#x662F;&#x600E;&#x4E48;&#x4FDD;&#x7559; <code>compose</code> &#x4ED3;&#x5E93;&#x7684; <code>git</code> &#x8BB0;&#x5F55;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# &#x5728; github &#x4E0A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x4ED3;&#x5E93; `koa-compose-analysis` &#x514B;&#x9686;&#x4E0B;&#x6765;</span><br><span class="line">git clone https://github.com/lxchuan12/koa-compose-analysis.git</span><br><span class="line">cd koa-compose-analysis</span><br><span class="line">git subtree add --prefix=compose https://github.com/koajs/compose.git main</span><br><span class="line"># &#x8FD9;&#x6837;&#x5C31;&#x628A; compose &#x6587;&#x4EF6;&#x5939;&#x514B;&#x9686;&#x5230;&#x81EA;&#x5DF1;&#x7684; git &#x4ED3;&#x5E93;&#x4E86;&#x3002;&#x4E14;&#x4FDD;&#x7559;&#x7684; git &#x8BB0;&#x5F55;</span><br></pre></td></tr></table></figure>

<p>&#x5173;&#x4E8E;&#x66F4;&#x591A; <code>git subtree</code>&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;<a href="/external_links/ef80b102f73444145c2a3507c9b4adf3.html" target="blank" rel="noopener">&#x7528; Git Subtree &#x5728;&#x591A;&#x4E2A; Git &#x9879;&#x76EE;&#x95F4;&#x53CC;&#x5411;&#x540C;&#x6B65;&#x5B50;&#x9879;&#x76EE;&#xFF0C;&#x9644;&#x7B80;&#x660E;&#x4F7F;&#x7528;&#x624B;&#x518C;</a></p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x600E;&#x4E48;&#x6839;&#x636E;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x4E2D;&#x63D0;&#x4F9B;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#x3002;</p>
<h3 id="2-2-&#x6839;&#x636E;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5;-compose-&#x6E90;&#x7801;"><a href="#2-2-&#x6839;&#x636E;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5;-compose-&#x6E90;&#x7801;" class="headerlink" title="2.2 &#x6839;&#x636E;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5; compose &#x6E90;&#x7801;"></a>2.2 &#x6839;&#x636E;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5; compose &#x6E90;&#x7801;</h3><p>&#x7528;<code>VSCode</code>&#xFF08;&#x6211;&#x7684;&#x7248;&#x672C;&#x662F; <code>1.60</code> &#xFF09;&#x6253;&#x5F00;&#x9879;&#x76EE;&#xFF0C;&#x627E;&#x5230; <code>compose/package.json</code>&#xFF0C;&#x627E;&#x5230; <code>scripts</code> &#x548C; <code>test</code> &#x547D;&#x4EE4;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;// compose/package.json</span><br><span class="line">{</span><br><span class="line">    &quot;name&quot;: &quot;koa-compose&quot;,</span><br><span class="line">    // debug &#xFF08;&#x8C03;&#x8BD5;&#xFF09;</span><br><span class="line">    &quot;scripts&quot;: {</span><br><span class="line">        &quot;eslint&quot;: &quot;standard --fix .&quot;,</span><br><span class="line">        &quot;test&quot;: &quot;jest&quot;</span><br><span class="line">    },</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>scripts</code>&#x4E0A;&#x65B9;&#x5E94;&#x8BE5;&#x4F1A;&#x6709;<code>debug</code>&#x6216;&#x8005;<code>&#x8C03;&#x8BD5;</code>&#x5B57;&#x6837;&#x3002;&#x70B9;&#x51FB;<code>debug</code>(&#x8C03;&#x8BD5;)&#xFF0C;&#x9009;&#x62E9; <code>test</code>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a28e5e72a2f1dfd2bce7737cda3e603422acc4301bf1c54b461dd02277f35fb7" alt="VSCode &#x8C03;&#x8BD5;"></p>
<p>&#x63A5;&#x7740;&#x4F1A;&#x6267;&#x884C;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;<code>test/test.js</code>&#x6587;&#x4EF6;&#x3002;&#x7EC8;&#x7AEF;&#x8F93;&#x51FA;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0dc00aec232edad84f2ead4db6da6f2ea8093afeae14009e824e169cf4a1fba7" alt="koa-compose &#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8F93;&#x51FA;&#x7ED3;&#x679C;"></p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x8C03;&#x8BD5; <code>compose/test/test.js</code> &#x6587;&#x4EF6;&#x3002;<br>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; <code>45&#x884C;</code> &#x6253;&#x4E0A;&#x65AD;&#x70B9;&#xFF0C;&#x91CD;&#x65B0;&#x70B9;&#x51FB; <code>package.json</code> =&gt; <code>srcipts</code> =&gt; <code>test</code> &#x8FDB;&#x5165;&#x8C03;&#x8BD5;&#x6A21;&#x5F0F;&#x3002;<br>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/3cb27f7e6c5ef31833fa29ea4983f63d79b8790a01e162ee41eb733d6800dd69" alt="koa-compose &#x8C03;&#x8BD5;"></p>
<p>&#x63A5;&#x7740;&#x6309;&#x4E0A;&#x65B9;&#x7684;&#x6309;&#x94AE;&#xFF0C;&#x7EE7;&#x7EED;&#x8C03;&#x8BD5;&#x3002;&#x5728;<code>compose/index.js</code>&#x6587;&#x4EF6;&#x4E2D;&#x5173;&#x952E;&#x7684;&#x5730;&#x65B9;&#x6253;&#x4E0A;&#x65AD;&#x70B9;&#xFF0C;&#x8C03;&#x8BD5;&#x5B66;&#x4E60;&#x6E90;&#x7801;&#x4E8B;&#x534A;&#x529F;&#x500D;&#x3002;</p>
<p><a href="/external_links/f7809270f41e044d90770c8e0e4c9c17.html" target="blank" rel="noopener">&#x66F4;&#x591A; nodejs &#x8C03;&#x8BD5;&#x76F8;&#x5173; &#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5B98;&#x65B9;&#x6587;&#x6863;</a></p>
<p>&#x987A;&#x4FBF;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#x4E0B;&#x51E0;&#x4E2A;&#x8C03;&#x8BD5;&#x76F8;&#x5173;&#x6309;&#x94AE;&#x3002;</p>
<ul>
<li><ol>
<li>&#x7EE7;&#x7EED;&#xFF08;F5&#xFF09;: &#x70B9;&#x51FB;&#x540E;&#x4EE3;&#x7801;&#x4F1A;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x65AD;&#x70B9;&#x6240;&#x5728;&#x4F4D;&#x7F6E;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x4E00;&#x4E2A;&#x65AD;&#x70B9;&#xFF0C;&#x5219;&#x8BA4;&#x4E3A;&#x672C;&#x6B21;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x3002;</li>
</ol>
</li>
<li><ol start="2">
<li>&#x5355;&#x6B65;&#x8DF3;&#x8FC7;&#xFF08;F10&#xFF09;&#xFF1A;&#x70B9;&#x51FB;&#x540E;&#x4F1A;&#x8DF3;&#x5230;&#x5F53;&#x524D;&#x4EE3;&#x7801;&#x4E0B;&#x4E00;&#x884C;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x5230;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x3002;</li>
</ol>
</li>
<li><ol start="3">
<li>&#x5355;&#x6B65;&#x8C03;&#x8BD5;&#xFF08;F11&#xFF09;&#xFF1A;&#x70B9;&#x51FB;&#x540E;&#x8FDB;&#x5165;&#x5230;&#x5F53;&#x524D;&#x51FD;&#x6570;&#x7684;&#x5185;&#x90E8;&#x8C03;&#x8BD5;&#xFF0C;&#x6BD4;&#x5982;&#x5728; <code>compose</code> &#x8FD9;&#x4E00;&#x884C;&#x4E2D;&#x6267;&#x884C;&#x5355;&#x6B65;&#x8C03;&#x8BD5;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;&#x5230; <code>compose</code> &#x51FD;&#x6570;&#x5185;&#x90E8;&#x8FDB;&#x884C;&#x8C03;&#x8BD5;&#x3002;</li>
</ol>
</li>
<li><ol start="4">
<li>&#x5355;&#x6B65;&#x8DF3;&#x51FA;&#xFF08;Shift + F11&#xFF09;&#xFF1A;&#x70B9;&#x51FB;&#x540E;&#x8DF3;&#x51FA;&#x5F53;&#x524D;&#x8C03;&#x8BD5;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x4E0E;&#x5355;&#x6B65;&#x8C03;&#x8BD5;&#x5BF9;&#x5E94;&#x3002;</li>
</ol>
</li>
<li><ol start="5">
<li>&#x91CD;&#x542F;&#xFF08;Ctrl + Shift + F5&#xFF09;&#xFF1A;&#x987E;&#x540D;&#x601D;&#x4E49;&#x3002;</li>
</ol>
</li>
<li><ol start="6">
<li>&#x65AD;&#x5F00;&#x94FE;&#x63A5;&#xFF08;Shift + F5&#xFF09;&#xFF1A;&#x987E;&#x540D;&#x601D;&#x4E49;&#x3002;</li>
</ol>
</li>
</ul>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x8DDF;&#x7740;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x5B66;&#x6E90;&#x7801;&#x3002;</p>
<ol start="3">
<li>&#x8DDF;&#x7740;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x5B66;&#x6E90;&#x7801;</li>
</ol>
<hr>
<p>&#x5206;&#x4EAB;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x5C0F;&#x6280;&#x5DE7;&#xFF1A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x5904;&#x52A0;&#x4E0A;<code>only</code>&#x4FEE;&#x9970;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F8B;&#x5982;</span><br><span class="line">it.only(&apos;should work&apos;, async () =&gt; {})</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x53EA;&#x6267;&#x884C;&#x5F53;&#x524D;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#xFF0C;&#x4E0D;&#x5173;&#x5FC3;&#x5176;&#x4ED6;&#x7684;&#xFF0C;&#x4E0D;&#x4F1A;&#x5E72;&#x6270;&#x8C03;&#x8BD5;&#x3002;</p>
<h3 id="3-1-&#x6B63;&#x5E38;&#x6D41;&#x7A0B;"><a href="#3-1-&#x6B63;&#x5E38;&#x6D41;&#x7A0B;" class="headerlink" title="3.1 &#x6B63;&#x5E38;&#x6D41;&#x7A0B;"></a>3.1 &#x6B63;&#x5E38;&#x6D41;&#x7A0B;</h3><p>&#x6253;&#x5F00; <code>compose/test/test.js</code> &#x6587;&#x4EF6;&#xFF0C;&#x770B;&#x7B2C;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// compose/test/test.js</span><br><span class="line">&apos;use strict&apos;</span><br><span class="line"></span><br><span class="line">/* eslint-env jest */</span><br><span class="line"></span><br><span class="line">const compose = require(&apos;..&apos;)</span><br><span class="line">const assert = require(&apos;assert&apos;)</span><br><span class="line"></span><br><span class="line">function wait (ms) {</span><br><span class="line">  return new Promise((resolve) =&gt; setTimeout(resolve, ms || 1))</span><br><span class="line">}</span><br><span class="line">// &#x5206;&#x7EC4;</span><br><span class="line">describe(&apos;Koa Compose&apos;, function () {</span><br><span class="line">  it.only(&apos;should work&apos;, async () =&gt; {</span><br><span class="line">    const arr = []</span><br><span class="line">    const stack = []</span><br><span class="line"></span><br><span class="line">    stack.push(async (context, next) =&gt; {</span><br><span class="line">      arr.push(1)</span><br><span class="line">      await wait(1)</span><br><span class="line">      await next()</span><br><span class="line">      await wait(1)</span><br><span class="line">      arr.push(6)</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    stack.push(async (context, next) =&gt; {</span><br><span class="line">      arr.push(2)</span><br><span class="line">      await wait(1)</span><br><span class="line">      await next()</span><br><span class="line">      await wait(1)</span><br><span class="line">      arr.push(5)</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    stack.push(async (context, next) =&gt; {</span><br><span class="line">      arr.push(3)</span><br><span class="line">      await wait(1)</span><br><span class="line">      await next()</span><br><span class="line">      await wait(1)</span><br><span class="line">      arr.push(4)</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line">    await compose(stack)({})</span><br><span class="line">    // &#x6700;&#x540E;&#x8F93;&#x51FA;&#x6570;&#x7EC4;&#x662F; [1,2,3,4,5,6]</span><br><span class="line">    expect(arr).toEqual(expect.arrayContaining([1, 2, 3, 4, 5, 6]))</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5927;&#x6982;&#x770B;&#x5B8C;&#x8FD9;&#x6BB5;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#xFF0C;<code>context</code>&#x662F;&#x4EC0;&#x4E48;&#xFF0C;<code>next</code>&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x3002;</p>
<p>&#x5728;<a href="/external_links/0d8f156089e3d3770eb1cac7f5a83517.html" target="blank" rel="noopener"><code>koa</code>&#x7684;&#x6587;&#x6863;</a>&#x4E0A;&#x6709;&#x4E2A;&#x975E;&#x5E38;&#x4EE3;&#x8868;&#x6027;&#x7684;&#x4E2D;&#x95F4;&#x4EF6; <code>gif</code> &#x56FE;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/3170184086b74b5c6a680daccf773fedf053f1789a63f247c412acdcd34147af" alt="&#x4E2D;&#x95F4;&#x4EF6; gif &#x56FE;"></p>
<p>&#x800C;<code>compose</code>&#x51FD;&#x6570;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x628A;&#x6DFB;&#x52A0;&#x8FDB;&#x4E2D;&#x95F4;&#x4EF6;&#x6570;&#x7EC4;&#x7684;&#x51FD;&#x6570;&#x6309;&#x7167;&#x4E0A;&#x9762; <code>gif</code> &#x56FE;&#x7684;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x3002;</p>
<h4 id="3-1-1-compose-&#x51FD;&#x6570;"><a href="#3-1-1-compose-&#x51FD;&#x6570;" class="headerlink" title="3.1.1 compose &#x51FD;&#x6570;"></a>3.1.1 compose &#x51FD;&#x6570;</h4><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;<code>compose</code> &#x51FD;&#x6570;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E24;&#x4EF6;&#x4E8B;&#x60C5;&#x3002;</p>
<ul>
<li><ol>
<li>&#x63A5;&#x6536;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x6821;&#x9A8C;&#x53C2;&#x6570;&#x662F;&#x6570;&#x7EC4;&#xFF0C;&#x4E14;&#x6821;&#x9A8C;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x9879;&#x662F;&#x51FD;&#x6570;&#x3002;</li>
</ol>
</li>
<li><ol start="2">
<li>&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x63A5;&#x6536;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5206;&#x522B;&#x662F;<code>context</code>&#x548C;<code>next</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6700;&#x540E;&#x8FD4;&#x56DE;<code>Promise</code>&#x3002;</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line"> * Compose `middleware` returning</span><br><span class="line"> * a fully valid middleware comprised</span><br><span class="line"> * of all those which are passed.</span><br><span class="line"> *</span><br><span class="line"> * @param {Array} middleware</span><br><span class="line"> * @return {Function}</span><br><span class="line"> * @api public</span><br><span class="line"> */</span><br><span class="line">function compose (middleware) {</span><br><span class="line">  // &#x6821;&#x9A8C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x6570;&#x7EC4;&#xFF0C;&#x6821;&#x9A8C;&#x6570;&#x7EC4;&#x4E2D;&#x6BCF;&#x4E00;&#x9879;&#x662F;&#x51FD;&#x6570;</span><br><span class="line">  if (!Array.isArray(middleware)) throw new TypeError(&apos;Middleware stack must be an array!&apos;)</span><br><span class="line">  for (const fn of middleware) {</span><br><span class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;Middleware must be composed of functions!&apos;)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @param {Object} context</span><br><span class="line">   * @return {Promise}</span><br><span class="line">   * @api public</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  return function (context, next) {</span><br><span class="line">    // last called middleware #</span><br><span class="line">    let index = -1</span><br><span class="line">    return dispatch(0)</span><br><span class="line">    function dispatch(i){</span><br><span class="line">      // &#x7701;&#x7565;&#xFF0C;&#x4E0B;&#x6587;&#x8BB2;&#x8FF0;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x6765;&#x770B; <code>dispatch</code> &#x51FD;&#x6570;&#x3002;</p>
<h4 id="3-1-2-dispatch-&#x51FD;&#x6570;"><a href="#3-1-2-dispatch-&#x51FD;&#x6570;" class="headerlink" title="3.1.2 dispatch &#x51FD;&#x6570;"></a>3.1.2 dispatch &#x51FD;&#x6570;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;function dispatch (i) {</span><br><span class="line">  // &#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4E2D;&#x591A;&#x6B21;&#x8C03;&#x7528;&#x62A5;&#x9519;</span><br><span class="line">  // await next()</span><br><span class="line">  // await next()</span><br><span class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">  index = i</span><br><span class="line">  // &#x53D6;&#x51FA;&#x6570;&#x7EC4;&#x91CC;&#x7684; fn1, fn2, fn3...</span><br><span class="line">  let fn = middleware[i]</span><br><span class="line">  // &#x6700;&#x540E; &#x76F8;&#x7B49;&#xFF0C;next &#x4E3A; undefined</span><br><span class="line">  if (i === middleware.length) fn = next</span><br><span class="line">  // &#x76F4;&#x63A5;&#x8FD4;&#x56DE; Promise.resolve()</span><br><span class="line">  if (!fn) return Promise.resolve()</span><br><span class="line">  try {</span><br><span class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)))</span><br><span class="line">  } catch (err) {</span><br><span class="line">    return Promise.reject(err)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x503C;&#x5F97;&#x4E00;&#x63D0;&#x7684;&#x662F;&#xFF1A;<code>bind</code>&#x51FD;&#x6570;&#x662F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x51FD;&#x6570;&#x3002;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x51FD;&#x6570;&#x91CC;&#x7684;this&#x6307;&#x5411;&#xFF08;&#x5982;&#x679C;&#x51FD;&#x6570;&#x4E0D;&#x9700;&#x8981;&#x4F7F;&#x7528;<code>this</code>&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x5199;&#x6210;<code>null</code>&#xFF09;&#x3002;<br>&#x8FD9;&#x53E5;<code>fn(context, dispatch.bind(null, i + 1)</code>&#xFF0C;<code>i + 1</code> &#x662F;&#x4E3A;&#x4E86; <code>let fn = middleware[i]</code> &#x53D6;<code>middleware</code>&#x4E2D;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x3002;<br>&#x4E5F;&#x5C31;&#x662F; <code>next</code> &#x662F;&#x4E0B;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#x91CC;&#x7684;&#x51FD;&#x6570;&#x3002;&#x4E5F;&#x5C31;&#x80FD;&#x89E3;&#x91CA;&#x4E0A;&#x6587;&#x4E2D;&#x7684; <code>gif</code>&#x56FE;&#x51FD;&#x6570;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x3002;<br>&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x4E2D;&#x6570;&#x7EC4;&#x7684;&#x6700;&#x7EC8;&#x987A;&#x5E8F;&#x662F;<code>[1,2,3,4,5,6]</code>&#x3002;</p>
<h4 id="3-1-3-&#x7B80;&#x5316;-compose-&#x4FBF;&#x4E8E;&#x7406;&#x89E3;"><a href="#3-1-3-&#x7B80;&#x5316;-compose-&#x4FBF;&#x4E8E;&#x7406;&#x89E3;" class="headerlink" title="3.1.3 &#x7B80;&#x5316; compose &#x4FBF;&#x4E8E;&#x7406;&#x89E3;"></a>3.1.3 &#x7B80;&#x5316; compose &#x4FBF;&#x4E8E;&#x7406;&#x89E3;</h4><p>&#x81EA;&#x5DF1;&#x52A8;&#x624B;&#x8C03;&#x8BD5;&#x4E4B;&#x540E;&#xFF0C;&#x4F60;&#x4F1A;&#x53D1;&#x73B0; <code>compose</code> &#x6267;&#x884C;&#x540E;&#x5C31;&#x662F;&#x7C7B;&#x4F3C;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x6784;&#xFF08;&#x7701;&#x7565; <code>try catch</code> &#x5224;&#x65AD;&#xFF09;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x80FD;&#x66F4;&#x597D;&#x7406;&#x89E3;&#x4E86;&#x3002;</span><br><span class="line">// simpleKoaCompose</span><br><span class="line">const [fn1, fn2, fn3] = stack;</span><br><span class="line">const fnMiddleware = function(context){</span><br><span class="line">    return Promise.resolve(</span><br><span class="line">      fn1(context, function next(){</span><br><span class="line">        return Promise.resolve(</span><br><span class="line">          fn2(context, function next(){</span><br><span class="line">              return Promise.resolve(</span><br><span class="line">                  fn3(context, function next(){</span><br><span class="line">                    return Promise.resolve();</span><br><span class="line">                  })</span><br><span class="line">              )</span><br><span class="line">          })</span><br><span class="line">        )</span><br><span class="line">    })</span><br><span class="line">  );</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;<code>koa-compose</code>&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;<code>Promise</code>&#xFF0C;&#x4ECE;<code>&#x4E2D;&#x95F4;&#x4EF6;&#xFF08;&#x4F20;&#x5165;&#x7684;&#x6570;&#x7EC4;&#xFF09;</code>&#x4E2D;&#x53D6;&#x51FA;&#x7B2C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;<code>context</code>&#x548C;&#x7B2C;&#x4E00;&#x4E2A;<code>next</code>&#x51FD;&#x6570;&#x6765;&#x6267;&#x884C;&#x3002;  </p>
<p>&#x7B2C;&#x4E00;&#x4E2A;<code>next</code>&#x51FD;&#x6570;&#x91CC;&#x4E5F;&#x662F;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;<code>Promise</code>&#xFF0C;&#x4ECE;<code>&#x4E2D;&#x95F4;&#x4EF6;&#xFF08;&#x4F20;&#x5165;&#x7684;&#x6570;&#x7EC4;&#xFF09;</code>&#x4E2D;&#x53D6;&#x51FA;&#x7B2C;&#x4E8C;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;<code>context</code>&#x548C;&#x7B2C;&#x4E8C;&#x4E2A;<code>next</code>&#x51FD;&#x6570;&#x6765;&#x6267;&#x884C;&#x3002;  </p>
<p>&#x7B2C;&#x4E8C;&#x4E2A;<code>next</code>&#x51FD;&#x6570;&#x91CC;&#x4E5F;&#x662F;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;<code>Promise</code>&#xFF0C;&#x4ECE;<code>&#x4E2D;&#x95F4;&#x4EF6;&#xFF08;&#x4F20;&#x5165;&#x7684;&#x6570;&#x7EC4;&#xFF09;</code>&#x4E2D;&#x53D6;&#x51FA;&#x7B2C;&#x4E09;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;<code>context</code>&#x548C;&#x7B2C;&#x4E09;&#x4E2A;<code>next</code>&#x51FD;&#x6570;&#x6765;&#x6267;&#x884C;&#x3002;  </p>
<p>&#x7B2C;&#x4E09;&#x4E2A;&#x2026;  </p>
<p>&#x4EE5;&#x6B64;&#x7C7B;&#x63A8;&#x3002;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#x4E2D;&#x6709;&#x8C03;&#x7528;<code>next</code>&#x51FD;&#x6570;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;<code>Promise.resolve</code>&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x5219;&#x4E0D;&#x6267;&#x884C;<code>next</code>&#x51FD;&#x6570;&#x3002;<br>&#x8FD9;&#x6837;&#x5C31;&#x628A;&#x6240;&#x6709;&#x4E2D;&#x95F4;&#x4EF6;&#x4E32;&#x8054;&#x8D77;&#x6765;&#x4E86;&#x3002;&#x8FD9;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5E38;&#x8BF4;&#x7684;&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x3002;</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e50b9662d5e259e5e5f1c5997349d2d0ce7d78793a336d97f42afd569517f67a" alt="&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x56FE;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;"></p>
<p><strong>&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#x975E;&#x5E38;&#x60CA;&#x8273;&#xFF0C;&#x201C;&#x73A9;&#x8FD8;&#x662F;&#x5927;&#x795E;&#x4F1A;&#x73A9;&#x201D;</strong>&#x3002;</p>
<h3 id="3-2-&#x9519;&#x8BEF;&#x6355;&#x83B7;"><a href="#3-2-&#x9519;&#x8BEF;&#x6355;&#x83B7;" class="headerlink" title="3.2 &#x9519;&#x8BEF;&#x6355;&#x83B7;"></a>3.2 &#x9519;&#x8BEF;&#x6355;&#x83B7;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;it(&apos;should catch downstream errors&apos;, async () =&gt; {</span><br><span class="line">  const arr = []</span><br><span class="line">  const stack = []</span><br><span class="line"></span><br><span class="line">  stack.push(async (ctx, next) =&gt; {</span><br><span class="line">    arr.push(1)</span><br><span class="line">    try {</span><br><span class="line">      arr.push(6)</span><br><span class="line">      await next()</span><br><span class="line">      arr.push(7)</span><br><span class="line">    } catch (err) {</span><br><span class="line">      arr.push(2)</span><br><span class="line">    }</span><br><span class="line">    arr.push(3)</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  stack.push(async (ctx, next) =&gt; {</span><br><span class="line">    arr.push(4)</span><br><span class="line">    throw new Error()</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  await compose(stack)({})</span><br><span class="line">  // &#x8F93;&#x51FA;&#x987A;&#x5E8F; &#x662F; [ 1, 6, 4, 2, 3 ]</span><br><span class="line">  expect(arr).toEqual([1, 6, 4, 2, 3])</span><br><span class="line">})</span><br></pre></td></tr></table></figure>

<p>&#x76F8;&#x4FE1;&#x7406;&#x89E3;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x548C; <code>compose</code> &#x51FD;&#x6570;&#xFF0C;&#x4E5F;&#x662F;&#x6BD4;&#x8F83;&#x597D;&#x7406;&#x89E3;&#x8FD9;&#x4E2A;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x4E86;&#x3002;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7801;&#x5728;&#x8FD9;&#x91CC;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;try {</span><br><span class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)))</span><br><span class="line">} catch (err) {</span><br><span class="line">  return Promise.reject(err)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-next-&#x51FD;&#x6570;&#x4E0D;&#x80FD;&#x8C03;&#x7528;&#x591A;&#x6B21;"><a href="#3-3-next-&#x51FD;&#x6570;&#x4E0D;&#x80FD;&#x8C03;&#x7528;&#x591A;&#x6B21;" class="headerlink" title="3.3 next &#x51FD;&#x6570;&#x4E0D;&#x80FD;&#x8C03;&#x7528;&#x591A;&#x6B21;"></a>3.3 next &#x51FD;&#x6570;&#x4E0D;&#x80FD;&#x8C03;&#x7528;&#x591A;&#x6B21;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;it(&apos;should throw if next() is called multiple times&apos;, () =&gt; {</span><br><span class="line">  return compose([</span><br><span class="line">    async (ctx, next) =&gt; {</span><br><span class="line">      await next()</span><br><span class="line">      await next()</span><br><span class="line">    }</span><br><span class="line">  ])({}).then(() =&gt; {</span><br><span class="line">    throw new Error(&apos;boom&apos;)</span><br><span class="line">  }, (err) =&gt; {</span><br><span class="line">    assert(/multiple times/.test(err.message))</span><br><span class="line">  })</span><br><span class="line">})</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x4E00;&#x5757;&#x5BF9;&#x5E94;&#x7684;&#x5219;&#x662F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;index = -1</span><br><span class="line">dispatch(0)</span><br><span class="line">function dispatch (i) {</span><br><span class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</span><br><span class="line">  index = i</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8C03;&#x7528;&#x4E24;&#x6B21;&#x540E; <code>i</code> &#x548C; <code>index</code> &#x90FD;&#x4E3A; <code>1</code>&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x62A5;&#x9519;&#x3002;</p>
<p><code>compose/test/test.js</code>&#x6587;&#x4EF6;&#x4E2D;&#x603B;&#x5171; 300&#x4F59;&#x884C;&#xFF0C;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x6587;&#x4E2D;&#x65B9;&#x6CD5;&#x81EA;&#x884C;&#x8C03;&#x8BD5;&#x3002;</p>
<ol start="4">
<li>&#x603B;&#x7ED3;</li>
</ol>
<hr>
<p>&#x867D;&#x7136;<code>koa-compose</code>&#x6E90;&#x7801; 50&#x884C; &#x4E0D;&#x5230;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x662F;&#x7B2C;&#x4E00;&#x6B21;&#x770B;&#x6E90;&#x7801;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#xFF0C;&#x8FD8;&#x662F;&#x4F1A;&#x6709;&#x96BE;&#x5EA6;&#x7684;&#x3002;&#x5176;&#x4E2D;&#x6DF7;&#x6742;&#x7740;&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x3001;&#x95ED;&#x5305;&#x3001;<code>Promise</code>&#x3001;<code>bind</code>&#x7B49;&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x672C;&#x6587;&#xFF0C;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x4E86; <code>koa-compose</code> &#x4E2D;&#x95F4;&#x4EF6;&#x5E38;&#x8BF4;&#x7684;&#x6D0B;&#x8471;&#x6A21;&#x578B;&#xFF0C;&#x5B66;&#x4F1A;&#x4E86;&#x90E8;&#x5206; <a href="/external_links/e9eea0b1d16f6fb760d90cb899d70a3c.html" target="blank" rel="noopener"><code>jest</code></a> &#x7528;&#x6CD5;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x5B66;&#x4F1A;&#x4E86;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x73B0;&#x6210;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x53BB;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#x3002;</p>
<p><strong>&#x76F8;&#x4FE1;&#x5B66;&#x4F1A;&#x4E86;&#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#x540E;&#xFF0C;&#x4F1A;&#x89C9;&#x5F97;&#x6E90;&#x7801;&#x4E5F;&#x6CA1;&#x6709;&#x60F3;&#x8C61;&#x4E2D;&#x7684;&#x90A3;&#x4E48;&#x96BE;</strong>&#x3002;</p>
<p>&#x5F00;&#x6E90;&#x9879;&#x76EE;&#xFF0C;&#x4E00;&#x822C;&#x90FD;&#x4F1A;&#x6709;&#x5F88;&#x5168;&#x9762;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x3002;&#x9664;&#x4E86;&#x53EF;&#x4EE5;&#x7ED9;&#x6211;&#x4EEC;&#x5B66;&#x4E60;&#x6E90;&#x7801;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#x5E26;&#x6765;&#x65B9;&#x4FBF;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7ED9;&#x6211;&#x4EEC;&#x5E26;&#x6765;&#x7684;&#x542F;&#x53D1;&#xFF1A;&#x81EA;&#x5DF1;&#x5DE5;&#x4F5C;&#x4E2D;&#x7684;&#x9879;&#x76EE;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x9010;&#x6B65;&#x5F15;&#x5165;&#x6D4B;&#x8BD5;&#x5DE5;&#x5177;&#xFF0C;&#x6BD4;&#x5982; <a href="/external_links/e9eea0b1d16f6fb760d90cb899d70a3c.html" target="blank" rel="noopener"><code>jest</code></a>&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x8BFB;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x6E90;&#x7801;&#x662F;&#x6211;&#x4EEC;&#x5B66;&#x4E60;&#x4E1A;&#x754C;&#x5927;&#x725B;&#x8BBE;&#x8BA1;&#x601D;&#x60F3;&#x548C;&#x6E90;&#x7801;&#x5B9E;&#x73B0;&#x7B49;&#x6BD4;&#x8F83;&#x597D;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x770B;&#x5B8C;&#x672C;&#x6587;&#xFF0C;&#x975E;&#x5E38;&#x5E0C;&#x671B;&#x80FD;&#x81EA;&#x5DF1;&#x52A8;&#x624B;&#x5B9E;&#x8DF5;&#x8C03;&#x8BD5;&#x6E90;&#x7801;&#x53BB;&#x5B66;&#x4E60;&#xFF0C;&#x5BB9;&#x6613;&#x5438;&#x6536;&#x6D88;&#x5316;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x6709;&#x4F59;&#x529B;&#xFF0C;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x770B;&#x6211;&#x7684; <code>koa-compose</code> &#x6E90;&#x7801;&#x6587;&#x7AE0;&#xFF1A;<a href="https://dev.newban.cn/6844904088220467213">&#x5B66;&#x4E60; koa &#x6E90;&#x7801;&#x7684;&#x6574;&#x4F53;&#x67B6;&#x6784;&#xFF0C;&#x6D45;&#x6790;koa&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x539F;&#x7406;&#x548C;co&#x539F;&#x7406;</a></p>
<p>&#x6700;&#x540E;&#x6B22;&#x8FCE;&#x52A0;&#x6211;&#x5FAE;&#x4FE1; <a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener">ruochuan12</a> &#x4EA4;&#x6D41;&#xFF0C;&#x53C2;&#x4E0E; <a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener">&#x6E90;&#x7801;&#x5171;&#x8BFB;</a> &#x6D3B;&#x52A8;&#xFF0C;&#x5927;&#x5BB6;&#x4E00;&#x8D77;&#x5B66;&#x4E60;&#x6E90;&#x7801;&#xFF0C;&#x5171;&#x540C;&#x8FDB;&#x6B65;&#x3002;</p>
<hr>
<h2 id="&#x5173;&#x4E8E;-amp-amp-&#x4EA4;&#x6D41;&#x7FA4;"><a href="#&#x5173;&#x4E8E;-amp-amp-&#x4EA4;&#x6D41;&#x7FA4;" class="headerlink" title="&#x5173;&#x4E8E; &amp;&amp; &#x4EA4;&#x6D41;&#x7FA4;"></a>&#x5173;&#x4E8E; &amp;&amp; &#x4EA4;&#x6D41;&#x7FA4;</h2><p>&#x6700;&#x8FD1;&#x7EC4;&#x7EC7;&#x4E86;<a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener"><strong>&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x6D3B;&#x52A8;</strong></a>&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x52A0;&#x6211;&#x5FAE;&#x4FE1; <a href="/external_links/543e99fafefff82a874bf6079191c64f.html" target="blank" rel="noopener">ruochuan12</a> &#x53C2;&#x4E0E;&#xFF0C;&#x957F;&#x671F;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#x3002;</p>
<p>&#x4F5C;&#x8005;&#xFF1A;&#x5E38;&#x4EE5;<strong>&#x82E5;&#x5DDD;</strong>&#x4E3A;&#x540D;&#x6DF7;&#x8FF9;&#x4E8E;&#x6C5F;&#x6E56;&#x3002;&#x6B22;&#x8FCE;&#x52A0;&#x6211;&#x5FAE;&#x4FE1;<code>ruochuan12</code>&#x3002;&#x524D;&#x7AEF;&#x8DEF;&#x4E0A; | &#x6240;&#x77E5;&#x751A;&#x5C11;&#xFF0C;&#x552F;&#x5584;&#x5B66;&#x3002;  </p>
<p><a href="/external_links/b71f781539ee782c62d55f94d7a81dc5.html" target="blank" rel="noopener">&#x5173;&#x6CE8;&#x516C;&#x4F17;&#x53F7;&#x82E5;&#x5DDD;&#x89C6;&#x91CE;</a>&#xFF0C;&#x6BCF;&#x5468;&#x4E00;&#x8D77;&#x5B66;&#x6E90;&#x7801;&#xFF0C;&#x5B66;&#x4F1A;&#x770B;&#x6E90;&#x7801;&#xFF0C;&#x8FDB;&#x9636;&#x9AD8;&#x7EA7;&#x524D;&#x7AEF;&#x3002;  </p>
<p><a href="/external_links/12e94b0eb6e065b6200852afcc62d01b.html" target="blank" rel="noopener">&#x82E5;&#x5DDD;&#x7684;&#x535A;&#x5BA2;</a>  </p>
<p><a href="/external_links/475d7a8029ffd100531bc36509c3041f.html" target="blank" rel="noopener"><code>segmentfault</code>&#x82E5;&#x5DDD;&#x89C6;&#x91CE;&#x4E13;&#x680F;</a>&#xFF0C;&#x5F00;&#x901A;&#x4E86;<strong>&#x82E5;&#x5DDD;&#x89C6;&#x91CE;</strong>&#x4E13;&#x680F;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;~  </p>
<p><a href="/external_links/3262cef29eeade0b92ad2508b72e962d.html" target="blank" rel="noopener">&#x6398;&#x91D1;&#x4E13;&#x680F;</a>&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;~  </p>
<p><a href="/external_links/475d7a8029ffd100531bc36509c3041f.html" target="blank" rel="noopener">&#x77E5;&#x4E4E;&#x82E5;&#x5DDD;&#x89C6;&#x91CE;&#x4E13;&#x680F;</a>&#xFF0C;&#x5F00;&#x901A;&#x4E86;<strong>&#x82E5;&#x5DDD;&#x89C6;&#x91CE;</strong>&#x4E13;&#x680F;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;~  </p>
<p><a href="/external_links/475d7a8029ffd100531bc36509c3041f.html" target="blank" rel="noopener">github blog</a>&#xFF0C;&#x6C42;&#x4E2A;<code>star</code>^_^~</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/c6500a62b3033da27422c871cdf53e82.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7005073093899403294.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7005073093899403294.html" itemprop="url">SpringBoot整合Spring Data Elasti</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-07T14:21:24+08:00">
                2021-09-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x672C;&#x6587;&#x8BB2;&#x8FF0;&#x4E86;<code>SpringBoot</code>&#x6574;&#x5408;<code>Spring Data Elasticsearch</code>&#x7684;&#x8BE6;&#x7EC6;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x4E86;<code>ElasticsearchRestTemplate&#x3001;ElasticsearchRepository</code>&#x7B49;&#x7C7B;&#x6765;&#x5B9E;&#x73B0;<code>Index</code>&#x3001;<code>Document</code>CRUD&#x64CD;&#x4F5C;&#x7684;Java Api&#x3002;</p>
<p>&#x5728;&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x9700;&#x8981;&#x9009;&#x62E9;Es&#x5BF9;&#x5E94;&#x7248;&#x672C;&#x7684;jar&#x5305;&#xFF0C;&#x672C;&#x6587;&#x6240;&#x4F7F;&#x7528;&#x7684;Es&#x7248;&#x672C;&#x4E3A;7.9.3&#xFF0C;&#x67E5;&#x770B;spring&#x5B98;&#x7F51;&#x53EF;&#x77E5;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;springboot&#x7248;&#x672C;&#x4E3A;2.4.x&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/59ffa69b8b714f69947b41f8dadec1edc0b73523861237f10f117151085f8fda" alt="image.png"></p>
<h2 id="&#x6574;&#x5408;"><a href="#&#x6574;&#x5408;" class="headerlink" title="&#x6574;&#x5408;"></a>&#x6574;&#x5408;</h2><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;maven&#x9879;&#x76EE;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x64CD;&#x4F5C;&#x8D77;&#x6765;&#x4E86;&#x3002;</p>
<h3 id="&#x914D;&#x7F6E;"><a href="#&#x914D;&#x7F6E;" class="headerlink" title="&#x914D;&#x7F6E;"></a>&#x914D;&#x7F6E;</h3><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><p>&#x5F15;&#x5165;&#x4EE5;&#x4E0B;jar&#x5305;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.4.0&lt;/version&gt;</span><br><span class="line">    &lt;relativePath/&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.18.12&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;compile&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.71&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;spring.data.elasticsearch.repositories.enabled = true</span><br><span class="line">spring.elasticsearch.rest.uris=localhost:9200</span><br></pre></td></tr></table></figure>

<h4 id="ElasticsearchRestTemplate&#x914D;&#x7F6E;"><a href="#ElasticsearchRestTemplate&#x914D;&#x7F6E;" class="headerlink" title="ElasticsearchRestTemplate&#x914D;&#x7F6E;"></a>ElasticsearchRestTemplate&#x914D;&#x7F6E;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&#x590D;&#x5236;&#x4EE3;&#x7801;@Configuration</span><br><span class="line">public class ElasticsearchRestTemplateConfig extends AbstractElasticsearchConfiguration {</span><br><span class="line">    @Value(&quot;${spring.elasticsearch.rest.uris}&quot;)</span><br><span class="line">    private String uris;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public RestHighLevelClient elasticsearchClient() {</span><br><span class="line">        ClientConfiguration configuration = ClientConfiguration.builder()</span><br><span class="line">                .connectedTo(uris)</span><br><span class="line">                .build();</span><br><span class="line">        return RestClients.create(configuration).rest();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x4EE3;&#x7801;"><a href="#&#x4EE3;&#x7801;" class="headerlink" title="&#x4EE3;&#x7801;"></a>&#x4EE3;&#x7801;</h3><h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><p>Model&#x7C7B;&#x4F3C;&#x4E8E;&#x6570;&#x636E;&#x5E93;&#x5B9E;&#x4F53;&#xFF0C;&#x4E0D;&#x8FC7;&#x6B64;&#x5904;&#x6240;&#x6620;&#x5C04;&#x7684;&#x662F;Index&#x548C;Document&#x7684;&#x5B57;&#x6BB5;&#x3002;&#x6CE8;&#x89E3;&#x542B;&#x4E49;&#x53EF;&#x67E5;&#x770B;<a href="/external_links/7eb5536b58156989af9ec190f658276b.html" target="blank" rel="noopener">Spring&#x5B98;&#x7F51;</a>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Data</span><br><span class="line">@Document(indexName = &quot;order&quot;, shards = 1, replicas = 1)</span><br><span class="line">public class Order implements Serializable {</span><br><span class="line">    @Id</span><br><span class="line">    private Integer id;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Keyword)</span><br><span class="line">    private Long orderNo;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Integer)</span><br><span class="line">    private Integer orderType;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Long)</span><br><span class="line">    private Long orderAmount;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Text, analyzer = &quot;ik_smart&quot;, searchAnalyzer = &quot;ik_max_word&quot;)</span><br><span class="line">    private String orderDesc;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Keyword, analyzer = &quot;ik_smart&quot;, searchAnalyzer = &quot;ik_max_word&quot;)</span><br><span class="line">    private String username;</span><br><span class="line"></span><br><span class="line">    @Field(type = FieldType.Keyword, analyzer = &quot;ik_smart&quot;, searchAnalyzer = &quot;ik_max_word&quot;)</span><br><span class="line">    private String userPhone;</span><br><span class="line"></span><br><span class="line">    private Map&lt;String, List&lt;String&gt;&gt; highlights;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h4><p>ElasticsearchRepository&#x63A5;&#x53E3;&#x5C01;&#x88C5;&#x4E86;Document&#x7684;CRUD&#x64CD;&#x4F5C;&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x5B9A;&#x4E49;&#x63A5;&#x53E3;&#x7EE7;&#x627F;&#x5B83;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;public interface OrderRepository extends ElasticsearchRepository&lt;Order, Integer&gt; {</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;public interface OrderService {</span><br><span class="line">    void saveAll(List&lt;Order&gt; orders);</span><br><span class="line"></span><br><span class="line">    Order findById(Integer id);</span><br><span class="line"></span><br><span class="line">    void deleteById(Integer id);</span><br><span class="line"></span><br><span class="line">    void updateById(Order order);</span><br><span class="line"></span><br><span class="line">    PageResponse&lt;Order&gt; findList(Order order, Integer pageIndex, Integer pageSize);</span><br><span class="line"></span><br><span class="line">    PageResponse&lt;Order&gt; findAll(Integer pageIndex, Integer pageSize);</span><br><span class="line"></span><br><span class="line">    PageResponse&lt;Order&gt; findHighlight(Order order, Integer pageIndex, Integer pageSize);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl implements OrderService {</span><br><span class="line">    @Autowired</span><br><span class="line">    OrderRepository orderRepository;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void saveAll(List&lt;Order&gt; orders) {</span><br><span class="line">        orderRepository.saveAll(orders);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void deleteById(Integer id) {</span><br><span class="line">        orderRepository.deleteById(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void updateById(Order order) {</span><br><span class="line">        orderRepository.save(order);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public PageResponse&lt;Order&gt; findList(Order order, Integer pageIndex, Integer pageSize) {</span><br><span class="line">        CriteriaQuery criteriaQuery = new CriteriaQuery(new Criteria()</span><br><span class="line">                .and(new Criteria(&quot;orderDesc&quot;).contains(order.getOrderDesc()))</span><br><span class="line">                .and(new Criteria(&quot;orderNo&quot;).is(order.getOrderNo())))</span><br><span class="line">                .setPageable(PageRequest.of(pageIndex, pageSize));</span><br><span class="line"></span><br><span class="line">        SearchHits&lt;Order&gt; searchHits = elasticsearchRestTemplate.search(criteriaQuery, Order.class);</span><br><span class="line">        List&lt;Order&gt; result = searchHits.get().map(SearchHit::getContent).collect(Collectors.toList());</span><br><span class="line">        PageResponse&lt;Order&gt; pageResponse = new PageResponse&lt;Order&gt;();</span><br><span class="line">        pageResponse.setTotal(searchHits.getTotalHits());</span><br><span class="line">        pageResponse.setResult(result);</span><br><span class="line">        return pageResponse;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public PageResponse&lt;Order&gt; findAll(Integer pageIndex, Integer pageSize) {</span><br><span class="line">        Page&lt;Order&gt; page = orderRepository.findAll(PageRequest.of(pageIndex, pageSize));</span><br><span class="line"></span><br><span class="line">        PageResponse&lt;Order&gt; pageResponse = new PageResponse&lt;Order&gt;();</span><br><span class="line">        pageResponse.setTotal(page.getTotalElements());</span><br><span class="line">        pageResponse.setResult(page.getContent());</span><br><span class="line">        return pageResponse;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public PageResponse&lt;Order&gt; findHighlight(Order order, Integer pageIndex, Integer pageSize) {</span><br><span class="line">        if (order == null) {</span><br><span class="line">            PageResponse&lt;Order&gt; pageResponse = new PageResponse&lt;Order&gt;();</span><br><span class="line">            pageResponse.setTotal(0L);</span><br><span class="line">            pageResponse.setResult(new ArrayList&lt;&gt;());</span><br><span class="line">            return pageResponse;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        CriteriaQuery criteriaQuery = new CriteriaQuery(new Criteria()</span><br><span class="line">                .and(new Criteria(&quot;orderNo&quot;).is(order.getOrderNo()))</span><br><span class="line">                .and(new Criteria(&quot;orderDesc&quot;).contains(order.getOrderDesc())))</span><br><span class="line">                .setPageable(PageRequest.of(pageIndex, pageSize));</span><br><span class="line"></span><br><span class="line">        HighlightBuilder highlightBuilder = new HighlightBuilder();</span><br><span class="line">        highlightBuilder.field(&quot;orderNo&quot;).field(&quot;orderDesc&quot;);</span><br><span class="line">        highlightBuilder.requireFieldMatch(false);</span><br><span class="line">        highlightBuilder.preTags(&quot;&lt;h3 style=&quot;color:blue&quot;&gt;&quot;);</span><br><span class="line">        highlightBuilder.postTags(&quot;&lt;/h3&gt;&quot;);</span><br><span class="line"></span><br><span class="line">        HighlightQuery highlightQuery = new HighlightQuery(highlightBuilder);</span><br><span class="line">        criteriaQuery.setHighlightQuery(highlightQuery);</span><br><span class="line"></span><br><span class="line">        SearchHits&lt;Order&gt; searchHits = elasticsearchRestTemplate.search(criteriaQuery, Order.class);</span><br><span class="line"></span><br><span class="line">        List&lt;Order&gt; result = searchHits.get().map(e -&gt; {</span><br><span class="line">            Order element = e.getContent();</span><br><span class="line">            element.setHighlights(e.getHighlightFields());</span><br><span class="line">            return element;</span><br><span class="line">        }).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        PageResponse&lt;Order&gt; pageResponse = new PageResponse&lt;Order&gt;();</span><br><span class="line">        pageResponse.setTotal(searchHits.getTotalHits());</span><br><span class="line">        pageResponse.setResult(result);</span><br><span class="line">        return pageResponse;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Order findById(Integer id) {</span><br><span class="line">        return orderRepository.findById(id).orElse(null);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><ul>
<li>Index&#x64CD;&#x4F5C;<br>&#x4F7F;&#x7528;ElasticsearchRestTemplate&#x76F4;&#x63A5;&#x5C31;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x548C;&#x5220;&#x9664;&#x7D22;&#x5F15;&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RequestMapping(&quot;/index/&quot;)</span><br><span class="line">@RestController</span><br><span class="line">public class IndexController {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x521B;&#x5EFA;&#x7D22;&#x5F15;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;create&quot;)</span><br><span class="line">    public String create(@RequestParam String indexName) {</span><br><span class="line">        IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(IndexCoordinates.of(indexName));</span><br><span class="line">        if (indexOperations.exists()) {</span><br><span class="line">            return &quot;&#x7D22;&#x5F15;&#x5DF2;&#x5B58;&#x5728;&quot;;</span><br><span class="line">        }</span><br><span class="line">        indexOperations.create();</span><br><span class="line">        return &quot;&#x7D22;&#x5F15;&#x521B;&#x5EFA;&#x6210;&#x529F;&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x5220;&#x9664;&#x7D22;&#x5F15;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;delete&quot;)</span><br><span class="line">    public String delete(@RequestParam String indexName) {</span><br><span class="line">        IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(IndexCoordinates.of(indexName));</span><br><span class="line">        indexOperations.delete();</span><br><span class="line">        return &quot;&#x7D22;&#x5F15;&#x5220;&#x9664;&#x6210;&#x529F;&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>Document&#x64CD;&#x4F5C;<br>&#x4E3B;&#x8981;&#x5305;&#x62EC;&#x7B80;&#x5355;&#x67E5;&#x8BE2;&#x3001;&#x589E;&#x5220;&#x6539;&#x3001;&#x5206;&#x9875;&#x67E5;&#x8BE2;&#x3001;&#x9AD8;&#x4EAE;&#x641C;&#x7D22;&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RequestMapping(&quot;/doc/&quot;)</span><br><span class="line">@RestController</span><br><span class="line">public class DocController {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6279;&#x91CF;&#x521B;&#x5EFA;</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;saveBatch&quot;)</span><br><span class="line">    public String saveBatch(@RequestBody List&lt;Order&gt; orders) {</span><br><span class="line">        if (CollectionUtils.isEmpty(orders)) {</span><br><span class="line">            return &quot;&#x6587;&#x6863;&#x4E0D;&#x80FD;&#x4E3A;&#x7A7A;&quot;;</span><br><span class="line">        }</span><br><span class="line">        orderService.saveAll(orders);</span><br><span class="line">        return &quot;&#x4FDD;&#x5B58;&#x6210;&#x529F;&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6839;&#x636E;id&#x5220;&#x9664;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;deleteById&quot;)</span><br><span class="line">    public String deleteById(@RequestParam Integer id) {</span><br><span class="line">        orderService.deleteById(id);</span><br><span class="line">        return &quot;&#x5220;&#x9664;&#x6210;&#x529F;&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6839;&#x636E;id&#x66F4;&#x65B0;</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(&quot;updateById&quot;)</span><br><span class="line">    public String updateById(@RequestBody Order order) {</span><br><span class="line">        orderService.updateById(order);</span><br><span class="line">        return &quot;&#x66F4;&#x65B0;&#x6210;&#x529F;&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6839;&#x636E;id&#x641C;&#x7D22;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;findById&quot;)</span><br><span class="line">    public String findById(@RequestParam Integer id) {</span><br><span class="line">        return JSON.toJSONString(orderService.findById(id));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x5206;&#x9875;&#x641C;&#x7D22;&#x6240;&#x6709;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;findAll&quot;)</span><br><span class="line">    public String findAll(@RequestParam Integer pageIndex, @RequestParam Integer pageSize) {</span><br><span class="line">        return JSON.toJSONString(orderService.findAll(pageIndex, pageSize));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6761;&#x4EF6;&#x5206;&#x9875;&#x641C;&#x7D22;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;findList&quot;)</span><br><span class="line">    public String findList(@RequestBody Order order, @RequestParam Integer pageIndex, @RequestParam Integer pageSize) {</span><br><span class="line">        return JSON.toJSONString(orderService.findList(order, pageIndex, pageSize));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6761;&#x4EF6;&#x9AD8;&#x4EAE;&#x5206;&#x9875;&#x641C;&#x7D22;</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;findHighlight&quot;)</span><br><span class="line">    public String findHighlight(@RequestBody(required = false) Order order, @RequestParam Integer pageIndex, @RequestParam Integer pageSize) {</span><br><span class="line">        return JSON.toJSONString(orderService.findHighlight(order, pageIndex, pageSize));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x6D4B;&#x8BD5;"><a href="#&#x6D4B;&#x8BD5;" class="headerlink" title="&#x6D4B;&#x8BD5;"></a>&#x6D4B;&#x8BD5;</h3><p>&#x76F4;&#x63A5;postman&#x8BBF;&#x95EE;controller&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x5373;&#x53EF;&#x3002;<br>&#x793A;&#x4F8B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/0a58fe5f68094335cf20bad8c861bce1330efe5f74c991ecf4c880062b299ae5" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/412ebcc89651299a686df4585a6c987f.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7004833249566392351.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7004833249566392351.html" itemprop="url">Zookeeper   源码入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-06T22:52:25+08:00">
                2021-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00;. &#x524D;&#x8A00;"></a>&#x4E00;. &#x524D;&#x8A00;</h2><p>&#x51FA;&#x4E8E;&#x5BF9;&#x96C6;&#x7FA4;&#x9009;&#x4E3E;&#x6D41;&#x7A0B;&#x7684;&#x597D;&#x5947; , &#x6240;&#x4EE5;&#x628A; Zookeeper &#x6E90;&#x7801;&#x62C9;&#x4E0B;&#x6765;&#x8DD1;&#x4E86;&#x4E00;&#x4E0B; , &#x8FD9;&#x7BC7;&#x6587;&#x6863;&#x5BF9;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x505A;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x8BB0;&#x5F55;.</p>
<p>&#x8981;&#x60F3;&#x770B;&#x61C2;&#x4EFB;&#x4F55;&#x6E90;&#x7801; , &#x7B2C;&#x4E00;&#x6B65;&#x5C31;&#x662F;&#x8981;&#x8DD1;&#x8D77;&#x6765; . &#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD; , &#x5982;&#x679C;&#x5FEB;&#x901F;&#x7684;&#x8DD1;&#x6E90;&#x7801; ,&#x540C;&#x65F6;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x5176;&#x4E2D;&#x7684;&#x5173;&#x952E;&#x70B9; , &#x4FBF;&#x4E8E;&#x5904;&#x7406;</p>
<h2 id="&#x4E8C;-&#x6E90;&#x7801;&#x7684;&#x8FD0;&#x884C;"><a href="#&#x4E8C;-&#x6E90;&#x7801;&#x7684;&#x8FD0;&#x884C;" class="headerlink" title="&#x4E8C; . &#x6E90;&#x7801;&#x7684;&#x8FD0;&#x884C;"></a>&#x4E8C; . &#x6E90;&#x7801;&#x7684;&#x8FD0;&#x884C;</h2><h3 id="2-1-&#x4E3B;&#x542F;&#x52A8;&#x6D41;&#x7A0B;"><a href="#2-1-&#x4E3B;&#x542F;&#x52A8;&#x6D41;&#x7A0B;" class="headerlink" title="2.1 &#x4E3B;&#x542F;&#x52A8;&#x6D41;&#x7A0B;"></a>2.1 &#x4E3B;&#x542F;&#x52A8;&#x6D41;&#x7A0B;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// Step 1 : Git &#x62C9;&#x53D6;</span><br><span class="line">https://github.com/apache/zookeeper.git</span><br><span class="line"></span><br><span class="line">// Step 2 : &#x672C;&#x5730;&#x8FD0;&#x884C; (Intellij)</span><br><span class="line">1. &#x627E;&#x5230; zookeeper-server &#x5B50;&#x6A21;&#x5757;</span><br><span class="line">2. &#x627E;&#x5230; &#x5BF9;&#x5E94;&#x7684;&#x542F;&#x52A8;&#x7C7B; </span><br><span class="line">3. &#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x542F;&#x52A8;&#x9879;&#x76EE;</span><br><span class="line"></span><br><span class="line">// PS : &#x8FD9;&#x91CC;&#x67E5;&#x770B;&#x4E86; Zookeeper &#x8FD0;&#x884C;&#x5305; (ZkServer.cmd)&#x7684;&#x5185;&#x5BB9; , &#x51B3;&#x5B9A;&#x5148;&#x91C7;&#x7528;&#x76F8;&#x540C;&#x7684;&#x65B9;&#x5F0F;&#x542F;&#x52A8; &gt;&gt;&gt;&gt;</span><br><span class="line">setlocal</span><br><span class="line">call &quot;%~dp0zkEnv.cmd&quot;</span><br><span class="line"></span><br><span class="line">set ZOOMAIN=org.apache.zookeeper.server.quorum.QuorumPeerMain</span><br><span class="line">echo on</span><br><span class="line">call %JAVA% &quot;-Dzookeeper.log.dir=%ZOO_LOG_DIR%&quot; &quot;-Dzookeeper.root.logger=%ZOO_LOG4J_PROP%&quot; -cp &quot;%CLASSPATH%&quot; %ZOOMAIN% &quot;%ZOOCFG%&quot; %*</span><br><span class="line"></span><br><span class="line">endlocal</span><br></pre></td></tr></table></figure>

<h3 id="2-2-&#x5176;&#x4ED6;&#x542F;&#x52A8;&#x7C7B;"><a href="#2-2-&#x5176;&#x4ED6;&#x542F;&#x52A8;&#x7C7B;" class="headerlink" title="2.2 &#x5176;&#x4ED6;&#x542F;&#x52A8;&#x7C7B;"></a>2.2 &#x5176;&#x4ED6;&#x542F;&#x52A8;&#x7C7B;</h3><p>&#x8FDB;&#x5165;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F88;&#x591A;&#x5176;&#x4ED6;&#x7684;&#x542F;&#x52A8;&#x7C7B; , &#x8FD9;&#x91CC;&#x67E5;&#x9605;&#x4E86;&#x4E00;&#x4E0B; <a href="/external_links/d0be9ce56b297fd101314dd148b3cbad.html" target="blank" rel="noopener">API Doc</a> , &#x5927;&#x6982;&#x4E86;&#x89E3;&#x4E86;&#x4E00;&#x4E0B;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/352d8f24339c6753ab9ff34262e736bf40b408f96461e8d724890572ce0ad544" alt="image.png"></p>
<h3 id="2-3-&#x6E90;&#x7801;&#x7684;&#x4E3B;&#x8981;&#x903B;&#x8F91;"><a href="#2-3-&#x6E90;&#x7801;&#x7684;&#x4E3B;&#x8981;&#x903B;&#x8F91;" class="headerlink" title="2.3 &#x6E90;&#x7801;&#x7684;&#x4E3B;&#x8981;&#x903B;&#x8F91;"></a>2.3 &#x6E90;&#x7801;&#x7684;&#x4E3B;&#x8981;&#x903B;&#x8F91;</h3><p>&#x6E90;&#x7801;&#x7684;&#x4E3B;&#x8981;&#x5165;&#x53E3;&#x7C7B;&#x4E3A; QuorumPeerMain , &#x800C;&#x5176;&#x4ED6;&#x7684;&#x7C7B;&#x4F1A;&#x7531; QuorumPeerMain &#x53D1;&#x8D77;&#x8C03;&#x7528; (&#x4F8B;&#x5982; : ) , &#x8FD9;&#x91CC;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x56FE; &gt;&gt;&gt;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/974208dfa3207f3cf42dbd267427d788f9cb553735b492fc3505a892aac0ddb5" alt="&#x7ED3;&#x6784;&#x56FE;.jpg"></p>
<h2 id="&#x4E8C;-&#x542F;&#x52A8;&#x6D41;&#x7A0B;"><a href="#&#x4E8C;-&#x542F;&#x52A8;&#x6D41;&#x7A0B;" class="headerlink" title="&#x4E8C; . &#x542F;&#x52A8;&#x6D41;&#x7A0B;"></a>&#x4E8C; . &#x542F;&#x52A8;&#x6D41;&#x7A0B;</h2><p>&#x6765;&#x7B80;&#x5355;&#x770B;&#x4E00;&#x4E0B; QuorumPeerMain &#x542F;&#x52A8;&#x65F6;&#x505A;&#x4E86;&#x4EC0;&#x4E48; :</p>
<h3 id="3-1-QuorumPeerMain-&#x7B80;&#x4ECB;"><a href="#3-1-QuorumPeerMain-&#x7B80;&#x4ECB;" class="headerlink" title="3.1 QuorumPeerMain &#x7B80;&#x4ECB;"></a>3.1 QuorumPeerMain &#x7B80;&#x4ECB;</h3><p>&#x5F53;&#x4F7F;&#x7528;&#x8BE5;&#x7C7B;&#x7684;main()&#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x7A0B;&#x5E8F;&#x65F6;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x88AB;&#x7528;&#x4F5C;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8DEF;&#x5F84; , &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x5982;&#x4E0B;&#x4FE1;&#x606F; :</p>
<ul>
<li><strong>dataDir</strong> : ZooKeeper&#x6570;&#x636E;&#x6240;&#x5728;&#x76EE;&#x5F55;&#x3002;</li>
<li><strong>dataLogDir</strong> : ZooKeeper&#x4E8B;&#x52A1;&#x65E5;&#x5FD7;&#x5B58;&#x653E;&#x76EE;&#x5F55;&#x3002;</li>
<li><strong>clientPort</strong> : &#x7528;&#x4E8E;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x4FE1;&#x7684;&#x7AEF;&#x53E3;&#x3002;</li>
<li><strong>tickTime</strong> : &#x4E00;&#x4E2A;&#x6EF4;&#x7B54;&#x7684;&#x6301;&#x7EED;&#x65F6;&#x95F4;&#xFF0C;&#x5355;&#x4F4D;&#x4E3A;&#x6BEB;&#x79D2;&#x3002;&#x8FD9;&#x662F;ZooKeeper&#x4E2D;&#x7684;&#x57FA;&#x672C;&#x65F6;&#x95F4;&#x5355;&#x4F4D;&#x3002;</li>
<li><strong>initLimit</strong> : &#x8DDF;&#x8E2A;&#x8005;&#x7B49;&#x5F85;&#x4E0E;leader&#x521D;&#x59CB;&#x540C;&#x6B65;&#x7684;&#x6700;&#x5927;&#x8282;&#x62CD;&#x6570;&#x3002;</li>
<li><strong>syncLimit</strong> : &#x8DDF;&#x8E2A;&#x8005;&#x7B49;&#x5F85;&#x6765;&#x81EA;leader&#x7684;&#x6D88;&#x606F;(&#x5305;&#x62EC;&#x5FC3;&#x8DF3;)&#x7684;&#x6700;&#x5927;&#x8282;&#x62CD;&#x6570;&#x3002;</li>
<li><strong>server.id</strong> : &#x8FD9;&#x662F;&#x5177;&#x6709;&#x7ED9;&#x5B9A;id&#x7684;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x7528;&#x4E8E;&#x4EF2;&#x88C1;&#x534F;&#x8BAE;&#x7684;&#x4E3B;&#x673A;:port[:port]&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# &#x4EE5;&#x4E0B;&#x662F;&#x6211;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=D:\\java\\workspace\\git\\zookeeper\\temp</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<h3 id="3-2-IDEA-&#x914D;&#x7F6E;"><a href="#3-2-IDEA-&#x914D;&#x7F6E;" class="headerlink" title="3.2 IDEA &#x914D;&#x7F6E;"></a>3.2 IDEA &#x914D;&#x7F6E;</h3><blockquote>
<p>VM Options</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;&quot;-Dzookeeper.root.logger=INFO,CONSOLE&quot; -cp &quot;D:\java\workspace\git\zookeeper\zookeeper\zookeeper-server\target\classes;D:\java\workspace\git\zookeeper\zookeeper\zookeeper-server\target\lib\*;D:\java\workspace\git\zookeeper\zookeeper\bin\..\*;D:\java\workspace\git\zookeeper\zookeeper\bin\..\lib\*;D:\java\workspace\git\zookeeper\zookeeper\bin\..\conf&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Program arguments</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;D:\java\workspace\git\zookeeper\zoo.cfg</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/585595030c836996caba03d604dcec5a407b951cf0ffa7931201cb025eb9e0d1" alt="image.png"></p>
<p>&#x5176;&#x4E2D;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F; log &#x7EA7;&#x522B;&#x548C;&#x4F60;&#x7684;&#x6E90;&#x7801;&#x8DEF;&#x5F84; , &#x914D;&#x7F6E;&#x5B8C;&#x6210;&#x540E;&#x4E00;&#x822C;&#x9879;&#x76EE;&#x5C31;&#x80FD;&#x6B63;&#x5E38;&#x8DD1;&#x8D77;&#x6765;&#x4E86;</p>
<h2 id="&#x4E09;-&#x8BF7;&#x6C42;&#x4E0E;&#x63A5;&#x6536;"><a href="#&#x4E09;-&#x8BF7;&#x6C42;&#x4E0E;&#x63A5;&#x6536;" class="headerlink" title="&#x4E09; . &#x8BF7;&#x6C42;&#x4E0E;&#x63A5;&#x6536;"></a>&#x4E09; . &#x8BF7;&#x6C42;&#x4E0E;&#x63A5;&#x6536;</h2><p>&#x8BF7;&#x6C42;&#x548C;&#x63A5;&#x6536;&#x8DD1;&#x901A;&#x4E86;&#x624D;&#x662F;&#x4E00;&#x5207;&#x7684;&#x57FA;&#x7840; , Zk &#x7684;&#x6838;&#x5FC3;&#x5BF9;&#x8C61;&#x5206;&#x522B;&#x4E3A; ClientCnxn &#x548C; ServerCnxn</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/4fe7249e17411d1f75e8d3c86c4a41d5e9b0914559daf5001c208733317fa66c" alt="System-ServerCnxn.png"></p>
<p>&#x4ECE; log &#x4E2D;&#x4E0D;&#x96BE;&#x53D1;&#x73B0; , &#x9ED8;&#x8BA4;&#x662F;&#x8D70;&#x7684; NIO</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;[main:NIOServerCnxnFactory@89] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">[NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@222] - Accepted socket connection from /127.0.0.1:53152</span><br><span class="line">[NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@903] - Connection request from old client /127.0.0.1:53152; will be dropped if server is in r-o mode</span><br><span class="line">[NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@942] - Client attempting to renew session 0x100001d6f1f0009 at /127.0.0.1:53152</span><br><span class="line">[NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@687] - Invalid session 0x100001d6f1f0009 for client /127.0.0.1:53152, probably expired</span><br><span class="line">[NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1056] - Closed socket connection for client /127.0.0.1:53152 which had sessionid 0x100001d6f1f0009</span><br></pre></td></tr></table></figure>

<h3 id="3-1-&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;"><a href="#3-1-&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;" class="headerlink" title="3.1 &#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;"></a>3.1 &#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;</h3><p>&#x4EE5; SetData &#x4E3A;&#x4F8B; , &#x4E3B;&#x8981;&#x7ECF;&#x8FC7;&#x5982;&#x4E0B;&#x6D41;&#x7A0B; :</p>
<ul>
<li>C- ZooKeeper # &#x76F8;&#x5173;&#x903B;&#x8F91;</li>
<li>C- ClientCnxn # submitRequest : &#x6784;&#x5EFA; Packet , &#x540C;&#x65F6;&#x52A0;&#x5165; Queue &#x4E2D;</li>
<li>C- ClientCnxnSocketNIO : &#x53D1;&#x8D77;&#x5904;&#x7406;&#x8BF7;&#x6C42;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public Stat setData(final String path, byte[] data, int version) throws KeeperException, InterruptedException {</span><br><span class="line"></span><br><span class="line">    final String clientPath = path;</span><br><span class="line">    PathUtils.validatePath(clientPath);</span><br><span class="line">    </span><br><span class="line">    // serverPath -&gt;  /testWatch</span><br><span class="line">    final String serverPath = prependChroot(clientPath);</span><br><span class="line"></span><br><span class="line">    RequestHeader h = new RequestHeader();</span><br><span class="line">    h.setType(ZooDefs.OpCode.setData);</span><br><span class="line">    </span><br><span class="line">    // &#x6784;&#x5EFA; request</span><br><span class="line">    SetDataRequest request = new SetDataRequest();</span><br><span class="line">    request.setPath(serverPath);</span><br><span class="line">    request.setData(data);</span><br><span class="line">    request.setVersion(version);</span><br><span class="line">    </span><br><span class="line">    SetDataResponse response = new SetDataResponse();</span><br><span class="line">    </span><br><span class="line">    // &#x901A;&#x8FC7; ClientCnxn &#x53D1;&#x8D77;&#x8BF7;&#x6C42;</span><br><span class="line">    ReplyHeader r = cnxn.submitRequest(h, request, response, null);</span><br><span class="line">    if (r.getErr() != 0) {</span><br><span class="line">        throw KeeperException.create(KeeperException.Code.get(r.getErr()), clientPath);</span><br><span class="line">    }</span><br><span class="line">    return response.getStat();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x5E95;&#x5C42; &#x8FD8;&#x662F;&#x7528;&#x7684; NIO &#x8C03;&#x7528; , &#x540E;&#x9762;&#x8BE6;&#x7EC6;&#x770B;&#x770B;</strong></p>
<h3 id="3-2-&#x670D;&#x52A1;&#x7AEF;&#x5904;&#x7406;&#x8BF7;&#x6C42;"><a href="#3-2-&#x670D;&#x52A1;&#x7AEF;&#x5904;&#x7406;&#x8BF7;&#x6C42;" class="headerlink" title="3.2 &#x670D;&#x52A1;&#x7AEF;&#x5904;&#x7406;&#x8BF7;&#x6C42;"></a>3.2 &#x670D;&#x52A1;&#x7AEF;&#x5904;&#x7406;&#x8BF7;&#x6C42;</h3><p>Zookeeper &#x7684;&#x6838;&#x5FC3;&#x7BA1;&#x7406;&#x7C7B;&#x4E3A; ZooKeeperServer , &#x5176;&#x4E2D;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5; :</p>
<ul>
<li>processConnectRequest : &#x5904;&#x7406;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;</li>
</ul>
<blockquote>
<p>&#x6838;&#x5FC3;&#x4E00; : processConnectRequest</p>
</blockquote>
<p>&#x521B;&#x5EFA;&#x8FDE;&#x63A5;&#x662F;&#x4E00;&#x5207;&#x7684;&#x8D77;&#x70B9; , &#x4E3B;&#x8981;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x6D41;&#x7A0B;&#x8C03;&#x7528;&#x5230;&#x8BE5;&#x7C7B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;C- ZooKeeperServer : &#x4EC5;&#x4FDD;&#x7559;&#x6838;&#x5FC3;&#x4EE3;&#x7801;</span><br><span class="line">public void processConnectRequest(ServerCnxn cnxn, ByteBuffer incomingBuffer) throws IOException {</span><br><span class="line">    BinaryInputArchive bia = BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer));</span><br><span class="line">    </span><br><span class="line">    // &#x53C2;&#x6570;&#x51C6;&#x5907;</span><br><span class="line">    ConnectRequest connReq = new ConnectRequest();</span><br><span class="line">    connReq.deserialize(bia, &quot;connect&quot;);</span><br><span class="line">    boolean readOnly = false;</span><br><span class="line">    </span><br><span class="line">    readOnly = bia.readBool(&quot;readOnly&quot;);</span><br><span class="line">    cnxn.isOldClient = false;</span><br><span class="line">    </span><br><span class="line">    // &#x8D85;&#x65F6;&#x65F6;&#x95F4; : 4000</span><br><span class="line">    int sessionTimeout = connReq.getTimeOut();</span><br><span class="line">    // &#x8FDE;&#x63A5;&#x5BC6;&#x7801; , &#x4E0D;&#x5B58;&#x5728;&#x5219;&#x4E3A;&#x4E00;&#x4E2A;&#x7A7A;&#x6570;&#x7EC4;</span><br><span class="line">    byte passwd[] = connReq.getPasswd();</span><br><span class="line">    </span><br><span class="line">    // &#x6700;&#x5C0F;&#x6700;&#x5927;&#x4F1A;&#x8BDD;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span><br><span class="line">    int minSessionTimeout = getMinSessionTimeout();</span><br><span class="line">    int maxSessionTimeout = getMaxSessionTimeout();</span><br><span class="line"></span><br><span class="line">    // &#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span><br><span class="line">    cnxn.setSessionTimeout(sessionTimeout);</span><br><span class="line">    cnxn.disableRecv();</span><br><span class="line">    </span><br><span class="line">    // &#x5982;&#x679C;session &#x5B58;&#x5728;</span><br><span class="line">    long sessionId = connReq.getSessionId();</span><br><span class="line">    if (sessionId != 0) {</span><br><span class="line">    </span><br><span class="line">        long clientSessionId = connReq.getSessionId();</span><br><span class="line">        // &#x5148;&#x5173;&#x95ED;&#x518D;&#x91CD;&#x65B0;&#x6253;&#x5F00;&#x4F1A;&#x8BDD; </span><br><span class="line">        serverCnxnFactory.closeSession(sessionId);</span><br><span class="line">        cnxn.setSessionId(sessionId);</span><br><span class="line">        reopenSession(cnxn, sessionId, passwd, sessionTimeout);</span><br><span class="line">    } else {</span><br><span class="line">        // &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;</span><br><span class="line">        createSession(cnxn, passwd, sessionTimeout);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x6838;&#x5FC3;&#x4E8C; : Request &#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;<br><strong>&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x7A0D;&#x5FAE;&#x6709;&#x70B9;&#x7ED5;&#x7684;&#x591A;&#x7EBF;&#x7A0B;&#x5904;&#x7406; , &#x540E;&#x9762;&#x518D;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B; ,&#x5148;&#x770B;&#x4E0B;&#x4E3B;&#x8981;&#x7684;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</strong></p>
</blockquote>
<ul>
<li>C- PrepRequestProcessor # pRequest : &#x7531;&#x914D;&#x7F6E;&#x7C7B;&#x53D1;&#x8D77;&#x7684;first &#x8BF7;&#x6C42;&#x5904;&#x7406;&#x5668;</li>
<li>C- SyncRequestProcessor # processRequest : <strong>&#x5C06;&#x8BF7;&#x6C42;&#x52A0;&#x5165; Queue &#x4E2D;(&#x6838;&#x5FC3;)</strong></li>
<li>C- SyncRequestProcessor # run : &#x5176;&#x4E2D;&#x4F1A;&#x4E00;&#x76F4;&#x5FAA;&#x73AF;&#x5904;&#x7406; Request</li>
<li>C- FinalRequestProcessor # processRequest : &#x53D1;&#x8D77; Process &#x8C03;&#x7528;</li>
</ul>
<p><strong>PS : &#x5176;&#x4E2D;&#x5FAA;&#x73AF;&#x7684;&#x5904;&#x7406;&#x5F88;&#x4E0D;&#x9519; , &#x503C;&#x5F97;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x4E00;&#x4E0B;</strong></p>
<h2 id="&#x56DB;-Zookeeper-&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"><a href="#&#x56DB;-Zookeeper-&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;" class="headerlink" title="&#x56DB; . Zookeeper &#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></a>&#x56DB; . Zookeeper &#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</h2><p><strong>&#x53E6;&#x5916;&#x4E00;&#x5927;&#x91CD;&#x70B9;&#x5C31;&#x662F;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x6570;&#x636E;&#x662F;&#x4EE5;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x7ED3;&#x6784;&#x4FDD;&#x5B58;&#x5230;Zookeeper &#x4E2D;&#x7684; , Zookeeper &#x4E2D;&#x5B58;&#x5728;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x6838;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5BF9;&#x8C61; :</strong></p>
<ul>
<li>ZKDatabase : &#x6570;&#x636E;&#x4E2D;&#x5FC3;</li>
<li>DataTree : &#x6570;&#x636E;&#x6570; , &#x6838;&#x5FC3;&#x6570;&#x636E;&#x5BF9;&#x8C61;</li>
</ul>
<h3 id="4-1-&#x6570;&#x636E;&#x7684;&#x83B7;&#x53D6;"><a href="#4-1-&#x6570;&#x636E;&#x7684;&#x83B7;&#x53D6;" class="headerlink" title="4.1 &#x6570;&#x636E;&#x7684;&#x83B7;&#x53D6;"></a>4.1 &#x6570;&#x636E;&#x7684;&#x83B7;&#x53D6;</h3><p>&#x4EE5;&#x6570;&#x636E;&#x7684;&#x83B7;&#x53D6;&#x4E3A;&#x4F8B; , &#x7ECF;&#x5386;&#x4E86;&#x4EE5;&#x4E0B;&#x6D41;&#x7A0B; :</p>
<ul>
<li>C- SyncRequestProcessor # run : &#x6CE8;&#x610F; , &#x8FD9;&#x4E2A;&#x662F;&#x4E00;&#x4E2A;&#x4E0D;&#x65AD;&#x4ECE; queue &#x4E2D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x7684;&#x8FC7;&#x7A0B;</li>
<li>C- FinalRequestProcessor # processRequest</li>
<li>C- ZKDatabase # getNode</li>
<li>C- DataTree # getNode</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DataTree {</span><br><span class="line">    // &#x6838;&#x5FC3;&#x5B58;&#x50A8;&#x5BF9;&#x8C61;</span><br><span class="line">    private final ConcurrentHashMap&lt;String, DataNode&gt; nodes = new ConcurrentHashMap&lt;String, DataNode&gt;();</span><br><span class="line"></span><br><span class="line">    // watches &#x5BF9;&#x8C61;&#x96C6;&#x5408;</span><br><span class="line">    private final WatchManager dataWatches = new WatchManager();</span><br><span class="line">    private final WatchManager childWatches = new WatchManager();</span><br><span class="line"></span><br><span class="line">    /** the root of zookeeper tree */</span><br><span class="line">    private static final String rootZookeeper = &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    /** the zookeeper nodes that acts as the management and status node **/</span><br><span class="line">    private static final String procZookeeper = Quotas.procZookeeper;</span><br><span class="line"></span><br><span class="line">    /** this will be the string thats stored as a child of root */</span><br><span class="line">    private static final String procChildZookeeper = procZookeeper.substring(1);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * the zookeeper quota node that acts as the quota management node for</span><br><span class="line">     * zookeeper</span><br><span class="line">     */</span><br><span class="line">    private static final String quotaZookeeper = Quotas.quotaZookeeper;</span><br><span class="line"></span><br><span class="line">    /** this will be the string thats stored as a child of /zookeeper */</span><br><span class="line">    private static final String quotaChildZookeeper = quotaZookeeper</span><br><span class="line">            .substring(procZookeeper.length() + 1);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * the path trie that keeps track fo the quota nodes in this datatree</span><br><span class="line">     */</span><br><span class="line">    private final PathTrie pTrie = new PathTrie();</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><strong>&#x5185;&#x5BB9;&#x4E0D;&#x591A; , &#x4F46;&#x662F;&#x6BD4;&#x8F83;&#x91CD;&#x8981; , &#x8FD9;&#x51E0;&#x4E2A;&#x73AF;&#x8282;&#x5F04;&#x6E05;&#x695A;&#x540E; , &#x540E;&#x9762;&#x56F4;&#x7740;&#x6574;&#x4E2A;&#x73AF;&#x8282;&#x62BD;&#x4E1D;&#x5265;&#x8327;&#x5C31;&#x884C;&#x4E86;</strong></p>
<p>&#x540E;&#x7EED;&#x6587;&#x7AE0;&#x5DF2;&#x7ECF;&#x6574;&#x7406;&#x5F97;&#x5DEE;&#x4E0D;&#x591A;&#x4E86; , &#x7A0D;&#x5FAE;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#x540E;&#x7EED;&#x53D1;&#x51FA;&#x6765; , &#x6587;&#x7AE0;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#x65E9; , &#x7248;&#x672C;&#x6BD4;&#x8F83;&#x65E7; ,&#x4F46;&#x662F;&#x6838;&#x5FC3;&#x662F;&#x5DEE;&#x4E0D;&#x591A;&#x5F97;</p>
<h2 id="&#x9644;&#x5F55;"><a href="#&#x9644;&#x5F55;" class="headerlink" title="&#x9644;&#x5F55; :"></a>&#x9644;&#x5F55; :</h2><h3 id="Zookeeper-&#x9879;&#x76EE;&#x7ED3;&#x6784;"><a href="#Zookeeper-&#x9879;&#x76EE;&#x7ED3;&#x6784;" class="headerlink" title="Zookeeper &#x9879;&#x76EE;&#x7ED3;&#x6784;"></a>Zookeeper &#x9879;&#x76EE;&#x7ED3;&#x6784;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;//&#x2500;zookeeper-assembly                </span><br><span class="line">//&#x2500;zookeeper-client</span><br><span class="line">&#x2502;  &#x2514;&#x2500;zookeeper-client-c        </span><br><span class="line">//&#x2500;zookeeper-compatibility-tests</span><br><span class="line">&#x2502;  &#x2514;&#x2500;zookeeper-compatibility-tests-curator                                  </span><br><span class="line">//&#x2500;zookeeper-contrib</span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-fatjar               </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-huebrowser                   </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-loggraph                                    </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-monitoring       </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-rest                                    </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-zkfuse         </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-zkperl          </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-zkpython          </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-contrib-zktreeutil   </span><br><span class="line">&#x2502;  &#x2514;&#x2500;zookeeper-contrib-zooinspector                                  </span><br><span class="line">//&#x2500;zookeeper-docs                    </span><br><span class="line">//&#x2500;zookeeper-it                           </span><br><span class="line">//&#x2500;zookeeper-jute</span><br><span class="line">//&#x2500;zookeeper-metrics-providers</span><br><span class="line">&#x2502;  &#x2514;&#x2500;zookeeper-prometheus-metrics</span><br><span class="line">//&#x2500;zookeeper-recipes</span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-recipes-election </span><br><span class="line">&#x2502;  &#x251C;&#x2500;zookeeper-recipes-lock                             </span><br><span class="line">&#x2502;  &#x2514;&#x2500;zookeeper-recipes-queue</span><br><span class="line">//&#x2500;zookeeper-server</span><br></pre></td></tr></table></figure>

<h2 id="&#x53C2;&#x8003;&#x6587;&#x6863;"><a href="#&#x53C2;&#x8003;&#x6587;&#x6863;" class="headerlink" title="&#x53C2;&#x8003;&#x6587;&#x6863;"></a>&#x53C2;&#x8003;&#x6587;&#x6863;</h2><p><a href="/external_links/70c6c928ae73dd953790c8b70d5e6048.html" target="blank" rel="noopener">www.cnblogs.com/jing99/p/12&#x2026;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2b161330037395d7391434a8c24216bb.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7003141599139987492.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7003141599139987492.html" itemprop="url">CompletableFuture真香，可以替代CountD</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-02T09:26:29+08:00">
                2021-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x539F;&#x521B;&#xFF1A;&#x5C0F;&#x59D0;&#x59D0;&#x5473;&#x9053;&#xFF08;&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;ID&#xFF1A;xjjdog&#xFF09;&#xFF0C;&#x6B22;&#x8FCE;&#x5206;&#x4EAB;&#xFF0C;&#x8F6C;&#x8F7D;&#x8BF7;&#x4FDD;&#x7559;&#x51FA;&#x5904;&#x3002;</p>
</blockquote>
<p>&#x5728;&#x5BF9;&#x7C7B;&#x7684;&#x547D;&#x540D;&#x7BC7;&#x957F;&#x6587;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x4E86;<code>Future</code>&#x548C;<code>Promise</code>&#x3002;</p>
<p>Future&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x5360;&#x4F4D;&#x7B26;&#xFF0C;&#x4EE3;&#x8868;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x5C06;&#x6765;&#x7684;&#x7ED3;&#x679C;&#x3002;&#x4E00;&#x822C;&#x901A;&#x8FC7;get&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x963B;&#x585E;&#x5F97;&#x5230;&#x7ED3;&#x679C;&#xFF0C;&#x6216;&#x8005;&#x8BA9;&#x5B83;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x7136;&#x540E;&#x901A;&#x8FC7;callback&#x56DE;&#x8C03;&#x7ED3;&#x679C;&#x3002;</p>
<p>&#x4F46;&#x5982;&#x679C;&#x56DE;&#x8C03;&#x4E2D;&#x5D4C;&#x5165;&#x4E86;&#x56DE;&#x8C03;&#x5462;&#xFF1F;&#x5982;&#x679C;&#x5C42;&#x6B21;&#x5F88;&#x6DF1;&#xFF0C;&#x5C31;&#x662F;&#x56DE;&#x8C03;&#x5730;&#x72F1;&#x3002;Java&#x4E2D;&#x7684;CompletableFuture&#x5176;&#x5B9E;&#x5C31;&#x662F;Promise&#xFF0C;&#x7528;&#x6765;&#x89E3;&#x51B3;&#x56DE;&#x8C03;&#x5730;&#x72F1;&#x95EE;&#x9898;&#x3002;Promise&#x662F;&#x4E3A;&#x4E86;&#x8BA9;&#x4EE3;&#x7801;&#x53D8;&#x5F97;&#x4F18;&#x7F8E;&#x800C;&#x5B58;&#x5728;&#x7684;&#x3002;</p>
<p>&#x6709;&#x591A;&#x4F18;&#x7F8E;&#xFF1F;&#x8FD9;&#x4E48;&#x8BF4;&#x5427;&#xFF0C;&#x4E00;&#x65E6;&#x4F60;&#x4F7F;&#x7528;&#x4E86;CompletableFuture&#xFF0C;&#x5C31;&#x4F1A;&#x7231;&#x4E0D;&#x91CA;&#x624B;&#xFF0C;&#x5C31;&#x50CF;&#x521D;&#x604B;&#x5973;&#x53CB;&#x4E00;&#x6837;&#xFF0C;&#x5929;&#x5929;&#x60F3;&#x7740;&#x5979;&#x3002;</p>
<h2 id="&#x4E00;&#x7CFB;&#x5217;&#x9759;&#x6001;&#x65B9;&#x6CD5;"><a href="#&#x4E00;&#x7CFB;&#x5217;&#x9759;&#x6001;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4E00;&#x7CFB;&#x5217;&#x9759;&#x6001;&#x65B9;&#x6CD5;"></a>&#x4E00;&#x7CFB;&#x5217;&#x9759;&#x6001;&#x65B9;&#x6CD5;</h2><p>&#x4ECE;&#x5B83;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;CompletableFuture&#x76F4;&#x63A5;&#x63D0;&#x4F9B;&#x4E86;&#x51E0;&#x4E2A;&#x4FBF;&#x6377;&#x7684;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x5165;&#x53E3;&#x3002;&#x5176;&#x4E2D;&#x6709;<code>run</code>&#x548C;<code>supply</code>&#x4E24;&#x7EC4;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/36f807e1b8c7765e04ca26b3a5c4d99161558ef7f53b84aed8f1cffa9028046c" alt="image.png"></p>
<p>run&#x7684;&#x53C2;&#x6570;&#x662F;Runnable&#xFF0C;&#x800C;supply&#x7684;&#x53C2;&#x6570;&#x662F;Supplier&#x3002;&#x524D;&#x8005;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x800C;&#x540E;&#x8005;&#x6709;&#xFF0C;&#x5426;&#x5219;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x4E24;&#x6837;&#x3002;</p>
<p>&#x8FD9;&#x4E24;&#x7EC4;&#x9759;&#x6001;&#x51FD;&#x6570;&#xFF0C;&#x90FD;&#x63D0;&#x4F9B;&#x4E86;&#x4F20;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x7EBF;&#x7A0B;&#x6C60;&#x7684;&#x529F;&#x80FD;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7528;&#x7684;&#x4E0D;&#x662F;&#x5916;&#x7F6E;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x5C31;&#x4F1A;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x7684;ForkJoin&#x7EBF;&#x7A0B;&#x6C60;&#x3002;&#x9ED8;&#x8BA4;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x5927;&#x5C0F;&#x548C;&#x7528;&#x9014;&#x4F60;&#x662F;&#x63A7;&#x5236;&#x4E0D;&#x4E86;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FD8;&#x662F;&#x5EFA;&#x8BAE;&#x81EA;&#x5DF1;&#x4F20;&#x9012;&#x4E00;&#x4E2A;&#x3002;</p>
<p>&#x5178;&#x578B;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5199;&#x8D77;&#x6765;&#x662F;&#x8FD9;&#x4E2A;&#x6837;&#x5B50;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(()-&gt;{</span><br><span class="line">	return &quot;test&quot;;</span><br><span class="line">});</span><br><span class="line">String result = future.join();</span><br></pre></td></tr></table></figure>

<p>&#x62FF;&#x5230;CompletableFuture&#x540E;&#xFF0C;&#x4F60;&#x5C31;&#x53EF;&#x4EE5;&#x505A;&#x66F4;&#x591A;&#x7684;&#x82B1;&#x6837;&#x3002;</p>
<h2 id="&#x8FD9;&#x4E9B;&#x82B1;&#x6837;&#x6709;&#x5F88;&#x591A;"><a href="#&#x8FD9;&#x4E9B;&#x82B1;&#x6837;&#x6709;&#x5F88;&#x591A;" class="headerlink" title="&#x8FD9;&#x4E9B;&#x82B1;&#x6837;&#x6709;&#x5F88;&#x591A;"></a>&#x8FD9;&#x4E9B;&#x82B1;&#x6837;&#x6709;&#x5F88;&#x591A;</h2><p>&#x6211;&#x4EEC;&#x8BF4;&#x9762;&#x8BF4;&#x4E86;&#xFF0C;CompletableFuture&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF0C;&#x5C31;&#x662F;&#x8BA9;&#x4EE3;&#x7801;&#x5199;&#x8D77;&#x6765;&#x597D;&#x770B;&#x3002;&#x914D;&#x5408;Java8&#x4E4B;&#x540E;&#x7684;stream&#x6D41;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;&#x6574;&#x4E2A;&#x8BA1;&#x7B97;&#x8FC7;&#x7A0B;&#x62BD;&#x8C61;&#x6210;&#x4E00;&#x4E2A;&#x6D41;&#x3002;&#x524D;&#x9762;&#x4EFB;&#x52A1;&#x7684;&#x8BA1;&#x7B97;&#x7ED3;&#x679C;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F5C;&#x4E3A;&#x540E;&#x9762;&#x4EFB;&#x52A1;&#x7684;&#x8F93;&#x5165;&#xFF0C;&#x5C31;&#x50CF;&#x662F;&#x7BA1;&#x9053;&#x4E00;&#x6837;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;thenApply</span><br><span class="line">thenApplyAsync</span><br><span class="line">thenAccept</span><br><span class="line">thenAcceptAsync</span><br><span class="line">thenRun</span><br><span class="line">thenRunAsync</span><br><span class="line">thenCombine</span><br><span class="line">thenCombineAsync</span><br><span class="line">thenCompose</span><br><span class="line">thenComposeAsync</span><br></pre></td></tr></table></figure>

<p><img src="media/completableFuture/1717.gif" alt></p>
<p>&#x6BD4;&#x5982;&#xFF0C;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x662F;99&#xFF0C;&#x5E76;&#x4E0D;&#x56E0;&#x4E3A;&#x662F;&#x5F02;&#x6B65;&#x5C31;&#x6253;&#x4E71;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x7684;&#x987A;&#x5E8F;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;CompletableFuture&lt;Integer&gt; cf = CompletableFuture.supplyAsync(() -&gt; 10)</span><br><span class="line">                .thenApplyAsync((e) -&gt; {</span><br><span class="line">                    try {</span><br><span class="line">                        Thread.sleep(10000);</span><br><span class="line">                    } catch (InterruptedException ex) {</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    }</span><br><span class="line">                    return e * 10;</span><br><span class="line">                }).thenApplyAsync(e -&gt; e - 1);</span><br><span class="line"></span><br><span class="line">cf.join();</span><br><span class="line">System.out.println(cf.get());</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x6837;&#x7684;&#xFF0C;&#x51FD;&#x6570;&#x7684;&#x4F5C;&#x7528;&#x8FD8;&#x8981;&#x770B;then&#x540E;&#x9762;&#x7684;&#x52A8;&#x8BCD;&#x3002;</p>
<ul>
<li>apply &#x6709;&#x5165;&#x53C2;&#x548C;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x5165;&#x53C2;&#x4E3A;&#x524D;&#x7F6E;&#x4EFB;&#x52A1;&#x7684;&#x8F93;&#x51FA;</li>
<li>accept &#x6709;&#x5165;&#x53C2;&#x65E0;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x4F1A;&#x8FD4;&#x56DE;CompletableFuture</li>
<li>run &#x6CA1;&#x6709;&#x5165;&#x53C2;&#x4E5F;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x540C;&#x6837;&#x4F1A;&#x8FD4;&#x56DE;CompletableFuture</li>
<li>combine &#x5F62;&#x6210;&#x4E00;&#x4E2A;&#x590D;&#x5408;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x8FDE;&#x63A5;&#x4E24;&#x4E2A;CompletableFuture&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x4EEC;&#x7684;2&#x4E2A;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#xFF0C;&#x4F5C;&#x4E3A;combine&#x7684;&#x8F93;&#x5165;</li>
<li>compose &#x5C06;&#x5D4C;&#x5957;&#x7684;CompletableFuture&#x5E73;&#x94FA;&#x5F00;&#xFF0C;&#x7528;&#x6765;&#x4E32;&#x8054;&#x4E24;&#x4E2A;CompletableFuture</li>
</ul>
<h2 id="when&#x548C;handle"><a href="#when&#x548C;handle" class="headerlink" title="when&#x548C;handle"></a>when&#x548C;handle</h2><p>&#x4E0A;&#x9762;&#x7684;&#x51FD;&#x6570;&#x5217;&#x8868;&#xFF0C;&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x3002;&#x6BD4;&#x5982;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;whenComplete</span><br></pre></td></tr></table></figure>

<p>when&#x7684;&#x610F;&#x601D;&#xFF0C;&#x5C31;&#x662F;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x65F6;&#x5019;&#x7684;&#x56DE;&#x8C03;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x6253;&#x7B97;&#x5728;&#x5B8C;&#x6210;&#x4EFB;&#x52A1;&#x540E;&#xFF0C;&#x8F93;&#x51FA;&#x4E00;&#x4E2A;<code>done</code>&#x3002;&#x5B83;&#x4E5F;&#x662F;&#x5C5E;&#x4E8E;&#x53EA;&#x6709;&#x5165;&#x53C2;&#x6CA1;&#x6709;&#x51FA;&#x53C2;&#x7684;&#x8303;&#x7574;&#xFF0C;&#x9002;&#x5408;&#x653E;&#x5728;&#x6700;&#x540E;&#x4E00;&#x6B65;&#x8FDB;&#x884C;&#x89C2;&#x6D4B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;CompletableFuture&lt;Integer&gt; cf = CompletableFuture.supplyAsync(() -&gt; 10)</span><br><span class="line">                .thenApplyAsync((e) -&gt; {</span><br><span class="line">                    try {</span><br><span class="line">                        Thread.sleep(1000);</span><br><span class="line">                    } catch (InterruptedException ex) {</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    }</span><br><span class="line">                    return e * 10;</span><br><span class="line">                }).thenApplyAsync(e -&gt; e - 1)</span><br><span class="line">                .whenComplete((r, e)-&gt;{</span><br><span class="line">                    System.out.println(&quot;done&quot;);</span><br><span class="line">                })</span><br><span class="line">                ;</span><br><span class="line"></span><br><span class="line">cf.join();</span><br><span class="line">System.out.println(cf.get());</span><br></pre></td></tr></table></figure>

<p>handle&#x548C;exceptionally&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x548C;whenComplete&#x662F;&#x975E;&#x5E38;&#x50CF;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public CompletableFuture&lt;T&gt; exceptionally(Function&lt;Throwable, ? extends T&gt; fn);</span><br><span class="line"></span><br><span class="line">public &lt;U&gt; CompletionStage&lt;U&gt; handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn);</span><br></pre></td></tr></table></figure>

<p>CompletableFuture&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x4E32;&#x8054;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x7684;&#x5176;&#x4E2D;&#x67D0;&#x4E00;&#x6B65;&#x9AA4;&#x53D1;&#x751F;&#x4E86;&#x5F02;&#x5E38;&#xFF0C;&#x4F1A;&#x5F71;&#x54CD;&#x540E;&#x7EED;&#x4EE3;&#x7801;&#x7684;&#x8FD0;&#x884C;&#x7684;&#x3002;</p>
<p>exceptionally&#x4ECE;&#x540D;&#x5B57;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x662F;&#x4E13;&#x95E8;&#x5904;&#x7406;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x7684;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x6211;&#x4EEC;&#x5F3A;&#x5236;&#x67D0;&#x4E2A;&#x6B65;&#x9AA4;&#x9664;&#x4EE5;0&#xFF0C;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#xFF0C;&#x6355;&#x83B7;&#x540E;&#x8FD4;&#x56DE;-1&#xFF0C;&#x5B83;&#x5C06;&#x80FD;&#x591F;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;CompletableFuture&lt;Integer&gt; cf = CompletableFuture.supplyAsync(() -&gt; 10)</span><br><span class="line">                .thenApplyAsync(e-&gt;e/0)</span><br><span class="line">                .thenApplyAsync(e -&gt; e - 1)</span><br><span class="line">                .exceptionally(ex-&gt;{</span><br><span class="line">                    System.out.println(ex);</span><br><span class="line">                    return -1;</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">cf.join();</span><br><span class="line">System.out.println(cf.get());</span><br></pre></td></tr></table></figure>

<p>handle&#x66F4;&#x52A0;&#x9AD8;&#x7EA7;&#x4E00;&#x4E9B;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x9664;&#x4E86;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#x53C2;&#x6570;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;&#x5165;&#x53C2;&#x3002;&#x5904;&#x7406;&#x65B9;&#x6CD5;&#x4E5F;&#x90FD;&#x7C7B;&#x4F3C;&#xFF0C;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;CompletableFuture&#x7684;&#x51FD;&#x6570;&#x4E0D;&#x4EC5;&#x4EC5;&#x8FD9;&#x4E9B;&#xFF0C;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#xFF0C;&#x6839;&#x636E;&#x51FD;&#x6570;&#x540D;&#x79F0;&#x5F88;&#x5BB9;&#x6613;&#x80FD;&#x591F;&#x4E86;&#x89E3;&#x5230;&#x5B83;&#x7684;&#x4F5C;&#x7528;&#x3002;&#x5B83;&#x8FD8;&#x53EF;&#x4EE5;&#x66FF;&#x6362;&#x590D;&#x6742;&#x7684;CountDownLatch&#xFF0C;&#x8FD9;&#x8981;&#x6D89;&#x53CA;&#x5230;&#x51E0;&#x4E2A;&#x6BD4;&#x8F83;&#x96BE;&#x641E;&#x7684;&#x51FD;&#x6570;&#x3002;</p>
<h2 id="&#x66FF;&#x4EE3;CountDownLatch"><a href="#&#x66FF;&#x4EE3;CountDownLatch" class="headerlink" title="&#x66FF;&#x4EE3;CountDownLatch"></a>&#x66FF;&#x4EE3;CountDownLatch</h2><p>&#x8003;&#x8651;&#x4E0B;&#x9762;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#x3002;&#x67D0;&#x4E00;&#x4E2A;&#x4E1A;&#x52A1;&#x63A5;&#x53E3;&#xFF0C;&#x9700;&#x8981;&#x5904;&#x7406;&#x51E0;&#x767E;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x8BF7;&#x6C42;&#x4E4B;&#x540E;&#x518D;&#x628A;&#x8FD9;&#x4E9B;&#x7ED3;&#x679C;&#x7ED9;&#x6C47;&#x603B;&#x8D77;&#x6765;&#x3002;</p>
<p>&#x5982;&#x679C;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x7684;&#x8BDD;&#xFF0C;&#x5047;&#x8BBE;&#x6BCF;&#x4E2A;&#x63A5;&#x53E3;&#x8017;&#x65F6;100ms&#xFF0C;&#x90A3;&#x4E48;100&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x8017;&#x65F6;&#x5C31;&#x9700;&#x8981;10&#x79D2;&#x3002;&#x5047;&#x5982;&#x6211;&#x4EEC;&#x5E76;&#x884C;&#x53BB;&#x83B7;&#x53D6;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x6548;&#x7387;&#x5C31;&#x4F1A;&#x63D0;&#x9AD8;&#x3002;</p>
<p>&#x4F7F;&#x7528;CountDownLatch&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;ExecutorService executor = Executors.newFixedThreadPool(5);</span><br><span class="line"></span><br><span class="line">CountDownLatch countDown = new CountDownLatch(requests.size());</span><br><span class="line">for(Request request:requests){</span><br><span class="line">    executor.execute(()-&gt;{</span><br><span class="line">        try{</span><br><span class="line">        //some opts</span><br><span class="line">        }finally{</span><br><span class="line">            countDown.countDown();</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line">countDown.await(200,TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x4F7F;&#x7528;CompletableFuture&#x6765;&#x66FF;&#x6362;&#x5B83;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;ExecutorService executor = Executors.newFixedThreadPool(5);</span><br><span class="line"></span><br><span class="line">List&lt;CompletableFuture&lt;Result&gt;&gt; futureList = requests</span><br><span class="line">    .stream()</span><br><span class="line">    .map(request-&gt;</span><br><span class="line">        CompletableFuture.supplyAsync(e-&gt;{</span><br><span class="line">            //some opts</span><br><span class="line">        },executor))</span><br><span class="line">    .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;Void&gt; allCF = CompletableFuture.allOf(futureList.toArray(new CompletableFuture[0]));</span><br><span class="line"></span><br><span class="line">allCF.join();</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x7528;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x5C31;&#x662F;allOf&#xFF0C;&#x7528;&#x6765;&#x628A;&#x6240;&#x6709;&#x7684;CompletableFuture&#x7EC4;&#x5408;&#x5728;&#x4E00;&#x8D77;&#xFF1B;&#x7C7B;&#x4F3C;&#x7684;&#x8FD8;&#x6709;anyOf&#xFF0C;&#x8868;&#x793A;&#x53EA;&#x8FD0;&#x884C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x3002;&#x5E38;&#x7528;&#x7684;&#xFF0C;&#x8FD8;&#x6709;&#x4E09;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p>
<ul>
<li>thenAcceptBoth &#x5904;&#x7406;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x7ED3;&#x679C;&#x5165;&#x53C2;&#xFF0C;&#x65E0;&#x8FD4;&#x56DE;&#x503C;</li>
<li>thenCombine &#x5904;&#x7406;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6709;&#x5165;&#x53C2;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x6700;&#x559C;&#x6B22;</li>
<li>runAfterBoth &#x5904;&#x7406;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x65E0;&#x5165;&#x53C2;&#xFF0C;&#x65E0;&#x8FD4;&#x56DE;&#x503C;</li>
</ul>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>&#x81EA;&#x4ECE;&#x8BA4;&#x8BC6;&#x4E86;CompletableFuture&#xFF0C;&#x6211;&#x5DF2;&#x7ECF;&#x5F88;&#x5C11;&#x786C;&#x7F16;&#x7801;Future&#x4E86;&#x3002;&#x76F8;&#x5BF9;&#x4E8E;&#x5404;&#x79CD;&#x56DE;&#x8C03;&#x7684;&#x5D4C;&#x5957;&#xFF0C;CompletableFuture&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x66F4;&#x76F4;&#x89C2;&#x3001;&#x66F4;&#x4F18;&#x7F8E;&#x7684;API&#x3002;&#x5728;&#x201C;&#x591A;&#x4E2A;&#x4EFB;&#x52A1;&#x7B49;&#x5F85;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#x201D;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x573A;&#x666F;&#xFF0C;CompletableFuture&#x5DF2;&#x7ECF;&#x6210;&#x4E86;&#x6211;&#x7684;&#x9996;&#x9009;&#x3002;</p>
<p>&#x552F;&#x4E00;&#x7684;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x5B83;&#x7684;&#x51FD;&#x6570;&#x6709;&#x70B9;&#x591A;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x719F;&#x6089;&#x4E00;&#x5C0F;&#x6BB5;&#x65F6;&#x95F4;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5C0F;&#x5C0F;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#xFF0C;&#x8FD9;&#x4E2A;&#x7C7B;&#x5982;&#x679C;&#x53EB;&#x505A;<code>Promise</code>&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x80FD;&#x591F;&#x548C;JS&#x7684;&#x7EDF;&#x4E00;&#x8D77;&#x6765;&#xFF0C;&#x7B97;&#x662F;&#x9526;&#x4E0A;&#x6DFB;&#x82B1;&#x5427;&#x3002;</p>
<blockquote>
<p>&#x4F5C;&#x8005;&#x7B80;&#x4ECB;&#xFF1A;&#x5C0F;&#x59D0;&#x59D0;&#x5473;&#x9053; (xjjdog)&#xFF0C;&#x4E00;&#x4E2A;&#x4E0D;&#x5141;&#x8BB8;&#x7A0B;&#x5E8F;&#x5458;&#x8D70;&#x5F2F;&#x8DEF;&#x7684;&#x516C;&#x4F17;&#x53F7;&#x3002;&#x805A;&#x7126;&#x57FA;&#x7840;&#x67B6;&#x6784;&#x548C;Linux&#x3002;&#x5341;&#x5E74;&#x67B6;&#x6784;&#xFF0C;&#x65E5;&#x767E;&#x4EBF;&#x6D41;&#x91CF;&#xFF0C;&#x4E0E;&#x4F60;&#x63A2;&#x8BA8;&#x9AD8;&#x5E76;&#x53D1;&#x4E16;&#x754C;&#xFF0C;&#x7ED9;&#x4F60;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x5473;&#x9053;&#x3002;&#x6211;&#x7684;&#x4E2A;&#x4EBA;&#x5FAE;&#x4FE1;xjjdog0&#xFF0C;&#x6B22;&#x8FCE;&#x6DFB;&#x52A0;&#x597D;&#x53CB;&#xFF0C;&#x8FDB;&#x4E00;&#x6B65;&#x4EA4;&#x6D41;&#x3002;</p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/1665a2ed387a5ecfe3d725e961b1dd3c.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7002818906532347934.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7002818906532347934.html" itemprop="url">Go117 新特性，凭什么让程序提速 5~10%？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-01T12:47:06+08:00">
                2021-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x5FAE;&#x4FE1;&#x641C;&#x7D22;&#x3010;<strong>&#x8111;&#x5B50;&#x8FDB;&#x714E;&#x9C7C;&#x4E86;</strong>&#x3011;&#x5173;&#x6CE8;&#x8FD9;&#x4E00;&#x53EA;&#x7206;&#x809D;&#x714E;&#x9C7C;&#x3002;&#x672C;&#x6587; <strong>GitHub</strong> <a href="/external_links/cf784971d795b59e964badd54c3248db.html" target="blank" rel="noopener">github.com/eddycjy/blo&#x2026;</a> &#x5DF2;&#x6536;&#x5F55;&#xFF0C;&#x6709;&#x6211;&#x7684;&#x7CFB;&#x5217;&#x6587;&#x7AE0;&#x3001;&#x8D44;&#x6599;&#x548C;&#x5F00;&#x6E90; Go &#x56FE;&#x4E66;&#x3002;</p>
</blockquote>
<p>&#x5927;&#x5BB6;&#x597D;&#xFF0C;&#x6211;&#x662F;&#x714E;&#x9C7C;&#x3002;</p>
<p>&#x5728; Go1.17 &#x53D1;&#x5E03;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x60CA;&#x559C;&#x7684;&#x53D1;&#x73B0; Go &#x8BED;&#x8A00;&#x4ED6;&#x53C8;&#x53C8;&#x53C8;&#x4F18;&#x5316;&#x4E86;&#xFF0C;&#x7F16;&#x8BD1;&#x5668;&#x6539;&#x8FDB;&#x540E;&#x4EA7;&#x751F;&#x4E86;&#x7EA6; 5% &#x7684;&#x6027;&#x80FD;&#x63D0;&#x5347;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7834;&#x574F;&#x6027;&#x4FEE;&#x6539;&#xFF0C;&#x4FDD;&#x8BC1;&#x4E86;&#x5411;&#x524D;&#x517C;&#x5BB9;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/3e8908759c54f47d2335baf9fe78f7cd387ab275a44d8fb004cca25520f6f073" alt></p>
<p>&#x4ED6;&#x505A;&#x4E86;&#x4E9B;&#x4EC0;&#x4E48;&#x5462;&#xFF0C;&#x597D;&#x50CF;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x5230;&#x6709;&#x4EBA;&#x63D0;&#x8D77;&#x3002;&#x4E3A;&#x6B64;&#x4ECA;&#x5929;&#x714E;&#x9C7C;&#x5E26;&#x5927;&#x5BB6;&#x6765;&#x89E3;&#x8BFB;&#x4E24;&#x65B0;&#x63D0;&#x6848;&#xFF1A;</p>
<ul>
<li>&#x300A;<a href="/external_links/94708ed36232c0319b5b0aa610f1618f.html" target="blank" rel="noopener">Proposal: Register-based Go calling convention</a>&#x300B;</li>
<li>&#x300A;<a href="/external_links/94708ed36232c0319b5b0aa610f1618f.html" target="blank" rel="noopener">Proposal: Create an undefined internal calling convention</a>&#x300B;</li>
</ul>
<p>&#x672C;&#x6587;&#x4F1A;&#x57FA;&#x4E8E;&#x63D0;&#x6848;&#x8BB2;&#x89E3;&#x548C;&#x62C6;&#x89E3;&#xFF0C;&#x6BD5;&#x7ADF;&#x5206;&#x4EAB;&#x65B0;&#x77E5;&#x8BC6;&#x80AF;&#x5B9A;&#x8981;&#x4ECE;&#x5B98;&#x65B9;&#x8D44;&#x6599;&#x4F5C;&#x4E3A;&#x4E8B;&#x5B9E;&#x57FA;&#x51C6;&#x51FA;&#x53D1;&#x3002;</p>
<h2 id="&#x80CC;&#x666F;"><a href="#&#x80CC;&#x666F;" class="headerlink" title="&#x80CC;&#x666F;"></a>&#x80CC;&#x666F;</h2><p>&#x5728;&#x4EE5;&#x5F80;&#x7684; Go &#x7248;&#x672C;&#x4E2D;&#xFF0C;Go &#x7684;&#x8C03;&#x7528;&#x7EA6;&#x5B9A;&#x7B80;&#x5355;&#x4E14;&#x51E0;&#x4E4E;&#x8DE8;&#x5E73;&#x53F0;&#x901A;&#x7528;&#xFF0C;&#x5176;&#x539F;&#x56E0;&#x5728;&#x4E8E;&#x9009;&#x7528;&#x4E86;&#x57FA;&#x4E8E; Plan9 ABI &#x7684;&#x5806;&#x6808;&#x8C03;&#x7528;&#x7EA6;&#x5B9A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<strong>&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x548C;&#x8FD4;&#x56DE;&#x503C;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x5806;&#x6808;&#x4E0A;&#x6765;&#x8FDB;&#x884C;&#x4F20;&#x9012;</strong>&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E00;&#x5171;&#x63D0;&#x5230;&#x4E86; Plan9 &#x548C; ABI&#xFF0C;&#x8FD9;&#x662F;&#x4E24;&#x4E2A;&#x5F88;&#x5173;&#x952E;&#x7684;&#x7406;&#x5FF5;&#xFF1A;</p>
<ul>
<li>Plan9&#xFF1A;Go &#x8BED;&#x8A00;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x6C47;&#x7F16;&#x5668;&#xFF0C;Rob Pike &#x662F;&#x8D1D;&#x5C14;&#x5B9E;&#x9A8C;&#x5BA4;&#x7684;&#x731B;&#x4EBA;&#x3002;</li>
<li>ABI&#xFF1A;Application Binary Interface&#xFF08;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E8C;&#x8FDB;&#x5236;&#x63A5;&#x53E3;&#xFF09;&#xFF0C;ABI &#x5305;&#x542B;&#x4E86;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0B;&#x8FD0;&#x884C;&#x65F6;&#x5FC5;&#x987B;&#x9075;&#x5B88;&#x7684;&#x7F16;&#x7A0B;&#x7EA6;&#x5B9A;&#xFF08;&#x4F8B;&#x5982;&#xFF1A;&#x4E8C;&#x8FDB;&#x5236;&#x63A5;&#x53E3;&#xFF09;&#x3002;</li>
</ul>
<p>&#x8BE5;&#x65B9;&#x6848;&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x4F18;&#x70B9;&#xFF1A;&#x5B9E;&#x73B0;&#x7B80;&#x5355;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x5B9E;&#x73B0;&#x6210;&#x672C;&#x3002;</li>
<li>&#x7F3A;&#x70B9;&#xFF1A;&#x6027;&#x80FD;&#x65B9;&#x9762;&#x4ED8;&#x51FA;&#x4E86;&#x4E0D;&#x5C11;&#x7684;&#x4EE3;&#x4EF7;&#x3002;</li>
</ul>
<p>&#x6309;&#x6211;&#x7406;&#x89E3;&#xFF0C;&#x5728; Go &#x8BED;&#x8A00;&#x521D;&#x521B;&#x65F6;&#x671F;&#xFF0C;&#x91C7;&#x53D6;&#x5148;&#x7B80;&#x5355;&#x5B9E;&#x73B0;&#xFF0C;&#x8DD1;&#x8D77;&#x6765;&#x518D;&#x8BF4;&#x3002;&#x4E5F;&#x5408;&#x7406;&#xFF0C;&#x6027;&#x80FD;&#x5012;&#x4E0D;&#x662F;&#x4E00;&#x4E2A; TOP1 &#x9700;&#x6C42;&#x3002;</p>
<h2 id="Go1-17-&#x4F18;&#x5316;"><a href="#Go1-17-&#x4F18;&#x5316;" class="headerlink" title="Go1.17 &#x4F18;&#x5316;"></a>Go1.17 &#x4F18;&#x5316;</h2><h3 id="&#x4EC0;&#x4E48;&#x662F;&#x8C03;&#x7528;&#x60EF;&#x4F8B;"><a href="#&#x4EC0;&#x4E48;&#x662F;&#x8C03;&#x7528;&#x60EF;&#x4F8B;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F;&#x8C03;&#x7528;&#x60EF;&#x4F8B;"></a>&#x4EC0;&#x4E48;&#x662F;&#x8C03;&#x7528;&#x60EF;&#x4F8B;</h3><p>&#x5728;&#x65B0;&#x7248;&#x672C;&#x7684;&#x4F18;&#x5316;&#x4E2D;&#xFF0C;&#x63D0;&#x5230;&#x4E86;&#x8C03;&#x7528;&#x60EF;&#x4F8B;&#xFF08;calling convention&#xFF09;&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x6307;&#x7684;&#x662F;<strong>&#x8C03;&#x7528;&#x65B9;&#x548C;&#x88AB;&#x8C03;&#x7528;&#x65B9;&#x5BF9;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7684;&#x5171;&#x8BC6;&#x7EA6;&#x5B9A;</strong>&#x3002;</p>
<p>&#x8FD9;&#x4E9B;&#x5171;&#x8BC6;&#x5305;&#x542B;&#xFF1A;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x3001;&#x8FD4;&#x56DE;&#x503C;&#x3001;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x987A;&#x5E8F;&#x3001;&#x4F20;&#x9012;&#x65B9;&#x5F0F;&#x7B49;&#x3002;</p>
<p>&#x53CC;&#x65B9;&#x90FD;&#x5FC5;&#x987B;&#x9075;&#x5FAA;&#x8FD9;&#x4E2A;&#x7EA6;&#x5B9A;&#x65F6;&#xFF0C;&#x7A0B;&#x5E8F;&#x7684;&#x51FD;&#x6570;&#x624D;&#x80FD;&#x6B63;&#x5E38;&#x7684;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x9075;&#x5FAA;&#xFF0C;&#x90A3;&#x4E48;&#x8BE5;&#x51FD;&#x6570;&#x662F;&#x6CA1;&#x6CD5;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#x7684;&#x3002;</p>
<h3 id="&#x4F18;&#x5316;&#x662F;&#x4EC0;&#x4E48;"><a href="#&#x4F18;&#x5316;&#x662F;&#x4EC0;&#x4E48;" class="headerlink" title="&#x4F18;&#x5316;&#x662F;&#x4EC0;&#x4E48;"></a>&#x4F18;&#x5316;&#x662F;&#x4EC0;&#x4E48;</h3><p>&#x5728; Go1.17 &#x8D77;&#xFF0C;&#x6B63;&#x5F0F;&#x5C06;&#x628A; Go &#x5185;&#x90E8; ABI &#x89C4;&#x8303;&#xFF08;&#x5728; Go &#x51FD;&#x6570;&#x4E4B;&#x95F4;&#x4F7F;&#x7528;&#xFF09;&#x4ECE;&#x57FA;&#x4E8E;&#x5806;&#x6808;&#x7684;&#x51FD;&#x6570;&#x53C2;&#x6570;&#x548C;&#x7ED3;&#x679C;&#x4F20;&#x9012;&#x7684;&#x65B9;&#x5F0F;<strong>&#x6539;&#x4E3A;&#x57FA;&#x4E8E;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x51FD;&#x6570;&#x53C2;&#x6570;&#x548C;&#x7ED3;&#x679C;&#x4F20;&#x9012;</strong>&#x3002;</p>
<p>&#x672C;&#x6B21;&#x4FEE;&#x6539;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x9879;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x8BE5;&#x4F18;&#x5316;&#x662F;&#x6301;&#x7EED;&#x7684;&#xFF0C;&#x539F;&#x672C;&#x9884;&#x8BA1;&#x662F; Go1.16 &#x5B9E;&#x73B0;&#xFF0C;&#x4E0D;&#x8FC7;&#x62D6;&#x5230;&#x4E86; Go1.17&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/e7a1aa98a0372387d9c144e5932fd1c83c810a3d92b3ddb486ecc7eb05fde082" alt></p>
<p>&#x76EE;&#x524D;&#x5B9E;&#x73B0;&#x4E86; amd64 &#x548C; arm64 &#x67B6;&#x6784;&#x7684;&#x652F;&#x6301;&#x3002;&#x8FD8;&#x6709;&#x4E0D;&#x5C11;&#x7684;&#x66F4;&#x591A;&#x7684;&#x652F;&#x6301;&#x4F1A;&#x6301;&#x7EED;&#x5728; Go1.18 &#x4E2D;&#x5B8C;&#x6210;&#xFF0C;&#x5177;&#x4F53;&#x8FDB;&#x5EA6;&#x53EF;&#x89C1; <a href="/external_links/a10f679534e4ad9151d02034e7805b17.html" target="blank" rel="noopener">issues #40724</a>&#x3002;</p>
<h3 id="&#x6027;&#x80FD;&#x5982;&#x4F55;"><a href="#&#x6027;&#x80FD;&#x5982;&#x4F55;" class="headerlink" title="&#x6027;&#x80FD;&#x5982;&#x4F55;"></a>&#x6027;&#x80FD;&#x5982;&#x4F55;</h3><p>&#x5728; <a href="/external_links/b8f372860e46f1a0ff07f9f03723cd66.html" target="blank" rel="noopener">Go1.17 Release Notes</a> &#x4E2D;&#x660E;&#x786E;&#x6307;&#x51FA;&#xFF0C;&#x7528;&#x4E00;&#x7EC4;&#x6709;&#x4EE3;&#x8868;&#x6027;&#x7684; Go &#x5305;&#x548C;&#x7A0B;&#x5E8F;&#x7684;&#x57FA;&#x51C6;&#x6D4B;&#x8BD5;&#x3002;</p>
<p>&#x5B98;&#x65B9;&#x6570;&#x636E;&#x663E;&#x793A;&#xFF1A;</p>
<ul>
<li>Go &#x7A0B;&#x5E8F;&#x7684;&#x8FD0;&#x884C;&#x6027;&#x80FD;&#x63D0;&#x9AD8;&#x4E86;&#x7EA6; 5%&#x3002;</li>
<li>Go &#x6240;&#x7F16;&#x8BD1;&#x51FA;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x5927;&#x5C0F;&#x7684;&#x51CF;&#x5C11;&#x7EA6; 2%&#x3002;</li>
</ul>
<p>&#x5728;&#x6C11;&#x95F4;&#x6570;&#x636E;&#x6765;&#x770B;&#xFF0C;&#x5728; <a href="/external_links/1a393c9e10a9a4565ae0d0004d4b9747.html" target="blank" rel="noopener">twitter</a> &#x770B;&#x5230; @Achille &#x8868;&#x793A;&#x4ECE; Go1.15.7 &#x5347;&#x7EA7;&#x5230; Go1.17 &#x540E;&#x663E;&#x793A;&#x3002;&#x5728;&#x4E00;&#x4E2A;&#x5927;&#x89C4;&#x6A21;&#x7684;&#x6570;&#x636E;&#x5904;&#x7406;&#x7CFB;&#x7EDF;&#x4E0A;&#x8FDB;&#x884C;&#x7684; Go1.17 &#x5347;&#x7EA7;&#x4EA7;&#x751F;&#x4E86;&#x60CA;&#x4EBA;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4ED6;&#x7684;&#x771F;&#x5B9E;&#x6570;&#x636E;&#x3002;</p>
<p>CPU&#x3001;Malloc &#x8C03;&#x7528;&#x65F6;&#x95F4;&#x51CF;&#x5C11;&#x4E86;&#x7EA6;15%&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/15b691cfc0b51d194962575f2616db2dd52d3925a2b90d7d0cc6d92af73c4ddc" alt="&#x56FE;&#x6765;&#x81EA; @Achille"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/e6ae7acd4fe2a2d6f2bc880a024c8a786dd3a4a96e25f9dda1811012f1ea457f" alt="&#x56FE;&#x6765;&#x81EA; @Achille"></p>
<p>RSS &#x5927;&#x5C0F;&#x66F4;&#x63A5;&#x8FD1;&#x4E8E;&#x5806;&#x7684;&#x5927;&#x5C0F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/3ae6cd88e445eaf02460bfd709ed57dfdd0486901145f84e9438fdac1d43b6c9" alt="&#x56FE;&#x6765;&#x81EA; @Achille"></p>
<p>&#x4ECE;&#x539F;&#x672C;&#x7684; 1.6GB &#x964D;&#x81F3; 1GB&#x3002;</p>
<p>&#x7ED3;&#x5408;&#x5B98;&#x65B9;&#x548C;&#x6C11;&#x95F4;&#x6570;&#x636E;&#x6765;&#x770B;&#xFF0C;&#x4F18;&#x5316;&#x6548;&#x679C;&#x662F;&#x660E;&#x786E;&#x4E14;&#x6709;&#x6548;&#x7684;&#x3002;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x6D4B;&#x4E00;&#x6D4B;&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x5728; Go1.17 &#x8FD9;&#x4E00;&#x4E2A;&#x65B0;&#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x7B80;&#x5355;&#x7684;&#x5347;&#x4E00;&#x5347; Go &#x7248;&#x672C;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x5F97;&#x5230;&#x4E00;&#x5B9A;&#x7684;&#x6027;&#x80FD;&#x4F18;&#x5316;&#xFF0C;&#x8FD9;&#x662F;&#x975E;&#x5E38;&#x4E0D;&#x9519;&#x7684;&#x3002;</p>
<p>&#x4ECE;&#x4EE5;&#x5F80;&#x7684;&#x57FA;&#x4E8E;&#x5806;&#x6808;&#x7684;&#x51FD;&#x6570;&#x53C2;&#x6570;&#x548C;&#x7ED3;&#x679C;&#x4F20;&#x9012;&#x7684;&#x65B9;&#x5F0F;&#x6539;&#x4E3A; Go1.17~Go1.18 &#x57FA;&#x4E8E;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x51FD;&#x6570;&#x53C2;&#x6570;&#x548C;&#x7ED3;&#x679C;&#x4F20;&#x9012;&#xFF0C;Go &#x8BED;&#x8A00;&#x6B63;&#x5728;&#x4E00;&#x6B65;&#x6B65;&#x8D70;&#x7684;&#x66F4;&#x597D;&#xFF01;</p>
<p>&#x4F60;&#x89C9;&#x5F97;&#x5462;&#xFF1F;</p>
<p>&#x82E5;&#x6709;&#x4EFB;&#x4F55;&#x7591;&#x95EE;&#x6B22;&#x8FCE;&#x8BC4;&#x8BBA;&#x533A;&#x53CD;&#x9988;&#x548C;&#x4EA4;&#x6D41;&#xFF0C;<strong>&#x6700;&#x597D;&#x7684;&#x5173;&#x7CFB;&#x662F;&#x4E92;&#x76F8;&#x6210;&#x5C31;</strong>&#xFF0C;&#x5404;&#x4F4D;&#x7684;<strong>&#x70B9;&#x8D5E;</strong>&#x5C31;&#x662F;<a href="/external_links/8675c34314d48bf25069969f66e7f680.html" target="blank" rel="noopener">&#x714E;&#x9C7C;</a>&#x521B;&#x4F5C;&#x7684;&#x6700;&#x5927;&#x52A8;&#x529B;&#xFF0C;&#x611F;&#x8C22;&#x652F;&#x6301;&#x3002;</p>
<blockquote>
<p>&#x6587;&#x7AE0;&#x6301;&#x7EED;&#x66F4;&#x65B0;&#xFF0C;&#x53EF;&#x4EE5;&#x5FAE;&#x4FE1;&#x641C;&#x3010;&#x8111;&#x5B50;&#x8FDB;&#x714E;&#x9C7C;&#x4E86;&#x3011;&#x9605;&#x8BFB;&#xFF0C;&#x56DE;&#x590D;&#x3010;<strong>000</strong>&#x3011;&#x6709;&#x6211;&#x51C6;&#x5907;&#x7684;&#x4E00;&#x7EBF;&#x5927;&#x5382;&#x9762;&#x8BD5;&#x7B97;&#x6CD5;&#x9898;&#x89E3;&#x548C;&#x8D44;&#x6599;&#xFF1B;&#x672C;&#x6587; <strong>GitHub</strong> <a href="/external_links/cf784971d795b59e964badd54c3248db.html" target="blank" rel="noopener">github.com/eddycjy/blo&#x2026;</a> &#x5DF2;&#x6536;&#x5F55;&#xFF0C;&#x6B22;&#x8FCE; Star &#x50AC;&#x66F4;&#x3002;</p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2472386e23f691ad5d2800029818943c.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../180/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../180/">180</a><span class="page-number current">181</span><a class="page-number" href="../182/">182</a><span class="space">&hellip;</span><a class="page-number" href="../298/">298</a><a class="extend next" rel="next" href="../182/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">2975</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1162</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
