<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/239/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/239/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016147287889936397.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016147287889936397.html" itemprop="url">现在准备好告别Transform了吗？   拥抱AGP70</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-07T10:35:34+08:00">
                2021-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x524D;&#x6587;&#x63D0;&#x8981;"><a href="#&#x524D;&#x6587;&#x63D0;&#x8981;" class="headerlink" title="&#x524D;&#x6587;&#x63D0;&#x8981;"></a>&#x524D;&#x6587;&#x63D0;&#x8981;</h1><p>&#x4E4B;&#x524D;&#x5C31;&#x548C;&#x5927;&#x5BB6;&#x4ECB;&#x7ECD;&#x8FC7;<code>AGP(Android Gradle Plugin) 7.0.0</code>&#x7248;&#x672C;&#x4E4B;&#x540E;<code>Transform</code> &#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#x5373;&#x5C06;&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x800C;&#x4E14;&#x4E5F;&#x7B80;&#x5355;&#x7684;&#x4ECB;&#x7ECD;&#x4E86;&#x66FF;&#x6362;&#x7684;&#x65B9;&#x5F0F;&#x662F;<code>Transform Action</code>&#xFF0C;&#x7ECF;&#x8FC7;&#x6211;&#x8FD9;&#x4E00;&#x9635;&#x5B50;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x8C03;&#x7814;&#xFF0C;&#x53D1;&#x73B0;&#x53EA;&#x80FD;&#x8BF4;&#x7B54;&#x5BF9;&#x4E86;&#x4E00;&#x534A;&#x5427;&#x3002;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x4E2A;&#x65B0;&#x4E1C;&#x897F;<code>AsmClassVisitorFactory</code>&#x3002;</p>
<blockquote>
<p>com.android.build.api.instrumentation.AsmClassVisitorFactory</p>
</blockquote>
<blockquote>
<p>A factory to create class visitor objects to instrument classes.</p>
</blockquote>
<blockquote>
<p>The implementation of this interface must be an abstract class where the parameters and instrumentationContext are left unimplemented. The class must have an empty constructor which will be used to construct the factory object.</p>
</blockquote>
<p>&#x5F53;&#x524D;&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x7684;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x5C31;&#x662F;&#x57FA;&#x4E8E;<code>gradle</code>&#x539F;&#x751F;&#x7684;<code>Transform Action</code>&#xFF0C;&#x8FD9;&#x6B21;&#x7684;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x8D70;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5F2F;&#x8DEF;&#xFF0C;&#x4E00;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x4F46;&#x662F;&#x8C8C;&#x4F3C;&#x5F2F;&#x5F2F;&#x7ED5;&#x7ED5;&#x7684;&#xFF0C;&#x6700;&#x540E;&#x4E5F;&#x6CA1;&#x6709;&#x6210;&#x529F;&#xFF0C;&#x800C;&#x4E14;<code>Transform Action</code>&#x7684;&#x8F93;&#x5165;&#x4EA7;&#x7269;&#x90FD;&#x662F;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#xFF0C;&#x4FEE;&#x6539;&#x4E5F;&#x662F;&#x9488;&#x5BF9;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8C8C;&#x4F3C;&#x4E5F;&#x4E0D;&#x5B8C;&#x5168;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x66FF;&#x6362;&#x65B9;&#x6848;&#xFF0C;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#x90A3;&#x79CD;&#x590D;&#x6742;&#x7684;asm&#x64CD;&#x4F5C;&#x5219;&#x65E0;&#x6CD5;&#x8D1F;&#x8377;&#x4E86;&#x3002;</p>
<p><code>AsmClassVisitorFactory</code>&#x6839;&#x636E;&#x5B98;&#x65B9;&#x8BF4;&#x6CD5;&#xFF0C;&#x7F16;&#x8BD1;&#x901F;&#x5EA6;&#x4F1A;&#x6709;&#x63D0;&#x5347;&#xFF0C;&#x5927;&#x6982;18%&#x5DE6;&#x53F3;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x4F7F;&#x7528;&#x9636;&#x6BB5;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/eb512df978086ed6171d07aa640131c11ea20be09dd96307e7c6d6b5ba9cf2ff" alt="image.png"></p>
<h1 id="&#x5B66;&#x5E9F;&#x4E86;"><a href="#&#x5B66;&#x5E9F;&#x4E86;" class="headerlink" title="&#x5B66;&#x5E9F;&#x4E86;"></a>&#x5B66;&#x5E9F;&#x4E86;</h1><p>&#x6211;&#x4EEC;&#x5148;&#x4ECE;<code>AsmClassVisitorFactory</code>&#x8FD9;&#x4E2A;&#x62BD;&#x8C61;&#x63A5;&#x53E3;&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#x8D77;&#x5427;&#x3002;</p>
<h2 id="AsmClassVisitorFactory"><a href="#AsmClassVisitorFactory" class="headerlink" title="AsmClassVisitorFactory"></a>AsmClassVisitorFactory</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface AsmClassVisitorFactory&lt;ParametersT : InstrumentationParameters&gt; : Serializable {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The parameters that will be instantiated, configured using the given config when registering</span><br><span class="line">     * the visitor, and injected on instantiation.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val parameters: Property&lt;ParametersT&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Contains parameters to help instantiate the visitor objects.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val instrumentationContext: InstrumentationContext</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a class visitor object that will visit a class with the given [classContext]. The</span><br><span class="line">     * returned class visitor must delegate its calls to [nextClassVisitor].</span><br><span class="line">     *</span><br><span class="line">     * The given [classContext] contains static information about the classes before starting the</span><br><span class="line">     * instrumentation process. Any changes in interfaces or superclasses for the class with the</span><br><span class="line">     * given [classContext] or for any other class in its classpath by a previous visitor will</span><br><span class="line">     * not be reflected in the [classContext] object.</span><br><span class="line">     *</span><br><span class="line">     * [classContext] can also be used to get the data for classes that are in the runtime classpath</span><br><span class="line">     * of the class being visited.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     *</span><br><span class="line">     * @param classContext contains information about the class that will be instrumented by the</span><br><span class="line">     *                     returned class visitor.</span><br><span class="line">     * @param nextClassVisitor the [ClassVisitor] to which the created [ClassVisitor] must delegate</span><br><span class="line">     *                         method calls.</span><br><span class="line">     */</span><br><span class="line">    fun createClassVisitor(</span><br><span class="line">        classContext: ClassContext,</span><br><span class="line">        nextClassVisitor: ClassVisitor</span><br><span class="line">    ): ClassVisitor</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Whether or not the factory wants to instrument the class with the given [classData].</span><br><span class="line">     *</span><br><span class="line">     * If returned true, [createClassVisitor] will be called and the returned class visitor will</span><br><span class="line">     * visit the class.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     */</span><br><span class="line">    fun isInstrumentable(classData: ClassData): Boolean</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;&#x4E0B;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x5728;<code>createClassVisitor</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#xFF0C;&#x6B63;&#x5E38;&#x6211;&#x4EEC;&#x5728;&#x6784;&#x9020;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#x65F6;&#x5019;&#x662F;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4E4B;&#x540E;&#x5728;new&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;nextClassVisitor&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;<code>isInstrumentable</code>,&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x5426;&#x8981;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x6240;&#x6709;&#x7C7B;&#x90FD;&#x8981;&#x901A;&#x8FC7;ClassVisitor&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x8FD8;&#x662F;&#x592A;&#x8017;&#x65F6;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FC7;&#x6EE4;&#x6389;&#x5F88;&#x591A;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x7C7B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface ClassData {</span><br><span class="line">    /**</span><br><span class="line">     * Fully qualified name of the class.</span><br><span class="line">     */</span><br><span class="line">    val className: String</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of the annotations the class has.</span><br><span class="line">     */</span><br><span class="line">    val classAnnotations: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the interfaces that this class or a superclass of this class implements.</span><br><span class="line">     */</span><br><span class="line">    val interfaces: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the super classes that this class or a super class of this class extends.</span><br><span class="line">     */</span><br><span class="line">    val superClasses: List&lt;String&gt;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><code>ClassData</code>&#x5E76;&#x4E0D;&#x662F;asm&#x7684;api&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x5185;&#x5BB9;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x6BD4;&#x8F83;&#x5C11;&#xFF0C;&#x4F46;&#x662F;&#x5E94;&#x8BE5;&#x4E5F;&#x52C9;&#x5F3A;&#x591F;&#x7528;&#x4E86;&#x3002;&#x8FD9;&#x90E8;&#x5206;&#x5927;&#x5BB6;&#x7B80;&#x5355;&#x770B;&#x770B;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x5C31;&#x4E0D;&#x591A;&#x505A;&#x4ECB;&#x7ECD;&#x4E86;&#x5462;&#x3002;</p>
<h2 id="&#x65B0;&#x7684;Extension"><a href="#&#x65B0;&#x7684;Extension" class="headerlink" title="&#x65B0;&#x7684;Extension"></a>&#x65B0;&#x7684;Extension</h2><p>AGP&#x7248;&#x672C;&#x5347;&#x7EA7;&#x4E4B;&#x540E;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x4E3A;&#x4E86;&#x533A;&#x5206;&#x65B0;&#x65E7;&#x7248;&#x7684;<code>Extension</code>,&#x6240;&#x4EE5;&#x5728;<code>AppExtension</code>&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x65B0;&#x589E;&#x4E86;&#x4E00;&#x4E2A;<code>AndroidComponentsExtension</code>&#x51FA;&#x6765;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x7684;<code>transformClassesWith</code>&#x5C31;&#x9700;&#x8981;&#x6CE8;&#x518C;&#x5728;&#x8FD9;&#x4E2A;&#x4E0A;&#x9762;&#x3002;&#x8FD9;&#x4E2A;&#x9700;&#x8981;&#x8003;&#x8651;&#x5230;&#x53D8;&#x79CD;&#xFF0C;&#x548C;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x8FD8;&#x662F;&#x6709;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x533A;&#x522B;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x53D8;&#x79CD;&#x589E;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x9002;&#x914D;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;        val androidComponents = project.extensions.getByType(AndroidComponentsExtension::class.java)</span><br><span class="line">        androidComponents.onVariants { variant -&gt;</span><br><span class="line">            variant.transformClassesWith(PrivacyClassVisitorFactory::class.java,</span><br><span class="line">                    InstrumentationScope.ALL) {}</span><br><span class="line">            variant.setAsmFramesComputationMode(FramesComputationMode.COPY_FRAMES)</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<h2 id="&#x5B9E;&#x6218;"><a href="#&#x5B9E;&#x6218;" class="headerlink" title="&#x5B9E;&#x6218;"></a>&#x5B9E;&#x6218;</h2><p>&#x8FD9;&#x6B21;&#x8FD8;&#x662F;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x654F;&#x611F;&#x6743;&#x9650;api&#x66FF;&#x6362;&#x7684;&#x5B57;&#x8282;&#x7801;&#x66FF;&#x6362;&#x5DE5;&#x5177;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x5F00;&#x53D1;&#x3002;</p>
<h3 id="ClassVisitor"><a href="#ClassVisitor" class="headerlink" title="ClassVisitor"></a>ClassVisitor</h3><p>&#x770B;&#x770B;&#x6211;&#x4EEC;&#x6B63;&#x5E38;&#x662F;&#x5982;&#x4F55;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;ClassVisitor&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">ClassVisitor methodFilterCV = new ClassFilterVisitor(classWriter);</span><br><span class="line">ClassReader cr = new ClassReader(srcClass);</span><br><span class="line">cr.accept(methodFilterCV, ClassReader.SKIP_DEBUG);</span><br><span class="line">return classWriter.toByteArray();</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4F1A;&#x6784;&#x9020;&#x597D;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;<code>ClassWriter</code>&#xFF0C;&#x63A5;&#x7740;&#x4F1A;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x5165;&#x8FD9;&#x4E2A;<code>ClassWriter</code>&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassReader</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x5C06;byte&#x6570;&#x7EC4;&#x4F20;&#x5165;&#xFF0C;&#x4E4B;&#x540E;&#x8C03;&#x7528;classReader.accept&#x65B9;&#x6CD5;&#xFF0C;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x5728;visitor&#x4E2D;&#x9010;&#x4E2A;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x7C7B;&#x4FE1;&#x606F;&#xFF0C;&#x65B9;&#x6CD5;&#x5565;&#x7684;&#x90FD;&#x662F;&#x901A;&#x8FC7;ClassReader&#x8BFB;&#x5165;&#x7684;&#xFF0C;&#x7136;&#x540E;&#x7531;&#x5F53;&#x524D;&#x7684;<code>ClassVisitor</code>&#x8BBF;&#x95EE;&#x5B8C;&#x4E4B;&#x540E;&#x4EA4;&#x7ED9;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x4E00;&#x4E2A;<code>ClassWriter</code>&#x3002;</p>
<p>&#x5176;&#x4E2D;<code>ClassWriter</code>&#x4E5F;&#x662F;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5BF9;&#x8C61;&#xFF0C;&#x4ED6;&#x590D;&#x6742;&#x91CD;&#x65B0;&#x5C06;&#x4FEE;&#x6539;&#x8FC7;&#x7684;&#x7C7B;&#x8F6C;&#x5316;&#x6210;byte&#x6570;&#x636E;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5F97;&#x51FA;&#x6765;<code>ClassVisitor</code>&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x4E4B;&#x540E;&#x9010;&#x5C42;&#x5411;&#x4E0B;&#x8BBF;&#x95EE;&#x3002;</p>
<p>&#x4ECB;&#x7ECD;&#x5B8C;&#x4E86;&#x8FD9;&#x4E2A;&#x54E6;&#xFF0C;&#x6211;&#x4EEC;&#x505A;&#x4E2A;&#x5927;&#x80C6;&#x7684;&#x5047;&#x8BBE;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;<code>ClassVisitor</code>&#x94FE;&#x8868;&#x524D;&#x63D2;&#x5165;&#x51E0;&#x4E2A;&#x4E0D;&#x540C;&#x7684;<code>ClassVisitor</code>&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x5C31;&#x53EF;&#x4EE5;&#x8BA9;asm&#x4FEE;&#x6539;&#x9010;&#x4E2A;&#x751F;&#x6548;&#xFF0C;&#x7136;&#x540E;&#x4E5F;&#x4E0D;&#x9700;&#x8981;&#x591A;&#x4F59;&#x7684;io&#x64CD;&#x4F5C;&#x4E86;&#x5462;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x65B0;&#x7684;asm api &#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E86;&#xFF0C;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x8FB9;&#x5927;&#x4F6C;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6846;&#x67B6;&#x5927;&#x4F6C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;&#x53E6;&#x5916;bytex&#x5185;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002;</p>
<blockquote>
<p>tips ClassNode &#x56E0;&#x4E3A;&#x662F;&#x5148;&#x751F;&#x6210;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#xFF0C;&#x6240;&#x4EE5;&#x548C;&#x4E00;&#x822C;&#x7684;ClassVisitor&#x6709;&#x70B9;&#x5C0F;&#x533A;&#x522B;&#xFF0C;&#x9700;&#x8981;&#x5728;visitEnd&#x65B9;&#x6CD5;&#x5185;&#x8C03;&#x7528;accept(next)</p>
</blockquote>
<h3 id="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"><a href="#&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"></a>&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x4E0A;&#x5B9E;&#x6218;&#x54AF;&#x3002;&#x6211;&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7801;&#x5957;&#x7528;&#x5230;&#x8FD9;&#x6B21;&#x7684;&#x903B;&#x8F91;&#x4E0A;&#x6765;&#x3002;</p>
<blockquote>
<p><a href="/external_links/c45b99434aac9aa2e2a217e90ec1e916.html" target="blank" rel="noopener">demo&#x5730;&#x5740;</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;abstract class PrivacyClassVisitorFactory : AsmClassVisitorFactory&lt;InstrumentationParameters.None&gt; {</span><br><span class="line"></span><br><span class="line">    override fun createClassVisitor(classContext: ClassContext, nextClassVisitor: ClassVisitor): ClassVisitor {</span><br><span class="line">        return PrivacyClassNode(nextClassVisitor)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    override fun isInstrumentable(classData: ClassData): Boolean {</span><br><span class="line">        return true</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;isInstrumentable&#x90FD;&#x8FD4;&#x56DE;&#x7684;&#x662F;true&#xFF0C;&#x5176;&#x5B9E;&#x6211;&#x53EF;&#x4EE5;&#x5C06;&#x626B;&#x63CF;&#x89C4;&#x5219;&#x9650;&#x5B9A;&#x5728;&#x7279;&#x5B9A;&#x5305;&#x540D;&#x5185;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x52A0;&#x5FEB;&#x6784;&#x5EFA;&#x901F;&#x5EA6;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;class PrivacyClassNode(private val nextVisitor: ClassVisitor) : ClassNode(Opcodes.ASM5) {</span><br><span class="line">    override fun visitEnd() {</span><br><span class="line">        super.visitEnd()</span><br><span class="line">        PrivacyHelper.whiteList.let {</span><br><span class="line">            val result = it.firstOrNull { whiteName -&gt;</span><br><span class="line">                name.contains(whiteName, true)</span><br><span class="line">            }</span><br><span class="line">            result</span><br><span class="line">        }.apply {</span><br><span class="line">            if (this == null) {</span><br><span class="line">                //   println(&quot;filter: $name&quot;)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        PrivacyHelper.whiteList.firstOrNull {</span><br><span class="line">            name.contains(it, true)</span><br><span class="line">        }?.apply {</span><br><span class="line">            val iterator: Iterator&lt;MethodNode&gt; = methods.iterator()</span><br><span class="line">            while (iterator.hasNext()) {</span><br><span class="line">                val method = iterator.next()</span><br><span class="line">                method.instructions?.iterator()?.forEach {</span><br><span class="line">                    if (it is MethodInsnNode) {</span><br><span class="line">                        it.isPrivacy()?.apply {</span><br><span class="line">                            println(&quot;privacy transform classNodeName: ${name@this}&quot;)</span><br><span class="line">                            it.opcode = code</span><br><span class="line">                            it.owner = owner</span><br><span class="line">                            it.name = name</span><br><span class="line">                            it.desc = desc</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        accept(nextVisitor)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private fun MethodInsnNode.isPrivacy(): PrivacyAsmEntity? {</span><br><span class="line">    val pair = PrivacyHelper.privacyList.firstOrNull {</span><br><span class="line">        val first = it.first</span><br><span class="line">        first.owner == owner &amp;&amp; first.code == opcode &amp;&amp; first.name == name &amp;&amp; first.desc == desc</span><br><span class="line">    }</span><br><span class="line">    return pair?.second</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x628A;&#x903B;&#x8F91;&#x62BD;&#x8C61;&#x5B9A;&#x4E49;&#x5728;&#x7C7B;<code>ClassNode</code>&#x5185;&#xFF0C;&#x7136;&#x540E;&#x5728;<code>visitEnd</code>&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x6211;&#x4E4B;&#x524D;&#x8BF4;&#x7684;<code>accept(nextVisitor)</code>&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;&#x6CE8;&#x518C;&#x903B;&#x8F91;&#x4E86;&#xFF0C;&#x548C;&#x6211;&#x524D;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x5185;&#x5BB9;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h1 id="&#x6211;&#x7684;&#x89C2;&#x70B9;"><a href="#&#x6211;&#x7684;&#x89C2;&#x70B9;" class="headerlink" title="&#x6211;&#x7684;&#x89C2;&#x70B9;"></a>&#x6211;&#x7684;&#x89C2;&#x70B9;</h1><p><code>AsmClassVisitorFactory</code>&#x76F8;&#x6BD4;&#x8F83;&#x4E8E;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x786E;&#x5B9E;&#x7B80;&#x5316;&#x4E86;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x5FC3;&#x4E4B;&#x524D;&#x7684;&#x589E;&#x91CF;&#x66F4;&#x65B0;&#x7B49;&#x7B49;&#x903B;&#x8F91;&#xFF0C;&#x53EA;&#x8981;&#x4E13;&#x6CE8;&#x4E8E;asm api&#x7684;&#x64CD;&#x4F5C;&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x5176;&#x6B21;&#x5C31;&#x662F;&#x56E0;&#x4E3A;&#x51CF;&#x5C11;&#x4E86;io&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x901F;&#x5EA6;&#x81EA;&#x7136;&#x4E5F;&#x5C31;&#x6BD4;&#x4E4B;&#x524D;&#x6709;&#x6240;&#x63D0;&#x5347;&#x3002;&#x540C;&#x65F6;&#x56E0;&#x4E3A;&#x57FA;&#x4E8E;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x4F53;&#x6027;&#x80FD;&#x8FD8;&#x662F;&#x975E;&#x5E38;ok&#x7684;&#xFF0C;&#x90A3;&#x90E8;&#x5206;&#x589E;&#x91CF;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x66F4;&#x7B80;&#x5355;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x6211;&#x4E5F;&#x548C;&#x6211;&#x7684;&#x540C;&#x4E8B;&#x5927;&#x4F6C;&#x4EA4;&#x6D41;&#x8FC7;&#x54E6;&#xFF0C;&#x590D;&#x6742;&#x7684;&#x8FD9;&#x79CD;&#x7C7B;&#x4F3C;&#x4E0A;&#x7BC7;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#xFF0C;&#x6700;&#x597D;&#x8FD8;&#x662F;&#x4F7F;&#x7528;<code>Gradle Task</code>&#x7684;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x611F;&#x8C22; <a href="/external_links/bf5bb51389a5b3f64585ab7cb0ea718d.html" target="blank" rel="noopener">2BAB</a> &#x548C; <a href="/external_links/805a04201367bbabc8e0521f2b5c695d.html" target="blank" rel="noopener">&#x68EE;&#x54E5;</a>&#xFF0C;&#x6587;&#x7AE0;&#x5F88;&#x591A;&#x5185;&#x5BB9;&#x90FD;&#x53C2;&#x8003;&#x4E86;&#x51E0;&#x4F4D;&#x5927;&#x4F6C;&#x7684;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6211;&#x6253;&#x7B97;&#x653E;&#x98DE;&#x81EA;&#x5DF1;&#x4E86;&#xFF0C;&#x6587;&#x7AE0;&#x5B57;&#x6570;&#x5C31;&#x968F;&#x4FBF;&#x4E86;&#x5427;&#xFF0C;&#x4E0D;&#x8981;&#x8001;&#x76EF;&#x7740;&#x6587;&#x7AE0;&#x957F;&#x77ED;&#x95EE;&#x9898;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2deba0e41a9fb9d23a891b44798282dd.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015978312606449677.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015978312606449677.html" itemprop="url">Shell编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T23:48:55+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Shell&#x7C7B;&#x578B;"><a href="#Shell&#x7C7B;&#x578B;" class="headerlink" title="Shell&#x7C7B;&#x578B;"></a>Shell&#x7C7B;&#x578B;</h2><p>shell&#x79CD;&#x7C7B;&#x7279;&#x522B;&#x7684;&#x591A;&#xFF0C;&#x4E00;&#x822C;&#x5728;Linux&#x4E0B;&#x9ED8;&#x8BA4;&#x90FD;&#x662F;bash&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>cat /etc/passwd</code>&#x67E5;&#x770B;&#x6BCF;&#x4E2A;&#x7528;&#x6237;&#x9ED8;&#x8BA4;&#x7684;shell&#x3002;&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x5728;&#x5DE5;&#x4F5C;&#x4E2D;&#x53EF;&#x80FD;&#x4F1A;&#x7528;&#x5230;zsh&#xFF0C;&#x5176;&#x5B9E;zsh&#x662F;&#x517C;&#x5BB9;bash&#x7684;&#x3002;</p>
<p>&#x4E00;&#x822C;&#x5728;shell&#x4E0B;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;&#x6709;&#x4E24;&#x79CD;&#xFF1A;</p>
<ul>
<li>&#x5185;&#x5EFA;&#x547D;&#x4EE4;</li>
<li>&#x975E;&#x5185;&#x5EFA;&#x547D;&#x4EE4;<br>&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#x5728;&#x6267;&#x884C;&#x65F6;&#x4E00;&#x822C;&#x4E0D;&#x4F1A;fork&#x51FA;&#x5B50;shell&#xFF0C;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#x6709;<code>cd&#x3001;alias&#x3001;exit</code>&#xFF0C;&#x4E00;&#x822C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>which cmd</code>&#x53EF;&#x4EE5;&#x67E5;&#x51FA;&#x547D;&#x4EE4;&#x662F;&#x4E0D;&#x662F;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#x3002;&#x4E0D;&#x7BA1;&#x662F;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#xFF0C;&#x8FD8;&#x662F;&#x975E;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>$?</code>&#x6765;&#x83B7;&#x53D6;&#x547D;&#x4EE4;&#x7684;&#x8FD4;&#x56DE;&#x7801;(&#x8FD4;&#x56DE;&#x5417;&#x4E00;&#x822C;&#x662F;0&#x8868;&#x793A;&#x6210;&#x529F;&#xFF0C;&#x975E;0&#x8868;&#x793A;&#x5931;&#x8D25;)&#x3002;</li>
</ul>
<h2 id="Shell&#x5982;&#x4F55;&#x6267;&#x884C;&#x547D;&#x4EE4;"><a href="#Shell&#x5982;&#x4F55;&#x6267;&#x884C;&#x547D;&#x4EE4;" class="headerlink" title="Shell&#x5982;&#x4F55;&#x6267;&#x884C;&#x547D;&#x4EE4;"></a>Shell&#x5982;&#x4F55;&#x6267;&#x884C;&#x547D;&#x4EE4;</h2><p>&#x6267;&#x884C;&#x547D;&#x4EE4;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x662F;&#x5206;&#x5355;&#x6761;&#x6267;&#x884C;&#x8FD8;&#x662F;&#x591A;&#x6761;&#x6267;&#x884C;&#x3002;</p>
<h3 id="&#x5355;&#x6761;&#x6267;&#x884C;"><a href="#&#x5355;&#x6761;&#x6267;&#x884C;" class="headerlink" title="&#x5355;&#x6761;&#x6267;&#x884C;"></a>&#x5355;&#x6761;&#x6267;&#x884C;</h3><p>&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5E38;&#x7528;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x662F;&#x5982;&#x679C;&#x662F;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#x5C31;&#x4E0D;&#x4F1A;fork&#x800C;&#x5DF2;&#xFF0C;&#x975E;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#x4F1A;<code>fork/exec/wait</code>&#x3002;</p>
<h3 id="&#x591A;&#x6761;&#x6267;&#x884C;"><a href="#&#x591A;&#x6761;&#x6267;&#x884C;" class="headerlink" title="&#x591A;&#x6761;&#x6267;&#x884C;"></a>&#x591A;&#x6761;&#x6267;&#x884C;</h3><p>&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8BF4;&#x5199;&#x7684;&#x811A;&#x672C;(&#x6279;&#x5904;&#x7406;)&#xFF0C;&#x628A;&#x591A;&#x6761;&#x547D;&#x4EE4;&#x653E;&#x5230;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x5757;&#x6267;&#x884C;&#x3002;<br>&#x6BD4;&#x5982;&#x6709;&#x5982;&#x4E0B;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#xFF0C;&#x6587;&#x4EF6;&#x540D;&#x4E3A;&#xFF1A;<code>script.sh</code>&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#! /bin/sh</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p>&#x4E00;&#x822C;&#x6709;&#x4E24;&#x79CD;&#x6267;&#x884C;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ol>
<li>&#x4EE5;&#x4E00;&#x79CD;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x6267;&#x884C;&#x3002;</li>
</ol>
<p><code>chmod +x script.sh</code>&#x7136;&#x540E;<code>./script.sh</code>&#x5C31;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x4E86;&#x3002;&#x8FD9;&#x79CD;&#x6267;&#x884C;&#x65B9;&#x5F0F;&#x7684;&#x5927;&#x6982;&#x6D41;&#x7A0B;&#x4E3A;:&#x5148;fork&#x51FA;&#x4E00;&#x4E2A;&#x5B50;shell&#xFF0C;&#x5728;&#x5B50;shell&#x6267;&#x884C;&#x901A;&#x8FC7;exec&#x6765;&#x6267;&#x884C;&#x8BE5;&#x811A;&#x672C;&#x4E2D;&#x7B2C;&#x4E00;&#x884C;&#x6240;&#x6307;&#x5B9A;&#x7684;<code>/bin/sh</code>&#x7684;&#x89E3;&#x91CA;&#x5668;(&#x76F8;&#x5F53;&#x4E8E;&#x5C06;<code>sh</code>&#x7684;&#x4EE3;&#x7801;&#x6BB5;&#x52A0;&#x8F7D;&#x5230;&#x8FD9;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x4E2D;&#x6765;)&#xFF0C;&#x800C;&#x5F53;&#x524D;<code>script.sh</code>&#x662F;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x6765;&#x4F20;&#x9012;&#x7ED9;<code>sh</code>&#x7684;&#x3002;&#x5F53;&#x6267;&#x884C;&#x5230;<code>cd ..</code>&#xFF0C;&#x7531;&#x4E8E;<code>cd</code>&#x662F;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;<code>sh</code>&#x5185;&#x90E8;&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6765;&#x6539;&#x53D8;&#x5F53;&#x524D;&#x5B50;shell&#x7684;&#x5DE5;&#x4F5C;&#x8DEF;&#x5F84;&#xFF1B;&#x7136;&#x540E;&#x518D;&#x6267;&#x884C;<code>ls</code>&#xFF0C;&#x7531;&#x4E8E;<code>ls</code>&#x4E0D;&#x662F;&#x5185;&#x5EFA;&#x547D;&#x4EE4;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x518D;<code>fork</code>&#x51FA;&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x6267;&#x884C;<code>ls</code>&#xFF0C;&#x5B50;shell&#x8C03;&#x7528;<code>wait</code>&#x7B49;&#x5F85;<code>ls</code>&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x5F53;<code>ls</code>&#x7684;&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x5B8C;&#x4E4B;&#x540E;&#xFF0C;&#x5B50;shell&#x7684;<code>wait</code>&#x4F1A;&#x89E3;&#x9664;&#xFF0C;&#x7531;&#x4E8E;&#x811A;&#x672C;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x5DF2;&#x7ECF;&#x6267;&#x884C;&#x5B8C;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4E3B;shell&#x4E2D;<code>wait</code>&#x5B50;shell&#x4E5F;&#x89E3;&#x9664;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x770B;&#x5230;shell&#x63D0;&#x793A;&#x7B26;&#x4E86;&#x3002;</p>
<ol start="2">
<li>&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x89E3;&#x91CA;&#x5668;&#x6765;&#x6267;&#x884C;<br>&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x79CD;<code>sh ./script.sh</code>&#x65B9;&#x5F0F;&#x3002;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x5176;&#x5B9E;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#x7684;&#x672C;&#x8D28;&#x8FD8;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;<br>&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x80FD;&#x53D1;&#x73B0;&#x5728;&#x811A;&#x672C;&#x4E2D;&#x6709;&#x4E00;&#x53E5;<code>cd ..</code>&#xFF0C;&#x4F46;&#x662F;&#x811A;&#x672C;&#x6267;&#x884C;&#x5B8C;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x672C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6539;&#x53D8;&#xFF0C;&#x8FD9;&#x662F;&#x4E3A;&#x5565;&#xFF1F;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x4FEE;&#x6539;&#x7684;&#x662F;&#x5B50;shell&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#xFF0C;&#x5F53;&#x524D;&#x4E3B;shell&#x7684;&#x76EE;&#x5F55;&#x5E76;&#x6CA1;&#x6709;&#x4FEE;&#x6539;&#x5440;&#x3002;</li>
<li>&#x6267;&#x884C;&#x811A;&#x672C;&#x65F6;&#x80FD;&#x4E0D;&#x80FD;&#x5148;&#x4E0D;&#x8981;fork&#x51FA;&#x5B50;shell<br>&#x7B54;&#x6848;&#x80AF;&#x5B9A;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x7684;&#x65B9;&#x5F0F;<code>source ./script.sh</code>&#x6216;&#x8005;<code>. ./script.sh</code>&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5C31;&#x4E0D;&#x4F1A;&#x5148;fork&#x51FA;&#x5B50;shell&#x6765;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x5230;&#x5355;&#x4E2A;&#x547D;&#x4EE4;&#x65F6;&#x8FD8;&#x662F;&#x4F1A;fork&#x3002;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x8054;&#x60F3;&#x5230;&#x6211;&#x4EEC;&#x5E73;&#x65F6;&#x5728;&#x5B9A;&#x4E49;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x65F6;&#x811A;&#x672C;&#xFF0C;&#x6211;&#x4EEC;&#x6267;&#x884C;&#x8BE5;&#x811A;&#x672C;&#x65F6;&#x90FD;&#x7528;<code>source script.sh</code>&#x7684;&#x539F;&#x56E0;&#x3002;&#x56E0;&#x4E3A;&#x6267;&#x884C;&#x4E0D;&#x4F1A;fork&#xFF0C;&#x6240;&#x4EE5;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x5C31;&#x662F;&#x9488;&#x5BF9;&#x5F53;&#x524D;&#x7684;shell&#x8FDB;&#x7A0B;&#x7684;&#xFF1B;&#x5982;&#x679C;&#x6267;&#x884C;&#x4E4B;&#x524D;&#x7684;&#x65B9;&#x5F0F;&#x6267;&#x884C;&#xFF0C;&#x4EC5;&#x4EC5;&#x4FEE;&#x6539;&#x7684;&#x5B50;shell&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x4E3B;shell&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x5E76;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53D8;&#x5316;&#x3002;</li>
</ol>
<p>&#x53E6;&#x5916;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x901A;&#x8FC7;<code>(cd ..; ls -l)</code>&#x8FD9;&#x6837;&#x4E5F;&#x662F;&#x4F1A;fork&#x7684;&#x3002;</p>
<h2 id="Shell&#x57FA;&#x672C;&#x8BED;&#x6CD5;"><a href="#Shell&#x57FA;&#x672C;&#x8BED;&#x6CD5;" class="headerlink" title="Shell&#x57FA;&#x672C;&#x8BED;&#x6CD5;"></a>Shell&#x57FA;&#x672C;&#x8BED;&#x6CD5;</h2><h3 id="&#x53D8;&#x91CF;"><a href="#&#x53D8;&#x91CF;" class="headerlink" title="&#x53D8;&#x91CF;"></a>&#x53D8;&#x91CF;</h3><p>&#x5728;shell&#x4E2D;&#x53D8;&#x91CF;&#x5206;&#x6210;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x3001;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3002;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x53EA;&#x80FD;&#x5728;&#x5F53;&#x524D;&#x7684;shell&#x8FDB;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x800C;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x5728;&#x5F53;&#x524D;&#x7684;shell&#x8FDB;&#x7A0B;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
<ul>
<li><ol>
<li>&#x672C;&#x5730;&#x53D8;&#x91CF;<br>&#x672C;&#x5730;&#x53D8;&#x91CF;&#x7684;&#x5B9A;&#x4E49;&#x65B9;&#x5F0F;&#xFF1A;</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;VALNAME=value</span><br></pre></td></tr></table></figure>

<p>&#x7B49;&#x53F7;&#x4E24;&#x8FB9;&#x4E0D;&#x80FD;&#x6709;&#x7A7A;&#x683C;&#x3002;&#x83B7;&#x53D6;&#x83B7;&#x53D6;&#x53D8;&#x91CF;&#x7684;&#x503C;&#x5462;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;echo ${VALNAME}</span><br></pre></td></tr></table></figure>

<p>&#x5728;shell&#x4E2D;&#x6240;&#x6709;&#x53D8;&#x91CF;&#x7684;&#x7C7B;&#x578B;&#x90FD;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#xFF0C;&#x5982;&#x679C;&#x53D8;&#x91CF;&#x6CA1;&#x6709;&#x5B9A;&#x4E49;&#x5C31;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#x3002;</p>
<ul>
<li><ol start="2">
<li>&#x73AF;&#x5883;&#x53D8;&#x91CF;<br>&#x5C06;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x5BFC;&#x51FA;&#x5C31;&#x662F;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x547D;&#x4EE4;<code>export VALNAME</code>&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x4E00;&#x8FB9;&#x5B9A;&#x4E49;&#x4E00;&#x8FB9;&#x5BFC;&#x51FA;&#xFF1A;</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;export AAA=value</span><br></pre></td></tr></table></figure>

<p>&#x67E5;&#x770B;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>env</code>&#x6216;&#x8005;<code>printenv</code>&#x3002;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x6709;&#x7236;&#x8FDB;&#x7A0B;&#x4F20;&#x9012;&#x7ED9;&#x5B50;&#x8FDB;&#x7A0B;&#x3002;</p>
<ul>
<li><ol start="3">
<li>&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x53D8;&#x91CF;<br>&#x4F7F;&#x7528;&#x53D8;&#x91CF;&#x63A8;&#x8350;&#x4F7F;&#x7528;:</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;echo ${SHELL}</span><br></pre></td></tr></table></figure>

<p>&#x4E5F;&#x5C31;&#x662F;&#x5927;&#x62EC;&#x53F7;&#x7684;&#x65B9;&#x5F0F;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x597D;&#x5904;&#x5C31;&#x662F;&#x540E;&#x8FB9;&#x8DDF;&#x4E00;&#x4E9B;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x53D8;&#x91CF;&#x5C55;&#x5F00;&#x4EE5;&#x540E;&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x62FC;&#x63A5;&#x4E0A;&#x7684;&#x3002;&#x6BD4;&#x5982;<code>echo ${SHELL}abc</code>&#xFF0C;&#x90A3;&#x4E48;&#x7ED3;&#x679C;&#x5C31;&#x662F;<code>/bin/zshabc</code></p>
<ul>
<li><ol start="4">
<li>&#x53D8;&#x91CF;&#x7684;&#x7C7B;&#x578B;<br>&#x5728;shell&#x91CC;&#x8FB9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>declare</code>&#x6765;&#x58F0;&#x660E;&#x53D8;&#x91CF;&#xFF0C;&#x4F8B;&#x5982;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#!/bin/bash </span><br><span class="line"></span><br><span class="line">declare -i mi</span><br><span class="line">declare -i mx=100</span><br><span class="line">declare -i s=0</span><br><span class="line"></span><br><span class="line">for((mi=0; mi &lt;= mx; mi=mi+1)); do</span><br><span class="line">	s=s+mi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo $s</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>declare</code>&#x6765;&#x58F0;&#x660E;&#x6570;&#x7EC4;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#!/bin/bash </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare -a colors</span><br><span class="line">colors[0]=&quot;yellow&quot;</span><br><span class="line">colors[1]=&quot;white&quot;</span><br><span class="line">colors[2]=&quot;black&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;len=${colors[@]}&quot;</span><br><span class="line">for co in ${colors[@]}; do</span><br><span class="line">	echo $co</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li><ol start="5">
<li>&#x53D8;&#x91CF;&#x5185;&#x5BB9;&#x7684;&#x5220;&#x9664;&#x4E0E;&#x66FF;&#x6362;<br>&#x53D8;&#x91CF;&#x5185;&#x5BB9;&#x7684;&#x5220;&#x9664;&#xFF0C;&#x6700;&#x57FA;&#x672C;&#x7684;&#x8BED;&#x6CD5;&#x4E3A;<code>${var#&#x6A21;&#x5F0F;}</code>/<code>${var##&#x6A21;&#x5F0F;}</code>/<code>${var%&#x6A21;&#x5F0F;}</code>/<code>${var%%&#x6A21;&#x5F0F;}</code>/<code>${var/old/new}</code>/<code>${var//old/new}</code></li>
</ol>
</li>
</ul>
<ol>
<li><code>#</code>&#x8868;&#x793A;&#x4ECE;&#x524D;&#x5F80;&#x540E;&#x5220;&#x9664;&#xFF0C;&#x5220;&#x9664;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#x6700;&#x77ED;&#x7684;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;file_path=&quot;/home/test/workspace/shell/test.cpp&quot;</span><br><span class="line">echo ${file_path#/*/} </span><br><span class="line"></span><br><span class="line">## &#x8F93;&#x51FA;&#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</span><br><span class="line">test/workspace/shell/test.cpp</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>##</code>&#x8868;&#x793A;&#x4ECE;&#x524D;&#x5F80;&#x540E;&#x5220;&#x9664;&#xFF0C;&#x5220;&#x9664;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#x7684;&#x6700;&#x957F;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;file_path=&quot;/home/test/workspace/shell/test.cpp&quot;</span><br><span class="line">echo ${file_path##/*/}</span><br><span class="line">## &#x8F93;&#x51FA;&#x5185;&#x5BB9;&#x4E3A;:</span><br><span class="line">test.cpp</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><code>%</code>&#x8868;&#x793A;&#x4ECE;&#x540E;&#x5F80;&#x524D;&#x5220;&#x9664;&#xFF0C;&#x5220;&#x9664;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#x7684;&#x6700;&#x77ED;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;file_path=&quot;/home/test/workspace/shell/test/test.cpp&quot;</span><br><span class="line">echo ${file_path%/test*}</span><br><span class="line"></span><br><span class="line">## &#x8F93;&#x51FA;&#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</span><br><span class="line">/home/test/workspace/shell/test</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><code>%%</code>&#x8868;&#x793A;&#x4ECE;&#x540E;&#x5F80;&#x524D;&#x5220;&#x9664;&#xFF0C;&#x6EE1;&#x8DB3;&#x8981;&#x6C42;&#x7684;&#x6700;&#x957F;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;file_path=&quot;/home/test/workspace/shell/test/test.cpp&quot;</span><br><span class="line">echo ${file_path%%/test*}</span><br><span class="line"></span><br><span class="line">## &#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x4E3A;&#xFF1A;</span><br><span class="line">/home</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>&#x4F7F;&#x7528;<code>${var/old/new}</code>&#x66FF;&#x6362;&#x65F6;&#xFF0C;&#x4EC5;&#x4EC5;&#x66FF;&#x6362;&#x4E00;&#x6B21;&#x3002;&#x4F7F;&#x7528;<code>${var//old/new}</code>&#x66FF;&#x6362;&#x65F6;&#xFF0C;&#x662F;&#x66FF;&#x6362;&#x5168;&#x90E8;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;file_path=&quot;/home/test/workspace/shell/test/test.cpp&quot;</span><br><span class="line">echo ${file_path/test/learn}</span><br><span class="line"># &#x8F93;&#x51FA;&#xFF1A;</span><br><span class="line">/home/learn/workspace/shell/test/test.cpp</span><br><span class="line"></span><br><span class="line">echo ${file_path//test/learn}</span><br><span class="line"># &#x8F93;&#x51FA;</span><br><span class="line">/home/learn/workspace/shell/learn/learn.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li><ol start="6">
<li>&#x53D8;&#x91CF;&#x7684;&#x6D4B;&#x8BD5;<br>&#x8FD9;&#x91CC;&#x7684;&#x5185;&#x5BB9;&#x8FD8;&#x633A;&#x591A;&#x7684;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x4EC5;&#x4EC5;&#x8BB0;&#x5F55;&#x6211;&#x5E38;&#x7528;&#x7684;&#x3002;<br><code>new_var=${old-content}</code>&#x8868;&#x793A;<code>old</code>&#x6CA1;&#x6709;&#x5B9A;&#x4E49;&#x65F6;&#xFF0C;<code>new_var</code>&#x4F7F;&#x7528;content;&#x5982;&#x679C;<code>old</code>&#x5B9A;&#x4E49;&#x4E86;&#x5E76;&#x4E14;&#x662F;&#x4E2A;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x90A3;&#x4E48;<code>new_var</code>&#x4E5F;&#x662F;<code>&quot;&quot;</code>&#x3002;&#x53E6;&#x5916;<code>new_var=${old:-content}</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;<code>old</code>&#x6CA1;&#x6709;&#x5B9A;&#x4E49;&#x8FD8;&#x662F;&#x4E2A;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x90A3;&#x4E48;<code>new_var</code>&#x5C31;&#x53D6;content,&#x5426;&#x5219;&#x5C31;&#x53D6;<code>old</code>&#x3002;</li>
</ol>
</li>
</ul>
<h3 id="&#x6587;&#x4EF6;&#x540D;&#x4EE3;&#x6362;globbing"><a href="#&#x6587;&#x4EF6;&#x540D;&#x4EE3;&#x6362;globbing" class="headerlink" title="&#x6587;&#x4EF6;&#x540D;&#x4EE3;&#x6362;globbing"></a>&#x6587;&#x4EF6;&#x540D;&#x4EE3;&#x6362;globbing</h3><p>&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x4E9B;&#x901A;&#x914D;&#x7B26;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x901A;&#x914D;&#x7B26;</th>
<th>&#x4F5C;&#x7528;</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>&#x5339;&#x914D;0&#x4E2A;&#x6216;&#x8005;&#x591A;&#x4E2A;&#x4EFB;&#x4F55;&#x5B57;&#x7B26;</td>
</tr>
<tr>
<td>&#xFF1F;</td>
<td>&#x5339;&#x914D;1&#x4E2A;&#x4EFB;&#x610F;&#x5B57;&#x7B26;</td>
</tr>
<tr>
<td>[]</td>
<td>&#x5339;&#x914D;&#x65B9;&#x62EC;&#x53F7;&#x4E2D;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;</td>
</tr>
<tr>
<td>&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x6267;&#x884C;<code>ls ch1[0-2].doc</code>&#xFF0C;&#x90A3;&#x4E48;shell&#x5176;&#x5B9E;&#x4F1A;&#x5148;&#x5C55;&#x5F00;&#x901A;&#x914D;&#x7B26;&#xFF0C;&#x6BD4;&#x5982;&#x80FD;&#x627E;&#x5230;<code>ch10.doc</code>&#x3001;<code>ch11.doc</code>&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x8FD9;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x4F20;&#x9012;&#x7ED9;ls&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;ls&#x5E76;&#x4E0D;&#x4F1A;&#x4E0D;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x901A;&#x914D;&#x7B26;&#xFF0C;&#x662F;&#x7531;shell&#x5148;&#x5C55;&#x5F00;&#x518D;&#x4F20;&#x9012;&#x7ED9;ls&#x3002;</td>
<td></td>
</tr>
</tbody></table>
<h3 id="&#x547D;&#x4EE4;&#x884C;&#x4EE3;&#x6362;-&#x3001;"><a href="#&#x547D;&#x4EE4;&#x884C;&#x4EE3;&#x6362;-&#x3001;" class="headerlink" title="&#x547D;&#x4EE4;&#x884C;&#x4EE3;&#x6362;``&#x3001;$()"></a>&#x547D;&#x4EE4;&#x884C;&#x4EE3;&#x6362;``&#x3001;$()</h3><p>&#x901A;&#x8FC7;``&#x6216;&#x8005;$()&#x62EC;&#x8D77;&#x6765;&#x7684;&#x4E5F;&#x662F;&#x4E00;&#x6761;&#x547D;&#x4EE4;&#xFF0C;shell&#x4F1A;&#x5148;&#x6267;&#x884C;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#xFF0C;&#x5C06;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x653E;&#x5230;&#x5F53;&#x524D;&#x6240;&#x5728;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;DATE=`date`</span><br><span class="line">echo $DATE</span><br><span class="line"></span><br><span class="line">&#x6216;&#x8005;</span><br><span class="line">DATE=$(date)</span><br><span class="line">echo $DATE</span><br></pre></td></tr></table></figure>

<h3 id="&#x7B97;&#x672F;&#x4EE3;&#x6362;"><a href="#&#x7B97;&#x672F;&#x4EE3;&#x6362;" class="headerlink" title="&#x7B97;&#x672F;&#x4EE3;&#x6362;:$(())"></a>&#x7B97;&#x672F;&#x4EE3;&#x6362;:$(())</h3><p>shell&#x4E2D;&#x53D8;&#x91CF;&#x9ED8;&#x8BA4;&#x90FD;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x6D89;&#x53CA;&#x5230;&#x6574;&#x5F62;&#x53D8;&#x91CF;<code>+</code>&#x3001;<code>-</code>&#x3001;<code>*</code>&#x3001;<code>/</code>&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x5904;&#x7406;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;val=10</span><br><span class="line">echo $(($val + 10))</span><br></pre></td></tr></table></figure>

<p><code>$(())</code>&#x53EA;&#x80FD;&#x7528;&#x4E8E;&#x6574;&#x5F62;&#x8FD0;&#x7B97;</p>
<h3 id="&#x8F6C;&#x4E49;&#x5B57;&#x7B26;"><a href="#&#x8F6C;&#x4E49;&#x5B57;&#x7B26;" class="headerlink" title="&#x8F6C;&#x4E49;&#x5B57;&#x7B26;\"></a>&#x8F6C;&#x4E49;&#x5B57;&#x7B26;\</h3><p>&#x6709;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x7684;&#x5B57;&#x7B26;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x7279;&#x6B8A;&#x5B57;&#x7B26;&#x7684;&#x5B57;&#x9762;&#x91CF;&#x65F6;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8F6C;&#x4E49;&#x3002;<br><code>echo \$SHELL</code>&#x7ED3;&#x679C;&#x5C31;&#x4E0D;&#x6253;&#x5370;SHELL&#x53D8;&#x91CF;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x6253;&#x5370;<code>$SHELL</code>&#x3002;</p>
<p>&#x53E6;&#x5916;<code>\</code>&#x4E5F;&#x53EF;&#x4EE5;&#x8868;&#x793A;&#x7EED;&#x884C;&#x7684;&#x610F;&#x601D;&#x3002;</p>
<h3 id="&#x5355;&#x5F15;&#x53F7;&#x3001;&#x53CC;&#x5F15;&#x53F7;"><a href="#&#x5355;&#x5F15;&#x53F7;&#x3001;&#x53CC;&#x5F15;&#x53F7;" class="headerlink" title="&#x5355;&#x5F15;&#x53F7;&#x3001;&#x53CC;&#x5F15;&#x53F7;"></a>&#x5355;&#x5F15;&#x53F7;&#x3001;&#x53CC;&#x5F15;&#x53F7;</h3><p>&#x5355;&#x5F15;&#x53F7;&#x8868;&#x793A;&#x5B57;&#x7B26;&#x7684;&#x5B57;&#x9762;&#x503C;&#x3002;&#x53CC;&#x5F15;&#x53F7;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x90FD;&#x8868;&#x793A;&#x5B57;&#x7B26;&#x7684;&#x5B57;&#x9762;&#x503C;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x9047;&#x5230;<code>$&#x53D8;&#x91CF;&#x540D;</code>&#x5219;&#x4F1A;&#x5C55;&#x5F00;&#x53D8;&#x91CF;&#x503C;&#xFF1B;&#x5728;&#x9047;&#x5230;``&#x5219;&#x4F1A;&#x547D;&#x4EE4;&#x66FF;&#x6362;&#x3002;</p>
<h2 id="bash&#x542F;&#x52A8;&#x811A;&#x672C;"><a href="#bash&#x542F;&#x52A8;&#x811A;&#x672C;" class="headerlink" title="bash&#x542F;&#x52A8;&#x811A;&#x672C;"></a>bash&#x542F;&#x52A8;&#x811A;&#x672C;</h2><p>&#x5C31;&#x662F;bash&#x542F;&#x52A8;&#x65F6;&#x6267;&#x884C;&#x7684;&#x811A;&#x672C;&#xFF0C;&#x8FD9;&#x91CC;&#x8FB9;&#x7684;&#x89C4;&#x5219;&#x8FD8;&#x662F;&#x633A;&#x590D;&#x6742;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x4E00;&#x6761;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3001;alias&#x3001;mask&#x5B9A;&#x4E49;&#x5230;.bashrc&#x6587;&#x4EF6;&#x4E2D;&#x5373;&#x53EF;&#x3002;&#x8FD9;&#x6837;&#x5728;bash&#x542F;&#x52A8;&#x65F6;&#x4F1A;&#x81EA;&#x52A8;source&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x9884;&#x5148;&#x5B9A;&#x4E49;&#x7684;&#x53D8;&#x91CF;&#x5C31;&#x81EA;&#x52A8;&#x751F;&#x6548;&#x4E86;&#x3002;</p>
<h2 id="shell&#x811A;&#x672C;&#x8BED;&#x6CD5;"><a href="#shell&#x811A;&#x672C;&#x8BED;&#x6CD5;" class="headerlink" title="shell&#x811A;&#x672C;&#x8BED;&#x6CD5;"></a>shell&#x811A;&#x672C;&#x8BED;&#x6CD5;</h2><h3 id="&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;"><a href="#&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;" class="headerlink" title="&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;"></a>&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;</h3><p>&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;&#x8BED;&#x53E5;&#x5728;shell&#x4E2D;&#x6709;&#x4E24;&#x79CD;&#x8868;&#x8FBE;<code>[]</code>/<code>[[]]</code>/<code>test</code>&#xFF0C;&#x6761;&#x4EF6;&#x6D4B;&#x8BD5;&#x8BED;&#x53E5;&#x53EF;&#x4EE5;&#x6D4B;&#x8BD5;&#x5B57;&#x7B26;&#x4E32;/&#x6570;&#x503C;/&#x6587;&#x4EF6;&#x7684;&#x5C5E;&#x6027;&#x3002;&#x6BD4;&#x5982;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">perl&#x590D;&#x5236;&#x4EE3;&#x7801;VAR=2</span><br><span class="line">test $VAR -gt 1$</span><br><span class="line"></span><br><span class="line">[ $VAR -gt 3 ]</span><br></pre></td></tr></table></figure>

<p>&#x4E0D;&#x7BA1;&#x7528;&#x90A3;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x6700;&#x7EC8;&#x8868;&#x793A;&#x6761;&#x4EF6;&#x662F;&#x771F;&#x8FD8;&#x662F;&#x5047;&#xFF0C;&#x662F;&#x901A;&#x8FC7;<code>$?</code>&#x6765;&#x5224;&#x65AD;&#x7684;&#xFF0C;0&#x8868;&#x793A;true&#xFF0C;1&#x8868;&#x793A;false&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/4f5c6fa665d11f47d99cb9a80a242bee2961d7554d922f1b366c6daa7315ee14" alt="AAA_test.png"></p>
<p>&#x5BF9;&#x4E8E;&#x4E0E;&#x6216;&#x975E;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/2be8f6211b8e47bd81e1f80258c58fc41275fa01621343bffb6c3a4fe775adae" alt="AAAA_1.png"></p>
<p>&#x5728;shell&#x4E2D;<code>[[]]</code>&#x662F;<code>[]</code>&#x7684;&#x62D3;&#x5C55;&#xFF0C;&#x5E76;&#x4E14;<code>[[]]</code>&#x662F;&#x517C;&#x5BB9;<code>[]</code>&#x7684;&#x3002;&#x7ADF;&#x7136;&#x662F;&#x62D3;&#x5C55;&#xFF0C;&#x90A3;&#x529F;&#x80FD;&#x80AF;&#x5B9A;&#x8981;&#x6BD4;&#x4E4B;&#x524D;&#x7684;<code>[]</code>&#x8981;&#x5F3A;&#x4E00;&#x4E9B;&#x7684;&#x3002;</p>
<ul>
<li>&#x66FF;&#x6362;&#x6389;<code>[]</code>&#x4E2D;&#x7684;<code>-a</code>&#x6216;&#x8005;<code>-o</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;[ -f README.md -a -x README.md ] &amp;&amp; echo &quot;yes&quot; || echo &quot;no&quot;</span><br><span class="line"># &#x5982;&#x679C;&#x4F7F;&#x7528;[[]]&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#xFF1A;</span><br><span class="line">[[ -f README.md &amp;&amp; -x README.md ]] &amp;&amp; echo &quot;yes&quot; || echo &quot;no&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x4F7F;&#x7528;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;A=&quot;hello&quot;; [[ &quot;$A&quot; =~ hell? ]] &amp;&amp; echo &quot;yes&quot; || echo &quot;no&quot;</span><br><span class="line"></span><br><span class="line"># &#x8FD9;&#x91CC;&#x8981;&#x6CE8;&#x610F;=~ &#x53F3;&#x8FB9;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&quot;&quot;&#x3002;&#x5982;&#x679C;&#x4F7F;&#x7528;&quot;&quot;&#x5C31;&#x8868;&#x793A;&#x5B57;&#x7B26;&#x4E32;&#x4E86;&#xFF0C;&#x4E0D;&#x4F7F;&#x7528;&quot;&quot;&#x5C31;&#x8868;&#x793A;&#x6B63;&#x5219;&#x7684;&#x6A21;&#x5F0F;</span><br></pre></td></tr></table></figure>

<h3 id="&#x5224;&#x65AD;&#x8BED;&#x53E5;"><a href="#&#x5224;&#x65AD;&#x8BED;&#x53E5;" class="headerlink" title="&#x5224;&#x65AD;&#x8BED;&#x53E5;"></a>&#x5224;&#x65AD;&#x8BED;&#x53E5;</h3><p>&#x5728;shell&#x7F16;&#x7A0B;&#x4E2D;&#x662F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>if</code>&#x8BED;&#x53E5;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x8DDF;&#x6211;&#x4EEC;&#x7684;c&#x8BED;&#x8A00;&#x7684;if&#x4E5F;&#x4E0D;&#x592A;&#x4E00;&#x6837;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;if [ -f ~/.bashrc ]; then </span><br><span class="line">    . ~/.bashrc</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>&#x5176;&#x5B9E;&#x6D89;&#x53CA;&#x4E09;&#x6761;&#x8BED;&#x53E5;&#xFF0C;<code>if [ -f ~/.bashrc ]</code> &#x5982;&#x679C;&#x6D4B;&#x8BD5;&#x8BED;&#x53E5;$?&#x4E3A;0&#x5219;&#x8868;&#x793A;&#x4E3A;true&#xFF0C;&#x5426;&#x5219;&#x4E3A;false&#x3002;<code>then . ~/.bashrc</code>&#x5728;shell&#x4E00;&#x822C;&#x4E00;&#x884C;&#x53EA;&#x6709;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x6709;&#x591A;&#x6761;&#x8BED;&#x53E5;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x7528;;&#x5206;&#x79BB;&#x3002;<code>fi</code> &#x8868;&#x793A;if&#x7684;&#x7ED3;&#x675F;&#x6807;&#x8BB0;&#x3002;</p>
<p>&#x7279;&#x6B8A;if&#x8BED;&#x53E5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;if&#x7684;&#x6761;&#x4EF6;&#x6C38;&#x8FDC;&#x4E3A;true&#x3002;<code>:</code>&#x662F;&#x7A7A;&#x8BED;&#x53E5;&#xFF0C;&#x6267;&#x884C;&#x7ED3;&#x679C;$?&#x662F;0&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;if :; then echo &quot;always true&quot;; fi</span><br></pre></td></tr></table></figure>

<p>&#x5E38;&#x89C1;&#x7684;<code>if</code>&#x7528;&#x6CD5;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;num=1</span><br><span class="line"></span><br><span class="line">if [ $(($num)) -gt 10 ]; then</span><br><span class="line">    echo &apos;a&apos;</span><br><span class="line">elif [ ${num} -eq 10 ]; then</span><br><span class="line">    echo &apos;b&apos;</span><br><span class="line">else</span><br><span class="line">    echo &apos;c&apos;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p><code>&amp;&amp;</code>&#x3001;<code>||</code>&#x7528;&#x6CD5;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5229;&#x7528;&#x77ED;&#x8DEF;&#x7279;&#x6027;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;test &quot;$(whoami)&quot; != &apos;root&apos; &amp;&amp; (echo you are using a non-privileged account; exit 1)</span><br></pre></td></tr></table></figure>

<p>&#x5BF9;&#x4E8E;<code>if</code>&#x8BED;&#x53E5;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#xFF0C;&#x6700;&#x597D;&#x5BF9;&#x4E8E;<code>if [ $var xxxx ]</code>&#x4E2D;&#x7684;<code>$var</code>&#x7528;<code>&quot;&quot;</code>&#x62EC;&#x8D77;&#x6765;&#x3002;</p>
<h3 id="case&#x8BED;&#x53E5;"><a href="#case&#x8BED;&#x53E5;" class="headerlink" title="case&#x8BED;&#x53E5;"></a>case&#x8BED;&#x53E5;</h3><p>case&#x8BED;&#x53E5;&#x5C31;&#x662F;c&#x8BED;&#x8A00;&#x4E2D;&#x7684;switch case&#x3002;&#x5927;&#x6982;&#x7684;&#x7528;&#x6CD5;&#x662F;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;case $1 in </span><br><span class="line">    start) </span><br><span class="line">    ... </span><br><span class="line">    ;; </span><br><span class="line">    stop) </span><br><span class="line">    ... </span><br><span class="line">    ;; </span><br><span class="line">    reload | force-reload)</span><br><span class="line">     ... </span><br><span class="line">     ;; </span><br><span class="line">     restart) </span><br><span class="line">     ...</span><br><span class="line">     ;;</span><br><span class="line">     *) </span><br><span class="line">     log_success_msg &quot;Usage: /etc/init.d/apache2 {start|stop|restart|reload|force-reload|start-htcacheclean|stop-htcacheclean}&quot; </span><br><span class="line">     exit 1 </span><br><span class="line">     ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>&#x4EE5;case&#x5F00;&#x5934;&#xFF0C;&#x5728;in&#x91CC;&#x8FB9;&#x8FDB;&#x884C;&#x5339;&#x914D;&#xFF0C;&#x652F;&#x6301;&#x901A;&#x914D;&#x7B26;&#xFF0C;&#x4E00;&#x65E6;&#x627E;&#x5230;&#x67D0;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x5C31;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x8BED;&#x53E5;&#x6700;&#x7EC8;&#x8BED;&#x53E5;&#x662F;&#x4EE5;<code>;;</code>&#x7ED3;&#x675F;&#x3002;&#x6574;&#x4E2A;&#x8BED;&#x53E5;&#x662F;&#x4EE5;esac&#x7ED3;&#x675F;&#x3002;</p>
<h3 id="for-do-done"><a href="#for-do-done" class="headerlink" title="for/do/done"></a>for/do/done</h3><p>for&#x5FAA;&#x73AF;&#x3002;&#x6BD4;&#x5982;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;for FRUIT in apple banana pear; do </span><br><span class="line">    echo &quot;I like $FRUIT&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x60F3;&#x5C06;&#x67D0;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x6587;&#x4EF6;&#x6539;&#x540D;&#xFF0C;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;files=`ls test`</span><br><span class="line">echo ${files}</span><br><span class="line"></span><br><span class="line">for f in ${files}; do</span><br><span class="line">   mv &quot;test/${f}&quot; &quot;test/${f}.tmp&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x7C7B;&#x4F3C;&#x4E8E;c&#x8BED;&#x8A00;&#x7684;&#x5FAA;&#x73AF;&#x5F62;&#x5F0F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;declare -i mi</span><br><span class="line">declare -i mx=100</span><br><span class="line">declare -i s=0</span><br><span class="line"></span><br><span class="line">for((mi=0; mi &lt;= mx; mi=mi+1)); do</span><br><span class="line">	s=s+mi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo $s</span><br></pre></td></tr></table></figure>

<h3 id="while-do-done"><a href="#while-do-done" class="headerlink" title="while/do/done"></a>while/do/done</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;COUNTER=1</span><br><span class="line">while [ &quot;$COUNTER&quot; -lt 10 ]; do</span><br><span class="line">   echo &quot;Here we go again&quot; </span><br><span class="line">   COUNTER=$(($COUNTER+1))</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x4E2A;&#x5E94;&#x8BE5;&#x5F88;&#x597D;&#x7406;&#x89E3;&#x3002;</p>
<h3 id="&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#x4E0E;&#x7279;&#x6B8A;&#x53D8;&#x91CF;"><a href="#&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#x4E0E;&#x7279;&#x6B8A;&#x53D8;&#x91CF;" class="headerlink" title="&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#x4E0E;&#x7279;&#x6B8A;&#x53D8;&#x91CF;"></a>&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#x4E0E;&#x7279;&#x6B8A;&#x53D8;&#x91CF;</h3><p>&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#x5217;&#x8868;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/9a9e9150a1ccea6582e8bad62526a3bcc59fe18a569a5322ebb393fa76bdb791" alt="AAAA-2.png"></p>
<p>&#x5176;&#x4E2D;&#x4F4D;&#x7F6E;&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x7528;shift&#x547D;&#x4EE4;&#x5DE6;&#x79FB;&#x3002;&#x6BD4;&#x5982;shift 3&#x8868;&#x793A;&#x539F;&#x6765;&#x7684;4&#x73B0;&#x5728;&#x53D8;&#x6210;4&#x73B0;&#x5728;&#x53D8;&#x6210;4&#x73B0;&#x5728;&#x53D8;&#x6210;1&#xFF0C;&#x539F;&#x6765;&#x7684;5&#x73B0;&#x5728;&#x53D8;&#x6210;5&#x73B0;&#x5728;&#x53D8;&#x6210;5&#x73B0;&#x5728;&#x53D8;&#x6210;2&#x7B49;&#x7B49;&#xFF0C;&#x539F;&#x6765;&#x7684;1&#x3001;1&#x3001;1&#x3001;2&#x3001;3&#x4E22;&#x5F03;&#xFF0C;3&#x4E22;&#x5F03;&#xFF0C;3&#x4E22;&#x5F03;&#xFF0C;0&#x4E0D;&#x79FB;&#x52A8;&#x3002;&#x4E0D;&#x5E26;&#x53C2;&#x6570;&#x7684;shift&#x547D;&#x4EE4;&#x76F8;&#x5F53;&#x4E8E;shift 1&#x3002;shift&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x5C31;&#x662F;&#x5728;&#x811A;&#x672C;&#x5185;&#x90E8;&#x53EF;&#x80FD;&#x4F1A;&#x8C03;&#x7528;&#x5176;&#x4ED6;&#x7684;&#x811A;&#x672C;&#xFF0C;&#x4F46;&#x662F;&#x53C2;&#x6570;&#x53C8;&#x4E0D;&#x60F3;&#x7528;&#x90A3;&#x4E48;&#x591A;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;shift&#x8FDB;&#x884C;&#x4E22;&#x5F03;&#x3002;</p>
<h3 id="&#x51FD;&#x6570;"><a href="#&#x51FD;&#x6570;" class="headerlink" title="&#x51FD;&#x6570;"></a>&#x51FD;&#x6570;</h3><p>shell&#x4E2D;&#x7684;&#x51FD;&#x6570;&#x4E0D;&#x7528;&#x5199;&#x53C2;&#x6570;&#x5217;&#x8868;&#x8DDF;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x7684;&#x3002;&#x662F;&#x53EF;&#x4EE5;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x8DDF;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x4E0D;&#x9700;&#x8981;&#x58F0;&#x660E;&#x800C;&#x5DF2;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;is_directory()</span><br><span class="line">{ </span><br><span class="line">   DIR_NAME=$1 </span><br><span class="line">   if [ ! -d $DIR_NAME ]; then</span><br><span class="line">      return 1 </span><br><span class="line">   else </span><br><span class="line">      return 0 </span><br><span class="line">   fi</span><br><span class="line">}</span><br><span class="line">for DIR in &quot;$@&quot;; do </span><br><span class="line">   if is_directory &quot;$DIR&quot; </span><br><span class="line">      then : </span><br><span class="line">   else </span><br><span class="line">      echo &quot;$DIR doesn&apos;t exist. Creating it now...&quot; </span><br><span class="line">      mkdir $DIR &gt; /dev/null 2&gt;&amp;1 </span><br><span class="line">      if [ $? -ne 0 ]; then </span><br><span class="line">         echo &quot;Cannot create directory $DIR&quot; </span><br><span class="line">         exit 1 </span><br><span class="line">      fi</span><br><span class="line">   fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>&#x5728;shell&#x811A;&#x672C;&#x4E2D;&#x5982;&#x679C;&#x8981;&#x8868;&#x793A;&#x8FD4;&#x56DE;true&#xFF0C;&#x4E00;&#x822C;&#x7528;return 0&#xFF0C;&#x8FD9;&#x4E2A;&#x8DDF;<code>if</code>&#x5224;&#x65AD;&#x662F;&#x6709;&#x5173;&#x7CFB;&#x7684;&#x3002;&#x53E6;&#x5916;&#x5728;shell&#x7A7A;&#x8BED;&#x53E5;&#x7528;<code>:</code>&#x6765;&#x8868;&#x8FBE;&#x3002;</p>
<h2 id="&#x5E38;&#x89C1;&#x6280;&#x5DE7;&#x79EF;&#x7D2F;"><a href="#&#x5E38;&#x89C1;&#x6280;&#x5DE7;&#x79EF;&#x7D2F;" class="headerlink" title="&#x5E38;&#x89C1;&#x6280;&#x5DE7;&#x79EF;&#x7D2F;"></a>&#x5E38;&#x89C1;&#x6280;&#x5DE7;&#x79EF;&#x7D2F;</h2><h3 id="&#x5982;&#x679C;&#x811A;&#x672C;&#x9047;&#x5230;&#x9519;&#x8BEF;&#xFF0C;&#x6700;&#x597D;&#x80FD;&#x66B4;&#x9732;&#x51FA;&#x6765;&#xFF0C;&#x4E0D;&#x8981;&#x57CB;&#x96F7;"><a href="#&#x5982;&#x679C;&#x811A;&#x672C;&#x9047;&#x5230;&#x9519;&#x8BEF;&#xFF0C;&#x6700;&#x597D;&#x80FD;&#x66B4;&#x9732;&#x51FA;&#x6765;&#xFF0C;&#x4E0D;&#x8981;&#x57CB;&#x96F7;" class="headerlink" title="&#x5982;&#x679C;&#x811A;&#x672C;&#x9047;&#x5230;&#x9519;&#x8BEF;&#xFF0C;&#x6700;&#x597D;&#x80FD;&#x66B4;&#x9732;&#x51FA;&#x6765;&#xFF0C;&#x4E0D;&#x8981;&#x57CB;&#x96F7;"></a>&#x5982;&#x679C;&#x811A;&#x672C;&#x9047;&#x5230;&#x9519;&#x8BEF;&#xFF0C;&#x6700;&#x597D;&#x80FD;&#x66B4;&#x9732;&#x51FA;&#x6765;&#xFF0C;&#x4E0D;&#x8981;&#x57CB;&#x96F7;</h3><p>&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x8981;&#x4E0D;&#x4F7F;&#x7528;<code>set -e</code>&#x6216;&#x8005;&#x662F;&#x6307;&#x5B9A;&#x811A;&#x672C;&#x89E3;&#x91CA;&#x5668;&#x65F6;&#xFF0C;&#x6307;&#x5B9A;<code>-e</code>&#x53C2;&#x6570;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#!/bin/bash -e</span><br><span class="line"></span><br><span class="line">#set -e</span><br><span class="line">mkdir -p a/b</span><br><span class="line">cd a</span><br><span class="line">touch file</span><br><span class="line">cd -</span><br><span class="line"></span><br><span class="line">rmdir a</span><br><span class="line">echo &quot;done&quot;</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6837;&#x811A;&#x672C;&#x4E00;&#x65E6;&#x9047;&#x5230;error&#x5C31;&#x4F1A;&#x505C;&#x6B62;&#x8FD0;&#x884C;&#xFF0C;&#x5E76;&#x4E14;<code>$?</code>&#x4E5F;&#x4F1A;&#x8FD4;&#x56DE;&#x975E;0</p>
<h3 id="&#x663E;&#x6027;&#x6307;&#x5B9A;&#x811A;&#x672C;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;"><a href="#&#x663E;&#x6027;&#x6307;&#x5B9A;&#x811A;&#x672C;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;" class="headerlink" title="&#x663E;&#x6027;&#x6307;&#x5B9A;&#x811A;&#x672C;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;"></a>&#x663E;&#x6027;&#x6307;&#x5B9A;&#x811A;&#x672C;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;</h3><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x4E0D;&#x7BA1;&#x4F7F;&#x7528;&#x8005;&#x4ECE;&#x90A3;&#x4E2A;&#x4F4D;&#x7F6E;&#x542F;&#x52A8;&#x811A;&#x672C;&#xFF0C;&#x8BE5;&#x811A;&#x672C;&#x90FD;&#x80FD;&#x4E00;&#x5982;&#x65E2;&#x5F80;&#x7684;&#x6309;&#x7167;&#x9884;&#x671F;&#x7684;&#x76EE;&#x5F55;&#x5DE5;&#x4F5C;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x6211;&#x4EEC;&#x5C06;&#x67D0;&#x4E2A;&#x811A;&#x672C;&#x653E;&#x7F6E;&#x5728;&#x67D0;&#x4E2A;&#x76EE;&#x5F55;&#xFF0C;&#x90A3;&#x4E00;&#x822C;&#x5DE5;&#x4F5C;&#x8DEF;&#x5F84;&#x57FA;&#x672C;&#x4E0A;&#x662F;&#x57FA;&#x4E8E;&#x8BE5;&#x76EE;&#x5F55;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6700;&#x597D;&#x518D;&#x5199;&#x811A;&#x672C;&#x65F6;&#xFF0C;&#x5728;&#x811A;&#x672C;&#x7684;&#x6700;&#x5F00;&#x5934;&#x8FD9;&#x6837;&#x5199;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;dir=$(dirname $(readlink -f &quot;$0&quot;))</span><br><span class="line">cd ${dir}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x79CD;&#x5199;&#x6CD5;&#x4E5F;&#x540C;&#x65F6;&#x8003;&#x8651;&#x4E86;&#x8F6F;&#x8FDE;&#x63A5;&#x7684;&#x60C5;&#x51B5;</p>
<h3 id="&#x811A;&#x672C;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x5904;&#x7406;&#x6280;&#x5DE7;"><a href="#&#x811A;&#x672C;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x5904;&#x7406;&#x6280;&#x5DE7;" class="headerlink" title="&#x811A;&#x672C;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x5904;&#x7406;&#x6280;&#x5DE7;"></a>&#x811A;&#x672C;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x5904;&#x7406;&#x6280;&#x5DE7;</h3><p>&#x6700;&#x7B80;&#x5355;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x4E00;&#x4E2A;for&#x518D;&#x52A0;&#x4E00;&#x4E2A;case&#x8BED;&#x53E5;&#x6765;&#x5904;&#x7406;&#xFF0C;&#x590D;&#x6742;&#x70B9;&#x7684;&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>getopt</code>&#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;#!/bin/bash </span><br><span class="line"></span><br><span class="line">for arg in $@; do</span><br><span class="line">	case $arg in</span><br><span class="line">		-h)</span><br><span class="line">			echo &quot;usage:xxxx&quot;</span><br><span class="line">			exit 0</span><br><span class="line">			;;</span><br><span class="line">		-a)</span><br><span class="line">			echo &quot;param a handle&quot;</span><br><span class="line">			;;</span><br><span class="line">		*)</span><br><span class="line">			echo &quot;default param handle&quot;</span><br><span class="line">			;;</span><br><span class="line">	esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="&#x5176;&#x4ED6;"><a href="#&#x5176;&#x4ED6;" class="headerlink" title="&#x5176;&#x4ED6;"></a>&#x5176;&#x4ED6;</h3><p><code>|</code>&#x547D;&#x4EE4;&#x7684;&#x53F3;&#x8FB9;&#x5FC5;&#x987B;&#x662F;&#x80FD;&#x63A5;&#x53D7;&#x6807;&#x51C6;&#x8F93;&#x5165;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x65F6;&#x624D;&#x80FD;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#x3002;&#x6BD4;&#x5982;<code>echo &quot;helloworld&quot; | echo</code>&#x5C31;&#x4E0D;&#x4F1A;&#x6709;&#x4EFB;&#x4F55;&#x8F93;&#x51FA;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>xargs</code>&#x547D;&#x4EE4;&#x5C06;&#x6807;&#x51C6;&#x8F93;&#x5165;&#x8F6C;&#x6210;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;, <code>echo &quot;helloworld | xargs echo</code>&#x5C31;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x6253;&#x5370;&#x4E86;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/961f4bedbfcae2c48806b629d9c9b7fc.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015911062771859463.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015911062771859463.html" itemprop="url">pip 常用命令与国内源配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T19:22:04+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</li>
</ul>
<blockquote>
<p>pip&#x9ED8;&#x8BA4;&#x6E90;&#x5B58;&#x5728;&#x901F;&#x5EA6;&#x6162;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x672C;&#x6587;&#x4ECB;&#x7ECD;pip&#x547D;&#x4EE4;&#x6DFB;&#x52A0;&#x56FD;&#x5185;&#x6E90;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
</blockquote>
<h3 id="pip&#x5E38;&#x7528;&#x547D;&#x4EE4;"><a href="#pip&#x5E38;&#x7528;&#x547D;&#x4EE4;" class="headerlink" title="pip&#x5E38;&#x7528;&#x547D;&#x4EE4;"></a>pip&#x5E38;&#x7528;&#x547D;&#x4EE4;</h3><h4 id="&#x5B89;&#x88C5;&#x5305;"><a href="#&#x5B89;&#x88C5;&#x5305;" class="headerlink" title="&#x5B89;&#x88C5;&#x5305;"></a>&#x5B89;&#x88C5;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip install Package</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<h4 id="&#x66F4;&#x65B0;&#x5305;"><a href="#&#x66F4;&#x65B0;&#x5305;" class="headerlink" title="&#x66F4;&#x65B0;&#x5305;"></a>&#x66F4;&#x65B0;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip install -U Package</span><br></pre></td></tr></table></figure>

<h4 id="&#x5378;&#x8F7D;&#x5305;"><a href="#&#x5378;&#x8F7D;&#x5305;" class="headerlink" title="&#x5378;&#x8F7D;&#x5305;"></a>&#x5378;&#x8F7D;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip uninstall Package</span><br></pre></td></tr></table></figure>

<h4 id="&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;"><a href="#&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;" class="headerlink" title="&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;"></a>&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip list</span><br><span class="line">pip freeze</span><br><span class="line">pip freeze -r requirements.txt</span><br></pre></td></tr></table></figure>

<h4 id="&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;"><a href="#&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;" class="headerlink" title="&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;"></a>&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;pip show -f Package</span><br></pre></td></tr></table></figure>

<h3 id="&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;"><a href="#&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;" class="headerlink" title="&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;"></a>&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;</h3><h4 id="&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;"><a href="#&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;" class="headerlink" title="&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;"></a>&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;</h4><ul>
<li>&#x963F;&#x91CC;&#x4E91; <a href="/external_links/28c536c1beb72880df307115634edfc5.html" target="blank" rel="noopener">mirrors.aliyun.com/pypi/simple&#x2026;</a></li>
<li>&#x8C46;&#x74E3;<a href="/external_links/460f72cfa998c24c9a67d3979508d16f.html" target="blank" rel="noopener">pypi.douban.com/simple/</a></li>
<li>&#x6E05;&#x534E;&#x5927;&#x5B66; <a href="/external_links/e96bd21ec01a5aba9ba254af4815a81a.html" target="blank" rel="noopener">pypi.tuna.tsinghua.edu.cn/simple/</a></li>
<li>&#x4E2D;&#x56FD;&#x79D1;&#x5B66;&#x6280;&#x672F;&#x5927;&#x5B66; <a href="/external_links/e160b3c6e9d5addbe0d900554bc36e1a.html" target="blank" rel="noopener">pypi.mirrors.ustc.edu.cn/simple/</a></li>
<li>&#x534E;&#x4E2D;&#x79D1;&#x6280;&#x5927;&#x5B66;<a href="/external_links/4e3547260ce2d6ea94486d555504dd02.html" target="blank" rel="noopener">pypi.hustunique.com/</a></li>
</ul>
<p><strong>&#x65B0;&#x7248;ubuntu&#x8981;&#x6C42;&#x4F7F;&#x7528;https&#x6E90;&#xFF0C;&#x8981;&#x6CE8;&#x610F;&#x3002;</strong></p>
<blockquote>
<p>&#x5C31;&#x6211;&#x7684;&#x7ECF;&#x9A8C;&#x6765;&#x8BF4;&#x963F;&#x91CC;&#x4E91;&#x662F;&#x76EE;&#x524D;&#x7528;&#x4E0B;&#x6765;&#x6700;&#x7A33;&#x5B9A;&#x53EF;&#x9760;&#x7684;&#x3002;</p>
</blockquote>
<h4 id="&#x4E34;&#x65F6;&#x4F7F;&#x7528;"><a href="#&#x4E34;&#x65F6;&#x4F7F;&#x7528;" class="headerlink" title="&#x4E34;&#x65F6;&#x4F7F;&#x7528;"></a>&#x4E34;&#x65F6;&#x4F7F;&#x7528;</h4><blockquote>
<p>&#x5728;&#x4F7F;&#x7528;pip&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x4E0A;&#x53C2;&#x6570; <code>-i</code> &#x548C;&#x955C;&#x50CF;&#x5730;&#x5740;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;pip install -i https://mirrors.aliyun.com/pypi/simple/ tensorboard</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4ECE;&#x6E05;&#x534E;&#x6E90;&#x5B89;&#x88C5; tensorboard</p>
</blockquote>
<h4 id="&#x547D;&#x4EE4;&#x914D;&#x7F6E;"><a href="#&#x547D;&#x4EE4;&#x914D;&#x7F6E;" class="headerlink" title="&#x547D;&#x4EE4;&#x914D;&#x7F6E;"></a>&#x547D;&#x4EE4;&#x914D;&#x7F6E;</h4><blockquote>
<p>&#x5728;&#x7EC8;&#x7AEF;&#x8F93;&#x5165;&#x547D;&#x4EE4;&#xFF1A;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;pip install pip -U    # &#x5347;&#x7EA7;pip&#x5230;&#x6700;&#x65B0;&#x7248;&#x672C;</span><br><span class="line">pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x6B64;&#x65B9;&#x6CD5;&#x914D;&#x7F6E;&#x540E;&#x5B89;&#x88C5;&#x5305;&#x65F6;&#x53EF;&#x80FD;&#x4F1A;&#x63D0;&#x793A;&#x4E0B;&#x8F7D;&#x6E90;&#x4E0D;&#x53EF;&#x4FE1;&#xFF0C;&#x9700;&#x8981;&#x624B;&#x52A8;&#x52A0;&#x4E0A;<code>--trusted-host mirrors.aliyun.com</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;The repository located at mirrors.aliyun.com is not a trusted or secure host and is being ignored. If this repository is available via HTTPS we recommend you use HTTPS instead, otherwise you may silence this warning and allow it anyway with &apos;--trusted-host mirrors.aliyun.com&apos;.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x90A3;&#x4E48;&#x9999;&#x4E86;&#xFF0C;&#x4E00;&#x52B3;&#x6C38;&#x9038;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x4FEE;&#x6539;pip&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
</blockquote>
<h4 id="&#x4FEE;&#x6539;&#x914D;&#x7F6E;"><a href="#&#x4FEE;&#x6539;&#x914D;&#x7F6E;" class="headerlink" title="&#x4FEE;&#x6539;&#x914D;&#x7F6E;"></a>&#x4FEE;&#x6539;&#x914D;&#x7F6E;</h4><h5 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h5><blockquote>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&#xFF1A;</p>
</blockquote>
<ul>
<li><code>~/.pip/pip.conf</code></li>
<li><code>~/.config/pip/pip.conf</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<h5 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h5><blockquote>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&#xFF1A;</p>
</blockquote>
<ul>
<li><code>%HOMEPATH%\pip\pip.ini</code>&#xFF0C;&#x5373; <code>C:\Users\pip\pip.ini</code></li>
<li><code>%APPDATA%\pip\pip.ini</code>&#xFF0C;&#x5373;<code>C:\Users\AppData\Roaming\pip\pip.ini</code></li>
</ul>
<blockquote>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;cmd&#x4E2D;&#x8F93;&#x5165; <code>echo %APPDATA%</code> &#x6216; <code>echo %HOMEPATH%</code> &#x67E5;&#x770B;&#x81EA;&#x5DF1;&#x7684;&#x76F8;&#x5173;&#x8DEF;&#x5F84;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yml&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<h4 id="&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;"><a href="#&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;" class="headerlink" title="&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;"></a>&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;</h4><ul>
<li><code>http</code>&#x4E0D;&#x53EF;&#x4FE1;&#xFF0C;&#x5C06;&#x6E90;&#x5730;&#x5740;&#x4FEE;&#x6539;&#x4E3A; <code>https</code> &#x4E5F;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x4FE1;&#x4EFB;&#x5371;&#x673A;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2734c44683c0155f02a214eab84ccb72.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015855422049353741.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015855422049353741.html" itemprop="url">随手记   AOP 如何避开 BeanNotOfRequir</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T15:48:35+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x4ECA;&#x5929;&#x5BF9; Spring &#x8FDB;&#x884C;&#x6DF1;&#x5EA6;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019; , &#x60F3;&#x4EFF;&#x7167; AOP &#x53BB;&#x5B9E;&#x73B0;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7406; , &#x4F46;&#x662F;&#x5374;&#x89E6;&#x53D1;&#x4E86; <strong>BeanNotOfRequiredTypeException</strong> &#x5F02;&#x5E38; , &#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; Spring &#x4F1A;&#x8FDB;&#x884C;&#x7C7B;&#x7684;&#x6821;&#x9A8C;</p>
<p>&#x4E8E;&#x662F;&#x7A81;&#x7136;&#x4EA7;&#x751F;&#x4E86;&#x597D;&#x5947; , &#x51B3;&#x5B9A;&#x7814;&#x7A76;&#x4E00;&#x4E0B; , AOP &#x662F;&#x901A;&#x8FC7;&#x4EC0;&#x4E48;&#x65B9;&#x5F0F;&#x907F;&#x5F00;&#x8FD9;&#x4E2A;&#x6821;&#x9A8C;&#x8FC7;&#x7A0B;</p>
<h2 id="&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;"><a href="#&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;" class="headerlink" title="&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;"></a>&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;</h2><ul>
<li>AOP &#x901A;&#x8FC7; AopProxy &#x8FDB;&#x884C;&#x4EE3;&#x7406;</li>
<li>SpringBoot 1.5 &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; JDK Proxy , SpringBoot 2.0 &#x57FA;&#x4E8E;&#x81EA;&#x52A8;&#x88C5;&#x914D;(AopAutoConfiguration)&#x7684;&#x914D;&#x7F6E; , &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; CGlib</li>
</ul>
<blockquote>
<p>JDK Proxy &#x548C; CGLib &#x7684;&#x533A;&#x522B;</p>
</blockquote>
<p><strong>&#x8001;&#x751F;&#x5E38;&#x8C08;&#x7684;&#x95EE;&#x9898; , &#x95EE;&#x4E86;&#x5B8C;&#x6574;&#x6027;(&#x51D1;&#x5B57;&#x6570;) , &#x8FD8;&#x662F;&#x7B80;&#x5355;&#x5217;&#x4E00;&#x4E0B; :</strong></p>
<ul>
<li>JDK Proxy : &#x5229;&#x7528;&#x62E6;&#x622A;&#x5668;(&#x62E6;&#x622A;&#x5668;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;InvocationHanlder)&#x52A0;&#x4E0A;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;&#x4EE3;&#x7406;&#x63A5;&#x53E3;&#x7684;&#x533F;&#x540D;&#x7C7B;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x65B9;&#x6CD5;&#x524D;&#x8C03;&#x7528;InvokeHandler&#x6765;&#x5904;&#x7406;&#x3002;</li>
<li>CGLIB&#x52A8;&#x6001;&#x4EE3;&#x7406;:&#x5229;&#x7528;ASM&#x5F00;&#x6E90;&#x5305;&#xFF0C;&#x5BF9;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7C7B;&#x7684;class&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x8FDB;&#x6765;&#xFF0C;&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5176;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x5B50;&#x7C7B;&#x6765;&#x5904;&#x7406;&#x3002;</li>
</ul>
<p><strong>PS : &#x901A;&#x8FC7; proxy-target-class &#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</strong></p>
<h2 id="&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;"><a href="#&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;" class="headerlink" title="&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;"></a>&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;</h2><p>&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x662F; CGLIB , &#x6240;&#x4EE5;&#x4E3B;&#x6D41;&#x7A0B;&#x8FD8;&#x662F;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5206;&#x6790; , &#x6709;&#x4E86;&#x524D;&#x7F6E;&#x77E5;&#x8BC6;&#x7684;&#x8865;&#x5145; , &#x5B9E;&#x73B0;&#x731C;&#x6D4B;&#x662F;&#x7531;&#x4E8E; CGLIB &#x7684;&#x7279;&#x6027; , &#x5B9E;&#x9645;&#x4E0A;&#x88AB;&#x6821;&#x9A8C;&#x51FA;&#x6765;.</p>
<ul>
<li><strong>&#x6E90;&#x5934;</strong> :autowired &#x5BFC;&#x5165;&#x5F97;&#x65F6;&#x5019;&#x4F1A;&#x6821;&#x9A8C;&#x6CE8;&#x5165;&#x7684;&#x7C7B;&#x662F;&#x5426;&#x6B63;&#x786E;</li>
</ul>
<h3 id="3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"><a href="#3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;" class="headerlink" title="3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"></a>3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;</h3><ul>
<li>Step 1 : AbstractAutowireCapableBeanFactory # populateBean</li>
<li>Step 2 : AutowiredAnnotationBeanPostProcessor # postProcessProperties</li>
<li>Step 3 : InjectionMetadata # inject</li>
<li>Step 4 : AutowiredAnnotationBeanPostProcessor # inject</li>
<li>Step 5 : DefaultListableBeanFactory # doResolveDependency</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,</span><br><span class="line">      @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {</span><br><span class="line"></span><br><span class="line">      //............ &#x4EE5;&#x4E0B;&#x662F;&#x4E3B;&#x8981;&#x903B;&#x8F91; </span><br><span class="line"></span><br><span class="line">      if (autowiredBeanNames != null) {</span><br><span class="line">         autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x83B7;&#x53D6; Autowired &#x7684;&#x5B9E;&#x9645;&#x5BF9;&#x8C61;&#x6216;&#x8005;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span><br><span class="line">      if (instanceCandidate instanceof Class) {</span><br><span class="line">         instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5224;&#x65AD;&#x8BE5;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x4E3A;null</span><br><span class="line">      Object result = instanceCandidate;</span><br><span class="line">      if (result instanceof NullBean) {</span><br><span class="line">         if (isRequired(descriptor)) {</span><br><span class="line">            raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">         }</span><br><span class="line">         result = null;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x6838;&#x5FC3;&#x62E6;&#x622A;&#x903B;&#x8F91;</span><br><span class="line">      if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">         throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"><a href="#3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;" class="headerlink" title="3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"></a>3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">    </span><br><span class="line">    // &#x7C7B;&#x578B;&#x5224;&#x65AD;</span><br><span class="line">    if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">        return true;</span><br><span class="line">    } else {</span><br><span class="line">        Class resolvedWrapper;</span><br><span class="line">        </span><br><span class="line">        // &#x57FA;&#x672C;&#x7C7B;&#x578B;&#x7279;&#x6B8A;&#x5904;&#x7406;</span><br><span class="line">        if (lhsType.isPrimitive()) {</span><br><span class="line">            resolvedWrapper = (Class)primitiveWrapperTypeMap.get(rhsType);</span><br><span class="line">            return lhsType == resolvedWrapper;</span><br><span class="line">        } else {</span><br><span class="line">            resolvedWrapper = (Class)primitiveTypeToWrapperMap.get(rhsType);</span><br><span class="line">            return resolvedWrapper != null &amp;&amp; lhsType.isAssignableFrom(resolvedWrapper);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-AOP-&#x7684;&#x4F7F;&#x7528;"><a href="#3-3-AOP-&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="3.3 AOP &#x7684;&#x4F7F;&#x7528;"></a>3.3 AOP &#x7684;&#x4F7F;&#x7528;</h3><p>&#x770B;&#x5230;&#x4E86;&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3; , &#x90A3;&#x5C31;&#x5F97;&#x770B;&#x770B; AOP &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x901A;&#x8FC7; PostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684;&#x4E86; , &#x9996;&#x5148;&#x770B;&#x4E00;&#x4E0B; PostProcessor &#x94FE;&#x8868;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a6a7be386790c1ba8cbc3fb0b837cbdbb912e9cfce5e52e9a47315e988a971a9" alt="image.png"></p>
<blockquote>
<p>Step 1 : &#x5F53;&#x5BF9;&#x8C61; A &#x4E2D;&#x5B57;&#x6BB5;&#x662F; @Autowired &#x6CE8;&#x5165;&#x7684; AOP &#x4EE3;&#x7406;&#x7C7B;&#x65F6;</p>
</blockquote>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0; , &#x5728; DefaultListableBeanFactory # doResolveDependency &#x73AF;&#x8282;&#x4F1A;&#x53BB;&#x83B7;&#x53D6;&#x8BE5;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x5BF9;&#x8C61; ,<br>&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x83B7;&#x53D6;&#x5BF9;&#x8C61;&#x73AF;&#x8282;</span><br><span class="line">if (instanceCandidate instanceof Class) { </span><br><span class="line">   // &#x6B64;&#x65F6;&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x4E00;&#x4E2A; cglib &#x4EE3;&#x7406;&#x7C7B;</span><br><span class="line">   instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/aef7575ca1ddc94558c71bc7de00e268839f779e598d150effe56d2df5c550af" alt="image.png"></p>
<blockquote>
<p>Step 2 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x5165;&#x53E3;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB; -&gt; true</span><br><span class="line">if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">   throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// result.getClass()</span><br><span class="line">- name=com.gang.aop.demo.service.StartService$$EnhancerBySpringCGLIB$$d673b902</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 3 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x903B;&#x8F91;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;C- ClassUtils</span><br><span class="line">public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">   </span><br><span class="line">   // &#x6838;&#x5FC3;&#x8BED;&#x53E5; , native &#x65B9;&#x6CD5; -&gt; public native boolean isAssignableFrom(Class&lt;?&gt; cls);</span><br><span class="line">   if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">      return true;</span><br><span class="line">   }</span><br><span class="line">   //.........</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x7EE7;&#x627F;&#x7C7B; , ChildService extends ChildService</span><br><span class="line">: ------&gt; ChildService By ParentService :false &lt;-------</span><br><span class="line">: ------&gt; ParentService By ChildService:true &lt;-------</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x6B64;&#x53EF;&#x89C1; cglib &#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x6EE1;&#x8DB3;&#x8BE5;&#x6761;&#x4EF6; : <strong>&#x76F8;&#x540C; , &#x6216;&#x8005;&#x662F;&#x8D85;&#x7C7B;&#x6216;&#x8005;&#x8D85;&#x63A5;&#x53E3;</strong></p>
<p><strong>&#x8FD9;&#x91CC;&#x56DE;&#x8FC7;&#x5934;&#x770B;&#x4E4B;&#x524D;&#x7684;&#x95EE;&#x9898; , &#x5C31;&#x5F88;&#x7B80;&#x5355;&#x4E86; :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x95EE;&#x9898;&#x539F;&#x56E0; : </span><br><span class="line">&#x6211;&#x901A;&#x8FC7;&#x5B9E;&#x73B0; postProcessor &#x53BB;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x4EE3;&#x7406; </span><br><span class="line">public class AopProxyImpl extends Sourceable {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line">// &#x4FEE;&#x6539;&#x540E; : </span><br><span class="line">public class AopProxyImpl extends Source {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x5373;&#x53EF;&#x89E3;&#x51B3; BeanNotOfRequiredTypeException ,&#x5F04;&#x61C2;&#x4E86;&#x5C31;&#x6CA1;&#x4EC0;&#x4E48;&#x96BE;&#x5EA6;&#x4E86;</span><br><span class="line">//</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;"><a href="#&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;" class="headerlink" title="&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;"></a>&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;</h2><p>&#x90A3;&#x4E48;&#x7EE7;&#x7EED;&#x56DE;&#x987E;&#x4E0B; CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B; , &#x5B9E;&#x9645;&#x4E0A;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x7ED3;&#x679C;&#x4E0A;&#x662F;&#x53EF;&#x4EE5;&#x5F88;&#x76F4;&#x89C2;&#x7684;&#x770B;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x5BF9;&#x8C61;&#x7684; :</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ab4b2dc66710c0288633a3f2a7a34cf5930c8d5263cd85cdf8ee62dc25213235" alt="image.png"></p>
<p>&#x5173;&#x4E8E; CGLIB &#x7684;&#x57FA;&#x7840; , &#x53EF;&#x4EE5;&#x770B;&#x770B;&#x83DC;&#x9E1F;&#x7684;&#x6587;&#x6863; <a href="/external_links/fe1ac05d25dbc344520f0c285b601cf1.html" target="blank" rel="noopener">CGLIB(Code Generation Library) &#x4ECB;&#x7ECD;&#x4E0E;&#x539F;&#x7406;</a> , &#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;</p>
<h3 id="4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"><a href="#4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;" class="headerlink" title="4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"></a>4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;</h3><blockquote>
<p>FastClass &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>FastClass &#x5C31;&#x662F;&#x7ED9;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x7F16;&#x53F7;&#xFF0C;&#x901A;&#x8FC7;&#x7F16;&#x53F7;&#x627E;&#x5230;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x9891;&#x7E41;&#x4F7F;&#x7528;&#x53CD;&#x5C04;&#x5BFC;&#x81F4;&#x6548;&#x7387;&#x6BD4;&#x8F83;&#x4F4E;</p>
<p>CGLIB &#x4F1A;&#x751F;&#x6210;2&#x4E2A; fastClass :</p>
<ul>
<li>xxxx$$FastClassByCGLIB$$xxxx :<strong>&#x4E3A;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
<li>xxxx$$EnhancerByCGLIB$$xxxx$$FastClassByCGLIB$$xxxx : <strong>&#x4E3A;&#x6211;&#x4EEC;&#x88AB;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x5305;&#x542B;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
</ul>
<p><strong>&#x539F;&#x56E0; :</strong> cglib&#x4EE3;&#x7406;&#x57FA;&#x4E8E;&#x7EE7;&#x627F;&#x5B9E;&#x73B0;&#xFF0C;&#x7236;&#x7C7B;&#x4E2D;&#x975E;public&#x3001;final&#x7684;&#x65B9;&#x6CD5;&#x65E0;&#x6CD5;&#x88AB;&#x7EE7;&#x627F;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#x7684;fastclass&#x6765;&#x8C03;&#x7528;&#x4EE3;&#x7406;&#x4E0D;&#x5230;&#x7684;&#x65B9;&#x6CD5;</p>
<p>FastClass &#x4E2D;&#x6709;2&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x65B9;&#x6CD5; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4EE3;&#x7406;&#x65B9;&#x6CD5;</span><br><span class="line">public Object invoke(final int n, final Object o, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    final CglibService cglibService = (CglibService)o;</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x4EE3;&#x7406;&#x5BF9;&#x5E94;&#x7684;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;</span><br><span class="line">            cglibService.run();</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        case 1: {</span><br><span class="line">            // &#x4EE3;&#x7406; equeals &#x65B9;&#x6CD5;</span><br><span class="line">            return new Boolean(cglibService.equals(array[0]));</span><br><span class="line">        }</span><br><span class="line">        case 2: {</span><br><span class="line">            // &#x4EE3;&#x7406; toString &#x65B9;&#x6CD5;</span><br><span class="line">            return cglibService.toString();</span><br><span class="line">        }</span><br><span class="line">        case 3: {</span><br><span class="line">            // &#x4EE3;&#x7406; hashCode &#x65B9;&#x6CD5; </span><br><span class="line">            return new Integer(cglibService.hashCode());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61; </span><br><span class="line">public Object newInstance(final int n, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x6B64;&#x5904;&#x603B;&#x7ED3;&#x901A;&#x8FC7; new &#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;</span><br><span class="line">            return new CglibService();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>enchance &#x5BF9;&#x8C61;</p>
</blockquote>
<p>&#x4E4B;&#x524D;&#x4E86;&#x89E3;&#x5230; , cglib &#x901A;&#x8FC7;&#x91CD;&#x5199;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x4E3B;&#x7C7B;&#x8FBE;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x76EE;&#x7684; , &#x8FD9;&#x91CC;&#x6765;&#x770B;&#x4E00;&#x4E0B; , &#x539F;&#x65B9;&#x6CD5;&#x88AB;&#x6539;&#x5199;&#x6210;&#x4EC0;&#x4E48;&#x6837;&#x4E86;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;final void CGLIB$run$0() {</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">public final void run() {</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_2;</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_0;</span><br><span class="line">    if ((cglib$CALLBACK_0 = (cglib$CALLBACK_2 = this.CGLIB$CALLBACK_0)) == null) {</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        cglib$CALLBACK_2 = (cglib$CALLBACK_0 = this.CGLIB$CALLBACK_0);</span><br><span class="line">    }</span><br><span class="line">    if (cglib$CALLBACK_0 != null) {</span><br><span class="line">        // &#x8C03;&#x7528;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61;</span><br><span class="line">        cglib$CALLBACK_2.intercept((Object)this, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Method, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$emptyArgs, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Proxy);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    // &#x6CA1;&#x6709;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61; , &#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5B9E;&#x9645;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x62E6;&#x622A;&#x5668;</span><br><span class="line">public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {</span><br><span class="line">    </span><br><span class="line">    // &#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x5173;&#x8054;&#x7C7B;</span><br><span class="line">    // &#x6700;&#x7EC8;&#x901A;&#x8FC7; super.run &#x8C03;&#x7528;</span><br><span class="line">    Object result = proxy.invokeSuper(obj, args);     </span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x5904;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6620;&#x5C04;&#x5173;&#x7CFB;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/68c60d7f3d943afcfdb02123ea31bbe49c87333a130cc1385f495f0498978ab3" alt="image.png"></p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9fbe35eb4f090ddb29e2860952eb6fc2ed40f1c0e1f72c114be21c20faf96b2" alt="cglib.jpg"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/627bf1768683d8531a3aa9aa1e9574f6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015539581927833636.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015539581927833636.html" itemprop="url">盘点 Spring   Conditional</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-05T19:25:02+08:00">
                2021-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x6765;&#x770B;&#x4E00;&#x4E0B;Conditional&#x7684;&#x4F7F;&#x7528;&#x548C;&#x539F;&#x7406; , &#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f5da8494fdc3dbfb82db38462ff9127df6675d9aac36f2e1f449b7501281945a" alt="System-SpringBootCondition.png"></p>
<h2 id="&#x4E8C;-&#x4F7F;&#x7528;"><a href="#&#x4E8C;-&#x4F7F;&#x7528;" class="headerlink" title="&#x4E8C; . &#x4F7F;&#x7528;"></a>&#x4E8C; . &#x4F7F;&#x7528;</h2><ul>
<li>@ConditionalOnBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6CA1;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnSingleCandidate&#xFF1A;&#x5F53;&#x6307;&#x5B9A; Bean &#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#xFF0C;&#x6216;&#x8005;&#x867D;&#x7136;&#x6709;&#x591A;&#x4E2A;&#x4F46;&#x662F;&#x6307;&#x5B9A;&#x9996;&#x9009; Bean</li>
<li>@ConditionalOnClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnProperty&#xFF1A;&#x6307;&#x5B9A;&#x7684;&#x5C5E;&#x6027;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnResource&#xFF1A;&#x7C7B;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnExpression&#xFF1A;&#x57FA;&#x4E8E; SpEL &#x8868;&#x8FBE;&#x5F0F;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x3002;</li>
<li>@ConditionalOnJava&#xFF1A;&#x57FA;&#x4E8E; Java &#x7248;&#x672C;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;</li>
<li>@ConditionalOnJndi&#xFF1A;&#x5728; JNDI &#x5B58;&#x5728;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x5DEE;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x4F4D;&#x7F6E;</li>
<li>@ConditionalOnNotWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x4E0D;&#x662F; Web &#x9879;&#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
<li>@ConditionalOnWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x662F; Web&#x9879; &#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
</ul>
<h3 id="2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><h3 id="2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional"><a href="#2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional" class="headerlink" title="2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional"></a>2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DefaultConditional implements Condition {</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">        logger.info(&quot;------&gt; &#x8FDB;&#x884C; Conditional &#x5224;&#x65AD; &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Bean</span><br><span class="line">@ConditionalOnBean(TestService.class)</span><br><span class="line">public ConfigBean getConfigBean() {</span><br><span class="line">    logger.info(&quot;------&gt; &#x5F00;&#x59CB;&#x52A0;&#x8F7D; ConditionalOnBean &lt;-------&quot;);</span><br><span class="line">    return new ConfigBean();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"><a href="#&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;" class="headerlink" title="&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"></a>&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;</h2><h3 id="3-1-Conditional-&#x5165;&#x53E3;"><a href="#3-1-Conditional-&#x5165;&#x53E3;" class="headerlink" title="3.1 Conditional &#x5165;&#x53E3;"></a>3.1 Conditional &#x5165;&#x53E3;</h3><p>&#x5BF9;&#x4E8E; Configuration.@Bean &#x7684;&#x521B;&#x5EFA;&#x65B9;&#x5F0F; , Conditinal &#x7684;&#x8D77;&#x70B9;&#x662F; <strong>refush# invokeBeanFactoryPostProcessors</strong> , &#x5728;&#x5176;&#x4E2D;&#x4F1A;&#x8C03;&#x7528; <strong>ConfigurationClassPostProcessor</strong> &#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) {</span><br><span class="line"></span><br><span class="line">  // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D; Configuration &#x4E2D; @Bean &#x7684;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;</span><br><span class="line">  ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line">  MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line">  String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line">  // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x8DF3;&#x8FC7;&#x5F53;&#x524D; Bean</span><br><span class="line">  if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) {</span><br><span class="line">     configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">  if (configClass.skippedBeanMethods.contains(methodName)) {</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"><a href="#3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;" class="headerlink" title="3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"></a>3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;</h3><p>ConditionEvaluator &#x662F;&#x6838;&#x5FC3;&#x5904;&#x7406;&#x7C7B; , &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x8DF3;&#x8FC7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConditionEvaluator</span><br><span class="line">public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5982;&#x679C;&#x5F53;&#x524D; Bean &#x4E0D;&#x5305;&#x542B; @Conditional , &#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">   if (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) {</span><br><span class="line">      return false;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">    // Step 2 : &#x6709;2&#x79CD; ConfigurationPhase &#x7684;&#x7C7B;&#x578B; , &#x8868;&#x793A;2&#x79CD;&#x914D;&#x7F6E;&#x7684;&#x9636;&#x6BB5;</span><br><span class="line">    // PARSE_CONFIGURATION :Condition&#x5E94;&#x8BE5;&#x5728;&#x89E3;&#x6790;@Configuration&#x7C7B;&#x65F6;&#x8FDB;&#x884C;&#x8BA1;&#x7B97; , &#x5982;&#x679C;&#x6B64;&#x65F6;&#x6761;&#x4EF6;&#x4E0D;&#x5339;&#x914D;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x6DFB;&#x52A0;@Configuration&#x7C7B;</span><br><span class="line">    // REGISTER_BEAN : &#x6761;&#x4EF6;&#x4E0D;&#x4F1A;&#x963B;&#x6B62;@Configuration&#x7C7B;&#x88AB;&#x6DFB;&#x52A0; , &#x5728;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x6240;&#x6709;@Configuration&#x7C7B;&#x90FD;&#x5C06;&#x88AB;&#x89E3;&#x6790;</span><br><span class="line">   if (phase == null) {</span><br><span class="line">      if (metadata instanceof AnnotationMetadata &amp;&amp;</span><br><span class="line">            ConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) {</span><br><span class="line">         return shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">      }</span><br><span class="line">      return shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 3 : &#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684; Condition &#x5BF9;&#x8C61;</span><br><span class="line">   List&lt;Condition&gt; conditions = new ArrayList&lt;&gt;();</span><br><span class="line">   for (String[] conditionClasses : getConditionClasses(metadata)) {</span><br><span class="line">      for (String conditionClass : conditionClasses) {</span><br><span class="line">         Condition condition = getCondition(conditionClass, this.context.getClassLoader());</span><br><span class="line">         conditions.add(condition);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 4 : &#x6392;&#x5E8F; </span><br><span class="line">   AnnotationAwareOrderComparator.sort(conditions);</span><br><span class="line"></span><br><span class="line">   for (Condition condition : conditions) {</span><br><span class="line">      ConfigurationPhase requiredPhase = null;</span><br><span class="line">      if (condition instanceof ConfigurationCondition) {</span><br><span class="line">         requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();</span><br><span class="line">      }</span><br><span class="line">      // Step 5 : &#x6700;&#x7EC8;&#x7684; Condition &#x5339;&#x914D;&#x8FC7;&#x7A0B;</span><br><span class="line">      if ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) {</span><br><span class="line">         return true;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   return false;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x76F4;&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x5F00;&#x59CB;&#x5339;&#x914D;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;</p>
<h2 id="&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"><a href="#&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;" class="headerlink" title="&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"></a>&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;</h2><blockquote>
<p>&#x89E3;&#x6790;</p>
</blockquote>
<p>&#x5DF2;&#x77E5;&#x7684;Conditional &#x662F;&#x57FA;&#x4E8E; SpringBootCondition &#x5B9E;&#x73B0;&#x7684; , &#x5176;&#x5177;&#x4F53;&#x62BD;&#x8C61;&#x7C7B;&#x4E3A; FilteringSpringBootCondition , &#x770B;&#x4E00;&#x4E0B;&#x4E3B;&#x8981;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f710068f336807b5d041b0adc38d217037016de24f896e2bbfc3ab0679890651" alt="System_FilteringSpringBootCondition.png"></p>
<blockquote>
<p>&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x7684;&#x7C7B;</p>
</blockquote>
<p>&#x7B2C;&#x4E00;&#x6B65;&#x662F;&#x5FEB;&#x901F;&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7C7B; , &#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#x5982;&#x4E0B; :</p>
<ul>
<li><strong>&#x8D77;&#x70B9;</strong> : AbstractApplicationContext # refresh # invokeBeanFactoryPostProcessors</li>
<li><strong>&#x5904;&#x7406;</strong> : ConfigurationClassPostProcessor # postProcessBeanDefinitionRegistry &#x5904;&#x7406;&#x4E3B;&#x8981;&#x903B;&#x8F91;</li>
<li><strong>&#x62E6;&#x622A;</strong> : ConfigurationClassFilter # filter</li>
<li><strong>&#x5339;&#x914D;</strong> : FilteringSpringBootCondition # match</li>
</ul>
<p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x662F;&#x8FDB;&#x884C; match &#x5339;&#x914D; ,&#x76EE;&#x7684;&#x662F;&#x83B7;&#x53D6;&#x57FA;&#x4E8E;&#x6B63;&#x5728;&#x5BFC;&#x5165;&#x7684;Configuration&#x7C7B;&#x7684;AnnotationMetadata&#x7684;AutoConfigurationEntry</strong></p>
<h3 id="4-1-Filter-&#x62E6;&#x622A;"><a href="#4-1-Filter-&#x62E6;&#x622A;" class="headerlink" title="4.1 Filter &#x62E6;&#x622A;"></a>4.1 Filter &#x62E6;&#x622A;</h3><p>Filter &#x62E6;&#x622A;&#x662F;&#x5728; ConfigurationClassFilter ,&#x5176;&#x4E2D;&#x4F1A;&#x5BF9;&#x6240;&#x6709;&#x7684; Conditional &#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private static class ConfigurationClassFilter {</span><br><span class="line"></span><br><span class="line">   // &#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7684;&#x5143;&#x6570;&#x636E;</span><br><span class="line">   private final AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; filter(List&lt;String&gt; configurations) {</span><br><span class="line">      long startTime = System.nanoTime();</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x4E3A;&#x6240;&#x6709;&#x7684; Confiturations &#x7C7B;</span><br><span class="line">      String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">      boolean skipped = false;</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x5305;&#x542B; OnBeanCondition , OnClassCondition  ,OnWebApplicationCondition &#x4E09;&#x79CD;</span><br><span class="line">      for (AutoConfigurationImportFilter filter : this.filters) {</span><br><span class="line">         // &#x83B7;&#x53D6;&#x662F;&#x5426; &#x5B58;&#x5728; match &#x5339;&#x914D;</span><br><span class="line">         boolean[] match = filter.match(candidates, this.autoConfigurationMetadata);</span><br><span class="line">         for (int i = 0; i &lt; match.length; i++) {</span><br><span class="line">            if (!match[i]) {</span><br><span class="line">               candidates[i] = null;</span><br><span class="line">               skipped = true;</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      if (!skipped) {</span><br><span class="line">         return configurations;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5982;&#x679C;&#x4E0D;&#x80FD;&#x8DF3;&#x8FC7; , &#x8BB0;&#x5F55;&#x5F53;&#x524D; Confiturations &#x7C7B;</span><br><span class="line">      List&lt;String&gt; result = new ArrayList&lt;&gt;(candidates.length);</span><br><span class="line">      for (String candidate : candidates) {</span><br><span class="line">         if (candidate != null) {</span><br><span class="line">            result.add(candidate);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;"><a href="#4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;" class="headerlink" title="4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;"></a>4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;</h3><p>&#x6B64;&#x5904;&#x662F;&#x91CD;&#x5199;&#x4E86;&#x5176;&#x7236;&#x7C7B;&#x7684; match &#x65B9;&#x6CD5;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public boolean[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">   // Step 1 :  &#x51C6;&#x5907; Report &#x5BF9;&#x8C61; , &#x7528;&#x4E8E;&#x8BB0;&#x5F55;</span><br><span class="line">   ConditionEvaluationReport report = ConditionEvaluationReport.find(this.beanFactory);</span><br><span class="line">   // Step 2 : &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6240;&#x6709;&#x7684; Condition &#x65B9;&#x6CD5;</span><br><span class="line">   ConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses, autoConfigurationMetadata);</span><br><span class="line">   </span><br><span class="line">   boolean[] match = new boolean[outcomes.length];</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">   </span><br><span class="line">      // &#x5BF9;match&#x4E2D;&#x7684;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x8D4B;&#x503C;,&#x5F53;outcomes&#x5BF9;&#x5E94;&#x4E0B;&#x6807;&#x7684;ConditionOutcome&#x5339;&#x914D;&#x65F6;&#x4E3A;true.&#x5176;&#x4ED6;&#x60C5;&#x51B5;,&#x8FD4;&#x56DE;false</span><br><span class="line">      match[i] = (outcomes[i] == null || outcomes[i].isMatch());</span><br><span class="line">      if (!match[i] &amp;&amp; outcomes[i] != null) {</span><br><span class="line">          // &#x8BB0;&#x5F55;&#x65E5;&#x5FD7;</span><br><span class="line">         logOutcome(autoConfigurationClasses[i], outcomes[i]);</span><br><span class="line">         if (report != null) {</span><br><span class="line">            // &#x50CF; ConditionEvaluationReport # SortedMap &#x5B58;&#x653E;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</span><br><span class="line">            report.recordConditionEvaluation(autoConfigurationClasses[i], this, outcomes[i]);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return match;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ConditionEvaluationReport &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x81EA;&#x52A8;&#x5316;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x4E2D;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x53CA;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public final class ConditionEvaluationReport {</span><br><span class="line"></span><br><span class="line">    //bean&#x540D;&#x79F0;</span><br><span class="line">    private static final String BEAN_NAME = &quot;autoConfigurationReport&quot;;</span><br><span class="line">    </span><br><span class="line">    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7236;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private static final AncestorsMatchedCondition ANCESTOR_CONDITION = new AncestorsMatchedCondition();</span><br><span class="line">    </span><br><span class="line">    //&#x5B58;&#x653E;&#x7C7B;&#x540D;&#x6216;&#x65B9;&#x6CD5;&#x540D;&#xFF08;key&#xFF09;,&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x8F93;&#x51FA;&#x5BF9;&#x8C61;&#xFF08;value&#xFF09;</span><br><span class="line">    private final SortedMap&lt;String, ConditionAndOutcomes&gt; outcomes = new TreeMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    //&#x662F;&#x5426;&#x662F;&#x539F;&#x59CB;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private boolean addedAncestorOutcomes;</span><br><span class="line">    //&#x7236;&#x7684;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x62A5;&#x544A;&#x5BF9;&#x8C61;</span><br><span class="line">    private ConditionEvaluationReport parent;</span><br><span class="line">    </span><br><span class="line">    //&#x8BB0;&#x5F55;&#x5DF2;&#x7ECF;&#x4ECE;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x4E2D;&#x6392;&#x9664;&#x7684;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final List&lt;String&gt; exclusions = new ArrayList&lt;&gt;();</span><br><span class="line">    //&#x8BB0;&#x5F55;&#x4F5C;&#x4E3A;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x7684;&#x5019;&#x9009;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final Set&lt;String&gt; unconditionalClasses = new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-3-getOutcomes-&#x83B7;&#x53D6;"><a href="#4-3-getOutcomes-&#x83B7;&#x53D6;" class="headerlink" title="4.3 getOutcomes &#x83B7;&#x53D6;"></a>4.3 getOutcomes &#x83B7;&#x53D6;</h3><p>&#x6B64;&#x5904;&#x4EE5; OnBean &#x4E3A;&#x4F8B; , &#x6B64;&#x5904;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x5173;&#x8054;&#x5173;&#x7CFB; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected final ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,</span><br><span class="line">      AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">      </span><br><span class="line">   // Step 1 : &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x548C;&#x5904;&#x7406;&#x7C7B;&#x7B49;&#x5BB9;&#x91CF;&#x7684;&#x6570;&#x7EC4;</span><br><span class="line">   ConditionOutcome[] outcomes = new ConditionOutcome[autoConfigurationClasses.length];</span><br><span class="line">   </span><br><span class="line">   // Step 2 : &#x904D;&#x5386;&#x6240;&#x6709;&#x7684; autoConfigurationClasses</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">      String autoConfigurationClass = autoConfigurationClasses[i];</span><br><span class="line">      </span><br><span class="line">      if (autoConfigurationClass != null) {</span><br><span class="line">          </span><br><span class="line">         Set&lt;String&gt; onBeanTypes = autoConfigurationMetadata.getSet(autoConfigurationClass, &quot;ConditionalOnBean&quot;);</span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728; ConditionalOnBean &#x6807;&#x6CE8;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">         outcomes[i] = getOutcome(onBeanTypes, ConditionalOnBean.class);</span><br><span class="line">         </span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8F93;&#x51FA; ConditionOutcome </span><br><span class="line">         if (outcomes[i] == null) {</span><br><span class="line">            Set&lt;String&gt; onSingleCandidateTypes = autoConfigurationMetadata.getSet(autoConfigurationClass,</span><br><span class="line">                  &quot;ConditionalOnSingleCandidate&quot;);</span><br><span class="line">            // &#x6B64;&#x5904;&#x662F;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x8981;&#x5904;&#x7406;</span><br><span class="line">            outcomes[i] = getOutcome(onSingleCandidateTypes, ConditionalOnSingleCandidate.class);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return outcomes;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"><a href="#4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;" class="headerlink" title="4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"></a>4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</h3><p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x7684; matches &#x548C; FilteringSpringBootCondition &#x4E0D;&#x662F;&#x4E00;&#x4E2A;</strong></p>
<ul>
<li>FilteringSpringBootCondition # match : &#x57FA;&#x4E8E; AutoConfigurationImportFilter , &#x5BF9;&#x7ED9;&#x5B9A;&#x7684;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7C7B;&#x5019;&#x9009;&#x5E94;&#x7528;&#x7B5B;&#x9009;&#x5668;</li>
<li>SpringBootCondition # matches : &#x9700;&#x8981;&#x8FD4;&#x56DE;&#x6700;&#x7EC8;&#x7684;&#x5224;&#x65AD;&#x7ED3;&#x679C;</li>
</ul>
<blockquote>
<p>&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
</blockquote>
<ul>
<li>&#x5728; loadBeanDefinitionsForBeanMethod &#x7B49;&#x7C7B;&#x4F3C;&#x6D41;&#x7A0B;&#x79CD;&#x8C03;&#x7528; shouldSkip , &#x4ECE;&#x800C;&#x8DF3;&#x8F6C;&#x5230;&#x8BE5;&#x903B;&#x8F91;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public final boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line"></span><br><span class="line">   // &#x83B7;&#x53D6;&#x6CE8;&#x89E3;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x6216;&#x8005;&#x7C7B;&#x540D;</span><br><span class="line">   String classOrMethodName = getClassOrMethodName(metadata);</span><br><span class="line">   try {</span><br><span class="line">   </span><br><span class="line">      // &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7C7B; , &#x6B64;&#x5904;&#x4F1A;&#x5224;&#x65AD; metadata instanceof , &#x6709;&#x9650;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; ClassMetadata</span><br><span class="line">      ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br><span class="line">      </span><br><span class="line">      // &#x5F88;&#x7B80;&#x5355;&#x7684;&#x6253;&#x5370;&#x65E5;&#x5FD7; , Trace &#x7EA7;&#x522B;</span><br><span class="line">      logOutcome(classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8BB0;&#x5F55;&#x7ED3;&#x679C; , &#x901A;&#x8FC7; ConditionEvaluationReport &#x548C; recordEvaluation &#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</span><br><span class="line">      recordEvaluation(context, classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8FD4;&#x56DE;&#x662F;&#x5426;&#x6210;&#x529F;&#x5339;&#x914D;</span><br><span class="line">      return outcome.isMatch();</span><br><span class="line">   }</span><br><span class="line">   catch (NoClassDefFoundError ex) {</span><br><span class="line">      throw new IllegalStateException(......);</span><br><span class="line">   }</span><br><span class="line">   catch (RuntimeException ex) {</span><br><span class="line">      throw new IllegalStateException(&quot;Error processing condition on &quot; + getName(metadata), ex);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x662F;&#x8C03;&#x7528; getMatchOutcome &#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6216;&#x8005;&#x4E0D;&#x7B26;&#x5408;&#x8981;&#x6C42; , getMatchOutcome &#x9700;&#x8981;&#x5B50;&#x7C7B;&#x91CD;&#x5199;</p>
<h2 id="&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;"><a href="#&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;" class="headerlink" title="&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;"></a>&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;</h2><h3 id="5-1-OnClass"><a href="#5-1-OnClass" class="headerlink" title="5.1 OnClass"></a>5.1 OnClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5BB9;&#x5668; ClassLoader  </span><br><span class="line">   ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   // Step 2 : &#x5224;&#x65AD;&#x662F;&#x5426;&#x6709; ConditionalOnClass &#x7EA6;&#x675F;</span><br><span class="line">   List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br><span class="line">   if (onClasses != null) {</span><br><span class="line">      // Step 2-1 : filter &#x8FC7;&#x6EE4; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x7F3A;&#x5931;&#x7C7B; </span><br><span class="line">      List&lt;String&gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader);</span><br><span class="line">      if (!missing.isEmpty()) {</span><br><span class="line">         return ConditionOutcome.noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br><span class="line">               .didNotFind(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE, missing));</span><br><span class="line">      }</span><br><span class="line">      // Step 2-2 : &#x6784;&#x5EFA; matchMessage</span><br><span class="line">      matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br><span class="line">            .found(&quot;required class&quot;, &quot;required classes&quot;)</span><br><span class="line">            .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader));</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   // Step 3 : &#x540C;&#x7406; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981; MissClasses</span><br><span class="line">   List&lt;String&gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class);</span><br><span class="line">   if (onMissingClasses != null) {</span><br><span class="line">      // .... &#x4E0E; ConditionalOnClass &#x57FA;&#x672C;&#x7C7B;&#x4F3C; ,&#x6B64;&#x5904;&#x7701;&#x7565;</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConditionMessage &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<h3 id="5-2-OnBean"><a href="#5-2-OnBean" class="headerlink" title="5.2 OnBean"></a>5.2 OnBean</h3><p>&#x4E0E; OnBean &#x7C7B;&#x4F3C; , &#x8FD9;&#x91CC;&#x5C31;&#x5C55;&#x793A;&#x4E00;&#x79CD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   MergedAnnotations annotations = metadata.getAnnotations();</span><br><span class="line">   </span><br><span class="line">   if (annotations.isPresent(ConditionalOnBean.class)) {</span><br><span class="line">      // Step 1 :&#x83B7;&#x53D6; ConditionalOnBean &#x6CE8;&#x89E3;&#x4FE1;&#x606F;</span><br><span class="line">      Spec&lt;ConditionalOnBean&gt; spec = new Spec&lt;&gt;(context, metadata, annotations, ConditionalOnBean.class);</span><br><span class="line">      // Step 2 : &#x8FD4;&#x56DE;&#x5339;&#x914D;&#x7ED3;&#x679C;</span><br><span class="line">      // &#x5176;&#x5185;&#x90E8;&#x901A;&#x8FC7; getNamesOfBeansIgnoredByType , getBeanNamesForType &#x7B49;&#x65B9;&#x5F0F;&#x5224;&#x65AD;&#x7C7B;&#x662F;&#x5426;&#x5B58;&#x5728; </span><br><span class="line">      MatchResult matchResult = getMatchingBeans(context, spec);</span><br><span class="line">      if (!matchResult.isAllMatched()) {</span><br><span class="line">         String reason = createOnBeanNoMatchReason(matchResult);</span><br><span class="line">         return ConditionOutcome.noMatch(spec.message().because(reason));</span><br><span class="line">      }</span><br><span class="line">      matchMessage = spec.message(matchMessage).found(&quot;bean&quot;, &quot;beans&quot;).items(Style.QUOTE,</span><br><span class="line">            matchResult.getNamesOfAllMatches());</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnSingleCandidate.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnMissingBean.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>Conditional &#x672C;&#x8EAB;&#x5E76;&#x4E0D;&#x96BE; , &#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x5B8C;&#x5584;&#x56FE;&#x8C31;&#x4EE5;&#x53CA;&#x540E;&#x7EED;&#x7684; starter &#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x65B9;&#x6848; &#x505A;&#x51C6;&#x5907;.</p>
<p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x73AF;&#x8282;&#x7406;&#x89E3;&#x5C31;&#x884C;&#x4E86; :</p>
<ul>
<li>Spring &#x4E2D;&#x7684; Conditional &#x90FD;&#x4F1A;&#x7EE7;&#x627F; SpringBootCondition , &#x4F1A;&#x5B9E;&#x73B0;&#x5176; getOutcomes &#x65B9;&#x6CD5;</li>
<li>getOutcomes &#x662F;&#x7528;&#x4E8E;&#x5FEB;&#x901F;&#x53BB;&#x6389;&#x65E0;&#x9700;&#x52A0;&#x8F7D;&#x7684; Configuration , getMatchOutcome &#x662F;&#x4E3A;&#x4E86;&#x9A8C;&#x8BC1;&#x5339;&#x914D;&#x5173;&#x7CFB;</li>
<li>&#x901A;&#x5E38;&#x90FD;&#x4F1A;&#x901A;&#x8FC7; ConditionEvaluator &#x7684; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8FC7;@Bean &#x6D41;&#x7A0B;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/281031ca9f0e5159d3c1ec1896b59fa3.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015040159607423006.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015040159607423006.html" itemprop="url">Nginx实现静态资源和反向代理服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-04T11:05:05+08:00">
                2021-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x5B89;&#x88C5;"><a href="#&#x5B89;&#x88C5;" class="headerlink" title="&#x5B89;&#x88C5;"></a>&#x5B89;&#x88C5;</h2><p>&#x5B89;&#x88C5;Nginx&#x4E4B;&#x524D;&#x9700;&#x8981;&#x505A;&#x4E00;&#x4E9B;&#x51C6;&#x5907;&#xFF1A;</p>
<ul>
<li>&#x5B89;&#x88C5;GCC&#x7F16;&#x8BD1;&#x5668;&#xFF1A;<code>yum install -y gcc</code></li>
<li>G++&#x7F16;&#x8BD1;&#x5668;&#xFF1A;<code>yum install -y gcc-c++</code></li>
<li>&#x5B89;&#x88C5;PCRE&#x5E93;&#xFF1A;<code>yum install -y pcre pcre-devel</code></li>
<li>&#x5B89;&#x88C5;zlib&#x5E93;&#xFF1A;<code>yum install -y zlib zlib-devel</code></li>
<li>&#x5B89;&#x88C5;OpenSSL&#x5F00;&#x53D1;&#x5E93;&#xFF1A;<code>yum install -y openssl openssl-devel</code></li>
</ul>
<p>&#x7136;&#x540E;&#x4E0B;&#x8F7D;Nginx&#x538B;&#x7F29;&#x5305;&#x8DEF;&#x5F84;&#xFF1A;<a href="/external_links/323bd4127f8b479f1485281f7232bd62.html" target="blank" rel="noopener">Nginx&#x5B98;&#x7F51;</a><br>&#x6211;&#x8FD9;&#x91CC;&#x9009;&#x62E9;&#x7684;&#x662F;&#x7A33;&#x5B9A;&#x7248;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/f942ff05ab08da988e0d2a81a7b42cb0e35c6e50dd15c0a71bbffada80d08b48" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x89E3;&#x538B;&#xFF1A;tar -zxvf nginx-1.20.1.tar.gz <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/98641df220edd685b391fd01cdd9b1494e2cc192f800428a4e3532d25d0cdc8c" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x89E3;&#x538B;&#x4E4B;&#x540E;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/0ea203324601517d4f002e142043207951005ac81fd4b72582598fabd5904f92" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x8FDB;&#x5165;&#x76EE;&#x5F55;&#x540E;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF1A;<code>./configure</code> &#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#x68C0;&#x6D4B;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x5185;&#x6838;&#x4EE5;&#x53CA;&#x662F;&#x5426;&#x5B89;&#x88C5;&#x4E86;&#x9700;&#x8981;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x53C2;&#x6570;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x4EE5;&#x53CA;&#x4E2D;&#x95F4;&#x76EE;&#x5F55;&#x548C;Makefile&#x7B49;&#x6587;&#x4EF6;&#x7684;&#x751F;&#x6210;&#x3002; &#x6267;&#x884C;configure&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;objs&#x7684;&#x4E2D;&#x95F4;&#x76EE;&#x5F55;&#x3002;</p>
<p>&#x968F;&#x540E;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF1A;<code>make</code> &#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x662F;&#x6839;&#x636E;configure&#x547D;&#x4EE4;&#x751F;&#x6210;&#x7684;Makefile&#x6587;&#x4EF6;&#x7F16;&#x8BD1;Nginx&#x5DE5;&#x7A0B;&#xFF0C;&#x5E76;&#x751F;&#x6210;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x3001;&#x6700;&#x7EC8;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF1A;<code>make install</code> make install&#x547D;&#x4EE4;&#x5C06;Nginx&#x90E8;&#x7F72;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#xFF0C;&#x5982;&#x679C;&#x6267;&#x884C;configure&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x6307;&#x5B9A;Nginx&#x7684;&#x90E8;&#x7F72;&#x76EE;&#x5F55;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x4F1A;&#x9ED8;&#x8BA4;&#x7684;&#x90E8;&#x7F72;&#x5728;<code>/usr/local/nginx</code>&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x3002; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>--prefix=PATH</code>&#xFF0C;&#x6307;&#x5B9A;Nginx&#x5B89;&#x88C5;&#x90E8;&#x7F72;&#x540E;&#x7684;&#x76EE;&#x5F55;&#x4F4D;&#x7F6E;&#x3002;</p>
<p>&#x5982;&#x4F55;&#x542F;&#x52A8;Nginx&#xFF1A; &#x8FDB;&#x5165;&#x90E8;&#x7F72;&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x6267;&#x884C;<code>sbin/nginx</code>&#xFF0C;&#x5373;&#x53EF;&#x542F;&#x52A8;Nginx&#xFF1A; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/3e5778ab0cb218a09bba1de4fb4dfa8d4ca1fc8d3b622b9d77293cfa7266f55d" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x505C;&#x6B62;Nginx&#x547D;&#x4EE4;&#xFF1A;<code>sbin/nginx -s stop</code> &#x91CD;&#x542F;Nginx&#x547D;&#x4EE4;&#xFF1A;<code>sbin/nginx -s reload</code></p>
<h2 id="&#x7B80;&#x5355;&#x539F;&#x7406;&#x4ECB;&#x7ECD;"><a href="#&#x7B80;&#x5355;&#x539F;&#x7406;&#x4ECB;&#x7ECD;" class="headerlink" title="&#x7B80;&#x5355;&#x539F;&#x7406;&#x4ECB;&#x7ECD;"></a>&#x7B80;&#x5355;&#x539F;&#x7406;&#x4ECB;&#x7ECD;</h2><p>&#x5728;&#x5B89;&#x88C5;&#x6B65;&#x9AA4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5F53;Nginx&#x88AB;&#x542F;&#x52A8;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x663E;&#x793A;&#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;&#x4E00;&#x4E2A;&#x662F;master&#xFF0C;&#x4E00;&#x4E2A;&#x662F;worker&#x3002;&#x9ED8;&#x8BA4;worker&#x662F;&#x4E00;&#x4E2A;&#xFF0C;worker&#x6570;&#x91CF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;</p>
<p>Nginx&#x662F;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;master&#x8FDB;&#x7A0B;&#x6765;&#x7BA1;&#x7406;&#x591A;&#x4E2A;worker&#x8FDB;&#x7A0B;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C; worker&#x8FDB;&#x7A0B;&#x7684;&#x6570;&#x91CF;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;CPU&#x6570;&#x91CF;&#x76F8;&#x7B49;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;Nginx&#x4E2D;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x5C31;&#x662F;worker&#x8FDB;&#x7A0B;&#xFF0C;&#x800C;master&#x53EA;&#x662F;&#x8D1F;&#x8D23;&#x76D1;&#x63A7;&#x548C;&#x7BA1;&#x7406;worker&#x8FDB;&#x7A0B;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/78ac8e7b04a1f9a432d5f83b8c5e50789f60a0b00114cd8fbefd2559391f3cde" alt="Nginx&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x5173;&#x7CFB;"></p>
<h2 id="&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;"><a href="#&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;" class="headerlink" title="&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;"></a>&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;</h2><p>Nginx&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x9759;&#x6001;&#x6587;&#x4EF6;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x72EC;&#x7ACB;&#x8BBF;&#x95EE;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x901A;&#x8FC7;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53BB;&#x8BBF;&#x95EE;&#x6211;&#x4EEC;&#x7684;&#x9759;&#x6001;&#x8D44;&#x6E90;&#xFF0C;&#x4F8B;&#x5982;&#x56FE;&#x7247;&#xFF0C;pdf&#x6587;&#x4EF6;&#x554A;&#x53C8;&#x6216;&#x8005;&#x8BF4;&#x6211;&#x4EEC;&#x7684;&#x524D;&#x7AEF;&#x4EE3;&#x7801;&#x554A;&#xFF08;&#x524D;&#x540E;&#x7AEF;&#x5206;&#x79BB;&#x9879;&#x76EE;&#xFF09;&#x3002;</p>
<p>&#x6211;&#x662F;&#x6709;&#x9047;&#x5230;&#x8FC7;&#x4E00;&#x4E9B;&#x8001;&#x65E7;&#x7684;&#x9879;&#x76EE;&#xFF0C;&#x8BF7;&#x6C42;&#x9759;&#x6001;&#x6587;&#x4EF6;&#x90FD;&#x662F;&#x9700;&#x8981;&#x901A;&#x8FC7;java&#x63A5;&#x53E3;&#x53BB;&#x8BF7;&#x6C42;&#x7684;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x4E0D;&#x4EC5;&#x4EC5;&#x4F1A;&#x5BFC;&#x81F4;&#x5B89;&#x5168;&#x6027;&#x7684;&#x964D;&#x4F4E;&#xFF08;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6302;&#x4E86;&#xFF0C;&#x6216;&#x8005;&#x91CD;&#x65B0;&#x53D1;&#x5E03;&#x4E86;&#xFF0C;&#x9759;&#x6001;&#x8D44;&#x6E90;&#x90FD;&#x4F1A;&#x8BBF;&#x95EE;&#x4E0D;&#x4E86;&#xFF09;&#xFF0C;&#x8FD8;&#x4F1A;&#x5F88;&#x5927;&#x7A0B;&#x5EA6;&#x5F71;&#x54CD;&#x6211;&#x4EEC;&#x7684;&#x8BBF;&#x95EE;&#x6548;&#x7387;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x7684;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#xFF0C;&#x6765;&#x9009;&#x62E9;&#x4F7F;&#x7528;Nginx&#x4F5C;&#x4E3A;&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;&#x5462;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x5BF9;<code>nginx.conf</code>&#x6587;&#x4EF6;&#x7684;<code>http&#x5757;</code>&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;</span><br><span class="line">worker_processes  1;    #worker&#x8FDB;&#x7A0B;&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1</span><br><span class="line"> </span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024; #&#x6BCF;&#x4E2A;worker&#x8FDB;&#x7A0B;&#x7684;&#x6700;&#x5927;&#x8FDE;&#x63A5;&#x6570;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    include       mime.types; #&#x8BBE;&#x5B9A;mime&#x7C7B;&#x578B;,&#x7C7B;&#x578B;&#x7531;mime.type&#x6587;&#x4EF6;&#x5B9A;&#x4E49;</span><br><span class="line">    default_type  application/octet-stream; </span><br><span class="line"></span><br><span class="line">    sendfile        on; #&#x6307;&#x5B9A;nginx &#x662F;&#x5426;&#x8C03;&#x7528;sendfile &#x51FD;&#x6570;zero copy &#x65B9;&#x5F0F;&#xFF09;&#x6765;&#x8F93;&#x51FA;&#x6587;&#x4EF6;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65; #keepalive&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen       80; 		 #&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;</span><br><span class="line">        server_name  localhost;  #&#x76D1;&#x542C;&#x7684;&#x5730;&#x5740;&#x4FE1;&#x606F;</span><br><span class="line">        location /images/ {      #&#x76D1;&#x542C;&#x5730;&#x5740;&#x4FE1;&#x606F;&#x4E3A;localhost:80/images/* &#x7684;&#x8BF7;&#x6C42;</span><br><span class="line">            root   /usr/local/static;  #&#x5C06;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x8BF7;&#x6C42;&#x8BF7;&#x6C42;&#x5230;&#x771F;&#x5B9E;&#x7684;&#x8D44;&#x6E90;&#x76EE;&#x5F55;&#xFF0C;/usr/local/static/images/*</span><br><span class="line">            autoindex on;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /pdf/ { #&#x5339;&#x914D;&#x8DEF;&#x5F84;&#x4E3A;localhost:80/pdf/*&#x7684;&#x8BF7;&#x6C42;</span><br><span class="line">            root   /usr/local/static;</span><br><span class="line">            autoindex on;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6548;&#x679C;&#xFF1A; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/b3e2d81b83ca7cb4c632b2e0391532591df18f1701fce26f4ba2ac3fc7e00ad5" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/e25f3fafbc5c08c545e733506001fbf2d50766023e5f4cb50b29800718e6a42c" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x5173;&#x4E8E;location&#x5176;&#x4ED6;&#x7684;&#x5339;&#x914D;&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;<br>&#x8BED;&#x6CD5;&#xFF1A;<code>location[=|~|~*|^~|@]/uri/{...}</code></p>
<ul>
<li>location = / #&#x53EA;&#x6709;&#x5F53;&#x7528;&#x6237;&#x8BF7;&#x6C42;&#x662F;/&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x4F7F;&#x7528;&#x8BE5;location&#x4E0B;&#x7684;&#x914D;&#x7F6E;</li>
<li>~ &#x8868;&#x793A;&#x5339;&#x914D;URI&#x7684;&#x65F6;&#x5019;&#x662F;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#x7684;</li>
<li>~* &#x8868;&#x793A;&#x5339;&#x914D;URI&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;</li>
<li>^~ &#x8868;&#x793A;&#x5339;&#x914D;URI&#x7684;&#x65F6;&#x5019;&#x53EA;&#x9700;&#x524D;&#x534A;&#x90E8;&#x5206;&#x4E0E;uri&#x53C2;&#x6570;&#x5339;&#x914D;&#x5373;&#x53EF;&#xFF0C;location ^~ images {} &#xFF0C;&#x4EE5;images&#x5F00;&#x59CB;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x4F1A;&#x5339;&#x914D;&#x4E0A;</li>
<li>@ &#x8868;&#x793A;&#x4EC5;&#x7528;&#x4E8E;Nginx&#x670D;&#x52A1;&#x5185;&#x90E8;&#x8BF7;&#x6C42;&#x4E4B;&#x95F4;&#x7684;&#x91CD;&#x5B9A;&#x5411;&#xFF0C;&#x5E26;&#x6709;@&#x7684;location&#x4E0D;&#x76F4;&#x63A5;&#x5904;&#x7406;&#x7528;&#x6237;&#x8BF7; &#x6C42;</li>
</ul>
<p>location&#x662F;&#x6709;&#x987A;&#x5E8F;&#x7684;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x6709;&#x53EF;&#x80FD;&#x5339;&#x914D;&#x591A;&#x4E2A;location&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#x4F1A; &#x88AB;&#x7B2C;&#x4E00;&#x4E2A;location&#x5904;&#x7406;&#x3002;</p>
<h2 id="&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;"><a href="#&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;" class="headerlink" title="&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;"></a>&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;</h2><p>Nginx&#x9664;&#x4E86;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5F53;&#x505A;&#x9759;&#x6001;&#x8D44;&#x6E90;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x5916;&#xFF0C;&#x8FD8;&#x80FD;&#x591F;&#x7528;&#x6765;&#x4F5C;&#x4E3A;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#x3002;&#x90A3;&#x4E48;&#x5728;&#x8BF4;&#x660E;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x524D;&#xFF0C;&#x5148;&#x6765;&#x7B80;&#x5355;&#x8BF4;&#x4E00;&#x4E0B;&#xFF0C;&#x4EC0;&#x4E48;&#x662F;<code>&#x6B63;&#x5411;&#x4EE3;&#x7406;</code>&#xFF0C;&#x4EC0;&#x4E48;&#x662F;<code>&#x53CD;&#x5411;&#x4EE3;&#x7406;</code>&#x3002;</p>
<p>&#x6240;&#x8C13;&#x6B63;&#x5411;&#x4EE3;&#x7406;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x7F51;&#x7AD9;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x79CD;&#x79CD;&#x539F;&#x56E0;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x8BF7;&#x6C42;&#x65E0;&#x6CD5;&#x76F4;&#x63A5;&#x8BF7;&#x6C42;&#x5230;&#x76EE;&#x6807;&#x670D;&#x52A1;&#x5668;&#x3002;&#x6B64;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x501F;&#x52A9;&#x53E6;&#x4E00;&#x53F0;&#x5728;&#x56FD;&#x5916;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF08;&#x7528;&#x4F5C;&#x4EE3;&#x7406;&#xFF0C;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#xFF09;&#xFF0C;&#x7531;&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x53BB;&#x8BBF;&#x95EE;&#x76EE;&#x6807;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x53EA;&#x9700;&#x8981;&#x8BF7;&#x6C42;&#x8FD9;&#x4E00;&#x53F0;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#x5373;&#x53EF;&#x3002;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF0C;&#x5C31;&#x662F;&#x6B63;&#x5411;&#x4EE3;&#x7406;&#x3002;<strong>&#x6B63;&#x5411;&#x4EE3;&#x7406;&#xFF0C;&#x9690;&#x85CF;&#x4E86;&#x771F;&#x5B9E;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x4FE1;&#x606F;</strong>&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5E76;&#x4E0D;&#x6E05;&#x695A;&#x5B9E;&#x9645;&#x662F;&#x54EA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6765;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x56E0;&#x4E3A;&#x90FD;&#x662F;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#x76F4;&#x63A5;&#x4E0E;&#x670D;&#x52A1;&#x7AEF;&#x8FDB;&#x884C;&#x8BF7;&#x6C42;&#x548C;&#x6570;&#x636E;&#x4EA4;&#x4E92;&#x3002; &#x3010;&#x56FE;&#x7247;&#x6765;&#x6E90;&#x5728;&#x53C2;&#x8003;&#x8D44;&#x6599;&#x3011; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/7ec8eddfbfd94baa736cb84c4b1c9326c508051d26634e65f4292585c9d61209" alt="&#x56FE;&#x7247;&#x6765;&#x6E90;&#x5728;&#x53C2;&#x8003;&#x8D44;&#x6599;"> &#x800C;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#xFF0C;&#x5219;&#x662F;&#x9690;&#x85CF;&#x771F;&#x5B9E;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x5BA2;&#x6237;&#x7AEF;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x767E;&#x5EA6;baidu.com,&#x5B9E;&#x9645;&#x4E0A;baidu.com&#x5BF9;&#x5E94;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x53F0;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5B83;&#x80CC;&#x540E;&#x6709;&#x5927;&#x91CF;&#x7684;&#xFF0C;&#x771F;&#x6B63;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x6765;&#x5BF9;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x548C;&#x54CD;&#x5E94;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x4E0D;&#x77E5;&#x9053;&#x662F;&#x54EA;&#x4E00;&#x53F0;&#x5177;&#x4F53;&#x7684;&#x670D;&#x52A1;&#x5668;&#x63D0;&#x4F9B;&#x7684;&#x670D;&#x52A1;&#x3002;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x5C31;&#x662F;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#xFF0C;<strong>&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x9690;&#x85CF;&#x4E86;&#x771F;&#x5B9E;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x3002;</strong></p>
<p>&#x3010;&#x56FE;&#x7247;&#x6765;&#x6E90;&#x5728;&#x53C2;&#x8003;&#x8D44;&#x6599;&#x3011; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/7c635332de09bb16899933e6f57a3258710d0d6449ac4d4537191083242215d3" alt="&#x56FE;&#x7247;&#x6765;&#x6E90;&#x5728;&#x53C2;&#x8003;&#x8D44;&#x6599;"> &#x6240;&#x4EE5;&#xFF0C;Nginx&#x5728;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x4E2D;&#xFF0C;&#x8D77;&#x5230;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x5145;&#x5F53;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7528;&#x6765;&#x5C06;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x5230;&#x771F;&#x6B63;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;</p>
<p>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;Nginx&#x4E0D;&#x4F1A;&#x7ACB;&#x523B;&#x8F6C;&#x53D1;&#x5230;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x800C;&#x662F;&#x5148;&#x628A;&#x7528;&#x6237;&#x7684;&#x8BF7;&#x6C42;&#x5B8C;&#x6574;&#x5730;&#x63A5;&#x6536;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5411;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#xFF0C;&#x628A;&#x7F13;&#x5B58;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x8F6C;&#x53D1;&#x3002;Nginx&#x8FD9;&#x4E2A;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x4F18;&#x70B9;&#x5728;&#x4E8E;&#xFF0C;&#x964D;&#x4F4E;&#x4E86;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x8D1F;&#x8F7D;&#x538B;&#x529B;&#xFF0C;&#x5C3D;&#x91CF;&#x628A;&#x538B;&#x529B;&#x653E;&#x5728;Nginx&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x7F3A;&#x70B9;&#x5728;&#x4E8E;&#x5EF6;&#x957F;&#x4E86;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x5F00;&#x59CB;&#x914D;&#x7F6E;&#xFF1A; &#x4E8B;&#x524D;&#x51C6;&#x5907;&#xFF1A; &#x56E0;&#x4E3A;&#x8981;&#x6D4B;&#x8BD5;Nginx&#x8F6C;&#x53D1;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x6253;&#x5305;&#x4E86;&#x4E09;&#x4E2A;jar&#x5305;&#xFF0C;&#x5E76;&#x5206;&#x522B;&#x4EE5;8081&#xFF0C;8082&#xFF0C;8083&#x4E09;&#x4E2A;&#x7AEF;&#x53E3;&#x6765;&#x542F;&#x52A8;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/dde15617e448b2bc46578dd976d990a6cb856318b1a6f59485e0b34b74a84e18" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x914D;&#x7F6E;nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;</span><br><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    #</span><br><span class="line">    upstream nginx_demo_colony{</span><br><span class="line">	server yourip:8081;</span><br><span class="line">	server yourip:8082;</span><br><span class="line">	server yourip:8083;	</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  yourip;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line">     </span><br><span class="line">	location /nginxLoadBalanceDemo/{</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">		proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">		proxy_pass http://nginx_demo_colony;   #upstream &#x58F0;&#x540D;&#x7684;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;</span><br><span class="line">	}	</span><br><span class="line">   </span><br><span class="line">	location /images/ {</span><br><span class="line">            root   /usr/local/static;</span><br><span class="line">            autoindex on;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        location /pdf/ {</span><br><span class="line">            root   /usr/local/static;</span><br><span class="line">            autoindex on;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@RestController</span><br><span class="line">@RequestMapping(value = &quot;/nginxLoadBalanceDemo&quot;)</span><br><span class="line">public class HelloWorld {</span><br><span class="line">    @Value(&quot;${server.port}&quot;)</span><br><span class="line">    private String serverPort;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	* &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5E94;&#x7528;&#x7684;&#x7AEF;&#x53E3;&#x53F7;</span><br><span class="line">	*/</span><br><span class="line">    @GetMapping (value = &quot;/getServerPort&quot;)</span><br><span class="line">    public String getServerPort(){</span><br><span class="line">        return this.serverPort;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6548;&#x679C;&#xFF1A; <img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/29023c83e8a0d40f4dfa0f2843642883c539e9b936f571ee17a48e93c571f7c0" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> &#x8FD9;&#x91CC;&#x9ED8;&#x8BA4;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7B97;&#x6CD5;&#x662F;&#x8F6E;&#x8BE2;&#x3002; &#x76EE;&#x524D;&#x6682;&#x65F6;&#x5230;&#x8FD9;&#x5427;&#xFF0C;&#x672A;&#x6765;&#x8C01;&#x8BF4;&#x5F97;&#x51C6;&#xFF0C;&#x4E5F;&#x8BB8;&#x6211;&#x8FD8;&#x4F1A;&#x56DE;&#x6765;&#x5B8C;&#x5584;&#xFF0C;&#x6709;&#x7F18;&#x518D;&#x89C1;&#x3002;</p>
<h2 id="&#x53C2;&#x8003;&#x8D44;&#x6599;"><a href="#&#x53C2;&#x8003;&#x8D44;&#x6599;" class="headerlink" title="&#x53C2;&#x8003;&#x8D44;&#x6599;"></a>&#x53C2;&#x8003;&#x8D44;&#x6599;</h2><ol>
<li><a href="/external_links/2c6bb2a836aa52740d1138e234e7ca19.html" target="blank" rel="noopener">&#x300A;&#x6DF1;&#x5165;&#x7406;&#x89E3;Nginx&#xFF1A;&#x6A21;&#x5757;&#x5F00;&#x53D1;&#x4E0E;&#x67B6;&#x6784;&#x89E3;&#x6790;&#xFF08;&#x7B2C;2&#x7248;&#x300B;&#xFF08;&#x7F51;&#x4E0A;&#x627E;&#x4E0D;&#x5230;&#x514D;&#x8D39;&#x7684;&#x5C31;&#x53BB;&#x4E70;&#xFF0C;&#x4E0D;&#x4E22;&#x4EBA;&#xFF09;</a></li>
<li><a href="/external_links/ab6ea64bc1ae7e6f12b8e48dd9c0d7e0.html" target="blank" rel="noopener">Nginx&#x5B9E;&#x6218;&#xFF08;&#x5171;&#x5341;&#x4E00;&#x7AE0;&#xFF09;&#x603B;&#x8FF0;&amp;&#x6C47;&#x603B;</a></li>
<li><a href="/external_links/cb469ea325133eaf43c8e7724c44648b.html" target="blank" rel="noopener">&#x6B63;&#x5411;&#x4EE3;&#x7406;&#x4E0E;&#x53CD;&#x5411;&#x4EE3;&#x7406;</a></li>
</ol>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2d3e6dea50960adda15d268069529115.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014881775507734536.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014881775507734536.html" itemprop="url">一劳永逸的优化！并发RPC调用小工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-04T00:49:16+08:00">
                2021-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</p>
<p>&#x672C;&#x6587;&#x5DF2;&#x53C2;&#x4E0E; <a href="https://dev.newban.cn/7012210233804079141">&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;</a> &#xFF0C;&#x8D62;&#x53D6;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;&#xFF0C;&#x6311;&#x6218;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x3002;</p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x7CFB;&#x7EDF;&#x7684;&#x6027;&#x80FD;&#x4F18;&#x5316;&#x662F;&#x6BCF;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x5458;&#x7684;&#x5FC5;&#x7ECF;&#x4E4B;&#x8DEF;&#xFF0C;&#x4F46;&#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x8D70;&#x8FC7;&#x7684;&#x6700;&#x6DF1;&#x7684;&#x5957;&#x8DEF;&#x3002;&#x5B83;&#x4E0D;&#x4EC5;&#x9700;&#x8981;&#x5BF9;&#x5404;&#x79CD;&#x5DE5;&#x5177;&#x7684;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#xFF0C;&#x6709;&#x65F6;&#x8FD8;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x5177;&#x4F53;&#x7684;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x5F97;&#x51FA;&#x5B9A;&#x5236;&#x5316;&#x7684;&#x4F18;&#x5316;&#x65B9;&#x6848;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x6084;&#x6084;&#x85CF;&#x4E0A;&#x4E00;&#x4E2A;Thread.sleep&#xFF0C;&#x5728;&#x9700;&#x8981;&#x4F18;&#x5316;&#x7684;&#x65F6;&#x5019;&#x5C11;&#x7761;&#x51E0;&#x6BEB;&#x79D2;&#xFF08;&#x624B;&#x52A8;&#x72D7;&#x5934;&#xFF09;&#x3002;&#x6027;&#x80FD;&#x4F18;&#x5316;&#x8FD9;&#x4E2A;&#x8BFE;&#x9898;&#x5B9E;&#x5728;&#x662F;&#x592A;&#x6D69;&#x701A;&#x4E86;&#xFF0C;&#x4EE5;&#x81F3;&#x4E8E;&#x76EE;&#x524D;&#x5E02;&#x9762;&#x4E0A;&#x6CA1;&#x6709;&#x4E00;&#x672C;&#x4F18;&#x8D28;&#x7684;&#x4E66;&#x80FD;&#x591F;&#x5168;&#x9762;&#x7684;&#x603B;&#x7ED3;&#x8FD9;&#x4E2A;&#x8BFE;&#x9898;&#x3002;&#x4E0D;&#x4EC5;&#x5982;&#x6B64;&#xFF0C;&#x5373;&#x4F7F;&#x662F;&#x6DF1;&#x5165;&#x5230;&#x5404;&#x4E2A;&#x7EC6;&#x5206;&#x9886;&#x57DF;&#x4E0A;&#xFF0C;&#x6027;&#x80FD;&#x4F18;&#x5316;&#x7684;&#x624B;&#x6BB5;&#x4E5F;&#x975E;&#x5E38;&#x4E30;&#x5BCC;&#xFF0C;&#x4EE4;&#x4EBA;&#x773C;&#x82B1;&#x7F2D;&#x4E71;&#x3002;</p>
<p>&#x672C;&#x6587;&#x4E5F;&#x4E0D;&#x4F1A;&#x6DB5;&#x76D6;&#x6240;&#x6709;&#x7684;&#x4F18;&#x5316;&#x5957;&#x8DEF;&#xFF0C;&#x4EC5;&#x5C31;&#x6700;&#x8FD1;&#x9879;&#x76EE;&#x5F00;&#x53D1;&#x8FC7;&#x7A0B;&#x4E2D;&#x9047;&#x5230;&#x7684;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x8FD9;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#x7ED9;&#x51FA;&#x81EA;&#x5DF1;&#x7684;&#x901A;&#x7528;&#x65B9;&#x6848;&#x3002;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x6253;&#x5305;&#x6216;&#x662F;&#x590D;&#x5236;&#x7C98;&#x8D34;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;&#x3002;&#x4E5F;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x7ED9;&#x51FA;&#x66F4;&#x591A;&#x7684;&#x610F;&#x89C1;&#x8FD8;&#x6709;&#x4F18;&#x5316;&#x573A;&#x666F;&#x3002;</p>
<h2 id="&#x80CC;&#x666F;"><a href="#&#x80CC;&#x666F;" class="headerlink" title="&#x80CC;&#x666F;"></a>&#x80CC;&#x666F;</h2><p>&#x4E0D;&#x77E5;&#x5927;&#x5BB6;&#x5728;&#x5F00;&#x53D1;&#x8FC7;&#x7A0B;&#x4E2D;&#x662F;&#x5426;&#x9047;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5148;&#x53BB;&#x8C03;&#x7528;&#x670D;&#x52A1;A&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x670D;&#x52A1;B&#xFF0C;&#x7EC4;&#x88C5;&#x4E00;&#x4E0B;&#x6570;&#x636E;&#x4E4B;&#x540E;&#x518D;&#x53BB;&#x8C03;&#x7528;&#x4E00;&#x4E0B;&#x670D;&#x52A1;C&#xFF08;&#x5982;&#x679C;&#x4F60;&#x5728;&#x5FAE;&#x670D;&#x52A1;&#x7CFB;&#x7EDF;&#x7684;&#x5F00;&#x53D1;&#x4E2D;&#x6CA1;&#x6709;&#x9047;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x6211;&#x60F3;&#x8BF4;&#xFF0C;&#x8981;&#x4E48;&#x4F60;&#x4EEC;&#x7CFB;&#x7EDF;&#x7684;&#x62C6;&#x5206;&#x7C92;&#x5EA6;&#x592A;&#x7C97;&#xFF0C;&#x8981;&#x4E48;&#x8FD9;&#x4E00;&#x4E2A;&#x5E78;&#x8FD0;&#x65E0;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x4F9D;&#x8D56;&#x7684;&#x5E95;&#x5C42;&#x7CFB;&#x7EDF;~&#xFF09;</p>
<p>&#x8FD9;&#x6761;&#x94FE;&#x8DEF;&#x7684;&#x8017;&#x65F6;&#x5C31;&#x662F; <strong>duration(A) + duration(B) + duration(C) + &#x5176;&#x5B83;&#x64CD;&#x4F5C;</strong>&#x3002;&#x4ECE;&#x7ECF;&#x9A8C;&#x6765;&#x770B;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x7684;&#x8017;&#x65F6;&#x90FD;&#x6765;&#x81EA;&#x4E8E;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x7684;&#x5904;&#x7406;&#x8017;&#x65F6;&#x548C;&#x7F51;&#x7EDC;IO&#xFF0C;&#x5E94;&#x7528;&#x5185;&#x90E8;&#x7684;CPU&#x64CD;&#x4F5C;&#x7684;&#x8017;&#x65F6;&#x76F8;&#x6BD4;&#x800C;&#x8A00;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#x4E0D;&#x8BA1;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x5F97;&#x77E5;&#x5BF9;&#x670D;&#x52A1;A&#x548C;B&#x7684;&#x8C03;&#x7528;&#x4E4B;&#x95F4;&#x662F;&#x65E0;&#x4F9D;&#x8D56;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x540C;&#x65F6;&#x5E76;&#x53D1;&#x8C03;&#x7528;A&#x548C;B&#x6765;&#x51CF;&#x5C11;&#x540C;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x7B49;&#x5F85;&#x8017;&#x65F6;&#xFF0C;&#x8FD9;&#x6837;&#x7406;&#x60F3;&#x60C5;&#x51B5;&#x4E0B;&#x94FE;&#x8DEF;&#x7684;&#x8017;&#x65F6;&#x5C31;&#x53EF;&#x4EE5;&#x4F18;&#x5316;&#x6210; <strong>max(duration(A),duration(B)) + duration(C) + &#x5176;&#x5B83;&#x64CD;&#x4F5C;</strong></p>
<p>&#x518D;&#x4E3E;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6709;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x6279;&#x91CF;&#x8C03;&#x7528;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#xFF0C;&#x6BD4;&#x5982;&#x6279;&#x91CF;&#x67E5;&#x8BE2;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x4E0B;&#x6E38;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;&#x51FA;&#x4E8E;&#x670D;&#x52A1;&#x4FDD;&#x62A4;&#x5F80;&#x5F80;&#x4F1A;&#x5BF9;&#x5355;&#x6B21;&#x53EF;&#x4EE5;&#x67E5;&#x8BE2;&#x7684;&#x6570;&#x91CF;&#x8FDB;&#x884C;&#x7EA6;&#x675F;&#xFF0C;&#x6BD4;&#x5982;&#x4E00;&#x6B21;&#x53EA;&#x80FD;&#x67E5;&#x4E00;&#x767E;&#x6761;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x591A;&#x8BF7;&#x6C42;&#x62C6;&#x5206;&#x591A;&#x6B21;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#xFF0C;&#x4E8E;&#x662F;&#x8017;&#x65F6;&#x53D8;&#x6210;&#x4E86; <strong>n*duration(A) + &#x5176;&#x5B83;&#x64CD;&#x4F5C;</strong>&#x3002;&#x540C;&#x6837;&#xFF0C;&#x7528;&#x5E76;&#x53D1;&#x8BF7;&#x6C42;&#x7684;&#x4F18;&#x5316;&#x65B9;&#x5F0F;&#xFF0C;&#x7406;&#x60F3;&#x60C5;&#x51B5;&#x4E0B;&#x8017;&#x65F6;&#x53EF;&#x4EE5;&#x964D;&#x5230; <strong>max(duration(A)) + &#x5176;&#x5B83;&#x64CD;&#x4F5C;</strong></p>
<p>&#x8FD9;&#x4E24;&#x79CD;&#x573A;&#x666F;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x57FA;&#x672C;&#x7C7B;&#x4F3C;&#xFF0C;&#x672C;&#x6587;&#x5C06;&#x4F1A;&#x63D0;&#x4F9B;&#x7B2C;&#x4E8C;&#x79CD;&#x573A;&#x666F;&#x7684;&#x601D;&#x8DEF;&#x548C;&#x5B8C;&#x6574;&#x5B9E;&#x73B0;&#x3002;</p>
<h2 id="&#x5C0F;&#x8BD5;&#x725B;&#x5200;"><a href="#&#x5C0F;&#x8BD5;&#x725B;&#x5200;" class="headerlink" title="&#x5C0F;&#x8BD5;&#x725B;&#x5200;"></a>&#x5C0F;&#x8BD5;&#x725B;&#x5200;</h2><p>&#x5E76;&#x53D1;RPC&#x8C03;&#x7528;&#x7684;&#x6574;&#x4F53;&#x5B9E;&#x73B0;&#x7C7B;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/1deaebf708b850fd6f8db38ac32a33b5870939249fd1db88978354f5f05f0d04" alt="&#x8FDB;&#x9636;&#x7C7B;&#x56FE;.png"></p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6C60;&#x7528;&#x4E8E;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x3002;&#x56E0;&#x4E3A;&#x7A0B;&#x5E8F;&#x4E2D;&#x901A;&#x5E38;&#x8FD8;&#x6709;&#x522B;&#x7684;&#x4F7F;&#x7528;&#x7EBF;&#x7A0B;&#x6C60;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;RPC&#x8C03;&#x7528;&#x80FD;&#x591F;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x4E86;&#x5C01;&#x88C5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Configuration</span><br><span class="line">public class ThreadPoolExecutorFactory {</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private Map&lt;String, AsyncTaskExecutor&gt; executorMap;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * &#x9ED8;&#x8BA4;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">    */</span><br><span class="line">    @Bean(name = ThreadPoolName.DEFAULT_EXECUTOR)</span><br><span class="line">    public AsyncTaskExecutor baseExecutorService() {</span><br><span class="line">        //&#x540E;&#x7EED;&#x652F;&#x6301;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x5B9A;&#x5236;&#x5316;&#x8FD9;&#x90E8;&#x5206;&#x53C2;&#x6570;</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();</span><br><span class="line">        //&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x6C60;&#x53C2;&#x6570;&#x4FE1;&#x606F;</span><br><span class="line">        taskExecutor.setCorePoolSize(10);</span><br><span class="line">        taskExecutor.setMaxPoolSize(50);</span><br><span class="line">        taskExecutor.setQueueCapacity(200);</span><br><span class="line">        taskExecutor.setKeepAliveSeconds(60);</span><br><span class="line">        taskExecutor.setThreadNamePrefix(ThreadPoolName.DEFAULT_EXECUTOR + &quot;--&quot;);</span><br><span class="line">        taskExecutor.setWaitForTasksToCompleteOnShutdown(true);</span><br><span class="line">        taskExecutor.setAwaitTerminationSeconds(60);</span><br><span class="line">        taskExecutor.setDaemon(Boolean.TRUE);</span><br><span class="line">        //&#x4FEE;&#x6539;&#x62D2;&#x7EDD;&#x7B56;&#x7565;&#x4E3A;&#x4F7F;&#x7528;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x6267;&#x884C;</span><br><span class="line">        taskExecutor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">        //&#x521D;&#x59CB;&#x5316;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">        taskExecutor.initialize();</span><br><span class="line"></span><br><span class="line">        return taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * &#x5E76;&#x53D1;&#x8C03;&#x7528;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">    */</span><br><span class="line">    @Bean(name = ThreadPoolName.RPC_EXECUTOR)</span><br><span class="line">    public AsyncTaskExecutor rpcExecutorService() {</span><br><span class="line">        //&#x540E;&#x7EED;&#x652F;&#x6301;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x5B9A;&#x5236;&#x5316;&#x8FD9;&#x90E8;&#x5206;&#x53C2;&#x6570;</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();</span><br><span class="line">        //&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x6C60;&#x53C2;&#x6570;&#x4FE1;&#x606F;</span><br><span class="line">        taskExecutor.setCorePoolSize(20);</span><br><span class="line">        taskExecutor.setMaxPoolSize(100);</span><br><span class="line">        taskExecutor.setQueueCapacity(200);</span><br><span class="line">        taskExecutor.setKeepAliveSeconds(60);</span><br><span class="line">        taskExecutor.setThreadNamePrefix(ThreadPoolName.RPC_EXECUTOR + &quot;--&quot;);</span><br><span class="line">        taskExecutor.setWaitForTasksToCompleteOnShutdown(true);</span><br><span class="line">        taskExecutor.setAwaitTerminationSeconds(60);</span><br><span class="line">        taskExecutor.setDaemon(Boolean.TRUE);</span><br><span class="line">        //&#x4FEE;&#x6539;&#x62D2;&#x7EDD;&#x7B56;&#x7565;&#x4E3A;&#x4F7F;&#x7528;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x6267;&#x884C;</span><br><span class="line">        taskExecutor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">        //&#x521D;&#x59CB;&#x5316;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">        taskExecutor.initialize();</span><br><span class="line"></span><br><span class="line">        return taskExecutor;</span><br><span class="line">    }</span><br><span class="line">    /**</span><br><span class="line">     * &#x6839;&#x636E;&#x7EBF;&#x7A0B;&#x6C60;&#x540D;&#x79F0;&#x83B7;&#x53D6;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">     * &#x82E5;&#x627E;&#x4E0D;&#x5230;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">     * @param name &#x7EBF;&#x7A0B;&#x6C60;&#x540D;&#x79F0;</span><br><span class="line">     * @return &#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">     * @throws RuntimeException &#x82E5;&#x627E;&#x4E0D;&#x5230;&#x8BE5;&#x540D;&#x79F0;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">     */</span><br><span class="line">    public AsyncTaskExecutor fetchAsyncTaskExecutor(String name) {</span><br><span class="line">        AsyncTaskExecutor executor = executorMap.get(name);</span><br><span class="line">        if (executor == null) {</span><br><span class="line">            throw new RuntimeException(&quot;no executor name &quot; + name);</span><br><span class="line">        }</span><br><span class="line">        return executor;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public class ThreadPoolName {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x9ED8;&#x8BA4;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">     */</span><br><span class="line">    public static final String DEFAULT_EXECUTOR = &quot;defaultExecutor&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x5E76;&#x53D1;&#x8C03;&#x7528;&#x4F7F;&#x7528;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;</span><br><span class="line">     */</span><br><span class="line">    public static final String RPC_EXECUTOR = &quot;rpcExecutor&quot;;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x6211;&#x4EEC;&#x58F0;&#x660E;&#x4E86;&#x4E24;&#x4E2A;Spring&#x7684;&#x7EBF;&#x7A0B;&#x6C60;AsyncTaskExecutor&#xFF0C;&#x5206;&#x522B;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#x548C;RPC&#x8C03;&#x7528;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x4EEC;&#x88C5;&#x8F7D;&#x5230;map&#x4E2D;&#x3002;&#x8C03;&#x7528;&#x65B9;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;fetchAsyncTaskExecutor&#x65B9;&#x6CD5;&#x5E76;&#x4F20;&#x5165;&#x7EBF;&#x7A0B;&#x6C60;&#x7684;&#x540D;&#x79F0;&#x6765;&#x6307;&#x5B9A;&#x7EBF;&#x7A0B;&#x6C60;&#x6267;&#x884C;&#x3002;&#x8FD9;&#x91CC;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x7EC6;&#x8282;&#xFF0C;Rpc&#x7EBF;&#x7A0B;&#x6C60;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#x8981;&#x663E;&#x8457;&#x5927;&#x4E8E;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;Rpc&#x8C03;&#x7528;&#x4E0D;&#x662F;CPU&#x5BC6;&#x96C6;&#x578B;&#x903B;&#x8F91;&#xFF0C;&#x5F80;&#x5F80;&#x4F34;&#x968F;&#x7740;&#x5927;&#x91CF;&#x7684;&#x7B49;&#x5F85;&#x3002;&#x56E0;&#x6B64;&#x589E;&#x52A0;&#x7EBF;&#x7A0B;&#x6570;&#x91CF;&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x63D0;&#x9AD8;&#x5E76;&#x53D1;&#x6548;&#x7387;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Component</span><br><span class="line">public class TracedExecutorService {</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private ThreadPoolExecutorFactory threadPoolExecutorFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x6307;&#x5B9A;&#x7EBF;&#x7A0B;&#x6C60;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x4EFB;&#x52A1;&#x4E0A;&#x4E0B;&#x6587;</span><br><span class="line">     * @param executorName &#x7EBF;&#x7A0B;&#x6C60;&#x540D;&#x79F0;</span><br><span class="line">     * @param tracedCallable &#x5F02;&#x6B65;&#x4EFB;&#x52A1;</span><br><span class="line">     * @param &lt;T&gt; &#x8FD4;&#x56DE;&#x7C7B;&#x578B;</span><br><span class="line">     * @return &#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;</span><br><span class="line">     */</span><br><span class="line">    public &lt;T&gt; Future&lt;T&gt; submit(String executorName, Callable&lt;T&gt; tracedCallable) {</span><br><span class="line">        return threadPoolExecutorFactory.fetchAsyncTaskExecutor(executorName).submit(tracedCallable);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>submit&#x65B9;&#x6CD5;&#x5C01;&#x88C5;&#x4E86;&#x83B7;&#x53D6;&#x7EBF;&#x7A0B;&#x6C60;&#x548C;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x7684;&#x903B;&#x8F91;&#x3002;&#x8FD9;&#x91CC;&#x91C7;&#x7528;Callable+Future&#x7684;&#x7EC4;&#x5408;&#x6765;&#x83B7;&#x53D6;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;</p>
<p>&#x7EBF;&#x7A0B;&#x6C60;&#x51C6;&#x5907;&#x5C31;&#x7EEA;&#xFF0C;&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#x7528;&#x4E8E;&#x63D0;&#x4EA4;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x670D;&#x52A1;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public interface BatchOperateService {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x5E76;&#x53D1;&#x6279;&#x91CF;&#x64CD;&#x4F5C;</span><br><span class="line">     * @param function &#x6267;&#x884C;&#x7684;&#x903B;&#x8F91;</span><br><span class="line">     * @param requests &#x8BF7;&#x6C42;</span><br><span class="line">     * @param config &#x914D;&#x7F6E;</span><br><span class="line">     * @return &#x5168;&#x90E8;&#x54CD;&#x5E94;</span><br><span class="line">     */</span><br><span class="line">    &lt;T, R&gt; List&lt;R&gt; batchOperate(Function&lt;T, R&gt; function, List&lt;T&gt; requests, BatchOperateConfig config);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">public class BatchOperateConfig {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x8D85;&#x65F6;&#x65F6;&#x95F4;</span><br><span class="line">     */</span><br><span class="line">    private Long timeout;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x5355;&#x4F4D;</span><br><span class="line">     */</span><br><span class="line">    private TimeUnit timeoutUnit;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x662F;&#x5426;&#x9700;&#x8981;&#x5168;&#x90E8;&#x6267;&#x884C;&#x6210;&#x529F;</span><br><span class="line">     */</span><br><span class="line">    private Boolean needAllSuccess;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>batchOperate&#x65B9;&#x6CD5;&#x4E2D;&#x4F20;&#x5165;&#x4E86;function&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x662F;&#x9700;&#x8981;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x7684;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x3002;requests&#x5219;&#x662F;&#x6240;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x4F1A;&#x9012;&#x5F52;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x5E76;&#x63D0;&#x4EA4;&#x5230;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x3002;config&#x5BF9;&#x8C61;&#x5219;&#x53EF;&#x4EE5;&#x5BF9;&#x8FD9;&#x6B21;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x505A;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#xFF0C;&#x6BD4;&#x5982;&#x5E76;&#x53D1;&#x67E5;&#x8BE2;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF0C;&#x4EE5;&#x53CA;&#x5982;&#x679C;&#x90E8;&#x5206;&#x8C03;&#x7528;&#x5F02;&#x5E38;&#x65F6;&#x6574;&#x4E2A;&#x6279;&#x91CF;&#x67E5;&#x8BE2;&#x662F;&#x5426;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E00;&#x770B;&#x5B9E;&#x73B0;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class BatchOperateServiceImpl implements BatchOperateService{</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private TracedExecutorService tracedExecutorService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public &lt;T, R&gt; List&lt;R&gt; batchOperate(Function&lt;T, R&gt; function, List&lt;T&gt; requests, BatchOperateConfig config) {</span><br><span class="line">        log.info(&quot;batchOperate start function:{} request:{} config:{}&quot;, function, JSON.toJSONString(requests), JSON.toJSONString(config));</span><br><span class="line"></span><br><span class="line">        // &#x5F53;&#x524D;&#x65F6;&#x95F4;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        // &#x521D;&#x59CB;&#x5316;</span><br><span class="line">        int numberOfRequests = CollectionUtils.size(requests);</span><br><span class="line"></span><br><span class="line">        // &#x6240;&#x6709;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x7ED3;&#x679C;</span><br><span class="line">        List&lt;Future&lt;R&gt;&gt; futures = Lists.newArrayListWithExpectedSize(numberOfRequests);</span><br><span class="line">        // &#x4F7F;&#x7528;countDownLatch&#x8FDB;&#x884C;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x7BA1;&#x7406;</span><br><span class="line">        CountDownLatch countDownLatch = new CountDownLatch(numberOfRequests);</span><br><span class="line">        List&lt;BatchOperateCallable&lt;T, R&gt;&gt; callables = Lists.newArrayListWithExpectedSize(numberOfRequests);</span><br><span class="line"></span><br><span class="line">        // &#x5206;&#x522B;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x6267;&#x884C;</span><br><span class="line">        for (T request : requests) {</span><br><span class="line">            BatchOperateCallable&lt;T, R&gt; batchOperateCallable = new BatchOperateCallable&lt;&gt;(countDownLatch, function, request);</span><br><span class="line">            callables.add(batchOperateCallable);</span><br><span class="line"></span><br><span class="line">            // &#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x6267;&#x884C;</span><br><span class="line">            Future&lt;R&gt; future = tracedExecutorService.submit(ThreadPoolName.RPC_EXECUTOR, batchOperateCallable);</span><br><span class="line">            futures.add(future);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        try {</span><br><span class="line">            // &#x7B49;&#x5F85;&#x5168;&#x90E8;&#x6267;&#x884C;&#x5B8C;&#x6210;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x65F6;&#x4E14;&#x8981;&#x6C42;&#x5168;&#x90E8;&#x8C03;&#x7528;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">            boolean allFinish = countDownLatch.await(config.getTimeout(), config.getTimeoutUnit());</span><br><span class="line">            if (!allFinish &amp;&amp; config.getNeedAllSuccess()) {</span><br><span class="line">                throw new RuntimeException(&quot;batchOperate timeout and need all success&quot;);</span><br><span class="line">            }</span><br><span class="line">            // &#x904D;&#x5386;&#x6267;&#x884C;&#x7ED3;&#x679C;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7684;&#x6267;&#x884C;&#x5931;&#x8D25;&#x4E14;&#x8981;&#x6C42;&#x5168;&#x90E8;&#x8C03;&#x7528;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">            boolean allSuccess = callables.stream().map(BatchOperateCallable::isSuccess).allMatch(BooleanUtils::isTrue);</span><br><span class="line">            if (!allSuccess &amp;&amp; config.getNeedAllSuccess()) {</span><br><span class="line">                throw new RuntimeException(&quot;some batchOperate have failed and need all success&quot;);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            // &#x83B7;&#x53D6;&#x6240;&#x6709;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7ED3;&#x679C;&#x5E76;&#x8FD4;&#x56DE;</span><br><span class="line">            List&lt;R&gt; result = Lists.newArrayList();</span><br><span class="line">            for (Future&lt;R&gt; future : futures) {</span><br><span class="line">                R r = future.get();</span><br><span class="line">                if (Objects.nonNull(r)) {</span><br><span class="line">                    result.add(r);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            return result;</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new RuntimeException(e.getMessage());</span><br><span class="line">        } finally {</span><br><span class="line">            double duration = (System.currentTimeMillis() - startTime) / 1000.0;</span><br><span class="line">            log.info(&quot;batchOperate finish duration:{}s function:{} request:{} config:{}&quot;, duration, function, JSON.toJSONString(requests), JSON.toJSONString(config));</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x5E38;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x7ED9;&#x7EBF;&#x7A0B;&#x6C60;&#x540E;&#x76F4;&#x63A5;&#x904D;&#x5386;Future&#x5E76;&#x7B49;&#x5F85;&#x83B7;&#x53D6;&#x7ED3;&#x679C;&#x5C31;&#x597D;&#x4E86;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7528;CountDownLatch&#x6765;&#x505A;&#x66F4;&#x52A0;&#x7EDF;&#x4E00;&#x7684;&#x8D85;&#x65F6;&#x7BA1;&#x7406;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x4E00;&#x4E0B;BatchOperateCallable&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class BatchOperateCallable&lt;T, R&gt; implements Callable&lt;R&gt; {</span><br><span class="line"></span><br><span class="line">    private final CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">    private final Function&lt;T, R&gt; function;</span><br><span class="line"></span><br><span class="line">    private final T request;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x8BE5;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x662F;&#x5426;&#x6210;&#x529F;</span><br><span class="line">     */</span><br><span class="line">    private boolean success;</span><br><span class="line"></span><br><span class="line">    public BatchOperateCallable(CountDownLatch countDownLatch, Function&lt;T, R&gt; function, T request) {</span><br><span class="line">        this.countDownLatch = countDownLatch;</span><br><span class="line">        this.function = function;</span><br><span class="line">        this.request = request;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public R call() {</span><br><span class="line">        try {</span><br><span class="line">            success = false;</span><br><span class="line">            R result = function.apply(request);</span><br><span class="line">            success = true;</span><br><span class="line">            return result;</span><br><span class="line">        } finally {</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public boolean isSuccess() {</span><br><span class="line">        return success;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x65E0;&#x8BBA;&#x8C03;&#x7528;&#x65F6;&#x6210;&#x529F;&#x8FD8;&#x662F;&#x5F02;&#x5E38;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x4F1A;&#x5728;&#x7ED3;&#x675F;&#x540E;&#x5C06;&#x8BA1;&#x6570;&#x5668;&#x51CF;&#x4E00;&#x3002;&#x5F53;&#x8BA1;&#x6570;&#x5668;&#x88AB;&#x51CF;&#x5230;0&#x65F6;&#xFF0C;&#x5219;&#x4EE3;&#x8868;&#x6240;&#x6709;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x3002;&#x5426;&#x5219;&#x5982;&#x679C;&#x5728;&#x89C4;&#x5B9A;&#x65F6;&#x95F4;&#x5185;&#x8BA1;&#x6570;&#x5668;&#x6CA1;&#x6709;&#x5F52;&#x96F6;&#xFF0C;&#x5219;&#x4EE3;&#x8868;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x8D85;&#x65F6;&#xFF0C;&#x6B64;&#x65F6;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;</p>
<h2 id="&#x6F5C;&#x5728;&#x95EE;&#x9898;"><a href="#&#x6F5C;&#x5728;&#x95EE;&#x9898;" class="headerlink" title="&#x6F5C;&#x5728;&#x95EE;&#x9898;"></a>&#x6F5C;&#x5728;&#x95EE;&#x9898;</h2><p>&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x5728;&#x4E8E;&#x6211;&#x4EEC;&#x653E;&#x5927;&#x4E86;&#x8BBF;&#x95EE;&#x4E0B;&#x6E38;&#x63A5;&#x53E3;&#x7684;&#x6D41;&#x91CF;&#xFF0C;&#x6781;&#x7AEF;&#x60C5;&#x51B5;&#x4E0B;&#x751A;&#x81F3;&#x653E;&#x5927;&#x4E86;&#x6210;&#x767E;&#x4E0A;&#x5343;&#x500D;&#x3002;&#x5982;&#x679C;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x5E76;&#x6CA1;&#x6709;&#x505A;&#x9650;&#x6D41;&#x7B49;&#x9632;&#x5FA1;&#x6027;&#x63AA;&#x65BD;&#xFF0C;&#x6211;&#x4EEC;&#x6781;&#x6709;&#x53EF;&#x80FD;&#x5C06;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x6253;&#x6302;&#xFF08;&#x8FD9;&#x79CD;&#x539F;&#x56E0;&#x5BFC;&#x81F4;&#x7684;&#x6545;&#x969C;&#x5C61;&#x89C1;&#x4E0D;&#x9C9C;&#xFF09;&#x3002;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5BF9;&#x6574;&#x4E2A;&#x5E76;&#x53D1;&#x8C03;&#x7528;&#x505A;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x3002;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x4E24;&#x79CD;&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x5982;&#x679C;&#x5FAE;&#x670D;&#x52A1;&#x91C7;&#x7528;mesh&#x7684;&#x6A21;&#x5F0F;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5728;sidecar&#x4E2D;&#x914D;&#x7F6E;RPC&#x8C03;&#x7528;&#x7684;QPS&#xFF0C;&#x4ECE;&#x800C;&#x505A;&#x5230;&#x5168;&#x5C40;&#x7684;&#x7BA1;&#x63A7;&#x5BF9;&#x4E0B;&#x6E38;&#x670D;&#x52A1;&#x7684;&#x8BBF;&#x95EE;&#xFF08;&#x8FD9;&#x91CC;&#x9009;&#x62E9;&#x5355;&#x673A;&#x9650;&#x6D41;&#x8FD8;&#x662F;&#x96C6;&#x7FA4;&#x9650;&#x6D41;&#x53D6;&#x51B3;&#x4E8E;sidecar&#x662F;&#x5426;&#x652F;&#x6301;&#x7684;&#x6A21;&#x5F0F;&#x4EE5;&#x53CA;&#x670D;&#x52A1;&#x7684;&#x6D41;&#x91CF;&#x5927;&#x5C0F;&#x3002;&#x901A;&#x5E38;&#x6765;&#x8BF4;&#x5E73;&#x5747;&#x6D41;&#x91CF;&#x8F83;&#x5C0F;&#x5219;&#x5EFA;&#x8BAE;&#x9009;&#x62E9;&#x5355;&#x673A;&#x9650;&#x6D41;&#xFF0C;&#x56E0;&#x4E3A;&#x96C6;&#x7FA4;&#x9650;&#x6D41;&#x7684;&#x6CE2;&#x52A8;&#x6027;&#x5F80;&#x5F80;&#x6BD4;&#x5355;&#x673A;&#x9650;&#x6D41;&#x8981;&#x9AD8;&#xFF0C;&#x6D41;&#x91CF;&#x8FC7;&#x5C0F;&#x4F1A;&#x9020;&#x6210;&#x8BEF;&#x5224;&#xFF09;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5F00;&#x542F;mesh&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x9650;&#x6D41;&#x5668;&#xFF0C;&#x8FD9;&#x91CC;&#x63A8;&#x8350;Guava&#x7684;RateLimiter&#x7C7B;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x53EA;&#x652F;&#x6301;&#x5355;&#x673A;&#x9650;&#x6D41;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x60F3;&#x5B9E;&#x73B0;&#x96C6;&#x7FA4;&#x9650;&#x6D41;&#xFF0C;&#x5219;&#x65B9;&#x6848;&#x7684;&#x590D;&#x6742;&#x5EA6;&#x8FD8;&#x4F1A;&#x8FDB;&#x4E00;&#x6B65;&#x63D0;&#x5347;</p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x5C06;&#x9879;&#x76EE;&#x5F00;&#x53D1;&#x4E2D;&#x9047;&#x5230;&#x7684;&#x573A;&#x666F;&#x8FDB;&#x884C;&#x62BD;&#x8C61;&#x5E76;&#x5C3D;&#x53EF;&#x80FD;&#x7684;&#x7ED9;&#x51FA;&#x901A;&#x7528;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x6211;&#x4EEC;&#x6BCF;&#x4E00;&#x4E2A;&#x5F00;&#x53D1;&#x8005;&#x81EA;&#x6211;&#x7684;&#x91CD;&#x8981;&#x65B9;&#x5F0F;&#xFF0C;&#x4E5F;&#x662F;&#x63D0;&#x9AD8;&#x4EE3;&#x7801;&#x590D;&#x7528;&#x6027;&#x548C;&#x7A33;&#x5B9A;&#x6027;&#x7684;&#x5229;&#x5668;&#x3002;&#x5E76;&#x53D1;Rpc&#x8C03;&#x7528;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x89C1;&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#xFF0C;&#x5E0C;&#x671B;&#x672C;&#x6587;&#x7684;&#x5B9E;&#x73B0;&#x53EF;&#x4EE5;&#x5BF9;&#x4F60;&#x6709;&#x5E2E;&#x52A9;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/c492533649681181387e9bc0430b0540.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014458406312345637.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014458406312345637.html" itemprop="url">Mybatis中#{}和${}的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-02T21:24:17+08:00">
                2021-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</p>
<h3 id="&#x80CC;&#x666F;"><a href="#&#x80CC;&#x666F;" class="headerlink" title="&#x80CC;&#x666F;"></a>&#x80CC;&#x666F;</h3><p>Mybatis&#x4E2D;&#x4F7F;&#x7528;parameterType&#x8FDB;&#x884C;&#x4F20;&#x53C2;&#xFF0C;SQL&#x4E2D;&#x7684;&#x53C2;&#x6570;&#x5360;&#x4F4D;&#x7B26;&#x5219;&#x662F;&#x6709;#{}&#x548C;${}&#x4E24;&#x79CD;&#x5360;&#x4F4D;&#x7B26;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x5427;&#x3002;</p>
<h3 id="&#x77E5;&#x8BC6;&#x70B9;"><a href="#&#x77E5;&#x8BC6;&#x70B9;" class="headerlink" title="&#x77E5;&#x8BC6;&#x70B9;"></a>&#x77E5;&#x8BC6;&#x70B9;</h3><p>#{test1Param}&#xFF1A;#&#x5360;&#x4F4D;&#x7B26;&#x5728;SQL&#x4E2D;&#x586B;&#x5145;&#x65F6;&#x7ECF;&#x8FC7;&#x9884;&#x7F16;&#x8BD1;&#x7684;&#xFF0C;&#x5728;&#x4F7F;&#x7528;#&#x5360;&#x4F4D;&#x7B26;&#x586B;&#x5145;&#x65F6;&#xFF0C;&#x8BBE;&#x7F6E;#{test1Param}&#x4E3A;test&#xFF0C;&#x6267;&#x884C;&#x51FA;&#x6765;&#x662F;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x8FD9;&#x6837;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table_test where name = #{test1Param}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x6267;&#x884C;&#x65F6;&#x4F1A;&#x88AB;mybatis&#x8F6C;&#x6362;&#x6210;&#x5982;&#x4E0B;SQL&#x8BED;&#x53E5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jasqlva&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table_test where name = &apos;test&apos;;</span><br></pre></td></tr></table></figure>

<p>test1Param&#xFF1A;{test1Param}&#xFF1A;test1Param&#xFF1A;&#x5360;&#x4F4D;&#x7B26;&#x5728;SQL&#x4E2D;&#x586B;&#x5145;&#x65F6;&#x662F;&#x6CA1;&#x6709;&#x7ECF;&#x8FC7;&#x9884;&#x7F16;&#x8BD1;&#x7684;&#xFF0C;&#x5728;&#x4F7F;&#x7528;&#x5360;&#x4F4D;&#x7B26;&#x586B;&#x5145;&#x65F6;&#xFF0C;&#x8BBE;&#x7F6E;&#x5360;&#x4F4D;&#x7B26;&#x586B;&#x5145;&#x65F6;&#xFF0C;&#x8BBE;&#x7F6E;&#x5360;&#x4F4D;&#x7B26;&#x586B;&#x5145;&#x65F6;&#xFF0C;&#x8BBE;&#x7F6E;{test1Param}&#x4E3A;test&#xFF0C;&#x6267;&#x884C;&#x51FA;&#x6765;&#x662F;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x8FD9;&#x6837;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table_test where name = ${test1Param}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x6267;&#x884C;&#x65F6;&#x4F1A;&#x88AB;mybatis&#x8F6C;&#x6362;&#x6210;&#x5982;&#x4E0B;SQL&#x8BED;&#x53E5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table_test where name = test;</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;$&#x5360;&#x4F4D;&#x7B26;&#x5C31;&#x5B58;&#x5728;&#x4E86;SQL&#x6CE8;&#x5165;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x5E76;&#x6CA1;&#x6709;&#x7ECF;&#x8FC7;&#x7F16;&#x8BD1;&#xFF0C;&#x5219;&#x4E00;&#x65E6;&#x6267;&#x884C;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5C31;&#x4F1A;&#x76F4;&#x63A5;&#x6267;&#x884C;&#xFF1B;#&#x5360;&#x4F4D;&#x7B26;&#x56E0;&#x4E3A;&#x7ECF;&#x8FC7;&#x4E86;&#x9884;&#x7F16;&#x8BD1;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x5B58;&#x5728;&#x8FD9;&#x79CD;SQL&#x6CE8;&#x5165;&#x7684;&#x95EE;&#x9898;&#x4E86;&#x3002;</p>
<h3 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h3><p>&#x56E0;&#x4E3A;SQL&#x6CE8;&#x5165;&#x7684;&#x98CE;&#x9669;&#x5F88;&#x9AD8;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5728;&#x5F00;&#x53D1;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x662F;&#x4F1A;&#x6781;&#x529B;&#x63A8;&#x8350;&#x4F7F;&#x7528;#&#x5360;&#x4F4D;&#x7B26;&#x7684;&#xFF0C;&#x6BD5;&#x7ADF;&#x5B89;&#x5168;&#x662F;&#x6211;&#x4EEC;&#x5728;&#x5F00;&#x53D1;&#x7CFB;&#x7EDF;&#x65F6;&#x8981;&#x8003;&#x8651;&#x7684;&#x6781;&#x5176;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x70B9;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x603B;&#x4F1A;&#x5B58;&#x5728;&#x4F7F;&#x7528;$&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6BD4;&#x5982;&#x4F20;&#x5165;in&#x7684;&#x503C;&#xFF0C;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table_test where name in (${test1Param});</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x4E0A;&#xFF0C;&#x662F;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x6CE8;&#x5165;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;java&#x4EE3;&#x7801;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x62FC;&#x63A5;&#xFF0C;&#x968F;&#x540E;&#x901A;&#x8FC7;$&#x5360;&#x4F4D;&#x7B26;&#x8FDB;&#x884C;&#x6CE8;&#x5165;&#x64CD;&#x4F5C;&#x5373;&#x53EF;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/faf0f15bae1e4b9c451d5b7c75ef4285.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014408232471003144.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014408232471003144.html" itemprop="url">基于Spring Boot实现电脑端网页微信扫码授权登录方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-02T18:18:36+08:00">
                2021-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x672C;&#x6587;&#x5DF2;&#x53C2;&#x4E0E;&#x300C;<a href="https://dev.newban.cn/7012210233804079141/">&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;</a>&#x300D;&#xFF0C;&#x8D62;&#x53D6;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;&#xFF0C;&#x6311;&#x6218;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x3002;</p>
<h1 id="&#x7B80;&#x4ECB;"><a href="#&#x7B80;&#x4ECB;" class="headerlink" title="&#x7B80;&#x4ECB;"></a>&#x7B80;&#x4ECB;</h1><p>&#x7535;&#x8111;&#x7AEF;&#x5FAE;&#x4FE1;&#x7F51;&#x9875;&#x626B;&#x7801;&#x6388;&#x6743;&#x767B;&#x5F55;&#x6709;2&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ul>
<li><strong>&#x7B2C;&#x4E00;&#x79CD;</strong>&#xFF1A;&#x57FA;&#x4E8E;&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF0C;&#x5355;&#x72EC;&#x83B7;&#x53D6;&#x767B;&#x5F55;&#x4E8C;&#x7EF4;&#x7801;&#x626B;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x626B;&#x7801;&#x767B;&#x5F55;&#xFF0C;&#x7A0B;&#x5E8F;&#x63A7;&#x5236;&#x8DF3;&#x8F6C;&#x903B;&#x8F91;&#xFF0C;<strong>&#x4F8B;&#x5982;CSDN:</strong><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/e5a0b6c954aa936325ef259981c40cb3958aedb8839c3a4aaab6439aaed565f1" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></li>
<li><strong>&#x7B2C;&#x4E8C;&#x79CD;</strong>&#xFF1A;&#x57FA;&#x4E8E;&#x5FAE;&#x4FE1;&#x5F00;&#x653E;&#x5E73;&#x53F0;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x5FAE;&#x4FE1;&#x4E8C;&#x7EF4;&#x7801;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x626B;&#x7801;&#x767B;&#x5F55;&#xFF0C;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6210;&#x529F;&#x9875;&#x9762;,<strong>&#x4F8B;&#x5982;&#x6709;&#x9053;&#x7B14;&#x8BB0;&#xFF1A;</strong><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/ab84ab9edbd3103994d3416da332b807474145b1a58d12c27a53bcbfd2c3e78d" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"><br>&#x6CE8;&#xFF1A; <strong>&#x672C;&#x6587;&#x8BB0;&#x5F55;&#x7B2C;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x53EA;&#x9700;&#x901A;&#x8FC7;&#x5FAE;&#x4FE1;&#x6D4B;&#x8BD5;&#x516C;&#x4F17;&#x53F7;&#x5373;&#x53EF;&#x5B8C;&#x6210;&#x5B8C;&#x6574;&#x6D4B;&#x8BD5;&#xFF0C;&#x5373;&#x6240;&#x6709;&#x4EBA;&#x672C;&#x5730;&#x90FD;&#x53EF;&#x4EE5;&#x5B8C;&#x6574;&#x8FD0;&#x884C;</strong>&#xFF1B;&#x7B2C;&#x4E8C;&#x79CD;&#x9700;&#x6709;&#x901A;&#x8FC7;&#x8BA4;&#x8BC1;&#x8D44;&#x8D28;&#x7684;&#x5F00;&#x53D1;&#x8005;&#x8D26;&#x53F7;&#xFF0C;&#x540E;&#x7EED;&#x518D;&#x8BB0;&#x5F55;&#x3002;</li>
</ul>
<h1 id="&#x672C;&#x5730;&#x5B8C;&#x6574;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x51C6;&#x5907;"><a href="#&#x672C;&#x5730;&#x5B8C;&#x6574;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x51C6;&#x5907;" class="headerlink" title="&#x672C;&#x5730;&#x5B8C;&#x6574;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x51C6;&#x5907;"></a>&#x672C;&#x5730;&#x5B8C;&#x6574;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x51C6;&#x5907;</h1><h2 id="&#x5185;&#x7F51;&#x6E17;&#x900F;-gt-&#x751F;&#x6210;&#x672C;&#x5730;&#x6307;&#x5B9A;&#x7AEF;&#x53E3;&#x6620;&#x5C04;&#x7684;&#x5916;&#x7F51;&#x57DF;&#x540D;"><a href="#&#x5185;&#x7F51;&#x6E17;&#x900F;-gt-&#x751F;&#x6210;&#x672C;&#x5730;&#x6307;&#x5B9A;&#x7AEF;&#x53E3;&#x6620;&#x5C04;&#x7684;&#x5916;&#x7F51;&#x57DF;&#x540D;" class="headerlink" title="&#x5185;&#x7F51;&#x6E17;&#x900F;=&gt;&#x751F;&#x6210;&#x672C;&#x5730;&#x6307;&#x5B9A;&#x7AEF;&#x53E3;&#x6620;&#x5C04;&#x7684;&#x5916;&#x7F51;&#x57DF;&#x540D;"></a>&#x5185;&#x7F51;&#x6E17;&#x900F;=&gt;&#x751F;&#x6210;&#x672C;&#x5730;&#x6307;&#x5B9A;&#x7AEF;&#x53E3;&#x6620;&#x5C04;&#x7684;&#x5916;&#x7F51;&#x57DF;&#x540D;</h2><p><strong>&#x4F20;&#x9001;&#x95E8;&#xFF1A;</strong><a href="/external_links/6a04e43d6f936cef7b51ae5462ad272f.html" target="blank" rel="noopener">&#x5185;&#x7F51;&#x6E17;&#x900F;&#x5DE5;&#x5177;Natapp&#x4F7F;&#x7528;&#x8BE6;&#x89E3;</a><br><strong>&#x57DF;&#x540D;&#x751F;&#x6210;&#x4E4B;&#x540E;&#x4FEE;&#x6539;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF1A;</strong><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/8b52712f29149290937cf3e5a6c81d37b735bb751273c5ad7966211a9f3e7ac4" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<h2 id="&#x6CE8;&#x518C;&#x5E76;&#x914D;&#x7F6E;&#x5FAE;&#x4FE1;&#x6D4B;&#x8BD5;&#x516C;&#x4F17;&#x53F7;"><a href="#&#x6CE8;&#x518C;&#x5E76;&#x914D;&#x7F6E;&#x5FAE;&#x4FE1;&#x6D4B;&#x8BD5;&#x516C;&#x4F17;&#x53F7;" class="headerlink" title="&#x6CE8;&#x518C;&#x5E76;&#x914D;&#x7F6E;&#x5FAE;&#x4FE1;&#x6D4B;&#x8BD5;&#x516C;&#x4F17;&#x53F7;"></a>&#x6CE8;&#x518C;&#x5E76;&#x914D;&#x7F6E;&#x5FAE;&#x4FE1;&#x6D4B;&#x8BD5;&#x516C;&#x4F17;&#x53F7;</h2><ol>
<li>&#x6CE8;&#x518C;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/31a00e8e6723358a08992e5201c93112.html" target="blank" rel="noopener">&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x5E73;&#x53F0; &#x6D4B;&#x8BD5;&#x8D26;&#x53F7;&#x7533;&#x8BF7;</a>&#xFF0C;&#x626B;&#x7801;&#x767B;&#x5F55;&#xFF0C;<strong>&#x5E76;&#x5173;&#x6CE8;&#x8BE5;&#x6D4B;&#x8BD5;&#x53F7;</strong><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/2164414942f9deb377f82bb141a4204ced8bb25f7a1bf53321610a5142666df0" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/083f0b2a48a639b33b6c4a6fb5b043dd53ae5440b0a23e425c683d2c1f87524e" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></li>
<li>&#x83B7;&#x53D6;&#x6D4B;&#x8BD5;&#x53F7;appid&#x548C;appsecret<br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/5a321962ddc2a347ee978e5b7876799e034e414a53ae3dc7c47a344965146030" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></li>
</ol>
<p>3.&#x63A5;&#x53E3;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x4FEE;&#x6539;&#xFF08;<strong>&#x6B64;&#x5904;&#x4F1A;&#x56DE;&#x8C03;&#x540E;&#x53F0;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;&#xFF0C;&#x914D;&#x7F6E;&#x65F6;&#x9700;&#x542F;&#x52A8;&#x540E;&#x53F0;</strong>&#xFF09;<br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/2f7aa13857be3b4c2a4dd2e23b086de65b7c348d00ca49f511177aad209f5f52" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"><br>4.&#x914D;&#x7F6E;&#x7F51;&#x9875;&#x6388;&#x6743;&#x57DF;&#x540D;&#xFF0C;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x7528;&#x6237;&#x4FE1;&#x606F;<br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/0a14b6164170d14a2a758172c7b75d281d89b5c03d127fb3e713b250ce790811" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"><br><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/ccae7be5decb368fb931697f8846f1f5aab6441f50a48747a421ca2658a86533" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<h1 id="&#x6D41;&#x7A0B;"><a href="#&#x6D41;&#x7A0B;" class="headerlink" title="&#x6D41;&#x7A0B;"></a>&#x6D41;&#x7A0B;</h1><h2 id="&#x6587;&#x5B57;&#x7B80;&#x8FF0;"><a href="#&#x6587;&#x5B57;&#x7B80;&#x8FF0;" class="headerlink" title="&#x6587;&#x5B57;&#x7B80;&#x8FF0;"></a>&#x6587;&#x5B57;&#x7B80;&#x8FF0;</h2><ol>
<li>&#x9875;&#x9762;&#x70B9;&#x51FB;&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x767B;&#x5F55;&#x4E8C;&#x7EF4;&#x7801;&#x6309;&#x94AE;</li>
<li>&#x540E;&#x53F0;&#x4EE5;appid&#x548C;appsecret&#x4E3A;&#x53C2;&#x6570;&#x8C03;&#x7528;&#x5FAE;&#x4FE1;api&#x83B7;&#x53D6;access_token</li>
<li>&#x4EE5;access_token&#x4E3A;&#x53C2;&#x6570;&#x8C03;&#x7528;&#x5FAE;&#x4FE1;api&#x83B7;&#x53D6;&#x672C;&#x5730;&#x5FAE;&#x4FE1;&#x767B;&#x5F55;&#x4E8C;&#x7EF4;&#x7801;ticket&#xFF0C;&#x540C;&#x65F6;&#x4F20;&#x968F;&#x673A;&#x5B57;&#x7B26;&#x4E32;&#x53C2;&#x6570;scene_str&#xFF0C;&#x8BE5;&#x53C2;&#x4E0E;&#x53EF;&#x7528;&#x4E8E;&#x7A0B;&#x5E8F;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x626B;&#x7801;&#x6210;&#x529F;</li>
<li>&#x901A;&#x8FC7;ticket&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;&#x6210;&#x529F;&#xFF0C;&#x9875;&#x9762;&#x663E;&#x793A;&#xFF0C;&#x540C;&#x65F6;&#x524D;&#x53F0;&#x5F00;&#x59CB;&#x8FDB;&#x884C;js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF08;<strong>&#x6B64;&#x5904;&#x53EF;&#x4F18;&#x5316;&#x6210;&#x540E;&#x53F0;&#x901A;&#x77E5;</strong>&#xFF09;&#xFF0C;&#x76D1;&#x542C;&#x662F;&#x5426;&#x626B;&#x7801;&#x6210;&#x529F;</li>
<li>&#x7528;&#x6237;&#x5FAE;&#x4FE1;&#x626B;&#x7801;&#x6210;&#x529F;</li>
<li>&#x5FAE;&#x4FE1;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x56DE;&#x8C03;&#x672C;&#x5730;&#x670D;&#x52A1;&#x5668;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x63A5;&#x53E3;&#x9A8C;&#x8BC1;&#x7B7E;&#x540D;&#x548C;&#x56DE;&#x8C03;&#x5904;&#x7406;</li>
<li>&#x56DE;&#x8C03;&#x5904;&#x7406;&#x786E;&#x5B9A;&#x626B;&#x7801;&#x6210;&#x529F;&#xFF08;<strong>&#x6B64;&#x5904;&#x8FD8;&#x53EF;&#x8FDB;&#x884C;&#x5173;&#x6CE8;&#x9A8C;&#x8BC1;</strong>&#xFF09;&#xFF0C;&#x6570;&#x636E;&#x5E93;&#x6216;&#x7F13;&#x5B58;&#x63D2;&#x5165;&#x672C;&#x5730;&#x626B;&#x7801;&#x6210;&#x529F;&#x8BB0;&#x5F55;</li>
<li>&#x524D;&#x53F0;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x83B7;&#x53D6;&#x5230;&#x626B;&#x7801;&#x6210;&#x529F;&#x8BB0;&#x5F55;&#x6216;&#x8005;&#x540E;&#x53F0;&#x4E3B;&#x52A8;&#x901A;&#x77E5;&#xFF0C;&#x8FDB;&#x884C;&#x626B;&#x7801;&#x6210;&#x529F;&#x540E;&#x4E1A;&#x52A1;&#x5904;&#x7406;</li>
</ol>
<h2 id="&#x4EE3;&#x7801;"><a href="#&#x4EE3;&#x7801;" class="headerlink" title="&#x4EE3;&#x7801;"></a>&#x4EE3;&#x7801;</h2><h3 id="1-&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x4E8C;&#x7EF4;&#x7801;&#x548C;&#x542F;&#x52A8;js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;"><a href="#1-&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x4E8C;&#x7EF4;&#x7801;&#x548C;&#x542F;&#x52A8;js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;" class="headerlink" title="1.&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x4E8C;&#x7EF4;&#x7801;&#x548C;&#x542F;&#x52A8;js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;"></a>1.&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x4E8C;&#x7EF4;&#x7801;&#x548C;&#x542F;&#x52A8;js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</h3><p><strong>&#x524D;&#x53F0;html</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">html&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;h1&gt;&#x5FAE;&#x4FE1;&#x626B;&#x7801;&#x767B;&#x5F55;&#x65B9;&#x5F0F;&#x4E00;&lt;/h1&gt;</span><br><span class="line">    &lt;button onclick=&quot;getQrCode()&quot; style=&quot;width: 100px;height: 50px;&quot;&gt;&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;&lt;/button&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;img src=&quot;&quot; id=&quot;qrCodeImgId&quot;  style=&quot;width: 300px;height: 300px;display: none&quot;&gt;</span><br><span class="line">&lt;hr&gt;</span><br></pre></td></tr></table></figure>

<p><strong>&#x524D;&#x53F0;js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;//======================================&#x5FAE;&#x4FE1;&#x626B;&#x7801;&#x767B;&#x5F55;&#x65B9;&#x5F0F;&#x4E00;=========================================================</span><br><span class="line">    // &#x5B58;&#x50A8;&#x4E8C;&#x7EF4;&#x7801;&#x6807;&#x8BC6;,&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x626B;&#x7801;&#x6210;&#x529F;</span><br><span class="line">    var sceneStr;</span><br><span class="line">    var t;</span><br><span class="line">    // &#x83B7;&#x53D6;&#x767B;&#x5F55;&#x4E8C;&#x7EF4;&#x7801;</span><br><span class="line">    function getQrCode(){</span><br><span class="line">        $.get(&apos;qrCodeFirstLogin/getQrCode&apos;,function (data) {</span><br><span class="line">            console.log(&quot;=============getQrCode=======================&quot;);</span><br><span class="line">            console.log(data);</span><br><span class="line">            if(data.code == 200){</span><br><span class="line">                sceneStr = data.data.sceneStr;</span><br><span class="line">                // &#x4E8C;&#x7EF4;&#x7801;&#x83B7;&#x53D6;</span><br><span class="line">                $(&apos;#qrCodeImgId&apos;).attr(&apos;src&apos;,&quot;https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=&quot;+data.data.ticket);</span><br><span class="line">                $(&apos;#qrCodeImgId&apos;).show();</span><br><span class="line">                // &#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x76D1;&#x542C;&#x662F;&#x5426;&#x626B;&#x7801;&#x6210;&#x529F;</span><br><span class="line">                t = window.setInterval(getOpenId,3000);</span><br><span class="line">            }else{</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        });</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p><strong>&#x540E;&#x53F0;&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;ticket&#x63A5;&#x53E3;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    /**</span><br><span class="line">     *  &#x83B7;&#x53D6;accessToken</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String getAccessToken(){</span><br><span class="line">        String accessToken = null;</span><br><span class="line">        String getTokenUrl = wxConfig.getTokenUrl().replace(&quot;APPID&quot;, wxConfig.getAppId()).replace(&quot;SECRET&quot;, wxConfig.getAppSecret());</span><br><span class="line">        String result = HttpClientUtil.doGet(getTokenUrl);</span><br><span class="line">        JSONObject jsonObject = JSONObject.parseObject(result);</span><br><span class="line">        accessToken = jsonObject.getString(&quot;access_token&quot;);</span><br><span class="line">        return accessToken ;</span><br><span class="line">    }</span><br><span class="line">    /**</span><br><span class="line">     *  &#x83B7;&#x53D6;&#x767B;&#x5F55;&#x4E8C;&#x7EF4;&#x7801;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/getQrCode&quot;)</span><br><span class="line">    private ResultJson getQrCode(){</span><br><span class="line">        try {</span><br><span class="line">            // &#x83B7;&#x53D6;token&#x5F00;&#x53D1;&#x8005;</span><br><span class="line">            String accessToken =getAccessToken();</span><br><span class="line">            String getQrCodeUrl = wxConfig.getQrCodeUrl().replace(&quot;TOKEN&quot;, accessToken);</span><br><span class="line">            // &#x8FD9;&#x91CC;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E8C;&#x7EF4;&#x7801;&#xFF0C;&#x53C2;&#x6570;&#x662F;scene_str</span><br><span class="line">            String sceneStr = CodeLoginUtil.getRandomString(8);</span><br><span class="line">            String json=&quot;{\&quot;expire_seconds\&quot;: 604800, \&quot;action_name\&quot;: \&quot;QR_STR_SCENE\&quot;&quot; +&quot;, \&quot;action_info\&quot;: {\&quot;scene\&quot;: {\&quot;scene_str\&quot;: \&quot;&quot;+sceneStr+&quot;\&quot;}}}&quot;;</span><br><span class="line">            String result  = HttpClientUtil.doPostJson(getQrCodeUrl,json);</span><br><span class="line">            JSONObject jsonObject = JSONObject.parseObject(result);</span><br><span class="line">            jsonObject.put(&quot;sceneStr&quot;,sceneStr);</span><br><span class="line">            return ResultJson.ok(jsonObject);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return ResultJson.error(e.getMessage());</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="2-&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x548C;&#x56DE;&#x8C03;&#x5904;&#x7406;"><a href="#2-&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x548C;&#x56DE;&#x8C03;&#x5904;&#x7406;" class="headerlink" title="2.&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x548C;&#x56DE;&#x8C03;&#x5904;&#x7406;"></a>2.&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x548C;&#x56DE;&#x8C03;&#x5904;&#x7406;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line">     *  &#x9A8C;&#x8BC1;&#x7B7E;&#x540D;</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/checkSign&quot;)</span><br><span class="line">    public String checkSign ( HttpServletRequest request) throws Exception {</span><br><span class="line">        log.info(&quot;===========&gt;checkSign&quot;);</span><br><span class="line">        //&#x83B7;&#x53D6;&#x5FAE;&#x4FE1;&#x8BF7;&#x6C42;&#x53C2;&#x6570;</span><br><span class="line">        String signature = request.getParameter (&quot;signature&quot;);</span><br><span class="line">        String timestamp = request.getParameter (&quot;timestamp&quot;);</span><br><span class="line">        String nonce = request.getParameter (&quot;nonce&quot;);</span><br><span class="line">        String echostr = request.getParameter (&quot;echostr&quot;);</span><br><span class="line">        //&#x53C2;&#x6570;&#x6392;&#x5E8F;&#x3002; token &#x5C31;&#x8981;&#x6362;&#x6210;&#x81EA;&#x5DF1;&#x5B9E;&#x9645;&#x5199;&#x7684; token</span><br><span class="line">        String [] params = new String [] {timestamp,nonce,&quot;123456&quot;} ;</span><br><span class="line">        Arrays.sort (params) ;</span><br><span class="line">        //&#x62FC;&#x63A5;</span><br><span class="line">        String paramstr = params[0] + params[1] + params[2] ;</span><br><span class="line">        //&#x52A0;&#x5BC6;</span><br><span class="line">        //&#x83B7;&#x53D6; shal &#x7B97;&#x6CD5;&#x5C01;&#x88C5;&#x7C7B;</span><br><span class="line">        MessageDigest Sha1Dtgest = MessageDigest.getInstance(&quot;SHA-1&quot;) ;</span><br><span class="line">        //&#x8FDB;&#x884C;&#x52A0;&#x5BC6;</span><br><span class="line">        byte [] digestResult = Sha1Dtgest.digest(paramstr.getBytes (&quot;UTF-8&quot;));</span><br><span class="line">        //&#x62FF;&#x5230;&#x52A0;&#x5BC6;&#x7ED3;&#x679C;</span><br><span class="line">        String mysignature = CodeLoginUtil.bytes2HexString(digestResult);</span><br><span class="line">        mysignature=mysignature.toLowerCase(Locale.ROOT);</span><br><span class="line">        //&#x662F;&#x5426;&#x6B63;&#x786E;</span><br><span class="line">        boolean signsuccess = mysignature.equals(signature);</span><br><span class="line">        //&#x903B;&#x8F91;&#x5904;&#x7406;</span><br><span class="line">        if (signsuccess &amp;&amp; echostr!=null) {</span><br><span class="line">            //peizhi  token</span><br><span class="line">            return echostr  ;//&#x4E0D;&#x6B63;&#x786E;&#x5C31;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x5931;&#x8D25;&#x63D0;&#x793A;&#xFF0E;</span><br><span class="line">        }else{</span><br><span class="line">            JSONObject jsonObject = callback(request);</span><br><span class="line">            return jsonObject.toJSONString();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  &#x56DE;&#x8C03;&#x65B9;&#x6CD5;</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public JSONObject callback(HttpServletRequest request) throws Exception{</span><br><span class="line">        log.info(&quot;===========&gt;callback&quot;);</span><br><span class="line">        //request&#x4E2D;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x8FDB;&#x884C;&#x89E3;&#x6790;</span><br><span class="line">        WxMpXmlMessage message= WxMpXmlMessage.fromXml(request.getInputStream());//&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x6D41;,&#x5E76;&#x89E3;&#x6790;xml</span><br><span class="line">        String messageType=message.getMsgType();								//&#x6D88;&#x606F;&#x7C7B;&#x578B;</span><br><span class="line">        String messageEvent=message.getEvent();								    //&#x6D88;&#x606F;&#x4E8B;&#x4EF6;</span><br><span class="line">        // openid</span><br><span class="line">        String fromUser=message.getFromUser();									//&#x53D1;&#x9001;&#x8005;&#x5E10;&#x53F7;</span><br><span class="line">        String touser=message.getToUser();										//&#x5F00;&#x53D1;&#x8005;&#x5FAE;&#x4FE1;&#x53F7;</span><br><span class="line">        String text=message.getContent();										//&#x6587;&#x672C;&#x6D88;&#x606F;  &#x6587;&#x672C;&#x5185;&#x5BB9;</span><br><span class="line">        // &#x751F;&#x6210;&#x4E8C;&#x7EF4;&#x7801;&#x65F6;&#x7A7F;&#x8FC7;&#x7684;&#x7279;&#x6B8A;&#x53C2;&#x6570;</span><br><span class="line">        String eventKey=message.getEventKey();									//&#x4E8C;&#x7EF4;&#x7801;&#x53C2;&#x6570;</span><br><span class="line"></span><br><span class="line">        String uuid=&quot;&quot;;															//&#x4ECE;&#x4E8C;&#x7EF4;&#x7801;&#x53C2;&#x6570;&#x4E2D;&#x83B7;&#x53D6;uuid&#x901A;&#x8FC7;&#x8BE5;uuid&#x53EF;&#x901A;&#x8FC7;websocket&#x524D;&#x7AEF;&#x4F20;&#x6570;&#x636E;</span><br><span class="line">        String userid=&quot;&quot;;</span><br><span class="line"></span><br><span class="line">        //if&#x5224;&#x65AD;&#xFF0C;&#x5224;&#x65AD;&#x67E5;&#x8BE2;</span><br><span class="line">        JSONObject jsonObject = new JSONObject();</span><br><span class="line">        jsonObject.put(&quot;code&quot;,&quot;200&quot;);</span><br><span class="line">        if(messageType.equals(&quot;event&quot;)){</span><br><span class="line">             jsonObject = null;</span><br><span class="line">            //&#x5148;&#x6839;&#x636E;openid&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;  =&gt; &#x4ECE;&#x81EA;&#x5DF1;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x67E5;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F; =&gt; jsonObject </span><br><span class="line">            if(messageEvent.equals(&quot;SCAN&quot;)){</span><br><span class="line">                //&#x626B;&#x63CF;&#x4E8C;&#x7EF4;&#x7801;</span><br><span class="line">                //return &quot;&#x6B22;&#x8FCE;&#x56DE;&#x6765;&quot;;</span><br><span class="line">            }</span><br><span class="line">            if(messageEvent.equals(&quot;subscribe&quot;)){</span><br><span class="line">                //&#x5173;&#x6CE8;</span><br><span class="line">                //return &quot;&#x8C22;&#x8C22;&#x60A8;&#x7684;&#x5173;&#x6CE8;&quot;;</span><br><span class="line">            }</span><br><span class="line">            //&#x6CA1;&#x6709;&#x8BE5;&#x7528;&#x6237;</span><br><span class="line">            if(jsonObject==null){</span><br><span class="line">                //&#x4ECE;&#x5FAE;&#x4FE1;&#x4E0A;&#x4E2D;&#x62C9;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;</span><br><span class="line">                String url = &quot;https://api.weixin.qq.com/cgi-bin/user/info?access_token=&quot; +getAccessToken() +</span><br><span class="line">                        &quot;&amp;openid=&quot; + fromUser +</span><br><span class="line">                        &quot;&amp;lang=zh_CN&quot;;</span><br><span class="line">                String result = HttpClientUtil.doGet(url);</span><br><span class="line">                jsonObject = JSONObject.parseObject(result);</span><br><span class="line">                /**</span><br><span class="line">                 * &#x7528;&#x6237;&#x4FE1;&#x606F;&#x5904;&#x7406;....</span><br><span class="line">                 */</span><br><span class="line">            }</span><br><span class="line">            // &#x626B;&#x7801;&#x6210;&#x529F;&#xFF0C;&#x5B58;&#x5165;&#x7F13;&#x5B58;</span><br><span class="line">            loginMap.put(eventKey,new CodeLoginKey(eventKey,fromUser));</span><br><span class="line">            return jsonObject;</span><br><span class="line">        }</span><br><span class="line">        return jsonObject;</span><br><span class="line">        //log.info(&quot;&#x6D88;&#x606F;&#x7C7B;&#x578B;:{},&#x6D88;&#x606F;&#x4E8B;&#x4EF6;:{},&#x53D1;&#x9001;&#x8005;&#x8D26;&#x53F7;:{},&#x63A5;&#x6536;&#x8005;&#x5FAE;&#x4FE1;:{},&#x6587;&#x672C;&#x6D88;&#x606F;:{},&#x4E8C;&#x7EF4;&#x7801;&#x53C2;&#x6570;&#xFF1A;{}&quot;,messageType,messageEvent,fromUser,touser,text,eventKey);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="3-&#x626B;&#x7801;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x53D6;&#x6D88;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;"><a href="#3-&#x626B;&#x7801;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x53D6;&#x6D88;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;" class="headerlink" title="3.&#x626B;&#x7801;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x53D6;&#x6D88;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;"></a>3.&#x626B;&#x7801;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x53D6;&#x6D88;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</h3><p><strong>js&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x76D1;&#x542C;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;    // &#x626B;&#x7801;&#x6210;&#x529F;&#xFF0C;&#x83B7;&#x53D6;&#x7528;&#x6237;openId=&gt;&#x4E3A;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x505A;&#x51C6;&#x5907;</span><br><span class="line">    function getOpenId() {</span><br><span class="line">        $.get(&quot;qrCodeFirstLogin/getOpenId&quot;,{</span><br><span class="line">            &quot;eventKey&quot;:sceneStr</span><br><span class="line">        },function (data) {</span><br><span class="line">            if(data.code == 200){</span><br><span class="line">                console.log(&quot;========getOpenId==========&quot;);</span><br><span class="line">                console.log(data.data);</span><br><span class="line">                window.clearInterval(t);</span><br><span class="line">                alert(&quot;&#x767B;&#x5F55;&#x6210;&#x529F;openId&#xFF1A;&quot;+data.data.openId);</span><br><span class="line">                /**</span><br><span class="line">                 * 1&#x3001;&#x7B2C;&#x4E00;&#x6B21;&#x626B;&#x7801;&#x767B;&#x5F55;&#x8FDB;&#x884C;&#x8D26;&#x53F7;&#x7ED1;&#x5B9A;</span><br><span class="line">                 * 2&#x3001;&#x4EE5;&#x540E;&#x6839;&#x636E;openId&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;</span><br><span class="line">                 */</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p><strong>&#x540E;&#x53F0;&#x9A8C;&#x8BC1;&#x63A5;&#x53E3;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    /**</span><br><span class="line">     *  &#x6839;&#x636E;&#x4E8C;&#x7EF4;&#x7801;&#x6807;&#x8BC6;&#x83B7;&#x53D6;&#x7528;&#x6237;openId=&gt;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;</span><br><span class="line">     * @param eventKey</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;getOpenId&quot;)</span><br><span class="line">    public ResultJson getOpenId(String eventKey){</span><br><span class="line">        if(loginMap.get(eventKey) == null){</span><br><span class="line">            return ResultJson.error(&quot;&#x672A;&#x626B;&#x7801;&#x6210;&#x529F;&#xFF01;&quot;) ;</span><br><span class="line">        }</span><br><span class="line">        CodeLoginKey codeLoginKey = loginMap.get(eventKey);</span><br><span class="line">        loginMap.remove(eventKey);</span><br><span class="line">        return ResultJson.ok(codeLoginKey);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h1 id="&#x7ED3;&#x679C;&#x6F14;&#x793A;"><a href="#&#x7ED3;&#x679C;&#x6F14;&#x793A;" class="headerlink" title="&#x7ED3;&#x679C;&#x6F14;&#x793A;"></a>&#x7ED3;&#x679C;&#x6F14;&#x793A;</h1><h2 id="&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;"><a href="#&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;" class="headerlink" title="&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;"></a>&#x83B7;&#x53D6;&#x4E8C;&#x7EF4;&#x7801;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/976a891a98d6becf0261ed32498a800bb8e5a502c594aed98d48950a9bcfe8ad" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<h2 id="&#x626B;&#x7801;&#x6210;&#x529F;"><a href="#&#x626B;&#x7801;&#x6210;&#x529F;" class="headerlink" title="&#x626B;&#x7801;&#x6210;&#x529F;"></a>&#x626B;&#x7801;&#x6210;&#x529F;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p7/raw/master/img/bcde72b36b8c8d623691b276445fe9cfd1aa0362f84219205534f2a0c3bf95f9" alt="&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<h1 id="&#x6E90;&#x7801;"><a href="#&#x6E90;&#x7801;" class="headerlink" title="&#x6E90;&#x7801;"></a>&#x6E90;&#x7801;</h1><p>&#x4F20;&#x9001;&#x95E8;&#xFF1A;<a href="/external_links/0b6f05310b2d76c2ffd082320542ccbb.html" target="blank" rel="noopener">&#x5FAE;&#x4FE1;pc&#x626B;&#x7801;&#x767B;&#x5F55;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/694ecfe7b70f3e06bca35fb33248dc83.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014080754040717342.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014080754040717342.html" itemprop="url">Dubbo 30   BootStrap 初始化主流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-01T20:59:40+08:00">
                2021-10-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p><strong>&#x8FD9;&#x4E00;&#x7BC7;&#x53EA;&#x9884;&#x89C8;&#x4E00;&#x4E0B; Bootstrap &#x521D;&#x59CB;&#x5316;&#x7684;&#x4E3B;&#x6D41;&#x7A0B; , &#x90E8;&#x5206;&#x7EC6;&#x8282;&#x70B9;&#x4F1A;&#x53E6;&#x5916;&#x5206;&#x6790;</strong></p>
<p>Dubbo 3.0 &#x901A;&#x8FC7; DubboBootstrap &#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x903B;&#x8F91; , DubboBootstrap &#x7684;&#x542F;&#x52A8;&#x903B;&#x8F91;&#x5982;&#x4E0B; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x6838;&#x5FC3;&#x539F;&#x7406;&#x4E3A; ApplicationContextEvent &#x4E8B;&#x4EF6;&#x7684;&#x89E6;&#x53D1; , &#x5F53; SpringApplication &#x542F;&#x52A8;&#x540E; ,&#x4F1A;&#x53D1;&#x5E03;&#x8BE5;&#x4E8B;&#x4EF6;</span><br><span class="line"></span><br><span class="line">C- AbstractApplicationContext # refresh : &#x53D1;&#x5E03; ApplicationContextEvent &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onApplicationContextEvent : &#x76D1;&#x542C;Application &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onContextRefreshedEvent</span><br><span class="line">C- DubboBootstrap # start : &#x5F00;&#x59CB;&#x52A0;&#x8F7D;&#x64CD;&#x4F5C;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x53C2;&#x8003;&#x7C7B; : </span><br><span class="line">DubboBeanUtils</span><br><span class="line">ServiceAnnotationPostProcessor</span><br><span class="line">DubboClassPathBeanDefinitionScanner</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x76D1;&#x542C;&#x5668; : </span><br><span class="line">DubboBootstrapApplicationListener</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;"><a href="#&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;" class="headerlink" title="&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;"></a>&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;</h2><p>Dubbo &#x7684;&#x521D;&#x59CB;&#x5316;&#x4E3B;&#x8981;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x7C7B; : DubboBootstrap -</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// Step 1 : DubboBootstrapApplicationListener</span><br><span class="line">public void onApplicationContextEvent(ApplicationContextEvent event) {</span><br><span class="line">	if (DubboBootstrapStartStopListenerSpringAdapter.applicationContext == null) {</span><br><span class="line">		DubboBootstrapStartStopListenerSpringAdapter.applicationContext = event.getApplicationContext();</span><br><span class="line">	}</span><br><span class="line">        // Step 2-1 : &#x5BB9;&#x5668;&#x542F;&#x52A8;&#x540E;&#x521D;&#x59CB;&#x5316; Bootstrap , &#x770B;&#x540D;&#x79F0;&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x8FD8;&#x53EF;&#x4EE5;&#x5237;&#x65B0;</span><br><span class="line">	if (event instanceof ContextRefreshedEvent) {</span><br><span class="line">		onContextRefreshedEvent((ContextRefreshedEvent) event);</span><br><span class="line">        // &#x5BB9;&#x5668;&#x5173;&#x95ED;&#x903B;&#x8F91;  </span><br><span class="line">	} else if (event instanceof ContextClosedEvent) {</span><br><span class="line">		onContextClosedEvent((ContextClosedEvent) event);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-1 </span><br><span class="line">private void onContextRefreshedEvent(ContextRefreshedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		dubboBootstrap.start();</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-2 </span><br><span class="line">private void onContextClosedEvent(ContextClosedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		DubboShutdownHook.getDubboShutdownHook().run();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;"><a href="#&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;" class="headerlink" title="&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;"></a>&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;</h2><h3 id="3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="3.1 Start &#x4E3B;&#x6D41;&#x7A0B;"></a>3.1 Start &#x4E3B;&#x6D41;&#x7A0B;</h3><p>start &#x73AF;&#x8282;&#x4E3B;&#x8981;&#x7531;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x73AF;&#x8282; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;Step 1 : &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</span><br><span class="line">Step 2 : initialize &#x521D;&#x59CB;&#x5316;</span><br><span class="line">Step 3 : exportServices &#x8F93;&#x51FA; Services</span><br><span class="line">Step 4 : referServices &#x6CE8;&#x518C; refer Service</span><br><span class="line">Step 5 : onStart() &#x542F;&#x52A8; (&#x5F02;&#x6B65;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x521B;&#x5EFA; Thread &#x540E;&#x542F;&#x52A8;)</span><br><span class="line">    </span><br><span class="line">// &#x542F;&#x52A8; Dubbo &#x5BB9;&#x5668;&#x73AF;&#x5883;</span><br><span class="line">dubboBootstrap.start(); </span><br><span class="line"></span><br><span class="line">// Step 1 &#xFF1A;Start &#x903B;&#x8F91;</span><br><span class="line">public DubboBootstrap start() {</span><br><span class="line">    if (started.compareAndSet(false, true)) {</span><br><span class="line">        startup.set(false);</span><br><span class="line">        initialized.set(false);</span><br><span class="line">        shutdown.set(false);</span><br><span class="line">        awaited.set(false);</span><br><span class="line"></span><br><span class="line">        initialize();</span><br><span class="line">        // 1. export Dubbo Services</span><br><span class="line">        exportServices();</span><br><span class="line"></span><br><span class="line">        // Not only provider register</span><br><span class="line">        if (!isOnlyRegisterProvider() || hasExportedServices()) {</span><br><span class="line">            // 2. export MetadataService</span><br><span class="line">            exportMetadataService();</span><br><span class="line">            // 3. Register the local ServiceInstance if required</span><br><span class="line">            registerServiceInstance();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        referServices();</span><br><span class="line">        if (asyncExportingFutures.size() &gt; 0 || asyncReferringFutures.size() &gt; 0) {</span><br><span class="line">            new Thread(() -&gt; {</span><br><span class="line">                try {</span><br><span class="line">                    this.awaitFinish();</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    logger.warn(NAME + &quot; asynchronous export / refer occurred an exception.&quot;);</span><br><span class="line">                }</span><br><span class="line">                startup.set(true);</span><br><span class="line">                onStart();</span><br><span class="line">            }).start();</span><br><span class="line">        } else {</span><br><span class="line">            startup.set(true);</span><br><span class="line">            onStart();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    return this;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"><a href="#3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;" class="headerlink" title="3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"></a>3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;if (started.compareAndSet(false, true)) </span><br><span class="line">    </span><br><span class="line">startup.set(false);</span><br><span class="line">initialized.set(false);</span><br><span class="line">shutdown.set(false);</span><br><span class="line">awaited.set(false);</span><br><span class="line">    </span><br><span class="line">// &#x6B64;&#x5904;&#x6709;&#x51E0;&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x64CD;&#x4F5C; : </span><br><span class="line">1. &#x539F;&#x5B50;&#x8BBE;&#x7F6E;&#x5DF2;&#x7ECF;&#x542F;&#x52A8;</span><br><span class="line">2. &#x8BBE;&#x7F6E;&#x5C5E;&#x6027;</span><br><span class="line">    </span><br><span class="line">// &#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x8FD9;4&#x4E2A;&#x5C5E;&#x6027;</span><br><span class="line">private AtomicBoolean initialized = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean started = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean startup = new AtomicBoolean(true);</span><br><span class="line">private AtomicBoolean destroyed = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean shutdown = new AtomicBoolean(false)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"><a href="#3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;" class="headerlink" title="3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"></a>3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public void initialize() {</span><br><span class="line">    if (!initialized.compareAndSet(false, true)) {</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ApplicationModel.initFrameworkExts();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316;&#x914D;&#x7F6E;</span><br><span class="line">    startConfigCenter();</span><br><span class="line">    loadConfigsFromProps();</span><br><span class="line">    checkGlobalConfigs();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316; Service</span><br><span class="line">    startMetadataCenter();</span><br><span class="line">    initMetadataService();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="3-3-1-ApplicationModel-initFrameworkExts"><a href="#3-3-1-ApplicationModel-initFrameworkExts" class="headerlink" title="3.3.1 ApplicationModel.initFrameworkExts()"></a>3.3.1 ApplicationModel.initFrameworkExts()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- DubboBootstrap</span><br><span class="line">public static void initFrameworkExts() {</span><br><span class="line">        Set&lt;FrameworkExt&gt; exts = ExtensionLoader.getExtensionLoader(FrameworkExt.class).getSupportedExtensionInstances();</span><br><span class="line">    	// PIC21005</span><br><span class="line">        for (FrameworkExt ext : exts) {</span><br><span class="line">            ext.initialize();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 1 : &#x901A;&#x8FC7; SPI &#x8FDB;&#x884C;&#x63D2;&#x4EF6;&#x5904;&#x7406;</span><br><span class="line">@SPI</span><br><span class="line">public interface FrameworkExt extends Lifecycle {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8865;&#x5145; : Dubbo &#x4E2D;&#x7684;  Lifecycle &#x5BF9;&#x8C61;</span><br><span class="line">- ConfigManager</span><br><span class="line">- Environment</span><br><span class="line">- LifecycleAdapter</span><br><span class="line">- ServiceRepository</span><br><span class="line">- SpringExtensionFactory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-1  : ConfigManager &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        String configModeStr = null;</span><br><span class="line">        try {</span><br><span class="line">            configModeStr = (String) ApplicationModel.getEnvironment().getConfiguration().getProperty(DUBBO_CONFIG_MODE);</span><br><span class="line">            if (StringUtils.hasText(configModeStr)) {</span><br><span class="line">                this.configMode = ConfigMode.valueOf(configModeStr.toUpperCase());</span><br><span class="line">            }</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new IllegalArgumentException(msg, e);</span><br><span class="line">        }</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line">// Step 2-2  : Environment &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        if (initialized.compareAndSet(false, true)) {</span><br><span class="line">            this.propertiesConfiguration = new PropertiesConfiguration();</span><br><span class="line">            this.systemConfiguration = new SystemConfiguration();</span><br><span class="line">            this.environmentConfiguration = new EnvironmentConfiguration();</span><br><span class="line">            this.externalConfiguration = new InmemoryConfiguration(&quot;ExternalConfig&quot;);</span><br><span class="line">            this.appExternalConfiguration = new InmemoryConfiguration(&quot;AppExternalConfig&quot;);</span><br><span class="line">            this.appConfiguration = new InmemoryConfiguration(&quot;AppConfig&quot;);</span><br><span class="line"></span><br><span class="line">            loadMigrationRule();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-3 : ServiceRepository &#x90E8;&#x5206;</span><br></pre></td></tr></table></figure>

<p><strong>PIC21005 : FrameworkExt &#x5BF9;&#x8C61;&#x5217;&#x8868;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/16486906da2ce44c8ffb53ec9d1aba90e245f43280970fe5cd09f5bd03fec7ad" alt="Dubbo-Framaket-module.png"></p>
<h4 id="3-3-2-startConfigCenter-&#x7B80;&#x8FF0;"><a href="#3-3-2-startConfigCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.2 startConfigCenter &#x7B80;&#x8FF0;"></a>3.3.2 startConfigCenter &#x7B80;&#x8FF0;</h4><p>&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x603B;&#x5171;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x6B65; :</p>
<ol>
<li>&#x5206;&#x522B;&#x52A0;&#x8F7D; ApplicationConfig &#x548C; ConfigCenterConfig</li>
<li>&#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E;</li>
<li>&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startConfigCenter() {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5904;&#x7406;&#x5BF9;&#x5E94;&#x7684; Config , &#x6B64;&#x5904;&#x7B80;&#x5355;&#x4E00;&#x70B9;&#x8BF4;&#x5206;&#x4E3A;2&#x4E2A;&#x7C7B;&#x578B; , &#x5F88;&#x597D;&#x7684;&#x601D;&#x8DEF; , &#x540E;&#x9762;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E00; : &#x5B58;&#x5728;class &#x5BF9;&#x5E94;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x901A;&#x8FC7; class &#x7C7B;&#x578B;&#x53BB; newInstance &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x5E94;&#x7C7B;&#x578B;&#x7684; Class &#x5BF9;&#x8C61;</span><br><span class="line">    // 2. &#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684; refush &#x8FDB;&#x884C;&#x5237;&#x65B0;&#x5904;&#x7406; (TODO : &#x540E;&#x7EED;&#x5206;&#x6790; , &#x5C31;&#x662F;&#x914D;&#x7F6E;&#x7684;&#x91CD;&#x5199;&#x6D41;&#x7A0B;)</span><br><span class="line">    // 3. &#x7F13;&#x5B58;&#x5230; configManager &#x4E2D;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E8C; : &#x4E0D;&#x5B58;&#x5728;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x76F4;&#x63A5;&#x4ECE; ApplicationModel &#x4E2D;&#x83B7;&#x53D6; Environment</span><br><span class="line">    // 2. newInstance &#x5B9E;&#x4F8B;&#x5316;&#x540E;&#x653E;&#x5728; configManager &#x4E2D;</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line">    loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    useRegistryAsConfigCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    // check Config Center -&gt; PS:332001</span><br><span class="line">    Collection&lt;ConfigCenterConfig&gt; configCenters = configManager.getConfigCenters();</span><br><span class="line">    if (CollectionUtils.isEmpty(configCenters)) {</span><br><span class="line">        // &#x901A;&#x5E38;&#x914D;&#x7F6E;&#x4E86;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x8FD9;&#x91CC;&#x90FD;&#x4F1A;&#x6709;&#x503C; , &#x5982;&#x679C;&#x4E3A;&#x7A7A; , &#x6B64;&#x5904; new &#x4E86;&#x4E00;&#x4E2A;&#x57FA;&#x7840;&#x5B9E;&#x73B0;</span><br><span class="line">    } else {</span><br><span class="line">        for (ConfigCenterConfig configCenterConfig : configCenters) {</span><br><span class="line">            // Step 2 : &#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E; , &#x540E;&#x7EED;&#x6DF1;&#x5165;</span><br><span class="line">            configCenterConfig.refresh();</span><br><span class="line">            ConfigValidationUtils.validateConfigCenterConfig(configCenterConfig);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isNotEmpty(configCenters)) {</span><br><span class="line">        CompositeDynamicConfiguration compositeDynamicConfiguration = new CompositeDynamicConfiguration();</span><br><span class="line">        </span><br><span class="line">        // &#x8FD9;&#x91CC;&#x8981;&#x5BF9; environment &#x73AF;&#x8282;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</span><br><span class="line">        for (ConfigCenterConfig configCenter : configCenters) {</span><br><span class="line">            // Pass config from ConfigCenterBean to environment</span><br><span class="line">            environment.updateExternalConfigMap(configCenter.getExternalConfiguration());</span><br><span class="line">            environment.updateAppExternalConfigMap(configCenter.getAppExternalConfiguration());</span><br><span class="line"></span><br><span class="line">            // Fetch config from remote config center</span><br><span class="line">            compositeDynamicConfiguration.addConfiguration(prepareEnvironment(configCenter));</span><br><span class="line">        }</span><br><span class="line">        environment.setDynamicConfiguration(compositeDynamicConfiguration);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    // Step 3 : &#x6B64;&#x5904;&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0; TODO</span><br><span class="line">    configManager.refreshAll();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConfigCenterConfig &#x5BF9;&#x8C61;&#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x4E2D;&#x5305;&#x542B;&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x7840;&#x914D;&#x7F6E;&#x4FE1;&#x606F; , &#x4F8B;&#x5982; protocol , address , port , cluster , namespace &#x7B49;</p>
<p><strong>&#x7075;&#x6D3B;&#x5229;&#x7528;&#x8BE5; ConfigCenterConfig &#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x96C6;&#x6210;&#x591A;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</strong></p>
<blockquote>
<p>&#x8865;&#x5145; : PS:332001 &#x7ED3;&#x6784;</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f7c2c606aa34f2832f92ad41f94f1658f66a8d9cde46e515530d6fea91914070" alt="image.png"></p>
<h3 id="3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;"><a href="#3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;"></a>3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;</h3><p><strong>&#x8FD9;&#x91CC;&#x548C;&#x4E0A;&#x9762;&#x5176;&#x5B9E;&#x5DEE;&#x4E0D;&#x591A; , loadConfigs &#x662F;&#x901A;&#x8FC7;&#x7279;&#x6B8A;&#x7684;&#x524D;&#x7F00;&#x5BF9;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;</strong></p>
<p>&#x4E4B;&#x524D;&#x770B;&#x8FC7;&#x591A;&#x4E2A;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x5BF9;&#x4E8E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x52A0;&#x8F7D;&#x601D;&#x8DEF; , <strong>&#x57FA;&#x672C;&#x4E0A;&#x6B8A;&#x9014;&#x540C;&#x5F52; , &#x90FD;&#x662F;&#x4EE5;&#x7C7B;&#x533A;&#x5206; , &#x901A;&#x8FC7;&#x524D;&#x7F00;&#x52A0;&#x8F7D;</strong> , &#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x5206;&#x6790;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadConfigsFromProps() {</span><br><span class="line"></span><br><span class="line">    // application config has load before starting config center</span><br><span class="line">    // load dubbo.applications.xxx</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.modules.xxx</span><br><span class="line">    loadConfigs(ModuleConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.monitors.xxx</span><br><span class="line">    loadConfigs(MonitorConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metricses.xxx</span><br><span class="line">    loadConfigs(MetricsConfig.class);</span><br><span class="line"></span><br><span class="line">    // load multiple config types:</span><br><span class="line">    // load dubbo.protocols.xxx</span><br><span class="line">    loadConfigs(ProtocolConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.registries.xxx</span><br><span class="line">    loadConfigs(RegistryConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.providers.xxx</span><br><span class="line">    loadConfigs(ProviderConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.consumers.xxx</span><br><span class="line">    loadConfigs(ConsumerConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metadata-report.xxx</span><br><span class="line">    loadConfigs(MetadataReportConfig.class);</span><br><span class="line"></span><br><span class="line">    // config centers has bean loaded before starting config center</span><br><span class="line">    //loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;"><a href="#3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;"></a>3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;</h3><p>&#x5728;&#x8FD9;&#x4E2A;&#x73AF;&#x8282;&#x4E2D;&#x4F1A;&#x901A;&#x8FC7; ConfigValidationUtils &#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x6821;&#x9A8C; , &#x4EE5;&#x53CA;&#x7AEF;&#x53E3;&#x5904;&#x7406; , &#x6700;&#x540E;&#x901A;&#x8FC7; refresh &#x5237;&#x65B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void checkGlobalConfigs() {</span><br><span class="line">    // check config types (ignore metadata-center)</span><br><span class="line">    List&lt;Class&lt;? extends AbstractConfig&gt;&gt; multipleConfigTypes = Arrays.asList(</span><br><span class="line">        ApplicationConfig.class,</span><br><span class="line">        ProtocolConfig.class,</span><br><span class="line">        RegistryConfig.class,</span><br><span class="line">        MetadataReportConfig.class,</span><br><span class="line">        ProviderConfig.class,</span><br><span class="line">        ConsumerConfig.class,</span><br><span class="line">        MonitorConfig.class,</span><br><span class="line">        ModuleConfig.class,</span><br><span class="line">        MetricsConfig.class,</span><br><span class="line">        SslConfig.class);</span><br><span class="line"></span><br><span class="line">    for (Class&lt;? extends AbstractConfig&gt; configType : multipleConfigTypes) {</span><br><span class="line">        // &#x901A;&#x8FC7; ConfigValidationUtils &#x5BF9;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x6821;&#x9A8C;</span><br><span class="line">        checkDefaultAndValidateConfigs(configType);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check port conflicts</span><br><span class="line">    // </span><br><span class="line">    Map&lt;Integer, ProtocolConfig&gt; protocolPortMap = new LinkedHashMap&lt;&gt;();</span><br><span class="line">    for (ProtocolConfig protocol : configManager.getProtocols()) {</span><br><span class="line">        Integer port = protocol.getPort();</span><br><span class="line">        if (port == null || port == -1) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x6B64;&#x5904;&#x5982;&#x679C;&#x5B58;&#x5728;&#x7AEF;&#x53E3;&#x51B2;&#x7A81; , &#x8FD9;&#x91CC;&#x4F1A;&#x76F4;&#x63A5;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        ProtocolConfig prevProtocol = protocolPortMap.get(port);</span><br><span class="line">        if (prevProtocol != null) {</span><br><span class="line">            throw new IllegalStateException</span><br><span class="line">        }</span><br><span class="line">        protocolPortMap.put(port, protocol);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check reference and service</span><br><span class="line">    // &#x8FD9;&#x91CC;&#x6B63;&#x5F0F;&#x5F00;&#x59CB;&#x5904;&#x7406; reference &#x548C; DubboService , TODO : &#x540E;&#x9762;&#x5355;&#x7AE0;&#x5206;&#x6790;</span><br><span class="line">    for (ReferenceConfigBase&lt;?&gt; reference : configManager.getReferences()) {</span><br><span class="line">        reference.refresh();</span><br><span class="line">    }</span><br><span class="line">    for (ServiceConfigBase service : configManager.getServices()) {</span><br><span class="line">        service.refresh();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;"><a href="#3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.5 startMetadataCenter &#x7B80;&#x8FF0;"></a>3.3.5 startMetadataCenter &#x7B80;&#x8FF0;</h3><p>&#x6B64;&#x5904;&#x662F;&#x5143;&#x6570;&#x636E;&#x7684;&#x5904;&#x7406;&#x3000;, &#x5143;&#x6570;&#x636E;&#x662F;&#x65B0;&#x7279;&#x6027; , &#x53EF;&#x4EE5;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x524D;&#x7F00;&#x201C;dubbo.metadata-report&#x201D;&#x8BBE;&#x7F6E;MetadataReportConfig&#x7684;&#x5C5E;&#x6027;</p>
<blockquote>
<p>&#x4EC0;&#x4E48;&#x662F;&#x5143;&#x6570;&#x636E; :</p>
</blockquote>
<ul>
<li>&#x5143;&#x6570;&#x636E;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x8F7B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x538B;&#x529B;&#xFF0C;&#x5C06;&#x90E8;&#x5206;&#x5B58;&#x50A8;&#x5728;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x5185;&#x5BB9;&#x653E;&#x5230;&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x3002;</li>
<li>&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x53EA;&#x662F;&#x7ED9;&#x81EA;&#x5DF1;&#x4F7F;&#x7528;&#x7684; , &#x6539;&#x52A8;&#x65E0;&#x9700;&#x5237;&#x65B0;</li>
<li>&#x4E0D;&#x9700;&#x8981;&#x76D1;&#x542C;&#x548C;&#x901A;&#x77E5; , &#x6781;&#x5927;&#x7684;&#x51CF;&#x5C11;&#x4E86;&#x6027;&#x80FD;&#x7684;&#x6D88;&#x8017;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startMetadataCenter() {</span><br><span class="line"></span><br><span class="line">    useRegistryAsMetadataCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    ApplicationConfig applicationConfig = getApplication();</span><br><span class="line"></span><br><span class="line">    String metadataType = applicationConfig.getMetadataType();</span><br><span class="line">    // FIXME, multiple metadata config support.</span><br><span class="line">    Collection&lt;MetadataReportConfig&gt; metadataReportConfigs = configManager.getMetadataConfigs();</span><br><span class="line">    if (CollectionUtils.isEmpty(metadataReportConfigs)) {</span><br><span class="line">        //... &#x8FD9;&#x91CC;&#x914D;&#x7F6E;&#x4E86;&#x8FDC;&#x7A0B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x65F6;&#x9ED8;&#x8BA4;&#x90FD;&#x4F1A;&#x6709;&#x6570;&#x636E; , &#x6CA1;&#x6709;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    for (MetadataReportConfig metadataReportConfig : metadataReportConfigs) {</span><br><span class="line">        // &lt;dubbo:metadata-report address=&quot;zookeeper://127.0.0.1:2181&quot; id=&quot;metadata-center-zookeeper-2181&quot; /&gt;</span><br><span class="line">        ConfigValidationUtils.validateMetadataConfig(metadataReportConfig);</span><br><span class="line">        if (!metadataReportConfig.isValid()) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x901A;&#x8FC7; instance &#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5904;&#x7406;</span><br><span class="line">        MetadataReportInstance.init(metadataReportConfig);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-6-initMetadataService-&#x7B80;&#x8FF0;"><a href="#3-3-6-initMetadataService-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.6 initMetadataService &#x7B80;&#x8FF0;"></a>3.3.6 initMetadataService &#x7B80;&#x8FF0;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    private void initMetadataService() {</span><br><span class="line">//        startMetadataCenter();</span><br><span class="line">        this.metadataService = getDefaultExtension();</span><br><span class="line">        this.metadataServiceExporter = new ConfigurableMetadataServiceExporter(metadataService);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="3-4-exportServices"><a href="#3-4-exportServices" class="headerlink" title="3.4 exportServices"></a>3.4 exportServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4F53;&#x7CFB;</p>
<h3 id="3-5-referServices"><a href="#3-5-referServices" class="headerlink" title="3.5 referServices"></a>3.5 referServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x4F53;&#x7CFB;</p>
<h3 id="3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"><a href="#3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;" class="headerlink" title="3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"></a>3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void onStart() {</span><br><span class="line">	ExtensionLoader&lt;DubboBootstrapStartStopListener&gt; exts = getExtensionLoader(DubboBootstrapStartStopListener.class);</span><br><span class="line">	exts.getSupportedExtensionInstances().forEach(ext -&gt; ext.onStart(this));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x603B;&#x7ED3;, &#x4EE5;&#x53CA;&#x5BF9;&#x5168;&#x90E8;&#x7684;&#x6982;&#x5FF5;&#x6709;&#x4E2A;&#x521D;&#x6B65;&#x7684;&#x7406;&#x89E3; , &#x540E;&#x9762;&#x4F1A;&#x9010;&#x6B65;&#x5B8C;&#x5584;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x7684;&#x7EC6;&#x8282;&#x70B9; , &#x4EE5;&#x53CA;&#x5BF9;&#x5176;&#x4EE3;&#x7801;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x4F7F;&#x7528;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9ba9fb87e288d1434a787b82881e4c0404d73c3eb3e77ee7a247970bc0cbecd9" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/27b9805e4b2f109ec422efdd1f2caab8.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../238/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../238/">238</a><span class="page-number current">239</span><a class="page-number" href="../240/">240</a><span class="space">&hellip;</span><a class="page-number" href="../399/">399</a><a class="extend next" rel="next" href="../240/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">3990</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1304</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
