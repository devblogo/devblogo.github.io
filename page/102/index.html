<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/102/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/102/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7239321198034534459.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7239321198034534459.html" itemprop="url">JYM 设计模式系列- 单例模式，适配器模式，让你的代码更优</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-31T22:41:09+08:00">
                2023-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x89C9;&#x5F97;&#x4E0D;&#x9519;&#x8BF7;&#x6309;&#x4E0B;&#x56FE;&#x64CD;&#x4F5C;&#xFF0C;&#x6398;&#x53CB;&#x4EEC;&#xFF0C;&#x54C8;&#x54C8;&#x54C8;&#xFF01;&#xFF01;&#xFF01;<br><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/65778c41bc60c72d236c320e8d0f067c99f567e785167c96bbb39732a5310da4" alt="image.png"></p>
<h1 id="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"><a href="#&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;" class="headerlink" title="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"></a>&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;</h1><p>&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x7C7B;&#xFF1A;</p>
<p><strong>&#x521B;&#x5EFA;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E94;&#x79CD;&#xFF1A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</strong></p>
<p><strong>&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E03;&#x79CD;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x3001;&#x5916;&#x89C2;&#x6A21;&#x5F0F;&#x3001;&#x6865;&#x63A5;&#x6A21;&#x5F0F;&#x3001;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;&#x3001;&#x4EAB;&#x5143;&#x6A21;&#x5F0F;&#x3002;</strong></p>
<p><strong>&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x5341;&#x4E00;&#x79CD;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x3001;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x8FED;&#x4EE3;&#x5B50;&#x6A21;&#x5F0F;&#x3001;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3001;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x3001;&#x5907;&#x5FD8;&#x5F55;&#x6A21;&#x5F0F;&#x3001;&#x72B6;&#x6001;&#x6A21;&#x5F0F;&#x3001;&#x8BBF;&#x95EE;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x4E2D;&#x4ECB;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x89E3;&#x91CA;&#x5668;&#x6A21;&#x5F0F;&#x3002;</strong></p>
<h1 id="&#x4E00;&#xFF1A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;"><a href="#&#x4E00;&#xFF1A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E00;&#xFF1A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;"></a>&#x4E00;&#xFF1A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;</h1><h2 id="1-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;"><a href="#1-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;" class="headerlink" title="1.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;"></a>1.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;</h2><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x662F;&#x6307;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x53EA;&#x4F1A;&#x521B;&#x5EFA;&#x4E14;&#x4EC5;&#x521B;&#x5EFA;&#x4E00;&#x6B21;&#x5BF9;&#x8C61;&#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x3002;&#x5728;&#x7A0B;&#x5E8F;&#x4E2D;&#x591A;&#x6B21;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4E14;&#x4F5C;&#x7528;&#x76F8;&#x540C;&#x65F6;&#xFF0C;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x9891;&#x7E41;&#x5730;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x4F7F;&#x5F97;&#x5185;&#x5B58;&#x98D9;&#x5347;&#xFF0C;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x8BA9;&#x7A0B;&#x5E8F;&#x4EC5;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x8BA9;&#x6240;&#x6709;&#x9700;&#x8981;&#x8C03;&#x7528;&#x7684;&#x5730;&#x65B9;&#x90FD;&#x5171;&#x4EAB;&#x8FD9;&#x4E00;&#x5355;&#x4F8B;&#x5BF9;&#x8C61;&#x3002;</p>
<h2 id="1-2-&#x4F18;&#x7F3A;&#x70B9;"><a href="#1-2-&#x4F18;&#x7F3A;&#x70B9;" class="headerlink" title="1.2 &#x4F18;&#x7F3A;&#x70B9;"></a>1.2 &#x4F18;&#x7F3A;&#x70B9;</h2><p><strong>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x5185;&#x5B58;&#x91CC;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x51CF;&#x5C11;&#x4E86;&#x5185;&#x5B58;&#x7684;&#x5F00;&#x9500;&#x3002;</li>
<li>&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5BF9;&#x8D44;&#x6E90;&#x7684;&#x591A;&#x91CD;&#x5360;&#x7528;&#x3002;</li>
<li>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x8BBF;&#x95EE;&#x70B9;&#xFF0C;&#x53EF;&#x4EE5;&#x4F18;&#x5316;&#x548C;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x7684;&#x8BBF;&#x95EE;&#x3002;</li>
</ul>
<p><strong>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x7684;&#x7F3A;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x4E00;&#x822C;&#x6CA1;&#x6709;&#x63A5;&#x53E3;&#xFF0C;&#x6269;&#x5C55;&#x56F0;&#x96BE;&#x3002;&#x5982;&#x679C;&#x8981;&#x6269;&#x5C55;&#xFF0C;&#x5219;&#x9664;&#x4E86;&#x4FEE;&#x6539;&#x539F;&#x6765;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6CA1;&#x6709;&#x7B2C;&#x4E8C;&#x79CD;&#x9014;&#x5F84;&#xFF0C;&#x8FDD;&#x80CC;&#x5F00;&#x95ED;&#x539F;&#x5219;&#x3002;</li>
<li>&#x5728;&#x5E76;&#x53D1;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x4E0D;&#x5229;&#x4E8E;&#x4EE3;&#x7801;&#x8C03;&#x8BD5;&#x3002;&#x5728;&#x8C03;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x5355;&#x4F8B;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x4E5F;&#x4E0D;&#x80FD;&#x6A21;&#x62DF;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x7684;&#x529F;&#x80FD;&#x4EE3;&#x7801;&#x901A;&#x5E38;&#x5199;&#x5728;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x529F;&#x80FD;&#x8BBE;&#x8BA1;&#x4E0D;&#x5408;&#x7406;&#xFF0C;&#x5219;&#x5F88;&#x5BB9;&#x6613;&#x8FDD;&#x80CC;&#x5355;&#x4E00;&#x804C;&#x8D23;&#x539F;&#x5219;&#x3002;</li>
</ul>
<h2 id="1-3-&#x9002;&#x7528;&#x573A;&#x666F;"><a href="#1-3-&#x9002;&#x7528;&#x573A;&#x666F;" class="headerlink" title="1.3 &#x9002;&#x7528;&#x573A;&#x666F;"></a>1.3 &#x9002;&#x7528;&#x573A;&#x666F;</h2><p>&#x5728; Java&#x4E2D;&#xFF0C;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x5728;&#x4E00;&#x4E2A; JVM &#x4E2D;&#x53EA;&#x5B58;&#x5728;&#x5355;&#x4E00;&#x5B9E;&#x4F8B;&#x3002;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x4E3B;&#x8981;&#x6709;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x65B9;&#x9762;&#x3002;</p>
<ul>
<li>&#x9700;&#x8981;&#x9891;&#x7E41;&#x521B;&#x5EFA;&#x7684;&#x4E00;&#x4E9B;&#x7C7B;&#xFF0C;&#x4F7F;&#x7528;&#x5355;&#x4F8B;&#x53EF;&#x4EE5;&#x964D;&#x4F4E;&#x7CFB;&#x7EDF;&#x7684;&#x5185;&#x5B58;&#x538B;&#x529B;&#xFF0C;&#x51CF;&#x5C11; GC&#x3002;</li>
<li>&#x67D0;&#x7C7B;&#x53EA;&#x8981;&#x6C42;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x3002;</li>
<li>&#x67D0;&#x4E9B;&#x7C7B;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#x65F6;&#x5360;&#x7528;&#x8D44;&#x6E90;&#x8F83;&#x591A;&#xFF0C;&#x6216;&#x5B9E;&#x4F8B;&#x5316;&#x8017;&#x65F6;&#x8F83;&#x957F;&#xFF0C;&#x4E14;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x3002;</li>
<li>&#x67D0;&#x7C7B;&#x9700;&#x8981;&#x9891;&#x7E41;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x800C;&#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x53C8;&#x9891;&#x7E41;&#x88AB;&#x9500;&#x6BC1;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x591A;&#x7EBF;&#x7A0B;&#x7684;&#x7EBF;&#x7A0B;&#x6C60;&#x3001;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x6C60;&#x7B49;&#x3002;</li>
<li>&#x9891;&#x7E41;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x5E93;&#x6216;&#x6587;&#x4EF6;&#x7684;&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x63A7;&#x5236;&#x786C;&#x4EF6;&#x7EA7;&#x522B;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6216;&#x8005;&#x4ECE;&#x7CFB;&#x7EDF;&#x4E0A;&#x6765;&#x8BB2;&#x5E94;&#x5F53;&#x662F;&#x5355;&#x4E00;&#x63A7;&#x5236;&#x903B;&#x8F91;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x591A;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x5219;&#x7CFB;&#x7EDF;&#x4F1A;&#x5B8C;&#x5168;&#x4E71;&#x5957;&#x3002;</li>
<li>&#x5F53;&#x5BF9;&#x8C61;&#x9700;&#x8981;&#x88AB;&#x5171;&#x4EAB;&#x7684;&#x573A;&#x5408;&#x3002;&#x7531;&#x4E8E;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x53EA;&#x5141;&#x8BB8;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5171;&#x4EAB;&#x8BE5;&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x52A0;&#x5FEB;&#x5BF9;&#x8C61;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#x3002;&#x5982; Web &#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x5BF9;&#x8C61;&#x3001;&#x6570;&#x636E;&#x5E93;&#x7684;&#x8FDE;&#x63A5;&#x6C60;&#x7B49;&#x3002;</li>
</ul>
<h2 id="1-4-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"><a href="#1-4-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;" class="headerlink" title="1.4 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"></a>1.4 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;</h2><p>&#x597D;&#x4E86;&#xFF0C;&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x4EC0;&#x4E48;&#x662F;&#x5355;&#x4F8B;&#xFF0C;&#x4EE5;&#x53CA;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x7EE7;&#x7EED;&#x8BA8;&#x8BBA;&#x4E0B;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x5355;&#x4F8B;&#x3002;  </p>
<p>&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x5355;&#x4F8B;&#x5206;&#x4E3A;<strong>&#x884C;&#x4E3A;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#x548C;<strong>&#x7BA1;&#x7406;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#x3002;<strong>&#x884C;&#x4E3A;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#x4EE3;&#x8868;&#x4E0D;&#x7BA1;&#x5982;&#x4F55;&#x64CD;&#x4F5C;&#xFF0C;&#x5728;jvm&#x5C42;&#x9762;&#x4E0A;&#x90FD;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x800C;<strong>&#x7BA1;&#x7406;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#x5219;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#xFF1A;&#x4E0D;&#x7BA1;&#x8C01;&#x53BB;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x90FD;&#x8981;&#x5B88;&#x4E00;&#x5B9A;&#x7684;<strong>&#x89C4;&#x77E9;</strong>&#xFF0C;&#x6BD4;&#x65B9;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x67D0;&#x4E2A;&#x7C7B;&#xFF0C;&#x53EA;&#x80FD;&#x4ECE;&#x6307;&#x5B9A;&#x7684;&#x5730;&#x65B9;&#x2019;&#x53BB;&#x62FF;&#x2018;&#xFF0C;&#x8FD9;&#x6837;&#x62FF;&#x5230;&#x5C31;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E86;&#x3002;  </p>
<p>&#x800C;&#x5BF9;&#x4E8E;<strong>&#x7BA1;&#x7406;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#xFF0C;&#x76F8;&#x4FE1;&#x5927;&#x5BB6;&#x6700;&#x4E3A;&#x719F;&#x6089;&#x7684;&#x5C31;&#x662F;spring&#x4E86;&#xFF0C;spring&#x5C06;&#x6240;&#x6709;&#x7684;&#x7C7B;&#x653E;&#x5230;&#x4E00;&#x4E2A;<strong>&#x5BB9;&#x5668;</strong>&#x4E2D;&#xFF0C;&#x4EE5;&#x540E;&#x4F7F;&#x7528;&#x8BE5;&#x7C7B;&#x90FD;&#x4ECE;&#x8BE5;<strong>&#x5BB9;&#x5668;</strong>&#x53BB;&#x53D6;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4FDD;&#x8BC1;&#x4E86;&#x5355;&#x4F8B;&#x3002;  </p>
<p>&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5269;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#x63A5;&#x7740;&#x6765;&#x8C08;&#x8C08;&#x5982;&#x4F55;&#x5B9E;&#x73B0;<strong>&#x884C;&#x4E3A;&#x4E0A;&#x7684;&#x5355;&#x4F8B;</strong>&#x4E86;&#x3002;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x79CD;&#x5355;&#x4F8B;&#x5B9E;&#x73B0;&#x6709;&#x4E24;&#x79CD;&#x601D;&#x8DEF;&#xFF0C;<strong>&#x79C1;&#x6709;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x679A;&#x4E3E;</strong>&#x3002;</p>
<p>&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x6709;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;</p>
<ul>
<li>&#x61D2;&#x6C49;&#x5F0F;&#xFF1A;&#x5728;&#x771F;&#x6B63;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x53BB;&#x521B;&#x5EFA;&#x8BE5;&#x5BF9;&#x8C61;&#xFF1B;</li>
<li>&#x997F;&#x6C49;&#x5F0F;&#xFF1A;&#x5728;&#x7C7B;&#x52A0;&#x8F7D;&#x65F6;&#x521B;&#x5EFA;&#x597D;&#x8BE5;&#x5355;&#x4F8B;&#x5BF9;&#x8C61;&#xFF0C;&#x7B49;&#x5F85;&#x88AB;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x3002;</li>
</ul>
<h2 id="1-5-&#x4E0A;demo"><a href="#1-5-&#x4E0A;demo" class="headerlink" title="1.5 &#x4E0A;demo"></a>1.5 &#x4E0A;demo</h2><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4a3173e010571c5dcd8d2dcf2fb178f2cae496563545a2dc7f96aa4f1b1bcf15" alt="image.png"></p>
<p><strong>&#x997F;&#x6C49;&#x6A21;&#x5F0F;&#xFF1A;</strong></p>
<p>IvoryTower &#xFF1A;&#x5355;&#x4F8B;&#x7C7B;&#x3002;&#x521D;&#x59CB;&#x5316;&#x7684;&#x9759;&#x6001;&#x5B9E;&#x4F8B;&#x4FDD;&#x8BC1;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public final class IvoryTower {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x79C1;&#x6709;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x6CA1;&#x6709;&#x4EBA;&#x53EF;&#x4EE5;&#x5B9E;&#x4F8B;&#x5316;&#x8BE5;&#x7C7B;.</span><br><span class="line">   */</span><br><span class="line">  private IvoryTower() {</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x9759;&#x6001;&#x5230;&#x7C7B;&#x7684;&#x7C7B;&#x5B9E;&#x4F8B;.</span><br><span class="line">   */</span><br><span class="line">  private static final IvoryTower INSTANCE = new IvoryTower();</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x88AB;&#x7528;&#x6237;&#x8C03;&#x7528;&#x4EE5;&#x83B7;&#x53D6;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;.</span><br><span class="line">   *</span><br><span class="line">   * @return instance of the singleton.</span><br><span class="line">   */</span><br><span class="line">  public static IvoryTower getInstance() {</span><br><span class="line">    return INSTANCE;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x61D2;&#x6C49;&#x6A21;&#x5F0F;&#x521D;&#x59CB;&#x5316;&#x5355;&#x4F8B;&#xFF1A;</strong></p>
<p>ThreadSafeLazyLoadedIvoryTower&#xFF1A;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#x5355;&#x4F8B;&#x7C7B;&#x3002;&#x5B9E;&#x4F8B;&#x88AB;&#x60F0;&#x6027;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x540C;&#x6B65;&#x673A;&#x5236;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public final class ThreadSafeLazyLoadedIvoryTower {</span><br><span class="line"></span><br><span class="line">  private static volatile ThreadSafeLazyLoadedIvoryTower instance;</span><br><span class="line"></span><br><span class="line">  private ThreadSafeLazyLoadedIvoryTower() {</span><br><span class="line">    // &#x901A;&#x8FC7;&#x53CD;&#x5C04;&#xFF0C;&#x9632;&#x6B62;&#x5B9E;&#x4F8B;&#x5316;&#x5316;</span><br><span class="line">    if (instance != null) {</span><br><span class="line">      throw new IllegalStateException(&quot;Already initialized.&quot;);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x4E4B;&#x524D;&#x4E0D;&#x4F1A;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;</span><br><span class="line">   */</span><br><span class="line">  public static synchronized ThreadSafeLazyLoadedIvoryTower getInstance() {</span><br><span class="line">    if (instance == null) {</span><br><span class="line">      instance = new ThreadSafeLazyLoadedIvoryTower();</span><br><span class="line">    }</span><br><span class="line">    return instance;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x662F;&#x6309;&#x9700;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5355;&#x4F8B;&#x5B9E;&#x73B0;&#x3002;&#x7F3A;&#x70B9;&#x662F;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#x5F88;&#x6162;&#xFF0C;&#x56E0;&#x4E3A;&#x6574;&#x4E2A;&#x8BBF;&#x95EE;&#x65B9;&#x6CD5;&#x662F;&#x540C;&#x6B65;&#x7684;</p>
<p><strong>&#x901A;&#x8FC7;&#x679A;&#x4E3E;&#x5B9E;&#x73B0;&#x5355;&#x4F8B;&#xFF1A;</strong></p>
<p>EnumIvoryTower&#xFF1A; &#x6B64;&#x5B9E;&#x73B0;&#x662F;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x6DFB;&#x52A0;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#x53CA;&#x5176;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x662F;&#x5F00;&#x53D1;&#x6240;&#x505A;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public enum EnumIvoryTower {</span><br><span class="line"></span><br><span class="line">  INSTANCE;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return getDeclaringClass().getCanonicalName() + &quot;@&quot; + hashCode();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x53CC;&#x91CD;&#x68C0;&#x67E5;&#x9501;&#x5B9A;&#x5B9E;&#x73B0;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public final class ThreadSafeDoubleCheckLocking {</span><br><span class="line"></span><br><span class="line">  private static volatile ThreadSafeDoubleCheckLocking instance;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x79C1;&#x6709;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4EE5;&#x9632;&#x6B62;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x4F8B;&#x5316;.</span><br><span class="line">   */</span><br><span class="line">  private ThreadSafeDoubleCheckLocking() {</span><br><span class="line">    // to prevent instantiating by Reflection call</span><br><span class="line">    if (instance != null) {</span><br><span class="line">      throw new IllegalStateException(&quot;Already initialized.&quot;);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x516C;&#x5171;&#x8BBF;&#x95EE;&#x5668;</span><br><span class="line">   *</span><br><span class="line">   * @return an instance of the class.</span><br><span class="line">   */</span><br><span class="line">  public static ThreadSafeDoubleCheckLocking getInstance() {</span><br><span class="line">    // &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5C06;&#x6027;&#x80FD;&#x63D0;&#x9AD8; 25%</span><br><span class="line">    // Joshua Bloch &#x201C;Effective Java&#xFF0C;&#x7B2C;&#x4E8C;&#x7248;&#x201D;&#xFF0C;p. 283-284</span><br><span class="line"></span><br><span class="line">    var result = instance;</span><br><span class="line">    // &#x68C0;&#x67E5;&#x5355;&#x4F8B;&#x5B9E;&#x4F8B;&#x662F;&#x5426;&#x521D;&#x59CB;&#x5316;.</span><br><span class="line">    // &#x5982;&#x679C;&#x5B83;&#x5DF2;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x5B9E;&#x4F8B;&#x3002;</span><br><span class="line">    if (result == null) {</span><br><span class="line">      // &#x5B83;&#x6CA1;&#x6709;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x786E;&#x5B9A;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x53EF;&#x80FD;&#x6709;</span><br><span class="line">      // &#x540C;&#x65F6;&#x521D;&#x59CB;&#x5316;&#x5B83;.</span><br><span class="line">      // &#x6240;&#x4EE5;&#x4E3A;&#x4E86;&#x786E;&#x4FDD;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x9501;&#x5B9A;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4EE5;&#x83B7;&#x5F97;&#x4E92;&#x65A5;.</span><br><span class="line">      synchronized (ThreadSafeDoubleCheckLocking.class) {</span><br><span class="line">        //&#x518D;&#x6B21;&#x5C06;&#x5B9E;&#x4F8B;&#x5206;&#x914D;&#x7ED9;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x4EE5;&#x68C0;&#x67E5;&#x5B83;&#x662F;&#x5426;&#x7531;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x521D;&#x59CB;&#x5316;</span><br><span class="line">        //&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x88AB;&#x963B;&#x585E;&#x8FDB;&#x5165;&#x9501;&#x5B9A;&#x533A;&#x65F6;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;</span><br><span class="line">        // &#x5982;&#x679C;&#x5B83;&#x5DF2;&#x88AB;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E4B;&#x524D;&#x521B;&#x5EFA;&#x7684;&#x5B9E;&#x4F8B;</span><br><span class="line">        // &#x5C31;&#x50CF;&#x4E4B;&#x524D;&#x7684;&#x7A7A;&#x68C0;&#x67E5;&#x4E00;&#x6837;&#x3002;</span><br><span class="line">        result = instance;</span><br><span class="line">        if (result == null) {</span><br><span class="line">          // &#x8BE5;&#x5B9E;&#x4F8B;&#x4ECD;&#x672A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x5730;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;</span><br><span class="line">          // (&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;)</span><br><span class="line">          // &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#x5E76;&#x4F7F;&#x5176;&#x6210;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x5355;&#x4F8B;&#x5B9E;&#x4F8B;.</span><br><span class="line">          instance = result = new ThreadSafeDoubleCheckLocking();</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    return result;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5B83;&#x6BD4; ThreadSafeLazyLoadedIvoryTower &#x5FEB;&#x4E00;&#x4E9B;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E0D;&#x540C;&#x6B65;&#x6574;&#x4E2A;&#x8BBF;&#x95EE;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x53EA;&#x540C;&#x6B65;&#x7279;&#x5B9A;&#x6761;&#x4EF6;&#x4E0B;&#x7684;&#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x3002;</p>
<p><strong>&#x6309;&#x9700;&#x521D;&#x59CB;&#x5316; holder&#xFF1A;</strong></p>
<p>&#x53EF;&#x4EE5;&#x627E;&#x5230;&#x53E6;&#x4E00;&#x79CD;&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#x5EF6;&#x8FDF;&#x521D;&#x59CB;&#x5316;&#x5355;&#x4F8B;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x6B64;&#x5B9E;&#x73B0;&#x81F3;&#x5C11;&#x9700;&#x8981; Java 8 API &#x7EA7;&#x522B;&#x624D;&#x80FD;&#x5DE5;&#x4F5C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public final class InitializingOnDemandHolderIdiom {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x79C1;&#x6709;&#x6784;&#x9020;&#x51FD;&#x6570;.</span><br><span class="line">   */</span><br><span class="line">  private InitializingOnDemandHolderIdiom() {</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x5355;&#x4F8B;&#x5B9E;&#x4F8B;.</span><br><span class="line">   *</span><br><span class="line">   * @return Singleton instance</span><br><span class="line">   */</span><br><span class="line">  public static InitializingOnDemandHolderIdiom getInstance() {</span><br><span class="line">    return HelperHolder.INSTANCE;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x63D0;&#x4F9B;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7684; Singleton &#x5B9E;&#x4F8B;.</span><br><span class="line">   */</span><br><span class="line">  private static class HelperHolder {</span><br><span class="line">    private static final InitializingOnDemandHolderIdiom INSTANCE =</span><br><span class="line">        new InitializingOnDemandHolderIdiom();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Initialize-on-demand-holder &#x4E60;&#x60EF;&#x7528;&#x6CD5;&#x662F;&#x5728; Java &#x4E2D;&#x521B;&#x5EFA;&#x60F0;&#x6027;&#x521D;&#x59CB;&#x5316;&#x5355;&#x4F8B;&#x5BF9;&#x8C61;&#x7684;&#x5B89;&#x5168;&#x65B9;&#x6CD5;&#xFF1B;&#x8BE5;&#x6280;&#x672F;&#x5C3D;&#x53EF;&#x80FD;&#x60F0;&#x6027;&#xFF0C;&#x9002;&#x7528;&#x4E8E;&#x6240;&#x6709;&#x5DF2;&#x77E5;&#x7684; Java &#x7248;&#x672C;&#x3002;&#x5B83;&#x5229;&#x7528; &#x5173;&#x4E8E;&#x7C7B;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8BED;&#x8A00;&#x4FDD;&#x8BC1;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5728;&#x6240;&#x6709;&#x517C;&#x5BB9; Java &#x7684;&#x7F16;&#x8BD1;&#x5668;&#x548C;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#xFF1B;&#x90E8;&#x7C7B;&#x7684;&#x5F15;&#x7528;&#x65F6;&#x95F4;&#x4E0D;&#x65E9;&#x4E8E;&#x8C03;&#x7528; getInstance() &#x7684;&#x65F6;&#x95F4;&#xFF08;&#x56E0;&#x6B64;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;&#x4E5F;&#x4E0D;&#x65E9;&#xFF09;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6B64;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x9700;&#x8981;&#x7279;&#x6B8A;&#x7684;&#x8BED;&#x8A00;&#x7ED3;&#x6784;&#x3002;</p>
<p><strong>&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line"></span><br><span class="line">    // &#x997F;&#x6C49;&#x6A21;&#x5F0F;</span><br><span class="line">    var ivoryTower1 = IvoryTower.getInstance();</span><br><span class="line">    var ivoryTower2 = IvoryTower.getInstance();</span><br><span class="line">    LOGGER.info(&quot;ivoryTower1={}&quot;, ivoryTower1);</span><br><span class="line">    LOGGER.info(&quot;ivoryTower2={}&quot;, ivoryTower2);</span><br><span class="line"></span><br><span class="line">    // &#x61D2;&#x6C49;&#x6A21;&#x5F0F;</span><br><span class="line">    var threadSafeIvoryTower1 = ThreadSafeLazyLoadedIvoryTower.getInstance();</span><br><span class="line">    var threadSafeIvoryTower2 = ThreadSafeLazyLoadedIvoryTower.getInstance();</span><br><span class="line">    LOGGER.info(&quot;threadSafeIvoryTower1={}&quot;, threadSafeIvoryTower1);</span><br><span class="line">    LOGGER.info(&quot;threadSafeIvoryTower2={}&quot;, threadSafeIvoryTower2);</span><br><span class="line"></span><br><span class="line">    // &#x679A;&#x4E3E;&#x5355;&#x4F8B;</span><br><span class="line">    var enumIvoryTower1 = EnumIvoryTower.INSTANCE;</span><br><span class="line">    var enumIvoryTower2 = EnumIvoryTower.INSTANCE;</span><br><span class="line">    LOGGER.info(&quot;enumIvoryTower1={}&quot;, enumIvoryTower1);</span><br><span class="line">    LOGGER.info(&quot;enumIvoryTower2={}&quot;, enumIvoryTower2);</span><br><span class="line"></span><br><span class="line">    // &#x53CC;&#x91CD;&#x68C0;&#x67E5;&#x9501;&#x5B9A;&#x5B9E;&#x73B0;</span><br><span class="line">    var dcl1 = ThreadSafeDoubleCheckLocking.getInstance();</span><br><span class="line">    LOGGER.info(dcl1.toString());</span><br><span class="line">    var dcl2 = ThreadSafeDoubleCheckLocking.getInstance();</span><br><span class="line">    LOGGER.info(dcl2.toString());</span><br><span class="line"></span><br><span class="line">    // &#x6309;&#x9700;&#x521D;&#x59CB;&#x5316; holder</span><br><span class="line">    var demandHolderIdiom = InitializingOnDemandHolderIdiom.getInstance();</span><br><span class="line">    LOGGER.info(demandHolderIdiom.toString());</span><br><span class="line">    var demandHolderIdiom2 = InitializingOnDemandHolderIdiom.getInstance();</span><br><span class="line">    LOGGER.info(demandHolderIdiom2.toString());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="&#x4E8C;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;"><a href="#&#x4E8C;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E8C;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;"></a>&#x4E8C;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;</h1><h2 id="2-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;"><a href="#2-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;" class="headerlink" title="2.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;"></a>2.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;</h2><p>&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x5C5E;&#x4E8E;&#x201C;&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#x201D;&#x7684;&#x4E00;&#x79CD;&#x3002;&#x8BE5;&#x6A21;&#x5F0F;&#x7684;&#x6838;&#x5FC3;&#x601D;&#x60F3;&#x5C31;&#x662F;&#x5C06;&#x7C7B;&#x4E2D;&#x539F;&#x672C;&#x4E0D;&#x9002;&#x5408;&#x5F53;&#x524D;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x7684;&#x63A5;&#x53E3;&#x8F6C;&#x6362;&#x6210;&#x9002;&#x7528;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x4ECE;&#x800C;&#x5927;&#x5927;&#x63D0;&#x9AD8;&#x7A0B;&#x5E8F;&#x7684;&#x517C;&#x5BB9;&#x6027;&#x3002;&#x5E76;&#x4E14;&#x4ECE;&#x4F7F;&#x7528;&#x8005;&#x7684;&#x89D2;&#x5EA6;&#x662F;&#x770B;&#x4E0D;&#x5230;&#x88AB;&#x9002;&#x914D;&#x7684;&#x7C7B;&#x5730;&#xFF0C;&#x4E5F;&#x964D;&#x4F4E;&#x4E86;&#x4EE3;&#x7801;&#x4E4B;&#x95F4;&#x7684;&#x8026;&#x5408;&#x6027;&#x3002;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#x5C31;&#x662F;&#xFF1A;&#x7528;&#x6237;&#x8C03;&#x7528;&#x9002;&#x914D;&#x5668;&#x8F6C;&#x6362;&#x51FA;&#x6765;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5728;&#x8C03;&#x7528;&#x88AB;&#x9002;&#x914D;&#x7C7B;&#x7684;&#x76F8;&#x5173;&#x63A5;&#x53E3;&#xFF0C;&#x4ECE;&#x800C;&#x5B8C;&#x6210;&#x9002;&#x914D;&#x3002;</p>
<h2 id="2-2-&#x4F18;&#x7F3A;&#x70B9;"><a href="#2-2-&#x4F18;&#x7F3A;&#x70B9;" class="headerlink" title="2.2 &#x4F18;&#x7F3A;&#x70B9;"></a>2.2 &#x4F18;&#x7F3A;&#x70B9;</h2><p><strong>&#x4F18;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8FC7;&#x9002;&#x914D;&#x5668;&#x53EF;&#x4EE5;&#x900F;&#x660E;&#x5730;&#x8C03;&#x7528;&#x76EE;&#x6807;&#x63A5;&#x53E3;&#x3002;</li>
<li>&#x590D;&#x7528;&#x4E86;&#x73B0;&#x5B58;&#x7684;&#x7C7B;&#xFF0C;&#x7A0B;&#x5E8F;&#x5458;&#x4E0D;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x539F;&#x6709;&#x4EE3;&#x7801;&#x800C;&#x91CD;&#x7528;&#x73B0;&#x6709;&#x7684;&#x9002;&#x914D;&#x8005;&#x7C7B;&#x3002;</li>
<li>&#x5C06;&#x76EE;&#x6807;&#x7C7B;&#x548C;&#x9002;&#x914D;&#x8005;&#x7C7B;&#x89E3;&#x8026;&#xFF0C;&#x89E3;&#x51B3;&#x4E86;&#x76EE;&#x6807;&#x7C7B;&#x548C;&#x9002;&#x914D;&#x8005;&#x7C7B;&#x63A5;&#x53E3;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x95EE;&#x9898;&#x3002;</li>
<li>&#x5728;&#x5F88;&#x591A;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x4E2D;&#x7B26;&#x5408;&#x5F00;&#x95ED;&#x539F;&#x5219;&#x3002;</li>
</ul>
<p><strong>&#x7F3A;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x9002;&#x914D;&#x5668;&#x7F16;&#x5199;&#x8FC7;&#x7A0B;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x5168;&#x9762;&#x8003;&#x8651;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x589E;&#x52A0;&#x7CFB;&#x7EDF;&#x7684;&#x590D;&#x6742;&#x6027;&#x3002;</li>
<li>&#x589E;&#x52A0;&#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x96BE;&#x5EA6;&#xFF0C;&#x964D;&#x4F4E;&#x4EE3;&#x7801;&#x53EF;&#x8BFB;&#x6027;&#xFF0C;&#x8FC7;&#x591A;&#x4F7F;&#x7528;&#x9002;&#x914D;&#x5668;&#x4F1A;&#x4F7F;&#x7CFB;&#x7EDF;&#x4EE3;&#x7801;&#x53D8;&#x5F97;&#x51CC;&#x4E71;</li>
</ul>
<h2 id="2-3-&#x9002;&#x7528;&#x573A;&#x666F;"><a href="#2-3-&#x9002;&#x7528;&#x573A;&#x666F;" class="headerlink" title="2.3 &#x9002;&#x7528;&#x573A;&#x666F;"></a>2.3 &#x9002;&#x7528;&#x573A;&#x666F;</h2><ul>
<li><strong>&#x5C01;&#x88C5;&#x6709;&#x7F3A;&#x9677;&#x7684;&#x63A5;&#x53E3;&#x8BBE;&#x8BA1;&#xFF1A;</strong> &#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x4F9D;&#x8D56;&#x7684;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#x5728;&#x63A5;&#x53E3;&#x8BBE;&#x8BA1;&#x65B9;&#x9762;&#x6709;&#x7F3A;&#x9677;&#xFF08;&#x6BD4;&#x5982;&#x5305;&#x542B;&#x5927;&#x91CF;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#xFF09;&#xFF0C;&#x5F15;&#x5165;&#x4E4B;&#x540E;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x6211;&#x4EEC;&#x81EA;&#x8EAB;&#x4EE3;&#x7801;&#x7684;&#x53EF;&#x6D4B;&#x8BD5;&#x6027;&#x3002;&#x4E3A;&#x4E86;&#x9694;&#x79BB;&#x8BBE;&#x8BA1;&#x4E0A;&#x7684;&#x7F3A;&#x9677;&#xFF0C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5BF9;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x63A5;&#x53E3;&#x8FDB;&#x884C;&#x4E8C;&#x6B21;&#x5C01;&#x88C5;&#xFF0C;&#x62BD;&#x8C61;&#x51FA;&#x66F4;&#x597D;&#x7684;&#x63A5;&#x53E3;&#x8BBE;&#x8BA1;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x4E86;&#x3002;</li>
<li><strong>&#x7EDF;&#x4E00;&#x591A;&#x4E2A;&#x7C7B;&#x7684;&#x63A5;&#x53E3;&#x8BBE;&#x8BA1;&#xFF1A;</strong> &#x67D0;&#x4E2A;&#x529F;&#x80FD;&#x7684;&#x5B9E;&#x73B0;&#x4F9D;&#x8D56;&#x591A;&#x4E2A;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#xFF08;&#x6216;&#x8005;&#x8BF4;&#x7C7B;&#xFF09;&#x3002;&#x901A;&#x8FC7;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#xFF0C;&#x5C06;&#x5B83;&#x4EEC;&#x7684;&#x63A5;&#x53E3;&#x9002;&#x914D;&#x4E3A;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6001;&#x7684;&#x7279;&#x6027;&#x6765;&#x590D;&#x7528;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x3002;</li>
<li><strong>&#x66FF;&#x6362;&#x4F9D;&#x8D56;&#x7684;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#xFF1A;</strong> &#x5F53;&#x6211;&#x4EEC;&#x628A;&#x9879;&#x76EE;&#x4E2D;&#x4F9D;&#x8D56;&#x7684;&#x4E00;&#x4E2A;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#x66FF;&#x6362;&#x4E3A;&#x53E6;&#x4E00;&#x4E2A;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5229;&#x7528;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x5BF9;&#x4EE3;&#x7801;&#x7684;&#x6539;&#x52A8;&#x3002;</li>
<li><strong>&#x517C;&#x5BB9;&#x8001;&#x7248;&#x672C;&#x63A5;&#x53E3;&#xFF1A;</strong> &#x5728;&#x505A;&#x7248;&#x672C;&#x5347;&#x7EA7;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x8981;&#x5E9F;&#x5F03;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x76F4;&#x63A5;&#x5C06;&#x5176;&#x5220;&#x9664;&#xFF0C;&#x800C;&#x662F;&#x6682;&#x65F6;&#x4FDD;&#x7559;&#xFF0C;&#x5E76;&#x4E14;&#x6807;&#x6CE8;&#x4E3A; deprecated&#xFF0C;&#x5E76;&#x5C06;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#x59D4;&#x6258;&#x4E3A;&#x65B0;&#x7684;&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x3002;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x597D;&#x5904;&#x662F;&#xFF0C;&#x8BA9;&#x4F7F;&#x7528;&#x5B83;&#x7684;&#x9879;&#x76EE;&#x6709;&#x4E2A;&#x8FC7;&#x6E21;&#x671F;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5F3A;&#x5236;&#x8FDB;&#x884C;&#x4EE3;&#x7801;&#x4FEE;&#x6539;&#x3002;&#x8FD9;&#x4E5F;&#x53EF;&#x4EE5;&#x7C97;&#x7565;&#x5730;&#x770B;&#x4F5C;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x7684;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x573A;&#x666F;&#x3002;</li>
<li><strong>&#x9002;&#x914D;&#x4E0D;&#x540C;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#xFF1A;</strong> &#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x63A5;&#x53E3;&#x7684;&#x9002;&#x914D;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x5B83;&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x5728;&#x4E0D;&#x540C;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#x4E4B;&#x95F4;&#x7684;&#x9002;&#x914D;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x628A;&#x4ECE;&#x4E0D;&#x540C;&#x5F81;&#x4FE1;&#x7CFB;&#x7EDF;&#x62C9;&#x53D6;&#x7684;&#x4E0D;&#x540C;&#x683C;&#x5F0F;&#x7684;&#x5F81;&#x4FE1;&#x6570;&#x636E;&#xFF0C;&#x7EDF;&#x4E00;&#x4E3A;&#x76F8;&#x540C;&#x7684;&#x683C;&#x5F0F;&#xFF0C;&#x4EE5;&#x65B9;&#x4FBF;&#x5B58;&#x50A8;&#x548C;&#x4F7F;&#x7528;&#x3002;&#x518D;&#x6BD4;&#x5982;&#xFF0C;Java &#x4E2D;&#x7684; Arrays.asList() &#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x4F5C;&#x4E00;&#x79CD;&#x6570;&#x636E;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5C06;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#x8F6C;&#x5316;&#x4E3A;&#x96C6;&#x5408;&#x5BB9;&#x5668;&#x7C7B;&#x578B;&#x3002;</li>
</ul>
<h2 id="2-4-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"><a href="#2-4-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;" class="headerlink" title="2.4 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"></a>2.4 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;</h2><p>&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x5206;&#x6210;&#x4E09;&#x7C7B;&#xFF1A;<br><strong>&#x7C7B;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#xFF0C;&#x5BF9;&#x8C61;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#xFF0C;&#x63A5;&#x53E3;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;</strong>&#x3002;</p>
<p><strong>&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#xFF08;Adapter&#xFF09;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x4E3B;&#x8981;&#x89D2;&#x8272;&#x3002;</strong></p>
<ul>
<li>&#x76EE;&#x6807;&#xFF08;Target&#xFF09;&#x63A5;&#x53E3;&#xFF1A;&#x5F53;&#x524D;&#x7CFB;&#x7EDF;&#x4E1A;&#x52A1;&#x6240;&#x671F;&#x5F85;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x662F;&#x62BD;&#x8C61;&#x7C7B;&#x6216;&#x63A5;&#x53E3;&#x3002;</li>
<li>&#x9002;&#x914D;&#x8005;&#xFF08;Adaptee&#xFF09;&#x7C7B;&#xFF1A;&#x5B83;&#x662F;&#x88AB;&#x8BBF;&#x95EE;&#x548C;&#x9002;&#x914D;&#x7684;&#x73B0;&#x5B58;&#x7EC4;&#x4EF6;&#x5E93;&#x4E2D;&#x7684;&#x7EC4;&#x4EF6;&#x63A5;&#x53E3;&#x3002;</li>
<li>&#x9002;&#x914D;&#x5668;&#xFF08;Adapter&#xFF09;&#x7C7B;&#xFF1A;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x8F6C;&#x6362;&#x5668;&#xFF0C;&#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x6216;&#x5F15;&#x7528;&#x9002;&#x914D;&#x8005;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x628A;&#x9002;&#x914D;&#x8005;&#x63A5;&#x53E3;&#x8F6C;&#x6362;&#x6210;&#x76EE;&#x6807;&#x63A5;&#x53E3;&#xFF0C;&#x8BA9;&#x5BA2;&#x6237;&#x6309;&#x76EE;&#x6807;&#x63A5;&#x53E3;&#x7684;&#x683C;&#x5F0F;&#x8BBF;&#x95EE;&#x9002;&#x914D;&#x8005;&#x3002;</li>
</ul>
<h2 id="2-5-&#x4E0A;demo"><a href="#2-5-&#x4E0A;demo" class="headerlink" title="2.5 &#x4E0A;demo"></a>2.5 &#x4E0A;demo</h2><p>&#x8FD9;&#x4E2A;&#x6545;&#x4E8B;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x3002; &#x6D77;&#x76D7;&#x6765;&#x4E86;&#xFF01;&#x6211;&#x4EEC;&#x9700;&#x8981; RowingBoat&#xFF08;&#x5212;&#x8247;&#xFF09; &#x6765;&#x9003;&#x8DD1;&#xFF01;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x8258; FishingBoat&#xFF08;&#x6E14;&#x8239;&#xFF09;&#x548C;&#x6211;&#x4EEC;&#x7684;&#x8239;&#x957F;&#x3002;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x65F6;&#x95F4;&#x53BB;&#x8865;&#x65B0;&#x8239;&#xFF01;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x91CD;&#x7528;&#x8FD9;&#x4E2A;FishingBoat&#xFF08;&#x6E14;&#x8239;&#xFF09;&#x3002;&#x8239;&#x957F;&#x9700;&#x8981;&#x4E00;&#x8258;&#x4ED6;&#x53EF;&#x4EE5;&#x64CD;&#x4F5C;&#x7684;&#x5212;&#x8247;&#x3002;&#x89C4;&#x8303;&#x5728; RowingBoat&#xFF08;&#x5212;&#x8247;&#xFF09; &#x4E2D;&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x4F7F;&#x7528;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x6765;&#x91CD;&#x7528;&#x5B83;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/8fab377586d7d564c82bc3f3edecad61a98aa26fafd54880992590fc66b14e6b" alt="image.png"></p>
<p>RowingBoat&#xFF1A;&#x5BA2;&#x6237;&#x6240;&#x671F;&#x671B;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x4E00;&#x8258;&#x53EF;&#x4EE5;&#x5F00;&#x7684;&#x5212;&#x8247;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface RowingBoat {</span><br><span class="line"></span><br><span class="line">  void row();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Captain&#xFF1A;&#x8239;&#x957F;&#x4F7F;&#x7528; RowingBoat &#x822A;&#x884C;&#x3002; &#x8FD9;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x4E2D;&#x7684;&#x5BA2;&#x6237;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@Setter</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public final class Captain {</span><br><span class="line"></span><br><span class="line">  private RowingBoat rowingBoat;</span><br><span class="line"></span><br><span class="line">  void row() {</span><br><span class="line">    rowingBoat.row();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>FishingBoat&#xFF1A;&#x8BBE;&#x5907;&#x7C7B;&#xFF08;&#x6A21;&#x5F0F;&#x4E2D;&#x7684;&#x9002;&#x914D;&#x5668;&#xFF09;&#x3002;&#x6211;&#x4EEC;&#x60F3;&#x91CD;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#x7528;&#x6E14;&#x8239;&#x822A;&#x884C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">final class FishingBoat {</span><br><span class="line"></span><br><span class="line">  void sail() {</span><br><span class="line">    LOGGER.info(&quot;The fishing boat is sailing&quot;);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>FishingBoatAdapter&#xFF1A; &#x9002;&#x914D;&#x5668;&#x7C7B;&#x3002;&#x5C06;&#x8BBE;&#x5907;&#x63A5;&#x53E3; FishingBoat &#x8C03;&#x6574;&#x4E3A; RowingBoat &#x5BA2;&#x6237;&#x6240;&#x671F;&#x671B;&#x7684;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class FishingBoatAdapter implements RowingBoat {</span><br><span class="line"></span><br><span class="line">  private final FishingBoat boat = new FishingBoat();</span><br><span class="line"></span><br><span class="line">  public final void row() {</span><br><span class="line">    boat.sail();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>App&#xFF1A;&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public final class App {</span><br><span class="line"></span><br><span class="line">  private App() {</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x7A0B;&#x5E8F;&#x5165;&#x53E3;.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(final String[] args) {</span><br><span class="line">    // &#x8239;&#x957F;&#x53EA;&#x80FD;&#x64CD;&#x4F5C;&#x5212;&#x8247;&#xFF0C;&#x4F46;&#x901A;&#x8FC7;&#x9002;&#x914D;&#x5668;&#x4ED6;&#x80FD;&#x591F;</span><br><span class="line">    // &#x4E5F;&#x4F7F;&#x7528;&#x6E14;&#x8239;</span><br><span class="line">    var captain = new Captain(new FishingBoatAdapter());</span><br><span class="line">    captain.row();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong><em>&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x52A0;<a href="https://dev.newban.cn/7238403651021783077">&#x300C;&#x91D1;&#x77F3;&#x8BA1;&#x5212;&#x300D;</a></em></strong></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/5f655cb7552bf5268cb1b27cd6fbf7b6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7238917620850245687.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7238917620850245687.html" itemprop="url">JYM来一篇消息队列-Kafka的干货吧！！！ 一：先来了解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-30T21:39:59+08:00">
                2023-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/b427f5e2c7b8c75f67845c56d09b2ffc1101149cfcf20b343b95e7de4e26d769" alt="image.png"></p>
<h1 id="&#x4E00;&#xFF1A;&#x5148;&#x6765;&#x4E86;&#x89E3;&#x4E0B;&#x6982;&#x5FF5;"><a href="#&#x4E00;&#xFF1A;&#x5148;&#x6765;&#x4E86;&#x89E3;&#x4E0B;&#x6982;&#x5FF5;" class="headerlink" title="&#x4E00;&#xFF1A;&#x5148;&#x6765;&#x4E86;&#x89E3;&#x4E0B;&#x6982;&#x5FF5;"></a>&#x4E00;&#xFF1A;&#x5148;&#x6765;&#x4E86;&#x89E3;&#x4E0B;&#x6982;&#x5FF5;</h1><p>Kafka &#x662F;&#x4E00;&#x79CD;&#x9AD8;&#x541E;&#x5410;&#x91CF;&#x3001;&#x5206;&#x5E03;&#x5F0F;&#x3001;&#x57FA;&#x4E8E;&#x53D1;&#x5E03;/&#x8BA2;&#x9605;&#x7684;&#x6D88;&#x606F;&#x7CFB;&#x7EDF;&#xFF0C;&#x6700;&#x521D;&#x7531; LinkedIn &#x516C;&#x53F8;&#x5F00;&#x53D1;&#xFF0C;&#x4F7F;&#x7528; Scala &#x8BED;&#x8A00;&#x7F16;&#x5199;&#xFF0C;&#x76EE;&#x524D;&#x662F; Apache &#x7684;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#xFF0C;&#x4E5F;&#x662F;&#x76EE;&#x524D;&#x8F83;&#x4E3A;&#x4E3B;&#x6D41;&#x7684;&#x6D88;&#x606F;&#x5217;&#x961F;&#x3002;&#x4F5C;&#x7528;&#x5417;&#x548C;&#x5176;&#x4ED6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x76F8;&#x8BC6;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E; &#x3010;&#x5F02;&#x6B65;&#x3011;&#xFF0C;&#x3010;&#x89E3;&#x8026;&#x3011;&#xFF0C;&#x3010;&#x524A;&#x5CF0;&#x3011;&#x3002;</p>
<h1 id="&#x4E8C;&#xFF1A;Kafka&#x7EC4;&#x6210;"><a href="#&#x4E8C;&#xFF1A;Kafka&#x7EC4;&#x6210;" class="headerlink" title="&#x4E8C;&#xFF1A;Kafka&#x7EC4;&#x6210;"></a>&#x4E8C;&#xFF1A;Kafka&#x7EC4;&#x6210;</h1><ul>
<li><strong>Producer&#xFF1A;</strong>  &#x6D88;&#x606F;&#x751F;&#x4EA7;&#x8005;&#xFF0C;&#x5411; Kafka Broker &#x53D1;&#x6D88;&#x606F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
<li><strong>Consumer&#xFF1A;</strong>  &#x6D88;&#x606F;&#x6D88;&#x8D39;&#x8005;&#xFF0C;&#x4ECE; Kafka Broker &#x53D6;&#x6D88;&#x606F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
<li><strong>Consumer Group&#xFF1A;</strong>  &#x6D88;&#x8D39;&#x8005;&#x7EC4;&#xFF08;CG&#xFF09;&#xFF0C;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x5185;&#x6BCF;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x8D1F;&#x8D23;&#x6D88;&#x8D39;&#x4E0D;&#x540C;&#x5206;&#x533A;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x63D0;&#x9AD8;&#x6D88;&#x8D39;&#x80FD;&#x529B;&#x3002;&#x4E00;&#x4E2A;&#x5206;&#x533A;&#x53EA;&#x80FD;&#x7531;&#x7EC4;&#x5185;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#xFF0C;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x4E4B;&#x95F4;&#x4E92;&#x4E0D;&#x5F71;&#x54CD;&#x3002;&#x6240;&#x6709;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x90FD;&#x5C5E;&#x4E8E;&#x67D0;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#xFF0C;&#x5373;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x662F;&#x903B;&#x8F91;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x8BA2;&#x9605;&#x8005;&#x3002;</li>
<li><strong>Broker&#xFF1A;</strong>  &#x4E00;&#x53F0; Kafka &#x673A;&#x5668;&#x5C31;&#x662F;&#x4E00;&#x4E2A; broker&#x3002;&#x4E00;&#x4E2A;&#x96C6;&#x7FA4;&#x7531;&#x591A;&#x4E2A; broker &#x7EC4;&#x6210;&#x3002;&#x4E00;&#x4E2A; broker &#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x591A;&#x4E2A; topic&#x3002;</li>
<li><strong>Topic&#xFF1A;</strong>  &#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;topic &#x5C06;&#x6D88;&#x606F;&#x5206;&#x7C7B;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x548C;&#x6D88;&#x8D39;&#x8005;&#x9762;&#x5411;&#x7684;&#x662F;&#x540C;&#x4E00;&#x4E2A; topic&#x3002;</li>
<li><strong>Partition&#xFF1A;</strong>  &#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x6269;&#x5C55;&#x6027;&#xFF0C;&#x63D0;&#x9AD8;&#x5E76;&#x53D1;&#x80FD;&#x529B;&#xFF0C;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x5927;&#x7684; topic &#x53EF;&#x4EE5;&#x5206;&#x5E03;&#x5230;&#x591A;&#x4E2A; broker &#xFF08;&#x5373;&#x670D;&#x52A1;&#x5668;&#xFF09;&#x4E0A;&#xFF0C;&#x4E00;&#x4E2A; topic &#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x591A;&#x4E2A; partition&#xFF0C;&#x6BCF;&#x4E2A; partition &#x662F;&#x4E00;&#x4E2A; &#x6709;&#x5E8F;&#x7684;&#x961F;&#x5217;&#x3002;</li>
<li><strong>Replica&#xFF1A;</strong>  &#x526F;&#x672C;&#xFF0C;&#x4E3A;&#x5B9E;&#x73B0;&#x5907;&#x4EFD;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4FDD;&#x8BC1;&#x96C6;&#x7FA4;&#x4E2D;&#x7684;&#x67D0;&#x4E2A;&#x8282;&#x70B9;&#x53D1;&#x751F;&#x6545;&#x969C;&#x65F6;&#xFF0C;&#x8BE5;&#x8282;&#x70B9;&#x4E0A;&#x7684; partition &#x6570;&#x636E;&#x4E0D;&#x4E22;&#x5931;&#xFF0C;&#x4E14; Kafka &#x4ECD;&#x7136;&#x80FD;&#x591F;&#x7EE7;&#x7EED;&#x5DE5;&#x4F5C;&#xFF0C;Kafka &#x63D0;&#x4F9B;&#x4E86;&#x526F;&#x672C;&#x673A;&#x5236;&#xFF0C;&#x4E00;&#x4E2A; topic &#x7684;&#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x90FD;&#x6709;&#x82E5;&#x5E72;&#x4E2A;&#x526F;&#x672C;&#xFF0C;&#x4E00;&#x4E2A; leader &#x548C;&#x82E5;&#x5E72;&#x4E2A; follower&#x3002;</li>
<li><strong>Leader&#xFF1A;</strong>  &#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x591A;&#x4E2A;&#x526F;&#x672C;&#x7684;&#x201C;&#x4E3B;&#x201D;&#x526F;&#x672C;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x6570;&#x636E;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x53CA;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x6570;&#x636E;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x90FD;&#x662F; leader&#x3002;</li>
<li><strong>Follower&#xFF1A;</strong>  &#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x591A;&#x4E2A;&#x526F;&#x672C;&#x7684;&#x201C;&#x4ECE;&#x201D;&#x526F;&#x672C;&#xFF0C;&#x5B9E;&#x65F6;&#x4ECE; leader &#x4E2D;&#x540C;&#x6B65;&#x6570;&#x636E;&#xFF0C;&#x4FDD;&#x6301;&#x548C; leader &#x6570;&#x636E;&#x7684;&#x540C;&#x6B65;&#x3002;leader &#x53D1;&#x751F;&#x6545;&#x969C;&#x65F6;&#xFF0C;&#x67D0;&#x4E2A; follower &#x8FD8;&#x4F1A;&#x6210;&#x4E3A;&#x65B0;&#x7684; leader&#x3002;</li>
<li><strong>offset&#xFF1A;</strong>  &#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x7684;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x76D1;&#x63A7;&#x6570;&#x636E;&#x6D88;&#x8D39;&#x5230;&#x4EC0;&#x4E48;&#x4F4D;&#x7F6E;&#xFF0C;&#x5F53;&#x6D88;&#x8D39;&#x8005;&#x6302;&#x6389;&#x518D;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x6D88;&#x8D39;&#x4F4D;&#x7F6E;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;&#x3002;</li>
<li><strong>Zookeeper&#xFF1A;</strong>  Kafka &#x96C6;&#x7FA4;&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#xFF0C;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E; zookeeper&#xFF0C;zookeeper &#x5E2E;&#x52A9; Kafka &#x5B58;&#x50A8;&#x548C;&#x7BA1;&#x7406;&#x96C6;&#x7FA4;&#x4FE1;&#x606F;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/e7884d6d61604d1f4bcd4278c59fb174eeb721bc031c3167115cb7da52855107" alt="kafka&#x96C6;&#x7FA4;1.png"></p>
<h1 id="&#x4E09;&#xFF1A;Kafka-&#x6570;&#x636E;&#x5B58;&#x50A8;&#x8BBE;&#x8BA1;"><a href="#&#x4E09;&#xFF1A;Kafka-&#x6570;&#x636E;&#x5B58;&#x50A8;&#x8BBE;&#x8BA1;" class="headerlink" title="&#x4E09;&#xFF1A;Kafka &#x6570;&#x636E;&#x5B58;&#x50A8;&#x8BBE;&#x8BA1;"></a>&#x4E09;&#xFF1A;Kafka &#x6570;&#x636E;&#x5B58;&#x50A8;&#x8BBE;&#x8BA1;</h1><h2 id="3-1-partition-&#x7684;&#x6570;&#x636E;&#x6587;&#x4EF6;&#xFF08;offset&#xFF0C;MessageSize&#xFF0C;data&#xFF09;"><a href="#3-1-partition-&#x7684;&#x6570;&#x636E;&#x6587;&#x4EF6;&#xFF08;offset&#xFF0C;MessageSize&#xFF0C;data&#xFF09;" class="headerlink" title="3.1. partition &#x7684;&#x6570;&#x636E;&#x6587;&#x4EF6;&#xFF08;offset&#xFF0C;MessageSize&#xFF0C;data&#xFF09;"></a>3.1. partition &#x7684;&#x6570;&#x636E;&#x6587;&#x4EF6;&#xFF08;offset&#xFF0C;MessageSize&#xFF0C;data&#xFF09;</h2><p>partition &#x4E2D;&#x7684;&#x6BCF;&#x6761; Message &#x5305;&#x542B;&#x4E86;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x5C5E;&#x6027;&#xFF1A;offset&#xFF0C;MessageSize&#xFF0C;data&#xFF0C;&#x5176;&#x4E2D; offset &#x8868; &#x793A; Message &#x5728;&#x8FD9;&#x4E2A; partition &#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF;&#xFF0C;offset &#x4E0D;&#x662F;&#x8BE5; Message &#x5728; partition &#x6570;&#x636E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x5B9E; 13/04/2018 Page 176 of 283 &#x9645;&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF0C;&#x800C;&#x662F;&#x903B;&#x8F91;&#x4E0A;&#x4E00;&#x4E2A;&#x503C;&#xFF0C;&#x5B83;&#x552F;&#x4E00;&#x786E;&#x5B9A;&#x4E86; partition &#x4E2D;&#x7684;&#x4E00;&#x6761; Message&#xFF0C;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A; offset &#x662F; partition &#x4E2D; Message &#x7684; id&#xFF1B;MessageSize &#x8868;&#x793A;&#x6D88;&#x606F;&#x5185;&#x5BB9; data &#x7684;&#x5927;&#x5C0F;&#xFF1B;data &#x4E3A; Message &#x7684;&#x5177; &#x4F53;&#x5185;&#x5BB9;&#x3002;</p>
<h2 id="3-2-&#x6570;&#x636E;&#x6587;&#x4EF6;&#x5206;&#x6BB5;-segment&#xFF08;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x3001;&#x5206;&#x6BB5;&#x547D;&#x4EE4;&#x3001;&#x4E8C;&#x5206;&#x67E5;&#x627E;&#xFF09;"><a href="#3-2-&#x6570;&#x636E;&#x6587;&#x4EF6;&#x5206;&#x6BB5;-segment&#xFF08;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x3001;&#x5206;&#x6BB5;&#x547D;&#x4EE4;&#x3001;&#x4E8C;&#x5206;&#x67E5;&#x627E;&#xFF09;" class="headerlink" title="3.2 &#x6570;&#x636E;&#x6587;&#x4EF6;&#x5206;&#x6BB5; segment&#xFF08;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x3001;&#x5206;&#x6BB5;&#x547D;&#x4EE4;&#x3001;&#x4E8C;&#x5206;&#x67E5;&#x627E;&#xFF09;"></a>3.2 &#x6570;&#x636E;&#x6587;&#x4EF6;&#x5206;&#x6BB5; segment&#xFF08;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x3001;&#x5206;&#x6BB5;&#x547D;&#x4EE4;&#x3001;&#x4E8C;&#x5206;&#x67E5;&#x627E;&#xFF09;</h2><p>partition &#x7269;&#x7406;&#x4E0A;&#x7531;&#x591A;&#x4E2A; segment &#x6587;&#x4EF6;&#x7EC4;&#x6210;&#xFF0C;&#x6BCF;&#x4E2A; segment &#x5927;&#x5C0F;&#x76F8;&#x7B49;&#xFF0C;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x3002;&#x6BCF;&#x4E2A; segment &#x6570;&#x636E;&#x6587;&#x4EF6;&#x4EE5;&#x8BE5;&#x6BB5;&#x4E2D;&#x6700;&#x5C0F;&#x7684; offset &#x547D;&#x540D;&#xFF0C;&#x6587;&#x4EF6;&#x6269;&#x5C55;&#x540D;&#x4E3A;.log&#x3002;&#x8FD9;&#x6837;&#x5728;&#x67E5;&#x627E;&#x6307;&#x5B9A; offset &#x7684; Message &#x7684; &#x65F6;&#x5019;&#xFF0C;&#x7528;&#x4E8C;&#x5206;&#x67E5;&#x627E;&#x5C31;&#x53EF;&#x4EE5;&#x5B9A;&#x4F4D;&#x5230;&#x8BE5; Message &#x5728;&#x54EA;&#x4E2A; segment &#x6570;&#x636E;&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<h2 id="3-3-&#x6570;&#x636E;&#x6587;&#x4EF6;&#x7D22;&#x5F15;&#xFF08;&#x5206;&#x6BB5;&#x7D22;&#x5F15;&#x3001;&#x7A00;&#x758F;&#x5B58;&#x50A8;&#xFF09;"><a href="#3-3-&#x6570;&#x636E;&#x6587;&#x4EF6;&#x7D22;&#x5F15;&#xFF08;&#x5206;&#x6BB5;&#x7D22;&#x5F15;&#x3001;&#x7A00;&#x758F;&#x5B58;&#x50A8;&#xFF09;" class="headerlink" title="3.3 &#x6570;&#x636E;&#x6587;&#x4EF6;&#x7D22;&#x5F15;&#xFF08;&#x5206;&#x6BB5;&#x7D22;&#x5F15;&#x3001;&#x7A00;&#x758F;&#x5B58;&#x50A8;&#xFF09;"></a>3.3 &#x6570;&#x636E;&#x6587;&#x4EF6;&#x7D22;&#x5F15;&#xFF08;&#x5206;&#x6BB5;&#x7D22;&#x5F15;&#x3001;&#x7A00;&#x758F;&#x5B58;&#x50A8;&#xFF09;</h2><p>Kafka &#x4E3A;&#x6BCF;&#x4E2A;&#x5206;&#x6BB5;&#x540E;&#x7684;&#x6570;&#x636E;&#x6587;&#x4EF6;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;&#x6587;&#x4EF6;&#xFF0C;&#x6587;&#x4EF6;&#x540D;&#x4E0E;&#x6570;&#x636E;&#x6587;&#x4EF6;&#x7684;&#x540D;&#x5B57;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EA;&#x662F;&#x6587;&#x4EF6;&#x6269; &#x5C55;&#x540D;&#x4E3A;.index&#x3002;index &#x6587;&#x4EF6;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x4E3A;&#x6570;&#x636E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x6BCF;&#x6761; Message &#x5EFA;&#x7ACB;&#x7D22;&#x5F15;&#xFF0C;&#x800C;&#x662F;&#x91C7;&#x7528;&#x4E86;&#x7A00;&#x758F;&#x5B58; &#x50A8;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x6BCF;&#x9694;&#x4E00;&#x5B9A;&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x5EFA;&#x7ACB;&#x4E00;&#x6761;&#x7D22;&#x5F15;&#x3002;&#x8FD9;&#x6837;&#x907F;&#x514D;&#x4E86;&#x7D22;&#x5F15;&#x6587;&#x4EF6;&#x5360;&#x7528;&#x8FC7;&#x591A;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x4ECE;&#x800C;&#x53EF;&#x4EE5; &#x5C06;&#x7D22;&#x5F15;&#x6587;&#x4EF6;&#x4FDD;&#x7559;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/c411b88a3b1f2ed85cde5bfc4727354989799c9bf942139901a5f899c691ebe0" alt="image.png"></p>
<h1 id="&#x56DB;&#xFF1A;&#x751F;&#x4EA7;&#x8005;&#x8BBE;&#x8BA1;"><a href="#&#x56DB;&#xFF1A;&#x751F;&#x4EA7;&#x8005;&#x8BBE;&#x8BA1;" class="headerlink" title="&#x56DB;&#xFF1A;&#x751F;&#x4EA7;&#x8005;&#x8BBE;&#x8BA1;"></a>&#x56DB;&#xFF1A;&#x751F;&#x4EA7;&#x8005;&#x8BBE;&#x8BA1;</h1><h2 id="4-1-&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF08;partition-&#x4F1A;&#x5747;&#x8861;&#x5206;&#x5E03;&#x5230;&#x4E0D;&#x540C;-broker-&#x4E0A;&#xFF09;"><a href="#4-1-&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF08;partition-&#x4F1A;&#x5747;&#x8861;&#x5206;&#x5E03;&#x5230;&#x4E0D;&#x540C;-broker-&#x4E0A;&#xFF09;" class="headerlink" title="4.1 &#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF08;partition &#x4F1A;&#x5747;&#x8861;&#x5206;&#x5E03;&#x5230;&#x4E0D;&#x540C; broker &#x4E0A;&#xFF09;"></a>4.1 &#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF08;partition &#x4F1A;&#x5747;&#x8861;&#x5206;&#x5E03;&#x5230;&#x4E0D;&#x540C; broker &#x4E0A;&#xFF09;</h2><p>&#x7531;&#x4E8E;&#x6D88;&#x606F; topic &#x7531;&#x591A;&#x4E2A; partition &#x7EC4;&#x6210;&#xFF0C;&#x4E14; partition &#x4F1A;&#x5747;&#x8861;&#x5206;&#x5E03;&#x5230;&#x4E0D;&#x540C; broker &#x4E0A;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x4E3A;&#x4E86;&#x6709; &#x6548;&#x5229;&#x7528; broker &#x96C6;&#x7FA4;&#x7684;&#x6027;&#x80FD;&#xFF0C;&#x63D0;&#x9AD8;&#x6D88;&#x606F;&#x7684;&#x541E;&#x5410;&#x91CF;&#xFF0C;producer &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x968F;&#x673A;&#x6216;&#x8005; hash &#x7B49;&#x65B9;&#x5F0F;&#xFF0C;&#x5C06;&#x6D88; &#x606F;&#x5E73;&#x5747;&#x53D1;&#x9001;&#x5230;&#x591A;&#x4E2A; partition &#x4E0A;&#xFF0C;&#x4EE5;&#x5B9E;&#x73B0;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/8166badce31200f99a8f9898867c97b8aaa208c0040aae987773ed2e380a9f2a" alt="image.png"></p>
<h2 id="4-2-&#x6279;&#x91CF;&#x53D1;&#x9001;"><a href="#4-2-&#x6279;&#x91CF;&#x53D1;&#x9001;" class="headerlink" title="4.2 &#x6279;&#x91CF;&#x53D1;&#x9001;"></a>4.2 &#x6279;&#x91CF;&#x53D1;&#x9001;</h2><p>&#x662F;&#x63D0;&#x9AD8;&#x6D88;&#x606F;&#x541E;&#x5410;&#x91CF;&#x91CD;&#x8981;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;Producer &#x7AEF;&#x53EF;&#x4EE5;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x5408;&#x5E76;&#x591A;&#x6761;&#x6D88;&#x606F;&#x540E;&#xFF0C;&#x4EE5;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x5F0F;&#x53D1; &#x9001;&#x4E86;&#x6279;&#x91CF;&#x7684;&#x6D88;&#x606F;&#x7ED9; broker&#xFF0C;&#x4ECE;&#x800C;&#x5927;&#x5927;&#x51CF;&#x5C11; broker &#x5B58;&#x50A8;&#x6D88;&#x606F;&#x7684; IO &#x64CD;&#x4F5C;&#x6B21;&#x6570;&#x3002;&#x4F46;&#x4E5F;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x4E0A;&#x5F71;&#x54CD; &#x4E86;&#x6D88;&#x606F;&#x7684;&#x5B9E;&#x65F6;&#x6027;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4EE5;&#x65F6;&#x5EF6;&#x4EE3;&#x4EF7;&#xFF0C;&#x6362;&#x53D6;&#x66F4;&#x597D;&#x7684;&#x541E;&#x5410;&#x91CF;&#x3002;</p>
<h2 id="4-3-&#x538B;&#x7F29;&#xFF08;GZIP-&#x6216;-Snappy&#xFF09;"><a href="#4-3-&#x538B;&#x7F29;&#xFF08;GZIP-&#x6216;-Snappy&#xFF09;" class="headerlink" title="4.3 &#x538B;&#x7F29;&#xFF08;GZIP &#x6216; Snappy&#xFF09;"></a>4.3 &#x538B;&#x7F29;&#xFF08;GZIP &#x6216; Snappy&#xFF09;</h2><p>Producer &#x7AEF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; GZIP &#x6216; Snappy &#x683C;&#x5F0F;&#x5BF9;&#x6D88;&#x606F;&#x96C6;&#x5408;&#x8FDB;&#x884C;&#x538B;&#x7F29;&#x3002;Producer &#x7AEF;&#x8FDB;&#x884C;&#x538B;&#x7F29;&#x4E4B;&#x540E;&#xFF0C;&#x5728; Consumer &#x7AEF;&#x9700;&#x8FDB;&#x884C;&#x89E3;&#x538B;&#x3002;&#x538B;&#x7F29;&#x7684;&#x597D;&#x5904;&#x5C31;&#x662F;&#x51CF;&#x5C11;&#x4F20;&#x8F93;&#x7684;&#x6570;&#x636E;&#x91CF;&#xFF0C;&#x51CF;&#x8F7B;&#x5BF9;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;&#x7684;&#x538B;&#x529B;&#xFF0C;&#x5728;&#x5BF9;&#x5927; &#x6570;&#x636E;&#x5904;&#x7406;&#x4E0A;&#xFF0C;&#x74F6;&#x9888;&#x5F80;&#x5F80;&#x4F53;&#x73B0;&#x5728;&#x7F51;&#x7EDC;&#x4E0A;&#x800C;&#x4E0D;&#x662F; CPU&#xFF08;&#x538B;&#x7F29;&#x548C;&#x89E3;&#x538B;&#x4F1A;&#x8017;&#x6389;&#x90E8;&#x5206; CPU &#x8D44;&#x6E90;&#xFF09;&#x3002;</p>
<h1 id="&#x4E94;&#xFF1A;&#x6D88;&#x8D39;&#x8005;&#x8BBE;&#x8BA1;"><a href="#&#x4E94;&#xFF1A;&#x6D88;&#x8D39;&#x8005;&#x8BBE;&#x8BA1;" class="headerlink" title="&#x4E94;&#xFF1A;&#x6D88;&#x8D39;&#x8005;&#x8BBE;&#x8BA1;"></a>&#x4E94;&#xFF1A;&#x6D88;&#x8D39;&#x8005;&#x8BBE;&#x8BA1;</h1><p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/018e1256acdcb66bb4e67143ed9b9b8b93657319744243649f76ce13022e8c57" alt="image.png"></p>
<h2 id="5-1-Consumer-Group"><a href="#5-1-Consumer-Group" class="headerlink" title="5.1 Consumer Group"></a>5.1 Consumer Group</h2><p>&#x540C;&#x4E00; Consumer Group &#x4E2D;&#x7684;&#x591A;&#x4E2A; Consumer &#x5B9E;&#x4F8B;&#xFF0C;&#x4E0D;&#x540C;&#x65F6;&#x6D88;&#x8D39;&#x540C;&#x4E00;&#x4E2A; partition&#xFF0C;&#x7B49;&#x6548;&#x4E8E;&#x961F;&#x5217;&#x6A21; &#x5F0F;&#x3002;partition &#x5185;&#x6D88;&#x606F;&#x662F;&#x6709;&#x5E8F;&#x7684;&#xFF0C;Consumer &#x901A;&#x8FC7; pull &#x65B9;&#x5F0F;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x3002;Kafka &#x4E0D;&#x5220;&#x9664;&#x5DF2;&#x6D88;&#x8D39;&#x7684;&#x6D88;&#x606F; &#x5BF9;&#x4E8E; partition&#xFF0C;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#x78C1;&#x76D8;&#x6570;&#x636E;&#xFF0C;&#x4EE5;&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6; O(1)&#x65B9;&#x5F0F;&#x63D0;&#x4F9B;&#x6D88;&#x606F;&#x6301;&#x4E45;&#x5316;&#x80FD;&#x529B;&#x3002;</p>
<h1 id="&#x516D;-&#x6570;&#x636E;&#x53EF;&#x9760;&#x6027;"><a href="#&#x516D;-&#x6570;&#x636E;&#x53EF;&#x9760;&#x6027;" class="headerlink" title="&#x516D;:&#x6570;&#x636E;&#x53EF;&#x9760;&#x6027;"></a>&#x516D;:&#x6570;&#x636E;&#x53EF;&#x9760;&#x6027;</h1><h2 id="6-1-ack&#x673A;&#x5236;"><a href="#6-1-ack&#x673A;&#x5236;" class="headerlink" title="6.1 ack&#x673A;&#x5236;"></a>6.1 ack&#x673A;&#x5236;</h2><p>&#x4E3A;&#x4FDD;&#x8BC1;producer &#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x4E22;&#x5931;&#xFF0C;broker &#x63A5;&#x6536;&#x5230;&#x6570;&#x636E;&#x540E;&#x90FD;&#x9700;&#x8981;&#x5BF9;producer&#x53D1;&#x9001;ack(&#x786E;&#x8BA4;&#x63A5;&#x6536;) &#xFF0C;&#x5982;&#x679C;producer &#x672A;&#x6536;&#x5230;ack&#x5219;&#x4F1A;&#x91CD;&#x65B0;&#x53D1;&#x9001;&#x8BE5;&#x6761;&#x6D88;&#x606F;&#x3002;producer &#x7684; ack &#x7B56;&#x7565;&#x53C8;&#x5206;&#x4E3A;&#x4E09;&#x79CD;&#xFF1A;</p>
<ul>
<li>ack=0 producer&#x4E0D;&#x7B49;&#x5F85;broker&#x540C;&#x6B65;&#x5B8C;&#x6210;&#x7684;&#x786E;&#x8BA4;&#xFF0C;&#x7EE7;&#x7EED;&#x53D1;&#x9001;&#x4E0B;&#x4E00;&#x6761;(&#x6279;)&#x4FE1;&#x606F;</li>
<li>ack=1 producer&#x8981;&#x7B49;&#x5F85;leader&#x6210;&#x529F;&#x6536;&#x5230;&#x6570;&#x636E;&#x5E76;&#x5F97;&#x5230;&#x786E;&#x8BA4;&#xFF0C;&#x624D;&#x53D1;&#x9001;&#x4E0B;&#x4E00;&#x6761;message&#x3002;</li>
<li>ack=-1 producer&#x5F97;&#x5230;follwer&#x786E;&#x8BA4;(&#x5168;&#x526F;&#x672C;&#x540C;&#x6B65;&#x5B8C;&#x6210;)&#xFF0C;&#x624D;&#x53D1;&#x9001;&#x4E0B;&#x4E00;&#x6761;&#x6570;&#x636E;</li>
</ul>
<h2 id="6-2-ISR-&#xFF08;&#x540C;&#x6B65;&#x526F;&#x672C;&#x8868;&#xFF09;"><a href="#6-2-ISR-&#xFF08;&#x540C;&#x6B65;&#x526F;&#x672C;&#x8868;&#xFF09;" class="headerlink" title="6.2 ISR &#xFF08;&#x540C;&#x6B65;&#x526F;&#x672C;&#x8868;&#xFF09;"></a>6.2 ISR &#xFF08;&#x540C;&#x6B65;&#x526F;&#x672C;&#x8868;&#xFF09;</h2><blockquote>
<p>&#x91C7;&#x7528;&#x5168;&#x526F;&#x672C;&#x540C;&#x6B65;&#x5B8C;&#x6210;&#x518D;ack&#x4F1A;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<p>&#x5F53;leader &#x63A5;&#x6536;&#x5B8C;&#x6570;&#x636E;&#xFF0C;&#x6240;&#x6709;&#x7684;follower&#x5F00;&#x59CB;&#x540C;&#x6B65;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x4E00;&#x65E6;&#x6709;&#x4E00;&#x4E2A;follower&#x4E0D;&#x80FD;&#x4E0E;leader&#x8FDB;&#x884C;&#x540C;&#x6B65;&#xFF0C;&#x90A3;leader&#x4F1A;&#x4E00;&#x76F4;&#x7B49;&#x4E0B;&#x53BB;&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x975E;&#x5E38;&#x7684;&#x6D6A;&#x8D39;&#x65F6;&#x95F4;&#x3002;  </p>
<p>&#x4E3A;&#x6B64;kafka&#x5F15;&#x5165;&#x4E86; isr &#x673A;&#x5236;&#x2014;&#x2014;leader&#x4F1A;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x7684; isr&#xFF08;in-sync replica set&#xFF09;&#x5217;&#x8868;&#xFF0C;&#x8FD9;&#x4E2A;&#x5217;&#x8868;&#x7EF4;&#x62A4;&#x4E86;&#x548C;leader&#x4FDD;&#x6301;&#x540C;&#x6B65;&#x7684;&#x96C6;&#x5408;&#x3002;&#x5F53;ISR&#x4E2D;&#x7684;follower&#x5B8C;&#x6210;&#x6570;&#x636E;&#x7684;&#x540C;&#x6B65;&#x4E4B;&#x540E;&#xFF0C;leader&#x5C31;&#x4F1A;&#x53D1;&#x9001;ack&#x3002;&#x5982;&#x679C;follower &#x957F;&#x65F6;&#x95F4;&#x672A;&#x5411;leader&#x540C;&#x6B65;&#x6570;&#x636E;&#xFF0C;&#x5219;&#x8BE5;follower&#x5C06;&#x4F1A;&#x88AB;&#x8E22;&#x51FA; isr&#xFF0C;&#x5F53;&#x5176;&#x4ED6;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;follower&#x4E5F;&#x4F1A;&#x88AB;&#x52A0;&#x5165;&#x5230;isr&#x3002;&#x8FD9;&#x4E2A;&#x540C;&#x6B65;&#x6700;&#x5927;&#x65F6;&#x95F4;&#x914D;&#x7F6E;&#x9879;&#x4E3A;<code>replica.lag.time.max.ms</code> &#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x3002;&#x5982;&#x679C;leader&#x6545;&#x969C;&#x4E86;&#xFF0C;&#x4E5F;&#x4F1A;&#x4ECE;isr&#x7684;follower&#x4E2D;&#x9009;&#x4E3E;&#x65B0;&#x7684;leader&#x3002;</p>
</blockquote>
<h2 id="6-3-&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#x89E3;&#x51B3;"><a href="#6-3-&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#x89E3;&#x51B3;" class="headerlink" title="6.3 &#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#x89E3;&#x51B3;"></a>6.3 &#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#x89E3;&#x51B3;</h2><p>&#x56E0;&#x4E3A;&#x526F;&#x672C;&#x7684;&#x6D88;&#x606F;&#x6570;&#x5728;&#x5404;&#x4E2A;&#x4E4B;&#x95F4;&#x662F;&#x5B58;&#x5728;&#x5DEE;&#x5F02;&#x7684;&#xFF0C;&#x53EF;&#x80FD;leader10&#x6761;&#xFF0C;&#x800C;follower&#x53EA;&#x540C;&#x6B65;&#x4E86;8&#x6761;&#xFF1B;&#x5F53;leader&#x6302;&#x6389;&#xFF0C;&#x6570;&#x636E;&#x5C31;&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x751F;&#x4E22;&#x5931;&#xFF0C;&#x901A;&#x8FC7;&#x4E00;&#x79CD;&#x673A;&#x5236;&#x6765;&#x4FDD;&#x8BC1;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x6570;&#x636E;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x5C31;&#x5F88;&#x6709;&#x5FC5;&#x8981;&#x4E86;&#x3002;kafka&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#x901A;&#x8FC7; LEO&#xFF08;&#x6BCF;&#x4E2A;&#x526F;&#x672C;&#x7684;&#x6700;&#x540E;&#x4E00;&#x6761;offset&#xFF09;&#x548C;HW&#xFF08;&#x6240;&#x6709;&#x7684;LEO&#x4E2D;&#x6700;&#x5C0F;&#x7684;&#x90A3;&#x4E2A;&#xFF09;&#x6765;&#x4FDD;&#x8BC1;&#x3002;&#x793A;&#x610F;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/cb66ab3eaf646a17b17ef5c24bd3cb66df880edebc2efa6e29992e877adc00c5" alt="image.png"></p>
<p>&#x6D88;&#x8D39;&#x8005;&#x53EA;&#x80FD;&#x770B;&#x5230;offset&lt;=HW &#x7684;&#x6D88;&#x606F;&#x3002;</p>
<h1 id="&#x4E03;&#xFF1A;&#x6D88;&#x8D39;&#x673A;&#x5236;"><a href="#&#x4E03;&#xFF1A;&#x6D88;&#x8D39;&#x673A;&#x5236;" class="headerlink" title="&#x4E03;&#xFF1A;&#x6D88;&#x8D39;&#x673A;&#x5236;"></a>&#x4E03;&#xFF1A;&#x6D88;&#x8D39;&#x673A;&#x5236;</h1><h2 id="7-1-&#x6D88;&#x8D39;&#x7B56;&#x7565;"><a href="#7-1-&#x6D88;&#x8D39;&#x7B56;&#x7565;" class="headerlink" title="7.1 &#x6D88;&#x8D39;&#x7B56;&#x7565;"></a>7.1 &#x6D88;&#x8D39;&#x7B56;&#x7565;</h2><p>kafka &#x5BF9;&#x6D88;&#x606F;&#x6D88;&#x8D39;&#x7684;&#x5904;&#x7406;&#x6709;&#x4E09;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ul>
<li>&#xFF08;at least once&#xFF09;&#x81F3;&#x5C11;&#x4E00;&#x6B21;</li>
<li>(at most once)&#x81F3;&#x591A;&#x4E00;&#x6B21;</li>
<li>(exactly once) &#x6709;&#x4E14;&#x53EA;&#x6709;&#x4E00;&#x6B21;</li>
</ul>
<p>&#x56E0;&#x4E3A;ack&#x673A;&#x5236;&#x7684;&#x5B58;&#x5728;&#xFF0C;producer &#x5411;kafka&#x53D1;&#x9001;&#x6D88;&#x606F;&#x65F6;&#x5982;&#x679C; ack=0&#xFF0C;&#x7531;&#x4E8E;producer&#x4E0D;&#x7B49;&#x786E;&#x8BA4;&#x6D88;&#x606F;&#x662F;&#x5426;&#x6295;&#x9012;&#x6210;&#x529F;&#x5C31;&#x4E0D;&#x7BA1;&#x4E86; &#xFF0C;&#x53EF;&#x80FD;&#x4E22;&#x5931;&#x6570;&#x636E;&#xFF0C;&#x6B64;&#x65F6;&#x6D88;&#x8D39;&#x8005;&#x6700;&#x591A;&#x6D88;&#x8D39;&#x4E00;&#x6B21;&#x6D88;&#x606F;&#xFF1B;&#x5982;&#x679C;ack=1&#xFF0C;&#x5F53;producer&#x672A;&#x6536;&#x5230;&#x6D88;&#x606F;&#x786E;&#x8BA4;&#x6295;&#x9012;&#x6210;&#x529F;&#x65F6;&#x4F1A;&#x518D;&#x6B21;&#x6295;&#x9012;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x53EF;&#x80FD;&#x6D88;&#x606F;&#x88AB;&#x6295;&#x9012;&#x4E86;&#x591A;&#x6B21;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x5B58;&#x5728;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x5F53;kafka&#x5F00;&#x542F;&#x6570;&#x636E;&#x5E42;&#x7B49;&#x6027;&#x4E14;ack=1&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6B64;&#x65F6;&#x91CD;&#x590D;&#x7684;&#x6D88;&#x606F;&#x4F1A;&#x88AB;&#x53BB;&#x91CD;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x7684;&#x60C5;&#x51B5;&#x3002;  </p>
<p>&#x542F;&#x7528;&#x5E42;&#x7B49;&#x6027;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x5C06;producer&#x4E2D;&#x7684;&#x53C2;&#x6570; <code>enable.idompotence</code> &#x8BBE;&#x7F6E;&#x4E3A;true&#x3002;</p>
<h2 id="7-2-&#x6D88;&#x8D39;&#x8005;&#x76F8;&#x5173;&#x7279;&#x6027;"><a href="#7-2-&#x6D88;&#x8D39;&#x8005;&#x76F8;&#x5173;&#x7279;&#x6027;" class="headerlink" title="7.2 &#x6D88;&#x8D39;&#x8005;&#x76F8;&#x5173;&#x7279;&#x6027;"></a>7.2 &#x6D88;&#x8D39;&#x8005;&#x76F8;&#x5173;&#x7279;&#x6027;</h2><p>&#x548C;rabbitMQ&#x4E00;&#x6837;&#xFF0C;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x662F;&#x63A8;&#x6A21;&#x5F0F;&#x8FD8;&#x662F;&#x62C9;&#x6A21;&#x5F0F;&#x3002;&#x5728;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x4E2D;&#xFF0C;&#x6709;&#x591A;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#xFF0C;&#x4E00;&#x4E2A;topic&#x4E2D;&#x6709;&#x591A;&#x4E2A;partition&#x3002;&#x90A3;&#x4E48;&#x6D88;&#x606F;&#x7684;&#x5206;&#x914D;&#x662F;&#x600E;&#x4E48;&#x6837;&#x7684;&#x5462;&#xFF0C;&#x9996;&#x5148;&#x4E00;&#x4E2A;&#x6D88;&#x8D39;&#x8005;&#x7EC4;&#x4E2D;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x4E0D;&#x80FD;&#x540C;&#x65F6;&#x6D88;&#x8D39;&#x540C;&#x4E00;&#x4E2A;partition&#xFF0C;&#x8FD9;&#x662F;&#x57FA;&#x672C;&#x539F;&#x5219;&#x3002; &#x7136;&#x540E;partiotion&#x7684;&#x5206;&#x914D;&#x673A;&#x5236;&#x6709;&#x4E24;&#x79CD;&#xFF0C;&#x4E00;&#x79CD;&#x662F;range&#xFF08;&#x8303;&#x56F4;&#xFF09; &#x4E00;&#x79CD;&#x662F; RoundRobin&#xFF08;&#x8F6E;&#x8BE2;&#xFF09;&#xFF0C;range&#x793A; &#x610F;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/d28235d311c0caa20f9a2c627f3affdff6a2a86869ef73a1f19425763f697c42" alt="image.png"></p>
<p>RoundRobin &#x793A;&#x610F;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/1fe92dc421bd11cc531ac2f567d82c42282ef9b8c647f942664d6f87156b7e64" alt="image.png"></p>
<p>&#x7531;&#x4E8E;consumer&#x4E5F;&#x53EF;&#x80FD;&#x4F1A;&#x5B95;&#x673A;&#x6302;&#x6389;&#x7684;&#x98CE;&#x9669;&#xFF0C;&#x5F53;consumer&#x6062;&#x590D;&#x7684;&#x65F6;&#x5019;&#x5FC5;&#x987B;&#x8981;&#x80FD;&#x591F;&#x4ECE;&#x4E0A;&#x4E00;&#x6B21;&#x6D88;&#x8D39;&#x7684;&#x5730;&#x65B9;&#x91CD;&#x65B0;&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x3002;&#x6240;&#x4EE5;consumer&#x9700;&#x8981;&#x5B9E;&#x65F6;&#x8BB0;&#x5F55;&#x81EA;&#x5DF1;&#x6D88;&#x8D39;&#x5230;&#x4E86;&#x54EA;&#x4E00;&#x4E2A;offset&#xFF0C;&#x4EE5;&#x4FBF;&#x80FD;&#x591F;&#x6062;&#x590D;&#x5230;&#x5B95;&#x673A;&#x524D;&#x72B6;&#x6001;&#x3002;</p>
<h1 id="&#x516B;&#xFF1A;&#x4E00;&#x4E9B;&#x7591;&#x95EE;"><a href="#&#x516B;&#xFF1A;&#x4E00;&#x4E9B;&#x7591;&#x95EE;" class="headerlink" title="&#x516B;&#xFF1A;&#x4E00;&#x4E9B;&#x7591;&#x95EE;"></a>&#x516B;&#xFF1A;&#x4E00;&#x4E9B;&#x7591;&#x95EE;</h1><h2 id="8-1-kafka&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x4FDD;&#x8BC1;"><a href="#8-1-kafka&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x4FDD;&#x8BC1;" class="headerlink" title="8.1 kafka&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x4FDD;&#x8BC1;"></a>8.1 kafka&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x4FDD;&#x8BC1;</h2><blockquote>
<p>kafka&#x7684;producer&#x751F;&#x4EA7;&#x6570;&#x636E;&#xFF0C;&#x8981;&#x4EE5;&#x8FFD;&#x52A0;&#x7684;&#x5F62;&#x5F0F;&#x5199;&#x5165;&#x5230;log&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x5199;&#x78C1;&#x76D8;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x987A;&#x5E8F;&#x5199;&#xFF0C;&#x76F8;&#x5BF9;&#x4E8E;&#x78C1;&#x76D8;&#x7684;&#x968F;&#x673A;&#x5199;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x6548;&#x7387;&#x8981;&#x9AD8;&#x51FA;&#x5F88;&#x591A;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;kafka&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x7684;&#x4FDD;&#x8BC1;&#x4E4B;&#x4E00;&#x3002;&#x800C;&#x53E6;&#x5916;&#x7684;&#x4E00;&#x4E2A;&#x4FDD;&#x8BC1;&#x9AD8;&#x6548;&#x8BFB;&#x5199;&#x7684;&#x6280;&#x672F;&#x662F;&#x96F6;&#x62F7;&#x8D1D;&#xFF0C;&#x7528;&#x8FC7;netty&#x7684;&#x540C;&#x5B66;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#xFF0C;&#x4E2D;&#x95F4;&#x5C11;&#x4E86;&#x4E24;&#x6B21;&#x7528;&#x6237;&#x6001;&#x7684;&#x5207;&#x6362;&#x3002;</p>
</blockquote>
<h2 id="8-2-Kafka&#x65E0;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#8-2-Kafka&#x65E0;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="8.2 Kafka&#x65E0;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>8.2 Kafka&#x65E0;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x89E3;&#x51B3;&#x65B9;&#x6848;</h2><p>&#x5B9E;&#x73B0;Kafka&#x65E0;&#x4E22;&#x5931;&#x6D88;&#x606F;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x5982;&#x4E0B;&#xFF1A;</p>
<blockquote>
<ul>
<li>&#x5FC5;&#x987B;&#x4F7F;&#x7528;producer.send(msg, callback)&#x63A5;&#x53E3;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;</li>
<li>Producer&#x7AEF;&#x8BBE;&#x7F6E;acks&#x53C2;&#x6570;&#x503C;&#x4E3A;all&#x3002;acks&#x53C2;&#x6570;&#x503C;&#x4E3A;all&#x8868;&#x793A;ISR&#x4E2D;&#x6240;&#x6709;Broker&#x526F;&#x672C;&#x90FD;&#x63A5;&#x6536;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x6D88;&#x606F;&#x624D;&#x7B97;&#x5DF2;&#x63D0;&#x4EA4;&#x3002;</li>
<li>&#x8BBE;&#x7F6E;Producer&#x7AEF;retries&#x53C2;&#x6570;&#x503C;&#x4E3A;&#x4E00;&#x4E2A;&#x8F83;&#x5927;&#x503C;&#xFF0C;&#x8868;&#x793A;Producer&#x81EA;&#x52A8;&#x91CD;&#x8BD5;&#x6B21;&#x6570;&#x3002;&#x5F53;&#x51FA;&#x73B0;&#x7F51;&#x7EDC;&#x77AC;&#x65F6;&#x6296;&#x52A8;&#x65F6;&#xFF0C;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x53EF;&#x80FD;&#x4F1A;&#x5931;&#x8D25;&#xFF0C;&#x6B64;&#x65F6;Producer&#x80FD;&#x591F;&#x81EA;&#x52A8;&#x91CD;&#x8BD5;&#x6D88;&#x606F;&#x53D1;&#x9001;&#xFF0C;&#x907F;&#x514D;&#x6D88;&#x606F;&#x4E22;&#x5931;&#x3002;</li>
<li>&#x8BBE;&#x7F6E;Broker&#x7AEF;unclean.leader.election.enable = false&#xFF0C;unclean.leader.election.enable&#x53C2;&#x6570;&#x7528;&#x4E8E;&#x63A7;&#x5236;&#x6709;&#x8D44;&#x683C;&#x7ADE;&#x9009;&#x5206;&#x533A;Leader&#x7684;Broker&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;Broker&#x843D;&#x540E;&#x539F;Leader&#x592A;&#x591A;&#xFF0C;&#x90A3;&#x4E48;&#x6210;&#x4E3A;&#x65B0;Leader&#x5FC5;&#x7136;&#x4F1A;&#x9020;&#x6210;&#x6D88;&#x606F;&#x4E22;&#x5931;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x8981;&#x5C06;unclean.leader.election.enable&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x6210;false&#x3002;</li>
<li>&#x8BBE;&#x7F6E;Broker&#x7AEF;&#x53C2;&#x6570;replication.factor &gt;= 3&#xFF0C;&#x5C06;&#x6D88;&#x606F;&#x4FDD;&#x5B58;&#x591A;&#x4EFD;&#x526F;&#x672C;&#x3002;</li>
<li>&#x8BBE;&#x7F6E;Broker&#x53C2;&#x6570;min.insync.replicas &gt; 1&#xFF0C;&#x4FDD;&#x8BC1;ISR&#x4E2D;Broker&#x526F;&#x672C;&#x7684;&#x6700;&#x5C11;&#x4E2A;&#x6570;&#xFF0C;&#x5728;acks=-1&#x65F6;&#x624D;&#x751F;&#x6548;&#x3002;&#x8BBE;&#x7F6E;&#x6210;&#x5927;&#x4E8E;1&#x53EF;&#x4EE5;&#x63D0;&#x5347;&#x6D88;&#x606F;&#x6301;&#x4E45;&#x6027;&#xFF0C;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x503C; 1&#x3002;</li>
<li>&#x5FC5;&#x987B;&#x786E;&#x4FDD;replication.factor &gt; min.insync.replicas&#xFF0C;&#x5982;&#x679C;&#x4E24;&#x8005;&#x76F8;&#x7B49;&#xFF0C;&#x90A3;&#x4E48;&#x53EA;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x526F;&#x672C;&#x6302;&#x673A;&#xFF0C;&#x6574;&#x4E2A;&#x5206;&#x533A;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#x3002;&#x63A8;&#x8350;&#x8BBE;&#x7F6E;&#x6210;replication.factor = min.insync.replicas + 1&#x3002;</li>
<li>&#x786E;&#x4FDD;&#x6D88;&#x606F;&#x6D88;&#x8D39;&#x5B8C;&#x6210;&#x518D;&#x63D0;&#x4EA4;&#x3002;&#x8BBE;&#x7F6E;Consumer&#x7AEF;&#x53C2;&#x6570;enable.auto.commit&#x4E3A;false&#xFF0C;&#x5E76;&#x91C7;&#x7528;&#x624B;&#x52A8;&#x63D0;&#x4EA4;&#x4F4D;&#x79FB;&#x7684;&#x65B9;&#x5F0F;&#x3002;</li>
</ul>
</blockquote>
<p>&#x4F46;&#x662F;&#x4E0A;&#x8FB9;&#x7684;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#x5F88;&#x5927;&#x4E00;&#x90E8;&#x5206;&#x9650;&#x5236;&#x4E86;kafka &#x672C;&#x8EAB;&#x7684;&#x541E;&#x5410;&#x91CF;&#x3002;</p>
<h2 id="8-3-Kafka&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;"><a href="#8-3-Kafka&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;" class="headerlink" title="8.3 Kafka&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;"></a>8.3 Kafka&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;</h2><h3 id="8-3-1-&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x8FC7;&#x7A0B;&#x89E3;&#x6790;"><a href="#8-3-1-&#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x8FC7;&#x7A0B;&#x89E3;&#x6790;" class="headerlink" title="8.3.1 &#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x8FC7;&#x7A0B;&#x89E3;&#x6790;"></a>8.3.1 &#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;&#x8FC7;&#x7A0B;&#x89E3;&#x6790;</h3><p>&#x751F;&#x4EA7;&#x8005;&#x5C06;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5230;Topic&#x4E2D;&#xFF0C;&#x6D88;&#x8D39;&#x8005;&#x5373;&#x53EF;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#xFF0C;&#x5176;&#x6D88;&#x8D39;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;:</p>
<blockquote>
<ol>
<li>Consumer&#x5411;Broker&#x63D0;&#x4EA4;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#xFF0C;&#x5176;&#x6240;&#x8FDE;&#x63A5;&#x4E0A;&#x7684;Broker&#x90FD;&#x4F1A;&#x5411;&#x5176;&#x53D1;&#x9001;Broker Controller&#x7684;&#x901A;&#x4FE1;URL&#xFF0C;&#x5373;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;listeners&#x5730;&#x5740;&#xFF1B;</li>
<li>&#x5F53;Consumer&#x6307;&#x5B9A;&#x4E86;&#x8981;&#x6D88;&#x8D39;&#x7684;Topic&#x540E;&#xFF0C;&#x4F1A;&#x5411;Broker Controller&#x53D1;&#x9001;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#xFF1B;</li>
<li>Broker Controller&#x4F1A;&#x4E3A;Consumer&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x6216;&#x51E0;&#x4E2A;Partition Leader&#xFF0C;&#x5E76;&#x5C06;Partition&#x7684;&#x5F53;&#x524D;offset&#x53D1;&#x9001;&#x7ED9;Consumer&#xFF1B;</li>
<li>Consumer&#x4F1A;&#x6309;&#x7167;Broker Controller&#x5206;&#x914D;&#x7684;Partition&#x5BF9;&#x5176;&#x4E2D;&#x7684;&#x6D88;&#x606F;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#xFF1B;</li>
<li>&#x5F53;Consumer&#x6D88;&#x8D39;&#x5B8C;&#x6D88;&#x606F;&#x540E;&#xFF0C;Consumer&#x4F1A;&#x5411;Broker&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x5DF2;&#x7ECF;&#x88AB;&#x6D88;&#x8D39;&#x53CD;&#x9988;&#xFF0C;&#x5373;&#x6D88;&#x606F;&#x7684;offset&#xFF1B;</li>
<li>&#x5728;Broker&#x63A5;&#x6536;&#x5230;Consumer&#x7684;offset&#x540E;&#xFF0C;&#x4F1A;&#x66F4;&#x65B0;&#x76F8;&#x5E94;&#x7684;consumer_offset&#x4E2D;&#xFF1B;</li>
<li>Consumer&#x53EF;&#x4EE5;&#x91CD;&#x7F6E;offset&#xFF0C;&#x4ECE;&#x800C;&#x53EF;&#x4EE5;&#x7075;&#x6D3B;&#x6D88;&#x8D39;&#x5B58;&#x50A8;&#x5728;Broker&#x4E0A;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
</ol>
</blockquote>
<h3 id="8-3-2-&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#8-3-2-&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="8.3.2 &#x91CD;&#x590D;&#x6D88;&#x8D39;&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>8.3.2 &#x91CD;&#x590D;&#x6D88;&#x8D39;&#x89E3;&#x51B3;&#x65B9;&#x6848;</h3><blockquote>
<p>1.0 &#x540C;&#x4E00;&#x4E2A;Consumer&#x91CD;&#x590D;&#x6D88;&#x8D39;</p>
<p>&#x5F53;Consumer&#x7531;&#x4E8E;&#x6D88;&#x8D39;&#x80FD;&#x529B;&#x4F4E;&#x800C;&#x5F15;&#x53D1;&#x4E86;&#x6D88;&#x8D39;&#x8D85;&#x65F6;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x4F1A;&#x5F62;&#x6210;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x3002;<br>&#x5728;&#x67D0;&#x6570;&#x636E;&#x521A;&#x597D;&#x6D88;&#x8D39;&#x5B8C;&#x6BD5;&#xFF0C;&#x4F46;&#x6B63;&#x51C6;&#x5907;&#x63D0;&#x4EA4;offset&#x65F6;&#xFF0C;&#x6D88;&#x8D39;&#x65F6;&#x95F4;&#x8D85;&#x65F6;&#xFF0C;&#x5219;Broker&#x8BA4;&#x4E3A;&#x6D88;&#x606F;&#x672A;&#x6D88;&#x8D39;&#x6210;&#x529F;&#xFF0C;&#x4EA7;&#x751F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;&#x3002;</p>
<p>2.0 &#x5176;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF1A;&#x5EF6;&#x957F;offset&#x63D0;&#x4EA4;&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x4E0D;&#x540C;&#x7684;Consumer&#x91CD;&#x590D;&#x6D88;&#x8D39;<br>&#x5F53;Consumer&#x6D88;&#x8D39;&#x4E86;&#x6D88;&#x606F;&#xFF0C;&#x4F46;&#x8FD8;&#x6CA1;&#x6709;&#x63D0;&#x4EA4;offset&#x65F6;&#x5B95;&#x673A;&#xFF0C;&#x5219;&#x5DF2;&#x7ECF;&#x88AB;&#x6D88;&#x8D39;&#x8FC7;&#x7684;&#x6D88;&#x606F;&#x4F1A;&#x88AB;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x3002;<br>&#x5176;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF1A;&#x5C06;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x6539;&#x4E3A;&#x624B;&#x52A8;&#x63D0;&#x4EA4;</p>
</blockquote>
<p><strong>&#x4ECE;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x4E0A;&#x89E3;&#x51B3;Kafka&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x7684;&#x95EE;&#x9898;</strong></p>
<ul>
<li>&#x4FDD;&#x5B58;&#x5E76;&#x67E5;&#x8BE2;<ul>
<li>&#x7ED9;&#x6BCF;&#x4E2A;&#x6D88;&#x606F;&#x90FD;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;UUID&#xFF0C;&#x5728;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x53BB;&#x6301;&#x4E45;&#x5316;&#x7CFB;&#x7EDF;&#x4E2D;&#x67E5;&#x8BE2;&#xFF0C;&#x67E5;&#x770B;&#x6D88;&#x606F;&#x662F;&#x5426;&#x88AB;&#x6D88;&#x8D39;&#x8FC7;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6D88;&#x8D39;&#x8FC7;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#xFF1B;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x6D88;&#x8D39;&#x8FC7;&#xFF0C;&#x76F4;&#x63A5;&#x4E22;&#x5F03;&#x3002;</li>
</ul>
</li>
<li>&#x5229;&#x7528;&#x5E42;&#x7B49;&#x6027;<ul>
<li>&#x5E42;&#x7B49;&#x6027;&#x64CD;&#x4F5C;&#x7684;&#x7279;&#x70B9;&#x662F;&#x4EFB;&#x610F;&#x591A;&#x6B21;&#x6267;&#x884C;&#x6240;&#x4EA7;&#x751F;&#x7684;&#x5F71;&#x54CD;&#x5747;&#x4E0E;&#x4E00;&#x6B21;&#x6267;&#x884C;&#x7684;&#x5F71;&#x54CD;&#x76F8;&#x540C;&#x3002;<br>&#x5982;&#x679C;&#x5C06;&#x7CFB;&#x7EDF;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x8BBE;&#x8BA1;&#x4E3A;&#x5E42;&#x7B49;&#x6027;&#x64CD;&#x4F5C;&#xFF0C;&#x5C31;&#x4E0D;&#x7528;&#x62C5;&#x5FC3;Kafka&#x6D88;&#x606F;&#x7684;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5C06;&#x6D88;&#x8D39;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x8BBE;&#x8BA1;&#x6210;&#x5177;&#x5907;&#x5E42;&#x7B49;&#x6027;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x5229;&#x7528;&#x6570;&#x636E;&#x5E93;&#x7684;&#x552F;&#x4E00;&#x7EA6;&#x675F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5E42;&#x7B49;&#x6027;&#xFF0C;&#x5982;&#x5728;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5EFA;&#x4E00;&#x5F20;&#x8868;&#xFF0C;&#x5C06;&#x8868;&#x7684;&#x4E24;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x5B57;&#x6BB5;&#x8054;&#x5408;&#x8D77;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7EA6;&#x675F;&#xFF0C;&#x56E0;&#x6B64;&#x53EA;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x6761;&#x8BB0;&#x5F55;&#x3002;</li>
</ul>
</li>
<li>&#x8BBE;&#x7F6E;&#x524D;&#x63D0;&#x6761;&#x4EF6;<ul>
<li>&#x5B9E;&#x73B0;&#x5E42;&#x7B49;&#x6027;&#x7684;&#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#x662F;&#x7ED9;&#x6570;&#x636E;&#x53D8;&#x66F4;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x524D;&#x7F6E;&#x6761;&#x4EF6;&#x3002;&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x5C31;&#x66F4;&#x65B0;&#x6570;&#x636E;&#xFF0C;&#x5426;&#x5219;&#x62D2;&#x7EDD;&#x66F4;&#x65B0;&#x6570;&#x636E;&#xFF0C;&#x5728;&#x66F4;&#x65B0;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540C;&#x65F6;&#x53D8;&#x66F4;&#x524D;&#x7F6E;&#x6761;&#x4EF6;&#x4E2D;&#x9700;&#x8981;&#x5224;&#x65AD;&#x7684;&#x6570;&#x636E;&#x3002;</li>
</ul>
</li>
</ul>
<h3 id="8-3-3-kafka&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x5FEB;"><a href="#8-3-3-kafka&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x5FEB;" class="headerlink" title="8.3.3 kafka&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x5FEB;"></a>8.3.3 kafka&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x5FEB;</h3><ul>
<li><strong>&#x5229;&#x7528; Partition &#x5B9E;&#x73B0;&#x5E76;&#x884C;&#x5904;&#x7406;</strong> &#xFF1A;&#x6211;&#x4EEC;&#x90FD;&#x77E5;&#x9053; Kafka &#x662F;&#x4E00;&#x4E2A; Pub-Sub &#x7684;&#x6D88;&#x606F;&#x7CFB;&#x7EDF;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x53D1;&#x5E03;&#x8FD8;&#x662F;&#x8BA2;&#x9605;&#xFF0C;&#x90FD;&#x8981;&#x6307;&#x5B9A; Topic&#x3002;Topic &#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x903B;&#x8F91;&#x7684;&#x6982;&#x5FF5;&#x3002;&#x6BCF;&#x4E2A; Topic &#x90FD;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A; Partition&#xFF0C;&#x4E0D;&#x540C; Partition &#x53EF;&#x4F4D;&#x4E8E;&#x4E0D;&#x540C;&#x8282;&#x70B9;&#x3002;</li>
<li><strong>&#x987A;&#x5E8F;&#x8BFB;&#x5199;</strong>&#xFF1A;&#x56E0;&#x4E3A;&#x786C;&#x76D8;&#x662F;&#x673A;&#x68B0;&#x7ED3;&#x6784;&#xFF0C;&#x6BCF;&#x6B21;&#x8BFB;&#x5199;&#x90FD;&#x4F1A;&#x5BFB;&#x5740;-&gt;&#x5199;&#x5165;&#xFF0C;&#x5176;&#x4E2D;&#x5BFB;&#x5740;&#x662F;&#x4E00;&#x4E2A;&#x201C;&#x673A;&#x68B0;&#x52A8;&#x4F5C;&#x201D;&#xFF0C;&#x5B83;&#x662F;&#x6700;&#x8017;&#x65F6;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x786C;&#x76D8;&#x6700;&#x201C;&#x8BA8;&#x538C;&#x201D;&#x968F;&#x673A;I/O&#xFF0C;&#x6700;&#x559C;&#x6B22;&#x987A;&#x5E8F;I/O&#x3002;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x8BFB;&#x5199;&#x786C;&#x76D8;&#x7684;&#x901F;&#x5EA6;&#xFF0C;Kafka&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x987A;&#x5E8F;I/O&#x3002;</li>
<li><strong>&#x5145;&#x5206;&#x5229;&#x7528; Page Cache</strong>&#xFF1A;&#x5F15;&#x5165; Cache &#x5C42;&#x7684;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8; Linux &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5BF9;&#x78C1;&#x76D8;&#x8BBF;&#x95EE;&#x7684;&#x6027;&#x80FD;&#x3002;Cache &#x5C42;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x4E86;&#x78C1;&#x76D8;&#x4E0A;&#x7684;&#x90E8;&#x5206;&#x6570;&#x636E;&#x3002;&#x5F53;&#x6570;&#x636E;&#x7684;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x5728; Cache &#x4E2D;&#x5B58;&#x5728;&#x8BE5;&#x6570;&#x636E;&#x4E14;&#x662F;&#x6700;&#x65B0;&#x7684;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x5C06;&#x6570;&#x636E;&#x4F20;&#x9012;&#x7ED9;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#xFF0C;&#x514D;&#x9664;&#x4E86;&#x5BF9;&#x5E95;&#x5C42;&#x78C1;&#x76D8;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x63D0;&#x9AD8;&#x4E86;&#x6027;&#x80FD;&#x3002;Cache &#x5C42;&#x4E5F;&#x6B63;&#x662F;&#x78C1;&#x76D8; IOPS &#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x7A81;&#x7834; 200 &#x7684;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x4E4B;&#x4E00;&#x3002;&#x5728; Linux &#x7684;&#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x6587;&#x4EF6; Cache &#x5206;&#x4E3A;&#x4E24;&#x4E2A;&#x5C42;&#x9762;&#xFF0C;&#x4E00;&#x662F; Page Cache&#xFF0C;&#x53E6;&#x4E00;&#x4E2A; Buffer Cache&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; Page Cache &#x5305;&#x542B;&#x82E5;&#x5E72; Buffer Cache&#x3002;Page Cache &#x4E3B;&#x8981;&#x7528;&#x6765;&#x4F5C;&#x4E3A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x6587;&#x4EF6;&#x6570;&#x636E;&#x7684;&#x7F13;&#x5B58;&#x6765;&#x7528;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x9488;&#x5BF9;&#x5F53;&#x8FDB;&#x7A0B;&#x5BF9;&#x6587;&#x4EF6;&#x6709; read/write &#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x3002;Buffer Cache &#x5219;&#x4E3B;&#x8981;&#x662F;&#x8BBE;&#x8BA1;&#x7528;&#x6765;&#x5728;&#x7CFB;&#x7EDF;&#x5BF9;&#x5757;&#x8BBE;&#x5907;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5BF9;&#x5757;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x7684;&#x7CFB;&#x7EDF;&#x6765;&#x4F7F;&#x7528;&#x3002;</li>
<li><strong>&#x96F6;&#x62F7;&#x8D1D;&#x6280;&#x672F;</strong>&#xFF1A;<ul>
<li>&#x96F6;&#x62F7;&#x8D1D;&#xFF08;Zero-copy&#xFF09;&#x6280;&#x672F;&#x6307;&#x5728;&#x8BA1;&#x7B97;&#x673A;&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;CPU &#x4E0D;&#x9700;&#x8981;&#x5148;&#x5C06;&#x6570;&#x636E;&#x4ECE;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x590D;&#x5236;&#x5230;&#x53E6;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x4ECE;&#x800C;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;&#x4EE5;&#x53CA; CPU &#x7684;&#x62F7;&#x8D1D;&#x65F6;&#x95F4;&#x3002;&#x5B83;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5728;&#x6570;&#x636E;&#x62A5;&#x4ECE;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x5230;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x7A7A;&#x95F4;&#x4F20;&#x9012;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x51CF;&#x5C11;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#x6B21;&#x6570;&#xFF0C;&#x51CF;&#x5C11;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5B9E;&#x73B0; CPU &#x7684;&#x96F6;&#x53C2;&#x4E0E;&#xFF0C;&#x5F7B;&#x5E95;&#x6D88;&#x9664; CPU &#x5728;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x8D1F;&#x8F7D;&#x3002;</li>
<li>mmap&#xFF1A;Memory Mapped Files&#xFF1A;&#x7B80;&#x79F0; mmap&#xFF0C;&#x4E5F;&#x6709;&#x53EB; MMFile &#x7684;&#xFF0C;&#x4F7F;&#x7528; mmap &#x7684;&#x76EE;&#x7684;&#x662F;&#x5C06;&#x5185;&#x6838;&#x4E2D;&#x8BFB;&#x7F13;&#x51B2;&#x533A;&#xFF08;read buffer&#xFF09;&#x7684;&#x5730;&#x5740;&#x4E0E;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;&#x7F13;&#x51B2;&#x533A;&#xFF08;user buffer&#xFF09;&#x8FDB;&#x884C;&#x6620;&#x5C04;&#x3002;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x4E0E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x7684;&#x5171;&#x4EAB;&#xFF0C;&#x7701;&#x53BB;&#x4E86;&#x5C06;&#x6570;&#x636E;&#x4ECE;&#x5185;&#x6838;&#x8BFB;&#x7F13;&#x51B2;&#x533A;&#xFF08;read buffer&#xFF09;&#x62F7;&#x8D1D;&#x5230;&#x7528;&#x6237;&#x7F13;&#x51B2;&#x533A;&#xFF08;user buffer&#xFF09;&#x7684;&#x8FC7;&#x7A0B;&#x3002;&#x5B83;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#x662F;&#x76F4;&#x63A5;&#x5229;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684; Page &#x6765;&#x5B9E;&#x73B0;&#x6587;&#x4EF6;&#x5230;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x76F4;&#x63A5;&#x6620;&#x5C04;&#x3002;&#x5B8C;&#x6210;&#x6620;&#x5C04;&#x4E4B;&#x540E;&#x4F60;&#x5BF9;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x64CD;&#x4F5C;&#x4F1A;&#x88AB;&#x540C;&#x6B65;&#x5230;&#x786C;&#x76D8;&#x4E0A;&#x3002;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5F88;&#x5927;&#x7684; I/O &#x63D0;&#x5347;&#xFF0C;&#x7701;&#x53BB;&#x4E86;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x5230;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x590D;&#x5236;&#x7684;&#x5F00;&#x9500;&#x3002;</li>
<li>&#x6279;&#x5904;&#x7406;&#xFF1A;&#x5728;&#x5F88;&#x591A;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7CFB;&#x7EDF;&#x7684;&#x74F6;&#x9888;&#x4E0D;&#x662F; CPU &#x6216;&#x78C1;&#x76D8;&#xFF0C;&#x800C;&#x662F;&#x7F51;&#x7EDC;IO&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x9664;&#x4E86;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x4F4E;&#x7EA7;&#x6279;&#x5904;&#x7406;&#x4E4B;&#x5916;&#xFF0C;Kafka &#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x548C; broker &#x8FD8;&#x4F1A;&#x5728;&#x901A;&#x8FC7;&#x7F51;&#x7EDC;&#x53D1;&#x9001;&#x6570;&#x636E;&#x4E4B;&#x524D;&#xFF0C;&#x5728;&#x4E00;&#x4E2A;&#x6279;&#x5904;&#x7406;&#x4E2D;&#x7D2F;&#x79EF;&#x591A;&#x6761;&#x8BB0;&#x5F55; (&#x5305;&#x62EC;&#x8BFB;&#x548C;&#x5199;)&#x3002;&#x8BB0;&#x5F55;&#x7684;&#x6279;&#x5904;&#x7406;&#x5206;&#x644A;&#x4E86;&#x7F51;&#x7EDC;&#x5F80;&#x8FD4;&#x7684;&#x5F00;&#x9500;&#xFF0C;&#x4F7F;&#x7528;&#x4E86;&#x66F4;&#x5927;&#x7684;&#x6570;&#x636E;&#x5305;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x4E86;&#x5E26;&#x5BBD;&#x5229;&#x7528;&#x7387;&#x3002;</li>
<li>&#x6570;&#x636E;&#x538B;&#x7F29;&#xFF1A;Producer &#x53EF;&#x5C06;&#x6570;&#x636E;&#x538B;&#x7F29;&#x540E;&#x53D1;&#x9001;&#x7ED9; broker&#xFF0C;&#x4ECE;&#x800C;&#x51CF;&#x5C11;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;&#x4EE3;&#x4EF7;&#xFF0C;&#x76EE;&#x524D;&#x652F;&#x6301;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;&#x6709;&#xFF1A;Snappy&#x3001;Gzip&#x3001;LZ4&#x3002;&#x6570;&#x636E;&#x538B;&#x7F29;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x548C;&#x6279;&#x5904;&#x7406;&#x914D;&#x5957;&#x4F7F;&#x7528;&#x6765;&#x4F5C;&#x4E3A;&#x4F18;&#x5316;&#x624B;&#x6BB5;&#x7684;&#x3002;</li>
</ul>
</li>
</ul>
<p><strong>&#x603B;&#x7ED3;</strong>&#xFF1A;</p>
<blockquote>
<ul>
<li>1.0 partition &#x5E76;&#x884C;&#x5904;&#x7406;</li>
<li>2.0 &#x987A;&#x5E8F;&#x5199;&#x78C1;&#x76D8;&#xFF0C;&#x5145;&#x5206;&#x5229;&#x7528;&#x78C1;&#x76D8;&#x7279;&#x6027;</li>
<li>3.0 &#x5229;&#x7528;&#x4E86;&#x73B0;&#x4EE3;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5206;&#x9875;&#x5B58;&#x50A8; Page Cache &#x6765;&#x5229;&#x7528;&#x5185;&#x5B58;&#x63D0;&#x9AD8; I/O &#x6548;&#x7387;</li>
<li>4.0 &#x91C7;&#x7528;&#x4E86;&#x96F6;&#x62F7;&#x8D1D;&#x6280;&#x672F;</li>
<li>5.0 Producer &#x751F;&#x4EA7;&#x7684;&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x5230; broker&#xFF0C;&#x91C7;&#x7528; mmap &#x6587;&#x4EF6;&#x6620;&#x5C04;&#xFF0C;&#x5B9E;&#x73B0;&#x987A;&#x5E8F;&#x7684;&#x5FEB;&#x901F;&#x5199;&#x5165;</li>
<li>6.0 Customer &#x4ECE; broker &#x8BFB;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x91C7;&#x7528; sendfile&#xFF0C;&#x5C06;&#x78C1;&#x76D8;&#x6587;&#x4EF6;&#x8BFB;&#x5230; OS &#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x540E;&#xFF0C;&#x8F6C;&#x5230; NIO buffer&#x8FDB;&#x884C;&#x7F51;&#x7EDC;&#x53D1;&#x9001;&#xFF0C;&#x51CF;&#x5C11; CPU &#x6D88;&#x8017;</li>
</ul>
</blockquote>
<h3 id="8-3-4-Kafka&#x4E2D;&#x7684;HW&#x3001;LEO&#x3001;LSO&#x3001;LW&#x7B49;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#8-3-4-Kafka&#x4E2D;&#x7684;HW&#x3001;LEO&#x3001;LSO&#x3001;LW&#x7B49;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="8.3.4 Kafka&#x4E2D;&#x7684;HW&#x3001;LEO&#x3001;LSO&#x3001;LW&#x7B49;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;"></a>8.3.4 Kafka&#x4E2D;&#x7684;HW&#x3001;LEO&#x3001;LSO&#x3001;LW&#x7B49;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;</h3><blockquote>
<ul>
<li>HW&#x662F;High Watermak&#x7684;&#x7F29;&#x5199;&#xFF0C;&#x4FD7;&#x79F0;&#x9AD8;&#x6C34;&#x4F4D;&#xFF0C;&#x5B83;&#x8868;&#x793A;&#x4E86;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x6D88;&#x606F;&#x7684;&#x504F;&#x79FB;&#x91CF;&#xFF08;offset&#xFF09;&#xFF0C;&#x6D88;&#x8D39;&#x4E4B;&#x53EA;&#x80FD;&#x62C9;&#x53D6;&#x5230;&#x8FD9;&#x4E2A;offset&#x4E4B;&#x524D;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
<li>LEO&#x662F;Log End Offset&#x7684;&#x7F29;&#x5199;&#xFF0C;&#x5B83;&#x8868;&#x793A;&#x4E86;&#x5F53;&#x524D;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x4E2D;&#x4E0B;&#x4E00;&#x6761;&#x5F85;&#x5199;&#x5165;&#x6D88;&#x606F;&#x7684;offset&#x3002;</li>
<li>LSO&#x7279;&#x6307;LastStableOffset&#x3002;&#x5B83;&#x5177;&#x4F53;&#x4E0E;kafka&#x7684;&#x4E8B;&#x7269;&#x6709;&#x5173;&#x3002;&#x6D88;&#x8D39;&#x7AEF;&#x53C2;&#x6570;&#x2014;&#x2014;isolation.level,&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x7528;&#x6765;&#x914D;&#x7F6E;&#x6D88;&#x8D39;&#x8005;&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x3002;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#xFF0C;&#x201C;read_uncommitted&#x201D;&#x548C;&#x201C;read_committed&#x201D;&#x3002;</li>
<li>LW&#x662F;Low Watermark&#x7684;&#x7F29;&#x5199;&#xFF0C;&#x4FD7;&#x79F0;&#x201C;&#x4F4E;&#x6C34;&#x4F4D;&#x201D;&#xFF0C;&#x4EE3;&#x8868;AR&#x96C6;&#x5408;&#x4E2D;&#x6700;&#x5C0F;&#x7684;logStartOffset&#x503C;&#xFF0C;&#x526F;&#x672C;&#x7684;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#xFF08;FetchRequest&#xFF09;&#x548C;&#x5220;&#x9664;&#x8BF7;&#x6C42;&#xFF08;DeleteRecordRequest&#xFF09;&#x90FD;&#x53EF;&#x80FD;&#x4FC3;&#x4F7F;LW&#x7684;&#x589E;&#x957F;&#x3002;</li>
</ul>
</blockquote>
<h3 id="8-3-5-Kafka&#x4E2D;&#x662F;&#x600E;&#x4E48;&#x4F53;&#x73B0;&#x6D88;&#x606F;&#x987A;&#x5E8F;&#x6027;&#x7684;"><a href="#8-3-5-Kafka&#x4E2D;&#x662F;&#x600E;&#x4E48;&#x4F53;&#x73B0;&#x6D88;&#x606F;&#x987A;&#x5E8F;&#x6027;&#x7684;" class="headerlink" title="8.3.5 Kafka&#x4E2D;&#x662F;&#x600E;&#x4E48;&#x4F53;&#x73B0;&#x6D88;&#x606F;&#x987A;&#x5E8F;&#x6027;&#x7684;"></a>8.3.5 Kafka&#x4E2D;&#x662F;&#x600E;&#x4E48;&#x4F53;&#x73B0;&#x6D88;&#x606F;&#x987A;&#x5E8F;&#x6027;&#x7684;</h3><blockquote>
<ol>
<li>&#x4E00;&#x4E2A; topic&#xFF0C;&#x4E00;&#x4E2A; partition&#xFF0C;&#x4E00;&#x4E2A; consumer&#xFF0C;&#x5185;&#x90E8;&#x5355;&#x7EBF;&#x7A0B;&#x6D88;&#x8D39;&#xFF0C;&#x5355;&#x7EBF;&#x7A0B;&#x541E;&#x5410;&#x91CF;&#x592A;&#x4F4E;&#xFF0C;&#x4E00;&#x822C;&#x4E0D;&#x4F1A;&#x7528;&#x8FD9;&#x4E2A;&#x3002;</li>
<li>&#x5199; N &#x4E2A;&#x5185;&#x5B58; queue&#xFF0C;&#x5177;&#x6709;&#x76F8;&#x540C; key &#x7684;&#x6570;&#x636E;&#x90FD;&#x5230;&#x540C;&#x4E00;&#x4E2A;&#x5185;&#x5B58; queue&#xFF1B;&#x7136;&#x540E;&#x5BF9;&#x4E8E; N &#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x5206;&#x522B;&#x6D88;&#x8D39;&#x4E00;&#x4E2A;&#x5185;&#x5B58; queue &#x5373;&#x53EF;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x4FDD;&#x8BC1;&#x987A;&#x5E8F;&#x6027;&#x3002;</li>
</ol>
</blockquote>
<h3 id="8-3-6-Kafka&#x4E2D;&#x7684;ISR&#x3001;AR&#x53C8;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;ISR&#x7684;&#x4F38;&#x7F29;&#x53C8;&#x6307;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#8-3-6-Kafka&#x4E2D;&#x7684;ISR&#x3001;AR&#x53C8;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;ISR&#x7684;&#x4F38;&#x7F29;&#x53C8;&#x6307;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="8.3.6 Kafka&#x4E2D;&#x7684;ISR&#x3001;AR&#x53C8;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;ISR&#x7684;&#x4F38;&#x7F29;&#x53C8;&#x6307;&#x4EC0;&#x4E48;&#xFF1F;"></a>8.3.6 Kafka&#x4E2D;&#x7684;ISR&#x3001;AR&#x53C8;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;ISR&#x7684;&#x4F38;&#x7F29;&#x53C8;&#x6307;&#x4EC0;&#x4E48;&#xFF1F;</h3><ol>
<li>&#x5206;&#x533A;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x526F;&#x672C;&#x7EDF;&#x79F0;&#x4E3A;AR&#xFF08;Assigned Repllicas&#xFF09;&#x3002;&#x6240;&#x6709;&#x4E0E;leader&#x526F;&#x672C;&#x4FDD;&#x6301;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x540C;&#x6B65;&#x7684;&#x526F;&#x672C;&#xFF08;&#x5305;&#x62EC;Leader&#xFF09;&#x7EC4;&#x6210;ISR&#xFF08;In-Sync Replicas&#xFF09;&#xFF0C;ISR&#x96C6;&#x5408;&#x662F;AR&#x96C6;&#x5408;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x5B50;&#x96C6;&#x3002;&#x4E0E;leader&#x526F;&#x672C;&#x540C;&#x6B65;&#x6EDE;&#x540E;&#x8FC7;&#x591A;&#x7684;&#x526F;&#x672C;&#xFF08;&#x4E0D;&#x5305;&#x62EC;leader&#xFF09;&#x526F;&#x672C;&#xFF0C;&#x7EC4;&#x6210;OSR(Out-Sync Relipcas),&#x7531;&#x6B64;&#x53EF;&#x89C1;&#xFF1A;AR=ISR+OSR&#x3002;</li>
<li>ISR&#x96C6;&#x5408;&#x7684;&#x526F;&#x672C;&#x5FC5;&#x987B;&#x6EE1;&#x8DB3;&#xFF1A;<br>&#x526F;&#x672C;&#x6240;&#x5728;&#x8282;&#x70B9;&#x5FC5;&#x987B;&#x7EF4;&#x6301;&#x7740;&#x4E0E;zookeeper&#x7684;&#x8FDE;&#x63A5;&#xFF1B;&#x526F;&#x672C;&#x6700;&#x540E;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;offset&#x4E0E;leader&#x526F;&#x672C;&#x6700;&#x540E;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;offset&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x503C;&#x4E0D;&#x80FD;&#x8D85;&#x51FA;&#x6307;&#x5B9A;&#x7684;&#x9608;&#x503C;</li>
<li>&#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x7684;leader&#x526F;&#x672C;&#x90FD;&#x4F1A;&#x7EF4;&#x62A4;&#x6B64;&#x5206;&#x533A;&#x7684;ISR&#x96C6;&#x5408;&#xFF0C;&#x5199;&#x8BF7;&#x6C42;&#x9996;&#x5148;&#x7531;leader&#x526F;&#x672C;&#x5904;&#x7406;&#xFF0C;&#x4E4B;&#x540E;follower&#x526F;&#x672C;&#x4F1A;&#x4ECE;leader&#x526F;&#x672C;&#x4E0A;&#x62C9;&#x53D6;&#x5199;&#x5165;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4F1A;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5EF6;&#x8FDF;&#xFF0C;&#x5BFC;&#x81F4;follower&#x526F;&#x672C;&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6D88;&#x606F;&#x7565;&#x5C11;&#x4E8E;leader&#x526F;&#x672C;&#xFF0C;&#x53EA;&#x8981;&#x672A;&#x8D85;&#x51FA;&#x9608;&#x503C;&#x90FD;&#x662F;&#x53EF;&#x4EE5;&#x5BB9;&#x5FCD;&#x7684;</li>
<li>ISR&#x7684;&#x4F38;&#x7F29;&#x6307;&#x7684;&#x662F;Kafka&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5F00;&#x542F;&#x4E24;&#x4E2A;&#x4E0E;ISR&#x76F8;&#x5173;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x540D;&#x79F0;&#x5206;&#x522B;&#x4E3A;&#x201C;isr-expiration&#x201D;&#x548C;&#x201D;isr-change-propagation&#x201D;.&#x3002;isr-expiration&#x4EFB;&#x52A1;&#x4F1A;&#x5468;&#x671F;&#x6027;&#x7684;&#x68C0;&#x6D4B;&#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x662F;&#x5426;&#x9700;&#x8981;&#x7F29;&#x51CF;&#x5176;ISR&#x96C6;&#x5408;&#x3002;</li>
</ol>
<h3 id="8-3-6-&#x5982;&#x679C;&#x6211;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x4E2A;offset&#xFF0C;Kafka&#x600E;&#x4E48;&#x67E5;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#xFF1F;"><a href="#8-3-6-&#x5982;&#x679C;&#x6211;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x4E2A;offset&#xFF0C;Kafka&#x600E;&#x4E48;&#x67E5;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#xFF1F;" class="headerlink" title="8.3.6 &#x5982;&#x679C;&#x6211;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x4E2A;offset&#xFF0C;Kafka&#x600E;&#x4E48;&#x67E5;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#xFF1F;"></a>8.3.6 &#x5982;&#x679C;&#x6211;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x4E2A;offset&#xFF0C;Kafka&#x600E;&#x4E48;&#x67E5;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#xFF1F;</h3><ol>
<li>&#x901A;&#x8FC7;&#x6587;&#x4EF6;&#x540D;&#x524D;&#x7F00;&#x6570;&#x5B57;x&#x627E;&#x5230;&#x8BE5;&#x7EDD;&#x5BF9;offset &#x5BF9;&#x5E94;&#x6D88;&#x606F;&#x6240;&#x5728;&#x6587;&#x4EF6;&#x3002;</li>
<li>offset-x&#x4E3A;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x76F8;&#x5BF9;&#x504F;&#x79FB;&#x3002;</li>
<li>&#x901A;&#x8FC7;index&#x6587;&#x4EF6;&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x7D22;&#x5F15;&#x627E;&#x5230;&#x6700;&#x8FD1;&#x7684;&#x6D88;&#x606F;&#x7684;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x4ECE;&#x6700;&#x8FD1;&#x4F4D;&#x7F6E;&#x5F00;&#x59CB;&#x9010;&#x6761;&#x5BFB;&#x627E;&#x3002;</li>
</ol>
<h3 id="8-3-7-Kafka&#x4E2D;&#x7684;&#x5EF6;&#x8FDF;&#x961F;&#x5217;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#xFF1F;"><a href="#8-3-7-Kafka&#x4E2D;&#x7684;&#x5EF6;&#x8FDF;&#x961F;&#x5217;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#xFF1F;" class="headerlink" title="8.3.7 Kafka&#x4E2D;&#x7684;&#x5EF6;&#x8FDF;&#x961F;&#x5217;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#xFF1F;"></a>8.3.7 Kafka&#x4E2D;&#x7684;&#x5EF6;&#x8FDF;&#x961F;&#x5217;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#xFF1F;</h3><blockquote>
<p>Kafka&#x4E2D;&#x5B58;&#x5728;&#x5927;&#x91CF;&#x7684;&#x5EF6;&#x8FDF;&#x64CD;&#x4F5C;&#xFF0C;&#x6BD4;&#x5982;&#x5EF6;&#x8FDF;&#x751F;&#x4EA7;&#x3001;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x4EE5;&#x53CA;&#x5EF6;&#x8FDF;&#x5220;&#x9664;&#x7B49;&#x3002;Kafka&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;JDK&#x81EA;&#x5E26;&#x7684;Timer&#x6216;&#x8005;DelayQueue&#x6765;&#x5B9E;&#x73B0;&#x5EF6;&#x8FDF;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x800C;&#x662F;&#x57FA;&#x4E8E;&#x65F6;&#x95F4;&#x8F6E;&#x81EA;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x5B9E;&#x73B0;&#x5EF6;&#x8FDF;&#x529F;&#x80FD;&#x7684;&#x5B9A;&#x65F6;&#x5668;&#xFF08;SystemTimer&#xFF09;&#x3002;JDK&#x7684;Timer&#x548C;DelayQueue&#x63D2;&#x5165;&#x548C;&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x7684;&#x5E73;&#x5747;&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#x4E3A;O(nlog(n))&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x6EE1;&#x8DB3;Kafka&#x7684;&#x9AD8;&#x6027;&#x80FD;&#x8981;&#x6C42;&#xFF0C;&#x800C;&#x57FA;&#x4E8E;&#x65F6;&#x95F4;&#x8F6E;&#x53EF;&#x4EE5;&#x5C06;&#x63D2;&#x5165;&#x548C;&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#x90FD;&#x964D;&#x4E3A;O(1)&#x3002;Kafka&#x4E2D;&#x7684;&#x65F6;&#x95F4;&#x8F6E;&#xFF08;TimingWheel&#xFF09;&#x662F;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x7684;&#x73AF;&#x5F62;&#x961F;&#x5217;&#xFF0C;&#x5E95;&#x5C42;&#x91C7;&#x7528;&#x6570;&#x7EC4;&#x5B9E;&#x73B0;&#xFF0C;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x5B58;&#x653E;&#x4E00;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x5217;&#x8868;&#xFF08;TimerTaskList&#xFF09;&#x3002;TimerTaskList&#x662F;&#x4E00;&#x4E2A;&#x73AF;&#x5F62;&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#xFF0C;&#x94FE;&#x8868;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x9879;&#x8868;&#x793A;&#x7684;&#x90FD;&#x662F;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x9879;&#xFF08;TimerTaskEntry&#xFF09;&#xFF0C;&#x5176;&#x4E2D;&#x5C01;&#x88C5;&#x4E86;&#x771F;&#x6B63;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;TimerTask&#x3002;&#x65F6;&#x95F4;&#x8F6E;&#x7531;&#x591A;&#x4E2A;&#x65F6;&#x95F4;&#x683C;&#x7EC4;&#x6210;&#xFF0C;&#x6BCF;&#x4E2A;&#x65F6;&#x95F4;&#x683C;&#x4EE3;&#x8868;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#x8F6E;&#x7684;&#x57FA;&#x672C;&#x65F6;&#x95F4;&#x8DE8;&#x5EA6;&#xFF08;tickMs&#xFF09;&#x3002;&#x65F6;&#x95F4;&#x8F6E;&#x7684;&#x65F6;&#x95F4;&#x683C;&#x4E2A;&#x6570;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;&#x53EF;&#x7528;wheelSize&#x6765;&#x8868;&#x793A;&#xFF0C;&#x90A3;&#x4E48;&#x6574;&#x4E2A;&#x65F6;&#x95F4;&#x8F6E;&#x7684;&#x603B;&#x4F53;&#x65F6;&#x95F4;&#x8DE8;&#x5EA6;&#xFF08;interval&#xFF09;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x516C;&#x5F0F; tickMs &#xD7; wheelSize&#x8BA1;&#x7B97;&#x5F97;&#x51FA;&#x3002;</p>
</blockquote>
<h3 id="8-3-8-&#x6D88;&#x8D39;&#x8005;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4F4D;&#x79FB;&#x65F6;&#x63D0;&#x4EA4;&#x7684;&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x5230;&#x7684;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;offset&#x8FD8;&#x662F;offset-1"><a href="#8-3-8-&#x6D88;&#x8D39;&#x8005;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4F4D;&#x79FB;&#x65F6;&#x63D0;&#x4EA4;&#x7684;&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x5230;&#x7684;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;offset&#x8FD8;&#x662F;offset-1" class="headerlink" title="8.3.8 &#x6D88;&#x8D39;&#x8005;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4F4D;&#x79FB;&#x65F6;&#x63D0;&#x4EA4;&#x7684;&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x5230;&#x7684;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;offset&#x8FD8;&#x662F;offset+1?"></a>8.3.8 &#x6D88;&#x8D39;&#x8005;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4F4D;&#x79FB;&#x65F6;&#x63D0;&#x4EA4;&#x7684;&#x662F;&#x5F53;&#x524D;&#x6D88;&#x8D39;&#x5230;&#x7684;&#x6700;&#x65B0;&#x6D88;&#x606F;&#x7684;offset&#x8FD8;&#x662F;offset+1?</h3><blockquote>
<p>offset+1</p>
</blockquote>
<h3 id="8-3-9-&#x4F18;&#x5148;&#x526F;&#x672C;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5B83;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x6B8A;&#x7684;&#x4F5C;&#x7528;&#xFF1F;"><a href="#8-3-9-&#x4F18;&#x5148;&#x526F;&#x672C;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5B83;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x6B8A;&#x7684;&#x4F5C;&#x7528;&#xFF1F;" class="headerlink" title="8.3.9 &#x4F18;&#x5148;&#x526F;&#x672C;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5B83;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x6B8A;&#x7684;&#x4F5C;&#x7528;&#xFF1F;"></a>8.3.9 &#x4F18;&#x5148;&#x526F;&#x672C;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5B83;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x6B8A;&#x7684;&#x4F5C;&#x7528;&#xFF1F;</h3><blockquote>
<p>&#x4F18;&#x5148;&#x526F;&#x672C; &#x4F1A;&#x662F;&#x9ED8;&#x8BA4;&#x7684;leader&#x526F;&#x672C; &#x53D1;&#x751F;leader&#x53D8;&#x5316;&#x65F6;&#x91CD;&#x9009;&#x4E3E;&#x4F1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x4F18;&#x5148;&#x526F;&#x672C;&#x4F5C;&#x4E3A;leader</p>
</blockquote>
<p><strong><em>&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x52A0;<a href="https://dev.newban.cn/7238403651021783077">&#x300C;&#x91D1;&#x77F3;&#x8BA1;&#x5212;&#x300D;</a></em></strong></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/c80fb39e8dd588c4fb3785e8551fd89b.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237540467427590199.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237540467427590199.html" itemprop="url">JYM 设计模式系列- 责任链模式，装饰模式，让你的代码更优</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-27T12:33:57+08:00">
                2023-05-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x89C9;&#x5F97;&#x4E0D;&#x9519;&#x8BF7;&#x6309;&#x4E0B;&#x56FE;&#x64CD;&#x4F5C;&#xFF0C;&#x6398;&#x53CB;&#x4EEC;&#xFF0C;&#x54C8;&#x54C8;&#x54C8;&#xFF01;&#xFF01;&#xFF01;<br><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/65778c41bc60c72d236c320e8d0f067c99f567e785167c96bbb39732a5310da4" alt="image.png"></p>
<h1 id="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"><a href="#&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;" class="headerlink" title="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"></a>&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;</h1><p>&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x7C7B;&#xFF1A;</p>
<ul>
<li><strong>&#x521B;&#x5EFA;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E94;&#x79CD;&#xFF1A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E03;&#x79CD;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x3001;&#x5916;&#x89C2;&#x6A21;&#x5F0F;&#x3001;&#x6865;&#x63A5;&#x6A21;&#x5F0F;&#x3001;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;&#x3001;&#x4EAB;&#x5143;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x5341;&#x4E00;&#x79CD;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x3001;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x8FED;&#x4EE3;&#x5B50;&#x6A21;&#x5F0F;&#x3001;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3001;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x3001;&#x5907;&#x5FD8;&#x5F55;&#x6A21;&#x5F0F;&#x3001;&#x72B6;&#x6001;&#x6A21;&#x5F0F;&#x3001;&#x8BBF;&#x95EE;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x4E2D;&#x4ECB;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x89E3;&#x91CA;&#x5668;&#x6A21;&#x5F0F;&#x3002;</strong></li>
</ul>
<h1 id="&#x4E00;&#xFF1A;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;"><a href="#&#x4E00;&#xFF1A;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E00;&#xFF1A;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;"></a>&#x4E00;&#xFF1A;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;</h1><h2 id="1-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;&#xFF1A;"><a href="#1-1-&#x540D;&#x8BCD;&#x89E3;&#x91CA;&#xFF1A;" class="headerlink" title="1.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;&#xFF1A;"></a>1.1 &#x540D;&#x8BCD;&#x89E3;&#x91CA;&#xFF1A;</h2><p>&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x662F;&#x4E00;&#x79CD;&#x884C;&#x4E3A;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x5141;&#x8BB8;&#x4F60;&#x5C06;&#x8BF7;&#x6C42;&#x6CBF;&#x7740;&#x5904;&#x7406;&#x8005;&#x94FE;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#x3002;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x540E;&#xFF0C;&#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x5747;&#x53EF;&#x5BF9;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x6216;&#x5C06;&#x5176;&#x4F20;&#x9012;&#x7ED9;&#x94FE;&#x4E0A;&#x7684;&#x4E0B;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x3002;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x7684;&#x6838;&#x5FC3;&#x662F;&#x89E3;&#x51B3;&#x4E00;&#x7EC4;&#x670D;&#x52A1;&#x4E2D;&#x7684;&#x5148;&#x540E;&#x6267;&#x884C;&#x5904;&#x7406;&#x5173;&#x7CFB;&#x3002;</p>
<p>&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x8BA9;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x6A21;&#x5757;&#x66F4;&#x52A0;&#x6E05;&#x6670;&#xFF0C;&#x800C;&#x6BCF;&#x4E00;&#x4E2A;&#x6A21;&#x5757;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;next&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x83B7;&#x53D6;&#x3002;&#x800C;&#x6BCF;&#x4E00;&#x4E2A;next&#x662F;&#x7531;&#x7EE7;&#x627F;&#x7684;&#x7EDF;&#x4E00;&#x62BD;&#x8C61;&#x7C7B;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6700;&#x7EC8;&#x6240;&#x6709;&#x7C7B;&#x7684;&#x804C;&#x8D23;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x7684;&#x8FDB;&#x884C;&#x7F16;&#x6392;&#x4F7F;&#x7528;&#xFF0C;&#x7F16;&#x6392;&#x7684;&#x8FC7;&#x7A0B;&#x53EF;&#x4EE5;&#x505A;&#x6210;&#x53EF;&#x914D;&#x7F6E;&#x5316;&#x3002;</p>
<p>&#x5728;&#x4F7F;&#x7528;&#x8D23;&#x4EFB;&#x94FE;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x573A;&#x666F;&#x6BD4;&#x8F83;&#x56FA;&#x5B9A;&#xFF0C;&#x53EF;&#x5199;&#x6B7B;&#x5230;&#x4EE3;&#x7801;&#x4E2D;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x3002;&#x4F46;&#x5982;&#x679C;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x7ECF;&#x5E38;&#x53D8;&#x5316;&#x53EF;&#x4EE5;&#x505A;&#x6210;xml&#x914D;&#x7F6E;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4FDD;&#x5B58;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5B9E;&#x9645;&#x7684;&#x4E1A;&#x52A1;&#x4E2D;&#x5728;&#x4F7F;&#x7528;&#x8D23;&#x4EFB;&#x94FE;&#x65F6;&#x4F1A;&#x8FDB;&#x884C;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5305;&#x88C5;&#xFF0C;&#x901A;&#x8FC7;&#x628A;&#x4E0D;&#x540C;&#x7684;&#x8D23;&#x4EFB;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x7EC4;&#x88C5;&#xFF0C;&#x6784;&#x6210;&#x4E00;&#x6761;&#x5B8C;&#x6574;&#x4E1A;&#x52A1;&#x7684;&#x8D23;&#x4EFB;&#x94FE;&#x3002;</p>
<h2 id="1-2-&#x4F18;&#x70B9;&#xFF1A;"><a href="#1-2-&#x4F18;&#x70B9;&#xFF1A;" class="headerlink" title="1.2 &#x4F18;&#x70B9;&#xFF1A;"></a>1.2 &#x4F18;&#x70B9;&#xFF1A;</h2><p>&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x5F88;&#x597D;&#x7684;&#x5904;&#x7406;&#x5355;&#x4E00;&#x804C;&#x8D23;&#x548C;&#x5F00;&#x95ED;&#x539F;&#x5219;&#xFF0C;&#x7B80;&#x5355;&#x8026;&#x5408;&#x4E5F;&#x4F7F;&#x5BF9;&#x8C61;&#x5173;&#x7CFB;&#x66F4;&#x52A0;&#x6E05;&#x6670;&#xFF0C;&#x800C;&#x4E14;&#x5916;&#x90E8;&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5E76;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x7CFB;&#x8D23;&#x4EFB;&#x94FE;&#x662F;&#x5982;&#x4F55;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<h2 id="1-3&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x7ED3;&#x6784;"><a href="#1-3&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x7ED3;&#x6784;" class="headerlink" title="1.3&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x7ED3;&#x6784;"></a>1.3&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x7ED3;&#x6784;</h2><ul>
<li>&#x5904;&#x7406;&#x8005;  </li>
</ul>
<p>&#x58F0;&#x660E;&#x4E86;&#x6240;&#x6709;&#x5177;&#x4F53;&#x5904;&#x7406;&#x8005;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#xFF0C;&#x8BE5;&#x63A5;&#x53E3;&#x901A;&#x5E38;&#x4EC5;&#x5305;&#x542B;&#x5355;&#x4E2A;&#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x6709;&#x65F6;&#x5176;&#x8FD8;&#x4F1A;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x8BBE;&#x7F6E;&#x94FE;&#x4E0A;&#x4E0B;&#x5904;&#x7406;&#x8005;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<ul>
<li>&#x57FA;&#x7840;&#x5904;&#x7406;&#x8005; &#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x9009;&#x7684;&#x7C7B;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5C06;&#x6240;&#x6709;&#x5904;&#x7406;&#x8005;&#x5171;&#x7528;&#x7684;&#x6837;&#x672C;&#x4EE3;&#x7801;&#x653E;&#x7F6E;&#x5728;&#x5176;&#x4E2D;&#x3002;(&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8BE5;&#x7C7B;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4FDD;&#x5B58;&#x5BF9;&#x4E8E;&#x4E0B;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x5F15;&#x7528;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x901A;&#x8FC7;&#x5C06;&#x5904;&#x7406;&#x8005;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6216;&#x8BBE;&#x5B9A;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x94FE;&#x3002;&#x8BE5;&#x7C7B;&#x8FD8;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x9ED8;&#x8BA4;&#x7684;&#x5904;&#x7406;&#x884C;&#x4E3A;&#xFF0C;&#x786E;&#x5B9A;&#x4E0B;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x5B58;&#x5728;&#x540E;&#x518D;&#x5C06;&#x8BF7;&#x6C42;&#x4F20;&#x9012;&#x7ED9;&#x5B83;&#x3002;)</li>
<li>&#x5177;&#x4F53;&#x5904;&#x7406;&#x8005; &#x5305;&#x542B;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x3002;&#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x540E;&#xFF0C;&#x90FD;&#x5FC5;&#x987B;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x662F;&#x5426;&#x6CBF;&#x7740;&#x94FE;&#x4F20;&#x9012;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x5BA2;&#x6237;&#x7AEF;  </li>
</ul>
<p>&#x53EF;&#x6839;&#x636E;&#x7A0B;&#x5E8F;&#x903B;&#x8F91;&#x4E00;&#x6B21;&#x6027;&#x6216;&#x8005;&#x52A8;&#x6001;&#x7684;&#x751F;&#x6210;&#x94FE;&#x3002;</p>
<h2 id="1-4-&#x9002;&#x7528;&#x573A;&#x666F;"><a href="#1-4-&#x9002;&#x7528;&#x573A;&#x666F;" class="headerlink" title="1.4 &#x9002;&#x7528;&#x573A;&#x666F;"></a>1.4 &#x9002;&#x7528;&#x573A;&#x666F;</h2><ul>
<li>&#x5F53;&#x7A0B;&#x5E8F;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#x4E0D;&#x540C;&#x79CD;&#x7C7B;&#x8BF7;&#x6C42;&#xFF0C;&#x800C;&#x4E14;&#x8BF7;&#x6C42;&#x7C7B;&#x578B;&#x548C;&#x987A;&#x5E8F;&#x9884;&#x5148;&#x672A;&#x77E5;&#x65F6;&#x3002;</li>
<li>&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x5FC5;&#x987B;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x65F6;&#x3002;</li>
<li>&#x5904;&#x7406;&#x8005;&#x53CA;&#x5176;&#x987A;&#x5E8F;&#x5FC5;&#x987B;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x8FDB;&#x884C;&#x6539;&#x53D8;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3002;</li>
</ul>
<h2 id="1-5-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"><a href="#1-5-&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;" class="headerlink" title="1.5 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;"></a>1.5 &#x5B9E;&#x73B0;&#x65B9;&#x5F0F;</h2><ul>
<li>&#x58F0;&#x660E;&#x5904;&#x7406;&#x8005;&#x63A5;&#x53E3;&#x5E76;&#x63CF;&#x8FF0;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x65B9;&#x6CD5;&#x7684;&#x7B7E;&#x540D;</li>
<li>&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5904;&#x7406;&#x8005;&#x63A5;&#x53E3;&#x521B;&#x5EFA;&#x62BD;&#x8C61;&#x5904;&#x7406;&#x8005;&#x57FA;&#x7C7B;(<strong>&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x6765;&#x5B58;&#x50A8;&#x6307;&#x5411;&#x94FE;&#x4E0A;&#x4E0B;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x7684;&#x5F15;&#x7528;</strong>)</li>
<li>&#x521B;&#x5EFA;&#x5177;&#x4F53;&#x7684;&#x5904;&#x7406;&#x8005;&#x5B50;&#x7C7B;&#x5E76;&#x5B9E;&#x73B0;&#x5176;&#x5904;&#x7406;&#x65B9;&#x6CD5;&#x3002;(&#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x5728;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x540E;&#x90FD;&#x5FC5;&#x987B;&#x505A;&#x4E24;&#x4E2A;&#x51B3;&#x5B9A;&#xFF1A;1&#x3001;&#x662F;&#x5426;&#x81EA;&#x884C;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#xFF1B;2&#x3001;&#x662F;&#x5426;&#x5C06;&#x8BE5;&#x8BF7;&#x6C42;&#x6CBF;&#x7740;&#x94FE;&#x8FDB;&#x884C;&#x4F20;&#x9012;&#x3002;)</li>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x81EA;&#x884C;&#x7EC4;&#x88C5;&#x94FE;&#xFF0C;&#x6216;&#x8005;&#x4ECE;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x5904;&#x83B7;&#x5F97;&#x9884;&#x5148;&#x7EC4;&#x88C5;&#x597D;&#x7684;&#x94FE;&#x3002;</li>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x89E6;&#x53D1;&#x94FE;&#x4E2D;&#x7684;&#x4EFB;&#x610F;&#x5904;&#x7406;&#x8005;&#xFF0C;&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x3002;&#x8BF7;&#x6C42;&#x5C06;&#x901A;&#x8FC7;&#x94FE;&#x8FDB;&#x884C;&#x4F20;&#x9012;&#xFF0C;&#x76F4;&#x81F3;&#x67D0;&#x4E2A;&#x5904;&#x7406;&#x8005;&#x62D2;&#x7EDD;&#x7EE7;&#x7EED;&#x4F20;&#x9012;&#x6216;&#x8005;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;&#x94FE;&#x5C3E;&#x3002;</li>
</ul>
<h2 id="1-6-&#x4E0A;demo"><a href="#1-6-&#x4E0A;demo" class="headerlink" title="1.6 &#x4E0A;demo"></a>1.6 &#x4E0A;demo</h2><p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/9393440235b480e23a0dcd4561a76b2b5c14db57ce9890711cd0a533a60dbec2" alt="image.png"></p>
<p>RequestHandler :&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x5668;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface RequestHandler {</span><br><span class="line"></span><br><span class="line">  boolean canHandleRequest(Request req);</span><br><span class="line"></span><br><span class="line">  int getPriority();</span><br><span class="line"></span><br><span class="line">  void handle(Request req);</span><br><span class="line"></span><br><span class="line">  String name();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Request&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public class Request {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x6B64;&#x8BF7;&#x6C42;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x7531;&#x94FE;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x9879;&#x76EE;&#x4F7F;&#x7528;&#x4EE5;&#x67E5;&#x770B;&#x5B83;&#x4EEC;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x6216;&#x53EF;&#x4EE5;&#x5904;&#x7406;</span><br><span class="line">   * &#x8FD9;&#x4E2A;&#x7279;&#x6B8A;&#x8981;&#x6C42;</span><br><span class="line">   */</span><br><span class="line">  private final RequestType requestType;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x8BF7;&#x6C42;&#x7684;&#x63CF;&#x8FF0;</span><br><span class="line">   */</span><br><span class="line">  private final String requestDescription;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x6307;&#x793A;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x5DF2;&#x5904;&#x7406;&#x3002;&#x8BF7;&#x6C42;&#x53EA;&#x80FD;&#x5C06;&#x72B6;&#x6001;&#x4ECE;&#x672A;&#x5904;&#x7406;&#x5207;&#x6362;&#x5230;</span><br><span class="line">   * &#x5DF2;&#x5904;&#x7406;&#xFF0C;&#x65E0;&#x6CD5;&#x201C;&#x53D6;&#x6D88;&#x5904;&#x7406;&#x201D;&#x8BF7;&#x6C42;</span><br><span class="line">   */</span><br><span class="line">  private boolean handled;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x521B;&#x5EFA;&#x7ED9;&#x5B9A;&#x7C7B;&#x578B;&#x548C;&#x968F;&#x9644;&#x63CF;&#x8FF0;&#x7684;&#x65B0;&#x8BF7;&#x6C42;&#x3002;</span><br><span class="line">   *</span><br><span class="line">   * @param requestType        The type of request</span><br><span class="line">   * @param requestDescription The description of the request</span><br><span class="line">   */</span><br><span class="line">  public Request(final RequestType requestType, final String requestDescription) {</span><br><span class="line">    this.requestType = Objects.requireNonNull(requestType);</span><br><span class="line">    this.requestDescription = Objects.requireNonNull(requestDescription);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x7684;&#x63CF;&#x8FF0;&#x3002;</span><br><span class="line">   *</span><br><span class="line">   * @&#x8FD4;&#x56DE;&#x8BF7;&#x6C42;&#x7684;&#x4EBA;&#x53EF;&#x8BFB;&#x63CF;&#x8FF0;</span><br><span class="line">   */</span><br><span class="line">  public String getRequestDescription() {</span><br><span class="line">    return requestDescription;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * G&#x83B7;&#x53D6;&#x6B64;&#x8BF7;&#x6C42;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x7531;&#x547D;&#x4EE4;&#x94FE;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x4EBA;&#x4F7F;&#x7528;&#x4EE5;&#x67E5;&#x770B;&#x4ED6;&#x4EEC;&#x662F;&#x5426;&#x5E94;&#x8BE5;</span><br><span class="line">   * &#x6216;&#x8005;&#x53EF;&#x4EE5;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x7279;&#x5B9A;&#x7684;&#x8BF7;&#x6C42;</span><br><span class="line">   *</span><br><span class="line">   * @return The request type</span><br><span class="line">   */</span><br><span class="line">  public RequestType getRequestType() {</span><br><span class="line">    return requestType;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x5C06;&#x8BF7;&#x6C42;&#x6807;&#x8BB0;&#x4E3A;&#x5DF2;&#x5904;&#x7406;</span><br><span class="line">   */</span><br><span class="line">  public void markHandled() {</span><br><span class="line">    this.handled = true;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#x6307;&#x793A;&#x662F;&#x5426;&#x5904;&#x7406;&#x6B64;&#x8BF7;&#x6C42;</span><br><span class="line">   *</span><br><span class="line">   * @return &lt;tt&gt;true&lt;/tt&gt; when the request is handled, &lt;tt&gt;false&lt;/tt&gt; if not</span><br><span class="line">   */</span><br><span class="line">  public boolean isHandled() {</span><br><span class="line">    return this.handled;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return getRequestDescription();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>RequestType&#xFF1A;&#x8BF7;&#x6C42;&#x679A;&#x4E3E;&#x7C7B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public enum RequestType {</span><br><span class="line"></span><br><span class="line">  DEFEND_CASTLE, //&#x9632;&#x5FA1;&#x57CE;&#x5821;</span><br><span class="line">  TORTURE_PRISONER,//&#x9177;&#x5211;&#x56DA;&#x72AF;</span><br><span class="line">  COLLECT_TAX //&#x6536;&#x7A0E;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcCommander&#xFF1A;&#x517D;&#x4EBA;&#x6307;&#x6325;&#x5B98;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class OrcCommander implements RequestHandler {</span><br><span class="line">  @Override</span><br><span class="line">  public boolean canHandleRequest(Request req) {</span><br><span class="line">    return req.getRequestType() == RequestType.DEFEND_CASTLE;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public int getPriority() {</span><br><span class="line">    return 2;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void handle(Request req) {</span><br><span class="line">    req.markHandled();</span><br><span class="line">    LOGGER.info(&quot;{} handling request &quot;{}&quot;&quot;, name(), req);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String name() {</span><br><span class="line">    return &quot;Orc commander&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcKing&#xFF1A; &#x53D1;&#x51FA;&#x7531;&#x94FE;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcKing {</span><br><span class="line"></span><br><span class="line">  private List&lt;RequestHandler&gt; handlers;</span><br><span class="line"></span><br><span class="line">  public OrcKing() {</span><br><span class="line">    buildChain();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  private void buildChain() {</span><br><span class="line">    handlers = Arrays.asList(new OrcCommander(), new OrcOfficer(), new OrcSoldier());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Handle request by the chain.</span><br><span class="line">   */</span><br><span class="line">  public void makeRequest(Request req) {</span><br><span class="line">    handlers</span><br><span class="line">        .stream()</span><br><span class="line">        .sorted(Comparator.comparing(RequestHandler::getPriority))</span><br><span class="line">        .filter(handler -&gt; handler.canHandleRequest(req))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .ifPresent(handler -&gt; handler.handle(req));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcOfficer&#xFF1A;&#x517D;&#x4EBA;&#x519B;&#x5B98;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class OrcOfficer implements RequestHandler {</span><br><span class="line">  @Override</span><br><span class="line">  public boolean canHandleRequest(Request req) {</span><br><span class="line">    return req.getRequestType() == RequestType.TORTURE_PRISONER;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public int getPriority() {</span><br><span class="line">    return 3;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void handle(Request req) {</span><br><span class="line">    req.markHandled();</span><br><span class="line">    LOGGER.info(&quot;{} handling request &quot;{}&quot;&quot;, name(), req);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String name() {</span><br><span class="line">    return &quot;Orc officer&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcSoldier&#xFF1A;&#x517D;&#x4EBA;&#x58EB;&#x5175;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class OrcSoldier implements RequestHandler {</span><br><span class="line">  @Override</span><br><span class="line">  public boolean canHandleRequest(Request req) {</span><br><span class="line">    return req.getRequestType() == RequestType.COLLECT_TAX;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public int getPriority() {</span><br><span class="line">    return 1;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void handle(Request req) {</span><br><span class="line">    req.markHandled();</span><br><span class="line">    LOGGER.info(&quot;{} handling request &quot;{}&quot;&quot;, name(), req);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String name() {</span><br><span class="line">    return &quot;Orc soldier&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line"></span><br><span class="line">    var king = new OrcKing();</span><br><span class="line">    king.makeRequest(new Request(RequestType.DEFEND_CASTLE, &quot;defend castle &#x4FDD;&#x536B;&#x57CE;&#x5821;&quot;));</span><br><span class="line">    king.makeRequest(new Request(RequestType.TORTURE_PRISONER, &quot;torture prisoner &#x9177;&#x5211;&#x56DA;&#x72AF;&quot;));</span><br><span class="line">    king.makeRequest(new Request(RequestType.COLLECT_TAX, &quot;collect tax &#x5F81;&#x7A0E;&quot;));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x7A0B;&#x5E8F; RequestHandler&#x7EC4;&#x7EC7;&#x6210;&#x4E00;&#x4E2A;&#x94FE;&#xFF0C;&#x5176;&#x4E2D; &#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x90FD;&#x6709;&#x673A;&#x4F1A;&#x8F6E;&#x6D41;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x3002;&#x8FD9;&#x91CC;&#x56FD;&#x738B; OrcKing&#x53D1;&#x51FA;&#x8BF7;&#x6C42;&#xFF0C;&#x519B;&#x4E8B;&#x517D;&#x4EBA; OrcCommander&#xFF0C; OrcOfficer, OrcSoldier &#x5F62;&#x6210;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x94FE;&#x3002;</p>
<h1 id="&#x4E8C;&#xFF1A;&#x88C5;&#x9970;&#x6A21;&#x5F0F;"><a href="#&#x4E8C;&#xFF1A;&#x88C5;&#x9970;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E8C;&#xFF1A;&#x88C5;&#x9970;&#x6A21;&#x5F0F;"></a>&#x4E8C;&#xFF1A;&#x88C5;&#x9970;&#x6A21;&#x5F0F;</h1><h2 id="2-1-&#x4EC0;&#x4E48;&#x662F;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x89E3;&#x91CA;&#xFF1A;"><a href="#2-1-&#x4EC0;&#x4E48;&#x662F;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x89E3;&#x91CA;&#xFF1A;" class="headerlink" title="2.1 &#x4EC0;&#x4E48;&#x662F;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x89E3;&#x91CA;&#xFF1A;"></a>2.1 &#x4EC0;&#x4E48;&#x662F;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x89E3;&#x91CA;&#xFF1A;</h2><p>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x53C8;&#x540D;&#x5305;&#x88C5;&#x6A21;&#x5F0F;(Wrapper)&#x3002;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x662F;&#x4EE5;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x900F;&#x660E;&#x7684;&#x65B9;&#x5F0F;&#x6269;&#x5C55;&#x5BF9;&#x8C61;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x662F;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x7684;&#x4E00;&#x79CD;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#x3002;</p>
<ul>
<li>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x4EE5;&#x5BF9;&#x5BA2;&#x6237;&#x900F;&#x660E;&#x7684;&#x65B9;&#x5F0F;&#x52A8;&#x6001;&#x7684;&#x7ED9;&#x5BF9;&#x8C61;&#x9644;&#x52A0;&#x66F4;&#x591A;&#x7684;&#x8D23;&#x4EFB;&#xFF0C;&#x6362;&#x8A00;&#x4E4B;&#x5BA2;&#x6237;&#x5E76;&#x4E0D;&#x4F1A;&#x89C9;&#x5F97;&#x5BF9;&#x8C61;&#x5728;&#x88C5;&#x9970;&#x524D;&#x548C;&#x88C5;&#x9970;&#x540E;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;&#x3002;</li>
<li>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x589E;&#x52A0;&#x5B50;&#x7C7B;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5C06;&#x5BF9;&#x8C61;&#x7684;&#x529F;&#x80FD;&#x6269;&#x5C55;&#x3002;</li>
<li>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8C03;&#x7528;&#x59D4;&#x6D3E;&#x5230;&#x88AB;&#x88C5;&#x9970;&#x7C7B;&#xFF0C;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x5173;&#x952E;&#x5728;&#x4E8E;&#x8FD9;&#x79CD;&#x529F;&#x80FD;&#x7684;&#x6269;&#x5C55;&#x662F;&#x900F;&#x660E;&#x7684;&#x3002;</li>
<li>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x662F;&#x5728;&#x4E0D;&#x5FC5;&#x6539;&#x53D8;&#x539F;&#x7C7B;&#x6587;&#x4EF6;&#x548C;&#x4F7F;&#x7528;&#x7EE7;&#x627F;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x52A8;&#x6001;&#x7684;&#x6269;&#x5C55;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5B83;&#x662F;&#x901A;&#x8FC7;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5305;&#x88C5;&#x5BF9;&#x8C61;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x88C5;&#x9970;&#x6765;&#x5305;&#x88F9;&#x771F;&#x662F;&#x7684;&#x5BF9;&#x8C61;&#x3002;</li>
</ul>
<h2 id="2-2-&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x6210;"><a href="#2-2-&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x6210;" class="headerlink" title="2.2 &#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x6210;"></a>2.2 &#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x7EC4;&#x6210;</h2><ul>
<li>&#x62BD;&#x8C61;&#x6784;&#x4EF6;&#x89D2;&#x8272;(Component):&#x7ED9;&#x51FA;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x63A5;&#x53E3;&#xFF0C;&#x5DF2;&#x89C4;&#x8303;&#x51C6;&#x5907;&#x63A5;&#x53D7;&#x9644;&#x52A0;&#x8D23;&#x4EFB;&#x7684;&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x5177;&#x4F53;&#x6784;&#x4EF6;&#x89D2;&#x8272;(Concrete Component):&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x5C06;&#x8981;&#x63A5;&#x6536;&#x9644;&#x52A0;&#x8D23;&#x4EFB;&#x7684;&#x7C7B;&#x3002;</li>
<li>&#x88C5;&#x9970;&#x89D2;&#x8272;(Decrator):&#x6301;&#x6709;&#x4E00;&#x4E2A;&#x6784;&#x5EFA;&#x89D2;&#x8272;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x5E76;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x4E0E;&#x62BD;&#x8C61;&#x6784;&#x5EFA;&#x89D2;&#x8272;&#x4E00;&#x81F4;&#x7684;&#x63A5;&#x53E3;&#x3002;</li>
<li>&#x5177;&#x4F53;&#x88C5;&#x9970;&#x89D2;&#x8272;(Concrete Decrator):&#x8D1F;&#x8D23;&#x7ED9;&#x6784;&#x5EFA;&#x5BF9;&#x8C61;&#x8D34;&#x4E0A;&#x9644;&#x52A0;&#x7684;&#x8D23;&#x4EFB;&#x3002;</li>
</ul>
<h2 id="2-3-&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;"><a href="#2-3-&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;" class="headerlink" title="2.3 &#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;"></a>2.3 &#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;</h2><p><strong>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x4F18;&#x70B9;:</strong></p>
<ul>
<li>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x4E0E;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x7684;&#x76EE;&#x7684;&#x90FD;&#x662F;&#x8981;&#x6269;&#x5C55;&#x5BF9;&#x8C61;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4F46;&#x662F;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x6BD4;&#x7EE7;&#x627F;&#x66F4;&#x591A;&#x7684;&#x7075;&#x6D3B;&#x6027;&#x3002;</li>
<li>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E00;&#x79CD;&#x52A8;&#x6001;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x6269;&#x5C55;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x88C5;&#x9970;&#x5668;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x4E0D;&#x540C;&#x7684;&#x884C;&#x4E3A;&#x3002;</li>
<li>&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x5177;&#x4F53;&#x88C5;&#x9970;&#x7C7B;&#x4EE5;&#x53CA;&#x8FD9;&#x4E9B;&#x88C5;&#x9970;&#x7C7B;&#x7684;&#x6392;&#x5217;&#x7EC4;&#x5408;&#xFF0C;&#x53EF;&#x4EE5;&#x521B;&#x9020;&#x51FA;&#x5F88;&#x591A;&#x4E0D;&#x540C;&#x884C;&#x4E3A;&#x7684;&#x7EC4;&#x5408;&#x3002;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x4E2A;&#x5177;&#x4F53;&#x88C5;&#x9970;&#x7C7B;&#x6765;&#x88C5;&#x9970;&#x540C;&#x4E00;&#x5BF9;&#x8C61;&#xFF0C;&#x5F97;&#x5230;&#x529F;&#x80FD;&#x66F4;&#x4E3A;&#x5F3A;&#x5927;&#x7684;&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x5177;&#x4F53;&#x6784;&#x4EF6;&#x7C7B;&#x4E0E;&#x5177;&#x4F53;&#x88C5;&#x9970;&#x7C7B;&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x53D8;&#x5316;&#xFF0C;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x9700;&#x8981;&#x589E;&#x52A0;&#x65B0;&#x7684;&#x5177;&#x4F53;&#x6784;&#x4EF6;&#x7C7B;&#x548C;&#x5177;&#x4F53;&#x88C5;&#x9970;&#x7C7B;&#xFF0C;&#x5728;&#x4F7F;&#x7528;&#x65F6;&#x518D;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x7EC4;&#x5408;&#xFF0C;&#x539F;&#x6709;&#x4EE3;&#x7801;&#x65E0;&#x987B;&#x6539;&#x53D8;&#xFF0C;&#x7B26;&#x5408;&#x201C;&#x5F00;&#x95ED;&#x539F;&#x5219;&#x201D;</li>
</ul>
<p><strong>&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x7F3A;&#x70B9;:</strong></p>
<ul>
<li>&#x4F7F;&#x7528;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8BBE;&#x8BA1;&#x65F6;&#x5C06;&#x4EA7;&#x751F;&#x5F88;&#x591A;&#x5C0F;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x76F8;&#x4E92;&#x8FDE;&#x63A5;&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5B83;&#x4EEC;&#x7684;&#x7C7B;&#x6216;&#x8005;&#x5C5E;&#x6027;&#x503C;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;&#x540C;&#x65F6;&#x8FD8;&#x5C06;&#x4EA7;&#x751F;&#x5F88;&#x591A;&#x5177;&#x4F53;&#x88C5;&#x9970;&#x7C7B;&#x3002;&#x8FD9;&#x4E9B;&#x88C5;&#x9970;&#x7C7B;&#x548C;&#x5C0F;&#x5BF9;&#x8C61;&#x7684;&#x4EA7;&#x751F;&#x5C06;&#x589E;&#x52A0;&#x7CFB;&#x7EDF;&#x7684;&#x590D;&#x6742;&#x5EA6;&#xFF0C;&#x52A0;&#x5927;&#x5B66;&#x4E60;&#x4E0E;&#x7406;&#x89E3;&#x7684;&#x96BE;&#x5EA6;&#x3002;</li>
<li>&#x8FD9;&#x79CD;&#x6BD4;&#x7EE7;&#x627F;&#x66F4;&#x52A0;&#x7075;&#x6D3B;&#x673A;&#x52A8;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x4E5F;&#x540C;&#x65F6;&#x610F;&#x5473;&#x7740;&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x6BD4;&#x7EE7;&#x627F;&#x66F4;&#x52A0;&#x6613;&#x4E8E;&#x51FA;&#x9519;&#xFF0C;&#x6392;&#x9519;&#x4E5F;&#x5F88;&#x56F0;&#x96BE;&#xFF0C;&#x5BF9;&#x4E8E;&#x591A;&#x6B21;&#x88C5;&#x9970;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x8C03;&#x8BD5;&#x65F6;&#x5BFB;&#x627E;&#x9519;&#x8BEF;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x9010;&#x7EA7;&#x6392;&#x67E5;&#xFF0C;&#x8F83;&#x4E3A;&#x70E6;&#x7410;&#x3002;</li>
</ul>
<h2 id="2-4&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x9002;&#x7528;&#x73AF;&#x5883;"><a href="#2-4&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x9002;&#x7528;&#x73AF;&#x5883;" class="headerlink" title="2.4&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x9002;&#x7528;&#x73AF;&#x5883;"></a>2.4&#x88C5;&#x9970;&#x6A21;&#x5F0F;&#x7684;&#x9002;&#x7528;&#x73AF;&#x5883;</h2><blockquote>
<ul>
<li>&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4EE5;&#x52A8;&#x6001;&#x3001;&#x900F;&#x660E;&#x7684;&#x65B9;&#x5F0F;&#x7ED9;&#x5355;&#x4E2A;&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x804C;&#x8D23;&#x3002;</li>
<li>&#x9700;&#x8981;&#x52A8;&#x6001;&#x5730;&#x7ED9;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x589E;&#x52A0;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#x4E5F;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x5730;&#x88AB;&#x64A4;&#x9500;&#x3002;</li>
<li>&#x5F53;&#x4E0D;&#x80FD;&#x91C7;&#x7528;&#x7EE7;&#x627F;&#x7684;&#x65B9;&#x5F0F;&#x5BF9;&#x7CFB;&#x7EDF;&#x8FDB;&#x884C;&#x6269;&#x5145;&#x6216;&#x8005;&#x91C7;&#x7528;&#x7EE7;&#x627F;&#x4E0D;&#x5229;&#x4E8E;&#x7CFB;&#x7EDF;&#x6269;&#x5C55;&#x548C;&#x7EF4;&#x62A4;&#x65F6;&#x3002;&#x4E0D;&#x80FD;&#x91C7;&#x7528;&#x7EE7;&#x627F;&#x7684;&#x60C5;&#x51B5;&#x4E3B;&#x8981;&#x6709;&#x4E24;&#x7C7B;&#xFF1A;&#x7B2C;&#x4E00;&#x7C7B;&#x662F;&#x7CFB;&#x7EDF;&#x4E2D;&#x5B58;&#x5728;&#x5927;&#x91CF;&#x72EC;&#x7ACB;&#x7684;&#x6269;&#x5C55;&#xFF0C;&#x4E3A;&#x652F;&#x6301;&#x6BCF;&#x4E00;&#x79CD;&#x7EC4;&#x5408;&#x5C06;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x7684;&#x5B50;&#x7C7B;&#xFF0C;&#x4F7F;&#x5F97;&#x5B50;&#x7C7B;&#x6570;&#x76EE;&#x5448;&#x7206;&#x70B8;&#x6027;&#x589E;&#x957F;&#xFF1B;&#x7B2C;&#x4E8C;&#x7C7B;&#x662F;&#x56E0;&#x4E3A;&#x7C7B;&#x5B9A;&#x4E49;&#x4E0D;&#x80FD;&#x7EE7;&#x627F;&#xFF08;&#x5982;final&#x7C7B;&#xFF09;.</li>
</ul>
</blockquote>
<h2 id="2-5-&#x4E0A;demo"><a href="#2-5-&#x4E0A;demo" class="headerlink" title="2.5 &#x4E0A;demo"></a>2.5 &#x4E0A;demo</h2><p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/8ea4e59315b78f2f56eb7c2b119f4f8fddee5ba1a2dd3909c190729dbcd6487f" alt="image.png"></p>
<p>Troll&#xFF1A;&#x5DE8;&#x9B54;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Troll {</span><br><span class="line"></span><br><span class="line">  void attack(); //&#x653B;&#x51FB;</span><br><span class="line"></span><br><span class="line">  int getAttackPower(); // &#x83B7;&#x53D6;&#x653B;&#x51FB;&#x529B;</span><br><span class="line"></span><br><span class="line">  void fleeBattle(); //&#x9003;&#x79BB;&#x6218;&#x6597;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x68D2;&#x5B50;&#x5DE8;&#x9B54;&#x5B9E;&#x73B0;&#x5DE8;&#x9B54;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class ClubbedTroll implements Troll {</span><br><span class="line"></span><br><span class="line">  private final Troll decorated;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void attack() {</span><br><span class="line">    decorated.attack();</span><br><span class="line">    LOGGER.info(&quot;The troll swings at you with a club!&quot;);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public int getAttackPower() {</span><br><span class="line">    return decorated.getAttackPower() + 10;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void fleeBattle() {</span><br><span class="line">    decorated.fleeBattle();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E00;&#x822C;&#x7684;&#x5DE8;&#x9B54;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class SimpleTroll implements Troll {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void attack() {</span><br><span class="line">    LOGGER.info(&quot;The troll tries to grab you!&quot;);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public int getAttackPower() {</span><br><span class="line">    return 10;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void fleeBattle() {</span><br><span class="line">    LOGGER.info(&quot;The troll shrieks in horror and runs away!&quot;);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line"></span><br><span class="line">    // simple troll</span><br><span class="line">    LOGGER.info(&quot;A simple looking troll approaches.&quot;);</span><br><span class="line">    var troll = new SimpleTroll();</span><br><span class="line">    troll.attack();</span><br><span class="line">    troll.fleeBattle();</span><br><span class="line">    LOGGER.info(&quot;Simple troll power: {}.\n&quot;, troll.getAttackPower());</span><br><span class="line"></span><br><span class="line">    // &#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x88C5;&#x9970;&#x5668;&#x6539;&#x53D8;&#x7B80;&#x5355;&#x5DE8;&#x9B54;&#x7684;&#x884C;&#x4E3A;</span><br><span class="line">    LOGGER.info(&quot;A troll with huge club surprises you.&quot;);</span><br><span class="line">    var clubbedTroll = new ClubbedTroll(troll);</span><br><span class="line">    clubbedTroll.attack();</span><br><span class="line">    clubbedTroll.fleeBattle();</span><br><span class="line">    LOGGER.info(&quot;Clubbed troll power: {}.\n&quot;, clubbedTroll.getAttackPower());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C55;&#x793A;&#x4E86;&#x7B80;&#x5355;&#x7684; SimpleTroll &#x5982;&#x4F55;&#x9996;&#x5148;&#x653B;&#x51FB;&#x7136;&#x540E;&#x9003;&#x79BB; &#x6218;&#x6597;&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x7528; ClubbedTroll&#x88C5;&#x9970; SimpleTroll &#x5E76;&#x518D;&#x6B21;&#x6267;&#x884C;&#x653B;&#x51FB;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x88C5;&#x9970;&#x540E;&#x884C;&#x4E3A;&#x53D1;&#x751F;&#x4E86;&#x600E;&#x6837;&#x7684;&#x53D8;&#x5316;&#x3002;</p>
<p>&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x662F;&#x5B50;&#x7C7B;&#x5316;&#x7684;&#x66F4;&#x7075;&#x6D3B;&#x7684;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#x3002; Decorator &#x7C7B;&#x5B9E;&#x73B0;&#x4E0E;&#x76EE;&#x6807;&#x76F8;&#x540C;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x7EC4;&#x5408;&#x6765;&#x201C;&#x88C5;&#x9970;&#x201D;&#x5BF9;&#x76EE;&#x6807;&#x7684;&#x8C03;&#x7528;&#x3002;&#x4F7F;&#x7528;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x6539;&#x53D8;&#x7C7B;&#x7684;&#x884C;&#x4E3A;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/43e8cd04d188719303ba88f16bb49e74.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237051958993469496.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237051958993469496.html" itemprop="url">这道面试题真的很变态吗？😱</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-25T22:38:11+08:00">
                2023-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x6700;&#x8FD1;&#x5E2E;&#x516C;&#x53F8;&#x62DB;&#x8058;&#xFF0C;&#x4E3B;&#x8981;&#x8D1F;&#x8D23;&#x4E00;&#x9762;&#xFF0C;&#x6240;&#x4EE5;&#x57FA;&#x672C;&#x4E0A;&#x95EE;&#x7684;&#x57FA;&#x7840;&#x591A;&#x4E00;&#x70B9;&#x3002;&#x4F46;&#x662F;&#x6211;&#x5728;&#x95EE;&#x8FD9;&#x6837;&#x4E00;&#x9053;&#x9762;&#x8BD5;&#x9898;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5F88;&#x5C11;&#x6709;&#x4EBA;&#x7B54;&#x5BF9;&#x3002;&#x4E0D;&#x5C11;&#x4EBA;&#x89C9;&#x5F97;&#x6211;&#x95EE;&#x8FD9;&#x9053;&#x9898;&#x591A;&#x5C11;&#x6709;&#x70B9;&#x8FC7;&#x5206;&#x4E86;&#x1F62D;&#xFF0C;&#x5F53;&#x7136;&#x4E86;&#x9762;&#x8BD5;&#x8FD8;&#x662F;&#x5954;&#x7740;&#x76F8;&#x4E92;&#x6C9F;&#x901A;&#x76F8;&#x4E92;&#x5B66;&#x4E60;&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x8BF4;&#x8FD9;&#x9053;&#x9898;&#x4E0D;&#x4F1A;&#x5C31;&#x88AB;&#x5237;&#x6389;&#xFF0C;&#x5355;&#x7EAF;&#x7684;&#x89C9;&#x5F97;&#x8FD9;&#x9053;&#x9898;&#x6709;&#x610F;&#x601D;&#x3002;&#x8BDD;&#x4E0D;&#x591A;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x4E0A;&#x9898;</p>
<h2 id="&#x9898;&#x76EE;"><a href="#&#x9898;&#x76EE;" class="headerlink" title="&#x9898;&#x76EE;"></a>&#x9898;&#x76EE;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var foo = function () {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">var foo = function () {</span><br><span class="line">    console.log(&quot;foo2&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function foo() {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">function foo() {</span><br><span class="line">    console.log(&quot;foo2&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x6211;&#x4F1A;&#x8981;&#x6C42;&#x9762;&#x8BD5;&#x8005;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x4F9D;&#x6B21;&#x8BF4;&#x51FA;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;&#x666E;&#x904D;&#x591A;&#x7684;&#x9762;&#x8BD5;&#x8005;&#x7ED9;&#x51FA;&#x7684;&#x7B54;&#x6848;&#x662F;&#xFF1A;foo1&#x3001;foo2&#x3001;foo1&#x3001;foo2&#x3002;&#x867D;&#x7136;&#x5728;&#x6211;&#x770B;&#x6765;&#x8FD9;&#x662F;&#x4E00;&#x9053;&#x7B80;&#x5355;&#x7684;&#x9762;&#x8BD5;&#x9898;&#xFF0C;&#x4F46;&#x662F;&#x4E5F;&#x4E0D;&#x81F3;&#x4E8E;&#x8FD9;&#x4E48;&#x7B80;&#x5355;&#x5427;&#x1F631;<del>~</del></p>
<p>&#x5F53;&#x7136;&#x9762;&#x8BD5;&#x672C;&#x6765;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x76F8;&#x4E92;&#x8BA8;&#x8BBA;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x90A3;&#x5C31;&#x548C;&#x9762;&#x8BD5;&#x8005;&#x6C9F;&#x901A;&#x4E0B;&#x8FD9;&#x9053;&#x9898;&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x4E07;&#x4E00;&#x6211;&#x7406;&#x89E3;&#x9519;&#x4E86;&#x5462;&#x1F602;</p>
<h2 id="&#x89E3;&#x7B54;"><a href="#&#x89E3;&#x7B54;" class="headerlink" title="&#x89E3;&#x7B54;"></a>&#x89E3;&#x7B54;</h2><h3 id="&#x62C6;&#x5206;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;"><a href="#&#x62C6;&#x5206;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;" class="headerlink" title="&#x62C6;&#x5206;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;"></a>&#x62C6;&#x5206;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;</h3><p>&#x9996;&#x5148;&#x6211;&#x4F1A;&#x8BA9;&#x9762;&#x8BD5;&#x8005;&#x5148;&#x770B;&#x524D;&#x9762;&#x4E24;&#x4E2A;&#x51FD;&#x6570;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var foo = function () {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">var foo = function () {</span><br><span class="line">    console.log(&quot;foo2&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x65F6;&#x5019;&#x5927;&#x90E8;&#x5206;&#x4EBA;&#x57FA;&#x672C;&#x4E0A;&#x90FD;&#x53EF;&#x4EE5;&#x7B54;&#x5BF9;&#x4E86;&#xFF0C;&#x662F;&#xFF1A;foo1&#x3001;foo2&#x3002;&#x518D;&#x6709;&#x5F88;&#x5C11;&#x6570;&#x7684;&#x4EBA;&#x7B54;&#x4E0D;&#x5BF9;&#x90A3;&#x5C31;&#x53EA;&#x80FD;&#x201D;&#x65BD;&#x4E3B;&#xFF0C;&#x51FA;&#x95E8;&#x53F3;&#x8F6C;&#x201C;&#x1F60C;&#x3002;&#x63A5;&#x7740;&#x6839;&#x636E;&#x6211;&#x5F53;&#x65F6;&#x7684;&#x5FC3;&#x60C5;&#x53EF;&#x80FD;&#x4F1A;&#x7A0D;&#x4F5C;&#x8FFD;&#x95EE;&#xFF08;&#x7F8E;&#x5973;&#x9664;&#x5916;&#x1F642;&#xFF09;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;foo()</span><br><span class="line">var foo = function () {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x65F6;&#x5019;&#x53C8;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x4EBA;&#x7B54;&#x4E0D;&#x4E0A;&#x6765;&#x4E86;&#x3002;&#x8FD9;&#x6BEB;&#x65E0;&#x7591;&#x95EE;&#x662F;&#x80AF;&#x5B9A;&#x4F1A;&#x62A5;&#x9519;&#x7684;&#x554A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/9a24fab6a2faf1fd2c992bbb45b9cf1a07e5a361d534db5023769de42e71b59e" alt="image.png"></p>
<p>&#x6211;&#x4EEC;&#x90FD;&#x77E5;&#x9053;&#x7528;var&#x5B9A;&#x4E49;&#x7684;&#x53D8;&#x91CF;&#x4F1A;&#x53D8;&#x91CF;&#x63D0;&#x5347;&#xFF0C;&#x6240;&#x4EE5;&#x58F0;&#x660E;&#x4F1A;&#x88AB;&#x62FF;&#x5230;&#x51FD;&#x6570;&#x6216;&#x5168;&#x5C40;&#x4F5C;&#x7528;&#x57DF;&#x7684;&#x9876;&#x90E8;&#xFF0C;&#x5E76;&#x4E14;&#x8F93;&#x51FA;undefined&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x6267;&#x884C;foo()&#x7684;&#x65F6;&#x5019;&#xFF0C;foo&#x8FD8;&#x662F;undefined&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x62A5;&#x9519;&#x3002;&#x7531;&#x4E8E;js&#x4ECE;&#x6309;&#x7167;&#x987A;&#x5E8F;&#x4ECE;&#x4E0A;&#x5F80;&#x4E0B;&#x6267;&#x884C;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;&#x6267;&#x884C;<code>foo = function(){}</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x5BF9;foo&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x4E3A;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x3002;&#x6211;&#x4EEC;&#x91CD;&#x65B0;&#x770B;&#x62C6;&#x5206;&#x4E4B;&#x540E;&#x7684;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var foo = function () {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">var foo = function () {</span><br><span class="line">    console.log(&quot;foo2&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<p>foo&#x9996;&#x5148;&#x4F1A;&#x53D8;&#x91CF;&#x63D0;&#x5347;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x4E3A;function&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x6267;&#x884C;&#x7B2C;&#x4E00;&#x4E2A;foo&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6B64;&#x65F6;foo&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8D4B;&#x503C;&#x7684;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x3002;&#x63A5;&#x7740;&#x6267;&#x884C;&#x7B2C;&#x4E8C;&#x4E2A;foo&#x7684;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#xFF0C;&#x7531;&#x4E8E;&#x51FD;&#x6570;&#x4F5C;&#x7528;&#x57DF;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x540E;&#x9762;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x5C06;&#x8986;&#x76D6;&#x524D;&#x9762;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x3002;<br><strong>&#x7531;&#x4E8E;&#x5728;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x5C31;&#x8FDB;&#x884C;&#x4E86;&#x51FD;&#x6570;&#x7684;&#x91CD;&#x65B0;&#x5B9A;&#x4E49;</strong>&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x6267;&#x884C;&#x7684;&#x662F;&#x6700;&#x540E;&#x5B9A;&#x4E49;&#x7684;&#x90A3;&#x4E2A;&#x51FD;&#x6570;&#x3002;&#x6240;&#x4EE5;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4F1A;&#x6253;&#x5370;&#xFF1A;foo1&#x3001;foo2&#x3002;</p>
<p>&#x8FD9;&#x79CD;&#x5B9A;&#x4E49;&#x51FD;&#x6570;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x79F0;&#x4E3A;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x3002;<strong>&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x662F;&#x5C06;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x503C;&#x8D4B;&#x7ED9;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x6216;&#x5C5E;&#x6027;</strong></p>
<p>&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x6211;&#x4EEC;&#x62C6;&#x5206;&#x5B8C;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x5C31;&#x770B;&#x770B;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5427;&#x3002;</p>
<h2 id="&#x62C6;&#x5206;&#x51FD;&#x6570;&#x58F0;&#x660E;"><a href="#&#x62C6;&#x5206;&#x51FD;&#x6570;&#x58F0;&#x660E;" class="headerlink" title="&#x62C6;&#x5206;&#x51FD;&#x6570;&#x58F0;&#x660E;"></a>&#x62C6;&#x5206;&#x51FD;&#x6570;&#x58F0;&#x660E;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;function foo() {</span><br><span class="line">    console.log(&quot;foo1&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">function foo() {</span><br><span class="line">    console.log(&quot;foo2&quot;)</span><br><span class="line">}</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<p>&#x5927;&#x90E8;&#x5206;&#x4EBA;&#x5176;&#x5B9E;&#x90FD;&#x5361;&#x5728;&#x4E86;&#x8FD9;&#x91CC;&#x3002;<strong>&#x51FD;&#x6570;&#x58F0;&#x660E;&#x4F1A;&#x5728;&#x4EFB;&#x4F55;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x4E4B;&#x524D;&#x5148;&#x88AB;&#x8BFB;&#x53D6;&#x5E76;&#x6DFB;&#x52A0;&#x5230;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;</strong>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x63D0;&#x5347;&#x3002;&#x8BF4;&#x5230;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x5927;&#x591A;&#x6570;&#x4EBA;&#x5C31;&#x5DF2;&#x7ECF;&#x660E;&#x767D;&#x4E86;&#x3002;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5B9A;&#x4E49;&#x4E86;&#x4E24;&#x4E2A;foo&#x51FD;&#x6570;&#xFF0C;&#x7531;&#x4E8E;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x63D0;&#x5347;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;foo&#x4F1A;&#x8986;&#x76D6;&#x7B2C;&#x4E00;&#x4E2A;foo,&#x6240;&#x4EE5;&#x5F53;&#x8C03;&#x7528;&#x7B2C;&#x4E00;&#x4E2A;foo&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5176;&#x5B9E;&#x5DF2;&#x7ECF;&#x88AB;&#x7B2C;&#x4E8C;&#x4E2A;foo&#x8986;&#x76D6;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E24;&#x4E2A;&#x6253;&#x5370;&#x7684;&#x90FD;&#x662F;foo2&#x3002;</p>
<h2 id="&#x5F53;&#x4E24;&#x6BB5;&#x4EE3;&#x7801;&#x7ED3;&#x5408;"><a href="#&#x5F53;&#x4E24;&#x6BB5;&#x4EE3;&#x7801;&#x7ED3;&#x5408;" class="headerlink" title="&#x5F53;&#x4E24;&#x6BB5;&#x4EE3;&#x7801;&#x7ED3;&#x5408;"></a>&#x5F53;&#x4E24;&#x6BB5;&#x4EE3;&#x7801;&#x7ED3;&#x5408;</h2><p>&#x5F53;&#x5F00;&#x59CB;&#x89E3;&#x6790;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5C31;&#x5DF2;&#x7ECF;&#x63D0;&#x5347;&#x4E86;&#xFF0C;&#x7B2C;&#x56DB;&#x4E2A;foo&#x4F1A;&#x8986;&#x76D6;&#x7B2C;&#x4E09;&#x4E2A;foo&#x3002;&#x7136;&#x540E;js&#x5F00;&#x59CB;&#x4ECE;&#x4E0A;&#x5F80;&#x4E0B;&#x6267;&#x884C;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#x4E4B;&#x540E;&#x6267;&#x884C;foo()&#x540E;&#xFF0C;&#x6253;&#x5370;&#x4E86;&#x201D;foo1&#x201C;,&#x7B2C;&#x4E8C;&#x4E2A;&#x8D4B;&#x503C;&#x4E4B;&#x540E;&#x6267;&#x884C;foo()&#xFF0C;&#x6253;&#x5370;&#x4E86;&#x201D;foo2&#x201D;&#x3002;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;foo&#x7684;&#x6267;&#x884C;&#x5176;&#x5B9E;&#x662F;&#x7B2C;&#x4E8C;&#x4E2A;&#x8D4B;&#x503C;&#x4E86;&#x7684;foo,&#x56E0;&#x4E3A;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5F00;&#x59CB;&#x4ECE;&#x521A;&#x5F00;&#x59CB;&#x5C31;&#x88AB;&#x63D0;&#x5347;&#x4E86;&#xFF0C;&#x800C;&#x4E0B;&#x9762;&#x7684;&#x8D4B;&#x503C;&#x4F1A;&#x8986;&#x76D6;foo&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x6211;&#x4EEC;&#x6574;&#x4F53;&#x5206;&#x6790;&#x4EE3;&#x7801;&#x7684;&#x6267;&#x884C;&#x8FC7;&#x7A0B;</p>
<ol>
<li>&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x5B9A;&#x4E49;&#x53D8;&#x91CF;<code>foo</code>&#x5E76;&#x8D4B;&#x503C;&#x4E3A;&#x4E00;&#x4E2A;&#x533F;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x5728;&#x88AB;&#x8C03;&#x7528;&#x65F6;&#x6253;&#x5370;&#x201D;foo1&#x201D;&#x3002;</li>
<li>&#x63A5;&#x7740;&#xFF0C;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x91CD;&#x65B0;&#x5B9A;&#x4E49;&#x53D8;&#x91CF;<code>foo</code>&#xFF0C;&#x8D4B;&#x503C;&#x4E3A;&#x53E6;&#x4E00;&#x4E2A;&#x533F;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x5728;&#x88AB;&#x8C03;&#x7528;&#x65F6;&#x6253;&#x5370;&#x201D;foo2&#x201D;&#x3002;</li>
<li>&#x4F7F;&#x7528;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5B9A;&#x4E49;&#x4E86;&#x4E24;&#x4E2A;&#x540D;&#x4E3A;<code>foo</code>&#x7684;&#x51FD;&#x6570;&#x3002;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x4F1A;&#x5728;&#x4F5C;&#x7528;&#x57DF;&#x4E2D;&#x8FDB;&#x884C;&#x63D0;&#x5347;&#x3002;&#x540E;&#x9762;&#x7684;&#x4F1A;&#x8986;&#x76D6;&#x524D;&#x9762;&#x7684;&#xFF0C;&#x7531;&#x4E8E;&#x58F0;&#x660E;&#x4ECE;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x63D0;&#x5347;&#x4E86;&#xFF0C;&#x800C;&#x53C8;&#x6267;&#x884C;&#x4E86;&#x4E24;&#x4E2A;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x6B64;&#x65F6;foo&#x662F;&#x7B2C;&#x4E8C;&#x4E2A;&#x8D4B;&#x503C;&#x7684;&#x51FD;&#x6570;&#x3002;</li>
<li>&#x7136;&#x540E;&#x8C03;&#x7528;<code>foo()</code>&#xFF0C;&#x8F93;&#x51FA;&#x201D;foo2&#x201D;&#x3002;</li>
<li>&#x518D;&#x8C03;&#x7528;<code>foo()</code>&#xFF0C;&#x4E5F;&#x8F93;&#x51FA;&#x201D;foo2&#x201D;&#x3002;</li>
</ol>
<p>&#x5176;&#x5B9E;&#x5C31;&#x4E00;&#x4E2A;&#x70B9;&#xFF1A; <strong>&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x76F8;&#x5BF9;&#x4E8E;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x7684;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x533A;&#x522B;&#x662F;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5728;&#x4EE3;&#x7801;&#x89E3;&#x6790;&#x9636;&#x6BB5;&#x5C31;&#x4F1A;&#x88AB;&#x63D0;&#x5347;&#xFF08;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x63D0;&#x5347;&#xFF09;&#xFF0C;&#x800C;&#x51FD;&#x6570;&#x8868;&#x8FBE;&#x5F0F;&#x5219;&#x9700;&#x8981;&#x5728;&#x8D4B;&#x503C;&#x8BED;&#x53E5;&#x6267;&#x884C;&#x5230;&#x8FBE;&#x65F6;&#x624D;&#x4F1A;&#x521B;&#x5EFA;&#x51FD;&#x6570;&#x5BF9;&#x8C61;</strong></p>
<p>&#x5C0F;&#x4F19;&#x4F34;&#x4EEC;&#xFF0C;&#x4EE5;&#x4E0A;&#x662F;&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x6B22;&#x8FCE;&#x5728;&#x8BC4;&#x8BBA;&#x533A;&#x7559;&#x8A00;&#xFF0C;&#x5927;&#x5BB6;&#x76F8;&#x4E92;&#x8BA8;&#x8BBA;&#x76F8;&#x4E92;&#x5B66;&#x4E60;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x7684;&#x63CF;&#x8FF0;&#x786E;&#x5B9E;&#x6709;&#x70B9;&#x4E0D;&#x59A5;&#xFF0C;&#x6240;&#x4EE5;&#x505A;&#x4E86;&#x6539;&#x52A8;&#xFF0C;&#x671B;&#x5927;&#x5BB6;&#x8C05;&#x89E3;&#xFF0C;&#x8FD8;&#x662F;&#x672C;&#x7740;&#x76F8;&#x4E92;&#x5B66;&#x4E60;&#x7684;&#x6001;&#x5EA6;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/75eac98d42c6b28554e8cb844eae7cc1.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237046997734883386.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237046997734883386.html" itemprop="url">JYM 设计模式系列- 策略模式，模板方法模式，让你的代码更</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-25T20:38:00+08:00">
                2023-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x89C9;&#x5F97;&#x4E0D;&#x9519;&#x8BF7;&#x6309;&#x4E0B;&#x56FE;&#x64CD;&#x4F5C;&#xFF0C;&#x6398;&#x53CB;&#x4EEC;&#xFF0C;&#x54C8;&#x54C8;&#x54C8;&#xFF01;&#xFF01;&#xFF01;<br><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/65778c41bc60c72d236c320e8d0f067c99f567e785167c96bbb39732a5310da4" alt="image.png"></p>
<h1 id="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"><a href="#&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;" class="headerlink" title="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"></a>&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;</h1><p>&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x7C7B;&#xFF1A;</p>
<ul>
<li><strong>&#x521B;&#x5EFA;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E94;&#x79CD;&#xFF1A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E03;&#x79CD;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x3001;&#x5916;&#x89C2;&#x6A21;&#x5F0F;&#x3001;&#x6865;&#x63A5;&#x6A21;&#x5F0F;&#x3001;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;&#x3001;&#x4EAB;&#x5143;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x5341;&#x4E00;&#x79CD;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x3001;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x8FED;&#x4EE3;&#x5B50;&#x6A21;&#x5F0F;&#x3001;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3001;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x3001;&#x5907;&#x5FD8;&#x5F55;&#x6A21;&#x5F0F;&#x3001;&#x72B6;&#x6001;&#x6A21;&#x5F0F;&#x3001;&#x8BBF;&#x95EE;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x4E2D;&#x4ECB;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x89E3;&#x91CA;&#x5668;&#x6A21;&#x5F0F;&#x3002;</strong></li>
</ul>
<h1 id="&#x4E00;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;"><a href="#&#x4E00;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E00;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;"></a>&#x4E00;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;</h1><p>Strategy &#x6A21;&#x5F0F;&#xFF08;&#x4E5F;&#x79F0;&#x4E3A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#xFF09;&#x662F;&#x4E00;&#x79CD;&#x8F6F;&#x4EF6;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x5141;&#x8BB8;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#x7684;&#x884C;&#x4E3A;&#x3002;&#x5728; Java 8 &#x4E4B;&#x524D;&#xFF0C;Strategies &#x9700;&#x8981;&#x662F;&#x5355;&#x72EC;&#x7684;&#x7C7B;&#xFF0C;&#x8FEB;&#x4F7F;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x7F16;&#x5199;&#x5927;&#x91CF;&#x6837;&#x677F;&#x4EE3;&#x7801;&#x3002;&#x4F7F;&#x7528;&#x73B0;&#x4EE3; Java&#xFF0C;&#x5F88;&#x5BB9;&#x6613;&#x901A;&#x8FC7;&#x65B9;&#x6CD5;&#x5F15;&#x7528;&#x548C; lambda &#x4F20;&#x9012;&#x884C;&#x4E3A;&#xFF0C;&#x4ECE;&#x800C;&#x4F7F;&#x4EE3;&#x7801;&#x66F4;&#x77ED;&#x3001;&#x66F4;&#x6613;&#x8BFB;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D; DragonSlayingStrategy &#x5C01;&#x88C5;&#x4E86;&#x4E00;&#x4E2A;&#x7B97;&#x6CD5;&#x3002;&#x5305;&#x542B;&#x5BF9;&#x8C61; DragonSlayer&#xFF08;&#x5C60;&#x9F99;&#x8005;&#xFF09; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6539;&#x53D8;&#x5B83;&#x7684;&#x7B56;&#x7565;&#x6765;&#x6539;&#x53D8;&#x5B83;&#x7684;&#x884C;&#x4E3A;&#x3002;</p>
<h2 id="1-1-&#x4F7F;&#x7528;&#x573A;&#x666F;"><a href="#1-1-&#x4F7F;&#x7528;&#x573A;&#x666F;" class="headerlink" title="1.1 &#x4F7F;&#x7528;&#x573A;&#x666F;"></a>1.1 &#x4F7F;&#x7528;&#x573A;&#x666F;</h2><ul>
<li>&#x9488;&#x5BF9;&#x540C;&#x4E00;&#x7C7B;&#x578B;&#x7684;&#x95EE;&#x9898;&#x591A;&#x79CD;&#x5904;&#x7406;</li>
<li>&#x9700;&#x8981;&#x5B89;&#x5168;&#x7684;&#x5C01;&#x88C5;&#x591A;&#x79CD;&#x540C;&#x4E00;&#x7C7B;&#x578B;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5BF9;&#x5BA2;&#x6237;&#x9690;&#x85CF;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;</li>
<li>&#x51FA;&#x73B0;&#x540C;&#x4E00;&#x62BD;&#x8C61;&#x7C7B;&#x6709;&#x591A;&#x4E2A;&#x5B50;&#x7C7B;&#xFF0C;&#x800C;&#x53C8;&#x9700;&#x8981;&#x4F7F;&#x7528; if-else &#x6216;&#x8005;switch-case &#x6765;&#x9009;&#x62E9;&#x5177;&#x4F53;&#x5B50;&#x7C7B;&#x65F6;&#x3002;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/7c949bd6ffe0184cb233251abab836d1ee8b1f7156730a0b8a004e7d06af31d2" alt="image.png"></p>
<h2 id="1-2-&#x4F18;&#x7F3A;&#x70B9;"><a href="#1-2-&#x4F18;&#x7F3A;&#x70B9;" class="headerlink" title="1.2 &#x4F18;&#x7F3A;&#x70B9;"></a>1.2 &#x4F18;&#x7F3A;&#x70B9;</h2><h3 id="&#x4F18;&#x70B9;"><a href="#&#x4F18;&#x70B9;" class="headerlink" title="&#x4F18;&#x70B9;"></a>&#x4F18;&#x70B9;</h3><ul>
<li>&#x7ED3;&#x6784;&#x6E05;&#x6670;&#x660E;&#x4E86;&#xFF0C;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x76F4;&#x89C2;</li>
<li>&#x8026;&#x5408;&#x5EA6;&#x76F8;&#x5BF9;&#x8F83;&#x4F4E;&#xFF0C;&#x6269;&#x5C55;&#x65B9;&#x4FBF;</li>
<li>&#x64CD;&#x4F5C;&#x5C01;&#x88C5;&#x66F4;&#x5F7B;&#x5E95;&#xFF0C;&#x6570;&#x636E;&#x66F4;&#x52A0;&#x5B89;&#x5168;</li>
</ul>
<h3 id="&#x7F3A;&#x70B9;"><a href="#&#x7F3A;&#x70B9;" class="headerlink" title="&#x7F3A;&#x70B9;"></a>&#x7F3A;&#x70B9;</h3><ul>
<li>&#x968F;&#x7740;&#x7B56;&#x7565;&#x7684;&#x589E;&#x52A0;&#xFF0C;&#x7C7B; &#x4F1A;&#x53D8;&#x5F97;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#xFF0C;&#x5BB9;&#x6613;&#x9020;&#x6210;&#x7C7B;&#x7206;&#x70B8;</li>
<li>&#x4F7F;&#x7528;&#x8005;&#x5FC5;&#x987B;&#x77E5;&#x9053;&#x6240;&#x6709;&#x7B56;&#x7565;&#x7C7B;&#xFF0C;&#x5E76;&#x81EA;&#x884C;&#x89E3;&#x51B3;&#x4F7F;&#x7528;&#x54EA;&#x4E2A;&#x7B56;&#x7565;</li>
</ul>
<h2 id="1-3-&#x76F4;&#x63A5;&#x4E0A;demo"><a href="#1-3-&#x76F4;&#x63A5;&#x4E0A;demo" class="headerlink" title="1.3 &#x76F4;&#x63A5;&#x4E0A;demo"></a>1.3 &#x76F4;&#x63A5;&#x4E0A;demo</h2><p>&#x7B56;&#x7565;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;@FunctionalInterface</span><br><span class="line">public interface DragonSlayingStrategy {</span><br><span class="line"></span><br><span class="line">  void execute();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>DragonSlayer&#xFF1A;&#x5C60;&#x9F99;&#x8005;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x7B56;&#x7565;&#x6765;&#x5C60;&#x9F99;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public class DragonSlayer {</span><br><span class="line"></span><br><span class="line">  private DragonSlayingStrategy strategy;</span><br><span class="line"></span><br><span class="line">  public DragonSlayer(DragonSlayingStrategy strategy) {</span><br><span class="line">    this.strategy = strategy;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  public void changeStrategy(DragonSlayingStrategy strategy) {</span><br><span class="line">    this.strategy = strategy;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  public void goToBattle() {</span><br><span class="line">    strategy.execute();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x679A;&#x4E3E;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x7684; Lambda &#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class LambdaStrategy {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Enum to demonstrate strategy pattern.</span><br><span class="line">   */</span><br><span class="line">  public enum Strategy implements DragonSlayingStrategy {</span><br><span class="line">    MeleeStrategy(() -&gt; LOGGER.info(</span><br><span class="line">        &quot;With your Excalibur you severe the dragon&apos;s head!&quot;)),</span><br><span class="line">    ProjectileStrategy(() -&gt; LOGGER.info(</span><br><span class="line">        &quot;You shoot the dragon with the magical crossbow and it falls dead on the ground!&quot;)),</span><br><span class="line">    SpellStrategy(() -&gt; LOGGER.info(</span><br><span class="line">        &quot;You cast the spell of disintegration and the dragon vaporizes in a pile of dust!&quot;));</span><br><span class="line"></span><br><span class="line">    private final DragonSlayingStrategy dragonSlayingStrategy;</span><br><span class="line"></span><br><span class="line">    Strategy(DragonSlayingStrategy dragonSlayingStrategy) {</span><br><span class="line">      this.dragonSlayingStrategy = dragonSlayingStrategy;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void execute() {</span><br><span class="line">      dragonSlayingStrategy.execute();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD1;&#x6218;&#x7B56;&#x7565;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class MeleeStrategy implements DragonSlayingStrategy {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void execute() {</span><br><span class="line">    LOGGER.info(&quot;With your Excalibur you sever the dragon&apos;s head!&quot;);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5F39;&#x4E38;&#x7B56;&#x7565;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class ProjectileStrategy implements DragonSlayingStrategy {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void execute() {</span><br><span class="line">    LOGGER.info(&quot;You shoot the dragon with the magical crossbow and it falls dead on the ground!&quot;);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6CD5;&#x672F;&#x7B56;&#x7565;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class SpellStrategy implements DragonSlayingStrategy {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void execute() {</span><br><span class="line">    LOGGER.info(&quot;You cast the spell of disintegration and the dragon vaporizes in a pile of dust!&quot;);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  private static final String RED_DRAGON_EMERGES = &quot;Red dragon emerges.&quot;;</span><br><span class="line">  private static final String GREEN_DRAGON_SPOTTED = &quot;Green dragon spotted ahead!&quot;;</span><br><span class="line">  private static final String BLACK_DRAGON_LANDS = &quot;Black dragon lands before you.&quot;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    //GoF &#x7B56;&#x7565;&#x6A21;&#x5F0F;</span><br><span class="line">    LOGGER.info(GREEN_DRAGON_SPOTTED);</span><br><span class="line">    var dragonSlayer = new DragonSlayer(new MeleeStrategy());</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(RED_DRAGON_EMERGES);</span><br><span class="line">    dragonSlayer.changeStrategy(new ProjectileStrategy());</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(BLACK_DRAGON_LANDS);</span><br><span class="line">    dragonSlayer.changeStrategy(new SpellStrategy());</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line"></span><br><span class="line">    // Java 8 &#x51FD;&#x6570;&#x5F0F;&#x5B9E;&#x73B0;&#x7B56;&#x7565;&#x6A21;&#x5F0F;</span><br><span class="line">    LOGGER.info(GREEN_DRAGON_SPOTTED);</span><br><span class="line">    dragonSlayer = new DragonSlayer(</span><br><span class="line">        () -&gt; LOGGER.info(&quot;With your Excalibur you severe the dragon&apos;s head!&quot;));</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(RED_DRAGON_EMERGES);</span><br><span class="line">    dragonSlayer.changeStrategy(() -&gt; LOGGER.info(</span><br><span class="line">        &quot;You shoot the dragon with the magical crossbow and it falls dead on the ground!&quot;));</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(BLACK_DRAGON_LANDS);</span><br><span class="line">    dragonSlayer.changeStrategy(() -&gt; LOGGER.info(</span><br><span class="line">        &quot;You cast the spell of disintegration and the dragon vaporizes in a pile of dust!&quot;));</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line"></span><br><span class="line">    // &#x5177;&#x6709;&#x679A;&#x4E3E;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x7684; Java 8 lambda &#x5B9E;&#x73B0;</span><br><span class="line">    LOGGER.info(GREEN_DRAGON_SPOTTED);</span><br><span class="line">    dragonSlayer.changeStrategy(LambdaStrategy.Strategy.MeleeStrategy);</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(RED_DRAGON_EMERGES);</span><br><span class="line">    dragonSlayer.changeStrategy(LambdaStrategy.Strategy.ProjectileStrategy);</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">    LOGGER.info(BLACK_DRAGON_LANDS);</span><br><span class="line">    dragonSlayer.changeStrategy(LambdaStrategy.Strategy.SpellStrategy);</span><br><span class="line">    dragonSlayer.goToBattle();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x4E3B;&#x8981;&#x662F;&#x5206;&#x79BB;&#x7B97;&#x6CD5;&#xFF0C;&#x51CF;&#x5C11;&#x4EE3;&#x7801;&#x7684;&#x8026;&#x5408;&#x5EA6;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x5F88;&#x597D;&#x9075;&#x5FAA;&#x4E86;&#x5F00;&#x95ED;&#x539F;&#x5219;&#x3002;&#x5728;&#x4E66;&#x5199;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x591A;&#x591A;&#x4F7F;&#x7528;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x4EE3;&#x7801;&#x66F4;&#x52A0;&#x4F18;&#x7F8E;&#x3002;</p>
<h1 id="&#x4E8C;&#xFF1A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;"><a href="#&#x4E8C;&#xFF1A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;" class="headerlink" title="&#x4E8C;&#xFF1A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;"></a>&#x4E8C;&#xFF1A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;</h1><h2 id="2-1-&#x5F15;&#x8A00;"><a href="#2-1-&#x5F15;&#x8A00;" class="headerlink" title="2.1 &#x5F15;&#x8A00;"></a>2.1 &#x5F15;&#x8A00;</h2><p>&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x662F;&#x7ED3;&#x6784;&#x6700;&#x7B80;&#x5355;&#x7684;&#x884C;&#x4E3A;&#x578B;&#x8BBE;&#x8BA1;&#x6A21;&#x578B;&#xFF0C;&#x5728;&#x5176;&#x7ED3;&#x6784;&#x4E2D;&#x53EA;&#x5B58;&#x5728;&#x7236;&#x7C7B;&#x4E0E;&#x4E4B;&#x7C7B;&#x4E4B;&#x95F4;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#xFF0C;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x4E00;&#x4E9B;&#x590D;&#x6742;&#x6D41;&#x7A0B;&#x7684;&#x5B9E;&#x73B0;&#x6B65;&#x9AA4;&#x5C01;&#x88C5;&#x5728;&#x4E00;&#x7CFB;&#x5217;&#x57FA;&#x672C;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5728;&#x62BD;&#x8C61;&#x7236;&#x7C7B;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x79F0;&#x4E4B;&#x4E3A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x7684;&#x65B9;&#x6CD5;&#x6765;&#x5B9A;&#x4E49;&#x8FD9;&#x4E9B;&#x57FA;&#x672C;&#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x6B21;&#x5E8F;&#xFF0C;&#x800C;&#x901A;&#x8FC7;&#x5176;&#x5B50;&#x7C7B;&#x6765;&#x8986;&#x76D6;&#x67D0;&#x4E9B;&#x6B65;&#x9AA4;&#xFF0C;&#x4ECE;&#x800C;&#x4F7F;&#x5F97;&#x76F8;&#x540C;&#x7684;&#x7B97;&#x6CD5;&#x6846;&#x67B6;&#x53EF;&#x4EE5;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6765;&#x5B9A;&#x4E49;&#x7B97;&#x6CD5;&#x6846;&#x67B6;&#xFF0C;&#x800C;&#x67D0;&#x4E9B;&#x5177;&#x4F53;&#x6B65;&#x9AA4;&#x7684;&#x5B9E;&#x73B0;&#x53EF;&#x4EE5;&#x5728;&#x5176;&#x5B50;&#x7C7B;&#x4E2D;&#x5B8C;&#x6210;&#x3002;</p>
<h2 id="2-2-&#x5B9A;&#x4E49;"><a href="#2-2-&#x5B9A;&#x4E49;" class="headerlink" title="2.2 &#x5B9A;&#x4E49;"></a>2.2 &#x5B9A;&#x4E49;</h2><p>&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#xFF1A;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x4E2D;&#x7B97;&#x6CD5;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x800C;&#x5C06;&#x4E00;&#x4E9B;&#x6B65;&#x9AA4;&#x5EF6;&#x8FDF;&#x5230;&#x5B50;&#x7C7B;&#x4E2D;&#xFF0C;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x4F7F;&#x5F97;&#x5B50;&#x7C7B;&#x53EF;&#x4EE5;&#x4E0D;&#x6539;&#x53D8;&#x4E00;&#x4E2A;&#x7B97;&#x6CD5;&#x7684;&#x7ED3;&#x6784;&#x5373;&#x53EF;&#x91CD;&#x5B9A;&#x4E49;&#x8BE5;&#x7B97;&#x6CD5;&#x7684;&#x67D0;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x662F;&#x4E00;&#x79CD;&#x7C7B;&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#x3002;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x7B97;&#x6CD5;&#x7684;&#x6846;&#x67B6;&#x3002;&#x7B97;&#x6CD5;&#x5B50;&#x7C7B;&#x4E3A;&#x7A7A;&#x767D;&#x90E8;&#x5206;&#x63D0;&#x4F9B;&#x5B9E;&#x73B0;&#x3002;</p>
<h2 id="2-3-&#x4F18;&#x7F3A;&#x70B9;"><a href="#2-3-&#x4F18;&#x7F3A;&#x70B9;" class="headerlink" title="2.3 &#x4F18;&#x7F3A;&#x70B9;"></a>2.3 &#x4F18;&#x7F3A;&#x70B9;</h2><p><strong>&#x8BE5;&#x6A21;&#x5F0F;&#x7684;&#x4E3B;&#x8981;&#x4F18;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x5B83;&#x5C01;&#x88C5;&#x4E86;&#x4E0D;&#x53D8;&#x90E8;&#x5206;&#xFF0C;&#x6269;&#x5C55;&#x53EF;&#x53D8;&#x90E8;&#x5206;&#x3002;&#x5B83;&#x628A;&#x8BA4;&#x4E3A;&#x662F;&#x4E0D;&#x53D8;&#x90E8;&#x5206;&#x7684;&#x7B97;&#x6CD5;&#x5C01;&#x88C5;&#x5230;&#x7236;&#x7C7B;&#x4E2D;&#x5B9E;&#x73B0;&#xFF0C;&#x800C;&#x628A;&#x53EF;&#x53D8;&#x90E8;&#x5206;&#x7B97;&#x6CD5;&#x7531;&#x5B50;&#x7C7B;&#x7EE7;&#x627F;&#x5B9E;&#x73B0;&#xFF0C;&#x4FBF;&#x4E8E;&#x5B50;&#x7C7B;&#x7EE7;&#x7EED;&#x6269;&#x5C55;&#x3002;</li>
<li>&#x5B83;&#x5728;&#x7236;&#x7C7B;&#x4E2D;&#x63D0;&#x53D6;&#x4E86;&#x516C;&#x5171;&#x7684;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#xFF0C;&#x4FBF;&#x4E8E;&#x4EE3;&#x7801;&#x590D;&#x7528;&#x3002;</li>
<li>&#x90E8;&#x5206;&#x65B9;&#x6CD5;&#x662F;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5B50;&#x7C7B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6269;&#x5C55;&#x65B9;&#x5F0F;&#x589E;&#x52A0;&#x76F8;&#x5E94;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x7B26;&#x5408;&#x5F00;&#x95ED;&#x539F;&#x5219;&#x3002;</li>
</ul>
<p><strong>&#x8BE5;&#x6A21;&#x5F0F;&#x7684;&#x4E3B;&#x8981;&#x7F3A;&#x70B9;&#xFF1A;</strong></p>
<ul>
<li>&#x5BF9;&#x6BCF;&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x5B9E;&#x73B0;&#x90FD;&#x9700;&#x8981;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x5B50;&#x7C7B;&#xFF0C;&#x8FD9;&#x4F1A;&#x5BFC;&#x81F4;&#x7C7B;&#x7684;&#x4E2A;&#x6570;&#x589E;&#x52A0;&#xFF0C;&#x7CFB;&#x7EDF;&#x66F4;&#x52A0;&#x5E9E;&#x5927;&#xFF0C;&#x8BBE;&#x8BA1;&#x4E5F;&#x66F4;&#x52A0;&#x62BD;&#x8C61;&#xFF0C;&#x95F4;&#x63A5;&#x5730;&#x589E;&#x52A0;&#x4E86;&#x7CFB;&#x7EDF;&#x5B9E;&#x73B0;&#x7684;&#x590D;&#x6742;&#x5EA6;&#x3002;</li>
<li>&#x7236;&#x7C7B;&#x4E2D;&#x7684;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;&#xFF0C;&#x5B50;&#x7C7B;&#x6267;&#x884C;&#x7684;&#x7ED3;&#x679C;&#x4F1A;&#x5F71;&#x54CD;&#x7236;&#x7C7B;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x8FD9;&#x5BFC;&#x81F4;&#x4E00;&#x79CD;&#x53CD;&#x5411;&#x7684;&#x63A7;&#x5236;&#x7ED3;&#x6784;&#xFF0C;&#x5B83;&#x63D0;&#x9AD8;&#x4E86;&#x4EE3;&#x7801;&#x9605;&#x8BFB;&#x7684;&#x96BE;&#x5EA6;&#x3002;</li>
<li>&#x7531;&#x4E8E;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x81EA;&#x8EAB;&#x7684;&#x7F3A;&#x70B9;&#xFF0C;&#x5982;&#x679C;&#x7236;&#x7C7B;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#xFF0C;&#x5219;&#x6240;&#x6709;&#x5B50;&#x7C7B;&#x90FD;&#x8981;&#x6539;&#x4E00;&#x904D;&#x3002;</li>
</ul>
<h2 id="2-4-&#x9002;&#x7528;&#x573A;&#x666F;&#xFF1A;"><a href="#2-4-&#x9002;&#x7528;&#x573A;&#x666F;&#xFF1A;" class="headerlink" title="2.4 &#x9002;&#x7528;&#x573A;&#x666F;&#xFF1A;"></a>2.4 &#x9002;&#x7528;&#x573A;&#x666F;&#xFF1A;</h2><ul>
<li>&#x5BF9;&#x4E00;&#x4E9B;&#x590D;&#x6742;&#x7B97;&#x6CD5;&#x8FDB;&#x884C;&#x5206;&#x5272;&#xFF0C;&#x5C06;&#x5176;&#x7B97;&#x6CD5;&#x4E2D;&#x56FA;&#x5B9A;&#x4E0D;&#x53D8;&#x7684;&#x90E8;&#x5206;&#x8BBE;&#x8BA1;&#x4E3A;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x548C;&#x7236;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x4E00;&#x4E9B;&#x6539;&#x53D8;&#x7684;&#x7EC6;&#x8282;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E00;&#x6B21;&#x6027;&#x5B9E;&#x73B0;&#x7B97;&#x6CD5;&#x4E2D;&#x4E0D;&#x53D8;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x5C06;&#x53EF;&#x53D8;&#x90E8;&#x5206;&#x4EA4;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;</li>
<li>&#x5404;&#x5B50;&#x7C7B;&#x4E2D;&#x516C;&#x5171;&#x7684;&#x884C;&#x4E3A;&#x5E94;&#x88AB;&#x63D0;&#x53D6;&#x51FA;&#x6765;&#x5E76;&#x96C6;&#x4E2D;&#x5230;&#x4E00;&#x4E2A;&#x516C;&#x5171;&#x7236;&#x7C7B;&#x4E2D;&#x4EE5;&#x907F;&#x514D;&#x4EE3;&#x7801;&#x91CD;&#x590D;</li>
<li>&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5B50;&#x7C7B;&#x51B3;&#x5B9A;&#x7236;&#x7C7B;&#x7B97;&#x6CD5;&#x4E2D;&#x67D0;&#x4E2A;&#x6B65;&#x9AA4;&#x662F;&#x5426;&#x6267;&#x884C;&#xFF0C;&#x5B9E;&#x73B0;&#x5B50;&#x7C7B;&#x5BF9;&#x7236;&#x7C7B;&#x7684;&#x53CD;&#x5411;&#x63A7;&#x5236;</li>
</ul>
<h2 id="2-5-&#x76F4;&#x63A5;&#x4E0A;demo&#xFF1A;"><a href="#2-5-&#x76F4;&#x63A5;&#x4E0A;demo&#xFF1A;" class="headerlink" title="2.5 &#x76F4;&#x63A5;&#x4E0A;demo&#xFF1A;"></a>2.5 &#x76F4;&#x63A5;&#x4E0A;demo&#xFF1A;</h2><p>&#x5728;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C; HalflingThief&#xFF08;&#x8499;&#x9762;&#x5C0F;&#x5077;&#xFF09; &#x5305;&#x542B;&#x53EF;&#x4EE5;&#x66F4;&#x6539;&#x7684; StealingMethod&#xFF08;&#x7A83;&#x53D6;&#x65B9;&#x6CD5;&#xFF09;&#x3002; &#x5C0F;&#x5077;&#x9996;&#x5148;&#x4F7F;&#x7528; HitAndRunMethod&#xFF08;&#x6253;&#x4E86;&#x5C31;&#x8DD1;&#xFF09; &#x8FDB;&#x884C;&#x653B;&#x51FB;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528; SubtleMethod&#xFF08;&#x5FAE;&#x5999;&#x65B9;&#x6CD5;&#xFF09;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/447f60b138a180f88cb9cf69a46787b70720e735a9b1f167f28399ef173bf422" alt="image.png"></p>
<p>StealingMethod &#x5B9A;&#x4E49;&#x7B97;&#x6CD5;&#x7684;&#x6846;&#x67B6;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public abstract class StealingMethod {</span><br><span class="line"></span><br><span class="line">  protected abstract String pickTarget();</span><br><span class="line"></span><br><span class="line">  protected abstract void confuseTarget(String target);</span><br><span class="line"></span><br><span class="line">  protected abstract void stealTheItem(String target);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Steal.</span><br><span class="line">   */</span><br><span class="line">  public final void steal() {</span><br><span class="line">    var target = pickTarget();</span><br><span class="line">    LOGGER.info(&quot;The target has been chosen as {}.&quot;, target);</span><br><span class="line">    confuseTarget(target);</span><br><span class="line">    stealTheItem(target);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8499;&#x9762;&#x5C0F;&#x5077;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public class HalflingThief {</span><br><span class="line"></span><br><span class="line">  private StealingMethod method;</span><br><span class="line"></span><br><span class="line">  public HalflingThief(StealingMethod method) {</span><br><span class="line">    this.method = method;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  public void steal() {</span><br><span class="line">    method.steal();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  public void changeMethod(StealingMethod method) {</span><br><span class="line">    this.method = method;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6253;&#x4E86;&#x5C31;&#x8DD1;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class HitAndRunMethod extends StealingMethod {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected String pickTarget() {</span><br><span class="line">    return &quot;old goblin woman&quot;;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected void confuseTarget(String target) {</span><br><span class="line">    LOGGER.info(&quot;Approach the {} from behind.&quot;, target);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected void stealTheItem(String target) {</span><br><span class="line">    LOGGER.info(&quot;Grab the handbag and run away fast!&quot;);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5FAE;&#x5999;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class SubtleMethod extends StealingMethod {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected String pickTarget() {</span><br><span class="line">    return &quot;shop keeper&quot;;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected void confuseTarget(String target) {</span><br><span class="line">    LOGGER.info(&quot;Approach the {} with tears running and hug him!&quot;, target);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected void stealTheItem(String target) {</span><br><span class="line">    LOGGER.info(&quot;While in close contact grab the {}&apos;s wallet.&quot;, target);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class App {</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    var thief = new HalflingThief(new HitAndRunMethod());</span><br><span class="line">    thief.steal();</span><br><span class="line">    thief.changeMethod(new SubtleMethod());</span><br><span class="line">    thief.steal();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/cf06aff82360cc40e34418c0cea5a07d.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237007450179338299.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237007450179338299.html" itemprop="url">如何理解Native Crash问题 常见的Native C</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-25T16:34:50+08:00">
                2023-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x5E38;&#x89C1;&#x7684;Native-Crash&#x7C7B;&#x578B;"><a href="#&#x5E38;&#x89C1;&#x7684;Native-Crash&#x7C7B;&#x578B;" class="headerlink" title="&#x5E38;&#x89C1;&#x7684;Native Crash&#x7C7B;&#x578B;"></a>&#x5E38;&#x89C1;&#x7684;Native Crash&#x7C7B;&#x578B;</h1><table>
<thead>
<tr>
<th>&#x7C7B;&#x578B;</th>
<th>&#x5B50;&#x7C7B;</th>
<th>&#x539F;&#x56E0;</th>
</tr>
</thead>
<tbody><tr>
<td>SIGSEGV</td>
<td>SEGV_MAPERR</td>
<td>&#x5730;&#x5740;&#x4E0D;&#x5728; /proc/self/maps &#x6620;&#x5C04;&#x4E2D;</td>
</tr>
<tr>
<td></td>
<td>SEGV_ACCERR</td>
<td>&#x6CA1;&#x6709;&#x8BBF;&#x95EE;&#x6743;&#x9650;</td>
</tr>
<tr>
<td></td>
<td>SEGV_MTESERR</td>
<td>MTE&#x7279;&#x6709;&#x7C7B;&#x578B;</td>
</tr>
<tr>
<td>SIGABRT</td>
<td></td>
<td>&#x7A0B;&#x5E8F;&#x4E3B;&#x52A8;&#x9000;&#x51FA;&#xFF0C;&#x5E38;&#x89C1;&#x8C03;&#x7528;&#x51FD;&#x6570;abort()&#xFF0C;raise()&#x7B49;</td>
</tr>
<tr>
<td>SIGILL</td>
<td>ILL_ILLOPC</td>
<td>&#x975E;&#x6CD5;&#x64CD;&#x4F5C;&#x7801;&#xFF08;opcode&#xFF09;</td>
</tr>
<tr>
<td></td>
<td>ILL_ILLOPN</td>
<td>&#x975E;&#x6CD5;&#x64CD;&#x4F5C;&#x6570;&#xFF08;operand&#xFF09;</td>
</tr>
<tr>
<td></td>
<td>ILL_ILLADR</td>
<td>&#x975E;&#x6CD5;&#x5BFB;&#x5740;</td>
</tr>
<tr>
<td></td>
<td>ILL_ILLTRP</td>
<td>&#x975E;&#x6CD5;trap&#xFF0C;&#x5982;_builtintrap()&#x4E3B;&#x52A8;&#x5D29;&#x6E83;</td>
</tr>
<tr>
<td></td>
<td>ILL_PRVOPC</td>
<td>&#x975E;&#x6CD5;&#x7279;&#x6743;&#x64CD;&#x4F5C;&#x7801;(privileged opcode)</td>
</tr>
<tr>
<td></td>
<td>ILL_PRVREG</td>
<td>&#x975E;&#x6CD5;&#x7279;&#x6743;&#x5BC4;&#x5B58;&#x5668;(privileged register)</td>
</tr>
<tr>
<td></td>
<td>ILL_COPROC</td>
<td>&#x534F;&#x5904;&#x7406;&#x5668;&#x9519;&#x8BEF;</td>
</tr>
<tr>
<td></td>
<td>ILL_BADSTK</td>
<td>&#x5185;&#x90E8;&#x5806;&#x6808;&#x9519;&#x8BEF;</td>
</tr>
<tr>
<td>SIGBUS</td>
<td>BUS_ADRALN</td>
<td>&#x8BBF;&#x95EE;&#x5730;&#x5740;&#x672A;&#x5BF9;&#x9F50;</td>
</tr>
<tr>
<td></td>
<td>BUS_ADRERR</td>
<td>&#x8BBF;&#x95EE;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#xFF0C;&#x5E38;&#x89C1;&#x8BBF;&#x95EE;&#x7684;&#x6587;&#x4EF6;&#x622A;&#x65AD;</td>
</tr>
<tr>
<td></td>
<td>BUS_OBJERR</td>
<td>&#x7279;&#x5B9A;&#x5BF9;&#x8C61;&#x7684;&#x786C;&#x4EF6;&#x9519;&#x8BEF;</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>FPE_INTDIV</td>
<td>&#x6574;&#x6570;&#x9664;&#x4EE5;0</td>
</tr>
<tr>
<td></td>
<td>FPE_INTOVF</td>
<td>&#x6574;&#x6570;&#x6EA2;&#x51FA;</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTDIV</td>
<td>&#x6D6E;&#x70B9;&#x6570;&#x9664;&#x4EE5;0</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTOVF</td>
<td>&#x6D6E;&#x70B9;&#x6570;&#x4E0A;&#x6EA2;&#xFF08;overflow&#xFF09;</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTUND</td>
<td>&#x6D6E;&#x70B9;&#x6570;&#x4E0B;&#x6EA2;&#xFF08;underflow&#xFF09;</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTRES</td>
<td>&#x6D6E;&#x70B9;&#x6570;&#x7ED3;&#x679C;&#x4E0D;&#x7CBE;&#x786E;</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTINV</td>
<td>&#x65E0;&#x6548;&#x7684;&#x6D6E;&#x70B9;&#x8FD0;&#x7B97;</td>
</tr>
<tr>
<td></td>
<td>FPE_FLTSUB</td>
<td>&#x8D8A;&#x754C;</td>
</tr>
</tbody></table>
<h1 id="Android&#x65E5;&#x5FD7;"><a href="#Android&#x65E5;&#x5FD7;" class="headerlink" title="Android&#x65E5;&#x5FD7;"></a>Android&#x65E5;&#x5FD7;</h1><p>&#x2003;&#x2003;&#x5F53;&#x7A0B;&#x5E8F;&#x53D1;&#x751F;&#x4E86; Native Crash &#x9519;&#x8BEF;&#xFF0C;Android &#x7684;&#x65E5;&#x5FD7;&#x4F1A;&#x8F93;&#x51FA;&#x5230; log crash buffer &#x4E0A;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x901A;&#x8FC7;adb logcat -b crash &#x6293;&#x53D6;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x9519;&#x8BEF;&#x62A5;&#x544A;&#xFF0C;&#x800C;&#x65E5;&#x5FD7;&#x672C;&#x8EAB;&#x80FD;&#x63D0;&#x4F9B;&#x7684;&#x4FE1;&#x606F;&#x662F;&#x6709;&#x9650;&#x7684;&#xFF0C;&#x4EC5;&#x4EC5;&#x662F;&#x9519;&#x8BEF;&#x5806;&#x6808;&#xFF0C;&#x4E0E;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;--------- beginning of crash</span><br><span class="line">06-07 01:53:32.465 12027 12027 F DEBUG : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">06-07 01:53:32.465 12027 12027 F DEBUG : Revision: &apos;0&apos;</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : ABI: &apos;arm64&apos;</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : Timestamp: 2022-06-07 01:53:32.033409857+0800</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : Process uptime: 0s</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : Cmdline: mediaserver64</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : pid: 1139, tid: 11981, name: NPDecoder &gt;&gt;&gt; mediaserver64 &lt;&lt;&lt;</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : uid: 1013</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : tagged_addr_ctrl: 0000000000000001</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7c02d886f0</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : x0 79748c5e568e2ddc x1 0000007ca13c3618 x2 0000000000000000 x3 0000007ca1291000</span><br><span class="line">06-07 01:53:32.466 12027 12027 F DEBUG : x4 0000000001909705 x5 0000000000000000 x6 0000007c02d88808 x7 b60625655bf0252f</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x8 0000000000000080 x9 0000007ca126fed7 x10 0000000000000006 x11 0000007bfd0a81fc</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x12 9ef8a95ca9649dbe x13 e44782d5ac38720e x14 0000007bfd0a8030 x15 0000001e56307b5c</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x16 0000007c95dfdb70 x17 0000007c9844f118 x18 0000007bfaa28000 x19 b400007c13c246d0</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x20 0000007c02d88730 x21 b400007c13c67c00 x22 0000000000000415 x23 0000007c02d89000</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x24 0000000000000002 x25 b400007c13c246d0 x26 b400007c13c67c00 x27 0000007c02d89000</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : x28 0000007ca13c2c28 x29 0000007c02d886f0</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : lr 0000007c02d886f0 sp 0000007c02d886d0 pc 0000007c02d886f0 pst 0000000080001000</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : backtrace:</span><br><span class="line">06-07 01:53:32.467 12027 12027 F DEBUG : #00 pc 00000000000f86f0 [anon:stack_and_tls:11981]</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x5F53;&#x53EA;&#x6709;&#x65E5;&#x5FD7;&#x5806;&#x6808;&#x4E0D;&#x80FD;&#x8FDB;&#x884C;&#x66F4;&#x8BE6;&#x7EC6;&#x7684;&#x5206;&#x6790;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x7A0B;&#x5E8F;&#x7684;&#x90E8;&#x5206;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#x4EE5;&#x53CA;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#xFF0C;&#x800C;Android &#x7684;&#x9519;&#x8BEF;&#x673A;&#x5236;&#x4F1A;&#x76F8;&#x5E94;&#x7684;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4EFD; tombstone &#x6587;&#x4EF6;&#x4FDD;&#x5B58;&#x5230; /data/tombstones/tombstone_xx &#xFF0C;&#x5BF9;&#x4E8E;&#x6CA1;&#x6709; Root &#x6743;&#x9650;&#x7684;&#x673A;&#x5668;&#x5219;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; adb bugreport &#x6293;&#x53D6;&#x51FA; tombstone &#x6587;&#x4EF6;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c6e2e4d5573052ac9635853f8c34a659a506bda6fde29c82288a1e0c1582871a" alt></p>
<h1 id="Tombstone"><a href="#Tombstone" class="headerlink" title="Tombstone"></a>Tombstone</h1><p>&#x2003;&#x2003;tombstone &#x6587;&#x4EF6;&#x4FDD;&#x5B58;&#x7684;&#x4FE1;&#x606F;&#x6709;&#x9519;&#x8BEF;&#x7A0B;&#x5E8F;&#x7684;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;&#xFF0C;&#x901A;&#x4FD7;&#x7684;&#x8BF4; arm&#x3001;arm64 &#x7B49;&#xFF0C;&#x53D1;&#x751F;&#x65F6;&#x95F4;&#x70B9;&#xFF0C;&#x7A0B;&#x5E8F;&#x540D;&#xFF0C;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#xFF0C;&#x9519;&#x8BEF;&#x7A0B;&#x5E8F;&#x7684;&#x8FDB;&#x7A0B;&#x53F7;&#x3001;&#x7EBF;&#x7A0B;&#x53F7;&#xFF0C;&#x9519;&#x8BEF;&#x73B0;&#x573A;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5806;&#x6808;&#x548C;&#x90E8;&#x5206;&#x5BC4;&#x5B58;&#x5668;&#x5730;&#x5740;&#x9644;&#x8FD1;&#x7684;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x8868; /proc/self/maps &#xFF0C;FD &#x4FE1;&#x606F;&#x4EE5;&#x53CA;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#x65F6;&#x8BE5;&#x7A0B;&#x5E8F;&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;ABI: &apos;arm64&apos; &#x3010; arm64&#x7684;&#x7A0B;&#x5E8F; &#x3011;</span><br><span class="line">Timestamp: 2022-06-07 01:53:32.033409857+0800 &#x3010; &#x53D1;&#x751F;&#x9519;&#x8BEF;&#x7684;&#x65F6;&#x95F4;&#x6233; &#x3011;</span><br><span class="line">Process uptime: 0s</span><br><span class="line">Cmdline: mediaserver64 &#x3010; &#x7A0B;&#x5E8F;&#x540D; &#x3011;</span><br><span class="line">pid: 1139, tid: 11981, name: NPDecoder &gt;&gt;&gt; mediaserver64 &lt;&lt;&lt; &#x3010; &#x8FDB;&#x7A0B;&#x53F7;&#x3001;&#x7EBF;&#x7A0B;&#x53F7; &#x3011;</span><br><span class="line">uid: 1013</span><br></pre></td></tr></table></figure>

<h3 id="&#x9519;&#x8BEF;&#x7C7B;&#x578B;"><a href="#&#x9519;&#x8BEF;&#x7C7B;&#x578B;" class="headerlink" title="&#x9519;&#x8BEF;&#x7C7B;&#x578B;"></a>&#x9519;&#x8BEF;&#x7C7B;&#x578B;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7c02d886f0</span><br><span class="line">&#x3010; &#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x662F; SIGSEGV&#xFF0C;&#x5B50;&#x7C7B;&#x662F; SEGV_ACCERR&#xFF0C;&#x9519;&#x8BEF;&#x5730;&#x5740;0x7c02d886f0 &#x3011;</span><br><span class="line">SIGSEGV &#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x6700;&#x5E38;&#x89C1;&#x7684; Native Crash &#x7C7B;&#x578B;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x79F0;&#x5176;&#x4E3A;&#x6BB5;&#x9519;&#x8BEF;&#xFF0C;</span><br><span class="line">&#x800C;&#x9519;&#x8BEF;&#x610F;&#x601D;&#x662F;&#x5728; PC=0x7c02d886f0 &#x4E0A;&#x53D1;&#x751F;&#x62D2;&#x7EDD;&#x8BBF;&#x95EE;&#x7684;&#x6BB5;&#x9519;&#x8BEF;&#x3002;</span><br></pre></td></tr></table></figure>

<h3 id="&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;"><a href="#&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;" class="headerlink" title="&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;"></a>&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;x0 79748c5e568e2ddc x1 0000007ca13c3618 x2 0000000000000000 x3 0000007ca1291000</span><br><span class="line">x4 0000000001909705 x5 0000000000000000 x6 0000007c02d88808 x7 b60625655bf0252f</span><br><span class="line">x8 0000000000000080 x9 0000007ca126fed7 x10 0000000000000006 x11 0000007bfd0a81fc</span><br><span class="line">x12 9ef8a95ca9649dbe x13 e44782d5ac38720e x14 0000007bfd0a8030 x15 0000001e56307b5c</span><br><span class="line">x16 0000007c95dfdb70 x17 0000007c9844f118 x18 0000007bfaa28000 x19 b400007c13c246d0</span><br><span class="line">x20 0000007c02d88730 x21 b400007c13c67c00 x22 0000000000000415 x23 0000007c02d89000</span><br><span class="line">x24 0000000000000002 x25 b400007c13c246d0 x26 b400007c13c67c00 x27 0000007c02d89000</span><br><span class="line">x28 0000007ca13c2c28 x29 0000007c02d886f0</span><br><span class="line">lr 0000007c02d886f0 sp 0000007c02d886d0 pc 0000007c02d886f0 pst 0000000080001000</span><br></pre></td></tr></table></figure>

<h3 id="&#x5806;&#x6808;&#x4FE1;&#x606F;"><a href="#&#x5806;&#x6808;&#x4FE1;&#x606F;" class="headerlink" title="&#x5806;&#x6808;&#x4FE1;&#x606F;"></a>&#x5806;&#x6808;&#x4FE1;&#x606F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;backtrace:</span><br><span class="line">#00 pc 00000000000f86f0 [anon:stack_and_tls:11981] &#x3010;PC&#x521A;&#x597D;&#x843D;&#x5728;&#x7EBF;&#x7A0B;&#x6808;&#x5730;&#x5740;&#x4E0A;&#x3011;</span><br><span class="line">&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5F88;&#x5C11;&#x89C1;&#xFF0C;&#x867D;&#x7136;&#x5B83;&#x53EA;&#x6709;&#x7684;&#x4E00;&#x6761;&#x5806;&#x6808;&#xFF0C;&#x5E76;&#x4E0D;&#x4EE3;&#x8868;&#x7A0B;&#x5E8F;&#x662F;&#x4ECE;&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x8FD0;&#x884C;&#xFF0C;&#x51FA;&#x73B0;&#x7684;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4EC5;&#x4EC5; unwind &#x65E0;&#x6CD5;&#x6B63;&#x786E;&#x7684;&#x56DE;&#x6EAF;&#x3002;</span><br><span class="line">&#x6211;&#x4EEC;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6808;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x6062;&#x590D;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x7528;&#x6237;&#x6001;&#x4E3B;&#x7EBF;&#x7A0B;&#x6808;&#xFF08;&#x7EA2;&#x8272;&#x90E8;&#x5206;&#xFF09;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0a6b2d2f3b584e6ec48b11765037d2b78948054b5dd5eded9559734f872d004f" alt="UML diagram.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;&#x800C;&#x7EBF;&#x7A0B;&#x6808;&#x4F4D;&#x4E8E; mmap segmemt&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; /proc/self/maps &#x4E0A;&#x627E;&#x5230;&#x8BE5;&#x7EBF;&#x7A0B;&#x6808;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x8303;&#x56F4;&#x3002;</span><br><span class="line">0000007c&apos;02c90000-0000007c&apos;02d8bfff rw- 0 fc000 [anon:stack_and_tls:11981]</span><br><span class="line">&#x5927;&#x591A;&#x6570; arm64 &#x7684; Linux Android &#x7A0B;&#x5E8F;&#xFF0C;&#x5B83;&#x7684;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;&#x6808;&#x7ED3;&#x6784;&#x6837;&#x4F8B;&#x5982;&#x4E0B;&#xFF1A;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4c8ff8ea04bfa880510ae2ce36b1c0cf3b271c6814c02a09ff6a34530f78cf4a" alt="UML diagram (12).jpg"></p>
<h3 id="&#x5185;&#x5B58;&#x4FE1;&#x606F;"><a href="#&#x5185;&#x5B58;&#x4FE1;&#x606F;" class="headerlink" title="&#x5185;&#x5B58;&#x4FE1;&#x606F;"></a>&#x5185;&#x5B58;&#x4FE1;&#x606F;</h3><p>&#x2003;&#x2003;tombstone &#x4F1A;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x6709;&#x6548;&#x5730;&#x5740;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x9644;&#x8FD1;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x5927;&#x5C0F;&#x4E3A;0x100&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x6587;&#x4EF6;<br>system/core/debuggerd/libdebuggerd/utility.cpp &#x4E2D;&#x7684;&#x5B8F;&#x5B9A;&#x4E49; MEMORY_BYTES_TO_DUMP &#x53C2;&#x6570;<br>&#x50CF;&#x8FD9;&#x79CD;&#x4E00;&#x6761;&#x5806;&#x6808;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6808;&#x7684;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#x914D;&#x5408;&#x4E0B;&#x8FB9;&#x7684;&#x6620;&#x5C04;&#x8868;&#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x5230;&#x6211;&#x4EEC;&#x5BF9;&#x6808;&#x8FDB;&#x884C;&#x6062;&#x590D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">erlang&#x590D;&#x5236;&#x4EE3;&#x7801;memory near x1 (/system/lib64/libstagefright.so):</span><br><span class="line">0000007ca13c35f0 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c3600 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c3610 0000000000000000 0000007ca132326c ........l22.|...</span><br><span class="line">0000007ca13c3620 0000007ca1324008 0000007ca10552e4 .@2.|....R..|...</span><br><span class="line">0000007ca13c3630 0000007ca10552e8 0000007ca10552ec .R..|....R..|...</span><br><span class="line">0000007ca13c3640 0000007ca10552f4 0000007ca132402c .R..|...,@2.|...</span><br><span class="line">0000007ca13c3650 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c3660 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c3670 0000000000000000 0000007ca134ea84 ..........4.|...</span><br><span class="line">0000007ca13c3680 0000007ca134ecec 0000007ca10552e4 ..4.|....R..|...</span><br><span class="line">0000007ca13c3690 0000007ca10552e8 0000007ca10552ec .R..|....R..|...</span><br><span class="line">0000007ca13c36a0 0000007ca10552f4 0000007ca134ed10 .R..|.....4.|...</span><br><span class="line">0000007ca13c36b0 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c36c0 0000000000000000 0000000000000000 ................</span><br><span class="line">0000007ca13c36d0 0000000000000000 0000007ca135d02c ........,.5.|...</span><br><span class="line">0000007ca13c36e0 0000007ca135d4b8 0000007ca10552e4 ..5.|....R..|...</span><br><span class="line"></span><br><span class="line">memory near x29 ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;.. &#x3010;SP = 0x0000007c02d886d0&#x3011;</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;*&#x3010;x29 = 0x0000007c02d886f0&#x3011;</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88720 0000000000000000 0000007c02d88808 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;*</span><br><span class="line">0000007c02d88730 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..*</span><br><span class="line">0000007c02d88740 0000007c02d89000 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o</span><br><span class="line">0000007c02d88750 0000007c02d88830 0000007ca796ee7c 0&#x2026;|&#x2026;|&#x2026;|&#x2026;</span><br><span class="line">0000007c02d88760 0000007ca79f3dd8 0000007ca79edb80 .=..|&#x2026;&#x2026;.|&#x2026;</span><br><span class="line">0000007c02d88770 0000007c02d89000 b400007c13c04680 &#x2026;.|&#x2026;.F..|&#x2026;</span><br><span class="line">0000007c02d88780 0000000000000000 0000000000000002 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.</span><br><span class="line">0000007c02d88790 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d887a0 0000000000000000 b400007c13c7c100 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;</span><br><span class="line">0000007c02d887b0 0000007c02d88830 0000007ca796d420 0&#x2026;|&#x2026; &#x2026;|&#x2026;</span><br><span class="line">0000007c02d887c0 0000007c02d88830 0000007ca796d460 0&#x2026;|&#x2026;`&#x2026;|&#x2026;</span><br><span class="line"></span><br><span class="line">memory near lr ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;*</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88720 0000000000000000 0000007c02d88808 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;*</span><br><span class="line">0000007c02d88730 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..*</span><br><span class="line">0000007c02d88740 0000007c02d89000 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o</span><br><span class="line">0000007c02d88750 0000007c02d88830 0000007ca796ee7c 0&#x2026;|&#x2026;|&#x2026;|&#x2026;</span><br><span class="line">0000007c02d88760 0000007ca79f3dd8 0000007ca79edb80 .=..|&#x2026;&#x2026;.|&#x2026;</span><br><span class="line">0000007c02d88770 0000007c02d89000 b400007c13c04680 &#x2026;.|&#x2026;.F..|&#x2026;</span><br><span class="line">0000007c02d88780 0000000000000000 0000000000000002 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.</span><br><span class="line">0000007c02d88790 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d887a0 0000000000000000 b400007c13c7c100 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;</span><br><span class="line">0000007c02d887b0 0000007c02d88830 0000007ca796d420 0&#x2026;|&#x2026; &#x2026;|&#x2026;</span><br><span class="line">0000007c02d887c0 0000007c02d88830 0000007ca796d460 0&#x2026;|&#x2026;`&#x2026;|&#x2026;</span><br><span class="line"></span><br><span class="line">memory near sp ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886b0 0000000000000018 0000007caae98c58 &#x2026;&#x2026;..X&#x2026;|&#x2026;</span><br><span class="line">0000007c02d886c0 0000007c02d886f0 0000007c95de6754 &#x2026;.|&#x2026;Tg..|&#x2026;</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;*</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88720 0000000000000000 0000007c02d88808 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;*</span><br><span class="line">0000007c02d88730 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..*</span><br><span class="line">0000007c02d88740 0000007c02d89000 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o</span><br><span class="line">0000007c02d88750 0000007c02d88830 0000007ca796ee7c 0&#x2026;|&#x2026;|&#x2026;|&#x2026;</span><br><span class="line">0000007c02d88760 0000007ca79f3dd8 0000007ca79edb80 .=..|&#x2026;&#x2026;.|&#x2026;</span><br><span class="line">0000007c02d88770 0000007c02d89000 b400007c13c04680 &#x2026;.|&#x2026;.F..|&#x2026;</span><br><span class="line">0000007c02d88780 0000000000000000 0000000000000002 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.</span><br><span class="line">0000007c02d88790 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d887a0 0000000000000000 b400007c13c7c100 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;</span><br><span class="line"></span><br><span class="line">memory near pc ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;*</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88720 0000000000000000 0000007c02d88808 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;*</span><br><span class="line">0000007c02d88730 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..*</span><br><span class="line">0000007c02d88740 0000007c02d89000 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o</span><br><span class="line">0000007c02d88750 0000007c02d88830 0000007ca796ee7c 0&#x2026;|&#x2026;|&#x2026;|&#x2026;</span><br><span class="line">0000007c02d88760 0000007ca79f3dd8 0000007ca79edb80 .=..|&#x2026;&#x2026;.|&#x2026;</span><br><span class="line">0000007c02d88770 0000007c02d89000 b400007c13c04680 &#x2026;.|&#x2026;.F..|&#x2026;</span><br><span class="line">0000007c02d88780 0000000000000000 0000000000000002 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.</span><br><span class="line">0000007c02d88790 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d887a0 0000000000000000 b400007c13c7c100 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;</span><br><span class="line">0000007c02d887b0 0000007c02d88830 0000007ca796d420 0&#x2026;|&#x2026; &#x2026;|&#x2026;</span><br><span class="line">0000007c02d887c0 0000007c02d88830 0000007ca796d460 0&#x2026;|&#x2026;`&#x2026;|&#x2026;</span><br></pre></td></tr></table></figure>

<h3 id="&#x5185;&#x5B58;&#x6620;&#x5C04;&#x8868;"><a href="#&#x5185;&#x5B58;&#x6620;&#x5C04;&#x8868;" class="headerlink" title="&#x5185;&#x5B58;&#x6620;&#x5C04;&#x8868;"></a>&#x5185;&#x5B58;&#x6620;&#x5C04;&#x8868;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;memory map (1146 entries):</span><br><span class="line">0000005f&apos;fabc7000-0000005f&apos;fabc7fff r-- 0 1000 /system/bin/mediaserver64</span><br><span class="line">0000005f&apos;fabc8000-0000005f&apos;fabc9fff r-x 1000 2000 /system/bin/mediaserver64</span><br><span class="line">0000005f&apos;fabca000-0000005f&apos;fabcafff r-- 3000 1000 /system/bin/mediaserver64</span><br><span class="line">0000007b&apos;e79a3000-0000007b&apos;e7d93fff --- 0 3f1000</span><br><span class="line"></span><br><span class="line">0000007c&apos;a120e000-0000007c&apos;a128efff r-- 0 81000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a128f000-0000007c&apos;a13c0fff r-x 81000 132000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a13c1000-0000007c&apos;a13cffff r-- 1b3000 f000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a13d0000-0000007c&apos;a13d1fff rw- 1c1000 2000 /system/lib64/libstagefright.so</span><br><span class="line"></span><br><span class="line">0000007c&apos;a787c000-0000007c&apos;a78f4fff r-- 0 79000 /system/lib64/libmediaplayerservice.so</span><br><span class="line">0000007c&apos;a78f5000-0000007c&apos;a79ecfff r-x 79000 f8000 /system/lib64/libmediaplayerservice.so</span><br><span class="line">0000007c&apos;a79ed000-0000007c&apos;a79f8fff r-- 171000 c000 /system/lib64/libmediaplayerservice.so</span><br><span class="line">0000007c&apos;a79f9000-0000007c&apos;a79f9fff rw- 17c000 1000 /system/lib64/libmediaplayerservice.so</span><br></pre></td></tr></table></figure>

<h3 id="FD&#x4FE1;&#x606F;"><a href="#FD&#x4FE1;&#x606F;" class="headerlink" title="FD&#x4FE1;&#x606F;"></a>FD&#x4FE1;&#x606F;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;open files:</span><br><span class="line">fd 0: /dev/null (unowned)</span><br><span class="line">fd 1: /dev/null (unowned)</span><br><span class="line">fd 2: /dev/null (unowned)</span><br><span class="line">fd 3: socket:[62562] (unowned)</span><br><span class="line">fd 4: /dev/binderfs/binder (unowned)</span><br><span class="line">fd 5: /dev/binderfs/hwbinder (unowned)</span><br><span class="line">fd 6: /sys/kernel/tracing/trace_marker (unowned)</span><br><span class="line">fd 7: /dev/ashmem4945d9b6-db30-413c-88c5-e50674f154c7 (unowned)</span><br><span class="line">fd 8: /dmabuf: (unowned)</span><br><span class="line">fd 9: /dev/ashmem4945d9b6-db30-413c-88c5-e50674f154c7 (unowned)</span><br><span class="line">fd 10: /storage/emulated/0/zapya/folder/&#x534E;&#x8BED;&#x97F3;&#x4E50;/IN-K&amp;&#x738B;&#x5FFB;&#x8FB0;&amp;&#x82CF;&#x661F;&#x5A55; - &#x843D;&#x65E5;&#x4E0E;&#x665A;&#x98CE;.mp3 (owned by unique_fd 0x7c13c7a498)</span><br><span class="line">fd 11: /dev/ashmem4945d9b6-db30-413c-88c5-e50674f154c7 (unowned)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h1 id="Coredump"><a href="#Coredump" class="headerlink" title="Coredump"></a>Coredump</h1><p>&#x2003;&#x2003;&#x524D;&#x9762; tombstone &#x6587;&#x4EF6;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x5230;&#x5B83;&#x7684;&#x4FE1;&#x606F;&#x5F88;&#x6709;&#x9650;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x66F4;&#x591A;&#x7684;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#x65F6;&#xFF0C;&#x5B83;&#x65E0;&#x6CD5;&#x6EE1;&#x8DB3;&#x6211;&#x4EEC;&#xFF0C;&#x8FD9;&#x65F6; coredump &#x5C31;&#x5C24;&#x4E3A;&#x91CD;&#x8981;&#x4E86;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x6309;&#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x6293;&#x53D6;&#x76F8;&#x5E94;&#x7684;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x5173;&#x4E8E; core &#x7684;&#x4ECB;&#x7ECD;&#xFF0C;&#x89C1;&#xFF1A;<br><a href="/external_links/757ac8a94cf98469912e5472897049a6.html" target="blank" rel="noopener">man7.org/linux/man-p&#x2026;</a></p>
<h3 id="AOSP&#x65B9;&#x6CD5;"><a href="#AOSP&#x65B9;&#x6CD5;" class="headerlink" title="AOSP&#x65B9;&#x6CD5;"></a>AOSP&#x65B9;&#x6CD5;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# build/envsetup.sh</span><br><span class="line"># coredump_setup - enable core dumps globally for any process</span><br><span class="line">#                  that has the core-file-size limit set correctly</span><br><span class="line">#</span><br><span class="line"># NOTE: You must call also coredump_enable for a specific process</span><br><span class="line">#       if its core-file-size limit is not set already.</span><br><span class="line"># NOTE: Core dumps are written to ramdisk; they will not survive a reboot!</span><br><span class="line"></span><br><span class="line">function coredump_setup()</span><br><span class="line">{</span><br><span class="line">    echo &quot;Getting root...&quot;;</span><br><span class="line">    adb root;</span><br><span class="line">    adb wait-for-device;</span><br><span class="line"></span><br><span class="line">    echo &quot;Remounting root partition read-write...&quot;;</span><br><span class="line">    adb shell mount -w -o remount -t rootfs rootfs;</span><br><span class="line">    sleep 1;</span><br><span class="line">    adb wait-for-device;</span><br><span class="line">    adb shell mkdir -p /cores;</span><br><span class="line">    adb shell mount -t tmpfs tmpfs /cores;</span><br><span class="line">    adb shell chmod 0777 /cores;</span><br><span class="line"></span><br><span class="line">    echo &quot;Granting SELinux permission to dump in /cores...&quot;;</span><br><span class="line">    adb shell restorecon -R /cores;</span><br><span class="line"></span><br><span class="line">    echo &quot;Set core pattern.&quot;;</span><br><span class="line">    adb shell &apos;echo /cores/core.%p &gt; /proc/sys/kernel/core_pattern&apos;;</span><br><span class="line"></span><br><span class="line">    echo &quot;Done.&quot;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># coredump_enable - enable core dumps for the specified process</span><br><span class="line"># $1 = PID of process (e.g., $(pid mediaserver))</span><br><span class="line">#</span><br><span class="line"># NOTE: coredump_setup must have been called as well for a core</span><br><span class="line">#       dump to actually be generated.</span><br><span class="line"></span><br><span class="line">function coredump_enable()</span><br><span class="line">{</span><br><span class="line">    local PID=$1;</span><br><span class="line">    if [ -z &quot;$PID&quot; ]; then</span><br><span class="line">        printf &quot;Expecting a PID!\n&quot;;</span><br><span class="line">        return;</span><br><span class="line">    fi;</span><br><span class="line">    echo &quot;Setting core limit for $PID to infinite...&quot;;</span><br><span class="line">    adb shell /system/bin/ulimit -P $PID -c unlimited</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x5E38;&#x7528;&#x65B9;&#x6CD5;"><a href="#&#x5E38;&#x7528;&#x65B9;&#x6CD5;" class="headerlink" title="&#x5E38;&#x7528;&#x65B9;&#x6CD5;"></a>&#x5E38;&#x7528;&#x65B9;&#x6CD5;</h3><p>&#x2003;&#x2003;&#x7ED9; system_server &#x914D;&#x7F6E; coredump &#x53C2;&#x6570;&#xFF0C;&#x7531;&#x4E8E;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x7684; coredump &#x751F;&#x6210;&#x7684;&#x76EE;&#x5F55;&#x53D7; selinux &#x6743;&#x9650;&#x9650;&#x5236;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x914D;&#x7F6E;&#x6293; coredump &#x7684;&#x65B9;&#x6CD5;&#x8981;&#x6CE8;&#x610F;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x5BF9;&#x54EA;&#x4E9B;&#x76EE;&#x5F55;&#x6587;&#x4EF6;&#x6709;&#x8BFB;&#x5199;&#x7684; selinux &#x6743;&#x9650;&#xFF0C;&#x518D;&#x914D;&#x7F6E;&#x76F8;&#x5E94;&#x7684;&#x76EE;&#x5F55;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;adb wait-for-device</span><br><span class="line">adb root</span><br><span class="line">adb shell mkdir /data/cores</span><br><span class="line">adb shell chmod 777 /data/cores</span><br><span class="line">#adb shell setenforce 0</span><br><span class="line">adb shell restorecon -R /data/cores</span><br><span class="line">adb shell &apos;echo /data/cores/core.%e.%p &gt; /proc/sys/kernel/core_pattern&apos;</span><br><span class="line">adb shell &apos;system/bin/ulimit -P `pidof system_server` -c unlimited&apos;</span><br><span class="line">#adb shell &apos;echo 2 &gt; /proc/sys/fs/suid_dumpable&apos;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x6CE8;&#x610F;&#xFF1A;&#x786E;&#x5B9A;&#x95EE;&#x9898;&#x4E0E;selinux&#x6743;&#x9650;&#x65E0;&#x5173;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;adb shell setenforce 0&#x5173;&#x95ED;selinux&#x6743;&#x9650;  </p>
<p>&#x2003;&#x2003;&#x7ED9; com.android.settings &#x914D;&#x7F6E;&#x6293;&#x53D6; coredump &#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7531;&#x4E8E;&#x524D;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x4E2D; /data/cores &#x76EE;&#x5F55;&#x6062;&#x590D; selinux &#x6743;&#x9650;&#x540E;&#x5982;&#x4E0B;&#xFF1A;  </p>
<p>&#x2003;&#x2003;drwxrwxrwx 2 root root u:object_r:system_data_file:s0 3452 2022-07-04 15:08 cores  </p>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x77E5;&#x9053; app &#x4E00;&#x5B9A;&#x6709;&#x6743;&#x9650;&#x5BF9;&#x81EA;&#x8EAB;&#x7684; /data/data/$PACKAGE/ &#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x6587;&#x4EF6;&#x5177;&#x6709;&#x8BFB;&#x5199;&#x6743;&#x9650;&#xFF0C;&#x4E8E;&#x662F;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x6210;&#x5982;&#x4E0B;&#x53C2;&#x6570;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;adb wait-for-device</span><br><span class="line">adb root</span><br><span class="line">adb shell mkdir /data/data/com.android.settings/cores</span><br><span class="line">adb shell chmod 777 /data/data/com.android.settings/cores</span><br><span class="line">adb shell restorecon -R /data/data/com.android.settings/cores</span><br><span class="line">adb shell &apos;echo /data/data/com.android.settings/cores/core.%e.%p &gt; /proc/sys/kernel/core_pattern&apos;</span><br><span class="line">adb shell &apos;system/bin/ulimit -P `pidof com.android.settings` -c unlimited&apos;</span><br><span class="line">#adb shell &apos;echo 2 &gt; /proc/sys/fs/suid_dumpable&apos;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;&#x5F53;&#x6211;&#x4EEC;&#x5728;&#x673A;&#x5668;&#x4E0A;&#x9A8C;&#x8BC1;&#x5BF9;&#x8FD9;&#x4E2A;app&#x8FDB;&#x884C;kill -11&#x6A21;&#x62DF;&#x65F6;</span><br><span class="line">$ kill -11 `pidof com.android.settings`</span><br><span class="line">$ ls /data/data/com.android.settings/cores/core.ndroid.settings.27946</span><br></pre></td></tr></table></figure>

<h3 id="&#x53C2;&#x6570;&#x8BF4;&#x660E;"><a href="#&#x53C2;&#x6570;&#x8BF4;&#x660E;" class="headerlink" title="&#x53C2;&#x6570;&#x8BF4;&#x660E;"></a>&#x53C2;&#x6570;&#x8BF4;&#x660E;</h3><p>&#x2003;&#x2003;coredump_filter &#x8FDB;&#x7A0B;&#x9ED8;&#x8BA4;&#x503C;&#x662F;0x23&#xFF0C;&#x53EA;&#x6293;&#x53D6;&#xFF1A;&#x79C1;&#x6709;&#x533F;&#x540D;/&#x5171;&#x4EAB;&#x533F;&#x540D;/&#x79C1;&#x6709;&#x5927;&#x5C3A;&#x5BF8;&#x9875;&#xFF0C;&#x9700;&#x8981;&#x6293;&#x5168;&#x90E8;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#x5219; adb shell &#x2018;echo 0x27 &gt; /proc/$PID/coredump_filter&#x2019; &#x5373;&#x53EF;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x8282;&#x70B9;</th>
<th>&#x53C2;&#x6570;</th>
</tr>
</thead>
<tbody><tr>
<td>/proc/$PID/coredump_filter</td>
<td>bit0: &#x79C1;&#x6709;&#x533F;&#x540D;</td>
</tr>
<tr>
<td></td>
<td>bit1: &#x5171;&#x4EAB;&#x533F;&#x540D;</td>
</tr>
<tr>
<td></td>
<td>bit2: &#x6709;&#x5E95;&#x5C42;&#x6587;&#x4EF6;&#x7684;&#x79C1;&#x6709;&#x6620;&#x5C04;</td>
</tr>
<tr>
<td></td>
<td>bit3: &#x6709;&#x5E95;&#x5C42;&#x6587;&#x4EF6;&#x5171;&#x4EAB;&#x6620;&#x5C04;</td>
</tr>
<tr>
<td></td>
<td>bit4: ELF&#x5934;</td>
</tr>
<tr>
<td></td>
<td>bit5: &#x79C1;&#x6709;&#x5927;&#x5C3A;&#x5BF8;&#x9875;</td>
</tr>
<tr>
<td></td>
<td>bit6: &#x5171;&#x4EAB;&#x5927;&#x5C3A;&#x5BF8;&#x9875;</td>
</tr>
</tbody></table>
<p>&#x2003;&#x2003;core_pattern &#x63A7;&#x5236;&#x751F;&#x6210; core &#x7684;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x4EE5;&#x53CA;&#x8F93;&#x51FA;&#x7684; core &#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x4F8B;&#x5982;&#xFF1A;  </p>
<p>&#x2003;&#x2003;adb shell &#x2018;echo /data/cores/core.%p &gt; /proc/sys/kernel/core_pattern&#x2019;</p>
<table>
<thead>
<tr>
<th>&#x8282;&#x70B9;</th>
<th>&#x53C2;&#x6570;</th>
</tr>
</thead>
<tbody><tr>
<td>/proc/sys/kernel/core_pattern</td>
<td>%p: &#x6DFB;&#x52A0;pid</td>
</tr>
<tr>
<td></td>
<td>%u: &#x6DFB;&#x52A0;&#x5F53;&#x524D;uid</td>
</tr>
<tr>
<td></td>
<td>%g: &#x6DFB;&#x52A0;&#x5F53;&#x524D;gid</td>
</tr>
<tr>
<td></td>
<td>%s: &#x6DFB;&#x52A0;&#x5BFC;&#x81F4;&#x4EA7;&#x751F;core&#x7684;&#x4FE1;&#x53F7;</td>
</tr>
<tr>
<td></td>
<td>%t: &#x6DFB;&#x52A0;core&#x6587;&#x4EF6;&#x751F;&#x6210;&#x65F6;&#x7684;unix&#x65F6;&#x95F4;</td>
</tr>
<tr>
<td></td>
<td>%h: &#x6DFB;&#x52A0;&#x4E3B;&#x673A;&#x540D;</td>
</tr>
<tr>
<td></td>
<td>%e: &#x6DFB;&#x52A0;&#x547D;&#x4EE4;&#x540D;</td>
</tr>
<tr>
<td></td>
<td>&#xFF05;E: &#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x8DEF;&#x5F84;&#x540D;&#xFF0C;&#x7528;&#x659C;&#x6760;&#xFF08;&#x2019;/&#x2019;&#xFF09;&#x66FF;&#x6362;&#x4E3A;&#x611F;&#x53F9;&#x53F7;&#xFF08;&#x2019;&#xFF01;&#x2019;&#xFF09;&#x3002;</td>
</tr>
</tbody></table>
<p>&#x2003;&#x2003;&#x5F53;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x4E86; seteuid()/setegid() &#x6539;&#x53D8;&#x8FDB;&#x7A0B;&#x7684;&#x6709;&#x6548;&#x7528;&#x6237;&#x6216;&#x7EC4;&#xFF0C;&#x5219;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7CFB;&#x7EDF;&#x4E0D;&#x4F1A;&#x4E3A;&#x8FD9;&#x4E9B;&#x8FDB;&#x7A0B;&#x751F;&#x6210; core&#xFF0C;&#x6B64;&#x65F6;&#x4F60;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x8C03;&#x6574; suid_dumpable &#x53C2;&#x6570;&#x8FDB;&#x5165;&#x8C03;&#x8BD5;&#x6A21;&#x5F0F;&#x6216;&#x5B89;&#x5168;&#x6A21;&#x5F0F;&#x4E0B;&#x8FDB;&#x884C;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x8282;&#x70B9;</th>
<th>&#x53C2;&#x6570;</th>
</tr>
</thead>
<tbody><tr>
<td>/proc/sys/fs/suid_dumpable</td>
<td>0&#xFF1A;&#x9ED8;&#x8BA4;&#x6A21;&#x5F0F;</td>
</tr>
<tr>
<td></td>
<td>1&#xFF1A;&#x8C03;&#x8BD5;&#x6A21;&#x5F0F;</td>
</tr>
<tr>
<td></td>
<td>2&#xFF1A;&#x5B89;&#x5168;&#x6A21;&#x5F0F;</td>
</tr>
</tbody></table>
<h3 id="&#x6587;&#x4EF6;&#x683C;&#x5F0F;"><a href="#&#x6587;&#x4EF6;&#x683C;&#x5F0F;" class="headerlink" title="&#x6587;&#x4EF6;&#x683C;&#x5F0F;"></a>&#x6587;&#x4EF6;&#x683C;&#x5F0F;</h3><p>&#x2003;&#x2003;core &#x6587;&#x4EF6;&#x4E5F;&#x662F;ELF&#x6587;&#x4EF6;&#x7684;&#x4E00;&#x79CD;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x7684;&#x4E3B;&#x4F53;&#x683C;&#x5F0F;&#x7EC4;&#x6210;&#x90E8;&#x5206;&#x4E0E; ELF &#x6587;&#x4EF6;&#x76F8;&#x540C;&#xFF0C;&#x4EE5;&#x6848;&#x4F8B;&#x8BB2;&#x89E3;&#x7684; core &#x6587;&#x4EF6;&#x4E3A;&#x4F8B;&#xFF0C;&#x5B83;&#x4E3B;&#x8981;&#x7EC4;&#x6210;&#x90E8;&#x5206;&#x4E3A; /proc/self/maps &#x4E0B;&#x7684;VMA&#x4EE5;&#x53CA;&#x5404;&#x4E2A;&#x7EBF;&#x7A0B;&#x5BC4;&#x5B58;&#x5668;&#x3002;&#x5176;&#x4E2D;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#x5B58;&#x653E;&#x5728;PT_NOTE&#xFF0C;&#x5404;VMA&#x5B58;&#x653E;&#x5728; PT_LOAD&#xFF0C;&#x5F53;&#x88AB;&#x8FC7;&#x6EE4;&#x6389;&#x7684; VMA&#xFF0C;&#x5B83;&#x53EA;&#x6709; Program Header &#x63CF;&#x8FF0;&#xFF0C;&#x6CA1;&#x6709;&#x5BF9;&#x5E94;&#x7684; segment&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5BF9;&#x5E94;&#x7684;&#x6BB5;&#x7684; p_filesz = 0x0&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/65484452f4f5f9dbefcdebb447582d3db24f928675675625bb4adaaa97cc4e4c" alt="UML diagram (16).jpg"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/32824b300d1272fca43ff0e95182ee7f8df6503ff78c8df7f94ca020c9ae5d31" alt="UML diagram (5).jpg"></p>
<h3 id="&#x79BB;&#x7EBF;&#x8C03;&#x8BD5;"><a href="#&#x79BB;&#x7EBF;&#x8C03;&#x8BD5;" class="headerlink" title="&#x79BB;&#x7EBF;&#x8C03;&#x8BD5;"></a>&#x79BB;&#x7EBF;&#x8C03;&#x8BD5;</h3><p>&#x2003;&#x2003;&#x6CE8;&#xFF1A;MTK &#x5E73;&#x53F0;&#x7684; MINIDUMP &#x4E5F;&#x662F; coredump &#x7684;&#x4E00;&#x79CD;&#xFF0C;&#x5B83;&#x6240;&#x4FDD;&#x5B58;&#x7684;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#x6709;&#x9650;&#xFF0C;core &#x7684;&#x5206;&#x6790;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; GDB&#x3001;lldb &#x7B49;&#x8C03;&#x8BD5;&#x5DE5;&#x5177;&#xFF0C;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x8C03;&#x8BD5;&#x5DE5;&#x5177;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x4E00;&#x4E00;&#x4ECB;&#x7ECD;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;$ ~/work/debug/gdb_arm64/gdb-12.1/output/bin/aarch64-linux-gdb</span><br><span class="line">&#x5F53;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x7B26;&#x53F7;&#x8868;&#x65F6;&#xFF0C;&#x4EC5;&#x52A0;&#x8F7D; core-file &#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x3002;</span><br><span class="line">(gdb) core-file PROCESS_MINIDUMP</span><br><span class="line">&#x5F53;&#x6211;&#x4EEC;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x7B26;&#x53F7;&#x8868;&#x65F6;&#xFF0C;&#x5373;&#x53EF;&#x52A0;&#x8F7D;&#x7B26;&#x53F7;&#x8868;&#x76EE;&#x5F55;</span><br><span class="line">(gdb) set solib-search-path symbols/</span><br><span class="line">&#x6216;&#x8005;</span><br><span class="line">(gdb) set sysroot symbols/</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>&#x547D;&#x4EE4;</th>
<th>&#x7528;&#x9014;</th>
</tr>
</thead>
<tbody><tr>
<td>(gdb) info sharedlibrary</td>
<td>&#x663E;&#x793A;&#x6240;&#x6709;&#x5171;&#x4EAB;&#x5E93;&#x7684;&#x5730;&#x5740;&#x8303;&#x56F4;</td>
</tr>
<tr>
<td>(gdb) info registers</td>
<td>&#x663E;&#x793A;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x5F53;&#x524D;&#x5E27;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;</td>
</tr>
<tr>
<td>(gdb) info locals</td>
<td>&#x663E;&#x793A;&#x5F53;&#x524D;&#x5E27;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;</td>
</tr>
<tr>
<td>(gdb) info thread</td>
<td>&#x663E;&#x793A;&#x6709;&#x54EA;&#x4E9B;&#x7EBF;&#x7A0B;</td>
</tr>
<tr>
<td>(gdb) thread 2</td>
<td>&#x5207;&#x6362;&#x5230;2&#x53F7;&#x7EBF;&#x7A0B;&#x4E0A;</td>
</tr>
<tr>
<td>(gdb) bt</td>
<td>&#x663E;&#x793A;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x5806;&#x6808;</td>
</tr>
<tr>
<td>(gdb) thread apply all [command]&#x4F8B;&#x5982;&#x6253;&#x5370;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x5806;&#x6808;(gdb) thread apply all bt</td>
<td>&#x8BA9;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x505A;&#x540C;&#x6837;&#x7684;&#x547D;&#x4EE4;</td>
</tr>
<tr>
<td>(gdb) frame</td>
<td>&#x663E;&#x793A;&#x5F53;&#x524D;&#x5E27;&#x4FE1;&#x606F;</td>
</tr>
<tr>
<td>(gdb) frame 3</td>
<td>&#x5207;&#x6362;&#x5230;#3&#x5E27;</td>
</tr>
<tr>
<td>(gdb) print &#x6216; (gdb) p</td>
<td>&#x6253;&#x5370;&#x53D8;&#x91CF;</td>
</tr>
<tr>
<td>(gdb) ptype &#x2018;android::AHandler&#x2019;</td>
<td>&#x67E5;&#x770B;&#x67D0;&#x4E2A;class&#x6216;struct&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</td>
</tr>
<tr>
<td>(gdb) ptype /o &#x2018;android::AHandler&#x2019;</td>
<td>&#x67E5;&#x770B;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5360;&#x591A;&#x5C11;&#x5B57;&#x8282;</td>
</tr>
<tr>
<td>(gdb) set print pretty on</td>
<td>&#x683C;&#x5F0F;&#x5316;&#x8F93;&#x51FA;</td>
</tr>
<tr>
<td>(gdb) set log on</td>
<td>&#x4FDD;&#x5B58;gdb&#x8F93;&#x51FA;&#x7684;&#x7ED3;&#x679C;</td>
</tr>
<tr>
<td>(gdb) x /gx 0x7c02d886f0</td>
<td>&#x8BFB;&#x53D6;&#x5730;&#x5740;0x7c02d886f0&#x5185;&#x5B58;&#x5185;&#x5BB9;&#xFF0C;&#x5176;&#x4E2D;&#x8F93;&#x51FA;&#x683C;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;o(octal), x(hex), d(decimal),u(unsigned decimal), t(binary),f(float), a(address), i(instruction),c(char), s(string),z(hex, zero padded on the left).</td>
</tr>
<tr>
<td>(gdb) disassemble 0x0000007c95de6708&#x6216;(gdb) disassemble &#x2018;android::AMessage::setTarget&#x2019;</td>
<td>&#x663E;&#x793A;&#x51FD;&#x6570;&#x6C47;&#x7F16;&#x4FE1;&#x606F;</td>
</tr>
</tbody></table>
<h1 id="&#x5185;&#x5B58;&#x68C0;&#x6D4B;&#x673A;&#x5236;"><a href="#&#x5185;&#x5B58;&#x68C0;&#x6D4B;&#x673A;&#x5236;" class="headerlink" title="&#x5185;&#x5B58;&#x68C0;&#x6D4B;&#x673A;&#x5236;"></a>&#x5185;&#x5B58;&#x68C0;&#x6D4B;&#x673A;&#x5236;</h1><h3 id="ASAN"><a href="#ASAN" class="headerlink" title="ASAN"></a>ASAN</h3><p>&#x2003;&#x2003;&#x5728; Android 11 &#x4E4B;&#x540E;&#x7684; AOSP master &#x4E2D;&#xFF0C;&#x5F03;&#x7528;&#x4E86; arm64 &#x4E0A;&#x7684;&#x5E73;&#x53F0;&#x5F00;&#x53D1; ASAN&#xFF0C;&#x6539;&#x4E3A;&#x4F7F;&#x7528; HWASAN&#xFF0C;AddressSanitizer (ASAN) &#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x5FEB;&#x901F;&#x68C0;&#x6D4B;&#x5DE5;&#x5177;&#xFF0C;&#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x7C7B;&#x578B;</th>
<th>&#x610F;&#x4E49;</th>
</tr>
</thead>
<tbody><tr>
<td>Stack and heap buffer overflow/underflow</td>
<td>&#x5806;&#x6808;&#x548C;&#x5806;&#x7F13;&#x51B2;&#x533A;&#x4E0A;&#x6EA2;/&#x4E0B;&#x6EA2;</td>
</tr>
<tr>
<td>Heap use after free</td>
<td>&#x4F7F;&#x7528;&#x5DF2;&#x91CA;&#x653E;&#x7684;&#x5185;&#x5B58;</td>
</tr>
<tr>
<td>Stack use outside scope</td>
<td>&#x8D85;&#x51FA;&#x6808;&#x8303;&#x56F4;</td>
</tr>
<tr>
<td>Double free/wild free</td>
<td>&#x591A;&#x6B21;&#x91CA;&#x653E;&#x5185;&#x5B58;/&#x9519;&#x8BEF;&#x91CA;&#x653E;</td>
</tr>
</tbody></table>
<h3 id="HWASAN"><a href="#HWASAN" class="headerlink" title="HWASAN"></a>HWASAN</h3><p>&#x2003;&#x2003;HWASan &#x4EC5;&#x9002;&#x7528;&#x4E8E; Android 10 &#x53CA;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#xFF0C;&#x4E14;&#x53EA;&#x80FD;&#x7528;&#x4E8E; AArch64 &#x786C;&#x4EF6;&#xFF0C;&#x5177;&#x5907; ASAN &#x540C;&#x6837;&#x7684;&#x68C0;&#x6D4B;&#x80FD;&#x529B;&#xFF0C;&#x5728; Linux-4.14 &#x7248;&#x672C;&#x4EE5;&#x4E0A;&#x652F;&#x6301; tagged-pointers&#x624D;&#x80FD;&#x4F7F;&#x7528;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;&#x7F16;&#x8BD1;Android&#x7248;&#x672C;&#x65F6;&#x5E26;&#x5165;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x5982;&#x4E0B;&#xFF1A;</span><br><span class="line">$ export SANITIZE_TARGET=hwaddress</span><br><span class="line">&#x8DF3;&#x8FC7;&#x67D0;&#x4E2A;&#x6A21;&#x5757;&#xFF0C;&#x5728;&#x76F8;&#x5E94;&#x6A21;&#x5757;&#x4E0B;&#x7684;Android.bp&#x6587;&#x4EF6;&#x4E0B;&#x6DFB;&#x52A0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</span><br><span class="line">sanitize: {</span><br><span class="line">hwaddress: false,</span><br><span class="line">address: false,</span><br><span class="line">},</span><br><span class="line"></span><br><span class="line">Android.mk&#x5219;&#x6DFB;&#x52A0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</span><br><span class="line">LOCAL_NOSANITIZE := hwaddress</span><br><span class="line"></span><br><span class="line">APP&#x6784;&#x5EFA;&#x652F;&#x6301;HWASAN&#x5219;&#x5728;Application.mk&#x4E0B;&#x6DFB;&#x52A0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</span><br><span class="line">APP_STL := c++_shared</span><br><span class="line">APP_CFLAGS := -fsanitize=hwaddress -fno-omit-frame-pointer</span><br><span class="line">APP_LDFLAGS := -fsanitize=hwaddress</span><br></pre></td></tr></table></figure>

<h3 id="MTE"><a href="#MTE" class="headerlink" title="MTE"></a>MTE</h3><p>&#x2003;&#x2003;&#x6700;&#x65B0; Android S &#x4E0A;&#x5F15;&#x5165;&#x7684; ARM Memory Tagging Extension (MTE)&#xFF0C;MTE &#x7684;&#x539F;&#x7406;&#x548C; HWASan &#x7C7B;&#x4F3C;&#xFF0C;&#x6700;&#x5927;&#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E; HWASan &#x9700;&#x8981;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF0C;&#x5728;&#x6240;&#x6709;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x524D;&#x63D2;&#x6869;&#x76F8;&#x5E94;&#x7684;&#x68C0;&#x6D4B;&#x51FD;&#x6570;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x800C; MTE &#x5219;&#x5728;&#x8BFB;&#x5199;&#x6307;&#x4EE4;&#x5185;&#x90E8;&#x5B8C;&#x6210;&#x68C0;&#x6D4B;&#xFF0C;&#x5B8C;&#x5168;&#x7531;&#x786C;&#x4EF6;&#x652F;&#x6301;&#x3002;<br>&#x66F4;&#x591A;&#x5185;&#x5BB9;&#x8F6C;&#x81F3;&#x6398;&#x91D1;&#x5927;&#x4F6C;-&#x82A6;&#x534A;&#x5C71;&#xFF1A;  </p>
<p>&#x2003;&#x2003;<a href="https://dev.newban.cn/6844904111570157575">juejin.cn/post/684490&#x2026;</a>  </p>
<p>&#x2003;&#x2003;<a href="https://dev.newban.cn/7013595058125406238">juejin.cn/post/701359&#x2026;</a></p>
<h1 id="&#x91CE;&#x6307;&#x9488;&#x7684;&#x5371;&#x5BB3;"><a href="#&#x91CE;&#x6307;&#x9488;&#x7684;&#x5371;&#x5BB3;" class="headerlink" title="&#x91CE;&#x6307;&#x9488;&#x7684;&#x5371;&#x5BB3;"></a>&#x91CE;&#x6307;&#x9488;&#x7684;&#x5371;&#x5BB3;</h1><p>&#x2003;&#x2003;&#x5F53;&#x6240;&#x6307;&#x5411;&#x7684;&#x5BF9;&#x8C61;&#x88AB;&#x91CA;&#x653E;&#x6216;&#x8005;&#x6536;&#x56DE;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x8BE5;&#x6307;&#x9488;&#x6CA1;&#x6709;&#x4F5C;&#x4EFB;&#x4F55;&#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x4EE5;&#x81F3;&#x4E8E;&#x8BE5;&#x6307;&#x9488;&#x4ECD;&#x65E7;&#x6307;&#x5411;&#x5DF2;&#x7ECF;&#x56DE;&#x6536;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#xFF0C;&#x6B64;&#x60C5;&#x51B5;&#x4E0B;&#x8BE5;&#x6307;&#x9488;&#x4FBF;&#x79F0; Wild pointer (&#x91CE;&#x6307;&#x9488;)&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x91CE;&#x6307;&#x9488;&#x6240;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x88AB;&#x5206;&#x914D;&#x7ED9;&#x5176;&#x5B83;&#x6307;&#x9488;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x91CE;&#x6307;&#x9488;&#x4ECD;&#x5728;&#x4F7F;&#x7528;&#xFF0C;&#x7A0B;&#x5E8F;&#x5C06;&#x96BE;&#x4EE5;&#x9884;&#x6D4B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdio.h&gt;</span><br><span class="line">class A {</span><br><span class="line">public:</span><br><span class="line">    virtual ~A() = default;</span><br><span class="line">    virtual void foo() {</span><br><span class="line">        printf(&quot;A:%ld\n&quot;, a);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    long a;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">class B {</span><br><span class="line">public:</span><br><span class="line">    virtual ~B() = default;</span><br><span class="line">    virtual void foo() {</span><br><span class="line">        printf(&quot;B:%ld\n&quot;, b);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    long b;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int main(int /*argc*/, char** /*argv[]*/) {</span><br><span class="line">    A *a = new A();</span><br><span class="line">    A *a_bak = a;</span><br><span class="line">    a-&gt;a = 1000L;</span><br><span class="line">    printf(&quot;A ptr = %p\n&quot;, a);</span><br><span class="line">    delete a; // &#x6B64;&#x65F6;a&#x6307;&#x9488;&#x5DF2;&#x7ECF;&#x88AB;free&#x6389;&#xFF0C;&#x90A3;&#x4E48;&#x6307;&#x9488;a_bak&#x662F;&#x4E2A;&#x91CE;&#x6307;&#x9488;</span><br><span class="line">    B *b = new B();</span><br><span class="line">    printf(&quot;B ptr = %p\n&quot;, b);</span><br><span class="line">    b-&gt;b = 2000L;</span><br><span class="line">    b-&gt;foo();</span><br><span class="line">    a_bak-&gt;foo(); // &#x6B64;&#x5904;&#x7A0B;&#x5E8F;&#x4F1A;&#x8FD0;&#x884C;&#x600E;&#x4E48;&#x7ED3;&#x679C;</span><br><span class="line">    delete b;</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x4EE5;&#x4E0A;&#x7A0B;&#x5E8F;&#x4F1A;&#x600E;&#x4E48;&#x8F93;&#x51FA;&#xFF0C;&#x7531;&#x4E8E; B &#x4E0E; A &#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5927;&#x5C0F;&#x4E00;&#x81F4;&#xFF0C;&#x8FD0;&#x884C;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x6781;&#x5927;&#x53EF;&#x80FD;&#x4F1A;&#x5206;&#x914D;&#x521A;&#x91CA;&#x653E;&#x7684;&#x6307;&#x9488;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x6700;&#x540E;&#x6307;&#x9488; b &#x4E0E;&#x6307;&#x9488; a_bak &#x662F;&#x540C;&#x4E00;&#x4E2A;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;# ./data/Tester64</span><br><span class="line">A ptr = 0xb400007690205010</span><br><span class="line">B ptr = 0xb400007690205010</span><br><span class="line">B:2000</span><br><span class="line">B:2000</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x50CF;&#x4EE5;&#x4E0A;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x90A3;&#x7A0B;&#x5E8F;&#x5982;&#x4E0B;&#x6539;&#x5199;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x6015;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x4F1A;&#x51FA;&#x73B0;&#xFF0C;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x4F1A;&#x62A5;&#x4EC0;&#x4E48;&#x9519;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdio.h&gt;</span><br><span class="line">class A {</span><br><span class="line">public:</span><br><span class="line">    long bad;</span><br><span class="line">    long a;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">class B {</span><br><span class="line">    public:</span><br><span class="line">    virtual ~B() = default;</span><br><span class="line">    virtual void foo() {</span><br><span class="line">        b = 2000L;</span><br><span class="line">        printf(&quot;B:%ld\n&quot;, b);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    long b;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int main(int /*argc*/, char** /*argv[]*/) {</span><br><span class="line">    A *a = new A();</span><br><span class="line">    A *a_bak = a;</span><br><span class="line">    printf(&quot;A ptr = %p\n&quot;, a);</span><br><span class="line">    delete a;</span><br><span class="line">    B *b = new B();</span><br><span class="line">    printf(&quot;B ptr = %p\n&quot;, b);</span><br><span class="line">    a_bak-&gt;bad = 0x20L;</span><br><span class="line">    b-&gt;foo();</span><br><span class="line">    delete b;</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x5728;27&#x884C;&#x5904;&#xFF0C;bad &#x4F1A;&#x5C06; B &#x7684;&#x865A;&#x51FD;&#x6570;&#x8868;&#x7834;&#x574F;&#xFF0C;&#x5BFC;&#x81F4;28&#x548C;29&#x884C;&#x5728;&#x865A;&#x51FD;&#x6570;&#x8868;&#x4E0A;&#x5BFB;&#x627E; foo &#x51FD;&#x6570;&#x4E0E;&#x6790;&#x6784;&#x51FD;&#x6570;&#x5730;&#x5740;&#x65F6;&#x53D1;&#x6BB5;&#x9519;&#x8BEF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Timestamp: 2022-07-06 14:47:50.925654058+0800</span><br><span class="line">Process uptime: 0s</span><br><span class="line">Cmdline: ./data/Tester64</span><br><span class="line">pid: 12652, tid: 12652, name: Tester64 &gt;&gt;&gt; ./data/Tester64 &lt;&lt;&lt;</span><br><span class="line">uid: 0</span><br><span class="line">tagged_addr_ctrl: 0000000000000001</span><br><span class="line">signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x28</span><br><span class="line">Cause: null pointer dereference</span><br><span class="line">x0 b40000762f005010 x1 b40000762f01b000 x2 0000000000000007 x3 ffffffffffffffff</span><br><span class="line">x4 ffffffffffffffff x5 0000000040100401 x6 b40000762f01b006 x7 3637303030303462</span><br><span class="line">x8 0000000000000020 x9 a454ef76eb4317d3 x10 0000000000004001 x11 0000000000000000</span><br><span class="line">x12 0000000000000000 x13 0000000000000002 x14 0000000000000010 x15 0000000000000010</span><br><span class="line">x16 000000762f5a0c58 x17 000000762f5910d4 x18 000000763745c000 x19 b40000762f005010</span><br><span class="line">x20 b40000762f005010 x21 0000007fe173d378 x22 0000000000000001 x23 0000000000000000</span><br><span class="line">x24 0000000000000000 x25 0000000000000000 x26 0000000000000000 x27 0000000000000000</span><br><span class="line">x28 0000000000000000 x29 0000007fe173d2e0</span><br><span class="line">lr 0000005ac14600c8 sp 0000007fe173d2e0 pc 0000005ac14600d0 pst 0000000060001000</span><br><span class="line"></span><br><span class="line">backtrace:</span><br><span class="line">#00 pc 00000000000010d0 /data/Tester64 (main+124)</span><br><span class="line">#01 pc 000000000008436c /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+100)</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x7A0B;&#x5E8F;&#x4F1A;&#x51FA;&#x9519;&#x8FD8;&#x597D;&#xFF0C;&#x5982;&#x679C;&#x7A0B;&#x5E8F;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#xFF0C;&#x4ECD;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x5C06;&#x53D8;&#x5F97;&#x5F88;&#x53EF;&#x6015;&#xFF0C;&#x56E0;&#x4E3A;&#x4F60;&#x4E0D;&#x77E5;&#x9053;&#x7A0B;&#x5E8F;&#x5C06;&#x4F1A;&#x600E;&#x4E48;&#x8FD0;&#x884C;&#xFF0C;&#x50CF;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#xFF0C;&#x523B;&#x610F;&#x6539;&#x5199;&#x63A7;&#x5236;&#x7A0B;&#x5E8F;&#x5F80;&#x5176;&#x5B83;&#x65B9;&#x5411;&#x8FD0;&#x884C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdio.h&gt;</span><br><span class="line">class A {</span><br><span class="line">public:</span><br><span class="line">    void *bad;</span><br><span class="line">    long a;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">class B {</span><br><span class="line">public:</span><br><span class="line">    virtual ~B() {</span><br><span class="line">        printf(&quot;delete B\n&quot;);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    virtual void foo() {</span><br><span class="line">        b = 2000L;</span><br><span class="line">        printf(&quot;B:%ld\n&quot;, b);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    long b;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">void func1() {</span><br><span class="line">    printf(&quot;Hello !!\n&quot;);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void func2() {</span><br><span class="line">    printf(&quot;GoGoGo !!\n&quot;);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main(int /*argc*/, char** /*argv[]*/) {</span><br><span class="line">    A *a = new A();</span><br><span class="line">    A *a_bak = a;</span><br><span class="line">    printf(&quot;A ptr = %p\n&quot;, a);</span><br><span class="line">    delete a;</span><br><span class="line">    B *b = new B();</span><br><span class="line">    printf(&quot;B ptr = %p\n&quot;, b);</span><br><span class="line">    </span><br><span class="line">    long *data = new long[4] {0x0L, (long)func2, (long)func1, 0x0L};</span><br><span class="line">    a_bak-&gt;bad = data;</span><br><span class="line">    </span><br><span class="line">    printf(&quot;Test .. \n&quot;);</span><br><span class="line">    b-&gt;foo();</span><br><span class="line">    delete b;</span><br><span class="line">    printf(&quot;Done.\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;# ./data/Tester64</span><br><span class="line">A ptr = 0xb400007ce9605010</span><br><span class="line">B ptr = 0xb400007ce9605010</span><br><span class="line">Test ..</span><br><span class="line">Hello !!</span><br><span class="line">GoGoGo !!</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<h1 id="&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x7684;&#x5371;&#x5BB3;"><a href="#&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x7684;&#x5371;&#x5BB3;" class="headerlink" title="&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x7684;&#x5371;&#x5BB3;"></a>&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x7684;&#x5371;&#x5BB3;</h1><p>&#x2003;&#x2003;&#x6BD4;&#x8D77;&#x524D;&#x9762;&#x7684;&#x91CE;&#x6307;&#x9488;&#xFF0C;&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x90FD;&#x80FD;&#x88AB; HWASAN &#x7B49;&#x5185;&#x5B58;&#x68C0;&#x6D4B;&#x53D1;&#x73B0;&#xFF0C;&#x5F53;&#x7136;&#x524D;&#x9762;&#x7684;&#x91CE;&#x6307;&#x9488;&#x60C5;&#x51B5;&#x4E5F;&#x662F;&#x80FD;&#x88AB;&#x68C0;&#x6D4B;&#x53D1;&#x73B0;&#x7684;&#xFF0C;&#x6570;&#x7EC4;&#x8D8A;&#x754C;&#x5F80;&#x5F80;&#x4F1A;&#x51FA;&#x73B0;&#x67D0;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x5185;&#x5B58;&#x524D;&#x534A;&#x90E8;&#x5206;&#x88AB;&#x6C61;&#x67D3;&#xFF0C;&#x800C;&#x540E;&#x534A;&#x90E8;&#x5206;&#x6570;&#x636E;&#x6B63;&#x5E38;&#x7684;&#x60C5;&#x51B5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdio.h&gt;</span><br><span class="line">class A {</span><br><span class="line">public:</span><br><span class="line">    long a = 0x55AA;</span><br><span class="line">    long b = 0xDEAD;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int main(int /*argc*/, char** /*argv[]*/) {</span><br><span class="line">    long *b = new long[2] {0x0L, 0x1L};</span><br><span class="line">    A *a = new A();</span><br><span class="line">    printf(&quot;A:%p\n&quot;, a);</span><br><span class="line">    printf(&quot;B:%p\n&quot;, b);</span><br><span class="line">    b[2] = 0xDEAD;</span><br><span class="line">    printf(&quot;B2:%p\n&quot;, &amp;b[2]);</span><br><span class="line">    printf(&quot;0x%lx-0x%lx\n&quot;, a-&gt;a, a-&gt;b);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x56E0;&#x4E3A; b &#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x4E0E;&#x5BF9;&#x8C61; a &#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x521A;&#x542F;&#x52A8;&#x5206;&#x914D;&#x6307;&#x9488;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x57FA;&#x672C;&#x4F1A;&#x8FDE;&#x5728;&#x4E00;&#x5757;&#xFF0C;&#x56E0;&#x6B64; b[2] &#x8D8A;&#x754C;&#x884C;&#x4E3A;&#x5C06;&#x5BF9;&#x8C61; a &#x7684;&#x5185;&#x5BB9;&#x7834;&#x574F;&#xFF0C;&#x5F80;&#x5F80;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x4E86;&#x5F88;&#x4E45;&#xFF0C;&#x5185;&#x5B58;&#x788E;&#x7247;&#x5316;&#x589E;&#x52A0;&#xFF0C;&#x5C31;&#x4E0D;&#x77E5;&#x9053; b[2] &#x8D8A;&#x754C;&#x64CD;&#x4F5C;&#x4F1A;&#x7834;&#x574F;&#x54EA;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x5185;&#x5B58;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;# ./data/Tester64</span><br><span class="line">A:0xb400007fa7c05020</span><br><span class="line">B:0xb400007fa7c05010</span><br><span class="line">B2:0xb400007fa7c05020</span><br><span class="line">0xdead-0xdead</span><br></pre></td></tr></table></figure>

<h1 id="&#x673A;&#x5668;&#x7801;&#x7FFB;&#x8BD1;"><a href="#&#x673A;&#x5668;&#x7801;&#x7FFB;&#x8BD1;" class="headerlink" title="&#x673A;&#x5668;&#x7801;&#x7FFB;&#x8BD1;"></a>&#x673A;&#x5668;&#x7801;&#x7FFB;&#x8BD1;</h1><p>&#x2003;&#x2003;&#x672C;&#x6587;&#x6848;&#x4F8B;&#x4E2D;&#x7684; tombstone &#x6587;&#x4EF6; PC &#x8DD1;&#x98DE;&#xFF0C;&#x6CA1;&#x6709;&#x843D;&#x5728; text &#x6BB5;&#x5730;&#x5740;&#x4E0A;&#xFF0C;&#x8FD9;&#x91CC;&#x6362;&#x4E00;&#x4EFD; tombstone &#x65B9;&#x4FBF;&#x8BF4;&#x660E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F16;&#x8BD1;&#x7684;&#x65B9;&#x6CD5;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684; ELF &#x6587;&#x4EF6;&#xFF0C;&#x5373;&#x53EF;&#x7528; objdump &#x5F97;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6C47;&#x7F16;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x40</span><br><span class="line">Cause: null pointer dereference</span><br><span class="line">x0 0000000000000020 x1 b400007bf95f0e00 x2 63692f6863726165 x3 0000000000000008</span><br><span class="line">x4 b400007bf95f0e74 x5 b400007bf8ea36f4 x6 656863732f676e69 x7 732f7269645f616d</span><br><span class="line">x8 db4cf552ad46f717 x9 0000000000000001 x10 00000000000349e0 x11 0000007bc0000000</span><br><span class="line">x12 0000000000000000 x13 0000000000034960 x14 b400007b58d7c4c0 x15 00000000374d2457</span><br><span class="line">x16 0000007ca3543d50 x17 0000007ca35338ec x18 0000007b38c74000 x19 0000000000000020</span><br><span class="line">x20 0000000000000000 x21 0000007b548e9000 x22 0000007b548e9000 x23 b400007bf946ffd0</span><br><span class="line">x24 0000007b548e76c0 x25 0000007b548e9000 x26 0000007b548e7b30 x27 0000007b548e7b18</span><br><span class="line">x28 0000007b548e7a10 x29 0000007b548e7410</span><br><span class="line">lr 0000007a8e4e7980 sp 0000007b548e73e0 pc 0000007a8e4d0e00 pst 0000000060001000</span><br><span class="line"></span><br><span class="line">memory near pc (/apex/com.android.appsearch/lib64/libicing.so):</span><br><span class="line">0000007a8e4d0de0 a90557f6f90023f7 9100c3fda9064ff4 .#&#x2026;W&#x2026;O&#x2026;&#x2026;</span><br><span class="line">0000007a8e4d0df0 f94016c8d53bd056 f81f83a8aa0003f3 V.;&#x2026;@&#x2026;&#x2026;&#x2026;</span><br><span class="line">0000007a8e4d0e00 350001c839408008 91181c42b0fffde2 ..@9&#x2026;5&#x2026;.B&#x2026;</span><br><span class="line">0000007a8e4d0e10 2a1f03e1910023e0 910023f452808ee3 .#&#x2026;..*&#x2026;R.#..*</span><br><span class="line">0000007a8e4d0e20 910022809400d695 912b742190fffde1 &#x2026;..&quot;&#x2026;&#x2026;!t+.*</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x7F16;&#x5199;&#x6C47;&#x7F16;&#x6587;&#x4EF6; code.S&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;.inst 0xf90023f7</span><br><span class="line">.inst 0xa90557f6</span><br><span class="line">.inst 0xa9064ff4</span><br><span class="line">.inst 0x9100c3fd</span><br><span class="line">.inst 0xd53bd056</span><br><span class="line">.inst 0xf94016c8</span><br><span class="line">.inst 0xaa0003f3</span><br><span class="line">.inst 0xf81f83a8</span><br><span class="line">.inst 0x39408008</span><br><span class="line">.inst 0x350001c8</span><br><span class="line">.inst 0xb0fffde2</span><br><span class="line">.inst 0x91181c42</span><br><span class="line">.inst 0x910023e0</span><br><span class="line">.inst 0x2a1f03e1</span><br><span class="line">.inst 0x52808ee3</span><br><span class="line">.inst 0x910023f4</span><br><span class="line">.inst 0x9400d695</span><br><span class="line">.inst 0x91002280</span><br><span class="line">.inst 0x90fffde1</span><br><span class="line">.inst 0x912b7421</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;&#x7F16;&#x8BD1;&#xFF1A;aarch64-linux-android-as code.S -o code.o</span><br><span class="line">&#x53CD;&#x6C47;&#x7F16;&#xFF1A;aarch64-linux-android-objdump -d code.o</span><br><span class="line"></span><br><span class="line">code.o: file format elf64-littleaarch64</span><br><span class="line">Disassembly of section .text:</span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">0: f90023f7 str x23, [sp, #64]</span><br><span class="line">4: a90557f6 stp x22, x21, [sp, #80]</span><br><span class="line">8: a9064ff4 stp x20, x19, [sp, #96]</span><br><span class="line">c: 9100c3fd add x29, sp, #0x30</span><br><span class="line">10: d53bd056 mrs x22, tpidr_el0</span><br><span class="line">14: f94016c8 ldr x8, [x22, #40]</span><br><span class="line">18: aa0003f3 mov x19, x0</span><br><span class="line">1c: f81f83a8 stur x8, [x29, #-8]</span><br><span class="line">20: 39408008 ldrb w8, [x0, #32]</span><br><span class="line">24: 350001c8 cbnz w8, 5c &lt;.text+0x5c&gt;</span><br><span class="line">28: b0fffde2 adrp x2, fffffffffffbd000 &lt;.text+0xfffffffffffbd000&gt;</span><br><span class="line">2c: 91181c42 add x2, x2, #0x607</span><br><span class="line">30: 910023e0 add x0, sp, #0x8</span><br><span class="line">34: 2a1f03e1 mov w1, wzr</span><br><span class="line">38: 52808ee3 mov w3, #0x477 // #1143</span><br><span class="line">3c: 910023f4 add x20, sp, #0x8</span><br><span class="line">40: 9400d695 bl 35a94 &lt;.text+0x35a94&gt;</span><br><span class="line">44: 91002280 add x0, x20, #0x8</span><br><span class="line">48: 90fffde1 adrp x1, fffffffffffbc000 &lt;.text+0xfffffffffffbc000&gt;</span><br><span class="line">4c: 912b7421 add x1, x1, #0xadd</span><br><span class="line"></span><br><span class="line">&#x7531;&#x4E8E;x0=0x0000000000000020&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x6307;&#x4EE4;0x39408008( ldrb w8, [x0, #32])&#xFF0C;&#x4F1A;&#x53D1;&#x751F;&#x8BFB;&#x53D6;&#x5185;&#x5B58;0x40&#x7684;&#x6BB5;&#x9519;&#x8BEF;&#x3002;</span><br></pre></td></tr></table></figure>

<h1 id="&#x6C47;&#x7F16;&#x7FFB;&#x8BD1;"><a href="#&#x6C47;&#x7F16;&#x7FFB;&#x8BD1;" class="headerlink" title="&#x6C47;&#x7F16;&#x7FFB;&#x8BD1;"></a>&#x6C47;&#x7F16;&#x7FFB;&#x8BD1;</h1><p>&#x2003;&#x2003;&#x6709;&#x4E9B;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x624B;&#x52A8;&#x4FEE;&#x6539; ELF &#x6587;&#x4EF6;&#x7684;&#x673A;&#x5668;&#x7801;&#x8FBE;&#x5230;&#x4E00;&#x4E9B;&#x8C03;&#x8BD5;&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x77E5;&#x9053;&#x6C47;&#x7F16;&#x5BF9;&#x5E94;&#x7684;&#x673A;&#x5668;&#x7801;&#xFF0C;&#x53BB;&#x67E5;&#x624B;&#x518C;&#x4E5F;&#x6BD4;&#x8F83;&#x9EBB;&#x70E6;&#xFF0C;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x7F16;&#x5199;&#x6C47;&#x7F16;&#x6587;&#x4EF6;&#x5373;&#x53EF;&#x3002;  </p>
<p>&#x7F16;&#x5199;&#x6C47;&#x7F16;&#x6587;&#x4EF6; code_asm.S&#xFF0C;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python&#x590D;&#x5236;&#x4EE3;&#x7801;str x30, [sp, #-16]!</span><br><span class="line">str x29, [sp, #-16]!</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python&#x590D;&#x5236;&#x4EE3;&#x7801;&#x7F16;&#x8BD1;&#xFF1A;aarch64-linux-android-as code_asm.S -o code_asm.o</span><br><span class="line">&#x53CD;&#x6C47;&#x7F16;&#xFF1A;aarch64-linux-android-objdump -d code_asm.o</span><br><span class="line"></span><br><span class="line">code_asm.o: file format elf64-littleaarch64</span><br><span class="line">Disassembly of section .text:</span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">0: f81f0ffe str x30, [sp, #-16]!</span><br><span class="line">4: f81f0ffd str x29, [sp, #-16]!</span><br></pre></td></tr></table></figure>

<h1 id="&#x6848;&#x4F8B;&#x8BB2;&#x89E3;"><a href="#&#x6848;&#x4F8B;&#x8BB2;&#x89E3;" class="headerlink" title="&#x6848;&#x4F8B;&#x8BB2;&#x89E3;"></a>&#x6848;&#x4F8B;&#x8BB2;&#x89E3;</h1><h3 id="&#x9519;&#x8BEF;&#x65E5;&#x5FD7;"><a href="#&#x9519;&#x8BEF;&#x65E5;&#x5FD7;" class="headerlink" title="&#x9519;&#x8BEF;&#x65E5;&#x5FD7;"></a>&#x9519;&#x8BEF;&#x65E5;&#x5FD7;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Timestamp: 2022-06-07 01:53:32.033409857+0800</span><br><span class="line">Process uptime: 0s</span><br><span class="line">Cmdline: mediaserver64</span><br><span class="line">pid: 1139, tid: 11981, name: NPDecoder &gt;&gt;&gt; mediaserver64 &lt;&lt;&lt;</span><br><span class="line">uid: 1013</span><br><span class="line">tagged_addr_ctrl: 0000000000000001</span><br><span class="line">signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7c02d886f0</span><br><span class="line">x0 79748c5e568e2ddc x1 0000007ca13c3618 x2 0000000000000000 x3 0000007ca1291000</span><br><span class="line">x4 0000000001909705 x5 0000000000000000 x6 0000007c02d88808 x7 b60625655bf0252f</span><br><span class="line">x8 0000000000000080 x9 0000007ca126fed7 x10 0000000000000006 x11 0000007bfd0a81fc</span><br><span class="line">x12 9ef8a95ca9649dbe x13 e44782d5ac38720e x14 0000007bfd0a8030 x15 0000001e56307b5c</span><br><span class="line">x16 0000007c95dfdb70 x17 0000007c9844f118 x18 0000007bfaa28000 x19 b400007c13c246d0</span><br><span class="line">x20 0000007c02d88730 x21 b400007c13c67c00 x22 0000000000000415 x23 0000007c02d89000</span><br><span class="line">x24 0000000000000002 x25 b400007c13c246d0 x26 b400007c13c67c00 x27 0000007c02d89000</span><br><span class="line">x28 0000007ca13c2c28 x29 0000007c02d886f0</span><br><span class="line">lr 0000007c02d886f0 sp 0000007c02d886d0 pc 0000007c02d886f0 pst 0000000080001000</span><br><span class="line"></span><br><span class="line">backtrace:</span><br><span class="line">#00 pc 00000000000f86f0 [anon:stack_and_tls:11981]</span><br></pre></td></tr></table></figure>

<h3 id="&#x5206;&#x6790;"><a href="#&#x5206;&#x6790;" class="headerlink" title="&#x5206;&#x6790;"></a>&#x5206;&#x6790;</h3><h5 id="&#x76F4;&#x63A5;&#x539F;&#x56E0;"><a href="#&#x76F4;&#x63A5;&#x539F;&#x56E0;" class="headerlink" title="&#x76F4;&#x63A5;&#x539F;&#x56E0;"></a>&#x76F4;&#x63A5;&#x539F;&#x56E0;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;0000007c&apos;02c90000-0000007c&apos;02d8bfff rw- 0 fc000 [anon:stack_and_tls:11981]</span><br><span class="line">memory near pc ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;*</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line"></span><br><span class="line">code.o: file format elf64-littleaarch64</span><br><span class="line">Disassembly of section .text:</span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line"></span><br><span class="line">0: 02d886f0 .inst 0x02d886f0 ; undefined</span><br><span class="line">4: 0000007c udf #124</span><br><span class="line"></span><br><span class="line">&#x4ECE; tombstone &#x7684; backtrace &#x4FE1;&#x606F;&#x4E0A;&#x770B;&#xFF0C;&#x5F88;&#x660E;&#x663E;&#x662F;PC&#x8DD1;&#x98DE;&#x4E86;&#xFF0C;&#x8DD1;&#x5230;&#x7EBF;&#x7A0B;&#x6808;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x4E0B;&#xFF0C;</span><br><span class="line">&#x6808;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4E0D;&#x53EF;&#x8FD0;&#x884C;&#xFF0C;&#x56E0;&#x6B64;&#x88AB;&#x62D2;&#x7EDD;&#x8BBF;&#x95EE;&#x800C;&#x51FA;&#x9519;&#xFF0C;&#x5982;&#x679C;&#x6709;x&#x7684;&#x6743;&#x9650;&#x90A3;&#x4E48;&#x4E5F;&#x662F;&#x9519;&#x8BEF;&#xFF0C;&#x4F1A;&#x53D1;&#x751F; SIGILL &#x6307;&#x4EE4;&#x9519;&#x8BEF;</span><br></pre></td></tr></table></figure>

<h5 id="&#x6808;&#x56DE;&#x6EAF;"><a href="#&#x6808;&#x56DE;&#x6EAF;" class="headerlink" title="&#x6808;&#x56DE;&#x6EAF;"></a>&#x6808;&#x56DE;&#x6EAF;</h5><p>&#x2003;&#x2003;&#x4ECE; tombstone &#x4E2D;&#x7684; x29 &#x548C; SP &#x5BC4;&#x5B58;&#x5668;&#x9644;&#x8FD1;&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x8FDB;&#x884C;&#x6808;&#x56DE;&#x6EAF;&#xFF0C;&#x7531;&#x4E8E;&#x5927;&#x5C0F;&#x53D7;&#x9650;&#xFF0C;&#x5F80;&#x5F80;&#x65E0;&#x6CD5;&#x56DE;&#x6EAF;&#x5230;&#x6808;&#x5E95;&#xFF0C;&#x65E0;&#x6CD5;&#x5B8C;&#x5168;&#x8BC1;&#x660E;&#x7A0B;&#x5E8F;&#x5C31;&#x662F;&#x7ECF;&#x8FC7;&#x8FD9;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;memory near x29 ([anon:stack_and_tls:11981]):</span><br><span class="line">0000007c02d886d0 b400007c13c246d0 0000000001909705 .F..|&#x2026;&#x2026;&#x2026;..&#x3010;SP = 0x0000007c02d886d0&#x3011;</span><br><span class="line">0000007c02d886e0 0000007c02d88700 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o*</span><br><span class="line">0000007c02d886f0 0000007c02d88750 0000007ca133f8e0 P&#x2026;|&#x2026;..3.|&#x2026;&#x3010;x29 = 0x0000007c02d886f0&#x3011;</span><br><span class="line">0000007c02d88700 0000000000000002 0000000000000000 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88710 0000000000000415 0000000001909705 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.*</span><br><span class="line">0000007c02d88720 0000000000000000 0000007c02d88808 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;*</span><br><span class="line">0000007c02d88730 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..*</span><br><span class="line">0000007c02d88740 0000007c02d89000 6f2ab3b40fa2f8ef &#x2026;.|&#x2026;&#x2026;&#x2026;*o</span><br><span class="line">0000007c02d88750 0000007c02d88830 0000007ca796ee7c 0&#x2026;|&#x2026;|&#x2026;|&#x2026;</span><br><span class="line">0000007c02d88760 0000007ca79f3dd8 0000007ca79edb80 .=..|&#x2026;&#x2026;.|&#x2026;</span><br><span class="line">0000007c02d88770 0000007c02d89000 b400007c13c04680 &#x2026;.|&#x2026;.F..|&#x2026;</span><br><span class="line">0000007c02d88780 0000000000000000 0000000000000002 &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.</span><br><span class="line">0000007c02d88790 b400007c13c67c00 0000000000000000 .|..|&#x2026;&#x2026;&#x2026;..</span><br><span class="line">0000007c02d887a0 0000000000000000 b400007c13c7c100 &#x2026;&#x2026;&#x2026;&#x2026;|&#x2026;</span><br><span class="line">0000007c02d887b0 0000007c02d88830 0000007ca796d420 0&#x2026;|&#x2026; &#x2026;|&#x2026;</span><br><span class="line">0000007c02d887c0 0000007c02d88830 0000007ca796d460 0&#x2026;|&#x2026;`&#x2026;|&#x2026;</span><br><span class="line"></span><br><span class="line">&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x901A;&#x8FC7; FP(x29) &#x56DE;&#x6EAF;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x4E2A; x29 &#x662F;&#x6709;&#x6548;&#x7684;&#xFF0C;&#x90A3;&#x4E48; x29 &#x5B58;&#x653E;&#x7684;&#x662F;&#x4E0A;&#x4E00;&#x4E2A; Caller &#x7684; FP &#x5BC4;&#x5B58;&#x5668;&#xFF0C;x29+0x8 &#x7684;&#x5730;&#x5740;&#x5B58;&#x653E;&#x4E0A;&#x4E00;&#x4E2A; Caller &#x7684; LR &#x5BC4;&#x5B58;&#x5668;&#x3002;</span><br><span class="line"></span><br><span class="line">0x0000007ca133f8e0 &#x5730;&#x5740;&#x843D;&#x5728; /system/lib64/libstagefright.so &#x7684; TEXT &#x6BB5;&#x4E0A;&#x3002;</span><br><span class="line">0000007c&apos;a120e000-0000007c&apos;a128efff r-- 0 81000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a128f000-0000007c&apos;a13c0fff r-x 81000 132000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a13c1000-0000007c&apos;a13cffff r-- 1b3000 f000 /system/lib64/libstagefright.so</span><br><span class="line">0000007c&apos;a13d0000-0000007c&apos;a13d1fff rw- 1c1000 2000 /system/lib64/libstagefright.so</span><br><span class="line"></span><br><span class="line">[14] .text PROGBITS 0000000000081000 00081000</span><br><span class="line">000000000012bed8 0000000000000000 AX 0 0 4096</span><br><span class="line"></span><br><span class="line">Funcation_Offset = PC - TEXT_LOAD + .text_offset</span><br><span class="line"></span><br><span class="line">(gdb) p /x 0x0000007ca133f8e0-0x7ca128f000+0x81000</span><br><span class="line">$1 = 0x1318e0</span><br><span class="line"></span><br><span class="line">(gdb) x /2i 0x1318e0-0x4</span><br><span class="line">0x1318dc &lt;_ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE+200&gt;: bl 0x1ad390 &lt;_ZN7android8AMessageC1EjRKNS_2spIKNS_8AHandlerEEE@plt&gt;</span><br><span class="line">0x1318e0 &lt;_ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE+204&gt;: eor x8, x29, x25</span><br><span class="line"></span><br><span class="line">(gdb) p _ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE+200</span><br><span class="line">$2 = (android::status_t (*)(struct android::MediaCodec * const, size_t, size_t, size_t, int64_t, uint32_t,</span><br><span class="line">struct android::AString *)) 0x1318dc &lt;android::MediaCodec::queueInputBuffer(unsigned long, unsigned long, unsigned long, long, unsigned int, android::AString*)+200&gt;</span><br><span class="line"></span><br><span class="line">&#x56E0;&#x6B64;0x0000007ca133f8e0&#x6240;&#x5728;&#x7684;&#x51FD;&#x6570;&#x662F;android::MediaCodec::queueInputBuffer&#x3002;</span><br><span class="line">&#x4E00;&#x822C;&#x6211;&#x4EEC;&#x76F4;&#x63A5; PC &#x51CF;&#x53BB;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x5373;&#x53EF;&#x5F97;&#x5230;&#x51FD;&#x6570;&#x7684;&#x504F;&#x79FB;&#x5730;&#x5740;&#x3002;</span><br><span class="line"></span><br><span class="line">&#x5373;&#xFF1A; 0x0000007ca133f8e0 - 0x0000007ca120e000</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x6700;&#x540E;&#x8FD9;&#x4EFD; tombstone &#x53EA;&#x80FD;&#x901A;&#x8FC7; FP &#x63A8;&#x5BFC;&#x51FA;&#x8FD9;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x662F;&#x5426;&#x6B63;&#x786E;&#x5F85;&#x53D6;&#x8BC1;&#xFF0C;&#x8FD9;&#x4E5F;&#x4F53;&#x73B0;&#x4E86; tombstone &#x7684;&#x5C40;&#x9650;&#x6027;&#xFF0C;&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x80FD;&#x5B8C;&#x6574;&#x7684;&#x63A8;&#x5BFC;&#xFF0C;&#x5E76;&#x53D6;&#x8BC1;&#x6808;&#x662F;&#x5B8C;&#x6574;&#x6027;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5230; coredump &#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th>FP</th>
<th>LR</th>
<th>&#x51FD;&#x6570;&#x540D;</th>
</tr>
</thead>
<tbody><tr>
<td>0x0000007c02d886f0</td>
<td>0x0000007c02d88750</td>
<td>0x0000007ca133f8e0</td>
<td>android::MediaCodec::queueInputBuffer</td>
</tr>
<tr>
<td>0x0000007c02d88750</td>
<td>0x0000007c02d88830</td>
<td>0x0000007ca796ee7c</td>
<td>android::NuPlayer::Decoder::onInputBufferFetched</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;MTK &#x7684; aee &#x4F1A;&#x5C06;&#x4FDD;&#x5B58;&#x4E00;&#x4EFD; minidump &#xFF0C;&#x5C06; minidump &#x88C5;&#x8F7D;&#x5230;gdb&#x4E0A;&#x56DE;&#x6EAF;&#x3002;</span><br><span class="line">core-file PROCESS_MINIDUMP</span><br><span class="line">(gdb) bt</span><br><span class="line">#0 0x0000007c02d886f0 in ?? ()</span><br><span class="line">&#x7531;&#x6B64;&#x53EF;&#x89C1; GDB &#x4E5F;&#x65E0;&#x6CD5;&#x6B63;&#x786E;&#x56DE;&#x6EAF;&#x8FD9;&#x4E2A;&#x6808;&#xFF0C;&#x6211;&#x4EEC;&#x91CD;&#x590D;&#x524D;&#x9762;&#x7684;&#x6B65;&#x9AA4;&#x5728;&#x5B8C;&#x6574;&#x7684;&#x6808;&#x4E0A;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#xFF0C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>&#x5F53;&#x524D;FP</th>
<th>Caller FP</th>
<th>Caller LR</th>
<th>Caller &#x51FD;&#x6570;&#x540D;</th>
</tr>
</thead>
<tbody><tr>
<td>0x7c02d886f0</td>
<td>0x0000007c02d88750</td>
<td>0x0000007ca133f8e0</td>
<td>android::MediaCodec::queueInputBuffer</td>
</tr>
<tr>
<td>0x7c02d88750</td>
<td>0x0000007c02d88830</td>
<td>0x0000007ca796ee7c</td>
<td>android::NuPlayer::Decoder::onInputBufferFetched</td>
</tr>
<tr>
<td>0x7c02d88830</td>
<td>0x0000007c02d888a0</td>
<td>0x0000007ca796c984</td>
<td>android::NuPlayer::Decoder::doRequestBuffers</td>
</tr>
<tr>
<td>0x7c02d888a0</td>
<td>0x0000007c02d88920</td>
<td>0x0000007ca7963d48</td>
<td>android::NuPlayer::DecoderBase::onRequestInputBuffers</td>
</tr>
<tr>
<td>0x7c02d88920</td>
<td>0x0000007c02d88980</td>
<td>0x0000007ca79717bc</td>
<td>android::NuPlayer::Decoder::handleAnInputBuffer</td>
</tr>
<tr>
<td>0x7c02d88980</td>
<td>0x0000007c02d88a20</td>
<td>0x0000007ca7969328</td>
<td>android::NuPlayer::Decoder::onMessageReceived</td>
</tr>
<tr>
<td>0x7c02d88a20</td>
<td>0x0000007c02d88a70</td>
<td>0x0000007c95de2874</td>
<td>android::AHandler::deliverMessage</td>
</tr>
<tr>
<td>0x7c02d88a70</td>
<td>0x0000007c02d88ad0</td>
<td>0x0000007c95de8608</td>
<td>android::AMessage::deliver</td>
</tr>
<tr>
<td>0x7c02d88ad0</td>
<td>0x0000007c02d88b30</td>
<td>0x0000007c95de3bbc</td>
<td>android::ALooper::loop</td>
</tr>
<tr>
<td>0x7c02d88b30</td>
<td>0x0000007c02d88ba0</td>
<td>0x0000007ca105907c</td>
<td>android::Thread::_threadLoop</td>
</tr>
<tr>
<td>0x7c02d88ba0</td>
<td>0x0000007c02d88c10</td>
<td>0x0000007ca105886c</td>
<td>thread_data_t::trampoline</td>
</tr>
<tr>
<td>0x7c02d88c10</td>
<td>0x0000007c02d88c50</td>
<td>0x0000007caaf3be74</td>
<td>__pthread_start</td>
</tr>
<tr>
<td>0x7c02d88c50</td>
<td>0x0000007c02d88c80</td>
<td>0x0000007caaedb830</td>
<td>__start_thread</td>
</tr>
</tbody></table>
<p>&#x2003;&#x2003;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x80FD;&#x88AB;&#x56DE;&#x6EAF;&#x5230; __start_thread &#x51FD;&#x6570;&#xFF0C;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x8FD9;&#x4E2A;&#x6808;&#x662F;&#x53EF;&#x4FE1;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x6700;&#x540E;&#x7684; FP &#x5730;&#x5740;&#x5B58;&#x653E;&#x4E86; Caller FP &#x4E0E; Caller LR&#xFF0C;&#x5E76;&#x4E14;&#x4ECE;&#x6C47;&#x7F16;&#x7684;&#x6307;&#x4EE4;&#x6D41;&#x7A0B;&#x4E0A;&#x662F;&#x543B;&#x5408;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x6700;&#x540E;&#x7684; FP &#x5E94;&#x8BE5;&#x662F;&#x67D0;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x6808;&#x9876;&#xFF0C;&#x8BB0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E3A; A &#x51FD;&#x6570;&#x3002;</p>
<h5 id="A-&#x51FD;&#x6570;&#x662F;&#x8C01;&#xFF1F;"><a href="#A-&#x51FD;&#x6570;&#x662F;&#x8C01;&#xFF1F;" class="headerlink" title="A &#x51FD;&#x6570;&#x662F;&#x8C01;&#xFF1F;"></a>A &#x51FD;&#x6570;&#x662F;&#x8C01;&#xFF1F;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) x /12gx 0x7c02d886d0</span><br><span class="line">0x7c02d886d0: 0xb400007c13c246d0 0x0000000001909705 // SP</span><br><span class="line">0x7c02d886e0: 0x0000007c02d88700 0x6f2ab3b40fa2f8ef</span><br><span class="line">&#x6B64;&#x5904;&#x662F; A &#x51FD;&#x6570;&#x7684;&#x6808;&#x3002;</span><br><span class="line">0x7c02d886f0: 0x0000007c02d88750 0x0000007ca133f8e0 // FP</span><br><span class="line">0x7c02d88700: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88710: 0x0000000000000415 0x0000000001909705</span><br><span class="line">0x7c02d88720: 0x0000000000000000 0x0000007c02d88808</span><br><span class="line"></span><br><span class="line">&#x5F53; A &#x51FD;&#x6570;&#x8FD0;&#x884C;&#x5B8C;&#x6210;&#x540E;&#x8FD4;&#x56DE; LR &#x5730;&#x5740; 0x0000007ca133f8e0 (*android* *::MediaCodec::queueInputBuffer)*</span><br><span class="line"></span><br><span class="line">&#x6CE8;&#xFF1A;&#x4EE5;&#x4E0B;&#x201C;_ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE&#x201D; &#x7528; &quot;android::MediaCodec::queueInputBuffer&quot; &#x66FF;&#x4EE3;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x0000007ca133f8e0-0x20,+0x30</span><br><span class="line">Dump of assembler code from 0x7ca133f8c0 to 0x7ca133f8f0:</span><br><span class="line">0x0000007ca133f8c0 &lt;android::MediaCodec::queueInputBuffer+172&gt;: mov x1, sp</span><br><span class="line">0x0000007ca133f8c4 &lt;android::MediaCodec::queueInputBuffer+176&gt;: mov x0, x26</span><br><span class="line">0x0000007ca133f8c8 &lt;android::MediaCodec::queueInputBuffer+180&gt;: bl 0x7ca13bb130 &lt;_ZNK7android7RefBase9incStrongEPKv@plt&gt;</span><br><span class="line">0x0000007ca133f8cc &lt;android::MediaCodec::queueInputBuffer+184&gt;: mov x2, sp</span><br><span class="line">0x0000007ca133f8d0 &lt;android::MediaCodec::queueInputBuffer+188&gt;: mov x0, x25</span><br><span class="line">0x0000007ca133f8d4 &lt;android::MediaCodec::queueInputBuffer+192&gt;: mov w1, #0x6549 // #25929</span><br><span class="line">0x0000007ca133f8d8 &lt;android::MediaCodec::queueInputBuffer+196&gt;: movk w1, #0x7175, lsl #16</span><br><span class="line">0x0000007ca133f8dc &lt;android::MediaCodec::queueInputBuffer+200&gt;: bl 0x7ca13bb390 &lt;_ZN7android8AMessageC1EjRKNS_2spIKNS_8AHandlerEEE@plt&gt;</span><br><span class="line">0x0000007ca133f8e0 &lt;android::MediaCodec::queueInputBuffer+204&gt;: eor x8, x29, x25</span><br><span class="line">0x0000007ca133f8e4 &lt;android::MediaCodec::queueInputBuffer+208&gt;: cmp x8, #0xfff</span><br><span class="line">0x0000007ca133f8e8 &lt;android::MediaCodec::queueInputBuffer+212&gt;: str x25, [sp, #8]</span><br><span class="line">0x0000007ca133f8ec &lt;android::MediaCodec::queueInputBuffer+216&gt;: b.hi 0x7ca133f8f4 &lt;_ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE+224&gt; // b.pmore</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) p _ZN7android10MediaCodec16queueInputBufferEmmmljPNS_7AStringE+180</span><br><span class="line">$59 = (android::status_t (*)(android::MediaCodec * const, size_t, size_t, size_t, int64_t, uint32_t,</span><br><span class="line">android::AString *)) 0x7ca133f8c8 &lt;* *android::MediaCodec::queueInputBuffer(unsigned long, unsigned long, unsigned long, long, unsigned int, android::AString*)+180&gt;</span><br><span class="line"></span><br><span class="line">&#x8FD9;&#x4E2A; A &#x51FD;&#x6570;&#x662F; android::AMessage::AMessage(unsigned int, android::sp&lt;android::AHandler const&gt; const&amp;)&#xFF1F;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;A &#x51FD;&#x6570;&#x4F1A;&#x662F; AMessage &#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5417;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x7ca13bb390</span><br><span class="line">Dump of assembler code for function _ZN7android8AMessageC1EjRKNS_2spIKNS_8AHandlerEEE@plt:</span><br><span class="line">0x0000007ca13bb390 &lt;+0&gt;: adrp x16, 0x7ca13cd000</span><br><span class="line">0x0000007ca13bb394 &lt;+4&gt;: ldr x17, [x16, #992]</span><br><span class="line">0x0000007ca13bb398 &lt;+8&gt;: add x16, x16, #0x3e0</span><br><span class="line">0x0000007ca13bb39c &lt;+12&gt;: br x17</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) x /gx 0x7ca13cd000+0x3e0</span><br><span class="line">0x7ca13cd3e0 &lt;_ZN7android8AMessageC1EjRKNS_2spIKNS_8AHandlerEEE@got.plt&gt;: 0x0000007c95de66a8</span><br><span class="line"></span><br><span class="line">(gdb) disassemble 0x0000007c95de66a8</span><br><span class="line">Dump of assembler code for function _ZN7android8AMessageC2EjRKNS_2spIKNS_8AHandlerEEE:</span><br><span class="line">0x0000007c95de66a8 &lt;+0&gt;: stp x29, x30, [sp, #-48]!</span><br><span class="line">0x0000007c95de66ac &lt;+4&gt;: str x21, [sp, #16]</span><br><span class="line">0x0000007c95de66b0 &lt;+8&gt;: stp x20, x19, [sp, #32]</span><br><span class="line">0x0000007c95de66b4 &lt;+12&gt;: mov x29, sp</span><br><span class="line">0x0000007c95de66b8 &lt;+16&gt;: mov x19, x2</span><br><span class="line">0x0000007c95de66bc &lt;+20&gt;: mov w20, w1</span><br><span class="line">0x0000007c95de66c0 &lt;+24&gt;: mov x21, x0</span><br><span class="line">0x0000007c95de66c4 &lt;+28&gt;: bl 0x7c95dfb490 &lt;_ZN7android7RefBaseC2Ev@plt&gt;</span><br><span class="line">0x0000007c95de66c8 &lt;+32&gt;: movi v0.2d, #0x0</span><br><span class="line">0x0000007c95de66cc &lt;+36&gt;: adrp x8, 0x7c95dfd000 &lt;__dso_handle_const&gt;</span><br><span class="line">0x0000007c95de66d0 &lt;+40&gt;: ldr x8, [x8, #2744]</span><br><span class="line">0x0000007c95de66d4 &lt;+44&gt;: str w20, [x21, #16]</span><br><span class="line">0x0000007c95de66d8 &lt;+48&gt;: stur q0, [x21, #24]</span><br><span class="line">0x0000007c95de66dc &lt;+52&gt;: add x8, x8, #0x10</span><br><span class="line">0x0000007c95de66e0 &lt;+56&gt;: stur q0, [x21, #40]</span><br><span class="line">0x0000007c95de66e4 &lt;+60&gt;: mov x0, x21</span><br><span class="line">0x0000007c95de66e8 &lt;+64&gt;: mov x1, x19</span><br><span class="line">0x0000007c95de66ec &lt;+68&gt;: stur q0, [x21, #56]</span><br><span class="line">0x0000007c95de66f0 &lt;+72&gt;: str x8, [x21]</span><br><span class="line">0x0000007c95de66f4 &lt;+76&gt;: str xzr, [x21, #72]</span><br><span class="line">0x0000007c95de66f8 &lt;+80&gt;: ldp x20, x19, [sp, #32]</span><br><span class="line">0x0000007c95de66fc &lt;+84&gt;: ldr x21, [sp, #16]</span><br><span class="line">0x0000007c95de6700 &lt;+88&gt;: ldp x29, x30, [sp], #48</span><br><span class="line">0x0000007c95de6704 &lt;+92&gt;: b 0x7c95dfb950 &lt;_ZN7android8AMessage9setTargetERKNS_2spIKNS_8AHandlerEEE@plt&gt;</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x6808;&#x5927;&#x5C0F;&#x4E3A;0x30&#xFF0C;&#x5E76;&#x4E14; FP=SP&#xFF0C;&#x5982;&#x679C;A&#x51FD;&#x6570;&#x662F; AMessage &#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x8BE5;&#x51FD;&#x6570;&#x672A;&#x9000;&#x6808;&#x65F6; FP=SP &#x4E0D;&#x6210;&#x7ACB;&#x3002;  </p>
<p>&#x7EE7;&#x7EED;&#x5F80;&#x524D;&#x770B;&#x6808;&#x4E0A;&#x5185;&#x5B58;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;0x7c02d88600: 0xb400007c13c24bd0 0x6f2ab3b40fa2f8ef</span><br><span class="line">0x7c02d88610: 0x0000007c02d88660 0x0000007c95de6510</span><br><span class="line">0x7c02d88620: 0x0000007c02d89000 0x6f2ab3b40fa2f8ef</span><br><span class="line">0x7c02d88630: 0x0000007c02d88670 0x0000007caae98c58</span><br><span class="line">0x7c02d88640: 0x0000007c02d886b0 0x0000007caae9ce40</span><br><span class="line">0x7c02d88650: 0x0000000000000005 0x6f2ab3b40fa2f8ef</span><br><span class="line">0x7c02d88660: 0x0000007c02d886a0 0x0000007caae98c58</span><br><span class="line">0x7c02d88670: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88680: 0x0000000000000415 0xb400007c13c246d0</span><br><span class="line">0x7c02d88690: 0x0000000071756549 0x0000000000000018</span><br><span class="line">0x7c02d886a0: 0x0000007c02d886c0 0x0000007c9dccfb74 operator new(unsigned long)</span><br><span class="line">0x7c02d886b0: 0x0000000000000018 0x0000007caae98c58</span><br><span class="line">0x7c02d886c0: 0x0000007c02d886f0 0x0000007c95de6754</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;0x7c02d886d0: 0xb400007c13c246d0 0x0000000001909705 /SP</span><br><span class="line">0x7c02d886e0: 0x0000007c02d88700 0x6f2ab3b40fa2f8ef</span><br><span class="line">&#x6B64;&#x5904;&#x662F; A &#x51FD;&#x6570;&#x7684;&#x6808;&#x3002;</span><br><span class="line">0x7c02d886f0: 0x0000007c02d88750 0x0000007ca133f8e0 // FP</span><br><span class="line">0x7c02d88700: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88710: 0x0000000000000415 0x0000000001909705</span><br><span class="line">0x7c02d88720: 0x0000000000000000 0x0000007c02d88808</span><br><span class="line"></span><br><span class="line">&#x5730;&#x5740; 0x7c02d886c0 &#x5B58;&#x653E;&#x7684;&#x5185;&#x5B58;&#x6B63;&#x597D;&#x6307;&#x5411; A &#x51FD;&#x6570; FP &#x5730;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x5F88;&#x53EF;&#x80FD;&#x662F; A &#x51FD;&#x6570;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x6808;</span><br><span class="line">&#x51FD;&#x6570;&#x6808;{x29&#xFF0C;x30} = {0x0000007c02d886f0&#xFF0C;0x0000007c95de6754}</span><br><span class="line"></span><br><span class="line">&#x6CE8;&#xFF1A;&#x4EE5;&#x4E0B;&#x5C06;&#x5B57;&#x7B26;&#x4E32;&quot;_ZN7android8AMessage9setTargetERKNS_2spIKNS_8AHandlerEEE&quot;&#x66F4;&#x66FF;&#x4E3A;&quot;android::AMessage::setTarget&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x0000007c95de6754-0x20,+0x40</span><br><span class="line">Dump of assembler code from 0x7c95de6734 to 0x7c95de6774:</span><br><span class="line">0x0000007c95de6734 &lt;android::AMessage::setTarget+44&gt;: cbz x21, 0x7c95de6880 &lt;android::AMessage::setTarget+376&gt;</span><br><span class="line">0x0000007c95de6738 &lt;android::AMessage::setTarget+48&gt;: mov x20, x1</span><br><span class="line">0x0000007c95de673c &lt;android::AMessage::setTarget+52&gt;: ldr x1, [x21]</span><br><span class="line">0x0000007c95de6740 &lt;android::AMessage::setTarget+56&gt;: mov x0, #0x2ddc // #11740</span><br><span class="line">0x0000007c95de6744 &lt;android::AMessage::setTarget+60&gt;: movk x0, #0x568e, lsl #16</span><br><span class="line">0x0000007c95de6748 &lt;android::AMessage::setTarget+64&gt;: movk x0, #0x8c5e, lsl #32</span><br><span class="line">0x0000007c95de674c &lt;android::AMessage::setTarget+68&gt;: movk x0, #0x7974, lsl #48</span><br><span class="line">0x0000007c95de6750 &lt;android::AMessage::setTarget+72&gt;: bl 0x7c95dfb370 &lt;__cfi_slowpath@plt&gt;</span><br><span class="line">0x0000007c95de6754 &lt;android::AMessage::setTarget+76&gt;: ldr w8, [x21, #16]</span><br><span class="line">0x0000007c95de6758 &lt;android::AMessage::setTarget+80&gt;: str w8, [x19, #20]</span><br><span class="line">0x0000007c95de675c &lt;android::AMessage::setTarget+84&gt;: ldr x21, [x20]</span><br><span class="line">0x0000007c95de6760 &lt;android::AMessage::setTarget+88&gt;: ldr x1, [x21]</span><br><span class="line">0x0000007c95de6764 &lt;android::AMessage::setTarget+92&gt;: mov x0, #0x2ddc // #11740</span><br><span class="line">0x0000007c95de6768 &lt;android::AMessage::setTarget+96&gt;: movk x0, #0x568e, lsl #16</span><br><span class="line">0x0000007c95de676c &lt;android::AMessage::setTarget+100&gt;: movk x0, #0x8c5e, lsl #32</span><br><span class="line">0x0000007c95de6770 &lt;android::AMessage::setTarget+104&gt;: movk x0, #0x7974, lsl #48</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) p _ZN7android8AMessage9setTargetERKNS_2spIKNS_8AHandlerEEE+72</span><br><span class="line">$64 = (void (*)(android::AMessage * const, const android::sp&lt;android::AHandler const&gt; &amp;)) 0x7c95de6750 &lt;android::AMessage::setTarget(android::sp&lt;android::AHandler const&gt; const&amp;)+72&gt;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;A&#x51FD;&#x6570;&#x4F1A;&#x662F;android::AMessage::setTarget&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x0000007c95de6708,+0x30</span><br><span class="line">Dump of assembler code from 0x7c95de6708 to 0x7c95de6738:</span><br><span class="line">0x0000007c95de6708 &lt;android::AMessage::setTarget+0&gt;: sub sp, sp, #0x60</span><br><span class="line">0x0000007c95de670c &lt;android::AMessage::setTarget+4&gt;: stp x29, x30, [sp, #32]</span><br><span class="line">0x0000007c95de6710 &lt;android::AMessage::setTarget+8&gt;: stp x24, x23, [sp, #48]</span><br><span class="line">0x0000007c95de6714 &lt;android::AMessage::setTarget+12&gt;: stp x22, x21, [sp, #64]</span><br><span class="line">0x0000007c95de6718 &lt;android::AMessage::setTarget+16&gt;: stp x20, x19, [sp, #80]</span><br><span class="line">0x0000007c95de671c &lt;android::AMessage::setTarget+20&gt;: add x29, sp, #0x20</span><br><span class="line">0x0000007c95de6720 &lt;android::AMessage::setTarget+24&gt;: mrs x23, tpidr_el0</span><br><span class="line">0x0000007c95de6724 &lt;android::AMessage::setTarget+28&gt;: ldr x8, [x23, #40]</span><br><span class="line">0x0000007c95de6728 &lt;android::AMessage::setTarget+32&gt;: stur x8, [x29, #-8]</span><br><span class="line">0x0000007c95de672c &lt;android::AMessage::setTarget+36&gt;: ldr x21, [x1]</span><br><span class="line">0x0000007c95de6730 &lt;android::AMessage::setTarget+40&gt;: mov x19, x0</span><br><span class="line">0x0000007c95de6734 &lt;android::AMessage::setTarget+44&gt;: cbz x21, 0x7c95de6880 &lt;android::AMessage::setTarget+376&gt;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x4ECE;&#x6C47;&#x7F16;&#x770B;&#x51FD;&#x6570;&#x6808;&#x6B63;&#x662F;0x60&#x4E0E;A&#x51FD;&#x6570;&#x7684;&#x6808;&#x76F8;&#x7B49;&#x3002;<br>&#x56DE;&#x53BB;&#x518D;&#x770B;&#x770B; AMessage::AMessage &#x7684;&#x6C47;&#x7F16;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5B83;&#x662F;&#x9000;&#x6808;&#x540E;&#x8DF3;&#x8F6C;&#x5230; android::AMessage::setTarget&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007c95de6700 &lt;+88&gt;: ldp x29, x30, [sp], #48</span><br><span class="line">0x0000007c95de6704 &lt;+92&gt;: b 0x7c95dfb950 &lt;_ZN7android8AMessage9setTargetERKNS_2spIKNS_8AHandlerEEE@plt&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;x0 79748c5e568e2ddc x1 0000007ca13c3618 x2 0000000000000000 x3 0000007ca1291000</span><br><span class="line">x4 0000000001909705 x5 0000000000000000 x6 0000007c02d88808 x7 b60625655bf0252f</span><br><span class="line">x8 0000000000000080 x9 0000007ca126fed7 x10 0000000000000006 x11 0000007bfd0a81fc</span><br><span class="line">x12 9ef8a95ca9649dbe x13 e44782d5ac38720e x14 0000007bfd0a8030 x15 0000001e56307b5c</span><br><span class="line">x16 0000007c95dfdb70 x17 0000007c9844f118 x18 0000007bfaa28000 x19 b400007c13c246d0</span><br><span class="line">x20 0000007c02d88730 x21 b400007c13c67c00 x22 0000000000000415 x23 0000007c02d89000</span><br><span class="line">x24 0000000000000002 x25 b400007c13c246d0 x26 b400007c13c67c00 x27 0000007c02d89000</span><br><span class="line">x28 0000007ca13c2c28 x29 0000007c02d886f0</span><br><span class="line">lr 0000007c02d886f0 sp 0000007c02d886d0 pc 0000007c02d886f0 pst 0000000080001000</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x518D;&#x56DE;&#x770B; setTarget &#x6C47;&#x7F16;&#x521A;&#x597D; x0=0x79748c5e568e2ddc&#xFF0C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007c95de6740 &lt;android::AMessage::setTarget+56&gt;: mov x0, #0x2ddc // #11740</span><br><span class="line">0x0000007c95de6744 &lt;android::AMessage::setTarget+60&gt;: movk x0, #0x568e, lsl #16</span><br><span class="line">0x0000007c95de6748 &lt;android::AMessage::setTarget+64&gt;: movk x0, #0x8c5e, lsl #32</span><br><span class="line">0x0000007c95de674c &lt;android::AMessage::setTarget+68&gt;: movk x0, #0x7974, lsl #48</span><br><span class="line">0x0000007c95de6750 &lt;android::AMessage::setTarget+72&gt;: bl 0x7c95dfb370 &lt;__cfi_slowpath@plt&gt;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;x16 = 0x0000007c95dfdb70&#x4E0E;x17= 0x0000007c9844f118 &#x4E5F;&#x6EE1;&#x8DB3;tombstone&#x4FE1;&#x606F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x7c95dfb370</span><br><span class="line">Dump of assembler code for function __cfi_slowpath@plt:</span><br><span class="line">0x0000007c95dfb370 &lt;+0&gt;: adrp x16, 0x7c95dfd000 &lt;__dso_handle_const&gt;</span><br><span class="line">0x0000007c95dfb374 &lt;+4&gt;: ldr x17, [x16, #2928]</span><br><span class="line">0x0000007c95dfb378 &lt;+8&gt;: add x16, x16, #0xb70</span><br><span class="line">0x0000007c95dfb37c &lt;+12&gt;: br x17</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) x /gx 0x7c95dfd000+0xb70</span><br><span class="line">0x7c95dfdb70 &lt;__cfi_slowpath@got.plt&gt;: 0x0000007c9844f118</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x0000007c9844f118</span><br><span class="line">Dump of assembler code for function __cfi_slowpath(uint64_t, void *):*</span><br><span class="line">0x0000007c9844f118 &lt;+0&gt;: stp x29, x30, [sp, #-16]!*</span><br><span class="line">0x0000007c9844f11c &lt;+4&gt;: mov x29, sp*</span><br><span class="line">0x0000007c9844f120 &lt;+8&gt;: lsr x8, x1, #17*</span><br><span class="line">0x0000007c9844f124 &lt;+12&gt;: and x8, x8, #0x7ffffffffe*</span><br><span class="line">0x0000007c9844f128 &lt;+16&gt;: mov w9, #0x80000000 // #-2147483648*</span><br><span class="line">0x0000007c9844f12c &lt;+20&gt;: cmp x8, x9*</span><br><span class="line">0x0000007c9844f130 &lt;+24&gt;: b.hi 0x7c9844f14c &lt;__cfi_slowpath(uint64_t, void*)+52&gt; // b.pmore</span><br><span class="line">0x0000007c9844f134 &lt;+28&gt;: adrp x9, 0x7c98452000 &lt;_ZL19shadow_base_storage&gt;</span><br><span class="line">0x0000007c9844f138 &lt;+32&gt;: ldr x9, [x9]</span><br><span class="line">0x0000007c9844f13c &lt;+36&gt;: ldrh w8, [x9, x8]</span><br><span class="line">0x0000007c9844f140 &lt;+40&gt;: cmp w8, #0x1</span><br><span class="line">0x0000007c9844f144 &lt;+44&gt;: b.eq 0x7c9844f15c &lt;__cfi_slowpath(uint64_t, void *)+68&gt; // b.none*</span><br><span class="line">0x0000007c9844f148 &lt;+48&gt;: cbnz w8, 0x7c9844f164 &lt;__cfi_slowpath(uint64_t, void*)+76&gt;</span><br><span class="line">0x0000007c9844f14c &lt;+52&gt;: xpaclri</span><br><span class="line">0x0000007c9844f150 &lt;+56&gt;: mov x2, xzr</span><br><span class="line">0x0000007c9844f154 &lt;+60&gt;: mov x3, x30</span><br><span class="line">0x0000007c9844f158 &lt;+64&gt;: bl 0x7c9844f2a0 &lt;__loader_cfi_fail@plt&gt;</span><br><span class="line">0x0000007c9844f15c &lt;+68&gt;: ldp x29, x30, [sp], #16</span><br><span class="line">0x0000007c9844f160 &lt;+72&gt;: ret</span><br><span class="line">0x0000007c9844f164 &lt;+76&gt;: and x9, x1, #0xfffffffffffc0000</span><br><span class="line">0x0000007c9844f168 &lt;+80&gt;: sub x8, x9, x8, lsl #12</span><br><span class="line">0x0000007c9844f16c &lt;+84&gt;: add x3, x8, #0x42, lsl #12</span><br><span class="line">0x0000007c9844f170 &lt;+88&gt;: mov x2, xzr</span><br><span class="line">0x0000007c9844f174 &lt;+92&gt;: ldp x29, x30, [sp], #16</span><br><span class="line">0x0000007c9844f178 &lt;+96&gt;: br x3</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">&#x56E0;&#x6B64; A &#x51FD;&#x6570;&#x7684;&#x6808;&#x662F; android::AMessage::setTarget(android::sp&lt;android::AHandler const&gt; const&amp;)</span><br></pre></td></tr></table></figure>

<h5 id="&#x8BA1;&#x7B97;&#x6C47;&#x7F16;&#x8D70;&#x5411;"><a href="#&#x8BA1;&#x7B97;&#x6C47;&#x7F16;&#x8D70;&#x5411;" class="headerlink" title="&#x8BA1;&#x7B97;&#x6C47;&#x7F16;&#x8D70;&#x5411;"></a>&#x8BA1;&#x7B97;&#x6C47;&#x7F16;&#x8D70;&#x5411;</h5><p>&#x2003;&#x2003;&#x6839;&#x636E; tombstone &#x6700;&#x540E;&#x7684;&#x6808;&#x5730;&#x5740; SP=0x0000007c02d886d0 &#x8BF4;&#x660E;&#x51FD;&#x6570; __cfi_slowpath(uint64_t, void <em>) &#x5DF2;&#x7ECF;&#x9000;&#x6808;&#x3002;</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;0x7c02d88620: 0x0000007c02d89000 0x6f2ab3b40fa2f8ef</span><br><span class="line">0x7c02d88630: 0x0000007c02d88670 0x0000007caae98c58</span><br><span class="line">0x7c02d88640: 0x0000007c02d886b0 0x0000007caae9ce40</span><br><span class="line">0x7c02d88650: 0x0000000000000005 0x6f2ab3b40fa2f8ef</span><br><span class="line">je_malloc</span><br><span class="line">0x7c02d88660: 0x0000007c02d886a0 0x0000007caae98c58</span><br><span class="line">0x7c02d88670: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88680: 0x0000000000000415 0xb400007c13c246d0</span><br><span class="line">0x7c02d88690: 0x0000000071756549 0x0000000000000018</span><br><span class="line"></span><br><span class="line">malloc(size_t)</span><br><span class="line">0x7c02d886a0: 0x0000007c02d886c0 0x0000007c9dccfb74 operator new(unsigned long)</span><br><span class="line">0x7c02d886b0: 0x0000000000000018 0x0000007caae98c58</span><br><span class="line"></span><br><span class="line">__cfi_slowpath(uint64_t, void*)</span><br><span class="line">0x7c02d886c0: 0x0000007c02d886f0 0x0000007c95de6754</span><br><span class="line">0x7c02d886d0: 0xb400007c13c246d0 0x0000000001909705</span><br><span class="line">0x7c02d886e0: 0x0000007c02d88700 0x6f2ab3b40fa2f8ef</span><br><span class="line"></span><br><span class="line">android::AMessage::setTarget(android::sp&lt;android::AHandler const&gt; const&amp;)</span><br><span class="line">0x7c02d886f0: 0x0000007c02d88750 0x0000007ca133f8e0</span><br><span class="line">0x7c02d88700: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88710: 0x0000000000000415 0x0000000001909705</span><br><span class="line">0x7c02d88720: 0x0000000000000000 0x0000007c02d88808</span><br><span class="line">0x7c02d88730: 0xb400007c13c67c00 0x0000000000000000</span><br><span class="line">0x7c02d88740: 0x0000007c02d89000 0x6f2ab3b40fa2f8ef</span><br><span class="line"></span><br><span class="line">android::MediaCodec::queueInputBuffer(unsigned long, unsigned long, unsigned long, long, unsigned int, android::AString*)</span><br><span class="line">0x7c02d88750: 0x0000007c02d88830 0x0000007ca796ee7c</span><br><span class="line">0x7c02d88760: 0x0000007ca79f3dd8 0x0000007ca79edb80</span><br><span class="line">0x7c02d88770: 0x0000007c02d89000 0xb400007c13c04680</span><br><span class="line">0x7c02d88780: 0x0000000000000000 0x0000000000000002</span><br><span class="line">0x7c02d88790: 0xb400007c13c67c00 0x0000000000000000</span><br><span class="line">0x7c02d887a0: 0x0000000000000000 0xb400007c13c7c100</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x5176;&#x4E2D;&#x6062;&#x590D;&#x5176;&#x8C03;&#x7528;&#x6808;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;backtrace:</span><br><span class="line">unknown&#xFF1F;</span><br><span class="line">android::AMessage::setTarget(android::sp&lt;android::AHandler const&gt; const&amp;)</span><br><span class="line">android::MediaCodec::queueInputBuffer(unsigned long, unsigned long, unsigned long, long, unsigned int, android::AString*)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;__cfi_slowpath&#x51FD;&#x6570;&#x6709;&#x4E24;&#x5904;&#x9000;&#x6808;&#x76F8;&#x5173;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#xFF1A;</span><br><span class="line">0x0000007c9844f14c &lt;+52&gt;: xpaclri</span><br><span class="line">0x0000007c9844f150 &lt;+56&gt;: mov x2, xzr</span><br><span class="line">0x0000007c9844f154 &lt;+60&gt;: mov x3, x30</span><br><span class="line">0x0000007c9844f158 &lt;+64&gt;: bl 0x7c9844f2a0 &lt;__loader_cfi_fail@plt&gt;</span><br><span class="line">0x0000007c9844f15c &lt;+68&gt;: ldp x29, x30, [sp], #16</span><br><span class="line">0x0000007c9844f160 &lt;+72&gt;: ret</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#xFF1A;</span><br><span class="line">0x0000007c9844f164 &lt;+76&gt;: and x9, x1, #0xfffffffffffc0000</span><br><span class="line">0x0000007c9844f168 &lt;+80&gt;: sub x8, x9, x8, lsl #12</span><br><span class="line">0x0000007c9844f16c &lt;+84&gt;: add x3, x8, #0x42, lsl #12</span><br><span class="line">0x0000007c9844f170 &lt;+88&gt;: mov x2, xzr</span><br><span class="line">0x0000007c9844f174 &lt;+92&gt;: ldp x29, x30, [sp], #16</span><br><span class="line">0x0000007c9844f178 &lt;+96&gt;: br x3</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x5982;&#x679C;&#x8D70;&#x7684;&#x662F;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#x9000;&#x6808;&#xFF0C;&#x90A3;&#x4E48; x16 &#x548C; x17 &#x5C06;&#x4E0E; tombstone &#x4E0D;&#x7B26;&#x5408;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x8D70;&#x7684;&#x662F;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#x3002;<br>&#x800C;&#x8FD9;&#x91CC;&#x4F1A;&#x8DF3;&#x8F6C;&#x81F3; x3&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#x5F53;&#x524D; tombstone &#x91CC; x3=0x0000007ca1291000 &#x662F;&#x5426;&#x4E3A;&#x4E00;&#x4E2A;&#x6709;&#x6548;&#x7684;&#x51FD;&#x6570;&#x5730;&#x5740;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) disassemble 0x0000007ca1291000,+0x40</span><br><span class="line">Dump of assembler code from 0x7ca1291000 to 0x7ca1291040:</span><br><span class="line">0x0000007ca1291000 &lt;__cfi_check+0&gt;: str x30, [sp, #-16]!</span><br><span class="line">0x0000007ca1291004 &lt;__cfi_check+4&gt;: mov x8, #0x48f1 // #18673</span><br><span class="line">0x0000007ca1291008 &lt;__cfi_check+8&gt;: movk x8, #0xd799, lsl #16</span><br><span class="line">0x0000007ca129100c &lt;__cfi_check+12&gt;: movk x8, #0xcf94, lsl #32</span><br><span class="line">0x0000007ca1291010 &lt;__cfi_check+16&gt;: movk x8, #0xfc57, lsl #48</span><br><span class="line">0x0000007ca1291014 &lt;__cfi_check+20&gt;: cmp x0, x8</span><br><span class="line">0x0000007ca1291018 &lt;__cfi_check+24&gt;: b.le 0x7ca1291100 &lt;__cfi_check+256&gt;</span><br><span class="line">0x0000007ca129101c &lt;__cfi_check+28&gt;: mov x8, #0xd5c9 // #54729</span><br><span class="line">0x0000007ca1291020 &lt;__cfi_check+32&gt;: movk x8, #0x5fef, lsl #16</span><br><span class="line">0x0000007ca1291024 &lt;__cfi_check+36&gt;: movk x8, #0x22f2, lsl #32</span><br><span class="line">0x0000007ca1291028 &lt;__cfi_check+40&gt;: movk x8, #0x4e31, lsl #48</span><br><span class="line">0x0000007ca129102c &lt;__cfi_check+44&gt;: cmp x0, x8</span><br><span class="line">0x0000007ca1291030 &lt;__cfi_check+48&gt;: b.gt 0x7ca12911f4 &lt;__cfi_check+500&gt;</span><br><span class="line">0x0000007ca1291034 &lt;__cfi_check+52&gt;: mov x8, #0x90ef // #37103</span><br><span class="line">0x0000007ca1291038 &lt;__cfi_check+56&gt;: movk x8, #0x3c9, lsl #16</span><br><span class="line">0x0000007ca129103c &lt;__cfi_check+60&gt;: movk x8, #0x8d30, lsl #32</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x975E;&#x5E38;&#x7684;&#x5927;&#xFF0C;&#x4F46;&#x6709;&#x89C4;&#x5F8B;&#xFF0C;&#x5F88;&#x663E;&#x7136;&#x5148;&#x5C06; x8&#x4E0E;x0 &#x4F5C;&#x6BD4;&#x8F83;&#xFF0C;&#x5E76;&#x4E14;&#x6570;&#x503C;&#x4E0E; tombstone &#x4E2D;<br>x0=0x79748c5e568e2ddc &#x7C7B;&#x4F3C;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x641C;&#x7D22;&#x90E8;&#x5206;&#x5173;&#x952E;&#x5B57;&#x627E;&#x5230;&#x76F8;&#x5E94;&#x7684; case&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007ca12920b4 &lt;+4276&gt;: mov x8, #0x2ddc // #11740</span><br><span class="line">0x0000007ca12920b8 &lt;+4280&gt;: movk x8, #0x568e, lsl #16</span><br><span class="line">0x0000007ca12920bc &lt;+4284&gt;: movk x8, #0x8c5e, lsl #32</span><br><span class="line">0x0000007ca12920c0 &lt;+4288&gt;: movk x8, #0x7974, lsl #48</span><br><span class="line">0x0000007ca12920c4 &lt;+4292&gt;: cmp x0, x8</span><br><span class="line">0x0000007ca12920c8 &lt;+4296&gt;: b.eq 0x7ca129576c &lt;__cfi_check+18284&gt; // b.none</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007ca129576c &lt;+18284&gt;: adrp x8, 0x7ca13c2000 &lt;_ZTVN7android17BufferChannelBaseE+24&gt;</span><br><span class="line">0x0000007ca1295770 &lt;+18288&gt;: add x8, x8, #0xc28</span><br><span class="line">0x0000007ca1295774 &lt;+18292&gt;: sub x8, x1, x8</span><br><span class="line">0x0000007ca1295778 &lt;+18296&gt;: sub x8, x8, #0x630</span><br><span class="line">0x0000007ca129577c &lt;+18300&gt;: ror x8, x8, #4</span><br><span class="line">0x0000007ca1295780 &lt;+18304&gt;: cmp x8, #0x5a</span><br><span class="line">0x0000007ca1295784 &lt;+18308&gt;: b.hi 0x7ca1296680 &lt;__cfi_check+22144&gt; // b.pmore</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;tombstone &#x4E2D; x9=0x0000007ca126fed7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007ca1295788 &lt;+18312&gt;: adrp x9, 0x7ca126f000 &lt;_ZL5__txt+844&gt;</span><br><span class="line">0x0000007ca129578c &lt;+18316&gt;: add x9, x9, #0xed7</span><br><span class="line">0x0000007ca1295790 &lt;+18320&gt;: b 0x7ca12963a4 &lt;__cfi_check+21412&gt;</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;tombstone &#x4E2D;x8=0x0000000000000080</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007ca12963a4 &lt;+21412&gt;: ldrb w8, [x9, x8]</span><br><span class="line">0x0000007ca12963a8 &lt;+21416&gt;: tbnz w8, #7, 0x7ca1296644 &lt;__cfi_check+22084&gt;</span><br><span class="line">0x0000007ca12963ac &lt;+21420&gt;: b 0x7ca1296680 &lt;__cfi_check+22144&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007ca1296644 &lt;+22084&gt;: ldr x30, [sp], #16</span><br><span class="line">0x0000007ca1296648 &lt;+22088&gt;: ret</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x6700;&#x540E;&#x5728;&#x6B64;&#x5904;&#x9000;&#x6808;&#x56DE;&#x5230; android::AMessage::setTarget &#xFF0C;&#x7136;&#x540E; PC=LR=0x0000007c02d886f0 &#x53D1;&#x751F;&#x6BB5;&#x9519;&#x8BEF;&#x3002;</p>
<h3 id="&#x7ED3;&#x8BBA;"><a href="#&#x7ED3;&#x8BBA;" class="headerlink" title="&#x7ED3;&#x8BBA;"></a>&#x7ED3;&#x8BBA;</h3><p>&#x2003;&#x2003;&#x4E0D;&#x96BE;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;&#x7EC6;&#x8282; 0x7c02d886c0 &#x5730;&#x5740;&#x4E0A;&#x5B58;&#x50A8;&#x7684;&#x5185;&#x5BB9;&#x662F;&#x6709;&#x95EE;&#x9898;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;__cfi_slowpath(uint64_t, void*)</span><br><span class="line">0x7c02d886c0: 0x0000007c02d886f0 0x0000007c95de6754</span><br><span class="line"></span><br><span class="line">0x7c02d886d0: 0xb400007c13c246d0 0x0000000001909705</span><br><span class="line">0x7c02d886e0: 0x0000007c02d88700 0x6f2ab3b40fa2f8ef</span><br><span class="line"></span><br><span class="line">android::AMessage::setTarget(android::sp&lt;android::AHandler const&gt; const&amp;)</span><br><span class="line">0x7c02d886f0: 0x0000007c02d88750 0x0000007ca133f8e0</span><br><span class="line">0x7c02d88700: 0x0000000000000002 0x0000000000000000</span><br><span class="line">0x7c02d88710: 0x0000000000000415 0x0000000001909705</span><br><span class="line">0x7c02d88720: 0x0000000000000000 0x0000007c02d88808</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;0x0000007c9844f118 &lt; __cfi_slowpath +0&gt;: stp x29, x30, [sp, #-16]!</span><br><span class="line">&#x538B;&#x6808;&#x5E94;&#x8BE5;&#x662F; 0x7c02d886c0: 0x0000007c02d886f0 0x0000007c95de6754</span><br><span class="line">0x0000007c9844f11c &lt; __cfi_slowpath +4&gt;: mov x29, sp</span><br><span class="line">...</span><br><span class="line">0x0000007c9844f174 &lt; __cfi_slowpath +92&gt;: ldp x29, x30, [sp], #16</span><br><span class="line">0x0000007c9844f178 &lt; __cfi_slowpath +96&gt;: br x3</span><br><span class="line">0x0000007ca1291000 &lt;__cfi_check+0&gt;: str x30, [sp, #-16]!</span><br><span class="line">&#x538B;&#x6808;&#x5E94;&#x8BE5;&#x662F; 0x7c02d886c0: 0x0000007c95de6754 0x0000007c95de6754</span><br><span class="line">...</span><br><span class="line">0x0000007ca1296644 &lt; __cfi_check +22084&gt;: ldr x30, [sp], #16</span><br><span class="line">0x0000007ca1296648 &lt; __cfi_check +22088&gt;: ret</span><br><span class="line"></span><br><span class="line">(gdb) p /t 0xf81f0ffe &#x3010;str x30, [sp, #-16]!&#x3011;</span><br><span class="line">$5 = 11111000000111110000111111111110</span><br><span class="line">(gdb) p /t 0xf81f0ffd &#x3010;str x29, [sp, #-16]!&#x3011;</span><br><span class="line">$6 = 11111000000111110000111111111101</span><br><span class="line"></span><br><span class="line">&#x56E0;&#x6B64;&#x80FD;&#x7B26;&#x5408; tombstone &#x4FE1;&#x606F;&#xFF0C;&#x53EA;&#x6709;&#x6B64;&#x5904;&#x6307;&#x4EE4;&#x5F02;&#x5E38;&#x5BFC;&#x81F4;&#x3002;</span><br></pre></td></tr></table></figure>

<h3 id="&#x9519;&#x8BEF;&#x6A21;&#x62DF;"><a href="#&#x9519;&#x8BEF;&#x6A21;&#x62DF;" class="headerlink" title="&#x9519;&#x8BEF;&#x6A21;&#x62DF;"></a>&#x9519;&#x8BEF;&#x6A21;&#x62DF;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;# ps -ef | grep &quot;medias&quot;</span><br><span class="line">media 1145 1 0 01:35:04 ? 00:00:06 mediaserver64</span><br><span class="line">mediacodec 1223 1 0 01:35:04 ? 00:00:01 media.swcodec oid.media.swcodec/bin/mediaswcodec</span><br><span class="line"></span><br><span class="line"># cat /proc/1145/maps | grep &quot;libstagefright.so&quot;</span><br><span class="line">7abb428000-7abb4a9000 r--p 00000000 fe:05 84399283 /system/lib64/libstagefright.so</span><br><span class="line">7abb4a9000-7abb5db000 r-xp 00081000 fe:05 84399283 /system/lib64/libstagefright.so</span><br><span class="line">7abb5db000-7abb5ea000 r--p 001b3000 fe:05 84399283 /system/lib64/libstagefright.so</span><br><span class="line">7abb5ea000-7abb5ec000 rw-p 001c1000 fe:05 84399283 /system/lib64/libstagefright.so</span><br><span class="line"></span><br><span class="line">PC=0x7abb428000+0x83000</span><br><span class="line">&#x4FEE;&#x6539;&#x673A;&#x5668;&#x7801;&#x6A21;&#x62DF;&#x62A5;&#x9519;&#x573A;&#x666F;&#x3002;</span><br><span class="line"># ./data/memory_get64 1145 0x7abb4ab000</span><br><span class="line">pid 1145, target 0x7abb4ab000</span><br><span class="line">0xd2891e28f81f0ffe</span><br><span class="line"></span><br><span class="line"># ./data/memory_set64 1145 0x7abb4ab000 0xd2891e28 0xf81f0ffd</span><br><span class="line">pid 1145, target 0x7abb4ab000, val 0xd2891e28f81f0ffd</span><br><span class="line"></span><br><span class="line">06-27 23:10:07.311 1145 1145 F libc : Fatal signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7fdc95f510 in tid 1145 (mediaserver64), pid 1145 (mediaserver64)</span><br><span class="line">06-27 23:10:07.579 27515 27515 F DEBUG : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">06-27 23:10:07.579 27515 27515 F DEBUG : Revision: &apos;0&apos;</span><br><span class="line">06-27 23:10:07.579 27515 27515 F DEBUG : ABI: &apos;arm64&apos;</span><br><span class="line">06-27 23:10:07.579 27515 27515 F DEBUG : Timestamp: 2022-06-27 23:10:07.361670464+0800</span><br><span class="line">06-27 23:10:07.579 27515 27515 F DEBUG : Process uptime: 0s</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : Cmdline: mediaserver64</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : pid: 1145, tid: 1145, name: mediaserver64 &gt;&gt;&gt; mediaserver64 &lt;&lt;&lt;</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : uid: 1013</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : tagged_addr_ctrl: 0000000000000001</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7fdc95f510</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x0 bf2d51af2cdcf7a8 x1 0000007abb5df510 x2 0000000000000000 x3 0000007abb4ab000</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x4 0065006300690076 x5 7600690063006500 x6 0065006300690076 x7 b400007ac2afd3c8</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x8 0000000000000003 x9 0000007abb489b40 x10 0000000000000002 x11 0000000000000001</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x12 0000000000000000 x13 0000007aac820058 x14 0000000000000010 x15 0000000000000010</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x16 0000007ab0cbd538 x17 0000007ac1210118 x18 0000007ac3726000 x19 0000007fdc95f5d0</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x20 b400007a26e03048 x21 0000007ac13b1b98 x22 0000007ab0cadc50 x23 0000007ac2d13000</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x24 0000007fdc95f470 x25 b400007ac2aea1c4 x26 0000000000000000 x27 0000000000000479</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : x28 0000000000000000 x29 0000007fdc95f510</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : lr 0000007fdc95f510 sp 0000007fdc95f440 pc 0000007fdc95f510 pst 0000000080001000</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : backtrace:</span><br><span class="line">06-27 23:10:07.580 27515 27515 F DEBUG : #00 pc 000000000001f510 [stack]</span><br></pre></td></tr></table></figure>

<h3 id="Coredump&#x5BC4;&#x5B58;&#x5668;&#x6062;&#x590D;&#x6808;"><a href="#Coredump&#x5BC4;&#x5B58;&#x5668;&#x6062;&#x590D;&#x6808;" class="headerlink" title="Coredump&#x5BC4;&#x5B58;&#x5668;&#x6062;&#x590D;&#x6808;"></a>Coredump&#x5BC4;&#x5B58;&#x5668;&#x6062;&#x590D;&#x6808;</h3><p>&#x2003;&#x2003;&#x901A;&#x8FC7;readelf&#x8BFB;&#x53D6;MINIDUMP&#x6587;&#x4EF6;&#xFF0C;&#x4FDD;&#x5B58;&#x5BC4;&#x5B58;&#x5668;&#x4E0A;&#x4E0B;&#x6587;&#x5728;ELF&#x6587;&#x4EF6;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x8282;&#x4E2D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python&#x590D;&#x5236;&#x4EE3;&#x7801;Program Headers:</span><br><span class="line">Type Offset VirtAddr PhysAddr</span><br><span class="line">FileSiz MemSiz Flags Align</span><br><span class="line">NOTE 0x000000000000fb28 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x00000000000032cc 0x0000000000000000 0x0</span><br><span class="line">LOAD 0x0000000000013000 0x0000005ffabc7000 0x0000000000000000</span><br><span class="line">0x0000000000001000 0x0000000000001000 R 0x0</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x7528;hexedit&#x5DE5;&#x5177;&#x6253;&#x5F00;MINIDUMP&#x6587;&#x4EF6;&#x627E;&#x5230;&#x5BC4;&#x5B58;&#x5668;&#x5730;&#x5740;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">erlang&#x590D;&#x5236;&#x4EE3;&#x7801;0000FB20 00 00 00 00 00 00 00 00 05 00 00 00 88 01 00 00 ................</span><br><span class="line">0000FB30 01 00 00 00 43 4F 52 45 00 00 00 00 00 00 00 00 ....CORE........</span><br><span class="line">0000FB40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</span><br><span class="line">0000FB50 00 00 00 00 00 00 00 00 00 00 00 00 CD 2E 00 00 ................</span><br><span class="line">0000FB60 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 ................</span><br><span class="line">0000FB70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</span><br><span class="line">0000FB80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</span><br><span class="line">0000FB90 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</span><br><span class="line">0000FBA0 00 00 00 00 00 00 00 00 00 00 00 00 DC 2D 8E 56 .............-.V</span><br><span class="line">0000FBB0 5E 8C 74 79 18 36 3C A1 7C 00 00 00 00 00 00 00 ^.ty.6&lt;.|.......</span><br><span class="line">0000FBC0 00 00 00 00 00 10 29 A1 7C 00 00 00 05 97 90 01 ......).|.......</span><br><span class="line">0000FBD0 00 00 00 00 00 00 00 00 00 00 00 00 08 88 D8 02 ................</span><br><span class="line">0000FBE0 7C 00 00 00 2F 25 F0 5B 65 25 06 B6 80 00 00 00 |.../%.[e%......</span><br><span class="line">0000FBF0 00 00 00 00 D7 FE 26 A1 7C 00 00 00 06 00 00 00 ......&amp;.|.......</span><br><span class="line">0000FC00 00 00 00 00 FC 81 0A FD 7B 00 00 00 BE 9D 64 A9 ........{.....d.</span><br><span class="line">0000FC10 5C A9 F8 9E 0E 72 38 AC D5 82 47 E4 30 80 0A FD \....r8...G.0...</span><br><span class="line">0000FC20 7B 00 00 00 5C 7B 30 56 1E 00 00 00 70 DB DF 95 {...\{0V....p...</span><br><span class="line">0000FC30 7C 00 00 00 18 F1 44 98 7C 00 00 00 00 80 A2 FA |.....D.|.......</span><br><span class="line">0000FC40 7B 00 00 00 D0 46 C2 13 7C 00 00 B4 30 87 D8 02 {....F..|...0...</span><br><span class="line">0000FC50 7C 00 00 00 00 7C C6 13 7C 00 00 B4 15 04 00 00 |....|..|.......</span><br><span class="line">0000FC60 00 00 00 00 00 90 D8 02 7C 00 00 00 02 00 00 00 ........|.......</span><br><span class="line">0000FC70 00 00 00 00 D0 46 C2 13 7C 00 00 B4 00 7C C6 13 .....F..|....|..</span><br><span class="line">0000FC80 7C 00 00 B4 00 90 D8 02 7C 00 00 00 28 2C 3C A1 |.......|...(,&lt;.</span><br><span class="line">0000FC90 7C 00 00 00 F0 86 D8 02 7C 00 00 00 F0 86 D8 02 |.......|...Tg..</span><br><span class="line">0000FCA0 7C 00 00 00 D0 86 D8 02 7C 00 00 00 F0 86 D8 02 |.......|...Tg..</span><br><span class="line">0000FCB0 7C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |...............</span><br><span class="line">0000FCC0 00 00 00 00 05 00 00 00 88 00 00 00 03 00 00 00 ................</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x4E0A;&#x56FE;&#x7EFF;&#x8272;&#x4E3A;LR&#x548C;PC&#xFF0C;&#x5C06;&#x5B83;&#x4EEC;&#x4FEE;&#x6539;&#x4E3A;&#x6B63;&#x786E;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;<em>0x0000007c95de6754</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">erlang&#x590D;&#x5236;&#x4EE3;&#x7801;0000FC90 7C 00 00 00 F0 86 D8 02 7C 00 00 00 54 67 DE 95 |.......|...Tg..</span><br><span class="line">0000FCA0 7C 00 00 00 D0 86 D8 02 7C 00 00 00 54 67 DE 95 |.......|...Tg..</span><br><span class="line">0000FCB0 7C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |...............</span><br></pre></td></tr></table></figure>

<p>&#x2003;&#x2003;&#x91CD;&#x65B0;&#x5C06;&#x6062;&#x590D;&#x540E;&#x7684;MINIDUMP&#x88C5;&#x8F7D;&#x5230;gdb&#x4E0A;&#x5373;&#x53EF;&#x6062;&#x590D;callstack&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;(gdb) bt</span><br><span class="line">#0 android::AHandler::id (this=0xb400007c13c67c00)</span><br><span class="line">#1 android::AMessage::setTarget (this=0xb400007c13c246d0, handler=...)</span><br><span class="line">#2 0x0000007ca133f8e0 in android::MediaCodec::queueInputBuffer (this=0xb400007c13c67c00, index=2, offset=0, size=1045, presentationTimeUs=26253061, flags=0, errorDetailMsg=0x7c02d88808)</span><br><span class="line">#3 0x0000007ca796ee7c in android::NuPlayer::Decoder::onInputBufferFetched (this=0xb400007c13c7c100, msg=...)</span><br><span class="line">#4 0x0000007ca796c984 in android::NuPlayer::Decoder::doRequestBuffers (this=0xb400007c13c7c100)</span><br><span class="line">#5 0x0000007ca7963d48 in android::NuPlayer::DecoderBase::onRequestInputBuffers (this=0xb400007c13c7c100)</span><br><span class="line">#6 0x0000007ca79717bc in android::NuPlayer::Decoder::handleAnInputBuffer (this=0xb400007c13c7c100, index=2)</span><br><span class="line">#7 0x0000007ca7969328 in android::NuPlayer::Decoder::onMessageReceived (this=0xb400007c13c7c100, msg=...)</span><br><span class="line">#8 0x0000007c95de2874 in android::AHandler::deliverMessage (this=0xb400007c13c7c100, msg=...)</span><br><span class="line">#9 0x0000007c95de8608 in android::AMessage::deliver (this=0xb400007c13c24c70)</span><br><span class="line">#10 0x0000007c95de3bbc in android::ALooper::loop (this=&lt;optimized out&gt;)</span><br><span class="line">#11 0x0000007ca105907c in android::Thread::_threadLoop (user=user@entry=0xb400007cadca8fc0)</span><br><span class="line">#12 0x0000007ca105886c in thread_data_t::trampoline (t=&lt;optimized out&gt;)</span><br><span class="line">#13 0x0000007caaf3be74 in __pthread_start (arg=0x7c02d88cb0)</span><br><span class="line">#14 0x0000007caaedb830 in __start_thread (fn=0x7caaf3bda4 &lt;__pthread_start(void*)&gt;, arg=0x7c02d88cb0)</span><br></pre></td></tr></table></figure>

<p>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/a725b4106aa5f3de5715a91d3abc222a.html" target="blank" rel="noopener">mp.weixin.qq.com/s/YDhqP_ZkS&#x2026;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/997bf9b0633c498f03e2d8a5792a9591.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237001554083266617.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237001554083266617.html" itemprop="url">JYM 设计模式系列-工厂模式，让你的代码更优雅！！！ 概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-25T16:13:31+08:00">
                2023-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x89C9;&#x5F97;&#x4E0D;&#x9519;&#x8BF7;&#x6309;&#x4E0B;&#x56FE;&#x64CD;&#x4F5C;&#xFF0C;&#x6398;&#x53CB;&#x4EEC;&#xFF0C;&#x54C8;&#x54C8;&#x54C8;&#xFF01;&#xFF01;&#xFF01;<br><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/65778c41bc60c72d236c320e8d0f067c99f567e785167c96bbb39732a5310da4" alt="image.png"></p>
<h1 id="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"><a href="#&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;" class="headerlink" title="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"></a>&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;</h1><p>&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x7C7B;&#xFF1A;</p>
<ul>
<li><strong>&#x521B;&#x5EFA;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E94;&#x79CD;&#xFF1A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E03;&#x79CD;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x3001;&#x5916;&#x89C2;&#x6A21;&#x5F0F;&#x3001;&#x6865;&#x63A5;&#x6A21;&#x5F0F;&#x3001;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;&#x3001;&#x4EAB;&#x5143;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x5341;&#x4E00;&#x79CD;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x3001;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x8FED;&#x4EE3;&#x5B50;&#x6A21;&#x5F0F;&#x3001;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3001;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x3001;&#x5907;&#x5FD8;&#x5F55;&#x6A21;&#x5F0F;&#x3001;&#x72B6;&#x6001;&#x6A21;&#x5F0F;&#x3001;&#x8BBF;&#x95EE;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x4E2D;&#x4ECB;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x89E3;&#x91CA;&#x5668;&#x6A21;&#x5F0F;&#x3002;</strong></li>
</ul>
<h1 id="&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;"><a href="#&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;" class="headerlink" title="&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;"></a>&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;</h1><p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</p>
<h2 id="1-&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"><a href="#1-&#x5DE5;&#x5382;&#x6A21;&#x5F0F;" class="headerlink" title="1. &#x5DE5;&#x5382;&#x6A21;&#x5F0F;"></a><strong>1. &#x5DE5;&#x5382;&#x6A21;&#x5F0F;</strong></h2><h3 id="1-1-&#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"><a href="#1-1-&#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;" class="headerlink" title="1.1 &#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"></a><strong>1.1 &#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;</strong></h3><p>Factory&#x662F;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x5E76;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x4FBF;&#x9690;&#x85CF;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#x5E76;&#x4F7F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x4E13;&#x6CE8;&#x4E8E;&#x4F7F;&#x7528;&#x800C;&#x4E0D;&#x662F;&#x5BF9;&#x8C61;&#x521D;&#x59CB;&#x5316;&#x548C;&#x7BA1;&#x7406;&#x3002;</p>
<p>&#x4E8C;&#x8BDD;&#x4E0D;&#x8BF4;&#x4E0A;&#x4E00;&#x4E2A;demo&#xFF1A;&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x901A;&#x8FC7;&#x5236;&#x9020;&#x786C;&#x5E01;&#x4E1A;&#x52A1;&#x8BB2;&#x89E3;&#x3002;CoinFactory&#x662F;&#x5DE5;&#x5382;&#x7C7B;&#xFF0C;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x786C;&#x5E01;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/7e7ed54b1c8a7bdb3cc8317a264830ff9450e362c0e6d8dc8f62e6f257ec28af" alt="image.png"></p>
<p>Coin &#x63A5;&#x53E3;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Coin {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Coin&#x5DE5;&#x5382;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class CoinFactory {</span><br><span class="line"></span><br><span class="line">      /**</span><br><span class="line">       *  &#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5C06;&#x786C;&#x5E01;&#x7C7B;&#x578B;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x7C7B;</span><br><span class="line">       */</span><br><span class="line">      public static Coin getCoin(CoinType type) {</span><br><span class="line">        return type.getConstructor().get();</span><br><span class="line">      }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x786C;&#x5E01;&#x7684;&#x679A;&#x4E3E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public enum CoinType {</span><br><span class="line"></span><br><span class="line">  COPPER(CopperCoin::new),</span><br><span class="line">  GOLD(GoldCoin::new);</span><br><span class="line"></span><br><span class="line">  private final Supplier&lt;Coin&gt; constructor;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x94DC;&#x786C;&#x5E01;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class CopperCoin implements Coin {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is a copper coin.&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x91D1;&#x786C;&#x5E01;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class GoldCoin implements Coin {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is a gold coin.&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;Factory&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;<br>&#x521B;&#x5EFA;&#x5E76;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x4FBF;&#x9690;&#x85CF;&#x5B9E;&#x73B0;&#x903B;&#x8F91;<br>&#x5E76;&#x4F7F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x4E13;&#x6CE8;&#x4E8E;&#x4F7F;&#x7528;&#x800C;&#x4E0D;&#x662F;&#x5BF9;&#x8C61;&#x521D;&#x59CB;&#x5316;&#x548C;&#x7BA1;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program main entry point.</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    LOGGER.info(&quot;The alchemist begins his work.&quot;);</span><br><span class="line">    var coin1 = CoinFactory.getCoin(CoinType.COPPER);</span><br><span class="line">    var coin2 = CoinFactory.getCoin(CoinType.GOLD);</span><br><span class="line">    LOGGER.info(coin1.getDescription());</span><br><span class="line">    LOGGER.info(coin2.getDescription());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x70BC;&#x91D1;&#x672F;&#x58EB;&#x5236;&#x9020;&#x786C;&#x5E01;&#x3002;CoinFactory&#x662F;&#x5DE5;&#x5382;&#x7C7B;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x786C;&#x5E01;&#x3002;</strong></p>
<h3 id="1-2-&#x5DE5;&#x5382;&#x65B9;&#x6CD5;"><a href="#1-2-&#x5DE5;&#x5382;&#x65B9;&#x6CD5;" class="headerlink" title="1.2 &#x5DE5;&#x5382;&#x65B9;&#x6CD5;"></a>1.2 &#x5DE5;&#x5382;&#x65B9;&#x6CD5;</h3><p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#xFF08;FACTORY METHOD&#xFF09;&#x662F;&#x4E00;&#x79CD;&#x5E38;&#x7528;&#x7684;&#x7C7B;&#x521B;&#x5EFA;&#x578B;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;,&#x6B64;&#x6A21;&#x5F0F;&#x7684;&#x6838;&#x5FC3;&#x7CBE;&#x795E;&#x662F;&#x5C01;&#x88C5;&#x7C7B;&#x4E2D;&#x53D8;&#x5316;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x63D0;&#x53D6;&#x5176;&#x4E2D;&#x4E2A;&#x6027;&#x5316;&#x5584;&#x53D8;&#x7684;&#x90E8;&#x5206;&#x4E3A;&#x72EC;&#x7ACB;&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x4EE5;&#x8FBE;&#x5230;&#x89E3;&#x8026;&#x3001;&#x590D;&#x7528;&#x548C;&#x65B9;&#x4FBF;&#x540E;&#x671F;&#x7EF4;&#x62A4;&#x62D3;&#x5C55;&#x7684;&#x76EE;&#x7684;&#x3002;&#x5B83;&#x7684;&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x6709;&#x56DB;&#x4E2A;&#x89D2;&#x8272;&#xFF0C;&#x5206;&#x522B;&#x662F;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#xFF1B;&#x5177;&#x4F53;&#x5DE5;&#x5382;&#xFF1B;&#x62BD;&#x8C61;&#x4EA7;&#x54C1;&#xFF1B;&#x5177;&#x4F53;&#x4EA7;&#x54C1;&#x3002;</p>
<p><strong>&#x9002;&#x7528;&#x573A;&#x666F;</strong></p>
<p>&#x5982;&#x679C;&#x65E0;&#x6CD5;&#x9884;&#x77E5;&#x5BF9;&#x8C61;&#x786E;&#x5207;&#x7C7B;&#x522B;&#x53CA;&#x5176;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x65F6;&#xFF0C;&#x53EF;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x3002;<br>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5C06;&#x521B;&#x5EFA;&#x4EA7;&#x54C1;&#x7684;&#x4EE3;&#x7801;&#x4E0E;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x4EA7;&#x54C1;&#x7684;&#x4EE3;&#x7801;&#x5206;&#x79BB;&#xFF0C; &#x4ECE;&#x800C;&#x80FD;&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x4EE3;&#x7801;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x6269;&#x5C55;&#x4EA7;&#x54C1;&#x521B;&#x5EFA;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x3002;<br>&#x4F8B;&#x5982;&#xFF0C; &#x5982;&#x679C;&#x9700;&#x8981;&#x5411;&#x5E94;&#x7528;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x79CD;&#x65B0;&#x4EA7;&#x54C1;&#xFF0C; &#x4F60;&#x53EA;&#x9700;&#x8981;&#x5F00;&#x53D1;&#x65B0;&#x7684;&#x521B;&#x5EFA;&#x8005;&#x5B50;&#x7C7B;&#xFF0C; &#x7136;&#x540E;&#x91CD;&#x5199;&#x5176;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#x3002;</p>
<p><strong>&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;</strong></p>
<ol>
<li>&#x8BA9;&#x6240;&#x6709;&#x4EA7;&#x54C1;&#x90FD;&#x9075;&#x5FAA;&#x540C;&#x4E00;&#x63A5;&#x53E3;&#x3002;&#x8BE5;&#x63A5;&#x53E3;&#x5FC5;&#x987B;&#x58F0;&#x660E;&#x5BF9;&#x6240;&#x6709;&#x4EA7;&#x54C1;&#x90FD;&#x6709;&#x610F;&#x4E49;&#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
<li>&#x5728;&#x521B;&#x5EFA;&#x7C7B;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x3002;&#x8BE5;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x9075;&#x5FAA;&#x901A;&#x7528;&#x7684;&#x4EA7;&#x54C1;&#x63A5;&#x53E3;&#x3002;</li>
</ol>
<p><strong>&#x4EE5;&#x4E0D;&#x540C;&#x79CD;&#x7C7B;&#x7684;&#x94C1;&#x5320;&#x94F8;&#x9020;&#x6B66;&#x5668;&#x4E3A;demo&#xFF1A;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/46584c613158a066d4458f83fd54086c7537c84b527d53e89be24b578569ab1a" alt="image.png"></p>
<p>Blacksmith &#x94C1;&#x5320; &#x5305;&#x542B;&#x7528;&#x4E8E;&#x751F;&#x6210;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;&#x7684;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Blacksmith {</span><br><span class="line"></span><br><span class="line">  Weapon manufactureWeapon(WeaponType weaponType);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>WeaponType&#xFF1A;&#x6B66;&#x5668;&#x7C7B;&#x578B;&#x679A;&#x4E3E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line"> * WeaponType enumeration.</span><br><span class="line"> */</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public enum WeaponType {</span><br><span class="line"></span><br><span class="line">  SHORT_SWORD(&quot;short sword&quot;),</span><br><span class="line">  SPEAR(&quot;spear&quot;),</span><br><span class="line">  AXE(&quot;axe&quot;),</span><br><span class="line">  UNDEFINED(&quot;&quot;);</span><br><span class="line"></span><br><span class="line">  private final String title;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return title;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Weapon &#x6B66;&#x5668;&#x7C7B;&#x578B;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line"> * Weapon interface.</span><br><span class="line"> */</span><br><span class="line">public interface Weapon {</span><br><span class="line"></span><br><span class="line">  WeaponType getWeaponType();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7CBE;&#x7075;&#x94C1;&#x5320;&#xFF1A;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x5BF9;&#x8C61;&#x7684;&#x5177;&#x4F53;&#x5B50;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfBlacksmith implements Blacksmith {</span><br><span class="line"></span><br><span class="line">  private static final Map&lt;WeaponType, ElfWeapon&gt; ELFARSENAL;</span><br><span class="line"></span><br><span class="line">  static {</span><br><span class="line">    ELFARSENAL = new EnumMap&lt;&gt;(WeaponType.class);</span><br><span class="line">    Arrays.stream(WeaponType.values()).forEach(type -&gt; ELFARSENAL.put(type, new ElfWeapon(type)));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Weapon manufactureWeapon(WeaponType weaponType) {</span><br><span class="line">    return ELFARSENAL.get(weaponType);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;The elf blacksmith&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Elf Weapon &#x6B66;&#x5668;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public class ElfWeapon implements Weapon {</span><br><span class="line"></span><br><span class="line">  private final WeaponType weaponType;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;an elven &quot; + weaponType;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x94C1;&#x5320;&#xFF1A;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x5BF9;&#x8C61;&#x7684;&#x5177;&#x4F53;&#x5B50;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcBlacksmith implements Blacksmith {</span><br><span class="line"></span><br><span class="line">  private static final Map&lt;WeaponType, OrcWeapon&gt; ORCARSENAL;</span><br><span class="line"></span><br><span class="line">  static {</span><br><span class="line">    ORCARSENAL = new EnumMap&lt;&gt;(WeaponType.class);</span><br><span class="line">    Arrays.stream(WeaponType.values()).forEach(type -&gt; ORCARSENAL.put(type, new OrcWeapon(type)));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Weapon manufactureWeapon(WeaponType weaponType) {</span><br><span class="line">    return ORCARSENAL.get(weaponType);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;The orc blacksmith&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcWeapon &#x6B66;&#x5668;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public class OrcWeapon implements Weapon {</span><br><span class="line"></span><br><span class="line">  private final WeaponType weaponType;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;an orcish &quot; + weaponType;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line"> private static final String MANUFACTURED = &quot;{} manufactured {}&quot;;</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">  * Program entry point.</span><br><span class="line">  * @param args command line args</span><br><span class="line">  */</span><br><span class="line"> public static void main(String[] args) {</span><br><span class="line"></span><br><span class="line">   Blacksmith blacksmith = new OrcBlacksmith();</span><br><span class="line">   Weapon weapon = blacksmith.manufactureWeapon(WeaponType.SPEAR);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.AXE);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line"></span><br><span class="line">   blacksmith = new ElfBlacksmith();</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.SPEAR);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.AXE);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x79CD;&#x521B;&#x9020;&#x6027;&#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6765;&#x5904;&#x7406;<br>&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x65F6;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x8981;&#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x786E;&#x5207;&#x7C7B;&#x7684;&#x95EE;&#x9898;&#x3002;<br>&#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x5728;&#x63A5;&#x53E3;&#x4E2D;&#x6307;&#x5B9A;&#x7684;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x6765;&#x5B8C;&#x6210;&#x7684;<br>&#x5E76;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;&#xFF0C;&#x6216;&#x5728;&#x57FA;&#x7C7B;&#x4E2D;&#x5B9E;&#x73B0;&#x5E76;&#x53EF;&#x9009;&#x5730;&#x88AB;&#x8986;&#x76D6;<br>&#x6D3E;&#x751F;&#x7C7B;&#x2014;&#x2014;&#x800C;&#x4E0D;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x63A5;&#x53E3; Blacksmith &#x548C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<br>&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#xFF08;manufactureWeapon&#xFF09;&#x3002; &#x5177;&#x4F53;&#x7684;&#x5B50;&#x7C7B;&#xFF08;<br>OrcBlacksmith, ElfBlacksmith) &#x7136;&#x540E;&#x8986;&#x76D6;&#x8BE5;&#x65B9;&#x6CD5;&#x4EE5;&#x751F;&#x6210;&#x4ED6;&#x4EEC;&#x559C;&#x6B22;&#x7684;&#x5BF9;&#x8C61;</p>
<h3 id="1-3-&#x62BD;&#x8C61;&#x5DE5;&#x5382;"><a href="#1-3-&#x62BD;&#x8C61;&#x5DE5;&#x5382;" class="headerlink" title="1.3 &#x62BD;&#x8C61;&#x5DE5;&#x5382;"></a>1.3 &#x62BD;&#x8C61;&#x5DE5;&#x5382;</h3><p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#xFF08;AbstractFactory&#xFF09;&#x6A21;&#x5F0F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x5C01;&#x88C5;&#x4E00;&#x7EC4;&#x72EC;&#x7ACB;&#x5DE5;&#x5382;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x4E00;&#x4E2A;&#x5171;&#x540C;&#x7684;&#x76EE;&#x6807;&#xFF0C;&#x800C;&#x4E0D;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x3002;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8F6F;&#x4EF6;&#x521B;&#x5EFA;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x6CDB;&#x578B;&#x63A5;&#x53E3;&#xFF0C;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x4F5C;&#x4E3A;&#x4E3B;&#x9898;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x77E5;&#x9053;(&#x6216;&#x4E0D;&#x5173;&#x5FC3;)&#x5B83;&#x4ECE;&#x6BCF;&#x4E2A;&#x5185;&#x90E8;&#x5DE5;&#x5382;&#x83B7;&#x5F97;&#x54EA;&#x4E9B;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x53EA;&#x4F7F;&#x7528;&#x4ED6;&#x4EEC;&#x4EA7;&#x54C1;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x5C06;&#x7EC6;&#x8282;&#x5206;&#x5F00;&#x4E00;&#x7EC4;&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;&#x4ECE;&#x5B83;&#x4EEC;&#x7684;&#x4E00;&#x822C;&#x7528;&#x6CD5;&#x548C;&#x4F9D;&#x8D56;&#x4E8E;&#x5BF9;&#x8C61;&#x7EC4;&#x5408;&#xFF0C;&#x56E0;&#x4E3A;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x662F;&#x5728;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#x4E2D;&#x516C;&#x5F00;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x7684;&#x672C;&#x8D28;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x63A5;&#x53E3; &#xFF08;KingdomFactory&#xFF09;&#x53CA;&#x5176;&#x5B9E;&#x73B0;ElfKingdomFactory&#xFF0C;OrcKingdomFactory&#x3002;&#x8BE5;&#x793A;&#x4F8B;&#x4F7F;&#x7528;&#x521B;&#x5EFA;&#x56FD;&#x738B;&#x3001;&#x57CE;&#x5821;&#x548C;&#x519B;&#x961F;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/92e548ac9e34a4c981af868dece00e371321a4c09cf730524da03d1b037c592b" alt="image.png"></p>
<p>King &#x56FD;&#x738B;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface King {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Army &#x519B;&#x961F;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Army {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Castle&#xFF1A;&#x57CE;&#x5821;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Castle {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>KingdomFactory&#xFF1A;&#x738B;&#x56FD;&#x5DE5;&#x5382;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface KingdomFactory {</span><br><span class="line"></span><br><span class="line">  Castle createCastle();</span><br><span class="line"></span><br><span class="line">  King createKing();</span><br><span class="line"></span><br><span class="line">  Army createArmy();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5E2E;&#x52A9;KingdomFactory &#x751F;&#x4EA7; bean&#x7684;&#x7C7B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Getter</span><br><span class="line">@Setter</span><br><span class="line">public class Kingdom {</span><br><span class="line"></span><br><span class="line">  private King king;</span><br><span class="line">  private Castle castle;</span><br><span class="line">  private Army army;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * The factory of kingdom factories.</span><br><span class="line">   */</span><br><span class="line">  public static class FactoryMaker {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Enumeration for the different types of Kingdoms.</span><br><span class="line">     */</span><br><span class="line">    public enum KingdomType {</span><br><span class="line">      ELF, ORC</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The factory method to create KingdomFactory concrete objects.</span><br><span class="line">     */</span><br><span class="line">    public static KingdomFactory makeFactory(KingdomType type) {</span><br><span class="line">      return switch (type) {</span><br><span class="line">        case ELF -&gt; new ElfKingdomFactory();</span><br><span class="line">        case ORC -&gt; new OrcKingdomFactory();</span><br><span class="line">        default -&gt; throw new IllegalArgumentException(&quot;KingdomType not supported.&quot;);</span><br><span class="line">      };</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfArmy &#xFF1A;&#x7CBE;&#x7075;&#x7684;&#x519B;&#x961F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfArmy implements Army {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven army!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfCastle&#xFF1A;&#x7CBE;&#x7075;&#x57CE;&#x5821;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfCastle implements Castle {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven castle!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfKing &#x7CBE;&#x7075;&#x56FD;&#x738B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfKing implements King {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven king!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7CBE;&#x7075;&#x56FD;&#x5DE5;&#x5382;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfKingdomFactory implements KingdomFactory {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Castle createCastle() {</span><br><span class="line">    return new ElfCastle();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public King createKing() {</span><br><span class="line">    return new ElfKing();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Army createArmy() {</span><br><span class="line">    return new ElfArmy();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x519B;&#x961F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcArmy implements Army {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc army!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x57CE;&#x5821;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcCastle implements Castle {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc castle!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x56FD;&#x738B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcKing implements King {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc king!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x738B;&#x56FD;&#x5DE5;&#x5382;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcKingdomFactory implements KingdomFactory {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Castle createCastle() {</span><br><span class="line">    return new OrcCastle();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public King createKing() {</span><br><span class="line">    return new OrcKing();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Army createArmy() {</span><br><span class="line">    return new OrcArmy();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App implements Runnable {</span><br><span class="line"></span><br><span class="line">  private final Kingdom kingdom = new Kingdom();</span><br><span class="line"></span><br><span class="line">  public Kingdom getKingdom() {</span><br><span class="line">    return kingdom;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    var app = new App();</span><br><span class="line">    app.run();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void run() {</span><br><span class="line">    LOGGER.info(&quot;elf kingdom&quot;);</span><br><span class="line">    createKingdom(Kingdom.FactoryMaker.KingdomType.ELF);</span><br><span class="line">    LOGGER.info(kingdom.getArmy().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getCastle().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getKing().getDescription());</span><br><span class="line"></span><br><span class="line">    LOGGER.info(&quot;orc kingdom&quot;);</span><br><span class="line">    createKingdom(Kingdom.FactoryMaker.KingdomType.ORC);</span><br><span class="line">    LOGGER.info(kingdom.getArmy().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getCastle().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getKing().getDescription());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates kingdom.</span><br><span class="line">   * @param kingdomType type of Kingdom</span><br><span class="line">   */</span><br><span class="line">  public void createKingdom(final Kingdom.FactoryMaker.KingdomType kingdomType) {</span><br><span class="line">    final KingdomFactory kingdomFactory = Kingdom.FactoryMaker.makeFactory(kingdomType);</span><br><span class="line">    kingdom.setKing(kingdomFactory.createKing());</span><br><span class="line">    kingdom.setCastle(kingdomFactory.createCastle());</span><br><span class="line">    kingdom.setArmy(kingdomFactory.createArmy());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x5C01;&#x88C5;&#x4E00;&#x7EC4;&#x5177;&#x6709;&#x5171;&#x540C;&#x4E3B;&#x9898;&#x7684;&#x72EC;&#x7ACB;&#x5DE5;&#x5382;&#xFF0C;&#x800C;&#x65E0;&#x9700;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x3002;&#x5728;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8F6F;&#x4EF6;&#x521B;&#x5EFA;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x521B;&#x5EFA;&#x4F5C;&#x4E3A;&#x4E3B;&#x9898;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x5BA2;&#x6237;&#x4E0D;&#x77E5;&#x9053;&#xFF08;&#x6216;&#x4E0D;&#x5173;&#x5FC3;&#xFF09;&#x5B83;&#x4ECE;&#x8FD9;&#x4E9B;&#x5185;&#x90E8;&#x5DE5;&#x5382;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x83B7;&#x5F97;&#x4E86;&#x54EA;&#x4E9B;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C; &#x56E0;&#x4E3A;&#x5B83;&#x53EA;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x4EA7;&#x54C1;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x5C06;&#x4E00;&#x7EC4;&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#x4E0E;&#x5B83;&#x4EEC;&#x7684;&#x4E00;&#x822C;&#x7528;&#x6CD5;&#x5206;&#x5F00;&#xFF0C;&#x5E76;&#x4F9D;&#x8D56;&#x4E8E;&#x5BF9;&#x8C61;&#x7EC4;&#x5408;&#xFF0C;&#x56E0;&#x4E3A;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x662F;&#x5728;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#x4E2D;&#x516C;&#x5F00;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x7684;&#x672C;&#x8D28;&#x662F;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#xFF08;{@link KingdomFactory}&#xFF09;&#x53CA;&#x5176;&#x5B9E;&#x73B0;&#xFF08;{@link ElfKingdomFactory}&#x3001;{@link OrcKingdomFactory}&#xFF09;&#x3002;&#x8BE5;&#x793A;&#x4F8B;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x6765;&#x521B;&#x5EFA;&#x56FD;&#x738B;&#x3001;&#x57CE;&#x5821;&#x548C;&#x519B;&#x961F;&#x3002;</p>
<h3 id="1-4-Factory-kit-&#x6A21;&#x5F0F;"><a href="#1-4-Factory-kit-&#x6A21;&#x5F0F;" class="headerlink" title="1.4 Factory kit &#x6A21;&#x5F0F;"></a>1.4 Factory kit &#x6A21;&#x5F0F;</h3><p>Factory kit &#x662F;&#x4E00;&#x79CD;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x53D8;&#x5185;&#x5BB9;&#x7684;&#x5DE5;&#x5382;&#xFF0C;&#x5177;&#x6709;&#x5206;&#x79BB;&#x7684;builder &#x548C; factory &#x63A5;&#x53E3;&#xFF0C;&#x4EE5;&#x5904;&#x7406;&#x76F4;&#x63A5;&#x5728; factory kit &#x5B9E;&#x4F8B;&#x4E2D;&#x521B;&#x5EFA;&#x6307;&#x5B9A;&#x5BF9;&#x8C61;&#x4E4B;&#x4E00;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/ad50c6906149244ad66444acc87422906f8a979620c7d3cd6c0469249a252b16" alt="image.png"></p>
<p><strong>&#x5177;&#x4F53;demo</strong></p>
<p>&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x6B66;&#x5668;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Weapon {</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x529F;&#x80FD;&#x63A5;&#x53E3;&#xFF0C;&#x5DE5;&#x5382;&#x5957;&#x4EF6;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x3002; &#x672C;&#x5730;&#x521B;&#x5EFA;&#x7684;&#x5B9E;&#x4F8B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x673A;&#x4F1A;&#x6765;&#x4E25;&#x683C;&#x5B9A;&#x4E49;&#x5DE5;&#x5382;&#x5B9E;&#x4F8B;&#x5C06;&#x80FD;&#x591F;&#x521B;&#x5EFA;&#x54EA;&#x4E9B;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x3002;Factory &#x662F; Builder &#x7684;&#x5360;&#x4F4D;&#x7B26;&#x4F7F;&#x7528; WeaponFactory#create(WeaponType) &#x65B9;&#x6CD5;&#x521D;&#x59CB;&#x5316;&#x65B0;&#x5BF9;&#x8C61;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">php&#x590D;&#x5236;&#x4EE3;&#x7801;public interface WeaponFactory {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates an instance of the given type.</span><br><span class="line">   *</span><br><span class="line">   * @param name representing enum of an object type to be created.</span><br><span class="line">   * @return new instance of a requested class implementing {@link Weapon} interface.</span><br><span class="line">   */</span><br><span class="line">  Weapon create(WeaponType name);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates factory - placeholder for specified {@link Builder}s.</span><br><span class="line">   *</span><br><span class="line">   * @param consumer for the new builder to the factory.</span><br><span class="line">   * @return factory with specified {@link Builder}s</span><br><span class="line">   */</span><br><span class="line">  static WeaponFactory factory(Consumer&lt;Builder&gt; consumer) {</span><br><span class="line">    var map = new HashMap&lt;WeaponType, Supplier&lt;Weapon&gt;&gt;();</span><br><span class="line">    consumer.accept(map::put);</span><br><span class="line">    return name -&gt; map.get(name).get();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Builder&#xFF1A;&#x5141;&#x8BB8;&#x5C06;&#x5177;&#x6709;&#x540D;&#x79F0;&#x7684;&#x6784;&#x5EFA;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x5DE5;&#x5382;&#x7684;&#x529F;&#x80FD;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Builder {</span><br><span class="line">  void add(WeaponType name, Supplier&lt;Weapon&gt; supplier);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868; &#x65A7;&#x5934; &#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Axe implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Axe&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x5F13;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Bow implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Bow&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x77DB;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Spear implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Spear&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x5251;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Sword implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Sword&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B66;&#x5668;&#x7C7B;&#x578B;&#x7684;&#x679A;&#x4E3E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public enum WeaponType {</span><br><span class="line">  SWORD,</span><br><span class="line">  AXE,</span><br><span class="line">  BOW,</span><br><span class="line">  SPEAR</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    var factory = WeaponFactory.factory(builder -&gt; {</span><br><span class="line">      builder.add(WeaponType.SWORD, Sword::new);</span><br><span class="line">      builder.add(WeaponType.AXE, Axe::new);</span><br><span class="line">      builder.add(WeaponType.SPEAR, Spear::new);</span><br><span class="line">      builder.add(WeaponType.BOW, Bow::new);</span><br><span class="line">    });</span><br><span class="line">    var list = new ArrayList&lt;Weapon&gt;();</span><br><span class="line">    list.add(factory.create(WeaponType.AXE));</span><br><span class="line">    list.add(factory.create(WeaponType.SPEAR));</span><br><span class="line">    list.add(factory.create(WeaponType.SWORD));</span><br><span class="line">    list.add(factory.create(WeaponType.BOW));</span><br><span class="line">    list.forEach(weapon -&gt; LOGGER.info(&quot;{}&quot;, weapon.toString()));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x7ED9;&#x5B9A;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;WeaponFactory&#x8868;&#x793A;&#x5DE5;&#x5382;&#x5957;&#x4EF6;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x56DB;&#x4E2A; Builder&#xFF0C;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5B9E;&#x73B0; Weapon&#x63A5;&#x53E3;&#x7684;&#x7C7B;&#x7684;&#x65B0;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x5B83;&#x4EEC;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x90FD;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; WeaponFactory#create(WeaponType) &#x65B9;&#x6CD5;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x4E2D; &#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x8868;&#x793A; WeaponType &#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x5DE5;&#x5382;&#x5B9E;&#x4F8B;&#x4E2D;&#x663E;&#x5F0F;&#x6620;&#x5C04;&#x6240;&#x9700;&#x7684;&#x7C7B;&#x7C7B;&#x578B;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/dfd3743d38b4f04fa3c2196b87093a7a.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233964656287973436.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233964656287973436.html" itemprop="url">Flutter 小技巧之 310 适配之单例 Window</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-17T11:59:38+08:00">
                2023-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Flutter 3.10 &#x53D1;&#x5E03;&#x4E4B;&#x540E;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x80FD;&#x6CE8;&#x610F;&#x5230;&#xFF0C;&#x5728;&#x5B83;&#x7684; <a href="https://dev.newban.cn/7231565908631633979#heading-46">release note</a> &#x91CC;&#x63D0;&#x4E86;&#x4E00;&#x53E5;&#xFF1A; <strong>Window singleton &#x76F8;&#x5173;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x6539;&#x52A8;&#x662F;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x672A;&#x6765;&#x591A;&#x7A97;&#x53E3;&#x7684;&#x76F8;&#x5173;&#x5B9E;&#x73B0;</strong>&#x3002;</p>
<blockquote>
<p>&#x6240;&#x4EE5;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x591A;&#x7A97;&#x53E3;&#x7684;&#x76F8;&#x5173;&#x6539;&#x8FDB;&#xFF0C;&#x591A;&#x7A97;&#x53E3;&#x66F4;&#x591A;&#x662F;&#x5728; PC &#x573A;&#x666F;&#x4E0B;&#x66F4;&#x5E38;&#x89C1;&#xFF0C;&#x4F46;&#x662F;&#x53C8;&#x9700;&#x8981;&#x517C;&#x5BB9; Mobile &#x573A;&#x666F;&#xFF0C;&#x6545;&#x800C;&#x6709;&#x6B64;&#x6B21;&#x6539;&#x52A8;&#x4F5C;&#x4E3A;&#x63D0;&#x524D;&#x94FA;&#x57AB;&#x3002;</p>
</blockquote>
<p>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x5982;&#x679C;&#x5177;&#x4F53;&#x5230;&#x5BF9;&#x5E94;&#x7684; API &#x573A;&#x666F;&#xFF0C;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x6D89;&#x53CA; <code>WidgetsBinding.instance.window</code> &#x548C; <code>MediaQueryData.fromWindow</code> &#x7B49;&#x63A5;&#x53E3;&#x7684;&#x9002;&#x914D;&#xFF0C;&#x56E0;&#x4E3A; <code>WidgetsBinding.instance.window</code> &#x5373;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/31f86cfeafe61449ad72b36cd0c0e23262c315ede09114f152afa8291d7d58ab" alt></p>
<blockquote>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x4E0D;&#x9002;&#x914D;&#xFF0C;&#x8FD8;&#x80FD;&#x8DD1;&#xFF0C;&#x53EA;&#x662F;&#x5347;&#x7EA7;&#x7684;&#x6280;&#x672F;&#x503A;&#x52A1;&#x5F80;&#x540E;&#x7D2F;&#x8BA1;&#x800C;&#x5DF2;&#x3002;</p>
</blockquote>
<p>&#x90A3;&#x9996;&#x5148;&#x53EF;&#x80FD;&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x7591;&#x95EE;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6709;&#x9700;&#x8981;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.window</code> &#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#xFF1F;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x603B;&#x7ED3;&#x4E3A;&#xFF1A;</p>
<ul>
<li>&#x6CA1;&#x6709; <code>BuildContext</code> &#xFF0C;&#x4E0D;&#x60F3;&#x5F15;&#x5165; <code>BuildContext</code></li>
<li>&#x4E0D;&#x5E0C;&#x671B;&#x83B7;&#x53D6;&#x5230;&#x7684; <code>MediaQueryData</code> &#x53D7;&#x5230;&#x6240;&#x5728; <code>BuildContext</code> &#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x4F8B;&#x5982;&#x952E;&#x76D8;&#x5F39;&#x8D77;&#x5BFC;&#x81F4; padding &#x53D8;&#x5316;&#x91CD;&#x6784;&#x548C;&#x53D7;&#x5230; <code>Scaffold</code> &#x4E0B;&#x7684;&#x53C2;&#x6570;&#x5F71;&#x54CD;&#x7B49;</li>
</ul>
<blockquote>
<p>&#x8FD9;&#x90E8;&#x5206;&#x8BE6;&#x7EC6;&#x53EF;&#x89C1;&#xFF1A;<a href="https://dev.newban.cn/7114098725600903175">&#x300A;MediaQuery &#x548C; build &#x4F18;&#x5316;&#x4F60;&#x4E0D;&#x77E5;&#x9053;&#x7684;&#x79D8;&#x5BC6;&#x300B;</a> &#x3002;</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x4ECE; 3.10 &#x5F00;&#x59CB;&#xFF0C;&#x9488;&#x5BF9; <code>WidgetsBinding.instance.window</code> &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x65B0;&#x7684; API &#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x517C;&#x5BB9;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;&#x5B58;&#x5728; <code>BuildContex</code> &#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>View.of</code> &#x83B7;&#x53D6; <code>FlutterView</code>&#xFF0C;&#x8FD9;&#x662F;&#x5B98;&#x65B9;&#x6700;&#x63A8;&#x8350;&#x7684;&#x66FF;&#x4EE3;&#x65B9;&#x5F0F;</li>
<li>&#x5982;&#x679C;&#x6CA1;&#x6709; <code>BuildContex</code> &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>PlatformDispatcher</code> &#x7684; <code>views</code> &#x5BF9;&#x8C61;&#x53BB;&#x83B7;&#x53D6;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x6CE8;&#x610F;&#x5230;&#x6CA1;&#x6709;&#xFF0C;&#x73B0;&#x5728;&#x7528;&#x7684;&#x662F; <code>View.of</code> &#xFF0C;&#x83B7;&#x53D6;&#x7684;&#x662F; <code>FlutterView</code> &#xFF0C;&#x5BF9;&#x8C61;&#x90FD;&#x79F0;&#x547C;&#x4E3A; View &#x800C;&#x4E0D;&#x662F; &#x300C;Window&#x300D;&#xFF0C;&#x5BF9;&#x5E94;&#x7684; <code>MediaQueryData.fromWindow</code> API &#x4E5F;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x4FEE;&#x6539;&#x4E3A; <code>MediaQueryData.fromView</code> &#xFF0C;&#x8FD9;&#x4E2A;&#x4FEE;&#x6539;&#x7684;&#x4F9D;&#x636E;&#x5728;&#x4E8E;&#xFF1A;</p>
<blockquote>
<p>&#x8D77;&#x521D; Flutter &#x5047;&#x5B9A;&#x4E86;&#x5B83;&#x53EA;&#x652F;&#x6301;&#x4E00;&#x4E2A; Window &#x7684;&#x573A;&#x666F;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x6709; <code>SingletonFlutterWindow</code> &#x8FD9;&#x6837;&#x7684; instance window &#x5BF9;&#x8C61;&#x5B58;&#x5728;&#xFF0C;&#x540C;&#x65F6; <code>window</code> &#x5C5E;&#x6027;&#x53C8;&#x63D0;&#x4F9B;&#x4E86;&#x8BB8;&#x591A;&#x548C;&#x7A97;&#x53E3;&#x672C;&#x8EAB;&#x65E0;&#x5173;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5728;&#x591A;&#x7A97;&#x53E3;&#x903B;&#x8F91;&#x4E0B;&#x4F1A;&#x663E;&#x5F97;&#x5F88;&#x53E6;&#x7C7B;&#x3002;</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x7528;&#x300C;&#x957F;&#x7BC7;&#x5927;&#x8BBA;&#x300D;&#x6765;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E0B;&#x8FD9;&#x4E24;&#x4E2A;&#x573A;&#x666F;&#x7684;&#x7279;&#x522B;&#x4E4B;&#x5904;&#x3002;</p>
<h1 id="&#x5B58;&#x5728;-BuildContext"><a href="#&#x5B58;&#x5728;-BuildContext" class="headerlink" title="&#x5B58;&#x5728; BuildContext"></a>&#x5B58;&#x5728; BuildContext</h1><p>&#x56DE;&#x5F52;&#x5230;&#x672C;&#x6B21;&#x7684;&#x8C03;&#x6574;&#xFF0C;&#x9996;&#x5148;&#x662F;&#x5B58;&#x5728; BuildContext &#x7684;&#x573A;&#x666F;&#xFF0C;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x5BF9;&#x4E8E;&#x5B58;&#x5728; <code>BuildContex</code> &#x7684;&#x573A;&#x666F;&#xFF0C; <code>View.of</code> &#x76F8;&#x5173;&#x7684;&#x8C03;&#x6574;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;/// 3.10 &#x4E4B;&#x524D;</span><br><span class="line">double&#xA0;dpr&#xA0;=&#xA0;WidgetsBinding.instance.window.devicePixelRatio;</span><br><span class="line">Locale&#xA0;locale&#xA0;=&#xA0;WidgetsBinding.instance.window.locale;</span><br><span class="line">double&#xA0;width&#xA0;=</span><br><span class="line">&#xA0; &#xA0;MediaQueryData.fromWindow(WidgetsBinding.instance.window).size.width;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/// 3.10 &#x4E4B;&#x540E;</span><br><span class="line">double&#xA0;dpr&#xA0;=&#xA0;View.of(context).devicePixelRatio;</span><br><span class="line">Locale&#xA0;locale&#xA0;=&#xA0;View.of(context).platformDispatcher.locale;</span><br><span class="line">double&#xA0;width&#xA0;=</span><br><span class="line">&#xA0; &#xA0;MediaQueryData.fromView(View.of(context)).size.width;</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; <code>View</code> &#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x80AF;&#x5B9A;&#x662F;&#x6709;&#x4E00;&#x4E2A; <code>InheritedWidget</code> &#xFF0C;&#x5B83;&#x5C06; <code>FlutterView</code> &#x901A;&#x8FC7; <code>BuildContext</code> &#x5F80;&#x4E0B;&#x5171;&#x4EAB;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x4F9B;&#x7C7B;&#x4F3C; &#x300C;window&#x300D; &#x7684;&#x53C2;&#x6570;&#x80FD;&#x529B;&#xFF0C;&#x800C;&#x901A;&#x8FC7; <code>View.of</code> &#x83B7;&#x53D6;&#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<ul>
<li><strong>&#x5F53; <code>FlutterView</code> &#x672C;&#x8EAB;&#x7684;&#x5C5E;&#x6027;&#x503C;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x662F;&#x4E0D;&#x4F1A;&#x901A;&#x77E5;&#x7ED1;&#x5B9A;&#x7684; <code>context</code> &#x66F4;&#x65B0;&#xFF0C;&#x8FD9;&#x4E2A;&#x884C;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E4B;&#x524D;&#x7684; <code>WidgetsBinding.instance.window</code></strong></li>
<li>&#x53EA;&#x6709;&#x5F53; <code>FlutterView</code> &#x672C;&#x8EAB;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x6BD4;&#x5982; <code>context</code> &#x7ED8;&#x5236;&#x5230;&#x4E0D;&#x540C;&#x7684; <code>FlutterView</code> &#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x89E6;&#x53D1;&#x5BF9;&#x5E94;&#x7ED1;&#x5B9A;&#x7684; <code>context</code> &#x66F4;&#x65B0;</li>
</ul>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230; <code>View.of</code> &#x8FD9;&#x4E2A;&#x884C;&#x4E3A;&#x8003;&#x8651;&#x7684;&#x662F;&#x300C;&#x591A; <code>FlutterView</code>&#x300D; &#x4E0B;&#x7684;&#x66F4;&#x65B0;&#x573A;&#x666F;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x9700;&#x8981;&#x7ED1;&#x5B9A;&#x5230;&#x5177;&#x4F53;&#x5BF9;&#x5E94;&#x53C2;&#x6570;&#x7684;&#x53D8;&#x52A8;&#x66F4;&#x65B0;&#xFF0C;&#x5982; <code>size</code> &#x7B49;&#xFF0C;&#x8FD8;&#x662F;&#x8981;&#x901A;&#x8FC7;&#x4EE5;&#x524D;&#x7684; <code>MediaQuery.of</code> / <code>MediaQuery.maybeOf</code> &#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x800C;&#x5BF9;&#x4E8E; <code>View</code> &#x6765;&#x8BF4;&#xFF0C;<strong>&#x6BCF;&#x4E2A; <code>FlutterView</code> &#x90FD;&#x5FC5;&#x987B;&#x662F;&#x72EC;&#x7ACB;&#x4E14;&#x552F;&#x4E00;&#x7684;</strong>&#xFF0C;&#x5728;&#x4E00;&#x4E2A; Widget Tree &#x91CC;&#xFF0C;&#x4E00;&#x4E2A; <code>FlutterView</code> &#x53EA;&#x80FD;&#x548C;&#x4E00;&#x4E2A; <code>View</code> &#x76F8;&#x5173;&#x8054;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E3B;&#x8981;&#x4F53;&#x73B0;&#x5728; <code>FlutterView</code> &#x6807;&#x8BC6; <code>GlobalObjectKey</code> &#x7684;&#x5B9E;&#x73B0;&#x4E0A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/8992e156ad9bbb3991e62451f5265412d8fe33d2959984be71fea30ac1a45587" alt></p>
<p>&#x7B80;&#x5355;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;<strong>&#x5728;&#x5B58;&#x5728; <code>BuildContex</code> &#x7684;&#x573A;&#x666F;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x5C06; <code>WidgetsBinding.instance.window</code> &#x66FF;&#x6362;&#x4E3A; <code>View.of(context)</code> &#xFF0C;&#x4E0D;&#x7528;&#x62C5;&#x5FC3;&#x7ED1;&#x5B9A;&#x4E86; <code>context</code> &#x5BFC;&#x81F4;&#x91CD;&#x6784;&#xFF0C;&#x56E0;&#x4E3A; <code>View.of</code> &#x53EA;&#x5BF9; <code>FlutterView</code> &#x5207;&#x6362;&#x7684;&#x573A;&#x666F;&#x751F;&#x6548;</strong>&#x3002;</p>
<h1 id="&#x4E0D;&#x5B58;&#x5728;-BuildContext"><a href="#&#x4E0D;&#x5B58;&#x5728;-BuildContext" class="headerlink" title="&#x4E0D;&#x5B58;&#x5728; BuildContext"></a>&#x4E0D;&#x5B58;&#x5728; BuildContext</h1><p>&#x5BF9;&#x4E8E;&#x4E0D;&#x5B58;&#x5728;&#x6216;&#x8005;&#x4E0D;&#x65B9;&#x4FBF;&#x4F7F;&#x7528; <code>BuildContext</code> &#x7684;&#x573A;&#x666F;&#xFF0C;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x4E86; <code>PlatformDispatcher.views</code> API &#x6765;&#x8FDB;&#x884C;&#x652F;&#x6301;&#xFF0C;&#x4E0D;&#x8FC7;&#x56E0;&#x4E3A; <code>get views</code> &#x5BF9;&#x5E94;&#x7684;&#x662F; <code>Map</code> &#x7684; <code>values</code> &#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A; <code>Iterable</code> &#x5BF9;&#x8C61;&#xFF0C;<strong>&#x90A3;&#x4E48;&#x5BF9;&#x4E8E; 3.10 &#x6211;&#x4EEC;&#x9700;&#x8981;&#x5982;&#x4F55;&#x4F7F;&#x7528; <code>PlatformDispatcher.views</code> &#x6765;&#x9002;&#x914D;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684; <code>WidgetsBinding.instance.window</code> &#x573A;&#x9762;</strong>&#xFF1F;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/99ff77582cb730e4170b4e34ce705e4013afe5960c9e8ffa21099c74b95b028f" alt></p>
<blockquote>
<p><code>PlatformDispatcher</code> &#x5185;&#x90E8;&#x7684;<code>views</code> &#x7EF4;&#x62A4;&#x4E86;&#x4E2D;&#x6240;&#x6709;&#x53EF;&#x7528; <code>FlutterView</code> &#x7684;&#x5217;&#x8868;&#xFF0C;&#x7528;&#x4E8E;&#x63D0;&#x4F9B;&#x5728;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8BBF;&#x95EE;&#x89C6;&#x56FE;&#x7684;&#x652F;&#x6301;&#x3002;</p>
</blockquote>
<p>&#x4F60;&#x8BF4;&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x6709;&#x6CA1;&#x6709; <code>BuildContext</code> &#xFF1F;&#x6BD4;&#x5982; Flutter &#x91CC; &#x7684; <code>runApp</code> &#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;3.10 &#x76EE;&#x524D;&#x5728; <code>runApp</code> &#x65F6;&#x4F1A;&#x901A;&#x8FC7; <code>platformDispatcher.implicitView</code> &#x6765;&#x585E;&#x8FDB;&#x53BB;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684; <code>FlutterView</code> &#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/6d16abfc37df39d0617509f2bfa5993efa87bc0c18a5d22644145e441e801e30" alt></p>
<p><code>implicitView</code> &#x53C8;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5176;&#x5B9E; <code>implicitView</code> &#x5C31;&#x662F; <code>PlatformDispatcher._views</code> &#x91CC; id &#x4E3A; 0 &#x7684; <code>FlutterView</code> &#xFF0C;&#x9ED8;&#x8BA4;&#x4E5F;&#x662F; <code>views</code> &#x8FD9;&#x4E2A; <code>Iterable</code> &#x91CC;&#x7684; <code>first</code> &#x5BF9;&#x8C61;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/095083a377afd9fed7c784d1216efbaced341ab8430d6a87d76e26030b9e0dd0" alt></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684;&#x573A;&#x666F;&#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>platformDispatcher.views.first</code> &#x7684;&#x5B9E;&#x73B0;&#x8FC1;&#x79FB;&#x5BF9;&#x5E94;&#x7684; <code>instance.window</code> &#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;/// 3.10 &#x4E4B;&#x524D;</span><br><span class="line">MediaQueryData.fromWindow(WidgetsBinding.instance.window)</span><br><span class="line">/// 3.10 &#x4E4B;&#x540E;</span><br><span class="line">MediaQueryData.fromView(WidgetsBinding.instance.platformDispatcher.views.first)</span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>implicitView</code> &#x5BF9;&#x8C61;&#xFF1F; &#x56E0;&#x4E3A; <code>implicitView</code> &#x76EE;&#x524D;&#x662F;&#x4E00;&#x4E2A;&#x8FC7;&#x6E21;&#x6027;&#x65B9;&#x6848;&#xFF0C;&#x5B98;&#x65B9;&#x5E0C;&#x671B;&#x5728;&#x591A;&#x89C6;&#x56FE;&#x7684;&#x573A;&#x666F;&#x4E0B;&#x4E0D;&#x5E94;&#x8BE5;&#x59CB;&#x7EC8;&#x5B58;&#x5728; implicit view &#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x800C;&#x662F;&#x5E94;&#x7528;&#x81EA;&#x5DF1;&#x5E94;&#x8BE5;&#x4E3B;&#x52A8;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x53BB;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x89C6;&#x56FE;&#x8FDB;&#x884C;&#x7ED8;&#x5236;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b5e4fe05e2c7a74ecee4a21d0a4ee50dd15ccdb0e4ade570a43acc260791b482" alt></p>
<p>&#x6240;&#x4EE5;&#x5BF9;&#x4E8E; <code>implicitView</code> &#x76EE;&#x524D;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x4E86; <code>_implicitViewEnabled</code> &#x51FD;&#x6570;&#xFF0C;&#x540E;&#x7EED;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53EF;&#x914D;&#x7F6E;&#x4F4D;&#x6765;&#x63A7;&#x5236;&#x5F15;&#x64CE;&#x662F;&#x5426;&#x652F;&#x6301; <code>implicitView</code> &#xFF0C;&#x4E5F;&#x5C31;&#x662F; <strong><code>implicitView</code> &#x5728;&#x540E;&#x7EED;&#x66F4;&#x65B0;&#x968F;&#x65F6;&#x53EF;&#x80FD;&#x4E3A; null &#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x4E0D;&#x5E94;&#x8BE5;&#x5728;&#x5916;&#x90E8;&#x53BB;&#x4F7F;&#x7528;&#x5B83;&#x7684;&#x7406;&#x7531;</strong>&#xFF0C;&#x540C;&#x65F6;&#x5B83;&#x662F;&#x5728; <code>runApp</code> &#x65F6;&#x914D;&#x7F6E;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5728;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x8FD0;&#x884C;&#x540E;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x6539;&#x53D8;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5B83;&#x6C38;&#x8FDC;&#x90FD;&#x4F1A;&#x662F; null&#x3002;</p>
<blockquote>
<p><code>PlatformDispatcher.instance.views[0]</code> &#x5728;&#x4E4B;&#x524D;&#x7684;&#x5355;&#x89C6;&#x56FE;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x6709;&#x7A97;&#x53E3;&#x5B58;&#x5728;&#xFF0C;&#x7C7B;&#x4F3C;&#x7684; <code>implicitView</code> &#x4F1A;&#x59CB;&#x7EC8;&#x5B58;&#x5728;&#xFF1B;&#x800C;&#x5728;&#x591A;&#x7A97;&#x53E3;&#x573A;&#x666F;&#x4E0B;&#xFF0C;<code>PlatformDispatcher.instance.views</code> &#x5C06;&#x4F1A;&#x8DDF;&#x968F;&#x7A97;&#x53E3;&#x53D8;&#x5316;&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x5916;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#x53BB;&#x8BBF;&#x95EE; <code>views</code> &#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x901A;&#x8FC7; <code>PlatformDispatcher.instance.views</code> &#xFF0C;&#x56E0;&#x4E3A;&#x901A;&#x5E38;&#x5B98;&#x65B9;&#x66F4;&#x5EFA;&#x8BAE;&#x5728; Binding &#x7684;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x4E0B;&#x53BB;&#x8BBF;&#x95EE; <code>PlatformDispatcher</code> &#x3002;</p>
<blockquote>
<p>&#x9664;&#x4E86;&#x9700;&#x8981;&#x5728; <code>runApp()</code> &#x6216;&#x8005; <code>ensureInitialized()</code> &#x4E4B;&#x524D;&#x8BBF;&#x95EE; PlatformDispatcher &#x7684;&#x573A;&#x666F;&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x5916;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x901A;&#x8FC7; Engine &#x91CC;&#x5BF9;&#x4E8E; window &#x90E8;&#x5206;&#x4EE3;&#x7801;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x6240;&#x9700;&#x7684;&#x9ED8;&#x8BA4;<code>FlutterView</code> &#x662F; id &#x4E3A; 0 &#x7684;&#x76F8;&#x5173;&#x4F9D;&#x636E;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#x53BB;&#x517C;&#x5BB9;&#x652F;&#x6301;&#x7684;&#x903B;&#x8F91;&#x6240;&#x5728;&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
</table>
<h1 id="&#x6700;&#x540E;"><a href="#&#x6700;&#x540E;" class="headerlink" title="&#x6700;&#x540E;"></a>&#x6700;&#x540E;</h1><p>&#x6700;&#x540E;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF0C;&#x8BF4;&#x4E86;&#x90A3;&#x4E48;&#x591A;&#xFF0C;&#x5176;&#x5B9E;&#x4E0D;&#x5916;&#x4E4E;&#x5C31;&#x662F;&#x5C06; <code>WidgetsBinding.instance.window</code> &#x66FF;&#x6362;&#x4E3A; <code>View.of(context)</code> &#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x9A9A;&#x64CD;&#x4F5C;&#x573A;&#x666F;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6015;&#x540E;&#x7EED;&#x53C8;&#x5751;&#xFF0C;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.platformDispatcher.implicitView</code> &#x3002;</p>
<p>&#x6574;&#x4F53;&#x4E0A;&#x89E3;&#x91CA;&#x90A3;&#x4E48;&#x591A;&#xFF0C;<strong>&#x4E3B;&#x8981;&#x8FD8;&#x662F;&#x7ED9;&#x5927;&#x5BB6;&#x5BF9;&#x8FD9;&#x6B21;&#x53D8;&#x52A8;&#x6709;&#x4E00;&#x4E2A;&#x80CC;&#x666F;&#x8BA4;&#x77E5;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x5BF9;&#x672A;&#x6765;&#x591A;&#x7A97;&#x53E3;&#x5B9E;&#x73B0;&#x8FDB;&#x5C55;&#x6709;&#x8FDB;&#x4E00;&#x6B65;&#x7684;&#x4E86;&#x89E3;</strong>&#xFF0C;&#x76F8;&#x4FE1;&#x4E0B;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x591A;&#x7A97;&#x53E3;&#x5E94;&#x8BE5;&#x5C31;&#x53EF;&#x4EE5;&#x548C;&#x5927;&#x5BB6;&#x89C1;&#x9762;&#x4E86;&#x3002;</p>
<p>&#x66F4;&#x591A;&#x8BA8;&#x8BBA;&#x53EF;&#x89C1;&#xFF1A;</p>
<ul>
<li><a href="/external_links/36e2e1b464fadefe00c92d9548c60b68.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/71be0d321405088e7bea5c4bfb5a6528.html" target="blank" rel="noopener">github.com/flutter/eng&#x2026;</a></li>
<li><a href="/external_links/bc745af0eebe9a54930fbcbc0cfa3a83.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/0249a9b5af89ca99c5f3ad4233767a22.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/b630f10a5f2068b2d33787ed0b4bac13.html" target="blank" rel="noopener">github.com/flutter/eng&#x2026;</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/172745dea4c9f79d934c182058e00504.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233625509107499067.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233625509107499067.html" itemprop="url">Node 中的 AsyncLocalStorage 的前世今</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-16T15:22:14+08:00">
                2023-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x4E00;&#x3001;&#x80CC;&#x666F;"><a href="#&#x4E00;&#x3001;&#x80CC;&#x666F;" class="headerlink" title="&#x4E00;&#x3001;&#x80CC;&#x666F;"></a>&#x4E00;&#x3001;&#x80CC;&#x666F;</h1><p>&#x4F60;&#x597D;&#xFF01;&#x6211;&#x662F;&#x903B;&#x5343;&#xFF0C;&#x975E;&#x5E38;&#x9AD8;&#x5174;&#x4F60;&#x80FD;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5728;&#x5F00;&#x59CB;&#x524D;&#x6211;&#x5C06;&#x5927;&#x81F4;&#x4ECB;&#x7ECD;&#x4E24;&#x70B9;&#xFF0C;&#x5173;&#x4E8E;&#x9002;&#x5408;&#x8C01;&#x770B;&#x548C;&#x80FD;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;</p>
<h2 id="&#x9002;&#x5408;&#x8C01;&#x770B;"><a href="#&#x9002;&#x5408;&#x8C01;&#x770B;" class="headerlink" title="&#x9002;&#x5408;&#x8C01;&#x770B;"></a>&#x9002;&#x5408;&#x8C01;&#x770B;</h2><table>
<thead>
<tr>
<th><strong>&#x7C7B;&#x578B;&#x4EBA;&#x7FA4;</strong></th>
<th><strong>&#x63A8;&#x8350;&#x6307;&#x6570;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>&#x5B8C;&#x5168;&#x4E0D;&#x4E86;&#x89E3;Node&#xFF0C;&#x4F46;&#x6709;&#x5174;&#x8DA3;&#x770B;&#x770B;</td>
<td>&#x9002;&#x5408;&#xFF0C;&#x6709;&#x70B9;&#x95E8;&#x69DB;&#xFF0C;&#x4F1A;&#x5C3D;&#x91CF;&#x7167;&#x987E;&#x5230;</td>
</tr>
<tr>
<td>&#x5199;&#x8FC7;Node Server&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x8FD9;&#x4E2A;API</td>
<td>&#x5F88;&#x9002;&#x5408;&#xFF0C;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#x7684;&#x673A;&#x4F1A;</td>
</tr>
<tr>
<td>&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x6B64;API&#xFF0C;&#x4F46;&#x4E0D;&#x77E5;&#x9053;&#x4ED6;&#x7684;&#x524D;&#x4E16;&#x4ECA;&#x751F;</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF0C;&#x4F60;&#x770B;&#x6807;&#x9898;&#x554A;</td>
</tr>
<tr>
<td>&#x975E;&#x5E38;&#x4E86;&#x89E3;&#x6B64;API&#x751A;&#x81F3;&#x63D0;&#x8FC7;&#x76F8;&#x5173;PR</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF01;</td>
</tr>
</tbody></table>
<h2 id="Takeaway"><a href="#Takeaway" class="headerlink" title="Takeaway"></a>Takeaway</h2><p>&#x5982;&#x679C;&#x4F60;&#x6709;&#x8010;&#x5FC3;&#x770B;&#x5B8C;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;&#xFF1A;</p>
<ol>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4E00;&#x822C;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
<li>AsyncLocalStorage &#x4E0E;&#x6700;&#x65B0;&#x7684;&#x963F;&#x91CC;&#x5DF4;&#x5DF4;&#x4E3B;&#x5BFC;&#x7684; TC39 &#x63D0;&#x6848; AsyncContext &#x4E4B;&#x95F4;&#x662F;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#xFF1F;</li>
<li>&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7C7B;&#x4F3C;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x600E;&#x4E48;&#x7528;&#x7684;&#xFF1F;</li>
<li>Node &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684; AsyncHook&#xFF1F;</li>
</ol>
<h1 id="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage"><a href="#&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage" class="headerlink" title="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage"></a>&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage</h1><h2 id="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"><a href="#&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;" class="headerlink" title="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"></a>&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;</h2><p>&#x5F53;&#x4E00;&#x4E2A; Request &#x901A;&#x8FC7;&#x5C42;&#x5C42;&#x5173;&#x5361;&#x6253;&#x5230;&#x6211;&#x4EEC;&#x7684; Server&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x4EA7;&#x751F;&#x591A;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#xFF1A;</p>
<ol>
<li>&#x8BBF;&#x95EE;&#x65E5;&#x5FD7;</li>
<li>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;</li>
<li>SQL&#x65E5;&#x5FD7;</li>
<li>&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x65E5;&#x5FD7;&#x7B49;</li>
</ol>
<p>&#x800C;&#x5F53;&#x53D1;&#x751F;&#x4E86;&#x7EBF;&#x4E0A;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x6EAF;&#x6E90;&#x6392;&#x67E5;&#x3002;</p>
<p>&#x4E00;&#x822C;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x5728;&#x8BF7;&#x6C42;&#x4E4B;&#x5904;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x4E2A; unique traceId&#xFF0C;&#x6B64; id &#x5728;&#x6240;&#x6709;&#x65E5;&#x5FD7;&#x4E2D;&#x643A;&#x5E26;&#x5C31;&#x53EF;&#x4EE5;&#x8FFD;&#x8E2A;&#x8BE5;&#x8BF7;&#x6C42;&#x7684;&#x6240;&#x6709;&#x94FE;&#x8DEF;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;<strong>&#x5168;&#x94FE;&#x8DEF;&#x65E5;&#x5FD7;&#x8FFD;&#x8E2A;</strong>&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5728; Node Server &#x4E2D;&#x5982;&#x4F55;&#x8BA9;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0A;&#x4E0B;&#x6E38;&#x8C03;&#x7528;&#x90FD;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A; traceId &#x5462;&#xFF0C;&#x6211;&#x4EEC;&#x4E0B;&#x9762;&#x7ED9;&#x51E0;&#x4E2A;&#x65B9;&#x6848;&#x3002;</p>
<p>&#xFF08;&#x5148;&#x4E0D;&#x7BA1;&#x8FD9;&#x4E2A; id &#x662F; server &#x81EA;&#x5DF1;&#x751F;&#x6210;&#x7684;&#x8FD8;&#x662F; client &#x5E26;&#x4E0A;&#x6765;&#x7684;&#xFF09;</p>
<h2 id="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"><a href="#&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;" class="headerlink" title="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"></a>&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;</h2><p>&#x7B80;&#x5355;&#xFF0C;&#x5148;&#x62CD;&#x8111;&#x888B;&#x60F3;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>globalTraceId</code>&#xFF01;</p>
<p>&#x56E0;&#x4E3A;<code>closure</code>&#x95ED;&#x5305;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;close&#x4F4F;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5728;&#x4EFB;&#x4F55;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#xFF0C;&#x8BFB;&#x53D6;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x6240;&#x6307;&#x7684;&#x5185;&#x5B58;&#x91CC;&#x7684;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x7ED9;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x5373;&#x53EF;&#xFF1A;&#xFF08;&#x4EE5; raw Node.js &#x4E3A;&#x4F8B;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Raw Node.js HTTP server</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">let globalTraceId // &#xF8FF;&#x5168;&#x5C40;&#x53D8;&#x91CF;</span><br><span class="line"></span><br><span class="line">// 0. &#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  // &#x751F;&#x6210;&#x552F;&#x4E00; traceId&#xFF0C;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#xFF0C;&#x590D;&#x5199; globalTraceId &#x7684;&#x503C;</span><br><span class="line">  globalTraceId = generateTraceId()</span><br><span class="line"></span><br><span class="line">  // &#x68C0;&#x67E5;&#x7528;&#x6237;cookie&#x662F;&#x5426;&#x6709;&#x6548;</span><br><span class="line">  cookieValidator().then((res) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });</span><br><span class="line">    res.write(&apos;Congrats! Your damn cookie is the best one!&apos;);</span><br><span class="line">    res.end();</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x628A; traceId &#x8FDE;&#x540C; error &#x4E0A;&#x62A5;&#x7ED9;&#x5F02;&#x5E38;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;</span><br><span class="line">    reportError(err, globalTraceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 1. &#x521B;&#x5EFA; server </span><br><span class="line">const server = http.createServer((req, res) =&gt; {</span><br><span class="line">	handleRequest(req, res)</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// 2. &#x8BA9; server &#x548C; port:3000 &#x5EFA;&#x7ACB; socket &#x94FE;&#x63A5;&#xFF0C;&#x6301;&#x7EED;&#x63A5;&#x6536;&#x7AEF;&#x53E3;&#x4FE1;&#x606F;</span><br><span class="line">server.listen(3000, () =&gt; {</span><br><span class="line">  console.log(&apos;Server listening on port 3000&apos;);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x4F46;&#x662F;&#x5728; Node.js &#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF08;&#x4E3B;&#x7EBF;&#x7A0B;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF09;&#xFF0C;<code>globalTraceId</code>&#x8FD9;&#x6837;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5F02;&#x6B65;&#x6821;&#x9A8C; cookie &#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x56E0;&#x4E3A; main stack &#x5DF2;&#x7A7A;&#xFF0C;&#x6240;&#x4EE5;&#x4ECE;<code>backlog</code>&#x91CC;&#x9762;&#x8C03;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#x4E3B;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x800C;<code>globalTraceId</code>&#x4F1A;&#x88AB;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x590D;&#x5199;&#xFF0C;&#x5BFC;&#x81F4;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5728;&#x9519;&#x8BEF;&#x4E0A;&#x62A5;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x80FD;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684; id</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/76690e004be71e4ff5901390b5a94fd201f8c4fd85ed6d171e7e4be7e5007477" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"><a href="#&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;" class="headerlink" title="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"></a>&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</h2><p>&#x90A3;&#x4E0A;&#x9762;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x6CD5;&#x786E;&#x5B9E;&#x4E0D;&#x5BF9;&#xFF0C;&#x90A3;&#x4F60;&#x4F1A;&#x60F3;&#xFF0C;&#x90A3;&#x6211;&#x628A;&#x751F;&#x6210;&#x7684; traceId &#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4E00;&#x6B65;&#x6B65;&#x900F;&#x4F20;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x540C;&#x4E00;&#x4E2A; traceId &#x7684;&#x6548;&#x679C;&#xFF0C;&#x597D;&#x50CF;&#x597D;&#x591A;&#x5E93;&#x548C;&#x6846;&#x67B6;&#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<p>&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  const traceId = req.headers[&apos;x-trace-id&apos;] || generateTraceId();</span><br><span class="line">  // &#x628A; traceId &#x5199;&#x5165; req &#x8FD9;&#x4E2A; object&#xFF0C;&#x5C06;&#x53C2;&#x6570;&#x4E00;&#x8DEF;&#x5E26;&#x4E0B;&#x53BB;</span><br><span class="line">  req.traceId = traceId;</span><br><span class="line"></span><br><span class="line">  // &#x540C;&#x4E0A;</span><br><span class="line">  cookieValidator().then((result) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">  	// ...</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">    reportError(err, req.traceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function cookieValidator() {</span><br><span class="line">  return new Promise((resolve, reject) =&gt; {</span><br><span class="line">    setTimeout(() =&gt; {</span><br><span class="line">      // do someting</span><br><span class="line">      // ...</span><br><span class="line">    }, 1000);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x6B64;&#x540E;&#x7701;&#x7565;&#x76D1;&#x542C;&#x7B49;&#x64CD;&#x4F5C;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x80FD;&#x591F;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x628A; traceId &#x901A;&#x8FC7; req &#x8FD9;&#x4E2A; object &#x4E00;&#x8DEF;&#x4F20;&#x4E0B;&#x53BB;&#x3002;&#x80FD;&#x4F20;&#x4E0B;&#x53BB;&#x7684;&#x539F;&#x56E0;&#x662F; node &#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684; context&#xFF08;&#x4E0A;&#x4E0B;&#x6587;&#xFF09;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x8C03;&#x7528;&#x6808;&#x3001;local variable&#x3001;referenced global variable &#x5B58;&#x4E0B;&#x6765;&#xFF0C;&#x4E00;&#x76F4;&#x5230;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x518D;&#x5728;&#x5B58;&#x4E0B;&#x6765;&#x7684; context &#x4E2D;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6240;&#x8C13;&#x7684;<code>&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</code>&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7; local variable &#x88AB;&#x5B58;&#x5230;&#x4E86; async function call context &#x91CC;&#x9762;&#x800C;&#x5B8C;&#x6210;&#x4E86;<code>traceId</code>&#x5728;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x91CC;&#x9762;&#x4E00;&#x8DEF;&#x4F20;&#x9012;&#x3002;</p>
<p><strong>&#x5E38;&#x89C1;&#x7684; Node &#x5E93;&#x5982;&#x4F55;&#x5904;&#x7406; traceId &#x7684;&#xFF1F;</strong></p>
<p>&#x7EC6;&#x5FC3;&#x7684;&#x4F60;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x5E38;&#x7528; express &#x6216;&#x8005; koa &#x8FD9;&#x6837;&#x7684;&#x5E93;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x5E72;&#x7684;&#x561B;&#x3002;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x4E3E;&#x51E0;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x5E93;&#x7684;&#x4F8B;&#x5B50;</p>
<p><strong>Express.js</strong></p>
<p><a href="/external_links/4ed5922eb818b953fc6e20d667e67b46.html" target="blank" rel="noopener">Express</a> &#x662F;&#x6700;&#x65E9;&#x6D41;&#x884C;&#x7684;Node server&#x5E93;&#xFF0C;&#x5230;&#x73B0;&#x5728;&#x4F9D;&#x7136;&#x5F88;&#x6D41;&#x884C;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x8DEF;&#x7531;&#x3001;&#x4E2D;&#x95F4;&#x4EF6;&#x7B49;&#x5404;&#x79CD;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x770B;&#x4E0B; Express &#x662F;&#x5982;&#x4F55;&#x4F20;&#x9012; TraceId &#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Via express</span><br><span class="line">const express = require(&apos;express&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  req.traceId = traceId; // attach the trace ID to the request object</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x8BBE;&#x7F6E;&#x8DEF;&#x7531;</span><br><span class="line">app.get(&apos;/&apos;, async (req, res, next) =&gt; {</span><br><span class="line">  const traceId = req.traceId;</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    // call an asynchronous function and pass along the trace ID</span><br><span class="line">    const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">    // do something with the result</span><br><span class="line">    res.send(result);</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    next(error);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p><strong>Koa.js</strong></p>
<p><a href="/external_links/375bfd688767fe0bd21f1453cbb48a1c.html" target="blank" rel="noopener">Koa</a> &#x4E5F;&#x662F;&#x793E;&#x533A;&#x975E;&#x5E38;&#x6D41;&#x884C;&#x7684;&#x5E93;</p>
<p>Koa &#x65E9;&#x671F;&#x4F7F;&#x7528; <code>yield</code>&#x8BED;&#x6CD5;&#xFF0C;&#x540E;&#x671F;&#x652F;&#x6301;&#x4E86;<code>await</code>&#x8BED;&#x6CD5;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684; <code>egg.js</code>&#x662F;&#x57FA;&#x4E8E; Koa &#x5C01;&#x88C5;&#x7684;Node Server&#x6846;&#x67B6;&#x3002;&#x73B0;&#x5728;&#x6DD8;&#x5B9D;&#x7684;<code>midwayjs</code>&#x6700;&#x65E9;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;<code>egg.js</code>&#x505A;&#x7684;&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8F88;&#x5206;&#x5173;&#x7CFB;&#x68B3;&#x7406;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Koa &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const Koa = require(&apos;koa&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;A</span><br><span class="line">app.use(async (ctx, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  ctx.state.traceId = traceId; // store the trace ID in the Koa context object</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    await next();</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    throw error;</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;B&#xFF0C;&#x901A;&#x8FC7; ctx &#x900F;&#x4F20; traceId</span><br><span class="line">app.use(async (ctx) =&gt; {</span><br><span class="line">  const traceId = ctx.state.traceId;</span><br><span class="line"></span><br><span class="line">  // call an asynchronous function and pass along the trace ID</span><br><span class="line">  const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">  // do something with the result</span><br><span class="line">  ctx.body = result;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x51E0;&#x4E4E;&#x548C; express &#x4E00;&#x6837;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x628A; tracId &#x5B58;&#x5230;&#x4E00;&#x8DEF;&#x900F;&#x4F20;&#x7684; ctx &#x53D8;&#x91CF;&#x91CC;&#x9762;&#x5B9E;&#x73B0;&#x53C2;&#x6570;&#x7684;&#x900F;&#x4F20;&#x3002;</p>
<p><strong>Nest.js</strong></p>
<p><a href="/external_links/12ea646682d52a51d59a7d141b2bc347.html" target="blank" rel="noopener">Nest</a> (NestJS) &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x9AD8;&#x6548;&#x3001;&#x53EF;&#x6269;&#x5C55;&#x7684; Node.js &#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5F00;&#x53D1;&#x6846;&#x67B6;&#x3002;&#x5B83;&#x5229;&#x7528; JavaScript &#x7684;&#x6E10;&#x8FDB;&#x589E;&#x5F3A;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F7F;&#x7528;&#x5E76;&#x5B8C;&#x5168;&#x652F;&#x6301; TypeScript &#xFF08;&#x4ECD;&#x7136;&#x5141;&#x8BB8;&#x5F00;&#x53D1;&#x8005;&#x4F7F;&#x7528;&#x7EAF; JavaScript &#x8FDB;&#x884C;&#x5F00;&#x53D1;&#xFF09;&#xFF0C;&#x5E76;&#x7ED3;&#x5408;&#x4E86; OOP &#xFF08;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#xFF09;&#x3001;FP &#xFF08;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x548C; FRP &#xFF08;&#x51FD;&#x6570;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x3002;</p>
<p>&#x603B;&#x7ED3;&#x6765;&#x8BF4; Nest &#x7684;&#x7279;&#x70B9;&#x662F;&#xFF0C;&#x5B8C;&#x7F8E;&#x652F;&#x6301;ts&#x3001;&#x62E5;&#x62B1;&#x88C5;&#x9970;&#x5668;&#x548C;&#x6CE8;&#x89E3;&#xFF0C;&#x540C;&#x65F6;&#x901A;&#x8FC7;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#xFF08;DI&#xFF09;&#x548C;&#x6A21;&#x5757;&#x5316;&#x601D;&#x60F3;&#x7B49;&#xFF0C;&#x4F7F;&#x4EE3;&#x7801;&#x7ED3;&#x6784;&#x5DE5;&#x6574;&#xFF0C;&#x6613;&#x4E8E;&#x9605;&#x8BFB;&#x3002;&#x66F4;&#x591A;&#x4ECB;&#x7ECD;&#x53EF;&#x4EE5;&#x770B;&#x5B98;&#x7F51;&#x3002;</p>
<p>&#x5728;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x4E0A;&#xFF0C;Nest &#x662F;&#x63A8;&#x8350;&#x5982;&#x4F55;&#x4F7F;&#x7528; Async Local Storage &#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x89C1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<p><a href="/external_links/feb8be566d78178e7a3d1f7852caa0bd.html" target="blank" rel="noopener">docs.nestjs.com/recipes/asy&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F7F;&#x7528; nestjs-cls&#x8FD9;&#x4E2A;&#x5E93;</span><br><span class="line">// npm i nestjs-cls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x6A21;&#x5757;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7533;&#x660E; Cls Module</span><br><span class="line">@Module({</span><br><span class="line">  imports: [</span><br><span class="line">    // Register the ClsModule,</span><br><span class="line">    ClsModule.forRoot({</span><br><span class="line">      middleware: {</span><br><span class="line">        // automatically mount the</span><br><span class="line">        // ClsMiddleware for all routes</span><br><span class="line">        mount: true,</span><br><span class="line">        // and use the setup method to</span><br><span class="line">        // provide default store values.</span><br><span class="line">        setup: (cls, req) =&gt; {</span><br><span class="line">          // &#x901A;&#x8FC7;CLS&#x5B58;&#x50A8; traceId</span><br><span class="line">          cls.set(&apos;traceId&apos;, req.headers[&apos;x-trace-id&apos;] || generateTraceId()); </span><br><span class="line">        },</span><br><span class="line">      },</span><br><span class="line">    }),</span><br><span class="line">  ],</span><br><span class="line">  providers: [CatService],</span><br><span class="line">  controllers: [CatController],</span><br><span class="line">})</span><br><span class="line">export class AppModule {}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5728; Service &#x4E2D;&#x6CE8;&#x518C; Cls&#xFF0C;&#x5E76;&#x4E14;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">@Injectable()</span><br><span class="line">export class CatService {</span><br><span class="line">  constructor(</span><br><span class="line">    // We can inject the provided ClsService instance,</span><br><span class="line">    private readonly cls: ClsService,</span><br><span class="line">    private readonly catRepository: CatRepository,</span><br><span class="line">  ) {}</span><br><span class="line"></span><br><span class="line">  getCatForUser() {</span><br><span class="line">    // and use the &quot;get&quot; method to retrieve any stored value.</span><br><span class="line">    const userId = this.cls.get(&apos;traceId&apos;); // &#x83B7;&#x5F97; traceId</span><br><span class="line">    return this.catRepository.getForUser(userId);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Nest &#x548C;&#x4E0A;&#x9762;&#x7684;&#x5E93;&#x8089;&#x773C;&#x4E0A;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x662F;&#x91C7;&#x7528;&#x4E86;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#xFF0C;&#x540C;&#x65F6;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x88C5;&#x9970;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x5982;&#x679C;&#x5BF9;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x6709;&#x5174;&#x8DA3;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5B8C;&#x6210;&#x4E86;IOC&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>
<p><a href="/external_links/70d2f105f034cda3227e2404a8261f1f.html" target="blank" rel="noopener">zhuanlan.zhihu.com/p/311184005</a></p>
<p>OK&#xFF0C;&#x90A3;&#x4E48; <code>nestjs-cls</code>&#x8FD9;&#x4E2A;&#x5E93;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x8FD9;&#x4E2A;&#x5305;&#x7684;&#x63CF;&#x8FF0;</p>
<p>The <a href="/external_links/a0093739fc6f0cfaa52e7579861105d8.html" target="blank" rel="noopener">nestjs-cls</a> package provides several DX improvements over using plain <strong>AsyncLocalStorage</strong> (<strong>CLS</strong> is an abbreviation of the term continuation-local storage).</p>
<p>DX &#x662F; Developer Experience &#x5373;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x5E93;&#x662F;&#x7528;&#x4E8E;&#x63D0;&#x5347;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x7684;&#x57FA;&#x4E8E;&#x539F;&#x751F;<code>AsyncLocalStorage</code>&#x7684;&#x5305;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4E0B;&#x9762;&#x7EC8;&#x4E8E;&#x4ECB;&#x7ECD;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x7684;&#x4E3B;&#x89D2;<code>AsyncLocalStorage</code>&#xFF01;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/474a62136aef30b6aa5a113fa6f0fb7870b2959bb58557a6cabb0b622807356a" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"><a href="#&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage" class="headerlink" title="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"></a>&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;<code>AsyncLocalStorage</code></h2><p>AsyncLocalStorage &#x662F; Nodejs &#x7684; API&#xFF08;&#x5927;&#x7EA6;&#x5728;2019&#x5E74;&#x63A8;&#x51FA;&#xFF0C;2020&#x5E74;&#x8FDB;&#x5165;&#x7A33;&#x5B9A;&#x7248;&#x672C;&#xFF09;</p>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F; Node.js &#x89C9;&#x5F97;&#x5927;&#x5BB6;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4E0D;&#x591F;&#x4F18;&#x96C5;&#xFF0C;&#x54E5;&#x76F4;&#x63A5;&#x5728;<code>C++</code>&#x7684;&#x5C42;&#x9762;&#x7ED9;&#x4F60;&#x4EEC;&#x505A;&#x6389;&#x8FD9;&#x4E2A;&#x4E8B;&#xFF0C;&#x7136;&#x540E;&#x63D0;&#x4F9B;&#x4E2A;API&#x7ED9;&#x5927;&#x4F19;&#x7528;&#xFF0C;&#x600E;&#x4E48;&#x6837;&#xFF1F;&#x55EF;&#x5927;&#x6982;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x3002;</p>
<p>&#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x662F;&#x5B98;&#x65B9;&#x7684;API&#xFF0C;&#x81EA;&#x7136;&#x6709;&#x5B98;&#x65B9;&#x7684;&#x6587;&#x6863;&#x6765;&#x63CF;&#x8FF0;</p>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;</p>
<blockquote>
<p>This class creates stores that stay coherent through asynchronous operations.</p>
<p>While you can create your own implementation on top of the node:async_hooks module, AsyncLocalStorage should be preferred as it is a performant and memory safe implementation that involves significant optimizations that are non-obvious to implement.</p>
<p>The following example uses AsyncLocalStorage to build a simple logger that assigns IDs to incoming HTTP requests and includes them in messages logged within each request.</p>
</blockquote>
<p>&#x6587;&#x6863;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/8b7ffbb550a0eb20f988772d3dcd2f09.html" target="blank" rel="noopener">nodejs.org/api/async_c&#x2026;</a></p>
<p>&#x4E2D;&#x6587;&#x89E3;&#x91CA;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#xFF1A;<code>AsyncLocalStorage</code>&#x662F;&#x57FA;&#x4E8E;<code>node:async_hooks</code>&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#xFF08;&#x6BD4;&#x4E4B;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#xFF09;&#x662F;&#x6027;&#x80FD;&#x597D;&#x3001;&#x5185;&#x5B58;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x5B58;&#x50A8;&#x7528;&#x4E8E;<code>log</code>&#x7684;&#x4FE1;&#x606F;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E2A;&#x4F8B;&#x5B50; <code>AsyncLocalStorage</code>&#x662F;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;// How to use AsyncLocalStorage in Node.js</span><br><span class="line">import http from &apos;node:http&apos;;</span><br><span class="line">import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">function logWithId(msg) {</span><br><span class="line">  const traceId = asyncLocalStorage.getStore();</span><br><span class="line">  console.log(`${traceId}:`, msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">http.createServer((req, res) =&gt; {</span><br><span class="line">  // &#xF8FF;&#x5173;&#x952E;&#x7684;API&#x8C03;&#x7528;&#xF8FF;</span><br><span class="line">  asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">    logWithId(&apos;start&apos;);</span><br><span class="line">    // Imagine any chain of async operations here</span><br><span class="line">    setImmediate(() =&gt; {</span><br><span class="line">      logWithId(&apos;finish&apos;);</span><br><span class="line">      res.end();</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}).listen(8080);</span><br><span class="line"></span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">// Prints:</span><br><span class="line">//   0: start</span><br><span class="line">//   1: start</span><br><span class="line">//   0: finish</span><br><span class="line">//   1: finish</span><br></pre></td></tr></table></figure>

<p>&#x4E0B;&#x9762;&#x662F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x89E3;&#x91CA;&#xFF1A;</p>
<p>&#x4E0A;&#x9762;&#x5C55;&#x793A;&#x4E86;2&#x4E2A;&#x8BF7;&#x6C42;&#x88AB;&#x6253;&#x5230;<code>port:8080</code>&#xFF0C;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x88AB;&#x653E;&#x5728;&#x4E86;<code>asyncLocalStorage.run</code>&#x8FD9;&#x4E2A;API&#x91CC;&#x9762;&#x3002;<code>setImmediate</code>&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7;<code>logWithId</code>&#x53D6;&#x51FA;&#x8BE5;&#x8BF7;&#x6C42;&#x5728;&#x8FDB;&#x5165;&#x65F6;&#x88AB;&#x8D4B;&#x4E88;&#x7684;<code>id</code>&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5373;&#x4F7F;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;id(&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;idSeq=0&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x65F6;idSeq=1)&#x5DF2;&#x7ECF;&#x88AB;log&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x662F; line 8 &#x7684; &#x540C;&#x4E00;&#x4E2A; <code>asyncLocalStorage</code>&#x5374;&#x80FD;<code>getStore</code>&#x51FA;&#x5BF9;&#x5E94;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0D;&#x540C;id&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x5F0F;&#x5B58;&#x50A8;<code>id</code>&#x4F18;&#x96C5;&#x5F97;&#x591A;&#xFF08;&#x53E6;&#x5916;&#xFF0C;&#x901A;&#x8FC7;<code>asyncLocalStorage</code>&#x8FD9;&#x6837;&#x9690;&#x5F0F;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x6709;&#x70B9;&#x50CF;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; State Monad &#x5E2E;&#x52A9;&#x5F00;&#x53D1;&#x8005;&#x9690;&#x5F0F;&#x7BA1;&#x7406;&#x53C2;&#x6570;&#x4F20;&#x9012;&#xFF09;</p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x8BB2;&#x5230;&#x8FD9;&#xFF0C;&#x6211;&#x4EEC;<code>Takeaway</code>&#x4E2D;&#x7684;1&#x5DF2;&#x7ECF;&#x88AB;&#x89E3;&#x51B3;&#x4E86;</p>
<ul>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
</ul>
<p>&#x5982;&#x679C;&#x8BA4;&#x771F;&#x770B;&#x5B8C;&#xFF0C;&#x76F8;&#x4FE1;&#x4F60;&#x5BF9;&#x5B83;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x4E2A;&#x611F;&#x6027;&#x7684;&#x8BA4;&#x8BC6;&#x3002;&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6807;&#x9898;&#x7684;&#x540E;&#x4E00;&#x53E5;&#x8BDD;&#xFF0C;<code>AsyncLocalStorage</code>&#x7684;<code>&#x524D;&#x4E16;&#x4ECA;&#x751F;</code></p>
<h1 id="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage"><a href="#&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage" class="headerlink" title="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage"></a>&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage</h1><blockquote>
<p>&#x5FD8;&#x8BB0;&#x5386;&#x53F2;&#x5C31;&#x610F;&#x5473;&#x7740;&#x80CC;&#x53DB;&#xFF08;&#x72D7;&#x5934;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x5386;&#x53F2;&#x7684;&#x5408;&#x8BA2;&#x672C;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x5927;&#x5BB6;&#x90FD;&#x6709;&#x53C2;&#x6570;&#x5F02;&#x6B65;&#x4F20;&#x9012;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x6240;&#x4EE5;&#x7B49;19&#x5E74;AsyncLocalStorage&#x88AB;&#x63A8;&#x51FA;&#x4E4B;&#x524D;&#x4E00;&#x5B9A;&#x6709;&#x793E;&#x533A;&#x65B9;&#x6848;&#x88AB;&#x5927;&#x5BB6;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Node.js 14&#x53D1;&#x5E03;&#x4E4B;&#x524D;&#xFF0C;&#x793E;&#x533A;&#x662F;&#x5982;&#x4F55;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x7EBF;&#x6765;&#x68B3;&#x7406;&#x6B64;&#x4E8B;&#xFF0C;&#x90A3;&#x8981;&#x4ECE;2013&#x5E74;&#x7684;&#x6625;&#x5929;&#x8BF4;&#x8D77;</p>
<h2 id="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;"><a href="#2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;" class="headerlink" title="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;"></a>2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;</h2><p>2013&#x5E74;4&#x6708;30&#x53F7;&#xFF0C;<a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">node-continuation-local-storage</a> &#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x63D0;&#x4EA4;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A; <code>commit</code>&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#xFF0C;&#x793E;&#x533A;&#x66F4;&#x591A;&#x5730;&#x79F0;&#x5B83;&#x4E3A;<code>CLS</code>(Continuation-Local Storage&#xFF0C;&#x4E4B;&#x540E;&#x7B80;&#x79F0;&#x4E3A;CLS)&#x3002;&#x6211;&#x622A;&#x53D6;&#x4E86;&#x8FD9;&#x4E2A;10&#x5C81;&#x7684;&#x4ED3;&#x5E93;README&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x6BB5;&#x7ED9;&#x5927;&#x5BB6;</p>
<blockquote>
<p>Continuation-local storage works like thread-local storage in threaded programming, but is based on chains of Node-style callbacks instead of threads. The standard Node convention of functions calling functions is very similar to something called <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> in functional programming, and the name comes from the way this module allows you to set and get values that are scoped to the lifetime of these chains of function calls.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x8BDD;&#x53EF;&#x4EE5;&#x63D0;&#x53D6;&#x51FA;&#x51E0;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<ol>
<li>CLS &#x50CF;&#x591A;&#x7EBF;&#x7A0B;&#x7F16;&#x7A0B;&#x4E2D;&#x7684;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x7684; storage&#xFF08;TLS: thread local storage&#xFF09;&#x4E00;&#x6837;&#x5DE5;&#x4F5C;&#xFF0C;&#x53EA;&#x662F;&#x539F;&#x7406;&#x662F;&#x57FA;&#x4E8E; callback function &#x800C;&#x4E0D;&#x662F;&#x7EBF;&#x7A0B;</li>
<li>&#x53D6;&#x540D;&#x4E2D;&#x6709; Continuation &#x4EE3;&#x8868; C&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> &#x6982;&#x5FF5;&#xFF0C;&#x65E8;&#x5728;&#x94FE;&#x5F0F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x6301;&#x4E45;&#x7684;&#x6570;&#x636E;</li>
<li>&#x4F60;<code>set</code>&#x548C;<code>get</code>&#x7684;&#x503C;&#xFF0C;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5F02;&#x6B65;&#x7684;function&#x7684;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x8C03;&#x7528;&#x94FE;&#x5185;&#x7684;</li>
</ol>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x4E0B;&#x9762;&#x662F; github &#x4E0A;&#x8BE5;&#x4ED3;&#x5E93;&#x7684;&#x793A;&#x4F8B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const cls = require(&apos;continuation-local-storage&apos;); // require(&apos;cls-hooked&apos;) &#x4E5F;&#x884C;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;</span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// Create a new namespace for the traceId</span><br><span class="line">const traceNamespace = cls.createNamespace(&apos;trace&apos;);</span><br><span class="line"></span><br><span class="line">// Middleware to set the traceId for each request</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  traceNamespace.run(() =&gt; {</span><br><span class="line">    // Generate a new traceId if one doesn&apos;t exist</span><br><span class="line">    traceNamespace.set(&apos;traceId&apos;, generateTraceId());</span><br><span class="line">    next();</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// Route to get the traceId for the current request</span><br><span class="line">app.get(&apos;/traceId&apos;, async (req, res) =&gt; {</span><br><span class="line">  try {</span><br><span class="line">    const cookie = await cookieValidator()</span><br><span class="line">    // &#x6821;&#x9A8C;&#x662F;&#x5426;&#x6210;&#x529F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  } catch(e) {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">  	const traceId = traceNamespace.get(&apos;traceId&apos;);</span><br><span class="line">    reportError(err, traceId)</span><br><span class="line">  }</span><br><span class="line">  res.send(`Trace ID: ${traceId}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x6BCF;&#x6B21;&#x6267;&#x884C; <code>namespace.run(callback)</code> &#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x8BED;&#x6CD5;&#x4E0A;&#xFF0C;&#x901A;&#x8FC7; run &#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x4F4F;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x56DE;&#x8C03;&#x5185;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x6211;&#x4EEC;&#x7684; <code>Continuation-Local Storage</code>&#x3002;&#x8FD9;&#x4E2A;<code>xxx.run(callbakc, ...)</code>&#x7684;&#x8BED;&#x6CD5;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x4F1A;&#x591A;&#x6B21;&#x770B;&#x5230;&#x3002;</p>
<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>CLS &#x901A;&#x8FC7; <code>process.addAsyncListener</code> &#x8FD9;&#x4E2A; API &#x76D1;&#x542C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x3002;&#x5728;&#x521B;&#x5EFA;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#x5C06;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x5165;&#xFF0C;&#x6267;&#x884C;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x65F6;&#xFF0C;&#x4F20;&#x5165;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x9500;&#x6BC1;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x800C;<code>process.addAsyncListener</code>&#x662F; <a href="/external_links/579311e71bce05526dda23c9eec7c845.html" target="blank" rel="noopener">Node v0.11 &#x7248;&#x672C;&#x7684; API</a>&#xFF0C;&#x76EE;&#x524D;&#x4ED3;&#x5E93;&#x5F15;&#x7528;&#x7684;&#x662F; polyfill &#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4ECE;&#x4E0B;&#x9762;&#x622A;&#x56FE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x8FD9;&#x662F;&#x6BB5; polyfill &#x7684;&#x4EE3;&#x7801;&#x662F;2013&#x5E74;9&#x6708;2&#x53F7;&#x88AB;&#x63D0;&#x4EA4;&#x7684;&#xFF0C;&#x662F;&#x76F8;&#x5F53;&#x53E4;&#x65E9;&#x7684;&#x4E8B;&#x60C5;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// load polyfill if native support is unavailable</span><br><span class="line">if (!process.addAsyncListener) require(&apos;async-listener&apos;);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/d502057cb6d6c203cbee7f6d8b8418543828a268e169049b8144de25a6b1d788" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x901A;&#x8FC7; async call &#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x5199;&#x51FA;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#x7684;&#x9700;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x53D8;&#x91CF;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6765;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF1B;&#x540C;&#x65F6;&#x5728;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x91CC;&#x9762;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x901A;&#x8FC7;&#x6B64;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5B8C;&#x6210;&#x4E86;<code>nest</code>&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5373;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#xFF0C;run&#x91CC;&#x9762;&#x5728;&#x5D4C;&#x5165;&#x4E00;&#x4E2A;run&#x3002;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x975E;&#x5E38;&#x9002;&#x5408;&#x505A;&#x8C03;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x56E0;&#x4E3A; main call stack &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6808; : &#xFF09;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF1A;<a href="/external_links/7113efbf78025131b4cfb56c78bc528d.html" target="blank" rel="noopener">github.com/othiym23/no&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;// createNamespace &#x5C31;&#x662F;&#x8C03;&#x7528;&#x5185;&#x90E8;&#x7684; create &#x65B9;&#x6CD5;</span><br><span class="line">function create(name) {</span><br><span class="line">  assert.ok(name, &quot;namespace must be given a name!&quot;);</span><br><span class="line"></span><br><span class="line">  var namespace = new Namespace(name); // &#x65B0;&#x5EFA; space</span><br><span class="line">  namespace.id = process.addAsyncListener({</span><br><span class="line">    create : function () { return namespace.active; },</span><br><span class="line">    before : function (context, storage) { if (storage) namespace.enter(storage); },</span><br><span class="line">    after  : function (context, storage) { if (storage) namespace.exit(storage); },</span><br><span class="line">    error  : function (storage) { if (storage) namespace.exit(storage); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  process.namespaces[name] = namespace;</span><br><span class="line">  return namespace;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>create</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A; Namespace &#x6765;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64; name &#x4F1A;&#x5728;&#x539F;&#x751F;API&#x4E0A;&#x76D1;&#x542C;&#x5404;&#x79CD;&#x4E8B;&#x4EF6;&#xFF0C;&#x540C;&#x65F6;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x7684; store &#x53D8;&#x5316;&#x3002;&#x5176;&#x4E2D;<code>namespace.enter(storage)</code>&#x8868;&#x793A;&#x5C06;&#x6B64;&#x65F6;&#x7684; ctx &#x5165;&#x6808;&#xFF0C;&#x5728;async call before&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#xFF0C;&#x5373;&#x5B8C;&#x6210;&#x5F02;&#x6B65;&#x65F6;&#x95F4;&#x540E;&#x3001;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x3002;&#x800C;&#x5728;async call after&#x65F6;&#xFF0C;&#x5219;&#x662F;&#x8C03;&#x7528;&#x51FA;&#x6808;&#x65B9;&#x6CD5; <code>namespace.exit(storage)</code>&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570; storage&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728; store &#x4E2D;&#x5B58;&#x5165;&#x7684; traceId</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// cls&#x7684;&#x5B9E;&#x73B0;</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x662F; store &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684; class</span><br><span class="line">function Namespace(name) {</span><br><span class="line">  this.name   = name;</span><br><span class="line">  // changed in 2.7: no default context</span><br><span class="line">  this.active = null;</span><br><span class="line">  this._set   = [];</span><br><span class="line">  this.id     = null;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// run&#x65B9;&#x6CD5;</span><br><span class="line">Namespace.prototype.run = function (fn) {</span><br><span class="line">  var context = this.createContext();</span><br><span class="line">  this.enter(context);</span><br><span class="line">  try {</span><br><span class="line">    fn(context);</span><br><span class="line">    return context;</span><br><span class="line">  }</span><br><span class="line">  catch (exception) {</span><br><span class="line">    if (exception) {</span><br><span class="line">      exception[ERROR_SYMBOL] = context;</span><br><span class="line">    }</span><br><span class="line">    throw exception;</span><br><span class="line">  }</span><br><span class="line">  finally {</span><br><span class="line">    this.exit(context);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// &#x5F53;&#x524D;&#x7684; active &#x5165;&#x6808;&#xFF0C;&#x628A;&#x65B0;&#x7684; ctx &#x5F53;&#x505A; this.active</span><br><span class="line">Namespace.prototype.enter = function (context) {</span><br><span class="line">  assert.ok(context, &quot;context must be provided for entering&quot;);</span><br><span class="line"></span><br><span class="line">  this._set.push(this.active);</span><br><span class="line">  this.active = context;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684; <code>this._set</code>&#x5C31;&#x662F;&#x521A;&#x624D;&#x8BF4;&#x7684;&#x88AB;&#x7EF4;&#x62A4;&#x7684;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x6BCF;&#x4E00;&#x6B21; run &#x7684;&#x8C03;&#x7528;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; context &#x4F5C;&#x4E3A; this.active&#xFF0C;&#x540C;&#x65F6;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;&#x7684; context&#xFF08;this.active&#xFF09;&#x7ED9; push &#x8FDB;&#x5165; this._set &#x8FD9;&#x4E2A;&#x6808;&#xFF0C;&#x7B49;&#x5F85;&#x540E;&#x7EED;&#x88AB;pop&#x540E;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540E;&#x6765;&#x4ECB;&#x7ECD;&#x7684;<code>cls-hooked</code>&#x903B;&#x8F91;&#x548C;&#x4ED6;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x73B0;&#x66F4;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x628A;&#x4ED6;&#x628A;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5B58;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>new map()</code>&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;<code>&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x4E3A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x751F;&#x6210;&#x7684;asyncId</code> &#x4F5C;&#x4E3A; key &#x6765;&#x533A;&#x5206;&#x3002;&#x4E0D;&#x8FC7;&#x4E3A;&#x4E86;&#x5D4C;&#x5957;&#x80FD;&#x529B;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x4F9D;&#x65E7;&#x4FDD;&#x7559;&#x3002;</p>
<p>&#x867D;&#x7136;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x5DF2;&#x7ECF;&#x5728;&#x201D;&#x5386;&#x53F2;&#x7684;&#x5783;&#x573E;&#x5806;&#x201D;&#x91CC;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x91CC;&#x9762; API &#x7684;&#x8BBE;&#x8BA1;&#x548C;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x7684;&#x8FD8;&#x662F;&#x503C;&#x5F97;&#x4E00;&#x770B;&#xFF0C;&#x56E0;&#x4E3A;&#x4E4B;&#x540E;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x6CBF;&#x7528;&#x7684;&#x7C7B;&#x4F3C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;</p>
<p>&#x90A3;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x770B;&#x4E0B;&#x4E00;&#x4E2A;API&#x7684;&#x53D1;&#x5E03;</p>
<h2 id="2017&#x5E74;&#xFF1A;async-hooks"><a href="#2017&#x5E74;&#xFF1A;async-hooks" class="headerlink" title="2017&#x5E74;&#xFF1A;async_hooks"></a>2017&#x5E74;&#xFF1A;async_hooks</h2><blockquote>
<p><code>async_hooks</code>&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x4E09;&#x65B9;&#x5E93;&#xFF0C;&#x800C;&#x662F;&#x4E00;&#x4E2A;Node build-in&#x7684;module&#xFF0C;&#x4F9B;&#x7528;&#x6237;&#x8C03;&#x7528;&#x3002;</p>
</blockquote>
<p>The async_hooks API was released in Node.js 8.x in 2017</p>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x901A;&#x8FC7; hook &#x53EF;&#x4EE5;&#x5F80; async call &#x7684;&#x5404;&#x4E2A;&#x9636;&#x6BB5;&#x6CE8;&#x518C;&#x65B9;&#x6CD5;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684;React&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x4E00;&#x65E0;&#x4E8C;&#x7684;<code>asyncId</code>&#xFF0C;&#x6240;&#x4EE5;&#x57FA;&#x4E8E;&#x6B64;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6211;&#x4EEC;&#x7684;&#x5F02;&#x6B65;&#x76D1;&#x542C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;const asyncHooks = require(&apos;async-hooks&apos;)</span><br><span class="line">const asyncHook = asyncHooks.createHook({</span><br><span class="line">  init: (asyncId, type, triggerAsyncId, resource) =&gt; {},</span><br><span class="line">  before: asyncId =&gt; {},</span><br><span class="line">  after: asyncId =&gt; {},</span><br><span class="line">  destroy: asyncId =&gt; {},</span><br><span class="line">  promiseResolve: asyncId =&gt; {},</span><br><span class="line">})</span><br><span class="line">asyncHook.enable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// init() is called during object construction. The resource may not have</span><br><span class="line">// completed construction when this callback runs. Therefore, all fields of the</span><br><span class="line">// resource referenced by &quot;asyncId&quot; may not have been populated.</span><br><span class="line">function init(asyncId, type, triggerAsyncId, resource) { }</span><br><span class="line"></span><br><span class="line">// before() is called just before the resource&apos;s callback is called. It can be</span><br><span class="line">// called 0-N times for handles (such as TCPWrap), and will be called exactly 1</span><br><span class="line">// time for requests (such as FSReqCallback).</span><br><span class="line">function before(asyncId) { }</span><br><span class="line"></span><br><span class="line">// after() is called just after the resource&apos;s callback has finished.</span><br><span class="line">function after(asyncId) { }</span><br><span class="line"></span><br><span class="line">// destroy() is called when the resource is destroyed.</span><br><span class="line">function destroy(asyncId) { }</span><br></pre></td></tr></table></figure>

<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>&#x5177;&#x4F53;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x6700;&#x540E;&#x7684;&#x5EF6;&#x5C55;&#x7AE0;&#x8282;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x4E86;</p>
<h2 id="2017&#x5E74;&#xFF1A;cls-hooked"><a href="#2017&#x5E74;&#xFF1A;cls-hooked" class="headerlink" title="2017&#x5E74;&#xFF1A;cls-hooked"></a>2017&#x5E74;&#xFF1A;cls-hooked</h2><p>&#x5728;2017&#x5E74;&#xFF0C;async_hooks&#x53D1;&#x5E03;&#x540E;&#xFF0C;Jeff Lewis &#x8FD9;&#x4F4D;&#x8001;&#x5144;&#x9A6C;&#x4E0D;&#x505C;&#x8E44;&#x5730;&#x5C06;&#x8001;&#x4ED3;&#x5E93;fork&#x51FA;&#x6765;&#xFF0C;&#x91CD;&#x65B0;&#x7528;&#x6700;&#x65B0;&#x7684; async_hooks &#x91CD;&#x5199;&#x4E86; CLS&#x3002;&#x7531;&#x4E8E;&#x91CD;&#x5199;&#x540E; API &#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53D8;&#x5316;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x5217;&#x4E3E;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E86;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4ED6;&#x7684; <code>README</code></p>
<blockquote>
<p>This is a fork of <a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">CLS</a> using <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> OR <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> instead of <a href="/external_links/688d0de2171d760751ff9c148c702be3.html" target="blank" rel="noopener">async-listener</a>.</p>
<p>When running Nodejs version &lt; 8, this module uses <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> which is an unsupported Nodejs API, so please consider the risk before using it.</p>
<p>When running Nodejs version &gt;= 8.2.1, this module uses the newer <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> API which is considered <strong>Experimental</strong> by Nodejs.</p>
</blockquote>
<p>&#x4ECE;&#x4ED6;&#x7684; <code>README</code> &#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Node&#x7248;&#x672C;&#x5C0F;&#x4E8E;8&#x7684;&#xFF0C;&#x4F7F;&#x7528;&#x4E86; AsyncWrap&#xFF0C;&#x800C;Node&#x7248;&#x672C;&#x5927;&#x4E8E;8.2.1&#x7684;&#x5219;&#x7528;async_hooks&#x91CD;&#x5199;&#x4E86;&#x3002;</p>
<p>&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x4ED6;&#x7528; <code>Experimental</code>&#x6765;&#x63CF;&#x8FF0;&#x6B64;API&#xFF0C;&#x81EA;&#x7136;&#x800C;&#x7136;&#x6211;&#x4EEC;&#x5230; Nodejs &#x7684;&#x5B98;&#x7F51;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E0D;&#x518D;&#x88AB;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x3002;&#x539F;&#x56E0;&#x662F;&#x53EF;&#x7528;&#x6027;&#x3001;&#x5B89;&#x5168;&#x6027;&#x3001;&#x4EE5;&#x53CA;&#x6027;&#x80FD;&#x8868;&#x73B0;&#x90FD;&#x6709;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x4F60;&#x60F3;&#x4F7F;&#x7528; Async Context Tracking &#x7684;&#x80FD;&#x529B;&#xFF0C;&#x53D6;&#x800C;&#x4EE3;&#x4E4B;&#x7684;&#x5E94;&#x8BE5;&#x662F; <code>AsyncLocalStorage</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x56E0;&#x4E3A;&#x662F; ALS &#x505A;&#x4E86;&#x9002;&#x5F53;&#x7684;&#x4F18;&#x5316;&#x5E76;&#x4E14;&#x8BED;&#x6CD5;&#x66F4;&#x7B80;&#x6D01;</p>
<blockquote>
<p>Stability: 1 - Experimental. Please migrate away from this API, if you can. We do <strong>not</strong> recommend using the createHook, AsyncHook, and executionAsyncResource APIs as they have usability issues, safety risks, and performance implications. Async context tracking use cases are better served by the stable <strong>AsyncLocalStorage</strong> API.</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4e394fb3ecc3c17de3e353cf678a0b77487fe35285a9b8af5f8dfc32c7e5ee65" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>Node&#x6587;&#x6863;&#x4E2D;&#xFF0C;API&#x7684;&#x7A33;&#x5B9A;&#x6027;&#xFF08;&#x5C31;&#x662F;&#x544A;&#x8BC9;&#x4F60;&#x6562;&#x4E0D;&#x6562;&#x7528;&#x8FD9;&#x4E2A; API&#xFF09;&#x6709;&#x5206;&#x7EA7;</p>
<p>&#x5373;<code>Stability index</code>&#x88AB;&#x5206;&#x4E3A;&#x4E86;4&#x6863;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;</p>
<ul>
<li>Stability: 0 - Deprecated</li>
<li>Stability: 1 - Experimental</li>
<li>Stability: 2 - Stable</li>
<li>Stability: 3 - Legacy</li>
</ul>
<p>&#x6211;&#x4EEC;&#x7684; async_hooks &#x88AB;&#x5F52;&#x5230;&#x4E86; Experimental&#xFF0C;<code>&#x5728;&#x672A;&#x6765;&#x7684;&#x4EFB;&#x4F55;&#x7248;&#x672C;&#x4E2D;&#x90FD;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x975E;&#x5411;&#x540E;&#x517C;&#x5BB9;&#x7684;&#x53D8;&#x5316;&#x6216;&#x5220;&#x9664;&#x3002;&#x4E0D;&#x5EFA;&#x8BAE;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;</code>&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x4EFB;&#x4F55;&#x7EBF;&#x4E0A;&#x73AF;&#x5883;&#x90FD;&#x53EA;&#x4F7F;&#x7528; Statbility:2 - Stable &#x5C31;&#x597D;&#x3002;</p>
<h2 id="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"><a href="#2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;" class="headerlink" title="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"></a>2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;</h2><p>AsyncLocalStorage was first introduced in Node.js version 12.0.0, released on April 23, 2019.</p>
<p>&#x56E0;&#x4E3A;AsyncLocalStorage (ALS) &#x7684;&#x9700;&#x6C42;&#x5F3A;&#x70C8;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5B9E;&#x9A8C;&#x540E;&#xFF0C;ALS&#x7EC8;&#x4E8E;&#x5728; Node v13.10.0 &#x5B8C;&#x6574;&#x652F;&#x6301;&#x4E86;&#xFF0C;&#x968F;&#x540E; API &#x8FC1;&#x79FB;&#x5230;&#x4E86;&#x957F;&#x671F;&#x652F;&#x6301;&#x7248;&#x672C; Node v12.17.0</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0440a7ec9c3e4ae1819413914bfe7196a1af2a491f399ade0291d8179c778da4" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x56E0;&#x4E3A;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;API&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x4E5F;&#x5938;&#x4E86;&#x4E0D;&#x5C11;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4ECE;&#x5176;&#x4ED6;&#x89D2;&#x5EA6;&#x6765;&#x9610;&#x8FF0;&#x4E0B;</p>
<p><strong>&#x6027;&#x80FD;&#x95EE;&#x9898;</strong></p>
<p>AsyncLocalStorage &#x76F4;&#x63A5;&#x57FA;&#x4E8E; async_hooks &#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x3002;&#x800C; async_hooks &#x5BF9;&#x4E8E;&#x6027;&#x80FD;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x5728;&#x9AD8;&#x5E76;&#x53D1;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x5927;&#x5BB6;&#x5BF9;&#x6B64; API &#x4FDD;&#x6301;&#x4E86;&#x8C28;&#x614E;&#x7684;&#x6001;&#x5EA6;&#x3002;</p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/6f76ee04dc2a41d55ed6ec8653f3fcec.html" target="blank" rel="noopener">github.com/bmeurer/asy&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d6835046c3c728f13ce977774869f58514f4914567005e70519950c3823abf5" alt="image.png"></p>
<p>&#x540C;&#x65F6;&#xFF0C;Node &#x7684; issue &#x91CC;&#x9762;&#x4E5F;&#x6709;&#x5927;&#x91CF;&#x5BF9;&#x6B64;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x4E2A;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">&#x300A;AsyncLocalStorage kills 97% of performance in an async environment #34493&#x300B;</a></p>
<p>&#x672C;&#x6765;Node&#x7684;&#x6027;&#x80FD;&#x5C31;&#x662F;&#x4ED6;&#x7684;&#x77ED;&#x677F;&#xFF08;&#x6216;&#x8005;&#x8BF4;&#x8FD9;&#x4E8B;&#x56E0;&#x4E3A;&#x4ED6;&#x7684;&#x7279;&#x8D28;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#xFF09;&#xFF0C;&#x73B0;&#x5728;&#x7528;&#x4E0A;ALS&#x540E;&#x6027;&#x80FD;&#x53C8;&#x53D8;&#x5DEE;&#x4E86;&#x4E0D;&#x5C11;&#xFF0C;&#x81EA;&#x7136;&#x4F1A;&#x8BA9;&#x4EBA;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5BF9;&#x4ED6;&#x656C;&#x800C;&#x8FDC;&#x4E4B;&#xFF0C;&#x6240;&#x4EE5;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5462;&#xFF1F;</p>
<p><strong>&#x540E;&#x7EED;&#x66F4;&#x65B0;</strong></p>
<p>&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x8001;&#x5927;&#x54E5; V8 &#x51FA;&#x624B;&#x4E86;&#xFF0C;&#x6211;&#x501F;&#x7ED9;&#x4F60;&#x4E00;&#x4E2A; V8 &#x7684; API &#x7528;&#x5427;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x76D1;&#x542C;&#x6211;&#x7684; Promise lifecycle</p>
<p>&#x8FD9;&#x5C31;&#x662F; v8::Context PromiseHook API&#x3002;&#x8FD9;&#x4E2A; Hook &#x88AB;&#x52A0;&#x5165; V8 &#x540E;&#xFF0C;&#x5F88;&#x5FEB;&#x88AB; <a href="/external_links/706a78c569161016581eebbc66a99d27.html" target="blank" rel="noopener">Stephen Belanger</a> &#x52A0;&#x5165;&#x5230;&#x4E86; async_hooks</p>
<p>&#x8FD9;&#x662F;&#x5F15;&#x5165; PromiseHook &#x7684; PR &#x5730;&#x5740;&#xFF1A;<a href="/external_links/91da14a86e1b4f6cd2f94e947848e1eb.html" target="blank" rel="noopener">PR: async_hooks: use new v8::Context PromiseHook API #36394</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6a45a352587f4dc1e58ec99514f8955ca1c7f6d6538cb184865c599abdb8f6d" alt="image.png"></p>
<p>&#x7136;&#x540E;&#xFF0C;&#x4ECE;21&#x5E74;5&#x6708;&#x8FD9;&#x4E2A;&#x8BC4;&#x8BBA;&#x91CC;&#x9762;&#x5C31;&#x80FD;&#x770B;&#x51FA;&#xFF0C;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">github.com/nodejs/node&#x2026;</a>&#xFF0C;&#x5728;V8&#x7684;&#x52A0;&#x6301;&#x4E0B;&#xFF0C;&#x5728; Node v16.2.0 &#x7684;&#x7248;&#x672C;&#x91CC;&#xFF0C;ALS&#x7684;&#x6027;&#x80FD;&#x201D;&#x5927;&#x5E45;&#x201D;&#x63D0;&#x5347;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/63210224001af4e04afb287cfbba4bab36fef05ae575f0457d20dcce0a2ca191" alt="image.png"></p>
<h2 id="&#x5C0F;&#x7ED3;-1"><a href="#&#x5C0F;&#x7ED3;-1" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x6211;&#x4EEC;&#x5B8C;&#x6210;&#x4E86;2&#x548C;3&#xFF0C;&#x540C;&#x65F6;&#x62D3;&#x5C55;&#x4E86;&#x4E9B;&#x7C7B;&#x4F3C;&#x7684;&#x573A;&#x666F;&#x548C;&#x7528;&#x6CD5;</p>
<ul>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
</ul>
<p>&#x901A;&#x8FC7;&#x6B64;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x8F74;&#x753B;&#x4E00;&#x5F20;&#x56FE;&#x51FA;&#x6765;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/3e1d3b38e1e7e8075a119a3b5337234f407feb5dfda92faaab344525995cc994" alt="image.png"></p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8FD9;&#x5E45;&#x56FE;&#x5DF2;&#x7ECF;&#x9610;&#x8FF0;&#x4E86;&#x5927;&#x81F4;&#x7684;&#x53D1;&#x5C55;&#x7684;&#x5386;&#x53F2;</p>
<p>&#x800C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x4E4B;&#x524D;&#x4ECE;&#x672A;&#x63D0;&#x53CA;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x4E5F;&#x5F15;&#x51FA;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x88AB;&#x5199;&#x51FA;&#x7684;&#x539F;&#x56E0;<code>AsyncContext</code>&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BF4;&#xFF0C;&#x6700;&#x603B;&#x7ED3;&#x7684;&#x65F6;&#x5019;&#x8BF4;&#x5427;</p>
<h1 id="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;"><a href="#&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;" class="headerlink" title="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;"></a>&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;</h1><blockquote>
<p>&#x7531;&#x963F;&#x91CC;&#x5DF4;&#x5DF4; TC39 &#x4EE3;&#x8868;&#x4E3B;&#x5BFC;&#x7684; <a href="/external_links/f44d0aeb1204b34bfe7e868bfb06412a.html" target="blank" rel="noopener">Async Context &#x63D0;&#x6848;</a> &#x521A;&#x5728; 2023&#x5E74; 2 &#x6708;&#x521D;&#x7684; TC39 &#x4F1A;&#x8BAE;&#x4E2D;&#x6210;&#x4E3A;&#x4E86; TC39 Stage 1 &#x63D0;&#x6848;&#x3002;&#x63D0;&#x6848;&#x7684;&#x76EE;&#x6807;&#x662F;&#x5B9A;&#x4E49;&#x5728; JavaScript &#x7684;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x4E2D;&#x4F20;&#x9012;&#x6570;&#x636E;&#x7684;&#x65B9;&#x6848;&#x3002;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x5927;&#x5BB6;&#x4E5F;&#x80FD;&#x5F88;&#x5FEB;&#x660E;&#x767D;&#x65B0;&#x7684; TC39 &#x63D0;&#x6848;<code>AsyncContext</code>&#x662F;&#x5728;&#x505A;&#x4EC0;&#x4E48;&#x3002;</p>
<p>&#x5BF9;&#x6BD4;&#x4E24;&#x8005;&#x7684;API&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>AsyncContext</code>&#x7ED3;&#x5408;&#x4E86;<code>AsyncLocalStorage</code>&#x548C;<code>AsyncResource</code>&#xFF0C;&#x5E76;&#x7528;&#x4E86;&#x66F4;&#x901A;&#x7528;&#x7684;&#x540D;&#x5B57;<code>context</code>&#x6765;&#x6307;&#x4EE3;&#x540E;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x7684;&#x7ED3;&#x5408;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// ======= TC39&#x63D0;&#x6848;: AsyncContext =======</span><br><span class="line">class AsyncContext&lt;T&gt; {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6240;&#x6709; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x3002;</span><br><span class="line">  // &#x5F53;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6267;&#x884C;&#x65F6;&#xFF0C;&#x4F1A;&#x5C06; AsyncContext &#x72B6;&#x6001;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  static wrap&lt;R&gt;(fn: (...args: any[]) =&gt; R): (...args: any[]) =&gt; R;</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06; value &#x8BBE;&#x7F6E;&#x4E3A;&#x5F53;&#x524D; </span><br><span class="line">  // AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x503C;&#x4F1A;&#x5728; fn &#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x8D77;&#x7684;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x4E2D;&#x88AB;</span><br><span class="line">  // &#x5FEB;&#x7167;&#xFF08;&#x76F8;&#x5F53;&#x4E8E; wrap&#xFF09;&#x3002;</span><br><span class="line">  run&lt;R&gt;(value: T, fn: () =&gt; R): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F53;&#x524D; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;</span><br><span class="line">  get(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ======= Node API: AsyncLocalStorage =======</span><br><span class="line">class AsyncLocalStorage&lt;T&gt; {</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; callback&#xFF0C;&#x5E76;&#x5728; callback &#x6267;&#x884C;&#x671F;&#x95F4;&#x8BBE;&#x7F6E;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x503C;&#x3002;</span><br><span class="line">  run&lt;R&gt;(store: T, callback: (...args: any[]) =&gt; R, ...args: any[]): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5F53;&#x524D;&#x503C;</span><br><span class="line">  getStore(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">class AsyncResource {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x7684;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  runInAsyncScope&lt;R&gt;(fn: (...args: any[]) =&gt; R, thisArg, ...args: any[]): R;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;&#x8FD9;&#x91CC;&#x56DE;&#x7B54;&#x4E0B;&#x8FD9;&#x7AE0;&#x7684;&#x6807;&#x9898;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684;&#x5173;&#x7CFB;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x662F;</p>
<ul>
<li>AsyncLocalStorage&#x662F;Node&#x7684;API&#xFF1B;&#x4E0D;&#x662F;&#x6807;&#x51C6;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A; runtime &#x7684; API</li>
<li>AsyncContext&#x662F;EMACScript&#x6807;&#x51C6;(&#x5982;&#x679C;&#x901A;&#x8FC7;)&#xFF1B;&#x901A;&#x8FC7;&#x540E;&#x5C06;&#x6210;&#x4E3A;&#x89C4;&#x8303;&#xFF0C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7531;&#x5404;&#x79CD; runtime &#x914D;&#x5408; JS Engine &#x6765;&#x652F;&#x6301;</li>
</ul>
<p>&#x770B;&#x6765;&#x8FD9;&#x6BD4;&#x96F7;&#x950B;&#x548C;&#x96F7;&#x950B;&#x5854;&#x7684;&#x5173;&#x7CFB;&#x66F4;&#x8FD1;&#x4E9B;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x4E3A;&#x4E86;&#x8BA9; ECMA &#x6807;&#x51C6;&#x80FD;&#x540C;&#x65F6;&#x80FD;&#x517C;&#x5BB9;Node&#x7684;API&#xFF08;&#x56E0;&#x4E3A;&#x6807;&#x51C6;&#x548C;&#x76EE;&#x524D;&#x7684;API&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5230;&#x65F6;&#x5019;&#x53C8;&#x5F97;&#x6539;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x541E;&#x541E;&#x8001;&#x5E08;&#x7684;&#x63D0;&#x6848;&#x8BA9; AsyncContext &#x7684;&#x8BED;&#x6CD5;&#x548C; AsyncLocalStorage &#x975E;&#x5E38;&#x63A5;&#x8FD1;</p>
<h1 id="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"><a href="#&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"></a>&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;</h1><p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x4E0B;&#x540C;&#x884C;&#x90FD;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#xFF0C;&#x5927;&#x5BB6;&#x770B;&#x770B;&#x95E8;&#x9053;&#xFF0C;&#x6211;&#x4E5F;&#x770B;&#x4E2A;&#x70ED;&#x95F9;</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>&#x4F7F;&#x7528; ThreadLocal &#x6765;&#x5904;&#x7406;&#x7EBF;&#x7A0B;&#x5185;&#x7684;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class TraceIdFilter implements Filter {</span><br><span class="line"></span><br><span class="line">    private static final String TRACE_ID_HEADER = &quot;X-Trace-Id&quot;;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;String&gt; TRACE_ID = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)</span><br><span class="line">            throws IOException, ServletException {</span><br><span class="line">        HttpServletRequest httpRequest = (HttpServletRequest) request;</span><br><span class="line">        String traceId = httpRequest.getHeader(TRACE_ID_HEADER);</span><br><span class="line">        if (traceId == null || traceId.isEmpty()) {</span><br><span class="line">            traceId = generateTraceId();</span><br><span class="line">        }</span><br><span class="line">        TRACE_ID.set(traceId);</span><br><span class="line">        try {</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        } finally {</span><br><span class="line">            TRACE_ID.remove();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static String getTraceId() {</span><br><span class="line">        return TRACE_ID.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private String generateTraceId() {</span><br><span class="line">        return UUID.randomUUID().toString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // Other methods for initializing and destroying the filter...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h3><p>&#x4F7F;&#x7528; thread_local &#x6765;&#x5904;&#x7406;&#x672C;&#x5730;&#x7EBF;&#x7A0B;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;iostream&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line"></span><br><span class="line">thread_local int my_thread_local;</span><br><span class="line"></span><br><span class="line">void my_thread_function() {</span><br><span class="line">    my_thread_local = std::hash&lt;std::thread::id&gt;()(std::this_thread::get_id());</span><br><span class="line">    std::cout &lt;&lt; &quot;My thread-local value is &quot; &lt;&lt; my_thread_local &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main() {</span><br><span class="line">    std::thread t1(my_thread_function);</span><br><span class="line">    std::thread t2(my_thread_function);</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>&#x540C;&#x4E0A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">py&#x590D;&#x5236;&#x4EE3;&#x7801;import threading</span><br><span class="line"></span><br><span class="line">my_thread_local = threading.local()</span><br><span class="line"></span><br><span class="line">def my_thread_function():</span><br><span class="line">    my_thread_local.value = threading.get_ident()</span><br><span class="line">    print(f&quot;My thread-local value is {my_thread_local.value}&quot;)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=my_thread_function)</span><br><span class="line">t2 = threading.Thread(target=my_thread_function)</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br></pre></td></tr></table></figure>

<h1 id="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"></a>&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;</h1><p>&#x4E0B;&#x9762;&#x4E24;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x591A;&#x8D70;&#x4FE9;&#x6B65;&#xFF0C;&#x4ECB;&#x7ECD;&#x548C;&#x8BA8;&#x8BBA;&#x4E0B;&#x8FD9;&#x4E9B; API &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x5E0C;&#x671B;&#x6307;&#x6B63;&#x3002;</p>
<blockquote>
<p>&#x56E0;&#x4E3A;&#x5177;&#x4F53;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x4F1A;&#x548C; Node &#x7684;&#x7248;&#x672C;&#x6709;&#x5F3A;&#x76F8;&#x5173;</p>
<p>&#x6240;&#x4EE5;&#x7279;&#x522B;&#x58F0;&#x660E;&#xFF1A;&#x4E0B;&#x9762;&#x7684;&#x6587;&#x6863;&#x3001;&#x4EE3;&#x7801;&#x90FD;&#x4EE5; <strong>Node v16.x LTS</strong> (Long-term Support) &#x4E2D;&#x7684;&#x6587;&#x6863;&#x548C;&#x4EE3;&#x7801;&#x4E3A;&#x4F8B;&#x3002;</p>
</blockquote>
<h2 id="I-Wonder-Where-the-API-Comes-From"><a href="#I-Wonder-Where-the-API-Comes-From" class="headerlink" title="I Wonder Where the API Comes From"></a>I Wonder Where the API Comes From</h2><p>&#x8981;&#x60F3;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;API&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x8BFB;&#x6587;&#x6863;</p>
<p><a href="/external_links/664de0d336dbe22f94ea8fc636ae5876.html" target="blank" rel="noopener">nodejs.org/docs/latest&#x2026;</a></p>
<p>&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x6587;&#x6863;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;API&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x662F;&#x5374;&#x900F;&#x9732;&#x4E86;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x4FE1;&#x606F;&#xFF0C;source code &#x6765;&#x81EA;<code>lib/async_hook.js</code></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0a02586a931534dafb9e51e01ab042a798a29318da44f3547f84e3b18e00a4a0" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a99ea1bac5616fc973b92571f342f503fd686f3035cc42b371621f724058a731" alt="image.png"><br>&#x6240;&#x4EE5;&#x987A;&#x7406;&#x6210;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x63A2;&#x7D22;</p>
<p>&#x63A2;&#x7D22;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x5148;&#x5927;&#x6982;&#x4ECB;&#x7ECD;&#x4E0B; nodejs &#x9879;&#x76EE;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</p>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x548C;&#x6784;&#x5EFA;&#x6587;&#x4EF6;&#x54B1;&#x5148;&#x4E0D;&#x770B;&#xFF0C;&#x54B1;&#x4EEC;&#x770B;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x4E09;&#x4E2A;&#x6587;&#x4EF6;&#x5939;<code>deps</code>&#x3001;<code>lib</code>&#x3001;<code>src</code></p>
<table>
<thead>
<tr>
<th><strong>&#x540D;&#x5B57;</strong></th>
<th><strong>&#x8BF4;&#x660E;</strong></th>
<th><strong>&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x8BED;&#x8A00;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>deps</td>
<td>&#x5305;&#x542B; Node.js &#x4F7F;&#x7528;&#x7684;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#xFF0C;&#x5305;&#x62EC; V8 &#x5F15;&#x64CE;&#x548C; libuv &#x5E93;&#x7B49;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F; node_modules</td>
<td>C++/C</td>
</tr>
<tr>
<td>lib</td>
<td>&#x5305;&#x542B; Node.js &#x6838;&#x5FC3;&#x5E93;&#x6587;&#x4EF6;&#xFF0C;&#x5305;&#x62EC;&#x7528;&#x4E8E;&#x5904;&#x7406; I/O &#x64CD;&#x4F5C;&#x3001;&#x7F51;&#x7EDC;&#x548C;&#x5176;&#x4ED6;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#x7684;&#x6A21;&#x5757;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x6838;&#x5FC3;&#x5E93;&#x7684;JS&#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x4F5C;&#x4E3A;API&#x63D0;&#x4F9B;&#x7ED9;Nodejs&#x4F7F;&#x7528;&#x3002;&#x6BD4;&#x5982;&#x54B1;&#x4EEC;&#x719F;&#x6089;&#x7684; require(http) &#x5C31;&#x662F;&#x5F15;&#x7528;&#x7684; <code>lib/http.js</code></td>
<td>Javascript</td>
</tr>
<tr>
<td>src</td>
<td>&#x5305;&#x542B; Node.js &#x7684; C++ &#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x5305;&#x62EC;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x5982;&#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;&#x3001;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x548C; HTTP &#x670D;&#x52A1;&#x5668;&#x3002;C++&#x6838;&#x5FC3;&#x6A21;&#x5757;</td>
<td>C++</td>
</tr>
</tbody></table>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x6B65;&#x6B65;&#x6765;&#x68B3;&#x7406; AsyncLocalStorage API&#x2019;s calling chain</p>
<h2 id="Javascript-Zone"><a href="#Javascript-Zone" class="headerlink" title="Javascript Zone"></a>Javascript Zone</h2><p>OK&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x5927;&#x6982;&#x77E5;&#x9053;&#x4E86;&#x7684; <code>AsyncLocalStorage</code>API &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF0C;&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x6253;&#x5F00; <code>async_hooks.js</code>&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 1. &#x771F;&#x6B63;&#x7684;&#x50A8;&#x5B58;&#x4F4D;&#x7F6E;</span><br><span class="line">const storageList = [];</span><br><span class="line">const storageHook = createHook({</span><br><span class="line">  init(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">    const currentResource = executionAsyncResource();</span><br><span class="line">    // Value of currentResource is always a non null object</span><br><span class="line">    for (let i = 0; i &lt; storageList.length; ++i) {</span><br><span class="line">      storageList[i]._propagate(resource, currentResource);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">function createHook(fns) {</span><br><span class="line">  return new AsyncHook(fns);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 2. ALS Class &#x7684;&#x5B9E;&#x73B0;</span><br><span class="line">class AsyncLocalStorage {</span><br><span class="line">  constructor() {</span><br><span class="line">    this.kResourceStore = Symbol(&apos;kResourceStore&apos;);</span><br><span class="line">    this.enabled = false;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  _enable() {</span><br><span class="line">    if (!this.enabled) {</span><br><span class="line">      this.enabled = true;</span><br><span class="line">      ArrayPrototypePush(storageList, this);</span><br><span class="line">      storageHook.enable();</span><br><span class="line">		}</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  run(store, callback, ...args) {</span><br><span class="line">    // Avoid creation of an AsyncResource if store is already active</span><br><span class="line">    if (ObjectIs(store, this.getStore())) {</span><br><span class="line">      return ReflectApply(callback, null, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    this._enable();</span><br><span class="line"></span><br><span class="line">    // &#x65B0;&#x8001; resource &#x4EA4;&#x63A5;&#x73ED;</span><br><span class="line">    const resource = executionAsyncResource(); // &#x65B0;&#x7684;resource</span><br><span class="line">    const oldStore = resource[this.kResourceStore];  // &#x8001;&#x7684;resource</span><br><span class="line"></span><br><span class="line">    resource[this.kResourceStore] = store; // &#x65B0;&#x7684;resource&#xFF0C;traceId&#x5B58;&#x653E;&#x7684;&#x5730;&#x65B9;</span><br><span class="line"></span><br><span class="line">    try {</span><br><span class="line">      return ReflectApply(callback, null, args); </span><br><span class="line">    } finally {</span><br><span class="line">      resource[this.kResourceStore] = oldStore; // &#x7B49;callback&#x6267;&#x884C;&#x7ED3;&#x675F;&#xFF0C;&#x5C06;&#x8001;&#x7684;oldStore&#x5F52;&#x8FD8;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  getStore() {</span><br><span class="line">    if (this.enabled) {</span><br><span class="line">      const resource = executionAsyncResource();</span><br><span class="line">      return resource[this.kResourceStore];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4E86;&#x4FBF;&#x4E8E;&#x9605;&#x8BFB;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5220;&#x53BB;&#x4E86;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FD0;&#x884C; <code>AsyncLocalStorage.run(callback)</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x6267;&#x884C;2&#x4E2A;&#x52A8;&#x4F5C;&#xFF1A;</p>
<p>&#x53C2;&#x7167;&#x4E0B;&#x9762;&#x7684;API&#x8C03;&#x7528;&#x4EE3;&#x7801;&#x6765;&#x770B;</p>
<ul>
<li><code>this._enable()</code>&#xFF0C;&#x6FC0;&#x6D3B; hook &#x76D1;&#x542C;</li>
<li>&#x901A;&#x8FC7; <code>executionAsyncResource()</code>&#xFF0C;&#x83B7;&#x5F97;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8D44;&#x6E90;<code>resource</code>&#xFF08;AsyncResource&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;V8&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;AsyncResource&#xFF09;</li>
<li>&#x7136;&#x540E;&#x628A;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; store &#x5F53;&#x505A;<code>resource</code>&#x91CC;<code>kResourceStore</code>&#x5BF9;&#x5E94;&#x7684;&#x503C;&#xFF08;store&#x5C31;&#x662F;traceId&#xFF0C;kResourceStore&#x5C31;&#x662F;&#x4E00;&#x4E2A;Symbol&#x800C;&#x5DF2;&#xFF09;</li>
<li>&#x7136;&#x540E;&#x624D;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684;callback&#x4EE3;&#x7801;<code>ReflectApply(callback, null, args)</code>&#x3002;&#x5176;&#x4E2D;<code>ReflectApply</code>&#x76F4;&#x63A5;&#x7406;&#x89E3;&#x4E3A;JS&#x4E2D;&#x7684;<code>Function.Apply()</code>&#x3002;</li>
<li>&#x4E4B;&#x540E;&#x8FD9;&#x4E2A; run &#x65B9;&#x6CD5;&#x91CC;&#x9762;&#xFF0C;&#x4EFB;&#x4F55;&#x901A;&#x8FC7;<code>executionAsyncResource()</code>&#x5F97;&#x5230;&#x7684;&#x503C;&#x90FD;&#x662F;&#x6211;&#x4EEC;&#x1F446;&#x1F3FB;&#x4E0A;&#x9762;&#x7684; <code>traceId</code></li>
<li>&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>getStore()</code>&#x62FF;&#x5230;&#x8FD9;&#x4E2A;<code>traceId</code>&#xFF0C;&#x5B8C;&#x7F8E;&#xFF01;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">  console.log(asyncLocalStorage.getStore())</span><br><span class="line">  setImmediate(() =&gt; {</span><br><span class="line">    console.log(asyncLocalStorage.getStore())</span><br><span class="line">  })</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">asyncLocalStorage.run(&apos;test&apos;, () =&gt; {})</span><br></pre></td></tr></table></figure>

<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#x57FA;&#x4E8E;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;<code>ALS.run()</code>&#x91CC;&#x9762;&#x7684;callback&#x540C;&#x6B65;&#x8BF7;&#x6C42;&#x90FD;&#x53EF;&#x4EE5;&#x987A;&#x5229;&#x62FF;&#x5230;&#x5BF9;&#x5E94;&#x7684;<code>store</code>&#xFF0C;&#x4F46;&#x662F;&#x5F02;&#x6B65;&#x7684;&#x8BF7;&#x6C42;&#x6BCF;&#x6B21;&#x4F1A;&#x65B0;&#x5EFA; <code>AsyncResource</code>&#x3002;&#x6240;&#x4EE5;&#x62FF;&#x4E0D;&#x5230;&#x4E0A;&#x9762;&#x7684; store</p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x6765;&#x770B;<code>storageHook</code>&#x53D8;&#x91CF;&#xFF0C;&#x4ED6;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; Hook &#x6765;&#x76D1;&#x542C; init &#x4E8B;&#x4EF6;&#xFF0C;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x7684;&#x5F02;&#x6B65;&#x8D44;&#x6E90;(AsyncResource)&#x7684;&#x503C;&#x4F20;&#x7ED9;&#x6211;&#x4EEC;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x547D;&#x540D;&#x5B83;&#x4E3A;&#x5F02;&#x6B65;A&#x3002;&#x6240;&#x4EE5;&#x5728;&#x4E0D;&#x4E45;&#x7684;&#x5C06;&#x6765;&#xFF0C;&#x5F02;&#x6B65;A&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>asyncLocalStorage.getStore()</code>&#x53EF;&#x4EE5;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684;&#x503C;</p>
<p>&#x7ED3;&#x8BBA;&#xFF0C;ALS&#x4E5F;&#x662F;&#x57FA;&#x4E8E;AsyncHook&#x548C;&#x795E;&#x79D8;&#x7684;<code>executionAsyncResource</code>&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x4F46;&#x662F;&#x4ED6;&#x53EA;&#x4F7F;&#x7528;&#x4E86; init Hook&#xFF0C;&#x800C;&#x4E14;&#x5C01;&#x88C5;&#x7684;&#x5F88;&#x597D;&#xFF0C;&#x6240;&#x4EE5;&#x6027;&#x80FD;&#x548C;&#x53EF;&#x7528;&#x6027;&#x90FD;&#x66F4;&#x597D;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x770B; <code>AsyncHook</code>&#x90FD;&#x66F4;&#x53EF;&#x7591;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x7AE0;&#x6211;&#x4EEC;&#x6765;&#x5206;&#x6790;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x76D1;&#x542C;&#x52AB;&#x6301;&#x4EFB;&#x4F55;&#x4E00;&#x79CD;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x8FD9;&#x4E2A;<code>run&#x65B9;&#x6CD5;</code> &#x91CC;&#x9762;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x5B9E;&#x73B0;&#x7684;&#x5F62;&#x5F0F;&#x662F;&#x901A;&#x8FC7;&#x7C7B;&#x4F3C;&#x4E8E;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B8C;&#x6210;&#x4E86;<code>&#x5D4C;&#x5957;nest</code>&#x80FD;&#x529B;</p>
<p>&#x5176;&#x5B9E;&#x4ECE;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684; commit log &#x4E2D;&#x4E5F;&#x80FD;&#x8BC1;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x731C;&#x60F3;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9aee0aaa769ea22a8b6a157e78a739a312a16595e6bde4cdc654c0a09856bce5" alt></p>
<p>&#x8FD9;&#x4E2A;&#x622A;&#x56FE;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E2A;&#x5C0F;&#x5F69;&#x86CB; Reviewed-By: Zijian Liu</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x8FD9;&#x79CD;&#x9012;&#x5F52;&#x8FD8;&#x6709;&#x70B9;&#x50CF; Leetcode &#x7ECF;&#x5178;&#x7684;&#x56DE;&#x6EAF;&#x7B97;&#x6CD5;&#x9898; <a href="/external_links/25a09439e0a56f47cfbff81fc581b659.html" target="blank" rel="noopener">51. N-Queens</a>&#xFF0C;&#x5B83;&#x5C31;&#x662F;&#x5BF9; tree &#x7684;DFS&#x904D;&#x5386;&#x3002;DFS&#x904D;&#x5386;&#x7528;&#x9012;&#x5F52;&#x5199;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x800C;&#x7528;&#x8FED;&#x4EE3;&#x5199;&#x5C31;&#x662F;&#x7528;Stack&#x4E86;</p>
<h1 id="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;"></a>&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;</h1><h2 id="Intro-and-Guess"><a href="#Intro-and-Guess" class="headerlink" title="Intro and Guess"></a>Intro and Guess</h2><p>&#x5728;&#x4E0A;&#x4E00;&#x4E2A;&#x7AE0;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0; AsyncHook &#x548C; executionAsyncResource &#x662F;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B; AsyncHook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line">class AsyncHook {</span><br><span class="line">  constructor({</span><br><span class="line">    init,</span><br><span class="line">    before,</span><br><span class="line">    after,</span><br><span class="line">    destroy,</span><br><span class="line">    promiseResolve</span><br><span class="line">  }) {</span><br><span class="line">    this[init_symbol] = init;</span><br><span class="line">    this[before_symbol] = before;</span><br><span class="line">    this[after_symbol] = after;</span><br><span class="line">    this[destroy_symbol] = destroy;</span><br><span class="line">    this[promise_resolve_symbol] = promiseResolve;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  enable() {</span><br><span class="line">    // The set of callbacks for a hook should be the same regardless of whether</span><br><span class="line">    // enable()/disable() are run during their execution. The following</span><br><span class="line">    // references are reassigned to the tmp arrays if a hook is currently being</span><br><span class="line">    // processed.</span><br><span class="line">    const {</span><br><span class="line">      0: hooks_array,</span><br><span class="line">      1: hook_fields</span><br><span class="line">    } = getHookArrays();</span><br><span class="line"></span><br><span class="line">    // Each hook is only allowed to be added once.</span><br><span class="line">    if (ArrayPrototypeIncludes(hooks_array, this))</span><br><span class="line">      return this;</span><br><span class="line"></span><br><span class="line">    const prev_kTotals = hook_fields[kTotals];</span><br><span class="line"></span><br><span class="line">    // createHook() has already enforced that the callbacks are all functions,</span><br><span class="line">    // so here simply increment the count of whether each callbacks exists or</span><br><span class="line">    // not.</span><br><span class="line">    hook_fields[kTotals] = hook_fields[kInit] += +!!this[init_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kBefore] += +!!this[before_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kAfter] += +!!this[after_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kDestroy] += +!!this[destroy_symbol];</span><br><span class="line">    hook_fields[kTotals] +=</span><br><span class="line">      hook_fields[kPromiseResolve] += +!!this[promise_resolve_symbol];</span><br><span class="line">    ArrayPrototypePush(hooks_array, this);</span><br><span class="line"></span><br><span class="line">    if (prev_kTotals === 0 &amp;&amp; hook_fields[kTotals] &gt; 0) {</span><br><span class="line">      enableHooks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    updatePromiseHookMode();</span><br><span class="line"></span><br><span class="line">    return this;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD8;&#x597D;&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E0D;&#x7B97;&#x53EF;&#x7591;&#xFF0C;&#x548C;&#x9884;&#x60F3;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x628A;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7684; hook &#x7684; callback &#x5B58;&#x8D77;&#x6765;&#x3002;&#x7136;&#x540E;&#x518D;&#x901A;&#x8FC7; enable &#x65B9;&#x6CD5;&#x6FC0;&#x6D3B;&#x4ED6;&#x4EEC;&#xFF0C;&#x90A3; line 44 &#x7684; enableHooks() &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF1F;&#x6765;&#x81EA;<code>lib/internal/async_hooks.js</code>&#xFF08;&#x662F;&#x7684;&#xFF0C;&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x539F;&#x6765;&#x6BCF;&#x4E00;&#x4E2A;lib&#x6587;&#x4EF6;&#x5939;&#x7684;API&#x8FD8;&#x8C03;&#x7528;&#x4E86;<code>lib/internal</code>&#x8FD9;&#x5C42;&#x5185;&#x90E8;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x53C8;&#x62BD;&#x8C61;&#x4E86;&#x4E00;&#x5C42;&#x51FA;&#x6765;&#x3002;&#xFF09;</p>
<p>&#x770B;&#x4E0B;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">const async_wrap = internalBinding(&apos;async_wrap&apos;);</span><br><span class="line">const { setCallbackTrampoline } = async_wrap;</span><br><span class="line"></span><br><span class="line">function enableHooks() {</span><br><span class="line">  async_hook_fields[kCheck] += 1;</span><br><span class="line"></span><br><span class="line">  setCallbackTrampoline(callbackTrampoline);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; setCallbackTrampoline&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x81EA; async_wrap&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x770B;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x8C03;&#x7528;&#x7684;&#x795E;&#x79D8;&#x7684; executionAsyncResource &#x91CC;&#x9762;&#x8C03;&#x7528;&#x7684;&#x5173;&#x952E;&#x53D8;&#x91CF;&#xFF0C;&#x51E0;&#x4E4E;&#x90FD;&#x6765;&#x81EA;<code>async_wrap</code>&#xFF0C;&#x901A;&#x8FC7; internalBinding &#x83B7;&#x53D6;&#x5230;&#x7684;&#x3002;</p>
<p>&#x65E2;&#x7136;&#x8FD9;&#x91CC;&#x7528;&#x7684;&#x662F;<code>internalBinding(String)</code>&#xFF0C;&#x5165;&#x53C2;&#x662F;&#x4E2A;string&#xFF0C;&#x518D;&#x52A0;&#x4E0A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x7136;&#x53EF;&#x4EE5;&#x731C;&#x6D4B; internalBinding &#x91CC;&#x9762;&#x8FD8;&#x6709;&#x8BB8;&#x591A;string&#x53EF;&#x4EE5;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x4E14;&#x53EF;&#x679A;&#x4E3E;&#x5B8C;&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x6CA1;&#x6709;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x4E3A;const&#x3001;enum&#x3001;&#x6216;&#x8005;symbol&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x806A;&#x660E;&#x7684;&#x4F60;&#x53BB;&#x89E3;&#x7B54;&#x4E86;&#xFF09;</p>
<p>&#x968F;&#x4FBF;&#x641C;&#x4E0B;&#xFF0C;&#x65E0;&#x6570;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x901A;&#x8FC7; <code>internalBinding</code>&#x83B7;&#x53D6;&#x5230;&#xFF0C;&#x731C;&#x6D4B;&#x9A8C;&#x8BC1;&#x7ED3;&#x675F;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e79cdd5ec76c51fed2f9131d9d1d63468dee25af205f5c74876aeec6d017630c" alt="image.png"></p>
<p>&#x4F46;&#x662F;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x9047;&#x5230;&#x4E00;&#x4E9B;&#x5C0F;&#x9EBB;&#x70E6;&#xFF0C;&#x56E0;&#x4E3A;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;<code>internalBinding</code>&#x5E76;&#x6CA1;&#x6709;&#x901A;&#x8FC7; <code>require()</code>&#x7684;&#x65B9;&#x5F0F;&#x5F15;&#x7528;&#x8FDB;&#x4EE3;&#x7801;&#xFF0C;command+&#x5DE6;&#x952E;&#x4E5F;&#x53EA;&#x80FD;&#x5230;&#x5B83;&#x7684;d.ts&#x5B9A;&#x4E49;&#x91CC;&#x9762;&#x3002;&#x611F;&#x89C9;&#x4F3C;&#x4E4E;&#x9677;&#x5165;&#x4E86;&#x6B7B;&#x80E1;&#x540C;&#x6216;&#x8005;&#x4EC0;&#x4E48;&#x9ED1;&#x9B54;&#x6CD5;&#x4E4B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// d.ts file</span><br><span class="line">declare function InternalBinding(binding: &apos;blob&apos;): {</span><br><span class="line">  createBlob(sources: Array&lt;Uint8Array | InternalBlobBinding.BlobHandle&gt;, length: number): InternalBlobBinding.BlobHandle;</span><br><span class="line">  FixedSizeBlobCopyJob: typeof InternalBlobBinding.FixedSizeBlobCopyJob;</span><br><span class="line">  getDataObject(id: string): [handle: InternalBlobBinding.BlobHandle | undefined, length: number, type: string] | undefined;</span><br><span class="line">  storeDataObject(id: string, handle: InternalBlobBinding.BlobHandle, size: number, type: string): void;</span><br><span class="line">  revokeDataObject(id: string): void;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p><a href="/external_links/94019a2c32ae2ec25e3db8f62529a519.html" target="blank" rel="noopener">github.com/nodejs/help&#x2026;</a></p>
<p>&#x7B80;&#x5355;&#x4E00;&#x641C;&#xFF0C;&#x5C31;&#x80FD;&#x641C;&#x5230;&#x95EE;&#x9898;&#x7684;&#x56DE;&#x7B54;&#xFF0C;&#x67F3;&#x6697;&#x82B1;&#x660E;&#x3002;&#xFF08;&#x5176;&#x5B9E;&#x5168;&#x5C40;&#x641C;&#x7D22;&#x4E5F;&#x80FD;&#x641C;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF09;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x6765;&#x5230;<code>lib/internal/bootstrap/loader.js</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line"></span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Set up internalBinding() in the closure.</span><br><span class="line">/**</span><br><span class="line"> * @type {InternalBinding}</span><br><span class="line"> */</span><br><span class="line">let internalBinding;</span><br><span class="line">{</span><br><span class="line">  const bindingObj = ObjectCreate(null);</span><br><span class="line">  // eslint-disable-next-line no-global-assign</span><br><span class="line">  internalBinding = function internalBinding(module) {</span><br><span class="line">    let mod = bindingObj[module];</span><br><span class="line">    if (typeof mod !== &apos;object&apos;) {</span><br><span class="line">      mod = bindingObj[module] = getInternalBinding(module);</span><br><span class="line">      ArrayPrototypePush(moduleLoadList, `Internal Binding ${module}`);</span><br><span class="line">    }</span><br><span class="line">    return mod;</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x662F;&#x7B80;&#x5316;&#x540E;&#x7684;&#x5907;&#x6CE8;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x52A0;&#x8F7D;&#x4E3A;&#x4E86; loader&#xFF0C;&#x65E2;&#x7136;&#x662F; loader &#x81EA;&#x7136;&#x8981; load &#x6587;&#x4EF6;&#xFF0C;load &#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<p>&#x7528;&#x4E8E; load built-in modules&#xFF08;&#x52A0;&#x8F7D;&#x5185;&#x90E8;&#x6A21;&#x5757;&#xFF09;&#x3002;&#x628A;C++&#x7684;&#x6A21;&#x5757;load&#x5230;js&#x91CC;&#x9762;&#x8FDB;&#x884C;&#x8C03;&#x7528;</p>
<p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;In line 30&#xFF0C;getInternalBinding &#x4E5F;&#x662F;&#x2018;&#x51ED;&#x7A7A;&#x2019;&#x51FA;&#x73B0;&#x7684;&#x3002;&#x81EA;&#x7136;&#x6211;&#x4EEC;&#x53BB;&#x641C;&#x4E0B;&#x4ED6;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c9646e201b380478add1555fb6f67723ad28add54181450934531e80a7de82de" alt="image.png"></p>
<p>&#x770B;&#x6765;&#xFF0C;getInternalBinding() &#x662F;&#x771F;&#x5728;js&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x627E;&#x4E0D;&#x5230;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x4E0D;&#x6765;&#x81EA;js&#x4E16;&#x754C;</p>
<p>Alright&#xFF0C;&#x606D;&#x559C;&#x4F60;&#xFF0C;&#x5230;&#x8FBE;C++&#x7684;&#x5730;&#x76D8;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4F7F;&#x7528; internalBinding() &#x5C06; async_wrap &#x4ECE;<code>async_wrap.cc</code>&#x52A0;&#x8F7D;&#x5230;&#x4E86; <code>async_wrap.js</code></p>
<p>&#x90A3; internalBinding &#x662F;&#x88AB;&#x5B9A;&#x4E49;&#x5728;&#x4E86; js &#x6587;&#x4EF6;&#x91CC;&#x9762;&#xFF0C;&#x53C8;&#x4E3A;&#x5565;&#x53EF;&#x4EE5;&#x88AB;&#x5168;&#x5C40;&#x8BBF;&#x95EE;&#x5230;&#xFF0C;&#x800C;&#x4E14;&#x6CA1;&#x4F7F;&#x7528; require&#x3002;&#x8FD9;&#x4E2A;&#x5728;&#x5907;&#x6CE8;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x89E3;&#x91CA;</p>
<blockquote>
<p><code>// This file is compiled as if it&apos;s wrapped in a function with arguments</code>  </p>
<p><code>// passed by node::RunBootstrapping()</code></p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x7F16;&#x8BD1;&#x4E86;&#xFF0C;&#x5C31;&#x50CF;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x4E00;&#x6837;&#x88AB;&#x4F20;&#x5165;<code>node::RunBootstrapping()</code>&#x8C03;&#x7528;&#x3002;&#x800C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Node&#x7684;<code>C++ built-in module</code>&#x7684;&#x542F;&#x52A8;&#x51FD;&#x6570;</p>
<h3 id="C-World"><a href="#C-World" class="headerlink" title="C++ World"></a>C++ World</h3><p>&#x6211;&#x4EEC;&#x56DE;&#x5230;&#x4E3B;&#x7EBF;&#xFF0C;&#x770B;&#x770B;<code>async_wrap</code>&#x5728;&#x505A;&#x4EC0;&#x4E48;&#xFF0C;&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p>&#x603B;&#x4E4B;&#xFF0C;<code>async_wrap</code>&#x88AB;<code>getInternalBinding</code>&#x7ED9;get&#x5230;&#x4E86;loader.js&#x91CC;&#x9762;&#xFF0C;&#x90A3;&#x6709;get&#x5C31;&#x4E00;&#x5B9A;&#x6709;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;set&#x6216;&#x8005;&#x8BF4;&#x6CE8;&#x518C;&#x3002;&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x653E;&#x5230;src&#x6587;&#x4EF6;&#x5939;&#x7684;&#x8FD9;&#x91CC;<code>src/async_wrap.cc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">// &#x8BE5;&#x6587;&#x4EF6;&#x7ED3;&#x5C3E;&#x5904;</span><br><span class="line">// &#x5728;node_binding.h&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x4E86;&#x5B8F;macro</span><br><span class="line">// #define NODE_MODULE_CONTEXT_AWARE_INTERNAL(modname, regfunc)</span><br><span class="line">NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize);  </span><br><span class="line">NODE_MODULE_EXTERNAL_REFERENCE(async_wrap, node::AsyncWrap::RegisterExternalReferences);</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8BE5;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x5C3E;&#x5904;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x8FD9;&#x4E2A;<code>&#x5B8F;(macro)</code>&#xFF0C;&#x6CE8;&#x518C;&#x4E86;<code>async_wrap</code>&#x3002;</p>
<p>&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x5728;&#x4EE3;&#x7801;&#x5C42;&#x9762;&#x56DE;&#x7B54;&#x4E86; <code>where set</code>async_wrap<code>is called</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;<code>&#x5185;&#x90E8;&#x6A21;&#x5757;(Internal Module)</code>&#x662F;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x6765;&#x66B4;&#x9732;&#x7ED9;js&#x4EE5;&#x4F5C;&#x8C03;&#x7528;&#x7684;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x7684; loader &#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;<code>getInternalBinding</code></p>
<p>&#x81F3;&#x4E8E;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x6DF1;&#x6316;&#x3002;</p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>-&gt; <code>NODE_MODULE_CONTEXT_AWARE_CPP</code> -&gt; &#x2026;</p>
<p>&#x81EA;&#x6B64;&#x5C0F;&#x7ED3;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;<code>async_wrap</code>&#x662F;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;<code>async_wrap</code>&#x7684;&#x884C;&#x4E3A;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x5B9A;&#x4E49;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;<code>async_wrap.cc</code>&#x5185;&#x90E8;&#x5728;&#x505A;&#x4EC0;&#x4E48;</p>
<p><strong>async_wrap.cc</strong></p>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x6709;700&#x884C;&#x5DE6;&#x53F3;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x5C31;&#x4E0D;&#x5168;&#x90E8;&#x8D34;&#x51FA;&#x6765;&#x4E86;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5728;&#x770B;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x731C;&#x4E0B;&#xFF0C;&#x4ED6;&#x5728;&#x5E72;&#x561B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x7684;&#x731C;&#x6D4B;&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x6765;&#x770B;&#xFF0C;&#x4ED6;&#x53EB;&#x505A; async wrap&#xFF0C;wrap&#x5C31;&#x662F;&#x628A;&#x6211;&#x4EEC;&#x7684;async call&#x7ED9;&#x5305;&#x4F4F;&#x4E86;&#xFF0C;&#x5305;&#x4F4F;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;&#x4EE3;&#x8868;async call&#x60F3;&#x505A;&#x4EC0;&#x4E48;&#x4E8B;&#xFF0C;&#x90FD;&#x5F97;&#x5148;&#x8FC7;&#x4E00;&#x5C42;&#x6211;wrap&#x518D;&#x8BF4;&#x3002;</p>
<p>&#x719F;&#x6089;&#x5417;&#xFF1F;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x8C13;&#x7684;&#x76D1;&#x542C;(listen)&#x3001;&#x52AB;&#x6301;(hijack)&#x3001;&#x5305;&#x88F9;(wrap)&#x3001;&#x76D1;&#x63A7;(monitor)&#xFF0C;&#x5927;&#x81F4;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x610F;&#x601D;&#x3002;wrap&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x70B9;&#x50CF;AOP&#xFF08;&#x9762;&#x5411;&#x5207;&#x9762;&#x7F16;&#x7A0B;&#xFF09;&#x3001;&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x3001;&#x4EE3;&#x7406;proxy&#x7B49;&#x4E1C;&#x897F;&#xFF0C;&#x90FD;&#x662F;&#x4E3B;&#x89C2;&#x4E0A;&#x7ED9;&#x4EBA;&#x4E00;&#x79CD;&#x5C42;(layer)&#x7684;&#x611F;&#x89C9;&#x3002;</p>
<p>&#x8BDD;&#x8BF4;&#x56DE;&#x6765;&#xFF0C;&#x5728;&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x5C31;&#x77E5;&#x9053;&#xFF0C;<code>libuv</code>&#x662F;&#x7528;C&#x5199;&#x7684;&#x5E93;&#xFF0C;&#x8D1F;&#x8D23;&#x5F02;&#x6B65;I/O&#x7B49;&#x5DE5;&#x4F5C;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x7684;&#x5C31;&#x731C;&#x6D4B;&#xFF0C;&#x4F60;&#x65E2;&#x7136;wrap&#x52AB;&#x6301;async call&#xFF0C;&#x90A3;&#x5177;&#x4F53;&#x662F;&#x52AB;&#x6301;&#x4EC0;&#x4E48;&#x5462;&#xFF0C;&#x591A;&#x534A;&#x5C31;&#x662F;&#x548C;libuv&#x7684;&#x4E1C;&#x897F;&#x6709;&#x5173;&#x4E86;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x548C;libuv&#x548C;&#x52AB;&#x6301;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5728;<code>async_wrap.cc</code>&#x4EE3;&#x7801;&#x5185;&#x90E8;&#x627E;&#x5230;<code>uv.h</code>&#x5934;&#x6587;&#x4EF6;&#xFF08;&#x4EE3;&#x8868;libuv&#xFF09;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x81F3;&#x5C11;libuv&#x6CA1;&#x6709;&#x88AB;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x3002;&#x4F46;&#x662F;&#x5927;&#x7684;&#x65B9;&#x5411;&#x4E0D;&#x4F1A;&#x9519;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x770B;libuv&#x5B98;&#x7F51;&#x6587;&#x6863;<a href="/external_links/2069550e1bd72141db50b5b89d29f779.html" target="blank" rel="noopener">docs.libuv.org/en/v1.x/api&#x2026;</a></p>
<p>&#x8FD9;&#x91CC;&#x91CC;&#x9762;&#x6709;&#x5927;&#x91CF;&#x53E5;&#x67C4;(handle)&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x5E95;&#x5C42;I/O&#x8D44;&#x6E90;&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;&#xFF0C;&#x4EE5;&#x53CA;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x901A;&#x77E5;&#x548C;&#x56DE;&#x8C03;</p>
<p><strong>&#x6CE8;&#x610F;&#x4E0B;&#x9762;&#x53EA;&#x662F;&#x731C;&#x60F3;&#xFF01;&#x4E0D;&#x662F;&#x5BF9;&#x7684;&#xFF01;</strong></p>
<p><strong>&#x731C;&#x60F3;1&#xFF1A;</strong></p>
<p>&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x7684; libuv &#x91CC;&#x8FD9;&#x4E2A;API&#x4E86;&#xFF0C;&#x7528;&#x4F5C;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x4E14;&#x62FF;&#x5230;&#x5F02;&#x6B65;&#x7684;&#x56DE;&#x8C03;&#x3002;</p>
<p>&#x4E24;&#x4E2A;&#x5E93;&#x5185;&#x90E8;&#x7684;&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x4E92;&#x76F8;&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E0D;&#x7B26;&#x5408;&#x89C4;&#x8303;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x88AB;&#x5305;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x5BF9;&#x5916;&#x7684;API&#x8FDB;&#x884C;&#x4EA4;&#x4E92;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC; <code>async_wrap</code> <code>&lt;---&gt;</code> <code>libuv</code> &#x8FD9;&#x79CD;&#x5173;&#x7CFB;&#x53EF;&#x4EE5;&#x62BD;&#x8C61;&#x4E3A;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x1F447;&#x1F3FB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/27f4e2f98ca15ebc9cec99dec11e17f5cae12cc5b6554a14547d8cb3298f8175" alt="image.png"></p>
<p><strong>&#x731C;&#x60F3;2&#xFF1A;</strong></p>
<p>AsyncWrap&#x4F5C;&#x4E3A;&#x57FA;&#x7C7B;&#xFF0C;&#x63D0;&#x4F9B;&#x5404;&#x79CD;&#x57FA;&#x7840;API&#x548C;JS&#x5C42;&#x4EA4;&#x4E92;&#x3002;&#x884D;&#x751F;&#x7684;&#x5B50;&#x7C7B;&#x548C; libuv &#x901A;&#x8FC7; uv_handle_t &#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x7531; libuv &#x901A;&#x77E5;&#x5B50;&#x7C7B;&#x53BB;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684; async hook</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x4E0B;&#x4E00;&#x7AE0;&#x770B;&#x770B;&#x731C;&#x6D4B;&#x662F;&#x5426;&#x6B63;&#x786E;</p>
<p>&#x6700;&#x540E;&#xFF0C;<code>libuv</code>&#x91CC;&#x9762;&#x7684;uv&#x4E0D;&#x662F;&#x6BCF;&#x65E5;&#x8BBF;&#x95EE;&#x91CF;UV&#xFF08;Unique Visitor&#xFF09;&#x6216;&#x8005;DAU&#xFF08;Daily Active User&#xFF09;&#xFF0C;&#x800C;&#x662F; Lib of Unicorn Velociraptor&#xFF08;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF09;&#x3002;&#x4F60;&#x95EE;&#x6211;&#x4E3A;&#x5565;&#x662F;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF0C;&#x56E0;&#x4E3A;&#x3002;&#x3002;&#x3002;&#x3002;&#x770B;&#x4ED6;&#x7684;logo&#x5427;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/67c7cea90f445928c63b97f391252389ef4a80b55ea349a67a57ab22c225cc36" alt="image.png"></p>
<h2 id="How-Is-AsyncHook-Init-Invoked-by-Node-Core"><a href="#How-Is-AsyncHook-Init-Invoked-by-Node-Core" class="headerlink" title="How Is AsyncHook.Init() Invoked by Node Core"></a>How Is AsyncHook.Init() Invoked by Node Core</h2><p>&#x4E3A;&#x4E86;&#x56DE;&#x7B54;&#x4E0A;&#x9762;&#x90A3;&#x4E2A;&#x731C;&#x60F3;&#xFF0C;&#x6211;&#x60F3;&#x6211;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECB;&#x7ECD;&#x4E0B; AsyncHook &#x7684; init &#x65B9;&#x6CD5;&#x662F;&#x5982;&#x4F55;&#x88AB; Node Core &#x8C03;&#x7528;&#x7684;</p>
<p>&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x628A; init &#x5B58;&#x5728;&#x4E86;&#x67D0;&#x4E2A;&#x5730;&#x65B9;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x4E00;&#x4E2A; async call &#x7684;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x4F1A;&#x88AB;&#x89E6;&#x53D1;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6709;&#x4E86;&#x4E0B;&#x9762;2&#x4E2A;&#x6B65;&#x9AA4;&#xFF1A;</p>
<h3 id="Step-1-where-is-callback-stored-in"><a href="#Step-1-where-is-callback-stored-in" class="headerlink" title="Step 1, where is callback stored in?"></a>Step 1, where is callback stored in?</h3><p>&#x4E0A;&#x4E00;&#x7AE0;&#x8BF4;&#x4E86;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; hook cb &#x88AB;&#x5B58;&#x5728;&#x4E86; AsyncHook Class &#x5BF9;&#x5E94;&#x7684; this[xxx_symbol] = xxx &#x91CC;&#x9762;&#xFF0C;&#x5728;&#x88AB; enable &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7; ArrayPrototypePush(hooks_array, this) &#x88AB; push &#x5230;&#x4E86; hooks_array&#x3002;</p>
<p>&#x8FD9;&#x4E2A; hooks_array &#x6765;&#x81EA; lib/internal/async_hooks.js&#xFF0C;&#x53EB;&#x505A; active_hooks&#xFF0C;&#x770B;&#x4E0B;&#x5B9A;&#x4E49;&#xFF0C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; object</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Properties in active_hooks are used to keep track of the set of hooks being</span><br><span class="line">// executed in case another hook is enabled/disabled. The new set of hooks is</span><br><span class="line">// then restored once the active set of hooks is finished executing.</span><br><span class="line">const active_hooks = {</span><br><span class="line">  // Array of all AsyncHooks that will be iterated whenever an async event</span><br><span class="line">  // fires. Using var instead of (preferably const) in order to assign</span><br><span class="line">  // active_hooks.tmp_array if a hook is enabled/disabled during hook</span><br><span class="line">  // execution.</span><br><span class="line">  array: [],</span><br><span class="line">  // Use a counter to track nested calls of async hook callbacks and make sure</span><br><span class="line">  // the active_hooks.array isn&apos;t altered mid execution.</span><br><span class="line">  call_depth: 0,</span><br><span class="line">  // Use to temporarily store and updated active_hooks.array if the user</span><br><span class="line">  // enables or disables a hook while hooks are being processed. If a hook is</span><br><span class="line">  // enabled() or disabled() during hook execution then the current set of</span><br><span class="line">  // active hooks is duplicated and set equal to active_hooks.tmp_array. Any</span><br><span class="line">  // subsequent changes are on the duplicated array. When all hooks have</span><br><span class="line">  // completed executing active_hooks.tmp_array is assigned to</span><br><span class="line">  // active_hooks.array.</span><br><span class="line">  tmp_array: null,</span><br><span class="line">  // Keep track of the field counts held in active_hooks.tmp_array. Because the</span><br><span class="line">  // async_hook_fields can&apos;t be reassigned, store each uint32 in an array that</span><br><span class="line">  // is written back to async_hook_fields when active_hooks.array is restored.</span><br><span class="line">  tmp_fields: null</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = {</span><br><span class="line">  executionAsyncId,</span><br><span class="line">  triggerAsyncId,</span><br><span class="line">  // Private API</span><br><span class="line">  getHookArrays,</span><br><span class="line">  symbols: {</span><br><span class="line">    async_id_symbol, trigger_async_id_symbol,</span><br><span class="line">    init_symbol, before_symbol, after_symbol, destroy_symbol,</span><br><span class="line">    promise_resolve_symbol, owner_symbol</span><br><span class="line">  },</span><br><span class="line">  // ..</span><br><span class="line">  executionAsyncResource,</span><br><span class="line">  // Internal Embedder API</span><br><span class="line">	// ...</span><br><span class="line">  nativeHooks: {  </span><br><span class="line">    init: emitInitNative, //  &lt;====== &#x770B;&#x8FD9;&#x91CC;</span><br><span class="line">    before: emitBeforeNative,</span><br><span class="line">    after: emitAfterNative,</span><br><span class="line">    destroy: emitDestroyNative,</span><br><span class="line">    promise_resolve: emitPromiseResolveNative</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A; lib/internal/async_hooks.js &#x6587;&#x4EF6;export&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x6709;&#x4E2A;&#x540D;&#x5B57;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#xFF0C;emitInitNative&#x3002;Native, Native&#xFF0C;&#x540D;&#x5B57;&#x91CC;&#x9762;&#x6709; Native&#xFF0C;&#x5B9E;&#x5728;&#x592A;&#x4E0D;&#x5BF9;&#x52B2;&#x4E86;&#x3002;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5B9E;&#x73B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Emit From Native //</span><br><span class="line"></span><br><span class="line">// Used by C++ to call all init() callbacks. Because some state can be setup</span><br><span class="line">// from C++ there&apos;s no need to perform all the same operations as in</span><br><span class="line">// emitInitScript.</span><br><span class="line">function emitInitNative(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">  active_hooks.call_depth += 1;</span><br><span class="line">  resource = lookupPublicResource(resource);</span><br><span class="line">  // Use a single try/catch for all hooks to avoid setting up one per iteration.</span><br><span class="line">  try {</span><br><span class="line">    // Using var here instead of let because &quot;for (var ...)&quot; is faster than let.</span><br><span class="line">    // Refs: https://github.com/nodejs/node/pull/30380#issuecomment-552948364</span><br><span class="line">    // eslint-disable-next-line no-var</span><br><span class="line">    for (var i = 0; i &lt; active_hooks.array.length; i++) {</span><br><span class="line">      if (typeof active_hooks.array[i][init_symbol] === &apos;function&apos;) {</span><br><span class="line">        active_hooks.array[i][init_symbol](</span><br><span class="line">          asyncId, type, triggerAsyncId,</span><br><span class="line">          resource</span><br><span class="line">        );</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  } catch (e) {</span><br><span class="line">    fatalError(e);</span><br><span class="line">  } finally {</span><br><span class="line">    active_hooks.call_depth -= 1;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // Hooks can only be restored if there have been no recursive hook calls.</span><br><span class="line">  // Also the active hooks do not need to be restored if enable()/disable()</span><br><span class="line">  // weren&apos;t called during hook execution, in which case active_hooks.tmp_array</span><br><span class="line">  // will be null.</span><br><span class="line">  if (active_hooks.call_depth === 0 &amp;&amp; active_hooks.tmp_array !== null) {</span><br><span class="line">    restoreActiveHooks();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7; comment &#x8BC1;&#x660E;&#x4E86;&#xFF0C;emitInitNative &#x786E;&#x5B9E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x88AB; native &#x8C03;&#x7528;&#xFF08;C++&#xFF09;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x8DEF;&#x5B58;&#x4E0B;&#x6765;&#x7684; active_hooks &#x4F1A;&#x5728; line 18 &#x91CC;&#x9762;&#xFF0C;&#x5728;js&#x5C42;&#x88AB;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540C;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x7684; before, after &#x7B49;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x56DE;&#x7B54;&#x4E86;&#x6807;&#x9898;&#xFF0C;callback&#x662F;&#x5B58;&#x5728;&#x54EA;&#x91CC;&#x5E76;&#x88AB;&#x6267;&#x884C;&#x7684;</p>
<p>&#x5148;&#x522B;&#x6025;&#x7740;&#x8D70;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x5DEE;&#x4E00;&#x4EF6;&#x4E8B;&#xFF0C;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x628A;&#x8FD9;&#x4E2A; js &#x7684;&#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9;&#x6211;&#x4EEC;&#x7684; native &#x5C42;&#xFF1F;&#x5728;&#x8FD9;&#x91CC;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap.js</span><br><span class="line"></span><br><span class="line">const { nativeHooks } = require(&apos;internal/async_hooks&apos;);</span><br><span class="line">internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</span><br></pre></td></tr></table></figure>

<p>&#x795E;&#x79D8;&#x7684;&#xFF0C;&#x4ECE;C++&#x5C42;&#x6765;&#x7684; async_wrap &#x8D1F;&#x8D23;&#x628A;&#x6211;&#x4EEC;&#x7684; nativeHooks &#x6CE8;&#x518C;&#x5230;c++&#x3002;OK&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F; setupHooks is responsible for registering nativeHooks &#x5373;&#x53EF;</p>
<h3 id="Step-2-which-code-line-is-responsible-for-calling-init-callback"><a href="#Step-2-which-code-line-is-responsible-for-calling-init-callback" class="headerlink" title="Step 2, which code line is responsible for calling init callback?"></a>Step 2, which code line is responsible for calling init callback?</h3><p>&#x5148;&#x8BF4;&#x7ED3;&#x8BBA;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; async call &#x90FD;&#x4F1A;&#x7531;&#x4E00;&#x4E2A; C++ &#x7684;&#x7C7B;&#x53EB;&#x505A; AsyncWrap &#x6765;&#x5305;&#x88C5;&#xFF0C;&#x5730;&#x5740;&#x5728; src/async_wrap.cc</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x628A; async_wrap &#x66B4;&#x9732;&#x51FA;&#x53BB;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x6765;&#x770B;<code>Initialize</code></p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize)</code></p>
<p><strong>Initialize</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::Initialize(Local&lt;Object&gt; target,</span><br><span class="line">                           Local&lt;Value&gt; unused,</span><br><span class="line">                           Local&lt;Context&gt; context,</span><br><span class="line">                           void* priv) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(context);</span><br><span class="line">  Isolate* isolate = env-&gt;isolate();</span><br><span class="line">  HandleScope scope(isolate);</span><br><span class="line"></span><br><span class="line">  env-&gt;SetMethod(target, &quot;setupHooks&quot;, SetupHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setCallbackTrampoline&quot;, SetCallbackTrampoline);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;pushAsyncContext&quot;, PushAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;popAsyncContext&quot;, PopAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;executionAsyncResource&quot;, ExecutionAsyncResource);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;clearAsyncIdStack&quot;, ClearAsyncIdStack);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;queueDestroyAsyncId&quot;, QueueDestroyAsyncId);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setPromiseHooks&quot;, SetPromiseHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;registerDestroyHook&quot;, RegisterDestroyHook);</span><br><span class="line"></span><br><span class="line">  PropertyAttribute ReadOnlyDontDelete =</span><br><span class="line">      static_cast&lt;PropertyAttribute&gt;(ReadOnly | DontDelete);</span><br><span class="line">  // ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5148;&#x89E3;&#x91CA;&#x51E0;&#x4E2A;&#x57FA;&#x672C;&#x6982;&#x5FF5;&#x548C;&#x6570;&#x636E;&#x7C7B;&#x578B;:</p>
<ul>
<li><strong>Isolate</strong>: line 8 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728; <code>v8.h</code>&#x3002;Isolate&#x662F;V8&#x5F15;&#x64CE;&#x7684;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x5B9E;&#x4F8B;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;JavaScript&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x8FD0;&#x884C;&#x5728;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5185;&#x5B58;&#x5806;&#x3001;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x548C;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Isolate&#xFF0C;&#x6BCF;&#x4E2A;Isolate&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#xFF0C;&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x8FD0;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;</li>
<li><strong>Context</strong>: line 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;Context&#x8868;&#x793A;Isolate&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;JavaScript&#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x542B;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x53D8;&#x91CF;&#x3001;&#x51FD;&#x6570;&#x548C;&#x5176;&#x4ED6;&#x6570;&#x636E;&#x3002;Context&#x5728;Isolate&#x4E2D;&#x521B;&#x5EFA;&#xFF0C;&#x5E76;&#x4E0E;&#x7279;&#x5B9A;&#x7684;&#x6267;&#x884C;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;&#x8054;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x5355;&#x4E2A;Isolate&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Context&#xFF0C;&#x6BCF;&#x4E2A;Context&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x6267;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x77E5;&#x7684; <code>vm.createContext()</code>&#x4E5F;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; Context &#x5B9E;&#x4F8B;&#x3002;</li>
<li><strong>Local</strong>: lin 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;&#x5728; V8 &#x5F15;&#x64CE;&#xFF08;Node.js &#x7684; JavaScript &#x5F15;&#x64CE;&#xFF09;&#x4E2D;&#xFF0C;&#x7528;&#x4E8E;&#x8868;&#x793A; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#xFF08;Handle&#xFF09;</li>
</ul>
<ul>
<li><ul>
<li>&#x770B;&#x4E0B;&#x539F;&#x6587;&#x63CF;&#x8FF0;&#xFF1A;<code>An object reference managed by the v8 garbage collector. All objects returned from v8 have to be tracked by the garbage collector so that it knows that the objects are still alive</code>&#x3002;<ul>
<li>&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6307;&#x9488;&#xFF0C;&#x4F46;&#x662F;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4F1A;&#x968F;&#x7740;GC&#xFF08;garbage collection&#xFF09;&#x800C;&#x53D8;&#x5316;&#xFF0C;&#x786E;&#x4FDD;&#x603B;&#x662F;&#x6307;&#x5411;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x503C;&#xFF0C;&#x540C;&#x65F6;&#x7BA1;&#x7406;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x88AB;&#x6E05;&#x7406;&#x3002;</li>
<li>Local &#x53E5;&#x67C4;&#x662F;&#x4E00;&#x79CD;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#xFF0C;&#x5B83;&#x5728; V8 &#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x662F;&#x6709;&#x9650;&#x7684;&#x3002;&#x5F53; V8 &#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x56DE;&#x6536;&#x65F6;&#xFF0C;Local &#x53E5;&#x67C4;&#x6240;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x6E05;&#x7406;&#x3002;Local&#x5C31;&#x4EE3;&#x8868;&#x4E00;&#x4E2A;V8 Context &#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#x3002;&#x9664;&#x4E86;&#x672C;&#x5730;&#x53E5;&#x67C4;Local&#xFF0C;&#x8FD8;&#x6709;MaybeLocal&#xFF0C;Eternal&#x7B49;&#x7C7B;&#x578B;&#x3002;</li>
<li>line 9 &#x4E2D;&#x7684; HandleScope &#x4E5F;&#x662F;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x53E5;&#x67C4;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Environment</strong>: line 7 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>src/env.h</code>&#x3002;&#x5728; Node.js &#x7684; C++ &#x5C42;&#x9762;&#xFF0C;Environment &#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x548C;&#x7EF4;&#x62A4; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x548C;&#x8D44;&#x6E90;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x6865;&#x6881;&#xFF0C;&#x8BA9; Node.js &#x7684; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;Environment &#x7C7B;&#x5C01;&#x88C5;&#x4E86;&#x8BB8;&#x591A;&#x4E0E; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x4EE5;&#x4E0B;&#x662F; Environment &#x7C7B;&#x7684;&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x804C;&#x8D23;&#xFF1A;</li>
</ul>
<ul>
<li><ul>
<li>&#x7BA1;&#x7406; V8 Isolate &#x5B9E;&#x4F8B;&#xFF1A;Isolate &#x662F; V8 &#x5F15;&#x64CE;&#x4E2D;&#x8868;&#x793A;&#x72EC;&#x7ACB;&#x7684; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x4E00;&#x4E2A; Environment &#x5B9E;&#x4F8B;&#x4E0E;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684; Isolate &#x5B9E;&#x4F8B;&#x5173;&#x8054;&#xFF0C;&#x5B83;&#x4EEC;&#x5171;&#x540C;&#x6784;&#x6210;&#x4E86; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x3002;<ul>
<li>&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF1A;Environment &#x7C7B;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x4E0E;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x5982;&#x5BF9;&#x8C61;&#x53E5;&#x67C4;&#x3001;&#x7F13;&#x51B2;&#x533A;&#x7B49;&#x3002;&#x901A;&#x8FC7;&#x521B;&#x5EFA; V8 HandleScope &#x548C; EscapableHandleScope &#x5B9E;&#x4F8B;&#xFF0C;Environment &#x80FD;&#x786E;&#x4FDD; V8 &#x80FD;&#x6B63;&#x786E;&#x5730;&#x7BA1;&#x7406; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</li>
<li>&#x4E0E; JavaScript &#x5C42;&#x7684;&#x4E92;&#x64CD;&#x4F5C;&#xFF1A;Environment &#x7C7B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x5305;&#x62EC;&#x8BBE;&#x7F6E; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x65B9;&#x6CD5;&#x3001;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7B49;&#x3002;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>OK&#xFF0C;&#x57FA;&#x4E8E;&#x6B64;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x5728; line 7&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; Environment::GetCurrent(context) &#x83B7;&#x53D6;&#x5230;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x7684; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x5728;line 11&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x6307;&#x9488;&#x6240;&#x6307;&#x7684;&#x65B9;&#x6CD5; SetMethod&#xFF0C;&#x8BB2;&#x6211;&#x4EEC;&#x7684; SetupHooks &#x7ED1;&#x5B9A;&#x5230;&#x4E0A;&#x4E00;&#x8282;&#x63D0;&#x5230;&#x8FC7;&#x7684; <code>internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</code></p>
<p>&#x90A3; SetupHooks &#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p><strong>SetupHooks</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">static void SetupHooks(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(args);</span><br><span class="line"></span><br><span class="line">  CHECK(args[0]-&gt;IsObject());</span><br><span class="line"></span><br><span class="line">  // All of init, before, after, destroy, and promise_resolve are supplied by</span><br><span class="line">  // async_hooks internally, so this should only ever be called once. At which</span><br><span class="line">  // time all the functions should be set. Detect this by checking if</span><br><span class="line">  // init !IsEmpty().</span><br><span class="line">  CHECK(env-&gt;async_hooks_init_function().IsEmpty());</span><br><span class="line"></span><br><span class="line">  Local&lt;Object&gt; fn_obj = args[0].As&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">#define SET_HOOK_FN(name)                                                      \</span><br><span class="line">  do {                                                                         \</span><br><span class="line">    Local&lt;Value&gt; v =                                                           \</span><br><span class="line">        fn_obj-&gt;Get(env-&gt;context(),                                            \</span><br><span class="line">                    FIXED_ONE_BYTE_STRING(env-&gt;isolate(), #name))              \</span><br><span class="line">            .ToLocalChecked();                                                 \</span><br><span class="line">    CHECK(v-&gt;IsFunction());                                                    \</span><br><span class="line">    env-&gt;set_async_hooks_##name##_function(v.As&lt;Function&gt;());                  \</span><br><span class="line">  } while (0)</span><br><span class="line"></span><br><span class="line">  SET_HOOK_FN(init);</span><br><span class="line">  SET_HOOK_FN(before);</span><br><span class="line">  SET_HOOK_FN(after);</span><br><span class="line">  SET_HOOK_FN(destroy);</span><br><span class="line">  SET_HOOK_FN(promise_resolve);</span><br><span class="line">#undef SET_HOOK_FN</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x662F;&#x83B7;&#x53D6; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x786E;&#x4FDD; args[0] &#x662F;&#x4E00;&#x4E2A; Objext&#xFF0C;&#x540C;&#x65F6; async_hooks_init_function &#x662F; empty&#xFF0C;&#x786E;&#x4FDD;&#x53EA;&#x4F1A;&#x88AB;&#x521D;&#x59CB;&#x5316;1&#x6B21;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x5B9A;&#x4E49;&#x4E86; SET_HOOK_FN &#x8FD9;&#x4E2A;&#x5B8F;(marco)&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x5B8F;&#xFF0C;&#x5C06; init &#x65B9;&#x6CD5;&#x7ED1;&#x5B9A;&#x5230;&#x89E6;&#x53D1;&#x51FD;&#x6570;</p>
<p><code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>##name## &#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;init&#x3001;before&#x3001;after&#x3001;destroy&#x53D8;&#x91CF;&#xFF0C;&#x2018;#&#x2019; &#x548C; &#x2018;##&#x2019; &#x8BED;&#x6CD5;&#x7528;&#x4E8E; C/C++ &#x4E2D;&#x7684; macro &#x547D;&#x4EE4;&#x3002;&#x6700;&#x540E;&#x7684; #undef &#x4F7F;&#x7528;&#x662F;&#x53BB;&#x6389;&#x5B8F;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x6B64;&#x5B8F;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5728; AsyncWrap::EmitAsyncInit &#x4E2D;&#x8C03;&#x7528;</p>
<p><strong>EmitAsyncInit</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::EmitAsyncInit(Environment* env,</span><br><span class="line">                              Local&lt;Object&gt; object,</span><br><span class="line">                              Local&lt;String&gt; type,</span><br><span class="line">                              double async_id,</span><br><span class="line">                              double trigger_async_id) {</span><br><span class="line">  CHECK(!object.IsEmpty());</span><br><span class="line">  CHECK(!type.IsEmpty());</span><br><span class="line">  AsyncHooks* async_hooks = env-&gt;async_hooks();</span><br><span class="line"></span><br><span class="line">  // Nothing to execute, so can continue normally.</span><br><span class="line">  if (async_hooks-&gt;fields()[AsyncHooks::kInit] == 0) {</span><br><span class="line">    return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  HandleScope scope(env-&gt;isolate());</span><br><span class="line">  Local&lt;Function&gt; init_fn = env-&gt;async_hooks_init_function();</span><br><span class="line"></span><br><span class="line">  Local&lt;Value&gt; argv[] = {</span><br><span class="line">    Number::New(env-&gt;isolate(), async_id),</span><br><span class="line">    type,</span><br><span class="line">    Number::New(env-&gt;isolate(), trigger_async_id),</span><br><span class="line">    object,</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);</span><br><span class="line">  USE(init_fn-&gt;Call(env-&gt;context(), object, arraysize(argv), argv));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// location: v8.h</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A JavaScript function object (ECMA-262, 15.3).</span><br><span class="line"> */</span><br><span class="line">class V8_EXPORT Function : public Object {}</span><br></pre></td></tr></table></figure>

<p>set the fn: <code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>get the corresponding fn: <code>env -&gt; async_hooks_init_function()</code></p>
<p>&#x5728; line 18&#xFF0C;&#x6211;&#x4EEC;&#x83B7;&#x5F97;&#x4E86;&#x4E4B;&#x524D;&#x6CE8;&#x518C;&#x7684; init&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A; Local &#x53E5;&#x67C4;&#xFF0C;Local &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411; js &#x7684; function &#x7684;&#x53E5;&#x67C4;&#xFF0C;&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; line 28 &#x7684; init_fn -&gt; Call() &#x53EF;&#x4EE5;&#x6765;&#x89E6;&#x53D1; js &#x51FD;&#x6570;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x8BF4;&#x5B8C;&#x4E86;&#x4E00;&#x4E2A; Async Init Hook &#x662F;&#x5982;&#x4F55;&#x88AB;&#x5B8C;&#x6574;&#x8C03;&#x7528;&#x7684;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x56DE;&#x987E;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x7B97;&#x662F;&#x662F;&#x4E00;&#x4E2A;&#x5C0F;&#x7ED3;</p>
<h2 id="Sum-Up-High-Level-Overview-Flowchart"><a href="#Sum-Up-High-Level-Overview-Flowchart" class="headerlink" title="Sum Up: High-Level Overview Flowchart"></a>Sum Up: High-Level Overview Flowchart</h2><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/7b9f597c2442a81082bc6816d805b2904396ed0c8f013427bf43cca69f7b9a81" alt="image.png"></p>
<ul>
<li>API&#xFF1A;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x66B4;&#x9732;&#x4E86;&#x8FD9;3&#x4E2A;&#x91CD;&#x8981;&#x7684;API</li>
<li>Node Core - Native JS Module:</li>
</ul>
<pre><code>+ &#x4E0A;&#x9762;&#x7684;3&#x4E2A;API&#x6765;&#x81EA;async\_hooks.js&#x4E2D;&#x7684;3&#x4E2A;&#x7C7B;&#xFF1A;AsyncLocalStorage/AsyncResource/AsyncHook
+ AsyncHook&#x8D1F;&#x8D23;&#x6CE8;&#x518C;4&#x4E2A;&#x9636;&#x6BB5;&#x7684;Callback function
+ &#x5728;&#x8FD9;&#x91CC;&#x901A;&#x8FC7; internalBinding(&apos;async\_wrap&apos;) &#x83B7;&#x5F97;C++&#x5C42;&#x7684; AsyncWrap</code></pre><ul>
<li>Node Core - C++ Binding:</li>
</ul>
<pre><code>+ &#x5728; async\_wrap.cc &#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x5173;&#x952E;&#x7684;&#x57FA;&#x7C7B; `AsyncWrap`&#xFF0C;&#x5B83;&#x7EE7;&#x627F;&#x81EA; `BaseObject`
+ &#x901A;&#x8FC7; NODE\_MODULE\_CONTEXT\_AWARE\_INTERNAL &#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9; JS &#x5C42;
+ AsyncWrap&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x7C7B;&#x3002;UPDWrap&#x3001;TCPWrap&#x3001;FSEventWrap&#x7B49;&#x76F4;&#x63A5;&#x6216;&#x95F4;&#x63A5;&#x7EE7;&#x627F;&#x8005;&#x5B83;&#xFF0C;&#x4E3A;&#x5404;&#x79CD; Wrap &#x63D0;&#x4F9B;&#x8D1F;&#x8D23;&#x89E6;&#x53D1;Hook&#x56DE;&#x8C03;&#x7684;&#x65B9;&#x6CD5;&#x3002;
    - &#x6BD4;&#x5982; TCPWrap -&gt; ConnectionWrap -&gt; LibuvStreamWrap -&gt; HandleWrap -&gt; AsyncWrap
    - libuv&#x7684;&#x65B9;&#x6CD5;&#x5728;&#x5177;&#x4F53;&#x7684; Wrap &#x91CC;&#x9762;&#x8C03;&#x7528;&#x3002;
        * &#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A; TCP &#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x53D1;&#x51FA;&#x65F6;&#xFF0C;&#x4F1A;&#x6267;&#x884C; new TCPWrap&#xFF0C;&#x901A;&#x8FC7; uv\_tcp\_connect() &#x53D1;&#x8D77;&#x94FE;&#x63A5;&#xFF08;&#x65B9;&#x6CD5;&#x6765;&#x81EA;libuv&#xFF09;&#xFF1B;
        * &#x94FE;&#x63A5;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x53E5;&#x67C4;&#xFF08;uv\_tcp\_t&#xFF09;&#xFF0C;&#x5BF9; libuv &#x4FDD;&#x6301;&#x8BBF;&#x95EE;&#x3002;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x53E5;&#x67C4;&#x7C7B;&#x578B;&#x4F1A;&#x88AB;&#x8F6C;&#x53D8; uv\_tcp\_t -&gt; uv\_stream\_t
        * &#x5F53;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x65F6;&#x5019;&#xFF0C; TCPHandle &#x5BF9;&#x8C61;&#x4F1A;&#x89E6;&#x53D1; uv\_\_stream\_io() &#x65B9;&#x6CD5;&#x53BB;&#x6267;&#x884C; uv\_\_read()&#xFF0C;&#x6700;&#x7EC8;&#x901A;&#x77E5; TCPWrap &#x6216;&#x8005;&#x5176;&#x7236;&#x7C7B;&#x6267;&#x884C;&#x56DE;&#x8C03;
+ src/api &#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x7ED9;&#x4E09;&#x65B9;addons&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;API&#xFF0C;&#x5176;&#x4E2D;AsyncResource&#x662F;&#x57FA;&#x4E8E;AsyncWrap&#x7684;&#x5C01;&#x88C5;&#xFF0C;AsyncWrap&#x89E6;&#x53D1;before&#x548C;after&#x7684;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x662F;&#x901A;&#x8FC7; AsyncWrap::MakeCallback &#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x8C03;&#x7528; CallbackScope &#x5185;&#x90E8;&#x7684; InternalMakeCallback</code></pre><ul>
<li>Deps:</li>
</ul>
<pre><code>+ Libuv: &#x5BF9;I/O&#x5F02;&#x6B65;&#x3001;&#x7F51;&#x7EDC;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x8D1F;&#x8D23;
+ V8: &#x5BF9;Promise &#x548C; async/await &#x8BED;&#x6CD5;&#x8D1F;&#x8D23;
+ &#x6700;&#x7EC8;&#x901A;&#x8FC7; AsyncWrap &#x901A;&#x77E5;&#x5230; JS &#x5C42;&#x7684; AsyncHook</code></pre><h2 id="Add-On"><a href="#Add-On" class="headerlink" title="Add-On"></a>Add-On</h2><p>&#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x4E9B;&#x6536;&#x96C6;&#x8D44;&#x6599;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x73B0;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x548C;&#x5F69;&#x86CB;&#xFF0C;&#x5206;&#x4EAB;&#x7ED9;&#x5927;&#x5BB6;</p>
<p><strong>Performance Improvement</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/294ec9faacde0f406b4d878df7baa70ca35b2dd6aacba5ff8e92d15af29fdbad" alt="image.png"></p>
<p><a href="/external_links/4785ad23bbb7e952c4771db1818ea44a.html" target="blank" rel="noopener">PR&#xFF1A;async_hooks: use resource stack for AsyncLocalStorage run #39890</a></p>
<p>&#x5173;&#x952E;&#x5B57;&#xFF1A;</p>
<ul>
<li>using stack instead of AsyncResouce instance</li>
<li>eliminate extra lifecycle event</li>
</ul>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x6267;&#x884C;<code>AsyncLocalStorage.run</code>&#x7684;&#x65F6;&#x5019;&#x6709;&#x4E2A; commit log&#xFF0C;&#x8FD9;&#x6B21;&#x7684; PR &#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x5347;&#x6027;&#x80FD;</p>
<p><strong>PromiseHook</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f728b446fc8621087f2a0190c1cb7d893fcf3cb3f77dbcb0c8127ab08824abe5" alt="image.png"></p>
<p><a href="/external_links/16fe0b66fa48442349ec71a97786b483.html" target="blank" rel="noopener">PR: async_hooks: fast-path for PromiseHooks in JS #32891</a></p>
<p>&#x53C8;&#x662F;&#x8FD9;&#x4E2A;&#x54E5;&#x4EEC;&#x3002;</p>
<p>&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5F69;&#x86CB;&#x3002;Reviewed-By: Chengzhong Wu</p>
<p>&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x660E;&#x660E;&#x88AB;&#x5173;&#x95ED;&#x7684;PR&#xFF1F;&#x4EE3;&#x7801; commit &#x5374;&#x51FA;&#x73B0;&#x4E86;&#x5728;&#x4E86; Node v16.18&#xFF1F;&#x56E0;&#x4E3A;Node&#x53D1;&#x7248;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x4E0D;&#x4F7F;&#x7528;Github&#x7684;PR&#xFF0C;&#x6709;&#x4E00;&#x5957;&#x81EA;&#x5DF1;&#x7684;&#x6D41;&#x7A0B;&#xFF09;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0799228bb37158f0fcedcbed7bb168f85f5fefaf667bc7d5a943bc229a49ef6e" alt="image.png"></p>
<p><strong>How is loader created</strong></p>
<p>&#x8FD9;&#x91CC;&#x653E;&#x4E0B; <code>lib/internal/bootstrap/loader.js</code>&#x6587;&#x4EF6;&#x7684;&#x5B8C;&#x6574;&#x5907;&#x6CE8;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x5206;&#x60C5;&#x51B5;&#x8BA8;&#x8BBA;&#x4E86;<code>require</code>&#x8BED;&#x6CD5;&#x91CC;&#x62FF;&#x5230;&#x7684;&#x5404;&#x79CD;&#x5BF9;&#x8C61;&#x662F;&#x600E;&#x4E48;&#x88AB;&#x52A0;&#x8F7D;&#x8FDB;&#x53BB;&#x7684;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x628A;&#x6587;&#x6863;&#x7684;&#x6CE8;&#x91CA;&#x8BFB;&#x5B8C;&#xFF0C;&#x6574;&#x4E2A; loader &#x8FD9;&#x4E00;&#x5C42;&#x5C31;&#x4F1A;&#x6E05;&#x695A;&#x5F88;&#x591A;&#x3002;&#x6240;&#x4EE5;&#x975E;&#x5E38;&#x559C;&#x6B22; Node &#x7684;&#x4E30;&#x5BCC;&#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line">//</span><br><span class="line">// This file is compiled and run by node.cc before bootstrap/node.js</span><br><span class="line">// was called, therefore the loaders are bootstrapped before we start to</span><br><span class="line">// actually bootstrap Node.js. It creates the following objects:</span><br><span class="line">//</span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - process.binding(): the legacy C++ binding loader, accessible from user land</span><br><span class="line">//   because it is an object attached to the global process object.</span><br><span class="line">//   These C++ bindings are created using NODE_BUILTIN_MODULE_CONTEXT_AWARE()</span><br><span class="line">//   and have their nm_flags set to NM_F_BUILTIN. We do not make any guarantees</span><br><span class="line">//   about the stability of these bindings, but still have to take care of</span><br><span class="line">//   compatibility issues caused by them from time to time.</span><br><span class="line">// - process._linkedBinding(): intended to be used by embedders to add</span><br><span class="line">//   additional C++ bindings in their applications. These C++ bindings</span><br><span class="line">//   can be created using NODE_MODULE_CONTEXT_AWARE_CPP() with the flag</span><br><span class="line">//   NM_F_LINKED.</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line">//</span><br><span class="line">// Internal JavaScript module loader:</span><br><span class="line">// - NativeModule: a minimal module system used to load the JavaScript core</span><br><span class="line">//   modules found in lib/**/*.js and deps/**/*.js. All core modules are</span><br><span class="line">//   compiled into the node binary via node_javascript.cc generated by js2c.py,</span><br><span class="line">//   so they can be loaded faster without the cost of I/O. This class makes the</span><br><span class="line">//   lib/internal/*, deps/internal/* modules and internalBinding() available by</span><br><span class="line">//   default to core modules, and lets the core modules require itself via</span><br><span class="line">//   require(&apos;internal/bootstrap/loaders&apos;) even when this file is not written in</span><br><span class="line">//   CommonJS style.</span><br><span class="line">//</span><br><span class="line">// Other objects:</span><br><span class="line">// - process.moduleLoadList: an array recording the bindings and the modules</span><br><span class="line">//   loaded in the process and the order in which they are loaded.</span><br><span class="line"></span><br><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br></pre></td></tr></table></figure>

<p><strong>The Workflow of Node.js Startup</strong></p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">leezhenghui.github.io/node.js/201&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f845a06ae4ed9ff595b40092d9a927218ff167b7fbcdcd18780185984495a126" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/b2601115c384c4f09a83168693bc45d3e48d30675afc17f1cffdfb2f34b4c430" alt></p>
<p>&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#x7684; loader &#x5C31;&#x662F;&#x5728; LoadEnv &#x9636;&#x6BB5;&#x88AB;&#x6267;&#x884C;&#x7684;&#x3002;</p>
<p>&#x800C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BA8;&#x8BBA;&#x7684; AsyncHook &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5C31;&#x5728;&#x4E0A;&#x9762;&#x7684; [node native module] - [node-core(c/c++)] &#x4E24;&#x5C42;&#x4E4B;&#x95F4;</p>
<p>&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x539F;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x975E;&#x5E38;&#x8BE6;&#x7EC6;&#x5F97;&#x4ECB;&#x7ECD;&#x4E86; Node&#xFF0C;&#x540D;&#x5B57;&#x4E5F;&#x5F88;&#x6709;&#x610F;&#x601D; <a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">&#x300A;Demystify node.js - Modularization&#x300B;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c373a20c3aed76aa8b06ab581ff052ece9b5ff0870ddcb706e3ad11538bcaf4d" alt="image.png"></p>
<h1 id="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"><a href="#&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;" class="headerlink" title="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"></a>&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;</h1><p>&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x60F3;&#x6CD5;&#x975E;&#x5E38;&#x7A81;&#x7136;&#x3002;&#x5927;&#x6982;&#x662F;2&#x6708;&#x521D;&#xFF0C;&#x541E;&#x541E;&#x8001;&#x5E08;&#x5728;&#x7FA4;&#x91CC;&#x5206;&#x4EAB;&#x4E86;&#x5173;&#x4E8E; AsyncContext &#x63D0;&#x6848;&#x8FDB;&#x5165; Stage1 &#x7684;&#x6D88;&#x606F;&#xFF0C;&#x5C31;&#x7784;&#x4E86;&#x4E00;&#x773C;&#x53D1;&#x73B0;&#x770B;&#x4E0D;&#x61C2;&#xFF0C;&#x4E8E;&#x662F;&#x5728;&#x5927;&#x7FA4;&#x91CC;&#x6C42;&#x6559;&#x3002;</p>
<p>&#x540E;&#x6765;&#xFF0C;&#x4E86;&#x89E3;&#x5230;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x548C;Node&#x4E2D;&#x7684;&#x4E00;&#x4E9B;API&#x7C7B;&#x4F3C;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x5F00;&#x59CB;&#x6162;&#x6162;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#x7684;&#x80CC;&#x666F;&#xFF0C;&#x5FC3;&#x91CC;&#x60F3;&#x7740;&#x90FD;&#x6574;&#x7406;&#x4E86;&#x4E9B;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5199;&#x7BC7;&#x6587;&#x7AE0;&#x603B;&#x7ED3;&#x4E0B;&#x5427;&#x3002;&#x4F46;&#x662F;&#x5149;&#x4ECB;&#x7ECD; API &#x548B;&#x7528;&#x7531;&#x6709;&#x70B9;&#x6D45;&#xFF0C;&#x5B98;&#x7F51;&#x6587;&#x6863;&#x4E5F;&#x6709;&#xFF0C;&#x4E8E;&#x662F;&#x6240;&#x5E78;&#x68B3;&#x7406;&#x4E0B;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x3002;&#x540E;&#x6765;&#x611F;&#x89C9;&#xFF0C;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x90FD;&#x770B;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x4E5F;&#x4E00;&#x628A;&#x68AD;&#x5427;&#xFF0C;&#x51B5;&#x4E14;&#x8981;&#x5199;&#x5C31;&#x8D28;&#x91CF;&#x5199;&#x9AD8;&#x70B9;&#x561B;&#xFF0C;&#x6B63;&#x597D;&#x501F;&#x8FD9;&#x4E2A;&#x673A;&#x4F1A;&#x518D;&#x4E86;&#x89E3;&#x4E0B;Node&#xFF0C;&#x4E8E;&#x662F;&#xFF0C;&#x4FBF;&#x6709;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x8270;&#x96BE;&#x7684;&#xFF0C;&#x8FB9;&#x731C;&#x8FB9;&#x5B66;&#x8FB9;&#x5199;&#x3002;&#x96BE;&#x70B9;&#x6709;&#x4E8C;&#xFF0C;&#x96BE;&#x70B9;&#x4E4B;&#x4E00;&#xFF0C;&#x662F;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x5BF9;&#x6211;&#x6709;&#x4E00;&#x5B9A;&#x96BE;&#x5EA6;&#xFF1B;&#x4ECE;&#x4E00;&#x4E2A;&#x70B9;&#x5207;&#x5165;&#x8FDB;&#x5165;&#xFF08;&#x4E00;&#x4E2A;API&#xFF09;&#xFF0C;&#x53D1;&#x73B0;&#x8FD8;&#x9700;&#x8981;&#x4E00;&#x6761;&#x7EBF;&#xFF08;Node&#x7684;&#x673A;&#x5236;&#xFF09;&#x751A;&#x81F3;&#x4E00;&#x4E2A;&#x9762;&#x7684;&#x77E5;&#x8BC6;&#xFF08;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x3001;&#x751A;&#x81F3;&#x76F8;&#x5173;&#x9886;&#x57DF;&#x7684;&#x77E5;&#x8BC6;&#xFF09;&#x3002;&#x4E00;&#x5F00;&#x59CB;&#x6709;&#x70B9;overwhelming&#xFF0C;&#x53D1;&#x73B0;&#x9700;&#x8981;&#x540C;&#x6B65;&#x5B66;&#x7684;&#x77E5;&#x8BC6;&#x592A;&#x591A;&#x4E86;&#x3002;&#x540E;&#x6765;&#x53EF;&#x7B97;&#x627E;&#x5230;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x53EA;&#x8981;&#x7D27;&#x76EF;&#x7740;&#x8FD9;&#x4E2A;&#x70B9;&#xFF0C;&#x4E0D;&#x8981;&#x76F2;&#x76EE;&#x5C55;&#x5F00; Todo List&#xFF0C;&#x5C31;&#x6162;&#x6162;&#x5411;&#x5916;&#x6269;&#x5C55;&#x5373;&#x53EF;&#x3002;&#x96BE;&#x70B9;&#x4E4B;&#x4E8C;&#xFF0C;&#x662F;&#x884C;&#x6587;&#x5982;&#x4F55;&#x5C55;&#x5F00;&#xFF0C;&#x56E0;&#x4E3A;&#x5C31;&#x6211;&#x81EA;&#x5DF1;&#x8BFB;&#x6280;&#x672F;&#x4E66;&#x7C4D;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x5F88;&#x5C11;&#x63CF;&#x5199;&#x4E3A;&#x4EC0;&#x4E48;&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x53BB;&#x60F3;&#x6216;&#x8005;&#x672C;&#x8EAB;&#x5C31;&#x6709;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x624D;&#x80FD;&#x5F97;&#x5230;&#x7B54;&#x6848;&#xFF0C;&#x6211;&#x8FD8;&#x662F;&#x5E0C;&#x671B;&#x80FD;&#x63D0;&#x4F9B;&#x66F4;&#x591A;&#x7684;&#x80CC;&#x666F;&#x6765;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x3002;&#x60F3;&#x6CD5;&#x5F88;&#x7F8E;&#x597D;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E8B;&#x5B9E;&#x4E0A;&#x81EA;&#x5DF1;&#x4E0A;&#x624B;&#x4E4B;&#x540E;&#x53D1;&#x73B0;&#xFF0C;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x7406;&#x51FA;&#x4E00;&#x6761;&#x601D;&#x8DEF;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x50CF;&#x6F14;&#x5458;&#x5E26;&#x5165;&#x89D2;&#x8272;&#x4E00;&#x6837;&#x6765;&#x5E26;&#x5165;&#x8BFB;&#x8005;&#xFF0C;&#x5F88;&#x8003;&#x9A8C;&#x529F;&#x529B;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x6700;&#x540E;3&#x7AE0;&#xFF0C;&#x628A;&#x63E1;&#x4E0D;&#x4F4F;&#x4E86;&#x3002;</p>
<p>&#x5E78;&#x597D;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x6709;&#x8D35;&#x4EBA;&#x76F8;&#x52A9;&#xFF0C;&#x611F;&#x8C22;&#x8FC7;&#x7A0B;&#x4E2D;&#x5404;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x6307;&#x6559; @&#x5B50;&#x8083; @&#x6B65;&#x767D; @&#x9769;&#x65B0;&#x3002;&#x611F;&#x8C22;&#x4E24;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x5BA1;&#x7A3F;@&#x541E;&#x541E; @&#x6653;&#x7530;&#xFF1B;&#x4EE5;&#x53CA;&#x611F;&#x8C22;&#x8BA9;&#x6211;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x201D;&#x59CB;&#x4F5C;&#x4FD1;&#x8005;&#x201D; @&#x541E;&#x541E;&#xFF0C;&#x6CA1;&#x6709;&#x90A3;&#x6761;&#x606D;&#x559C;&#x63D0;&#x6848;&#x7684;&#x6D88;&#x606F;&#x6211;&#x4E5F;&#x4E0D;&#x4F1A;&#x53BB;&#x770B;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x81EA;&#x7136;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;&#x8FD8;&#x6709;&#x4E9B;&#x6CA1;&#x6709;&#x70B9;&#x540D;&#x7684;&#x670B;&#x53CB;&#xFF0C;&#x518D;&#x6B21;&#x4E5F;&#x4E00;&#x4E00;&#x611F;&#x8C22;&#x4E86;&#x3002;&#x591A;&#x52A9;&#x5F97;&#x9053;&#x3001;&#x5BE1;&#x52A9;&#x5931;&#x9053;&#xFF0C;&#x5BFB;&#x6C42;&#x5E2E;&#x52A9;&#x5BF9;&#x6211;&#x6765;&#x8BF4;&#x610F;&#x4E49;&#x5F88;&#x5927;&#xFF0C;&#x611F;&#x8C22;&#x5927;&#x5BB6;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x5728;&#x6709;&#x6536;&#x83B7;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x70B9;&#x8D5E;&#xFF0C;&#x53D1;&#x73B0;&#x9519;&#x8BEF;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x6307;&#x6B63;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e18b6744359e79d681dc89e018e2ff09.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233359844974182437.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233359844974182437.html" itemprop="url">手把手带你入门 Threejs Shader 系列（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-15T21:25:42+08:00">
                2023-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x63D2;&#x64AD;&#x4E00;&#x6761;&#x5728;&#x670B;&#x53CB;&#x5708;&#x3001;&#x7FA4;&#x91CC;&#x65E9;&#x53D1;&#x8FC7;&#x4F46;&#x6587;&#x7AE0;&#x91CC;&#x8FD8;&#x6CA1;&#x53D1;&#x7684;&#x201C;&#x6700;&#x65B0;&#x201D;&#x52A8;&#x6001;&#xFF1A;&#x4E94;&#x4E00;&#x524D;&#x540E;&#x53E4;&#x67F3;&#x603B;&#x7B97;&#x6362;&#x4E86;&#x80FD;&#x770B;&#x5230; AR &#x7684;&#x624B;&#x673A;&#xFF0C;&#x57FA;&#x4E8E;&#x4E00;&#x5E74;&#x524D;&#x7684; demo &#x7528; Three.js + Shader &#x7B49;&#x505A;&#x4E86;&#x4E2A; AR &#x7B80;&#x5355;&#x6548;&#x679C;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x7528;&#x624B;&#x673A; Chrome &#x8BBF;&#x95EE; <a href="/external_links/4474c9a1c92abe5487f1a5c8308109e2.html" target="blank" rel="noopener">desertsx.github.io/webxr</a> &#x4F53;&#x9A8C;&#x4E0B;&#x5E76;&#x5206;&#x4EAB;&#x5F55;&#x5C4F;&#x6548;&#x679C;&#xFF0C;&#x6BCF;&#x6B21;&#x914D;&#x8272;&#x90FD;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x5728;&#x81EA;&#x5DF1;&#x8EAB;&#x8FB9;&#x663E;&#x793A;&#x51FA;&#x589E;&#x5F3A;&#x73B0;&#x5B9E;&#x6548;&#x679C;&#x8FD8;&#x662F;&#x5F88;&#x9177;&#x7684;&#x3002;&#x5F53;&#x7136;&#x6709;&#x4E9B;&#x624B;&#x673A;&#x53EF;&#x80FD;&#x4E0D;&#x652F;&#x6301;&#xFF0C;&#x51FA;&#x73B0; not supported &#x5C31;&#x662F;&#x4E0D;&#x884C;&#xFF0C;&#x6CE8;&#x610F;&#x5F97;&#x7528;&#x624B;&#x673A; Chrome &#x8BBF;&#x95EE;&#x3002;&#x5177;&#x4F53;&#x6548;&#x679C;&#x53EF;&#x53C2;&#x89C1;&#x539F;&#x6587;&#x91CC;&#x7684;&#x89C6;&#x9891;&#x53F7;&#x5185;&#x5BB9;&#xFF1A;<a href="/external_links/ea0cad2cbe7eb98a94c808944bcffef7.html" target="blank" rel="noopener">&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E00;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ffcb1fa7533db70dfde6b076c19d6a1b1d2a886cc3ea34c62e4804df313b032b" alt></p>
<h2 id="&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;"><a href="#&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;" class="headerlink" title="&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;"></a>&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;</h2><p>&#x79BB;&#x4E0A;&#x7BC7;&#x6587;&#x7AE0;&#x53D1;&#x5E03;&#x53C8;&#x5FEB;&#x8FC7;&#x53BB;&#x4E00;&#x4E2A;&#x6708;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x53E4;&#x67F3;&#x5199;&#x8D77;&#x6765;&#x4E5F;&#x662F;&#x5F88;&#x96BE;&#x53D7;&#xFF0C;&#x611F;&#x89C9;&#x5F88;&#x591A;&#x4E1C;&#x897F;&#x8BB2;&#x8D77;&#x6765;&#x5F88;&#x7E41;&#x7410;&#xFF0C;&#x81EA;&#x5DF1;&#x8BB2;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x4E00;&#x76F4;&#x4E0D;&#x64C5;&#x957F;&#x8BB2;&#x89E3;&#x539F;&#x7406;&#x548C;&#x57FA;&#x7840;&#x7684;&#x7EC6;&#x8282;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x771F;&#x60F3;&#x76F4;&#x63A5;&#x653E;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x548C;&#x89C6;&#x9891;&#xFF0C;&#x8BA9;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x53BB;&#x770B;&#xFF0C;&#x4E0D;&#x505A;&#x89E3;&#x91CA;&#xFF0C;&#x4F46;&#x611F;&#x89C9;&#x90A3;&#x6837;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x7CFB;&#x5217;&#x7684;&#x6559;&#x7A0B;&#x800C;&#x8A00;&#x5C31;&#x6709;&#x6240;&#x7F3A;&#x5931;&#xFF0C;&#x6240;&#x4EE5;&#x7EC8;&#x7A76;&#x8FD8;&#x662F;&#x8FB9;&#x75DB;&#x82E6;&#x5730;&#x5C1D;&#x8BD5;&#x89E3;&#x91CA;&#xFF0C;&#x8FB9;&#x8270;&#x96BE;&#x5730;&#x7740;&#x4E00;&#x6B65;&#x6B65;&#x5B8C;&#x6210;&#x5185;&#x5BB9;&#xFF0C;&#x867D;&#x7136;&#x6700;&#x7EC8;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4ECD;&#x4E0D;&#x5B8C;&#x7F8E;&#xFF0C;&#x4F46;&#x597D;&#x6B79;&#x5148;&#x5B8C;&#x6210;&#x518D;&#x8BF4;&#x3002;&#x4E5F;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x70B9;&#x8D5E;&#x3001;&#x8F6C;&#x53D1;&#x3001;&#x6253;&#x8D4F;&#x3001;&#x8BC4;&#x8BBA;&#x7B49;&#x591A;&#x591A;&#x652F;&#x6301;&#x3002;&#x53E6;&#x5916;&#x653E;&#x4E86;&#x4E00;&#x4E9B;&#x94FE;&#x63A5;&#x53EF;&#x4F9B;&#x5927;&#x5BB6;&#x53C2;&#x8003;&#x5B66;&#x4E60;&#xFF0C;&#x5E0C;&#x671B;&#x80FD;&#x5BF9;&#x5927;&#x5BB6;&#x6709;&#x6240;&#x5E2E;&#x52A9;&#x3002;</p>
<h2 id="&#x524D;&#x7F6E;&#x8981;&#x6C42;"><a href="#&#x524D;&#x7F6E;&#x8981;&#x6C42;" class="headerlink" title="&#x524D;&#x7F6E;&#x8981;&#x6C42;"></a>&#x524D;&#x7F6E;&#x8981;&#x6C42;</h2><p>&#x5728;&#x6B63;&#x5F0F;&#x5E26;&#x5927;&#x5BB6;&#x8D70;&#x8FDB; Three.js Shader &#x4E16;&#x754C;&#x4E4B;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x5927;&#x5BB6;&#x5BF9; Three.js &#x6709;&#x6700;&#x57FA;&#x672C;&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x80FD;&#x770B;&#x61C2;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x5728; 3D &#x91CC;&#x653E;&#x4E00;&#x4E2A;&#x7EAF;&#x8272;&#x7684;&#x5E73;&#x9762;&#x7269;&#x4F53;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">html&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Three.js Shader&lt;/title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        body {</span><br><span class="line">            margin: 0;</span><br><span class="line">        }</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script type=&quot;module&quot;&gt;</span><br><span class="line">        import * as THREE from &apos;https://unpkg.com/three@0.152.2/build/three.module.js&apos;;</span><br><span class="line"></span><br><span class="line">        // Scene</span><br><span class="line">        const scene = new THREE.Scene();</span><br><span class="line"></span><br><span class="line">        // Camera</span><br><span class="line">        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);</span><br><span class="line">        camera.position.z = 2;</span><br><span class="line">        // camera.lookAt(new THREE.Vector3());</span><br><span class="line"></span><br><span class="line">        // Mesh = Geometry + Material</span><br><span class="line">        const geometry = new THREE.PlaneGeometry(1, 1);</span><br><span class="line">        const material = new THREE.MeshBasicMaterial({</span><br><span class="line">            color: 0x0ca678,</span><br><span class="line">            // wireframe: true</span><br><span class="line">        });</span><br><span class="line">        const mesh = new THREE.Mesh(geometry, material);</span><br><span class="line">        scene.add(mesh);</span><br><span class="line"></span><br><span class="line">        // Renderer</span><br><span class="line">        const renderer = new THREE.WebGLRenderer();</span><br><span class="line">        renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">        renderer.setClearColor(&quot;#e6fcf5&quot;, 1);</span><br><span class="line">        document.body.appendChild(renderer.domElement);</span><br><span class="line"></span><br><span class="line">        // Animation</span><br><span class="line">        function animate() {</span><br><span class="line">            requestAnimationFrame(animate);</span><br><span class="line">            // mesh.rotation.y += 0.01;</span><br><span class="line">            renderer.render(scene, camera);</span><br><span class="line">        }</span><br><span class="line">        animate();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6fc694a86db505683d807a138775d9c1634c6d2b7096ff7b75bb2de549a507c0" alt></p>
<p>&#x5982;&#x679C;&#x4F60;&#x4E4B;&#x524D;&#x6CA1;&#x63A5;&#x89E6;&#x8FC7; Three.js&#xFF0C;&#x5EFA;&#x8BAE;&#x5148;&#x770B;&#x770B; Three.js &#x5B98;&#x65B9;&#x6587;&#x6863;&#x7684;&#x8FD9;&#x7BC7;&#x6559;&#x7A0B;<a href="/external_links/4d7b7b99240afce9a5c0800258c77c4d.html" target="blank" rel="noopener">&#x300C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF08;Creating a scene&#xFF09;&#x300D;</a>&#xFF0C;&#x6216;&#x8005;&#x770B;&#x770B;&#x53E4;&#x67F3;&#x4E4B;&#x524D;&#x5B89;&#x5229;&#x8FC7;&#x7684;b&#x7AD9;up&#x4E3B;<code>&#x8FDB;&#x534E;</code>&#x7B80;&#x6D01;&#x6E05;&#x6670;&#x7684;&#x89C6;&#x9891;&#x2014;&#x2014;<a href="/external_links/52f884c1d280528cbadbf5949612b743.html" target="blank" rel="noopener">&#x300C;three.js&#x6559;&#x7A0B;-&#x4ECE;&#x5165;&#x95E8;&#x5230;&#x5165;&#x95E8;&#x300D;</a>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/8a1642ee9467901a43a28c8af11a6929936bbe04d275fed4c76266c14a604174" alt></p>
<p>&#x5982;&#x679C;&#x4F60;&#x559C;&#x6B22;&#x770B;&#x4E66;&#x5B66;&#x4E60;&#xFF0C;&#x521A;&#x597D;<code>&#x300C;Learn Three.js/Three.js&#x5F00;&#x53D1;&#x6307;&#x5357;&#x300D;</code>&#x82F1;&#x6587;&#x7B2C;&#x56DB;&#x7248;&#x524D;&#x51E0;&#x4E2A;&#x6708;&#x4E0A;&#x5E02;&#xFF0C;zlibrary &#x4E0A;&#x5DF2;&#x7ECF;&#x6709;&#x7535;&#x5B50;&#x4E66;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x81EA;&#x884C;&#x4E0B;&#x8F7D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;<code>&#x300C;&#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</code>&#x516C;&#x4F17;&#x53F7;&#x540E;&#x53F0;&#x56DE;&#x590D; <code>learn three.js</code> &#x83B7;&#x53D6; PDF &#x7248;&#x672C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ffab320240ae49bcaa975eb97ba9ba9350ff6013f4df4bd207ed8c9b19f4c1e0" alt></p>
<h2 id="&#x70B9;&#x7EBF;&#x9762;&#x4F53;"><a href="#&#x70B9;&#x7EBF;&#x9762;&#x4F53;" class="headerlink" title="&#x70B9;&#x7EBF;&#x9762;&#x4F53;"></a>&#x70B9;&#x7EBF;&#x9762;&#x4F53;</h2><p>&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x5728;&#x573A;&#x666F;&#x91CC;&#x653E;&#x4E86;&#x4E00;&#x4E2A;&#x5BBD;&#x9AD8; 1x1 &#x7684;&#x5E73;&#x9762;&#xFF0C;&#x5F53;&#x5F00;&#x542F;&#x7EBF;&#x6846;&#x6A21;&#x5F0F; <code>wireframe: true</code>&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x9ED8;&#x8BA4;&#x7684;&#x5E73;&#x9762;&#x7531;4&#x4E2A;&#x9876;&#x70B9;&#x3001;2&#x4E2A;&#x4E09;&#x89D2;&#x5F62;&#x7EC4;&#x6210;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const geometry = new THREE.PlaneGeometry(1, 1);</span><br><span class="line">const material = new THREE.MeshBasicMaterial({</span><br><span class="line">    color: 0x0ca678,</span><br><span class="line">    wireframe: true</span><br><span class="line">});</span><br><span class="line">const mesh = new THREE.Mesh(geometry, material);</span><br><span class="line">scene.add(mesh);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/40a167e8621c01de55c0b49e00daa6a4741942da89639b6b31addf3d3c2944cf" alt></p>
<p>&#x9876;&#x70B9;&#x8FDE;&#x6210;&#x7EBF;&#x3001;&#x7EBF;&#x7EC4;&#x6210;&#x4E09;&#x89D2;&#x5F62;&#x3001;&#x4E09;&#x89D2;&#x5F62;&#x7EC4;&#x6210;&#x51E0;&#x4F55;&#x4F53;&#xFF0C;&#x7ACB;&#x65B9;&#x4F53;&#x3001;&#x7403;&#x4F53;&#x7B49;&#x4EA6;&#x662F;&#x5982;&#x6B64;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f48ef765ced63efe89e12b2bc63fd997727a5c52fd59dcc77453aab20dd474c4" alt></p>
<h2 id="&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;"><a href="#&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;" class="headerlink" title="&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;"></a>&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;</h2><p><code>console.log(geometry)</code> &#x6253;&#x5370;&#x51E0;&#x4F55;&#x4F53;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5176;&#x4E2D; <code>attributes</code> &#x4E0A;&#x643A;&#x5E26;&#x7684;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x91CC;&#x9762;&#x5305;&#x542B;&#x9876;&#x70B9;&#x5750;&#x6807; position&#x3001;&#x7EB9;&#x7406;&#x5750;&#x6807; uv&#x3001;&#x6CD5;&#x7EBF; normal&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9e673cf0a00681e5816fc4c2252c990c521e81b9c1617f3836c50c723ad12d63" alt></p>
<p>&#x8FD9;&#x91CC; count &#x662F;&#x9876;&#x70B9;&#x6570;&#xFF0C;itemSize &#x662F;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x7684;&#x7EF4;&#x5EA6;&#x6570;&#xFF0C;&#x6BD4;&#x5982; position &#x548C; normal &#x90FD;&#x662F;3&#x7EF4;&#x7684;&#x3001;uv &#x662F;2&#x7EF4;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x8BF4;&#x6765;&#x5C31;&#x662F; position &#x7684; array &#x91CC;&#x662F;3&#x4E2A;&#x4E00;&#x7EC4;&#x8868;&#x793A;&#x67D0;&#x4E2A;&#x9876;&#x70B9;&#x7684;&#x5750;&#x6807;&#x6570;&#x636E;&#xFF0C;uv&#x3001;normal &#x540C;&#x7406;&#x3002;&#x914D;&#x56FE;&#x91CC;&#x53E4;&#x67F3;&#x6309;&#x7167;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x4E00;&#x6761;&#x6570;&#x636E;&#x7684;&#x683C;&#x5F0F;&#x8FDB;&#x884C;&#x6392;&#x5217;&#xFF0C;&#x65B9;&#x4FBF;&#x5927;&#x5BB6;&#x7406;&#x89E3;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e250c743aea9523bc06fefebcf24ebfd17bc35051c3375dfcd0232ebe0312494" alt></p>
<p>&#x56E0;&#x4E3A;&#x5E73;&#x9762;&#x5BBD;&#x9AD8;&#x5747;&#x4E3A;1&#xFF0C;&#x9ED8;&#x8BA4;&#x51E0;&#x4F55;&#x4F53;&#x5728;3&#x7EF4;&#x5750;&#x6807;&#x7CFB;&#x7684;&#x539F;&#x70B9;(0, 0, 0)&#x5904;&#x5C45;&#x4E2D;&#x4E14;&#x9762;&#x671D;z&#x8F74;&#x6B63;&#x65B9;&#x5411;&#x663E;&#x793A;&#xFF0C;&#x6240;&#x4EE5;&#x9876;&#x70B9;&#x5750;&#x6807;&#x4F9D;&#x6B21;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x633A;&#x597D;&#x7406;&#x89E3;&#x7684;&#x3002;</p>
<h2 id="uv-&#x7EB9;&#x7406;&#x5750;&#x6807;"><a href="#uv-&#x7EB9;&#x7406;&#x5750;&#x6807;" class="headerlink" title="uv &#x7EB9;&#x7406;&#x5750;&#x6807;"></a>uv &#x7EB9;&#x7406;&#x5750;&#x6807;</h2><p>&#x800C; uv &#x7EB9;&#x7406;&#x5750;&#x6807;&#x5F88;&#x591A;&#x4EBA;&#x53EF;&#x80FD;&#x7B2C;&#x4E00;&#x6B21;&#x63A5;&#x89E6;&#x4E0D;&#x592A;&#x4E86;&#x89E3;&#xFF0C;&#x5176;&#x5B9E;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x8FD9;&#x5F20;&#x56FE;&#xFF0C;u &#x4ECE;&#x5DE6;&#x5230;&#x53F3;&#x589E;&#x52A0;&#x3001;v &#x4ECE;&#x4E0B;&#x5230;&#x4E0A;&#x589E;&#x52A0;&#xFF0C;&#x8303;&#x56F4;&#x4ECE;&#x5DE6;&#x4E0B;&#x89D2; (0, 0) &#x5230;&#x53F3;&#x4E0A;&#x89D2; (1, 1) &#x5373;&#x53EF;&#xFF0C;&#x54EA;&#x6015;&#x662F;&#x957F;&#x65B9;&#x5F62;&#x5E73;&#x9762;&#x3001;&#x7403;&#x4F53;&#x3001;&#x590D;&#x6742;3D&#x6A21;&#x578B;&#x7B49;&#x7269;&#x4F53;&#xFF0C;&#x5176;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x7EB9;&#x7406;&#x5750;&#x6807;&#x90FD;&#x662F;&#x8FD9;&#x4E2A;&#x8303;&#x56F4;&#x3002;&#x501F;&#x52A9; uv &#x5C31;&#x80FD;&#x628A;&#x7EB9;&#x7406;&#x56FE;&#x7247;&#x8D34;&#x5230;3D&#x7269;&#x4F53;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F; uv &#x7684;&#x4E00;&#x5927;&#x7528;&#x5904;&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x6F14;&#x793A;&#xFF0C;&#x5F88;&#x7B80;&#x5355;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2b9cd08c116c40e3cdcce285fc0d4ff80d3bf8f6e76304a2af198cfeea2ba27f" alt></p>
<p>&#x522B;&#x770B;&#x53EA;&#x6709;&#x51E0;&#x4E2A;&#x9876;&#x70B9;&#x624D;&#x6709; uv &#x503C;&#xFF0C;&#x5176;&#x5B9E;&#x4E09;&#x89D2;&#x5F62;&#x5185;&#x6BCF;&#x4E2A;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x540E;&#x7EED;&#x90FD;&#x4F1A;&#x81EA;&#x52A8;&#x63D2;&#x503C;&#x5F97;&#x5230;&#x6570;&#x503C;&#xFF0C;&#x8FD9;&#x80CC;&#x540E;&#x501F;&#x52A9;&#x4E86;&#x4E09;&#x89D2;&#x5F62;<code>&#x91CD;&#x5FC3;&#x5750;&#x6807;/barycentric coordinates</code>&#x8FD9;&#x4E00;&#x826F;&#x597D;&#x7279;&#x6027;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x670B;&#x53CB;&#x53EF;&#x81EA;&#x884C;&#x4E86;&#x89E3;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x9700;&#x77E5;&#x9053;&#x5E73;&#x9762; plane &#x5185;&#x6BCF;&#x4E2A;&#x4F4D;&#x7F6E;&#x90FD;&#x4F1A;&#x6709; uv &#x503C;&#xFF0C;&#x6BD4;&#x5982;&#x4E2D;&#x5FC3;&#x4F4D;&#x7F6E;&#x662F; (0.5, 0.5)&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c94a7c6d64208f83f776fb10483ff4d1652d9929f42bfd4030b6c042e0915d8a" alt></p>
<p>&#x800C;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x540E;&#x7EED;&#x5728; vertex shader &#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x5C31;&#x80FD;&#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x5230;&#x5E76;&#x4F7F;&#x7528;&#x3002;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5F80;&#x9876;&#x70B9;&#x4E0A;&#x6302;&#x6240;&#x9700;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5373;&#x81EA;&#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x7740;&#x8272;&#x5668;&#x91CC;&#x4F7F;&#x7528;&#xFF0C;&#x8FD9;&#x4E9B;&#x540E;&#x7EED;&#x90FD;&#x4F1A;&#x4ECB;&#x7ECD;&#x3002;</p>
<h2 id="Shader-&#x767B;&#x573A;"><a href="#Shader-&#x767B;&#x573A;" class="headerlink" title="Shader &#x767B;&#x573A;"></a>Shader &#x767B;&#x573A;</h2><p>&#x8BB2;&#x5B8C;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x5C5E;&#x6027;&#x6570;&#x636E;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x540E;&#x7EED;&#x4F1A;&#x7528;&#x5230;&#x7684; uv &#x503C;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8BE5; Shader &#x7740;&#x8272;&#x5668;&#x767B;&#x573A;&#xFF0C;&#x770B;&#x770B;&#x5177;&#x4F53;&#x80FD;&#x7528; uv &#x505A;&#x4E9B;&#x4EC0;&#x4E48;&#xFF08;&#x5F97;&#x5230;&#x4E0B;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x624D;&#x6765;&#x5F97;&#x53CA;&#x8BB2;&#x4E86;&#xFF09;&#x3002;</p>
<p>&#x5728;<a href="https://dev.newban.cn/7224314619865628709">&#x300C;&#x65AD;&#x66F4;19&#x4E2A;&#x6708;&#xFF0C;&#x643A; Three.js Shader &#x5F52;&#x6765;&#xFF01;&#xFF08;&#x4E0B;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</a>&#x4E00;&#x6587;&#xFF0C;&#x53E4;&#x67F3;&#x5C31;&#x7B80;&#x5355;&#x6F14;&#x793A;&#x8FC7; Three.js &#x91CC;&#x8981;&#x5199;&#x7684; Shader &#x4EE3;&#x7801;&#x957F;&#x4EC0;&#x4E48;&#x6837;&#xFF0C;&#x8FD9;&#x91CC;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#x4E0B;&#x7EC6;&#x8282;&#x3002;</p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4F7F;&#x7528; Three.js &#x5185;&#x7F6E;&#x7684;&#x90A3;&#x4E9B;&#x6750;&#x8D28;&#xFF0C;&#x800C;&#x662F;&#x7528; <code>ShaderMaterial</code> &#x66FF;&#x6362; <code>MeshBasicMaterial</code>&#xFF0C;&#x5E76;&#x4E14;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>vertexShader</code> &#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x548C; <code>fragmentShader</code> &#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#xFF0C;&#x6765;&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x3001;&#x6BCF;&#x4E2A;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x5982;&#x4F55;&#x663E;&#x793A;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/4d7b7b99240afce9a5c0800258c77c4d.html" target="blank" rel="noopener">ShaderMaterial - Three.js</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">// const material = new THREE.MeshBasicMaterial({ color: 0x0ca678 });</span><br><span class="line">const material = new THREE.ShaderMaterial({</span><br><span class="line">  vertexShader: vertex,</span><br><span class="line">  fragmentShader: fragment</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p><code>vertex</code> &#x548C; <code>fragment</code> &#x91CC;&#x662F;&#x7528;&#x7C7B;&#x4F3C;C&#x8BED;&#x8A00;&#x7684; <code>GLSL</code> &#x8BED;&#x8A00;&#x2014;&#x2014;&#x5373; <code>OpenGL Shading Language</code>&#x2014;&#x2014;&#x5199;&#x7684; shader &#x7A0B;&#x5E8F;&#xFF0C;&#x7531; GPU &#x5206;&#x522B;&#x5BF9;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x3001;&#x6BCF;&#x4E2A;&#x7247;&#x5143;&#x72EC;&#x7ACB;&#x6267;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x6216;&#x7247;&#x5143;&#x90FD;&#x4E0D;&#x77E5;&#x9053;&#x5176;&#x4ED6;&#x9876;&#x70B9;&#x6216;&#x7247;&#x5143;&#x7684;&#x6570;&#x636E;&#x3002;&#x8FD9;&#x53E5;&#x8BDD;&#x770B;&#x4F3C;&#x4E0D;&#x8D77;&#x773C;&#xFF0C;&#x4F46;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x5374;&#x662F;&#x5927;&#x5BB6;&#x521A;&#x63A5;&#x89E6; shader &#x65F6;&#x89C9;&#x5F97;&#x5F88;&#x62BD;&#x8C61;&#x4E0D;&#x597D;&#x7406;&#x89E3;&#x7684;&#x539F;&#x56E0;&#x4E4B;&#x4E00;&#xFF0C;&#x4E5F;&#x662F;&#x53E4;&#x67F3;&#x521A;&#x5F00;&#x59CB;&#x5165;&#x95E8;&#x65F6;&#x89C9;&#x5F97;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x5207;&#x5165;&#x70B9;&#xFF0C;&#x540E;&#x7EED;&#x8BB2;&#x5230;&#x5177;&#x4F53;&#x4F8B;&#x5B50;&#x65F6;&#x4F1A;&#x518D;&#x63D0;&#xFF0C;&#x8FD9;&#x91CC;&#x5927;&#x5BB6;&#x8FD8;&#x4E00;&#x5934;&#x96FE;&#x6C34;&#x4E5F;&#x6CA1;&#x4E8B;&#x3002;</p>
<p>shader &#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x5355;&#x72EC;&#x5199;&#x5728;&#x8BF8;&#x5982; <code>vertex.glsl</code>&#x3001;<code>fragment.glsl</code> &#x7684;&#x6587;&#x4EF6;&#x91CC;&#x518D;&#x5BFC;&#x5165;&#x4F7F;&#x7528;&#xFF1B;&#x4E5F;&#x53EF;&#x4EE5;&#x548C;&#x793A;&#x4F8B;&#x4E00;&#x6837;&#x76F4;&#x63A5;&#x5728; JavaScript &#x91CC;&#x7528;&#x5B57;&#x7B26;&#x4E32;&#x683C;&#x5F0F;&#x8868;&#x793A;&#x3002;&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x8BB2;&#x89E3;&#x65B9;&#x4FBF;&#x91C7;&#x53D6;&#x540E;&#x8005;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x9700;&#x8981;&#x8BBE;&#x7F6E; <code>gl_Position</code> &#x9876;&#x70B9;&#x4F4D;&#x7F6E;&#xFF0C;&#x5728;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#x91CC;&#x9700;&#x8981;&#x8BBE;&#x7F6E; <code>gl_FragColor</code> &#x7247;&#x5143;/&#x50CF;&#x7D20;&#x989C;&#x8272;&#xFF0C;&#x4E24;&#x8005;&#x90FD;&#x5728;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x7684; <code>void main() {}</code> &#x4E3B;&#x51FD;&#x6570;&#x91CC;&#x8BBE;&#x7F6E;&#xFF0C;&#x5E76;&#x4E14; main &#x51FD;&#x6570;&#x4F1A;&#x88AB;&#x81EA;&#x52A8;&#x6267;&#x884C;&#x3002;&#x5728;&#x540E;&#x7EED;&#x5F88;&#x591A;&#x4F8B;&#x5B50;&#x91CC;&#x6211;&#x4EEC;&#x90FD;&#x53EA;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x8FD9;&#x4FE9;&#x5185;&#x7F6E;&#x53D8;&#x91CF;&#x7684;&#x503C;&#xFF0C;&#x53EA;&#x6709;&#x7B49;&#x4ECB;&#x7ECD;&#x7C92;&#x5B50;&#x7CFB;&#x7EDF;&#x65F6;&#x624D;&#x4F1A;&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x53E6;&#x5916;&#x8BBE;&#x7F6E; <code>gl_PointSize</code> &#x7C92;&#x5B50;&#x5927;&#x5C0F;&#x3002;</p>
<h2 id="Vertex-Shader"><a href="#Vertex-Shader" class="headerlink" title="Vertex Shader"></a>Vertex Shader</h2><p>&#x4E00;&#x822C;&#x7684;&#x6559;&#x7A0B;&#x4F1A;&#x5148;&#x8BB2;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#xFF0C;&#x5148;&#x4E0D;&#x53BB;&#x6539;&#x53D8;&#x9876;&#x70B9;&#x3001;&#x6539;&#x53D8;&#x4E09;&#x7EF4;&#x7269;&#x4F53;&#x5F62;&#x72B6;&#xFF0C;&#x6BD5;&#x7ADF;&#x5148;&#x628A;&#x53E6;&#x4E00;&#x4E2A;&#x653E;&#x4E00;&#x8FB9;&#x8BB2;&#x8D77;&#x6765;&#x66F4;&#x65B9;&#x4FBF;&#xFF0C;&#x800C;&#x8BBE;&#x7F6E;&#x989C;&#x8272;&#x76F8;&#x5BF9;&#x597D;&#x8BB2;&#x4E9B;&#x3002;&#x4F46;&#x5373;&#x4F7F;&#x5982;&#x6B64;&#xFF0C;&#x8981;&#x786E;&#x4FDD; Three.js Shader &#x91CC;&#x4EE3;&#x7801;&#x5B8C;&#x6574;&#x6027;&#xFF0C;&#x6700;&#x7B80;&#x5355;&#x7684;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x4E5F;&#x8981;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E00;&#x4E32;&#x4E1C;&#x897F;&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x7684;&#x7269;&#x4F53;&#x5448;&#x73B0;&#x5728;&#x4E8C;&#x7EF4;&#x5C4F;&#x5E55;&#x4E0A;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0);</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x867D;&#x7136;&#x5C31;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x4F46;&#x80CC;&#x540E;&#x539F;&#x7406;&#x9700;&#x8981;&#x4E00;&#x6574;&#x7BC7;&#x6587;&#x7AE0;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#xFF0C;&#x6B64;&#x5904;&#x7F57;&#x5217;&#x4E86;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x4EC5;&#x4F9B;&#x53C2;&#x8003;&#xFF0C;&#x7531;&#x4E8E;&#x6D89;&#x53CA;&#x4E0D;&#x5C11;&#x56FE;&#x5F62;&#x5B66;&#x77E5;&#x8BC6;&#xFF0C;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x76EE;&#x524D;&#x8FD8;&#x4E0D;&#x7406;&#x89E3;&#xFF0C;&#x4E5F;&#x4E0D;&#x91CD;&#x8981;&#xFF0C;&#x53EA;&#x9700;&#x77E5;&#x9053;&#x5FC5;&#x987B;&#x8FD9;&#x6837;&#x56FA;&#x5B9A;&#x8BBE;&#x7F6E;&#x624D;&#x80FD;&#x663E;&#x793A;&#xFF0C;&#x770B;&#x5B8C;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x521D;&#x6B65;&#x4E86;&#x89E3;&#x540E;&#x8DF3;&#x5230; GLSL &#x57FA;&#x7840;&#x8BB2;&#x89E3;&#x4E0E;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#x5B66;&#x4E60;&#x989C;&#x8272;&#x8BBE;&#x7F6E;&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/ac63cb31da9891bef95b58d1e988994b.html" target="blank" rel="noopener">&#x4ECE;&#x96F6;&#x5F00;&#x59CB;&#x5B66;&#x56FE;&#x5F62;&#x5B66;&#xFF1A;MVP Transformation</a></li>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/86fadecd4c1a5d0c080db8fbcdd8d759.html" target="blank" rel="noopener">&#x56FE;&#x5F62;&#x5B66;&#xFF1A;MVP&#x53D8;&#x6362;&#x6982;&#x8FF0;</a></li>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/40c4babdf47fda76137c097414eedbad.html" target="blank" rel="noopener">&#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66; 5&#xFF1A;&#x9F50;&#x6B21;&#x5750;&#x6807;&#x4E0E; MVP &#x77E9;&#x9635;&#x53D8;&#x6362;</a></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/90e6cad1934f51dabfd3a07476b2f5c2611871374e0044d43329530a55102b5c" alt></p>
<p>&#x867D;&#x7136;&#x89E3;&#x91CA;&#x8D77;&#x6765;&#x5F88;&#x4E3A;&#x96BE;&#xFF0C;&#x4F46;&#x53E4;&#x67F3;&#x8FD8;&#x662F;&#x7B80;&#x5355;&#x8BB2;&#x4E0B;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; <code>position</code> &#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;&#x51E0;&#x4F55;&#x4F53; attributes &#x91CC;&#x5404;&#x9876;&#x70B9;&#x7684;&#x5750;&#x6807;&#xFF0C;&#x5B83;&#x662F;&#x4E09;&#x7EF4;&#x5411;&#x91CF;&#x7C7B;&#x578B; <code>vec3</code>&#xFF0C;&#x9700;&#x8981;&#x5148;&#x53D8;&#x6210; <code>vec4</code> &#x56DB;&#x7EF4;&#x5411;&#x91CF;&#x7C7B;&#x578B;&#x2014;&#x2014;&#x5373;(x, y, z, w)4&#x4E2A;&#x5206;&#x91CF;&#x7684;&#x683C;&#x5F0F;&#x2014;&#x2014;&#x56E0;&#x4E3A;&#x6709;&#x4E86;&#x7B2C;4&#x4E2A;&#x503C; w=1.0 &#x624D;&#x80FD;&#x8FDB;&#x884C;&#x77E9;&#x9635;&#x64CD;&#x4F5C;&#xFF0C;&#x5B9E;&#x73B0;&#x65CB;&#x8F6C;&#x3001;&#x5E73;&#x79FB;&#x3001;&#x7F29;&#x653E;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>modelMatrix</code> &#x6A21;&#x578B;&#x77E9;&#x9635;&#x5C06;&#x539F;&#x672C;&#x6A21;&#x578B;&#x4EE5;&#x81EA;&#x8EAB;&#x672C;&#x5730;&#x5750;&#x6807;&#x5B9A;&#x4F4D;&#x7684;&#x65B9;&#x5F0F;&#x53D8;&#x6210;&#x4E16;&#x754C;&#x5750;&#x6807;&#x91CC;&#x9002;&#x5F53;&#x7684;&#x4F4D;&#x7F6E;&#x548C;&#x5927;&#x5C0F;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x60F3;&#x8981;&#x7684;&#x573A;&#x666F;&#x5E03;&#x5C40;&#xFF1B;&#x573A;&#x666F;&#x6709;&#x4E86;&#xFF0C;&#x76F8;&#x673A;&#x4F4D;&#x7F6E;&#x3001;&#x89C6;&#x89D2;&#x7684;&#x4E0D;&#x540C;&#x770B;&#x5230;&#x7684;&#x753B;&#x9762;&#x4E5F;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>viewMatrix</code> &#x89C6;&#x56FE;&#x77E9;&#x9635;&#x5B9E;&#x73B0;&#x7269;&#x4F53;&#x57FA;&#x4E8E;&#x76F8;&#x673A;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x524D;&#x4E24;&#x8005;&#x53EF;&#x4EE5;&#x7B80;&#x5199;&#x6210; <code>modelViewMartix</code>&#xFF0C;&#x6700;&#x540E;&#x518D;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>projectionMatrix</code> &#x6295;&#x5F71;&#x77E9;&#x9635;&#x53D8;&#x6362;&#x5230;&#x526A;&#x88C1;&#x7A7A;&#x95F4;&#xFF0C;&#x6700;&#x7EC8;&#x53D8;&#x6210;&#x4E8C;&#x7EF4;&#x5C4F;&#x5E55;&#x4E0A;&#x6E32;&#x67D3;&#x51FA;&#x6765;&#x7684;&#x6548;&#x679C;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x5728; b &#x7AD9;&#x770B;&#x72B9;&#x4ED6;&#x5927;&#x5B66;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66;&#x8BFE;&#x7A0B;&#xFF0C;&#x611F;&#x89C9;&#x8FD9;&#x90E8;&#x5206;&#x8BFE;&#x4EF6;&#x5F88;&#x76F4;&#x89C2;&#x3002;&#x4E00;&#x5F00;&#x59CB;&#x6905;&#x5B50;&#x3001;&#x684C;&#x5B50;&#x7B49;&#x4E09;&#x7EF4;&#x7269;&#x4F53;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x81EA;&#x8EAB;&#x4E2D;&#x5FC3;&#x6765;&#x653E;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x5E73;&#x79FB;&#x3001;&#x7F29;&#x653E;&#x3001;&#x65CB;&#x8F6C;&#x7B49;&#x6A21;&#x578B;&#x53D8;&#x6362;&#x6784;&#x5EFA;&#x51FA;&#x5408;&#x9002;&#x7684;&#x573A;&#x666F;&#x4E16;&#x754C;&#x91CC;&#x7684;&#x5E03;&#x5C40;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x7684;&#x76F8;&#x673A;&#x770B;&#x5230;&#x7279;&#x5B9A;&#x7684;&#x753B;&#x9762;&#xFF0C;&#x6700;&#x540E;&#x518D;&#x6E32;&#x67D3;&#x5230;&#x753B;&#x9762;&#x91CC;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/44567b86f56efcf074ba66ae9e1ba63d.html" target="blank" rel="noopener">2020&#x5E74; &#x79CB; &#x72B9;&#x4ED6;&#x5927;&#x5B66; &#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66;&#x8BFE;&#x7A0B;&#xFF08;&#x4E2D;&#x82F1;&#x5B57;&#x5E55;&#xFF09;</a></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6237af06e46942fb941140ad6aaaeb90ddbe7125818d0f268fa2738d125b10da" alt></p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x53D8;&#x91CF; <code>modelViewMatrix</code>&#x3001;<code>projectionMatrix</code> &#x548C;&#x5C5E;&#x6027; <code>position</code> &#x90FD;&#x662F; ShaderMaterial &#x91CC;&#x5185;&#x7F6E;&#x7684;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x62FF;&#x6765;&#x7528;&#xFF0C;&#x5DF2;&#x7ECF;&#x5E2E;&#x6211;&#x4EEC;&#x58F0;&#x660E;&#x597D;&#x4E86;&#xFF0C;&#x9876;&#x70B9;&#x4E0A;&#x7684; uv&#x3001;normal &#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#xFF1B;&#x5047;&#x5982;&#x6362;&#x6210; RawShaderMaterial &#x5C31;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x58F0;&#x660E;&#x540E;&#x624D;&#x80FD;&#x7528;&#xFF0C;&#x5F53;&#x7136;&#x76EE;&#x524D;&#x53E4;&#x67F3;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x5230;&#x8FC7;&#x76F4;&#x63A5;&#x7528; RawShaderMaterial &#x7684;&#x3002;&#x5176;&#x4ED6;&#x5185;&#x7F6E;&#x53D8;&#x91CF;&#x548C;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x7BC7;&#x6587;&#x6863;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/8eface4fa5365e60f9ad6ede737524a8.html" target="blank" rel="noopener">WebGLProgram - Three.js</a></li>
</ul>
<h2 id="GLSL-&#x8BED;&#x8A00;&#x57FA;&#x7840;"><a href="#GLSL-&#x8BED;&#x8A00;&#x57FA;&#x7840;" class="headerlink" title="GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;"></a>GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;</h2><p>&#x5728;&#x5F00;&#x59CB;&#x8BB2; fragment shader &#x91CC;&#x5982;&#x4F55;&#x7ED9;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x8D4B;&#x989C;&#x8272;&#x503C;&#x4E4B;&#x524D;&#xFF0C;&#x6709;&#x5FC5;&#x8981;&#x5148;&#x8BB2;&#x4E0B; GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x770B;&#x672C;&#x6587;&#x65F6;&#x4E5F;&#x8DDF;&#x7740;&#x6572;&#x4E86;&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x4E14;&#x201C;&#x81EA;&#x4F5C;&#x806A;&#x660E;&#x201D;&#x5730;&#x7701;&#x7565;&#x4E86; GLSL &#x6BCF;&#x884C;&#x8BED;&#x53E5;&#x6700;&#x540E;&#x7684;<code>&#x5206;&#x53F7;;</code>&#xFF0C;&#x6216;&#x8005;&#x628A; float &#x6D6E;&#x70B9;&#x6570;0.0&#x3001;1.0&#x5077;&#x61D2;&#x5199;&#x6210;&#x4E86;&#x6574;&#x578B; 0&#x3001;1&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x753B;&#x9762;&#x91CC;&#x7684;&#x7269;&#x4F53;&#x65E0;&#x6CD5;&#x663E;&#x793A;&#x3001;&#x63A7;&#x5236;&#x53F0;&#x6709;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x4E3A; GLSL &#x91CC;&#x8FD9;&#x4E24;&#x70B9;&#x662F;&#x5F88;&#x4E25;&#x683C;&#x7684;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x5927;&#x5BB6;&#x4E0D;&#x8BBA;&#x521A;&#x5165;&#x95E8; Shader&#x3001;&#x8FD8;&#x662F;&#x540E;&#x7EED;&#x7F16;&#x5199; Shader &#x8FC7;&#x7A0B;&#x4E2D;&#x4E00;&#x4E0D;&#x5C0F;&#x5FC3;&#x5C31;&#x975E;&#x5E38;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x52A1;&#x5FC5;&#x7262;&#x8BB0;&#x5728;&#x5FC3;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x53E4;&#x67F3;&#x521A;&#x6D4B;&#x8BD5;&#x4E86;&#x4E0B;&#xFF0C;&#x8FD9;&#x51E0;&#x5904;&#x6570;&#x5B57;&#x73B0;&#x5728;&#x5199;&#x6210;&#x6574;&#x6570;&#x4E5F;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#x4E86;&#xFF0C;&#x8BB0;&#x5F97;&#x4EE5;&#x524D;&#x662F;&#x4F1A;&#x62A5;&#x9519;&#x7684;&#xFF0C;&#x800C;&#x4E14;&#x5927;&#x5BB6;&#x770B;&#x7F51;&#x4E0A;&#x5176;&#x4ED6;&#x6559;&#x7A0B;&#x5927;&#x591A;&#x90FD;&#x662F;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x867D;&#x7136;&#x53EF;&#x80FD;&#x5411;&#x91CF;&#x7C7B;&#x578B; vec &#x91CC;&#x652F;&#x6301;&#x6574;&#x6570;&#x4E86;&#xFF0C;&#x4F46;&#x540E;&#x7EED;&#x6559;&#x7A0B;&#x91CC;&#x53E4;&#x67F3;&#x53EF;&#x80FD;&#x8FD8;&#x662F;&#x4F1A;&#x5EF6;&#x7EED;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x8FD9;&#x70B9;&#x9700;&#x8981;&#x5927;&#x5BB6;&#x6CE8;&#x610F;&#x4E0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p>GLSL &#x91CC;&#x53D8;&#x91CF;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x6709;&#x6D6E;&#x70B9;&#x6570; float&#x3001;&#x6574;&#x578B; int&#x3001;&#x5E03;&#x5C14;&#x578B; bool&#xFF0C;&#x4F46;&#x4EE5;&#x53E4;&#x67F3;&#x76EE;&#x524D;&#x63A5;&#x89E6;&#x8FC7;&#x7684;&#x4EE3;&#x7801;&#x91CC;&#xFF0C;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x4F7F;&#x7528;&#x8FDC;&#x8FDC;&#x591A;&#x4E8E;&#x540E;&#x4E24;&#x8005;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;float alpha = 0.5;</span><br><span class="line">int num = 10;</span><br><span class="line">bool flag = true;</span><br></pre></td></tr></table></figure>

<p>&#x53E6;&#x5916;&#x8FD8;&#x6709; vec &#x5411;&#x91CF;&#x7C7B;&#x578B;&#x7CFB;&#x5217;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E8C;&#x7EF4;&#x5411;&#x91CF; vec2&#x3001;&#x4E09;&#x7EF4;&#x5411;&#x91CF; vec3&#x3001;&#x56DB;&#x7EF4;&#x5411;&#x91CF; vec4&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x522B;&#x770B;&#x6210;&#x7531; (x,y)&#x3001;(x,y,z)&#x6216;(r,g,b)&#x3001;(x,y,z,w)&#x6216;(r,g,b,a) &#x7B49;&#x5206;&#x91CF;&#x7EC4;&#x6210;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x50CF;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x91CC;&#x4E00;&#x6837;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x6216;&#x4FEE;&#x6539;&#x5BF9;&#x5E94;&#x5206;&#x91CF;&#x6570;&#x503C;&#xFF1B;&#x5F53;&#x5206;&#x91CF;&#x7684;&#x503C;&#x90FD;&#x4E00;&#x6837;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x53EA;&#x5199;&#x4E00;&#x4E2A;&#x503C;&#xFF1B;&#x5411;&#x91CF;&#x4E4B;&#x95F4;&#x6216;&#x5411;&#x91CF;&#x4E0E;&#x6D6E;&#x70B9;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x52A0;&#x51CF;&#x4E58;&#x9664;&#x56DB;&#x5219;&#x8FD0;&#x7B97;&#xFF0C;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x6BCF;&#x4E2A;&#x5206;&#x91CF;&#x5355;&#x72EC;&#x8BA1;&#x7B97;&#x7684;&#x3002;</p>
<p>&#x53E6;&#x5916; vec3 &#x53EF;&#x4EE5;&#x7531; vec2+float &#x521B;&#x5EFA;&#x3001;vec4 &#x53EF;&#x4EE5;&#x7531; vec3+float&#x3001;vec2+vec2 &#x7B49;&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x521B;&#x5EFA;&#xFF0C;&#x6BD4;&#x8F83;&#x7075;&#x6D3B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;vec2 a = vec2(1.0, 0.0);</span><br><span class="line">// a.x=1.0 a.y=0.0</span><br><span class="line">a.x = 2.0;</span><br><span class="line">a.y = 0.5;</span><br><span class="line"></span><br><span class="line">vec2 a = vec2(1.0);</span><br><span class="line">// a.x=1.0 a.y=1.0</span><br><span class="line"></span><br><span class="line">// &#x5411;&#x91CF;&#x4E4B;&#x95F4;&#x6216;&#x5411;&#x91CF;&#x4E0E;&#x6D6E;&#x70B9;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x52A0;&#x51CF;&#x4E58;&#x9664;&#x56DB;&#x5219;&#x8FD0;&#x7B97;&#x662F;&#x57FA;&#x4E8E;&#x6BCF;&#x4E2A;&#x5206;&#x91CF;&#x5355;&#x72EC;&#x8BA1;&#x7B97;</span><br><span class="line">vec2 a = vec2(1.0) + vec2(0.1, 0.2);</span><br><span class="line">// a.x=1.1 a.y=1.2</span><br><span class="line">vec2 a = vec2(1.0) * 2.0;</span><br><span class="line">// a.x=2.0 a.y=2.0</span><br><span class="line"></span><br><span class="line">vec3 b = vec3(1.0, 2.0, 0.0);</span><br><span class="line">// b.x=1.0 b.y=2.0 b.z=0.0</span><br><span class="line">// b.r=1.0 b.g=2.0 b.b=0.0</span><br><span class="line">b.z = 3.0;</span><br><span class="line"></span><br><span class="line">vec4 c = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">// c.x=c.y=c.z=c.w=1.0</span><br><span class="line">// c.r=c.g=c.b=c.a=1.0</span><br><span class="line">c.r = 0.9</span><br><span class="line">c.g = 0.0;</span><br><span class="line">c.b = 0.0;</span><br><span class="line"></span><br><span class="line">vec3 d = vec3(vec2(0.5), 1.0);</span><br><span class="line">vec4 e = vec4(vec3(1.0), 1.0);</span><br><span class="line">vec4 e = vec4(vec2(0.3), vec2(0.1));</span><br></pre></td></tr></table></figure>

<p>vec3(1.0) &#x65E2;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F; x=y=z=1.0 &#x5904;&#x7684;&#x5750;&#x6807;&#x70B9;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F;&#x4ECE;&#x539F;&#x70B9;&#x6307;&#x5411;&#x8BE5;&#x70B9;&#x7684;&#x5411;&#x91CF;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F; r=g=b=1.0 &#x4E5F;&#x5C31;&#x662F;&#x767D;&#x8272;&#x989C;&#x8272;&#xFF0C;&#x6CE8;&#x610F;&#x5728; <strong>GLSL &#x91CC; rgb &#x8303;&#x56F4;&#x90FD;&#x662F; 0.0-1.0</strong>&#xFF0C;&#x800C;&#x975E;&#x4E00;&#x822C;&#x7684; 0-255&#x3002;&#x9ED1;&#x8272;&#x4E3A;(0.0,0.0,0.0)&#x3001;&#x767D;&#x8272;&#x4E3A;(1.0,1.0,1.0)&#x3001;&#x7EA2;&#x8272;&#x4E3A;(1.0,0.0,0.0)&#x2026;&#x2026;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x7684;&#x989C;&#x8272;&#x503C;&#x5C0F;&#x4E8E;0.0&#x4F1A;&#x88AB;&#x622A;&#x53D6;&#x5230;0.0&#xFF0C;&#x5927;&#x4E8E;1.0&#x4F1A;&#x88AB;&#x622A;&#x53D6;&#x5230;1.0&#x3002;</p>
<p>&#x53E6;&#x5916; GLSL &#x91CC;&#x7684;&#x51FD;&#x6570;&#x9700;&#x8981;&#x4EE5;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x7C7B;&#x578B;&#x5F00;&#x5934;&#xFF0C;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x5C31;&#x5982;&#x540C; main &#x4E3B;&#x51FD;&#x6570;&#x4E00;&#x6837;&#x4EE5; void &#x5F00;&#x5934;&#xFF0C;&#x51FD;&#x6570;&#x91CC;&#x6709;&#x53C2;&#x6570;&#x7684;&#x9700;&#x8981;&#x5199;&#x660E;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1B;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x3001;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x3001;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x7B49;&#x4E0D;&#x540C;&#x7684;&#x540C;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x5B58;&#x5728;&#x4EE5;&#x5B9E;&#x73B0;&#x7C7B;&#x4F3C;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x51FD;&#x6570;&#x91CD;&#x8F7D;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x91CC;&#x865A;&#x6784;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x652F;&#x6301;&#x4F20;&#x5165;&#x4E0D;&#x540C;&#x683C;&#x5F0F;&#x7684; rgb &#x989C;&#x8272;&#x6570;&#x503C;&#x4EE5;&#x5F97;&#x5230; hsl &#x989C;&#x8272;&#x683C;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;vec3 rgb2hsl(float r, float g, float b){</span><br><span class="line">  return vec3(1.0, 1.0, 1.0);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vec3 rgb2hsl(vec3 color){</span><br><span class="line">  return vec3(1.0, 1.0, 1.0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="Fragment-Shader"><a href="#Fragment-Shader" class="headerlink" title="Fragment Shader"></a>Fragment Shader</h2><p>&#x6709;&#x4E86;&#x524D;&#x9762;&#x8FD9;&#x4E9B; GLSL &#x57FA;&#x7840;&#xFF0C;&#x56DE;&#x8FC7;&#x5934;&#x770B; fragment shader &#x91CC;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x60F3;&#x6765;&#x5927;&#x5BB6;&#x5E94;&#x8BE5;&#x6CA1;&#x4EC0;&#x4E48;&#x7591;&#x95EE;&#x4E86;&#x5427;&#x3002;</p>
<p>&#x8BBE;&#x7F6E; gl_FragColor &#x4E3A; vec4(1.0, 0.0, 0.0, 1.0) &#x5C31;&#x662F;&#x8BBE;&#x7F6E;&#x7EA2;&#x8272;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4F1A;&#x901A;&#x8FC7; GPU &#x5BF9;&#x6240;&#x6709; plane &#x4E0A;&#x7684;&#x50CF;&#x7D20;&#x6267;&#x884C;&#xFF0C;&#x4E8E;&#x662F;&#x5448;&#x73B0;&#x51FA;&#x6765;&#x7684;&#x5C31;&#x662F;&#x7EA2;&#x8272;&#x7684;&#x5E73;&#x9762;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a9774fbde2b63271cd65ee1a3a8ddf03397127247c464a40ecaa268164012fff" alt></p>
<h2 id="&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;"><a href="#&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;" class="headerlink" title="&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;"></a>&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;</h2><p>&#x539F;&#x672C;&#x60F3;&#x7EE7;&#x7EED;&#x4EE5; uv &#x4E3A;&#x5207;&#x5165;&#x70B9;&#xFF0C;&#x8BB2;&#x8BB2;&#x5C06;&#x5176;&#x76F4;&#x63A5;&#x7528;&#x4E8E; fragment shader &#x91CC;&#x4F5C;&#x4E3A;&#x989C;&#x8272;&#xFF0C;&#x5E76;&#x7ED3;&#x5408; GLSL &#x7684;&#x4E00;&#x4E9B;&#x5185;&#x7F6E;&#x51FD;&#x6570;&#x4EE5;&#x751F;&#x6210;&#x91CD;&#x590D;&#x7684;&#x6761;&#x7EB9;&#x3001;&#x91CD;&#x590D;&#x7684;&#x5706;&#x5708;&#x7B49;&#x6548;&#x679C;&#xFF0C;&#x4F46;&#x4E00;&#x4E9B;&#x5FC5;&#x8981;&#x4ECB;&#x7ECD;&#x4E00;&#x5199;&#x8D77;&#x6765;&#x7BC7;&#x5E45;&#x5C31;&#x5197;&#x957F;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x8FD8;&#x6CA1;&#x6765;&#x53CA;&#x8BB2;&#x7684;&#x5185;&#x5BB9;&#x53EA;&#x80FD;&#x7559;&#x5230;&#x4E0B;&#x4E00;&#x7BC7;&#x7EE7;&#x7EED;&#xFF0C;&#x8FD9;&#x91CC;&#x5148;&#x7ED9;&#x5927;&#x5BB6;&#x770B;&#x770B;&#x65E9;&#x5C31;&#x751F;&#x6210;&#x7684;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x914D;&#x56FE;&#x5C1D;&#x5C1D;&#x9C9C;&#xFF08;&#x5F53;&#x7136;&#x670B;&#x53CB;&#x5708;&#x548C;&#x7FA4;&#x91CC;&#x65E9;&#x5C31;&#x653E;&#x51FA;&#x53BB;&#x4E86;&#xFF0C;&#x4E5F;&#x6B22;&#x8FCE;&#x65B0;&#x670B;&#x53CB;&#x6765;&#x56F4;&#x89C2;&#x4E0E;&#x4EA4;&#x6D41;&#xFF09;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6347d7b1757b748da57f4d6e04164f05a3ce6e59b7afe4f71e5c9f74555f424" alt></p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x672C;&#x6587;&#x53EA;&#x8BB2;&#x4E86;&#x4E9B;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x76EE;&#x524D;&#x5927;&#x5BB6;&#x9700;&#x8981;&#x77E5;&#x9053;&#x7684; GLSL &#x57FA;&#x7840;&#xFF0C;&#x6709;&#x610F;&#x4E0D;&#x5199;&#x6210;&#x5927;&#x800C;&#x5168;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x53EA;&#x6D89;&#x53CA;&#x5F53;&#x524D;&#x591F;&#x7528;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x540E;&#x9762;&#x7B49;&#x8BB2;&#x5230;&#x5176;&#x4ED6;&#x4F8B;&#x5B50;&#x65F6;&#x518D;&#x4E00;&#x6B65;&#x6B65;&#x5E26;&#x51FA;&#x6765;&#x66F4;&#x591A;&#x5185;&#x5BB9;&#x3002;&#x5F53;&#x7136;&#x5982;&#x6587;&#x7AE0;&#x5F00;&#x5934;&#x6240;&#x8A00;&#xFF0C;&#x8BB2;&#x89E3;&#x5730;&#x53EF;&#x80FD;&#x4ECD;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x4E86;&#x89E3;&#x66F4;&#x591A; GLSL &#x57FA;&#x7840;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x8FD8;&#x4E0D;&#x9519;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="https://dev.newban.cn/7158032481302609950">Three.js &#x8FDB;&#x9636;&#x4E4B;&#x65C5;&#xFF1A;Shader&#x7740;&#x8272;&#x5668;&#x5165;&#x95E8;</a></li>
</ul>
<h2 id="&#x7167;&#x4F8B;"><a href="#&#x7167;&#x4F8B;" class="headerlink" title="&#x7167;&#x4F8B;"></a>&#x7167;&#x4F8B;</h2><p>&#x6700;&#x540E;&#x6B22;&#x8FCE;&#x52A0;&#x5165;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x4EA4;&#x6D41;&#x7FA4;&#x300D;</code>&#xFF0C;&#x8FDB;&#x7FA4;&#x591A;&#x591A;&#x4EA4;&#x6D41;&#xFF0C;&#x5BF9;&#x672C;&#x6587;&#x4EFB;&#x4F55;&#x5730;&#x65B9;&#x6709;&#x7591;&#x60D1;&#x7684;&#x53EF;&#x4EE5;&#x7FA4;&#x91CC;&#x63D0;&#x95EE;&#x3002;&#x52A0;&#x53E4;&#x67F3;&#x5FAE;&#x4FE1;&#xFF1A;<code>xiaoaizhj</code>&#xFF0C;&#x5907;&#x6CE8;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x52A0;&#x7FA4;&#x300D;</code>&#x5373;&#x53EF;&#x3002;</p>
<p>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x53E4;&#x67F3;&#x7684;&#x516C;&#x4F17;&#x53F7;<code>&#x300C;&#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</code>&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x661F;&#x6807;&#xFF0C;&#x4EE5;&#x4FBF;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x6536;&#x5230;&#x66F4;&#x65B0;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e5c6edad625b0946ccf95ed3469deef0.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../101/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../101/">101</a><span class="page-number current">102</span><a class="page-number" href="../103/">103</a><span class="space">&hellip;</span><a class="page-number" href="../178/">178</a><a class="extend next" rel="next" href="../103/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">1775</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">725</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
