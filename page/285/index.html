<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/285/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/285/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512325750797.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512325750797.html" itemprop="url">linux namespace and cgroup nam</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T12:09:21+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h1><p>&#x53C2;&#x8003; </p>
<ul>
<li><a href="/external_links/52cfb7f4b076cadb79c6b0c73dfd7519.html" target="blank" rel="noopener">coolshell.cn/articles/17&#x2026;</a></li>
<li><a href="/external_links/6f7e00949d277ca2e4748094bdfcb062.html" target="blank" rel="noopener">coolshell.cn/articles/17&#x2026;</a></li>
<li><a href="/external_links/32ade2c59223296ac862c5167e83c4f5.html" target="blank" rel="noopener">www.infoq.com/cn/articles&#x2026;</a></li>
<li><a href="/external_links/894161647814104476c6321ec005161e.html" target="blank" rel="noopener">www.ibm.com/developerwo&#x2026;</a></li>
<li><a href="/external_links/41dd984862d502e81fc8027cdbd3806f.html" target="blank" rel="noopener">yeasy.gitbooks.io/docker_prac&#x2026;</a></li>
<li><a href="/external_links/33f559671e764e7c4d29cdce16522ad3.html" target="blank" rel="noopener">coolshell.cn/articles/17&#x2026;</a></li>
<li><a href="/external_links/85079190a8d7a7b4b6d522ae2444930f.html" target="blank" rel="noopener">www.infoq.com/cn/articles&#x2026;</a></li>
<li><a href="/external_links/9c36c04d97a63b859404cf31e4705700.html" target="blank" rel="noopener">www.infoq.com/cn/articles&#x2026;</a></li>
<li><a href="/external_links/bc9e927e63fdf6df2d1aecd320ebcea1.html" target="blank" rel="noopener">www.infoq.com/cn/articles&#x2026;</a></li>
<li><a href="/external_links/3f070f51eba2513ac3faa36fd621a86c.html" target="blank" rel="noopener">lecury.cn/linux_names&#x2026;</a></li>
<li><a href="/external_links/ae1da467693264c8d5887473e3751da4.html" target="blank" rel="noopener">lwn.net/Articles/53&#x2026;</a></li>
<li><a href="/external_links/33f559671e764e7c4d29cdce16522ad3.html" target="blank" rel="noopener">coolshell.cn/articles/17&#x2026;</a></li>
<li><a href="/external_links/208774bdb769bbd4aa0df7ff5de66e47.html" target="blank" rel="noopener">www.cnblogs.com/caoxiaojian&#x2026;</a></li>
<li><a href="/external_links/9a5d1897eb6ddef90281a5d0877d5610.html" target="blank" rel="noopener">blog.csdn.net/zhangyifei2&#x2026;</a></li>
</ul>
<h2 id="&#x7B80;&#x4ECB;"><a href="#&#x7B80;&#x4ECB;" class="headerlink" title="&#x7B80;&#x4ECB;"></a>&#x7B80;&#x4ECB;</h2><p>Linux Namespace&#x662F;Linux&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;&#x5185;&#x6838;&#x7EA7;&#x522B;&#x73AF;&#x5883;&#x9694;&#x79BB;&#x7684;&#x65B9;&#x6CD5;&#x3002;<br>&#x63D0;&#x4F9B;&#x4E86;&#x5BF9;UTS&#x3001;IPC&#x3001;mount&#x3001;PID&#x3001;network&#x3001;User&#x7B49;&#x7684;&#x9694;&#x79BB;&#x673A;&#x5236;&#x3002;</p>
<h3 id="&#x5206;&#x7C7B;"><a href="#&#x5206;&#x7C7B;" class="headerlink" title="&#x5206;&#x7C7B;"></a>&#x5206;&#x7C7B;</h3><table>
<thead>
<tr>
<th></th>
<th>&#x5206;&#x7C7B;</th>
<th>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53C2;&#x6570;</th>
<th>&#x76F8;&#x5173;&#x5185;&#x6838;&#x7248;&#x672C;</th>
<th>&#x9694;&#x79BB;&#x5185;&#x5BB9;</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Mount namespaces</td>
<td>CLONE_NEWNS</td>
<td>Linux 2.4.19</td>
<td>&#x6302;&#x8F7D;&#x70B9;&#xFF08;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF09;</td>
</tr>
<tr>
<td></td>
<td>UTS namespaces</td>
<td>CLONE_NEWUTS</td>
<td>Linux 2.6.19</td>
<td>&#x4E3B;&#x673A;&#x540D;&#x4E0E;&#x57DF;&#x540D;,&#x5F71;&#x54CD;uname(hostname, domainname)</td>
</tr>
<tr>
<td></td>
<td>IPC namespaces</td>
<td>CLONE_NEWIPC</td>
<td>Linux 2.6.19</td>
<td>&#x4FE1;&#x53F7;&#x91CF;&#x3001;&#x6D88;&#x606F;&#x961F;&#x5217;&#x548C;&#x5171;&#x4EAB;&#x5185;&#x5B58;, inter-process communication&#xFF0C;&#x6709;&#x5168;&#x5C40;id</td>
</tr>
<tr>
<td></td>
<td>PID namespaces</td>
<td>CLONE_NEWPID</td>
<td>Linux 2.6.24</td>
<td>&#x8FDB;&#x7A0B;&#x7F16;&#x53F7;</td>
</tr>
<tr>
<td></td>
<td>Network namespaces</td>
<td>CLONE_NEWNET</td>
<td>&#x59CB;&#x4E8E;Linux 2.6.24 &#x5B8C;&#x6210;&#x4E8E; Linux 2.6.29</td>
<td>&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x3001;&#x7F51;&#x7EDC;&#x6808;&#x3001;&#x7AEF;&#x53E3;&#x7B49;&#x7B49;</td>
</tr>
<tr>
<td></td>
<td>User namespaces</td>
<td>CLONE_NEWUSER</td>
<td>&#x59CB;&#x4E8E; Linux 2.6.23 &#x5B8C;&#x6210;&#x4E8E; Linux 3.8)</td>
<td>&#x7528;&#x6237;&#x548C;&#x7528;&#x6237;&#x7EC4;</td>
</tr>
</tbody></table>
<h3 id="&#x4E09;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"><a href="#&#x4E09;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="headerlink" title="&#x4E09;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"></a>&#x4E09;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h3><table>
<thead>
<tr>
<th>&#x8C03;&#x7528;</th>
<th>&#x4F5C;&#x7528;</th>
</tr>
</thead>
<tbody><tr>
<td>clone()</td>
<td>&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x7528;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x8BA1;&#x4E0A;&#x8FF0;&#x53C2;&#x6570;&#x8FBE;&#x5230;&#x9694;&#x79BB;&#x3002;</td>
</tr>
<tr>
<td>unshare()</td>
<td>&#x4F7F;&#x67D0;&#x8FDB;&#x7A0B;&#x8131;&#x79BB;&#x67D0;&#x4E2A;namespace</td>
</tr>
<tr>
<td>setns()</td>
<td>&#x628A;&#x67D0;&#x8FDB;&#x7A0B;&#x52A0;&#x5165;&#x5230;&#x67D0;&#x4E2A;namespace</td>
</tr>
</tbody></table>
<h2 id="&#x8BE6;&#x89E3;"><a href="#&#x8BE6;&#x89E3;" class="headerlink" title="&#x8BE6;&#x89E3;"></a>&#x8BE6;&#x89E3;</h2><p>&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#define _GNU_SOURCE</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sched.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">/* &#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x7ED9; clone &#x7528;&#x7684;&#x6808;&#xFF0C;&#x6808;&#x5927;&#x5C0F;1M */</span><br><span class="line">#define STACK_SIZE (1024 * 1024)</span><br><span class="line">static char container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line">char* const container_args[] = {</span><br><span class="line">    &quot;/bin/bash&quot;,</span><br><span class="line">    NULL</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int container_main(void* arg)</span><br><span class="line">{</span><br><span class="line">    printf(&quot;Container - inside the container!\n&quot;);</span><br><span class="line">    /* &#x76F4;&#x63A5;&#x6267;&#x884C;&#x4E00;&#x4E2A;shell&#xFF0C;&#x4EE5;&#x4FBF;&#x6211;&#x4EEC;&#x89C2;&#x5BDF;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7A7A;&#x95F4;&#x91CC;&#x7684;&#x8D44;&#x6E90;&#x662F;&#x5426;&#x88AB;&#x9694;&#x79BB;&#x4E86; */</span><br><span class="line">    sethostname(&quot;container&quot;,10); /* &#x8BBE;&#x7F6E;hostname */</span><br><span class="line"></span><br><span class="line">    execv(container_args[0], container_args); </span><br><span class="line">    printf(&quot;Something&apos;s wrong!\n&quot;);</span><br><span class="line">    return 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">{</span><br><span class="line">    printf(&quot;Parent - start a container!\n&quot;);</span><br><span class="line">    /* &#x8C03;&#x7528;clone&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x4F20;&#x51FA;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x6808;&#x7A7A;&#x95F4;&#x7684;&#xFF08;&#x4E3A;&#x4EC0;&#x4E48;&#x4F20;&#x5C3E;&#x6307;&#x9488;&#xFF0C;&#x56E0;&#x4E3A;&#x6808;&#x662F;&#x53CD;&#x7740;&#x7684;&#xFF09; */</span><br><span class="line">    // int container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD, NULL);</span><br><span class="line">    // int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | SIGCHLD, NULL); /*&#x542F;&#x7528;CLONE_NEWUTS Namespace&#x9694;&#x79BB; */</span><br><span class="line">    int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | CLONE_NEWIPC | SIGCHLD, NULL);</span><br><span class="line"></span><br><span class="line">    /* &#x7B49;&#x5F85;&#x5B50;&#x8FDB;&#x7A0B;&#x7ED3;&#x675F; */</span><br><span class="line">    waitpid(container_pid, NULL, 0);</span><br><span class="line">    printf(&quot;Parent - container stopped!\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="UTS-Namespace"><a href="#UTS-Namespace" class="headerlink" title="UTS Namespace"></a>UTS Namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&#x52A0;&#x5165; </span><br><span class="line">sethostname(&quot;container&quot;,10); /* &#x8BBE;&#x7F6E;hostname */</span><br><span class="line"></span><br><span class="line">int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | SIGCHLD, NULL); /*&#x542F;&#x7528;CLONE_NEWUTS Namespace&#x9694;&#x79BB; */</span><br><span class="line"></span><br><span class="line">root@container:~/testnamespace# uname -a</span><br><span class="line">Linux container 4.4.0-96-generic #119-Ubuntu SMP Tue Sep 12 14:59:54 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">root@container:~/testnamespace# hostname</span><br><span class="line">container</span><br></pre></td></tr></table></figure>

<h3 id="IPC-Namespace"><a href="#IPC-Namespace" class="headerlink" title="IPC Namespace"></a>IPC Namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;</span><br><span class="line">// &#x5982;&#x679C;&#x9694;&#x79BB;&#x4E86; ipcs -q &#x770B;&#x4E0D;&#x5230;&#x5916;&#x9762;&#x7684;&#xFF0C;&#x5426;&#x5219;&#x80FD;&#x770B;&#x5230;</span><br><span class="line"></span><br><span class="line">root@kube-master:~/testnamespace# ipcs -a</span><br><span class="line"></span><br><span class="line">------ Message Queues --------</span><br><span class="line">key        msqid      owner      perms      used-bytes   messages</span><br><span class="line">0x10d91bac 0          root       644        0            0</span><br><span class="line">0xb92f99fd 32769      root       644        0            0</span><br><span class="line">0xfcebd528 65538      root       644        0            0</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status</span><br><span class="line">0x00000000 0          root       644        80         2</span><br><span class="line">0x00000000 32769      root       644        16384      2</span><br><span class="line">0x00000000 65538      root       644        280        2</span><br><span class="line"></span><br><span class="line">------ Semaphore Arrays --------</span><br><span class="line">key        semid      owner      perms      nsems</span><br><span class="line">0x000000a7 0          root       600        1</span><br></pre></td></tr></table></figure>

<h3 id="PID-Namespace"><a href="#PID-Namespace" class="headerlink" title="PID Namespace"></a>PID Namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801; int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | CLONE_NEWPID | SIGCHLD, NULL); </span><br><span class="line"></span><br><span class="line">&#x6CA1;&#x6709;&#x9694;&#x79BB;</span><br><span class="line">root@container:~/testnamespace# ps -a</span><br><span class="line">  PID TTY          TIME CMD</span><br><span class="line">10079 pts/0    00:00:00 a.out</span><br><span class="line"></span><br><span class="line">&#x9694;&#x79BB;&#x4E4B;&#x540E;</span><br><span class="line">root@container:~# echo ?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">&#x4F46;&#x662F; ps -a&#x6CA1;&#x6709;&#x53D8;&#x5316;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;ps, top&#x8FD9;&#x4E9B;&#x547D;&#x4EE4;&#x4F1A;&#x53BB;&#x8BFB;/proc&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x56E0;&#x4E3A;/proc&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x5728;&#x7236;&#x8FDB;&#x7A0B;&#x548C;&#x5B50;&#x8FDB;&#x7A0B;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E9B;&#x547D;&#x4EE4;&#x663E;&#x793A;&#x7684;&#x4E1C;&#x897F;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;</span><br></pre></td></tr></table></figure>

<p>pid 1 &#x662F;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x7684;pid&#x9700;&#x8981;&#x6709;&#x8FDB;&#x7A0B;&#x76D1;&#x63A7;&#x548C;&#x8D44;&#x6E90;&#x56DE;&#x6536;&#x7684;&#x80FD;&#x529B;&#xFF0C; docker 1.13 &#x5F15;&#x5165;&#x4E86;&#x4E00;&#x4E2A; &#x2013;init &#x53C2;&#x6570;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;<br>&#x2013;init false Run an init inside the container that forwards signals and reaps processes<br>&#x53C2;&#x8003; <a href="/external_links/e22a95dc9130565e89e7f39c7cb795f0.html" target="blank" rel="noopener">blog.phusion.nl/2015/01/20/&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&#x279C;  ke git:(alb) &#x2717; docker run  alpine  ps</span><br><span class="line">PID   USER     TIME   COMMAND</span><br><span class="line">    1 root       0:00 ps</span><br><span class="line">&#x279C;  ke git:(alb) &#x2717; docker run --init  alpine  ps</span><br><span class="line">PID   USER     TIME   COMMAND</span><br><span class="line">    1 root       0:00 /dev/init -- ps</span><br><span class="line">    5 root       0:00 ps</span><br></pre></td></tr></table></figure>

<p>unshare()&#x548C;setns()&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5BF9;PID Namespace&#x7684;&#x5904;&#x7406;&#x4E0D;&#x592A;&#x76F8;&#x540C;&#xFF0C;&#x5F53;unshare PID namespace&#x65F6;&#xFF0C;&#x8C03;&#x7528;&#x8FDB;&#x7A0B;&#x4F1A;&#x4E3A;&#x5B83;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;PID Namespace&#xFF0C;&#x4F46;&#x662F;&#x8C03;&#x7528;&#x8FDB;&#x7A0B;&#x672C;&#x8EAB;&#x4E0D;&#x4F1A;&#x88AB;&#x79FB;&#x5230;&#x65B0;&#x7684;Namespace&#x4E2D;&#x3002;&#x800C;&#x4E14;&#x8C03;&#x7528;&#x8FDB;&#x7A0B;&#x7B2C;&#x4E00;&#x4E2A;&#x521B;&#x5EFA;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x5728;&#x65B0;Namespace&#x4E2D;&#x7684;PID&#x4E3A;1&#xFF0C;&#x5E76;&#x6210;&#x4E3A;&#x65B0;Namespace&#x4E2D;&#x7684;init&#x8FDB;&#x7A0B;&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x521B;&#x5EFA;&#x5176;&#x4ED6;&#x7684;Namespace&#x65F6;unshare()&#x548C;setns()&#x4F1A;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x65B0;&#x7684;Namespace&#xFF0C;&#x800C;&#x552F;&#x72EC;PID Namespace&#x4E0D;&#x662F;&#x5982;&#x6B64;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x8C03;&#x7528;getpid()&#x51FD;&#x6570;&#x5F97;&#x5230;&#x7684;PID&#x662F;&#x6839;&#x636E;&#x8C03;&#x7528;&#x8005;&#x6240;&#x5728;&#x7684;PID Namespace&#x800C;&#x51B3;&#x5B9A;&#x8FD4;&#x56DE;&#x54EA;&#x4E2A;PID&#xFF0C;&#x8FDB;&#x5165;&#x65B0;&#x7684;PID namespace&#x4F1A;&#x5BFC;&#x81F4;PID&#x4EA7;&#x751F;&#x53D8;&#x5316;&#x3002;&#x800C;&#x5BF9;&#x7528;&#x6237;&#x6001;&#x7684;&#x7A0B;&#x5E8F;&#x548C;&#x5E93;&#x51FD;&#x6570;&#x6765;&#x8BF4;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x8BA4;&#x4E3A;&#x8FDB;&#x7A0B;&#x7684;PID&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x91CF;&#xFF0C;PID&#x7684;&#x53D8;&#x5316;&#x4F1A;&#x5F15;&#x8D77;&#x8FD9;&#x4E9B;&#x8FDB;&#x7A0B;&#x5954;&#x6E83;&#x3002;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x4E00;&#x65E6;&#x7A0B;&#x5E8F;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4EE5;&#x540E;&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x7684;PID namespace&#x7684;&#x5173;&#x7CFB;&#x5C31;&#x786E;&#x5B9A;&#x4E0B;&#x6765;&#x4E86;&#xFF0C;&#x8FDB;&#x7A0B;&#x4E0D;&#x4F1A;&#x53D8;&#x66F4;&#x4ED6;&#x4EEC;&#x5BF9;&#x5E94;&#x7684;PID namespace&#x3002;</p>
<h3 id="Mount-Namespace"><a href="#Mount-Namespace" class="headerlink" title="Mount Namespace"></a>Mount Namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdlib.h&gt;</span><br><span class="line">system(&quot;mount -t proc proc /proc&quot;);</span><br><span class="line"> /* &#x542F;&#x7528;Mount Namespace - &#x589E;&#x52A0;CLONE_NEWNS&#x53C2;&#x6570; */</span><br><span class="line">int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">        CLONE_NEWUTS | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL);</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x65F6;&#x5019; ps&#x5C31;&#x5E72;&#x51C0;&#x591A;&#x4E86;</span><br><span class="line">root@vm-master:~/testnamespace# ps -aux</span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root         1  0.0  0.0  20036  3868 pts/1    S    12:24   0:00 /bin/bash</span><br><span class="line">root        15  0.0  0.0  36084  3228 pts/1    R+   12:24   0:00 ps -aux</span><br></pre></td></tr></table></figure>

<p>&#x5173;&#x4E8E;mount&#x547D;&#x4EE4;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&#x6A21;&#x4EFF;Docker&#x7684;Mount Namespace&#x3002;</span><br><span class="line">&#x5148;&#x8981;&#x505A;&#x4E00;&#x4E2A;rootfs&#x6587;&#x4EF6;&#x5939;</span><br><span class="line">hchen@ubuntu:~/rootfs$ ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  mnt  opt  proc  root  run  sbin  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line">// &#x62F7;&#x8D1D;&#x5FC5;&#x8981;&#x7684;&#x547D;&#x4EE4;</span><br><span class="line">hchen@ubuntu:~/rootfs$ ls ./bin ./usr/bin</span><br><span class="line"></span><br><span class="line">./bin:</span><br><span class="line">bash   chown  gzip      less  mount       netstat  rm     tabs  tee      top       tty</span><br><span class="line">cat    cp     hostname  ln    mountpoint  ping     sed    tac   test     touch     umount</span><br><span class="line">chgrp  echo   ip        ls    mv          ps       sh     tail  timeout  tr        uname</span><br><span class="line">chmod  grep   kill      more  nc          pwd      sleep  tar   toe      truncate  which</span><br><span class="line"></span><br><span class="line">./usr/bin:</span><br><span class="line">awk  env  groups  head  id  mesg  sort  strace  tail  top  uniq  vi  wc  xargs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x62F7;&#x8D1D;&#x547D;&#x4EE4;&#x8981;&#x7528;&#x7684;sso</span><br><span class="line">hchen@ubuntu:~/rootfs$ ls ./lib64 ./lib/x86_64-linux-gnu/</span><br><span class="line"></span><br><span class="line">./lib64:</span><br><span class="line">ld-linux-x86-64.so.2</span><br><span class="line"></span><br><span class="line">./lib/x86_64-linux-gnu/:</span><br><span class="line">libacl.so.1      libmemusage.so         libnss_files-2.19.so    libpython3.4m.so.1</span><br><span class="line">libacl.so.1.1.0  libmount.so.1          libnss_files.so.2       libpython3.4m.so.1.0</span><br><span class="line">libattr.so.1     libmount.so.1.1.0      libnss_hesiod-2.19.so   libresolv-2.19.so</span><br><span class="line">libblkid.so.1    libm.so.6              libnss_hesiod.so.2      libresolv.so.2</span><br><span class="line">libc-2.19.so     libncurses.so.5        libnss_nis-2.19.so      libselinux.so.1</span><br><span class="line">libcap.a         libncurses.so.5.9      libnss_nisplus-2.19.so  libtinfo.so.5</span><br><span class="line">libcap.so        libncursesw.so.5       libnss_nisplus.so.2     libtinfo.so.5.9</span><br><span class="line">libcap.so.2      libncursesw.so.5.9     libnss_nis.so.2         libutil-2.19.so</span><br><span class="line">libcap.so.2.24   libnsl-2.19.so         libpcre.so.3            libutil.so.1</span><br><span class="line">libc.so.6        libnsl.so.1            libprocps.so.3          libuuid.so.1</span><br><span class="line">libdl-2.19.so    libnss_compat-2.19.so  libpthread-2.19.so      libz.so.1</span><br><span class="line">libdl.so.2       libnss_compat.so.2     libpthread.so.0</span><br><span class="line">libgpm.so.2      libnss_dns-2.19.so     libpython2.7.so.1</span><br><span class="line">libm-2.19.so     libnss_dns.so.2        libpython2.7.so.1.0</span><br><span class="line"></span><br><span class="line">// &#x62F7;&#x8D1D;&#x5FC5;&#x8981;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</span><br><span class="line">hchen@ubuntu:~/rootfs$ ls ./etc</span><br><span class="line">bash.bashrc  group  hostname  hosts  ld.so.cache  nsswitch.conf  passwd  profile  </span><br><span class="line">resolv.conf  shadow</span><br><span class="line"></span><br><span class="line">// &#x4F9B;&#x6302;&#x8F7D;&#x7528;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</span><br><span class="line">hchen@ubuntu:~$ ls ./conf</span><br><span class="line">hostname     hosts     resolv.conf</span><br><span class="line"></span><br><span class="line">#define _GNU_SOURCE</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line">#include &lt;sys/mount.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sched.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">#define STACK_SIZE (1024 * 1024)</span><br><span class="line"></span><br><span class="line">static char container_stack[STACK_SIZE];</span><br><span class="line">char* const container_args[] = {</span><br><span class="line">    &quot;/bin/bash&quot;,</span><br><span class="line">    &quot;-l&quot;,</span><br><span class="line">    NULL</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int container_main(void* arg)</span><br><span class="line">{</span><br><span class="line">    printf(&quot;Container [%5d] - inside the container!\n&quot;, getpid());</span><br><span class="line"></span><br><span class="line">    //set hostname</span><br><span class="line">    sethostname(&quot;container&quot;,10);</span><br><span class="line"></span><br><span class="line">    //remount &quot;/proc&quot; to make sure the &quot;top&quot; and &quot;ps&quot; show container&apos;s information</span><br><span class="line">    if (mount(&quot;proc&quot;, &quot;rootfs/proc&quot;, &quot;proc&quot;, 0, NULL) !=0 ) {</span><br><span class="line">        perror(&quot;proc&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;sysfs&quot;, &quot;rootfs/sys&quot;, &quot;sysfs&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;sys&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;none&quot;, &quot;rootfs/tmp&quot;, &quot;tmpfs&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;tmp&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;udev&quot;, &quot;rootfs/dev&quot;, &quot;devtmpfs&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;dev&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;devpts&quot;, &quot;rootfs/dev/pts&quot;, &quot;devpts&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;dev/pts&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;shm&quot;, &quot;rootfs/dev/shm&quot;, &quot;tmpfs&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;dev/shm&quot;);</span><br><span class="line">    }</span><br><span class="line">    if (mount(&quot;tmpfs&quot;, &quot;rootfs/run&quot;, &quot;tmpfs&quot;, 0, NULL)!=0) {</span><br><span class="line">        perror(&quot;run&quot;);</span><br><span class="line">    }</span><br><span class="line">    /* </span><br><span class="line">     * &#x6A21;&#x4EFF;Docker&#x7684;&#x4ECE;&#x5916;&#x5411;&#x5BB9;&#x5668;&#x91CC;mount&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6; </span><br><span class="line">     * &#x4F60;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#xFF1A;/var/lib/docker/containers/&lt;container_id&gt;/&#x76EE;&#x5F55;&#xFF0C;</span><br><span class="line">     * &#x4F60;&#x4F1A;&#x770B;&#x5230;docker&#x7684;&#x8FD9;&#x4E9B;&#x6587;&#x4EF6;&#x7684;&#x3002;</span><br><span class="line">     */</span><br><span class="line">    if (mount(&quot;conf/hosts&quot;, &quot;rootfs/etc/hosts&quot;, &quot;none&quot;, MS_BIND, NULL)!=0 ||</span><br><span class="line">          mount(&quot;conf/hostname&quot;, &quot;rootfs/etc/hostname&quot;, &quot;none&quot;, MS_BIND, NULL)!=0 ||</span><br><span class="line">          mount(&quot;conf/resolv.conf&quot;, &quot;rootfs/etc/resolv.conf&quot;, &quot;none&quot;, MS_BIND, NULL)!=0 ) {</span><br><span class="line">        perror(&quot;conf&quot;);</span><br><span class="line">    }</span><br><span class="line">    /* &#x6A21;&#x4EFF;docker run&#x547D;&#x4EE4;&#x4E2D;&#x7684; -v, --volume=[] &#x53C2;&#x6570;&#x5E72;&#x7684;&#x4E8B; */</span><br><span class="line">    if (mount(&quot;/tmp/t1&quot;, &quot;rootfs/mnt&quot;, &quot;none&quot;, MS_BIND, NULL)!=0) {</span><br><span class="line">        perror(&quot;mnt&quot;);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /* chroot &#x9694;&#x79BB;&#x76EE;&#x5F55; */</span><br><span class="line">    if ( chdir(&quot;./rootfs&quot;) != 0 || chroot(&quot;./&quot;) != 0 ){</span><br><span class="line">        perror(&quot;chdir/chroot&quot;);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    execv(container_args[0], container_args);</span><br><span class="line">    perror(&quot;exec&quot;);</span><br><span class="line">    printf(&quot;Something&apos;s wrong!\n&quot;);</span><br><span class="line">    return 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">{</span><br><span class="line">    printf(&quot;Parent [%5d] - start a container!\n&quot;, getpid());</span><br><span class="line">    int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL);</span><br><span class="line">    waitpid(container_pid, NULL, 0);</span><br><span class="line">    printf(&quot;Parent - container stopped!\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FDB;&#x7A0B;&#x5728;&#x521B;&#x5EFA;mount namespace&#x65F6;&#xFF0C;&#x4F1A;&#x628A;&#x5F53;&#x524D;&#x7684;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x590D;&#x5236;&#x7ED9;&#x65B0;&#x7684;namespace&#x3002;&#x65B0;namespace&#x4E2D;&#x7684;&#x6240;&#x6709;mount&#x64CD;&#x4F5C;&#x90FD;&#x53EA;&#x5F71;&#x54CD;&#x81EA;&#x8EAB;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x800C;&#x5BF9;&#x5916;&#x754C;&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x4EFB;&#x4F55;&#x5F71;&#x54CD;&#x3002;&#x8FD9;&#x6837;&#x505A;&#x975E;&#x5E38;&#x4E25;&#x683C;&#x5730;&#x5B9E;&#x73B0;&#x4E86;&#x9694;&#x79BB;&#xFF0C;&#x4F46;&#x662F;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x53EF;&#x80FD;&#x5E76;&#x4E0D;&#x9002;&#x7528;&#x3002;&#x6BD4;&#x5982;&#x7236;&#x8282;&#x70B9;namespace&#x4E2D;&#x7684;&#x8FDB;&#x7A0B;&#x6302;&#x8F7D;&#x4E86;&#x4E00;&#x5F20;CD-ROM&#xFF0C;&#x8FD9;&#x65F6;&#x5B50;&#x8282;&#x70B9;namespace&#x62F7;&#x8D1D;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;&#x5C31;&#x65E0;&#x6CD5;&#x81EA;&#x52A8;&#x6302;&#x8F7D;&#x4E0A;&#x8FD9;&#x5F20;CD-ROM&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x79CD;&#x64CD;&#x4F5C;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x7236;&#x8282;&#x70B9;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>2006 &#x5E74;&#x5F15;&#x5165;&#x7684;&#x6302;&#x8F7D;&#x4F20;&#x64AD;&#xFF08;mount propagation&#xFF09;&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x6302;&#x8F7D;&#x4F20;&#x64AD;&#x5B9A;&#x4E49;&#x4E86;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#xFF08;mount object&#xFF09;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x7CFB;&#x7EDF;&#x7528;&#x8FD9;&#x4E9B;&#x5173;&#x7CFB;&#x51B3;&#x5B9A;&#x4EFB;&#x4F55;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x6302;&#x8F7D;&#x4E8B;&#x4EF6;&#x5982;&#x4F55;&#x4F20;&#x64AD;&#x5230;&#x5176;&#x4ED6;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#xFF08;&#x53C2;&#x8003;&#x81EA;&#xFF1A;<a href="/external_links/23fe52d97ce3b5bab634c8c365b055da.html" target="blank" rel="noopener">www.ibm.com/developerwo&#x2026;</a></p>
<p>&#x8FDB;&#x7A0B;&#x5728;&#x521B;&#x5EFA;Mount Namespace&#x65F6;&#xFF0C;&#x4F1A;&#x628A;&#x5F53;&#x524D;&#x7684;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x590D;&#x5236;&#x7ED9;&#x65B0;&#x7684;Namespace&#xFF0C;&#x65B0;&#x7684;Namespace&#x4E2D;&#x7684;&#x6240;&#x6709;mount&#x64CD;&#x4F5C;&#x4EC5;&#x5F71;&#x54CD;&#x81EA;&#x8EAB;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x3002;&#x4F46;&#x968F;&#x7740;&#x5F15;&#x5165;&#x6302;&#x8F7D;&#x4F20;&#x64AD;&#x7684;&#x7279;&#x6027;&#xFF0C;Mount Namespace&#x53D8;&#x5F97;&#x5E76;&#x4E0D;&#x662F;&#x5B8C;&#x5168;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x8D44;&#x6E90;&#x9694;&#x79BB;&#xFF0C;&#x8FD9;&#x79CD;&#x4F20;&#x64AD;&#x7279;&#x6027;&#x4F7F;&#x5F97;&#x591A;Mount Namespace&#x4E4B;&#x95F4;&#x7684;&#x6302;&#x8F7D;&#x4E8B;&#x4EF6;&#x53EF;&#x4EE5;&#x76F8;&#x4E92;&#x5F71;&#x54CD;&#x3002;</p>
<p>&#x6302;&#x8F7D;&#x4F20;&#x64AD;&#x5B9A;&#x4E49;&#x4E86;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x7CFB;&#x7EDF;&#x5229;&#x7528;&#x8FD9;&#x4E9B;&#x5173;&#x7CFB;&#x6765;&#x51B3;&#x5B9A;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x6302;&#x8F7D;&#x4E8B;&#x4EF6;&#x5BF9;&#x5176;&#x4ED6;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x7684;&#x5F71;&#x54CD;&#x3002;&#x5176;&#x4E2D;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x5171;&#x4EAB;&#x5173;&#x7CFB;(MS_SHARED)&#xFF1A;&#x4E00;&#x4E2A;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x7684;&#x6302;&#x8F7D;&#x4E8B;&#x4EF6;&#x4F1A;&#x8DE8;Namespace&#x5171;&#x4EAB;&#x5230;&#x5176;&#x4ED6;&#x6302;&#x8F7D;&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x4ECE;&#x5C5E;&#x5173;&#x7CFB;(MS_SLAVE): &#x4F20;&#x64AD;&#x7684;&#x65B9;&#x5411;&#x662F;&#x5355;&#x5411;&#x7684;&#xFF0C;&#x5373;&#x53EA;&#x80FD;&#x4ECE;Master&#x4F20;&#x64AD;&#x5230;Slave&#x65B9;&#x5411;&#x3002;</li>
<li>&#x79C1;&#x6709;&#x5173;&#x7CFB;(MS_PRIVATE): &#x4E0D;&#x540C;Namespace&#x7684;&#x6302;&#x8F7D;&#x4E8B;&#x4EF6;&#x662F;&#x4E92;&#x4E0D;&#x5F71;&#x54CD;&#x7684;(&#x9ED8;&#x8BA4;&#x9009;&#x9879;)&#x3002;</li>
<li>&#x4E0D;&#x53EF;&#x7ED1;&#x5B9A;&#x5173;&#x7CFB;(MS_UNBINDABLE): &#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x7ED1;&#x5B9A;&#x7684;&#x79C1;&#x6709;&#x6302;&#x8F7D;&#xFF0C;&#x4E0E;&#x79C1;&#x6709;&#x6302;&#x8F7D;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x80FD;&#x6267;&#x884C;&#x6302;&#x8F7D;&#x64CD;&#x4F5C;</li>
</ul>
<p>&#x4E00;&#x4E2A;&#x6302;&#x8F7D;&#x72B6;&#x6001;&#x53EF;&#x80FD;&#x4E3A;&#x5982;&#x4E0B;&#x7684;&#x5176;&#x4E2D;&#x4E00;&#x79CD;&#xFF1A;</p>
<ul>
<li>&#x5171;&#x4EAB;&#x6302;&#x8F7D;&#xFF08;shared&#xFF09;</li>
<li>&#x4ECE;&#x5C5E;&#x6302;&#x8F7D;&#xFF08;slave&#xFF09;</li>
<li>&#x5171;&#x4EAB;/&#x4ECE;&#x5C5E;&#x6302;&#x8F7D;&#xFF08;shared and slave&#xFF09;</li>
<li>&#x79C1;&#x6709;&#x6302;&#x8F7D;&#xFF08;private&#xFF09;</li>
<li>&#x4E0D;&#x53EF;&#x7ED1;&#x5B9A;&#x6302;&#x8F7D;&#xFF08;unbindable&#xFF09;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/fe581ad351c2a796148ed49b5d19f7f995b911733db2d26ca1e54aece5681100" alt="image"></p>
<p>image</p>
<p>&#x6302;&#x8F7D;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x901A;&#x8FC7;mount&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x5B83;&#x6709;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;&#x4E00;&#x4E2A;&#x662F;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7684;&#x7279;&#x6B8A;&#x6587;&#x4EF6;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x7279;&#x6B8A;&#x6587;&#x4EF6;&#x7684;&#x540D;&#x5B57;&#x3002;&#x8FD9;&#x4E2A;&#x7279;&#x6B8A;&#x6587;&#x4EF6;&#x4E00;&#x822C;&#x7528;&#x6765;&#x5173;&#x8054;&#x4E00;&#x4E9B;&#x5B58;&#x50A8;&#x5377;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B58;&#x50A8;&#x5377;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x81EA;&#x5DF1;&#x7684;&#x76EE;&#x5F55;&#x5C42;&#x7EA7;&#x548C;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7ED3;&#x6784;&#x3002;mount&#x6240;&#x8FBE;&#x5230;&#x7684;&#x6548;&#x679C;&#x662F;&#xFF1A;&#x50CF;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7684;&#x6587;&#x4EF6;&#x4E00;&#x6837;&#x8BBF;&#x95EE;&#x4F4D;&#x4E8E;&#x5176;&#x4ED6;&#x8BBE;&#x5907;&#x4E0A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x6839;&#x76EE;&#x5F55;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5C06;&#x8BE5;&#x8BBE;&#x5907;&#x4E0A;&#x76EE;&#x5F55;&#x7684;&#x6839;&#x8282;&#x70B9;&#x6302;&#x5230;&#x4E86;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x9875;&#x8282;&#x70B9;&#x4E0A;&#xFF0C;&#x8FBE;&#x5230;&#x4E86;&#x7ED9;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6269;&#x5145;&#x5BB9;&#x91CF;&#x7684;&#x76EE;&#x7684;&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;/proc&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x67E5;&#x770B;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x6302;&#x8F7D;&#x4FE1;&#x606F;&#xFF0C;&#x5177;&#x4F53;&#x505A;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;cat /proc/$pid/mountinfo</span><br></pre></td></tr></table></figure>

<p><code>&#x7ED1;&#x5B9A;&#x6302;&#x8F7D;</code>&#x7684;&#x5F15;&#x5165;&#x4F7F;&#x5F97;mount&#x7684;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E0D;&#x4E00;&#x5B9A;&#x8981;&#x662F;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x6587;&#x4EF6;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x8BE5;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x3002;Linux&#x4E2D;&#x7ED1;&#x5B9A;&#x6302;&#x8F7D;&#x7684;&#x7528;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;mount --bind /home/work /home/qiniu  </span><br><span class="line">mount -o bind /home/work /home/qiniu</span><br></pre></td></tr></table></figure>

<h3 id="User-Namespace"><a href="#User-Namespace" class="headerlink" title="User Namespace"></a>User Namespace</h3><p>&#x8981;&#x628A;&#x5BB9;&#x5668;&#x4E2D;&#x7684;uid&#x548C;&#x771F;&#x5B9E;&#x7CFB;&#x7EDF;&#x7684;uid&#x7ED9;&#x6620;&#x5C04;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x9700;&#x8981;&#x4FEE;&#x6539; /proc//uid_map &#x548C; /proc//gid_map &#x8FD9;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x3002;&#x8FD9;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x4E3A;&#xFF1A;<br><code>ID-inside-ns ID-outside-ns length</code></p>
<ul>
<li>&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5;ID-inside-ns&#x8868;&#x793A;&#x5728;&#x5BB9;&#x5668;&#x663E;&#x793A;&#x7684;UID&#x6216;GID&#xFF0C;</li>
<li>&#x7B2C;&#x4E8C;&#x4E2A;&#x5B57;&#x6BB5;ID-outside-ns&#x8868;&#x793A;&#x5BB9;&#x5668;&#x5916;&#x6620;&#x5C04;&#x7684;&#x771F;&#x5B9E;&#x7684;UID&#x6216;GID&#x3002;</li>
<li>&#x7B2C;&#x4E09;&#x4E2A;&#x5B57;&#x6BB5;&#x8868;&#x793A;&#x6620;&#x5C04;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x4E00;&#x822C;&#x586B;1&#xFF0C;&#x8868;&#x793A;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x3002;</li>
</ul>
<p>User namespace&#x4E3B;&#x8981;&#x9694;&#x79BB;&#x4E86;&#x5B89;&#x5168;&#x76F8;&#x5173;&#x7684;&#x6807;&#x8BC6;&#x7B26;&#xFF08;identifiers&#xFF09;&#x548C;&#x5C5E;&#x6027;&#xFF08;attributes&#xFF09;&#xFF0C;&#x5305;&#x62EC;&#x7528;&#x6237;ID&#x3001;&#x7528;&#x6237;&#x7EC4;ID&#x3001;root&#x76EE;&#x5F55;&#x3001;key&#xFF08;&#x6307;&#x5BC6;&#x94A5;&#xFF09;&#x4EE5;&#x53CA;&#x7279;&#x6B8A;&#x6743;&#x9650;&#x3002;&#x8BF4;&#x5F97;&#x901A;&#x4FD7;&#x4E00;&#x70B9;&#xFF0C;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7528;&#x6237;&#x7684;&#x8FDB;&#x7A0B;&#x901A;&#x8FC7;clone()&#x521B;&#x5EFA;&#x7684;&#x65B0;&#x8FDB;&#x7A0B;&#x5728;&#x65B0;user namespace&#x4E2D;&#x53EF;&#x4EE5;&#x62E5;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x7528;&#x6237;&#x548C;&#x7528;&#x6237;&#x7EC4;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5728;&#x5BB9;&#x5668;&#x5916;&#x5C5E;&#x4E8E;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;&#x7279;&#x6743;&#x7684;&#x666E;&#x901A;&#x7528;&#x6237;&#xFF0C;&#x4F46;&#x662F;&#x4ED6;&#x521B;&#x5EFA;&#x7684;&#x5BB9;&#x5668;&#x8FDB;&#x7A0B;&#x5374;&#x5C5E;&#x4E8E;&#x62E5;&#x6709;&#x6240;&#x6709;&#x6743;&#x9650;&#x7684;&#x8D85;&#x7EA7;&#x7528;&#x6237;&#xFF0C;&#x8FD9;&#x4E2A;&#x6280;&#x672F;&#x4E3A;&#x5BB9;&#x5668;&#x63D0;&#x4F9B;&#x4E86;&#x6781;&#x5927;&#x7684;&#x81EA;&#x7531;&#x3002;<br>User Namespace&#x9664;&#x4E86;&#x9694;&#x79BB;&#x7528;&#x6237;ID&#x548C;&#x7528;&#x6237;&#x7EC4;ID&#x4E4B;&#x5916;&#xFF0C;&#x8FD8;&#x5BF9;&#x6BCF;&#x4E2A;Namespace&#x8FDB;&#x884C;&#x4E86;Capability&#x7684;&#x9694;&#x79BB;&#x548C;&#x63A7;&#x5236;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x548C;&#x5220;&#x9664;&#x76F8;&#x5E94;&#x7684;Capability&#x6765;&#x63A7;&#x5236;&#x65B0;Namespace&#x4E2D;&#x8FDB;&#x7A0B;&#x6240;&#x62E5;&#x6709;&#x7684;&#x6743;&#x9650;&#xFF0C;&#x6BD4;&#x5982;&#x4E3A;&#x65B0;&#x7684;Namespace&#x4E2D;&#x589E;&#x52A0;CAP_CHOWN&#x6743;&#x9650;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x8FD9;&#x4E2A;Namespace&#x7684;&#x8FDB;&#x7A0B;&#x62E5;&#x6709;&#x6539;&#x53D8;&#x6587;&#x4EF6;&#x5C5E;&#x4E3B;&#x7684;&#x6743;&#x9650;&#x3002;</p>
<ul>
<li>user namespace&#x88AB;&#x521B;&#x5EFA;&#x540E;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x88AB;&#x8D4B;&#x4E88;&#x4E86;&#x8BE5;namespace&#x4E2D;&#x7684;&#x5168;&#x90E8;&#x6743;&#x9650;&#xFF0C;&#x8FD9;&#x6837;&#x8FD9;&#x4E2A;init&#x8FDB;&#x7A0B;&#x5C31;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x6240;&#x6709;&#x5FC5;&#x8981;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#xFF0C;&#x800C;&#x4E0D;&#x4F1A;&#x56E0;&#x6743;&#x9650;&#x4E0D;&#x8DB3;&#x800C;&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#x3002;</li>
<li>&#x6211;&#x4EEC;&#x770B;&#x5230;namespace&#x5185;&#x90E8;&#x770B;&#x5230;&#x7684;UID&#x548C;GID&#x5DF2;&#x7ECF;&#x4E0E;&#x5916;&#x90E8;&#x4E0D;&#x540C;&#x4E86;&#xFF0C;&#x9ED8;&#x8BA4;&#x663E;&#x793A;&#x4E3A;65534&#xFF0C;&#x8868;&#x793A;&#x5C1A;&#x672A;&#x4E0E;&#x5916;&#x90E8;namespace&#x7528;&#x6237;&#x6620;&#x5C04;&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5BF9;user namespace&#x5185;&#x90E8;&#x7684;&#x8FD9;&#x4E2A;&#x521D;&#x59CB;user&#x548C;&#x5176;&#x5916;&#x90E8;namespace&#x67D0;&#x4E2A;&#x7528;&#x6237;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x5F53;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E9B;&#x5BF9;&#x5916;&#x90E8;namespace&#x7684;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x68C0;&#x9A8C;&#x5176;&#x6743;&#x9650;&#xFF08;&#x6BD4;&#x5982;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x4FE1;&#x53F7;&#x6216;&#x64CD;&#x4F5C;&#x67D0;&#x4E2A;&#x6587;&#x4EF6;&#xFF09;&#x3002;&#x540C;&#x6837;&#x7528;&#x6237;&#x7EC4;&#x4E5F;&#x8981;&#x5EFA;&#x7ACB;&#x6620;&#x5C04;&#x3002;</li>
<li>&#x8FD8;&#x6709;&#x4E00;&#x70B9;&#x867D;&#x7136;&#x4E0D;&#x80FD;&#x4ECE;&#x8F93;&#x51FA;&#x4E2D;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x4F46;&#x662F;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x3002;&#x7528;&#x6237;&#x5728;&#x65B0;namespace&#x4E2D;&#x6709;&#x5168;&#x90E8;&#x6743;&#x9650;&#xFF0C;&#x4F46;&#x662F;&#x4ED6;&#x5728;&#x521B;&#x5EFA;&#x4ED6;&#x7684;&#x7236;namespace&#x4E2D;&#x4E0D;&#x542B;&#x4EFB;&#x4F55;&#x6743;&#x9650;&#x3002;&#x5C31;&#x7B97;&#x8C03;&#x7528;&#x548C;&#x521B;&#x5EFA;&#x4ED6;&#x7684;&#x8FDB;&#x7A0B;&#x6709;&#x5168;&#x90E8;&#x6743;&#x9650;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002;&#x6240;&#x4EE5;&#x54EA;&#x6015;&#x662F;root&#x7528;&#x6237;&#x8C03;&#x7528;&#x4E86;clone()&#x5728;user namespace&#x4E2D;&#x521B;&#x5EFA;&#x51FA;&#x7684;&#x65B0;&#x7528;&#x6237;&#x5728;&#x5916;&#x90E8;&#x4E5F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6743;&#x9650;&#x3002;</li>
<li>&#x6700;&#x540E;&#xFF0C;user namespace&#x7684;&#x521B;&#x5EFA;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x5C42;&#x5C42;&#x5D4C;&#x5957;&#x7684;&#x6811;&#x72B6;&#x7ED3;&#x6784;&#x3002;&#x6700;&#x4E0A;&#x5C42;&#x7684;&#x6839;&#x8282;&#x70B9;&#x5C31;&#x662F;root namespace&#xFF0C;&#x65B0;&#x521B;&#x5EFA;&#x7684;&#x6BCF;&#x4E2A;user namespace&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x7236;&#x8282;&#x70B9;user namespace&#x4EE5;&#x53CA;&#x96F6;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x5B50;&#x8282;&#x70B9;user namespace&#xFF0C;&#x8FD9;&#x4E00;&#x70B9;&#x4E0E;PID namespace&#x975E;&#x5E38;&#x76F8;&#x4F3C;&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#define _GNU_SOURCE</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line">#include &lt;sys/mount.h&gt;</span><br><span class="line">#include &lt;sys/capability.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sched.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">#define STACK_SIZE (1024 * 1024)</span><br><span class="line"></span><br><span class="line">static char container_stack[STACK_SIZE];</span><br><span class="line">char* const container_args[] = {</span><br><span class="line">    &quot;/bin/bash&quot;,</span><br><span class="line">    NULL</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">int pipefd[2];</span><br><span class="line"></span><br><span class="line">void set_map(char* file, int inside_id, int outside_id, int len) {</span><br><span class="line">    FILE* mapfd = fopen(file, &quot;w&quot;);</span><br><span class="line">    if (NULL == mapfd) {</span><br><span class="line">        perror(&quot;open file error&quot;);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    fprintf(mapfd, &quot;%d %d %d&quot;, inside_id, outside_id, len);</span><br><span class="line">    fclose(mapfd);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void set_uid_map(pid_t pid, int inside_id, int outside_id, int len) {</span><br><span class="line">    char file[256];</span><br><span class="line">    sprintf(file, &quot;/proc/%d/uid_map&quot;, pid);</span><br><span class="line">    set_map(file, inside_id, outside_id, len);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void set_gid_map(pid_t pid, int inside_id, int outside_id, int len) {</span><br><span class="line">    char file[256];</span><br><span class="line">    sprintf(file, &quot;/proc/%d/gid_map&quot;, pid);</span><br><span class="line">    set_map(file, inside_id, outside_id, len);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int container_main(void* arg)</span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    printf(&quot;Container [%5d] - inside the container!\n&quot;, getpid());</span><br><span class="line"></span><br><span class="line">    printf(&quot;Container: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld\n&quot;,</span><br><span class="line">            (long) geteuid(), (long) getegid(), (long) getuid(), (long) getgid());</span><br><span class="line"></span><br><span class="line">    /* &#x7B49;&#x5F85;&#x7236;&#x8FDB;&#x7A0B;&#x901A;&#x77E5;&#x540E;&#x518D;&#x5F80;&#x4E0B;&#x6267;&#x884C;&#xFF08;&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x540C;&#x6B65;&#xFF09; */</span><br><span class="line">    char ch;</span><br><span class="line">    close(pipefd[1]);</span><br><span class="line">    read(pipefd[0], &amp;ch, 1);</span><br><span class="line"></span><br><span class="line">    printf(&quot;Container [%5d] - setup hostname!\n&quot;, getpid());</span><br><span class="line">    //set hostname</span><br><span class="line">    sethostname(&quot;container&quot;,10);</span><br><span class="line"></span><br><span class="line">    //remount &quot;/proc&quot; to make sure the &quot;top&quot; and &quot;ps&quot; show container&apos;s information</span><br><span class="line">    mount(&quot;proc&quot;, &quot;/proc&quot;, &quot;proc&quot;, 0, NULL);</span><br><span class="line"></span><br><span class="line">    execv(container_args[0], container_args);</span><br><span class="line">    printf(&quot;Something&apos;s wrong!\n&quot;);</span><br><span class="line">    return 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">{</span><br><span class="line">    const int gid=getgid(), uid=getuid();</span><br><span class="line"></span><br><span class="line">    printf(&quot;Parent: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld\n&quot;,</span><br><span class="line">            (long) geteuid(), (long) getegid(), (long) getuid(), (long) getgid());</span><br><span class="line"></span><br><span class="line">    pipe(pipefd);</span><br><span class="line"></span><br><span class="line">    printf(&quot;Parent [%5d] - start a container!\n&quot;, getpid());</span><br><span class="line"></span><br><span class="line">    int container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS  | CLONE_NEWNS | CLONE_NEWUSER | SIGCHLD, NULL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    printf(&quot;Parent [%5d] - Container [%5d]!\n&quot;, getpid(), container_pid);</span><br><span class="line"></span><br><span class="line">    //To map the uid/gid, </span><br><span class="line">    //   we need edit the /proc/PID/uid_map (or /proc/PID/gid_map) in parent</span><br><span class="line">    //The file format is</span><br><span class="line">    //   ID-inside-ns   ID-outside-ns   length</span><br><span class="line">    //if no mapping, </span><br><span class="line">    //   the uid will be taken from /proc/sys/kernel/overflowuid</span><br><span class="line">    //   the gid will be taken from /proc/sys/kernel/overflowgid</span><br><span class="line">    set_uid_map(container_pid, 0, uid, 1);</span><br><span class="line">    set_gid_map(container_pid, 0, gid, 1);</span><br><span class="line"></span><br><span class="line">    printf(&quot;Parent [%5d] - user/group mapping done!\n&quot;, getpid());</span><br><span class="line"></span><br><span class="line">    /* &#x901A;&#x77E5;&#x5B50;&#x8FDB;&#x7A0B; */</span><br><span class="line">    close(pipefd[1]);</span><br><span class="line"></span><br><span class="line">    waitpid(container_pid, NULL, 0);</span><br><span class="line">    printf(&quot;Parent - container stopped!\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x4E0A;&#x9762;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x6211;&#x4EEC;&#x7528;&#x4E86;&#x4E00;&#x4E2A;pipe&#x6765;&#x5BF9;&#x7236;&#x5B50;&#x8FDB;&#x7A0B;&#x8FDB;&#x884C;&#x540C;&#x6B65;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8FD9;&#x6837;&#x505A;&#xFF1F;&#x56E0;&#x4E3A;&#x5B50;&#x8FDB;&#x7A0B;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;execv&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F1A;&#x628A;&#x5F53;&#x524D;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FDB;&#x7A0B;&#x7A7A;&#x95F4;&#x7ED9;&#x5168;&#x90E8;&#x8986;&#x76D6;&#x6389;&#xFF0C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5728;execv&#x4E4B;&#x524D;&#x5C31;&#x505A;&#x597D;user namespace&#x7684;uid/gid&#x7684;&#x6620;&#x5C04;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;execv&#x8FD0;&#x884C;&#x7684;/bin/bash&#x5C31;&#x4F1A;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8BBE;&#x7F6E;&#x4E86;uid&#x4E3A;0&#x7684;inside-uid&#x800C;&#x53D8;&#x6210;#&#x53F7;&#x7684;&#x63D0;&#x793A;&#x7B26;&#x3002;</span><br></pre></td></tr></table></figure>

<h3 id="Network-Namespace"><a href="#Network-Namespace" class="headerlink" title="Network Namespace"></a>Network Namespace</h3><p>&#x5728;Linux&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x7528;ip&#x547D;&#x4EE4;&#x521B;&#x5EFA;Network Namespace  </p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/e194f606c4632d62b20cc244f33994c4e8b89289b812b766259dfacc058d725a" alt="image"></p>
<p>image</p>
<p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7269;&#x7406;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x90FD;&#x5206;&#x914D;&#x5728;&#x6700;&#x521D;&#x7684;root namespace&#xFF08;&#x8868;&#x793A;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x7684;namespace&#xFF0C;&#x5728;PID namespace&#x4E2D;&#x5DF2;&#x7ECF;&#x63D0;&#x53CA;&#xFF09;&#x4E2D;&#x3002;&#x4F46;&#x662F;&#x5982;&#x679C;&#x4F60;&#x6709;&#x591A;&#x5757;&#x7269;&#x7406;&#x7F51;&#x5361;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x628A;&#x5176;&#x4E2D;&#x4E00;&#x5757;&#x6216;&#x591A;&#x5757;&#x5206;&#x914D;&#x7ED9;&#x65B0;&#x521B;&#x5EFA;&#x7684;network namespace&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5F53;&#x65B0;&#x521B;&#x5EFA;&#x7684;network namespace&#x88AB;&#x91CA;&#x653E;&#x65F6;&#xFF08;&#x6240;&#x6709;&#x5185;&#x90E8;&#x7684;&#x8FDB;&#x7A0B;&#x90FD;&#x7EC8;&#x6B62;&#x5E76;&#x4E14;namespace&#x6587;&#x4EF6;&#x6CA1;&#x6709;&#x88AB;&#x6302;&#x8F7D;&#x6216;&#x6253;&#x5F00;&#xFF09;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;namespace&#x4E2D;&#x7684;&#x7269;&#x7406;&#x7F51;&#x5361;&#x4F1A;&#x8FD4;&#x56DE;&#x5230;root namespace&#x800C;&#x975E;&#x521B;&#x5EFA;&#x8BE5;&#x8FDB;&#x7A0B;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#x6240;&#x5728;&#x7684;network namespace&#x3002;</p>
<p>&#x5728;&#x5EFA;&#x7ACB;&#x8D77;veth pair&#x4E4B;&#x524D;&#xFF0C;&#x65B0;&#x65E7;namespace&#x8BE5;&#x5982;&#x4F55;&#x901A;&#x4FE1;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x662F;pipe&#xFF08;&#x7BA1;&#x9053;&#xFF09;&#x3002;&#x6211;&#x4EEC;&#x4EE5;Docker Daemon&#x5728;&#x542F;&#x52A8;&#x5BB9;&#x5668;dockerinit&#x7684;&#x8FC7;&#x7A0B;&#x4E3A;&#x4F8B;&#x3002;Docker Daemon&#x5728;&#x5BBF;&#x4E3B;&#x673A;&#x4E0A;&#x8D1F;&#x8D23;&#x521B;&#x5EFA;&#x8FD9;&#x4E2A;veth pair&#xFF0C;&#x901A;&#x8FC7;netlink&#x8C03;&#x7528;&#xFF0C;&#x628A;&#x4E00;&#x7AEF;&#x7ED1;&#x5B9A;&#x5230;docker0&#x7F51;&#x6865;&#x4E0A;&#xFF0C;&#x4E00;&#x7AEF;&#x8FDE;&#x8FDB;&#x65B0;&#x5EFA;&#x7684;network namespace&#x8FDB;&#x7A0B;&#x4E2D;&#x3002;&#x5EFA;&#x7ACB;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;Docker Daemon&#x548C;dockerinit&#x5C31;&#x901A;&#x8FC7;pipe&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#xFF0C;&#x5F53;Docker Daemon&#x5B8C;&#x6210;veth-pair&#x7684;&#x521B;&#x5EFA;&#x4E4B;&#x524D;&#xFF0C;dockerinit&#x5728;&#x7BA1;&#x9053;&#x7684;&#x53E6;&#x4E00;&#x7AEF;&#x5FAA;&#x73AF;&#x7B49;&#x5F85;&#xFF0C;&#x76F4;&#x5230;&#x7BA1;&#x9053;&#x53E6;&#x4E00;&#x7AEF;&#x4F20;&#x6765;Docker Daemon&#x5173;&#x4E8E;veth&#x8BBE;&#x5907;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5173;&#x95ED;&#x7BA1;&#x9053;&#x3002;dockerinit&#x624D;&#x7ED3;&#x675F;&#x7B49;&#x5F85;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x5E76;&#x628A;&#x5B83;&#x7684;&#x201C;eth0&#x201D;&#x542F;&#x52A8;&#x8D77;&#x6765;&#x3002;&#x6574;&#x4E2A;&#x6548;&#x679C;&#x7C7B;&#x4F3C;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// docker &#x7F51;&#x7EDC;&#x672C;&#x8D28;&#x505A;&#x7684;&#x4E8B;&#x5C31;&#x662F; 1. &#x521B;&#x5EFA;&#x7F51;&#x6865;  2. &#x521B;&#x5EFA;veth &#x865A;&#x62DF;&#x7F51;&#x5361;,&#x4E00;&#x5934;&#x5728;docker ns1,&#x4E00;&#x5934;&#x63D2;&#x5728;&#x7F51;&#x6865;&#x4E0A; 3. &#x8BBE;&#x7F6E;ip,&#x8DEF;&#x7531;&#x89C4;&#x5219;,nat&#xFF0C;&#x8BA9;docker &#x7F51;&#x7EDC;&#x80FD;&#x7ECF;&#x8FC7;bridge &#x51FA;&#x53BB;  &#x5916;&#x90E8;&#x8BBF;&#x95EE;&#x5BB9;&#x5668;&#x7F51;&#x7EDC; &#x4E5F;&#x662F;&#x5728;&#x672C;&#x5730;&#x7684; iptable &#x7684; nat &#x8868;&#x4E2D;&#x6DFB;&#x52A0;&#x76F8;&#x5E94;&#x7684;&#x89C4;&#x5219; https://yeasy.gitbooks.io/docker_practice/content/advanced_network/port_mapping.html</span><br><span class="line">calico &#x4E5F;&#x662F;&#x7C7B;&#x4F3C;&#x5B9E;&#x73B0;&#xFF0C;&#x6CA1;&#x6709;&#x7528;bridge&#x6A21;&#x5F0F;</span><br><span class="line"></span><br><span class="line">## &#x9996;&#x5148;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x7F51;&#x6865;lxcbr0&#xFF0C;&#x6A21;&#x4EFF;docker0</span><br><span class="line">brctl addbr lxcbr0</span><br><span class="line">brctl stp lxcbr0 off</span><br><span class="line">ifconfig lxcbr0 192.168.10.1/24 up #&#x4E3A;&#x7F51;&#x6865;&#x8BBE;&#x7F6E;IP&#x5730;&#x5740;</span><br><span class="line"></span><br><span class="line">## &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;network namespace - ns1</span><br><span class="line"></span><br><span class="line"># &#x589E;&#x52A0;&#x4E00;&#x4E2A;namesapce &#x547D;&#x4EE4;&#x4E3A; ns1 &#xFF08;&#x4F7F;&#x7528;ip netns add&#x547D;&#x4EE4;&#xFF09;</span><br><span class="line">ip netns add ns1 </span><br><span class="line"></span><br><span class="line"># &#x6FC0;&#x6D3B;namespace&#x4E2D;&#x7684;loopback&#xFF0C;&#x5373;127.0.0.1&#xFF08;&#x4F7F;&#x7528;ip netns exec ns1&#x6765;&#x64CD;&#x4F5C;ns1&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#xFF09;</span><br><span class="line">ip netns exec ns1   ip link set dev lo up </span><br><span class="line"></span><br><span class="line">## &#x7136;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x589E;&#x52A0;&#x4E00;&#x5BF9;&#x865A;&#x62DF;&#x7F51;&#x5361;</span><br><span class="line"></span><br><span class="line"># &#x589E;&#x52A0;&#x4E00;&#x4E2A;pair&#x865A;&#x62DF;&#x7F51;&#x5361;&#xFF0C;&#x6CE8;&#x610F;&#x5176;&#x4E2D;&#x7684;veth&#x7C7B;&#x578B;&#xFF0C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x7F51;&#x5361;&#x8981;&#x6309;&#x8FDB;&#x5BB9;&#x5668;&#x4E2D;</span><br><span class="line"># VETH &#x8BBE;&#x5907;&#x603B;&#x662F;&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#xFF0C;&#x9001;&#x5230;&#x4E00;&#x7AEF;&#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x603B;&#x662F;&#x4ECE;&#x53E6;&#x4E00;&#x7AEF;&#x4EE5;&#x8BF7;&#x6C42;&#x63A5;&#x53D7;&#x7684;&#x5F62;&#x5F0F;&#x51FA;&#x73B0;&#x3002;&#x8BE5;&#x8BBE;&#x5907;&#x4E0D;&#x80FD;&#x88AB;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x76F4;&#x63A5;&#x64CD;&#x4F5C;&#xFF0C;&#x4F46;&#x4F7F;&#x7528;&#x8D77;&#x6765;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x3002;&#x521B;&#x5EFA;&#x5E76;&#x914D;&#x7F6E;&#x6B63;&#x786E;&#x540E;&#xFF0C;&#x5411;&#x5176;&#x4E00;&#x7AEF;&#x8F93;&#x5165;&#x6570;&#x636E;&#xFF0C;VETH &#x4F1A;&#x6539;&#x53D8;&#x6570;&#x636E;&#x7684;&#x65B9;&#x5411;&#x5E76;&#x5C06;&#x5176;&#x9001;&#x5165;&#x5185;&#x6838;&#x7F51;&#x7EDC;&#x6838;&#x5FC3;&#xFF0C;&#x5B8C;&#x6210;&#x6570;&#x636E;&#x7684;&#x6CE8;&#x5165;&#x3002;&#x5728;&#x53E6;&#x4E00;&#x7AEF;&#x80FD;&#x8BFB;&#x5230;&#x6B64;&#x6570;&#x636E;&#x3002;</span><br><span class="line"></span><br><span class="line">ip link add veth-ns1 type veth peer name lxcbr0.1</span><br><span class="line"></span><br><span class="line"># &#x628A; veth-ns1 &#x6309;&#x5230;namespace ns1&#x4E2D;&#xFF0C;&#x8FD9;&#x6837;&#x5BB9;&#x5668;&#x4E2D;&#x5C31;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7F51;&#x5361;&#x4E86;</span><br><span class="line">ip link set veth-ns1 netns ns1</span><br><span class="line"></span><br><span class="line"># &#x628A;&#x5BB9;&#x5668;&#x91CC;&#x7684; veth-ns1&#x6539;&#x540D;&#x4E3A; eth0 &#xFF08;&#x5BB9;&#x5668;&#x5916;&#x4F1A;&#x51B2;&#x7A81;&#xFF0C;&#x5BB9;&#x5668;&#x5185;&#x5C31;&#x4E0D;&#x4F1A;&#x4E86;&#xFF09;</span><br><span class="line">ip netns exec ns1  ip link set dev veth-ns1 name eth0 </span><br><span class="line"></span><br><span class="line"># &#x4E3A;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7F51;&#x5361;&#x5206;&#x914D;&#x4E00;&#x4E2A;IP&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x6FC0;&#x6D3B;&#x5B83;</span><br><span class="line">ip netns exec ns1 ifconfig eth0 192.168.10.11/24 up</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x628A;veth-ns1&#x8FD9;&#x4E2A;&#x7F51;&#x5361;&#x6309;&#x5230;&#x4E86;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8981;&#x628A;lxcbr0.1&#x6DFB;&#x52A0;&#x4E0A;&#x7F51;&#x6865;&#x4E0A;</span><br><span class="line">brctl addif lxcbr0 lxcbr0.1</span><br><span class="line"></span><br><span class="line"># &#x4E3A;&#x5BB9;&#x5668;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x8DEF;&#x7531;&#x89C4;&#x5219;&#xFF0C;&#x8BA9;&#x5BB9;&#x5668;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5916;&#x9762;&#x7684;&#x7F51;&#x7EDC;</span><br><span class="line">ip netns exec ns1     ip route add default via 192.168.10.1</span><br><span class="line"></span><br><span class="line"># &#x5728;/etc/netns&#x4E0B;&#x521B;&#x5EFA;network namespce&#x540D;&#x79F0;&#x4E3A;ns1&#x7684;&#x76EE;&#x5F55;&#xFF0C;</span><br><span class="line"># &#x7136;&#x540E;&#x4E3A;&#x8FD9;&#x4E2A;namespace&#x8BBE;&#x7F6E;resolv.conf&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x5BB9;&#x5668;&#x5185;&#x5C31;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x57DF;&#x540D;&#x4E86;</span><br><span class="line">mkdir -p /etc/netns/ns1</span><br><span class="line">echo &quot;nameserver 8.8.8.8&quot; &gt; /etc/netns/ns1/resolv.conf</span><br></pre></td></tr></table></figure>

<h1 id="CGroup"><a href="#CGroup" class="headerlink" title="CGroup"></a>CGroup</h1><p>cgroups&#x53EF;&#x4EE5;&#x9650;&#x5236;&#x3001;&#x8BB0;&#x5F55;&#x3001;&#x9694;&#x79BB;&#x8FDB;&#x7A0B;&#x7EC4;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x7269;&#x7406;&#x8D44;&#x6E90;&#xFF08;&#x5305;&#x62EC;&#xFF1A;CPU&#x3001;memory&#x3001;IO&#x7B49;&#xFF09;&#xFF0C;&#x4E3A;&#x5BB9;&#x5668;&#x5B9E;&#x73B0;&#x865A;&#x62DF;&#x5316;&#x63D0;&#x4F9B;&#x4E86;&#x57FA;&#x672C;&#x4FDD;&#x8BC1;&#xFF0C;&#x662F;&#x6784;&#x5EFA;Docker&#x7B49;&#x4E00;&#x7CFB;&#x5217;&#x865A;&#x62DF;&#x5316;&#x7BA1;&#x7406;&#x5DE5;&#x5177;&#x7684;&#x57FA;&#x77F3;&#x3002;</p>
<p>&#x4E3B;&#x8981;&#x63D0;&#x4F9B;&#x4E86;&#x5982;&#x4E0B;&#x529F;&#x80FD;&#xFF1A;</p>
<ul>
<li>Resource limitation: &#x9650;&#x5236;&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#xFF0C;&#x6BD4;&#x5982;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x4E0A;&#x9650;&#x4EE5;&#x53CA;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x7F13;&#x5B58;&#x9650;&#x5236;&#x3002;</li>
<li>Prioritization: &#x4F18;&#x5148;&#x7EA7;&#x63A7;&#x5236;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;CPU&#x5229;&#x7528;&#x548C;&#x78C1;&#x76D8;IO&#x541E;&#x5410;&#x3002;</li>
<li>Accounting: &#x4E00;&#x4E9B;&#x5BA1;&#x8BA1;&#x6216;&#x4E00;&#x4E9B;&#x7EDF;&#x8BA1;&#xFF0C;&#x4E3B;&#x8981;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x8BA1;&#x8D39;&#x3002;</li>
<li>Control: &#x6302;&#x8D77;&#x8FDB;&#x7A0B;&#xFF0C;&#x6062;&#x590D;&#x6267;&#x884C;&#x8FDB;&#x7A0B;&#x3002;</li>
</ul>
<p>&#x5BF9;&#x5F00;&#x53D1;&#x8005;&#x6765;&#x8BF4;&#xFF0C;cgroups&#x6709;&#x5982;&#x4E0B;&#x56DB;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x7279;&#x70B9;&#xFF1A;</p>
<ul>
<li>cgroups&#x7684;API&#x4EE5;&#x4E00;&#x4E2A;&#x4F2A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#xFF0C;&#x5373;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x5B9E;&#x73B0;cgroups&#x7684;&#x7EC4;&#x7EC7;&#x7BA1;&#x7406;&#x3002;</li>
<li>cgroups&#x7684;&#x7EC4;&#x7EC7;&#x7BA1;&#x7406;&#x64CD;&#x4F5C;&#x5355;&#x5143;&#x53EF;&#x4EE5;&#x7EC6;&#x7C92;&#x5EA6;&#x5230;&#x7EBF;&#x7A0B;&#x7EA7;&#x522B;&#xFF0C;&#x7528;&#x6237;&#x6001;&#x4EE3;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x7CFB;&#x7EDF;&#x5206;&#x914D;&#x7684;&#x8D44;&#x6E90;&#x521B;&#x5EFA;&#x548C;&#x9500;&#x6BC1;cgroups&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x8D44;&#x6E90;&#x518D;&#x5206;&#x914D;&#x548C;&#x7BA1;&#x7406;&#x3002;</li>
<li>&#x6240;&#x6709;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x7684;&#x529F;&#x80FD;&#x90FD;&#x4EE5;&#x201C;subsystem&#xFF08;&#x5B50;&#x7CFB;&#x7EDF;&#xFF09;&#x201D;&#x7684;&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#xFF0C;&#x63A5;&#x53E3;&#x7EDF;&#x4E00;&#x3002;</li>
<li>&#x5B50;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4E4B;&#x521D;&#x4E0E;&#x5176;&#x7236;&#x8FDB;&#x7A0B;&#x5904;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;cgroups&#x7684;&#x63A7;&#x5236;&#x7EC4;&#x3002;</li>
</ul>
<p>&#x672C;&#x8D28;&#x4E0A;&#x6765;&#x8BF4;&#xFF0C;cgroups&#x662F;&#x5185;&#x6838;&#x9644;&#x52A0;&#x5728;&#x7A0B;&#x5E8F;&#x4E0A;&#x7684;&#x4E00;&#x7CFB;&#x5217;&#x94A9;&#x5B50;&#xFF08;hooks&#xFF09;&#xFF0C;&#x901A;&#x8FC7;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x65F6;&#x5BF9;&#x8D44;&#x6E90;&#x7684;&#x8C03;&#x5EA6;&#x89E6;&#x53D1;&#x76F8;&#x5E94;&#x7684;&#x94A9;&#x5B50;&#x4EE5;&#x8FBE;&#x5230;&#x8D44;&#x6E90;&#x8FFD;&#x8E2A;&#x548C;&#x9650;&#x5236;&#x7684;&#x76EE;&#x7684;&#x3002;</p>
<p>&#x672F;&#x8BED;</p>
<ul>
<li>task&#xFF08;&#x4EFB;&#x52A1;&#xFF09;&#xFF1A;cgroups&#x7684;&#x672F;&#x8BED;&#x4E2D;&#xFF0C;task&#x5C31;&#x8868;&#x793A;&#x7CFB;&#x7EDF;&#x7684;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;</li>
<li>cgroup&#xFF08;&#x63A7;&#x5236;&#x7EC4;&#xFF09;&#xFF1A;cgroups &#x4E2D;&#x7684;&#x8D44;&#x6E90;&#x63A7;&#x5236;&#x90FD;&#x4EE5;cgroup&#x4E3A;&#x5355;&#x4F4D;&#x5B9E;&#x73B0;&#x3002;cgroup&#x8868;&#x793A;&#x6309;&#x67D0;&#x79CD;&#x8D44;&#x6E90;&#x63A7;&#x5236;&#x6807;&#x51C6;&#x5212;&#x5206;&#x800C;&#x6210;&#x7684;&#x4EFB;&#x52A1;&#x7EC4;&#xFF0C;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x5B50;&#x7CFB;&#x7EDF;&#x3002;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x53EF;&#x4EE5;&#x52A0;&#x5165;&#x67D0;&#x4E2A;cgroup&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4ECE;&#x67D0;&#x4E2A;cgroup&#x8FC1;&#x79FB;&#x5230;&#x53E6;&#x5916;&#x4E00;&#x4E2A;cgroup&#x3002;</li>
<li>subsystem&#xFF08;&#x5B50;&#x7CFB;&#x7EDF;&#xFF09;&#xFF1A;cgroups&#x4E2D;&#x7684;subsystem&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;&#x8C03;&#x5EA6;&#x63A7;&#x5236;&#x5668;&#xFF08;Resource Controller&#xFF09;&#x3002;&#x6BD4;&#x5982;CPU&#x5B50;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x63A7;&#x5236;CPU&#x65F6;&#x95F4;&#x5206;&#x914D;&#xFF0C;&#x5185;&#x5B58;&#x5B50;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x9650;&#x5236;cgroup&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;&#x3002;</li>
<li>hierarchy&#xFF08;&#x5C42;&#x7EA7;&#x6811;&#xFF09;&#xFF1A;hierarchy&#x7531;&#x4E00;&#x7CFB;&#x5217;cgroup&#x4EE5;&#x4E00;&#x4E2A;&#x6811;&#x72B6;&#x7ED3;&#x6784;&#x6392;&#x5217;&#x800C;&#x6210;&#xFF0C;&#x6BCF;&#x4E2A;hierarchy&#x901A;&#x8FC7;&#x7ED1;&#x5B9A;&#x5BF9;&#x5E94;&#x7684;subsystem&#x8FDB;&#x884C;&#x8D44;&#x6E90;&#x8C03;&#x5EA6;&#x3002;hierarchy&#x4E2D;&#x7684;cgroup&#x8282;&#x70B9;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x96F6;&#x6216;&#x591A;&#x4E2A;&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x5B50;&#x8282;&#x70B9;&#x7EE7;&#x627F;&#x7236;&#x8282;&#x70B9;&#x7684;&#x5C5E;&#x6027;&#x3002;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;hierarchy</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;hchen@ubuntu:~$ mount -t cgroup #&#x6216;&#x8005;&#x4F7F;&#x7528;lssubsys -m&#x547D;&#x4EE4;&#xFF1A; # lscgroup &#x67E5;&#x8BE2;</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuacct type cgroup (rw,relatime,cpuacct)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory type cgroup (rw,relatime,memory)</span><br><span class="line">cgroup on /sys/fs/cgroup/devices type cgroup (rw,relatime,devices)</span><br><span class="line">cgroup on /sys/fs/cgroup/freezer type cgroup (rw,relatime,freezer)</span><br><span class="line">cgroup on /sys/fs/cgroup/blkio type cgroup (rw,relatime,blkio)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_prio type cgroup (rw,net_prio)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_cls type cgroup (rw,net_cls)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,relatime,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,relatime,hugetlb)</span><br></pre></td></tr></table></figure>

<h2 id="cgroups&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x7B80;&#x4ECB;"><a href="#cgroups&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x7B80;&#x4ECB;" class="headerlink" title="cgroups&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x7B80;&#x4ECB;"></a>cgroups&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x7B80;&#x4ECB;</h2><h3 id="&#x67E5;&#x8BE2;cgroup&#x53CA;&#x5B50;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x72B6;&#x6001;"><a href="#&#x67E5;&#x8BE2;cgroup&#x53CA;&#x5B50;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x72B6;&#x6001;" class="headerlink" title="&#x67E5;&#x8BE2;cgroup&#x53CA;&#x5B50;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x72B6;&#x6001;"></a>&#x67E5;&#x8BE2;cgroup&#x53CA;&#x5B50;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x72B6;&#x6001;</h3><ul>
<li>&#x67E5;&#x770B;&#x6240;&#x6709;&#x7684;cgroup&#xFF1A;lscgroup</li>
<li>&#x67E5;&#x770B;&#x6240;&#x6709;&#x652F;&#x6301;&#x7684;&#x5B50;&#x7CFB;&#x7EDF;&#xFF1A;lssubsys -a</li>
<li>&#x67E5;&#x770B;&#x6240;&#x6709;&#x5B50;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x7684;&#x4F4D;&#x7F6E;&#xFF1A; lssubsys &#x2013;m</li>
<li>&#x67E5;&#x770B;&#x5355;&#x4E2A;&#x5B50;&#x7CFB;&#x7EDF;&#xFF08;&#x5982;memory&#xFF09;&#x6302;&#x8F7D;&#x4F4D;&#x7F6E;&#xFF1A;lssubsys &#x2013;m memory</li>
</ul>
<h3 id="&#x521B;&#x5EFA;hierarchy&#x5C42;&#x7EA7;&#x5E76;&#x6302;&#x8F7D;&#x5B50;&#x7CFB;&#x7EDF;"><a href="#&#x521B;&#x5EFA;hierarchy&#x5C42;&#x7EA7;&#x5E76;&#x6302;&#x8F7D;&#x5B50;&#x7CFB;&#x7EDF;" class="headerlink" title="&#x521B;&#x5EFA;hierarchy&#x5C42;&#x7EA7;&#x5E76;&#x6302;&#x8F7D;&#x5B50;&#x7CFB;&#x7EDF;"></a>&#x521B;&#x5EFA;hierarchy&#x5C42;&#x7EA7;&#x5E76;&#x6302;&#x8F7D;&#x5B50;&#x7CFB;&#x7EDF;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x865A;&#x62DF;&#x673A;&#x64CD;&#x4F5C;&#xFF0C;&#x4F1A;&#x5F71;&#x54CD;&#x7CFB;&#x7EDF;</span><br><span class="line">mount -t tmpfs cgroups /sys/fs/cgroup</span><br><span class="line">mkdir /sys/fs/cgroup/cg1</span><br><span class="line">// mount -t cgroup -o subsystems name /cgroup/name</span><br><span class="line">mount &#x2013;t cgroup &#x2013;o cpu,memory cpu_and_mem /sys/fs/cgroup/cg1</span><br></pre></td></tr></table></figure>

<h2 id="CPU-&#x9650;&#x5236;"><a href="#CPU-&#x9650;&#x5236;" class="headerlink" title="CPU &#x9650;&#x5236;"></a>CPU &#x9650;&#x5236;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;root@container:~# mkdir -p  /sys/fs/cgroup/cpu/wanglei</span><br><span class="line">root@container:~# cat /sys/fs/cgroup/cpu/wanglei/cpu.cfs_quota_us</span><br><span class="line">-1</span><br><span class="line"></span><br><span class="line">&#x6D4B;&#x8BD5;&#x7A0B;&#x5E8F;</span><br><span class="line">int main(void)</span><br><span class="line">{</span><br><span class="line">    int i = 0;</span><br><span class="line">    for(;;) i++;</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">top-&gt;</span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 6121 root      20   0    4224    684    612 R 100.0  0.0   0:05.89 a.out</span><br><span class="line"></span><br><span class="line">&#x5F00;&#x59CB;&#x9650;&#x5236;,6121&#x67E5;&#x5230;&#x662F;&#x6D4B;&#x8BD5;&#x7A0B;&#x5E8F;&#x7684;pid</span><br><span class="line">root@container:~/testcgroup# echo 20000 &gt; /sys/fs/cgroup/cpu/wanglei/cpu.cfs_quota_us</span><br><span class="line">root@container:~/testcgroup# echo 6121 &gt;&gt; /sys/fs/cgroup/cpu/wanglei/tasks</span><br><span class="line"></span><br><span class="line">top-&gt;</span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 6121 root      20   0    4224    684    612 R  20.3  0.0   2:31.16 a.out</span><br></pre></td></tr></table></figure>

<p>&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x793A;&#x4F8B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#define _GNU_SOURCE         /* See feature_test_macros(7) */</span><br><span class="line"></span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const int NUM_THREADS = 5;</span><br><span class="line"></span><br><span class="line">void *thread_main(void *threadid)</span><br><span class="line">{</span><br><span class="line">    /* &#x628A;&#x81EA;&#x5DF1;&#x52A0;&#x5165;cgroup&#x4E2D;&#xFF08;syscall(SYS_gettid)&#x4E3A;&#x5F97;&#x5230;&#x7EBF;&#x7A0B;&#x7684;&#x7CFB;&#x7EDF;tid&#xFF09; */</span><br><span class="line">    char cmd[128];</span><br><span class="line">    sprintf(cmd, &quot;echo %ld &gt;&gt; /sys/fs/cgroup/cpu/haoel/tasks&quot;, syscall(SYS_gettid));</span><br><span class="line">    system(cmd); </span><br><span class="line">    sprintf(cmd, &quot;echo %ld &gt;&gt; /sys/fs/cgroup/cpuset/haoel/tasks&quot;, syscall(SYS_gettid));</span><br><span class="line">    system(cmd);</span><br><span class="line"></span><br><span class="line">    long tid;</span><br><span class="line">    tid = (long)threadid;</span><br><span class="line">    printf(&quot;Hello World! It&apos;s me, thread #%ld, pid #%ld!\n&quot;, tid, syscall(SYS_gettid));</span><br><span class="line"></span><br><span class="line">    int a=0; </span><br><span class="line">    while(1) {</span><br><span class="line">        a++;</span><br><span class="line">    }</span><br><span class="line">    pthread_exit(NULL);</span><br><span class="line">}</span><br><span class="line">int main (int argc, char *argv[])</span><br><span class="line">{</span><br><span class="line">    int num_threads;</span><br><span class="line">    if (argc &gt; 1){</span><br><span class="line">        num_threads = atoi(argv[1]);</span><br><span class="line">    }</span><br><span class="line">    if (num_threads&lt;=0 || num_threads&gt;=100){</span><br><span class="line">        num_threads = NUM_THREADS;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /* &#x8BBE;&#x7F6E;CPU&#x5229;&#x7528;&#x7387;&#x4E3A;50% */</span><br><span class="line">    mkdir(&quot;/sys/fs/cgroup/cpu/haoel&quot;, 755);</span><br><span class="line">    system(&quot;echo 50000 &gt; /sys/fs/cgroup/cpu/haoel/cpu.cfs_quota_us&quot;);</span><br><span class="line"></span><br><span class="line">    mkdir(&quot;/sys/fs/cgroup/cpuset/haoel&quot;, 755);</span><br><span class="line">    /* &#x9650;&#x5236;CPU&#x53EA;&#x80FD;&#x4F7F;&#x7528;#2&#x6838;&#x548C;#3&#x6838; */</span><br><span class="line">    system(&quot;echo \&quot;2,3\&quot; &gt; /sys/fs/cgroup/cpuset/haoel/cpuset.cpus&quot;);</span><br><span class="line"></span><br><span class="line">    pthread_t* threads = (pthread_t*) malloc (sizeof(pthread_t)*num_threads);</span><br><span class="line">    int rc;</span><br><span class="line">    long t;</span><br><span class="line">    for(t=0; t&lt;num_threads; t++){</span><br><span class="line">        printf(&quot;In main: creating thread %ld\n&quot;, t);</span><br><span class="line">        rc = pthread_create(&amp;threads[t], NULL, thread_main, (void *)t);</span><br><span class="line">        if (rc){</span><br><span class="line">            printf(&quot;ERROR; return code from pthread_create() is %d\n&quot;, rc);</span><br><span class="line">            exit(-1);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /* Last thing that main() should do */</span><br><span class="line">    pthread_exit(NULL);</span><br><span class="line">    free(threads);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x9650;&#x5236;"><a href="#&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x9650;&#x5236;" class="headerlink" title="&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x9650;&#x5236;"></a>&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x9650;&#x5236;</h2><p>&#x6D4B;&#x8BD5;&#x4E00;&#x4E2A;&#x8017;&#x5C3D;&#x5185;&#x5B58;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x9650;&#x5236;&#x5185;&#x5B58;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7A0B;&#x5E8F;&#x4F1A;&#x88AB;kill</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">{</span><br><span class="line">    int size = 0;</span><br><span class="line">    int chunk_size = 512;</span><br><span class="line">    void *p = NULL;</span><br><span class="line"></span><br><span class="line">    while(1) {</span><br><span class="line"></span><br><span class="line">        if ((p = malloc(chunk_size)) == NULL) {</span><br><span class="line">            printf(&quot;out of memory!!\n&quot;);</span><br><span class="line">            break;</span><br><span class="line">        }</span><br><span class="line">        memset(p, 1, chunk_size);</span><br><span class="line">        size += chunk_size;</span><br><span class="line">        printf(&quot;[%d] - memory is allocated [%8d] bytes \n&quot;, getpid(), size);</span><br><span class="line">        sleep(1);</span><br><span class="line">    }</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;root@container:~/testcgroup# mkdir /sys/fs/cgroup/memory/wanglei</span><br><span class="line">root@container:~/testcgroup# echo 64k &gt; /sys/fs/cgroup/memory/wanglei/memory.limit_in_bytes</span><br><span class="line">root@container:~/testcgroup# echo [pid] &gt; /sys/fs/cgroup/memory/haoel/tasks^C</span><br></pre></td></tr></table></figure>

<h2 id="&#x78C1;&#x76D8;I-O&#x9650;&#x5236;"><a href="#&#x78C1;&#x76D8;I-O&#x9650;&#x5236;" class="headerlink" title="&#x78C1;&#x76D8;I/O&#x9650;&#x5236;"></a>&#x78C1;&#x76D8;I/O&#x9650;&#x5236;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;root@container:~/testcgroup# dd if=/dev/vda of=/dev/null</span><br><span class="line"></span><br><span class="line">iotop-&gt;</span><br><span class="line">  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">15660 be/4 root       73.81 M/s    0.00 B/s  0.00 % 82.47 % dd if=/dev/vda of=/dev/null</span><br><span class="line"></span><br><span class="line">root@container:~/testcgroup# mkdir /sys/fs/cgroup/blkio/wanglei</span><br><span class="line">root@container:~/testcgroup# ls -l /dev/vda</span><br><span class="line">brw-rw---- 1 root disk 253, 0 Sep 25 12:49 /dev/vda</span><br><span class="line">root@container:~/testcgroup# echo &quot;253:0 1048576&quot; &gt; /sys/fs/cgroup/blkio/wanglei/blkio.throttle.read_bps_device</span><br><span class="line">root@container:~/testcgroup# echo 16221  &gt; /sys/fs/cgroup/blkio/wanglei/tasks</span><br><span class="line"></span><br><span class="line">iotop-&gt; &#x9650;&#x5236;&#x5F97;&#x4E0D;&#x662F;&#x5F88;&#x51C6;</span><br><span class="line">  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">16221 be/4 root      978.21 K/s    0.00 B/s  0.00 % 95.28 % dd if=/dev/vda of=/dev/null</span><br></pre></td></tr></table></figure>

<h2 id="CGroup&#x7684;&#x5B50;&#x7CFB;&#x7EDF;"><a href="#CGroup&#x7684;&#x5B50;&#x7CFB;&#x7EDF;" class="headerlink" title="CGroup&#x7684;&#x5B50;&#x7CFB;&#x7EDF;"></a>CGroup&#x7684;&#x5B50;&#x7CFB;&#x7EDF;</h2><ul>
<li>blkio&#xFF1A; &#x8FD9;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x4E3A;&#x5757;&#x8BBE;&#x5907;&#x8BBE;&#x5B9A;&#x8F93;&#x5165;/&#x8F93;&#x51FA;&#x9650;&#x5236;&#xFF0C;&#x6BD4;&#x5982;&#x7269;&#x7406;&#x9A71;&#x52A8;&#x8BBE;&#x5907;&#xFF08;&#x5305;&#x62EC;&#x78C1;&#x76D8;&#x3001;&#x56FA;&#x6001;&#x786C;&#x76D8;&#x3001;USB&#x7B49;&#xFF09;&#x3002;</li>
<li>cpu&#xFF1A; &#x8FD9;&#x4E2A;subsystem&#x4F7F;&#x7528;&#x8C03;&#x5EA6;&#x7A0B;&#x5E8F;&#x63A7;&#x5236;task&#x5BF9;CPU&#x7684;&#x4F7F;&#x7528;&#x3002;</li>
<li>cpuacct&#xFF1A; &#x8FD9;&#x4E2A;subsystem&#x81EA;&#x52A8;&#x751F;&#x6210;cgroup&#x4E2D;task&#x5BF9;CPU&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x7684;&#x62A5;&#x544A;&#x3002;</li>
<li>cpuset&#xFF1A; &#x8FD9;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x4E3A;cgroup&#x4E2D;&#x7684;task&#x5206;&#x914D;&#x72EC;&#x7ACB;&#x7684;CPU&#xFF08;&#x6B64;&#x5904;&#x9488;&#x5BF9;&#x591A;&#x5904;&#x7406;&#x5668;&#x7CFB;&#x7EDF;&#xFF09;&#x548C;&#x5185;&#x5B58;&#x3002;</li>
<li>devices &#x8FD9;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x5F00;&#x542F;&#x6216;&#x5173;&#x95ED;cgroup&#x4E2D;task&#x5BF9;&#x8BBE;&#x5907;&#x7684;&#x8BBF;&#x95EE;&#x3002;</li>
<li>freezer &#x8FD9;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x6302;&#x8D77;&#x6216;&#x6062;&#x590D;cgroup&#x4E2D;&#x7684;task&#x3002;</li>
<li>memory &#x8FD9;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x8BBE;&#x5B9A;cgroup&#x4E2D;task&#x5BF9;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;&#x7684;&#x9650;&#x5B9A;&#xFF0C;&#x5E76;&#x4E14;&#x81EA;&#x52A8;&#x751F;&#x6210;&#x8FD9;&#x4E9B;task&#x5BF9;&#x5185;&#x5B58;&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x7684;&#x62A5;&#x544A;&#x3002;</li>
<li>perfevent &#x8FD9;&#x4E2A;subsystem&#x4F7F;&#x7528;&#x540E;&#x4F7F;&#x5F97;cgroup&#x4E2D;&#x7684;task&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x7EDF;&#x4E00;&#x7684;&#x6027;&#x80FD;&#x6D4B;&#x8BD5;&#x3002;{![perf: Linux CPU&#x6027;&#x80FD;&#x63A2;&#x6D4B;&#x5668;&#xFF0C;&#x8BE6;&#x89C1;<a href="/external_links/dc07f9b78d7d47604a887fb751616d52.html" target="blank" rel="noopener">perf.wiki.kernel.org/index.php/M&#x2026;</a></li>
<li>*net_cls &#x8FD9;&#x4E2A;subsystem Docker&#x6CA1;&#x6709;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#xFF0C;&#x5B83;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x7B49;&#x7EA7;&#x8BC6;&#x522B;&#x7B26;(classid)&#x6807;&#x8BB0;&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x5305;&#xFF0C;&#x4ECE;&#x800C;&#x5141;&#x8BB8; Linux &#x6D41;&#x91CF;&#x63A7;&#x5236;&#x7A0B;&#x5E8F;&#xFF08;TC&#xFF1A;Traffic Controller&#xFF09;&#x8BC6;&#x522B;&#x4ECE;&#x5177;&#x4F53;cgroup&#x4E2D;&#x751F;&#x6210;&#x7684;&#x6570;&#x636E;&#x5305;&#x3002;</li>
</ul>
<h2 id="&#x7EC4;&#x7EC7;&#x7ED3;&#x6784;&#x4E0E;&#x57FA;&#x672C;&#x89C4;&#x5219;"><a href="#&#x7EC4;&#x7EC7;&#x7ED3;&#x6784;&#x4E0E;&#x57FA;&#x672C;&#x89C4;&#x5219;" class="headerlink" title="&#x7EC4;&#x7EC7;&#x7ED3;&#x6784;&#x4E0E;&#x57FA;&#x672C;&#x89C4;&#x5219;"></a>&#x7EC4;&#x7EC7;&#x7ED3;&#x6784;&#x4E0E;&#x57FA;&#x672C;&#x89C4;&#x5219;</h2><p>&#x5927;&#x5BB6;&#x5728;namespace&#x6280;&#x672F;&#x7684;&#x8BB2;&#x89E3;&#x4E2D;&#x5DF2;&#x7ECF;&#x4E86;&#x89E3;&#x5230;&#xFF0C;&#x4F20;&#x7EDF;&#x7684;Unix&#x8FDB;&#x7A0B;&#x7BA1;&#x7406;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5148;&#x542F;&#x52A8;init&#x8FDB;&#x7A0B;&#x4F5C;&#x4E3A;&#x6839;&#x8282;&#x70B9;&#xFF0C;&#x518D;&#x7531;init&#x8282;&#x70B9;&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#x4F5C;&#x4E3A;&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x800C;&#x6BCF;&#x4E2A;&#x5B50;&#x8282;&#x70B9;&#x7531;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x6B64;&#x5F80;&#x590D;&#xFF0C;&#x5F62;&#x6210;&#x4E00;&#x4E2A;&#x6811;&#x72B6;&#x7ED3;&#x6784;&#x3002;&#x800C;cgroups&#x4E5F;&#x662F;&#x7C7B;&#x4F3C;&#x7684;&#x6811;&#x72B6;&#x7ED3;&#x6784;&#xFF0C;&#x5B50;&#x8282;&#x70B9;&#x90FD;&#x4ECE;&#x7236;&#x8282;&#x70B9;&#x7EE7;&#x627F;&#x5C5E;&#x6027;&#x3002;</p>
<p>&#x5B83;&#x4EEC;&#x6700;&#x5927;&#x7684;&#x4E0D;&#x540C;&#x5728;&#x4E8E;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E2D;cgroup&#x6784;&#x6210;&#x7684;hierarchy&#x53EF;&#x4EE5;&#x5141;&#x8BB8;&#x5B58;&#x5728;&#x591A;&#x4E2A;&#x3002;&#x5982;&#x679C;&#x8FDB;&#x7A0B;&#x6A21;&#x578B;&#x662F;&#x7531;init&#x4F5C;&#x4E3A;&#x6839;&#x8282;&#x70B9;&#x6784;&#x6210;&#x7684;&#x4E00;&#x68F5;&#x6811;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;cgroups&#x7684;&#x6A21;&#x578B;&#x5219;&#x662F;&#x7531;&#x591A;&#x4E2A;hierarchy&#x6784;&#x6210;&#x7684;&#x68EE;&#x6797;&#x3002;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x76EE;&#x7684;&#x4E5F;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x5982;&#x679C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;hierarchy&#xFF0C;&#x90A3;&#x4E48;&#x6240;&#x6709;&#x7684;task&#x90FD;&#x8981;&#x53D7;&#x5230;&#x7ED1;&#x5B9A;&#x5176;&#x4E0A;&#x7684;subsystem&#x7684;&#x9650;&#x5236;&#xFF0C;&#x4F1A;&#x7ED9;&#x90A3;&#x4E9B;&#x4E0D;&#x9700;&#x8981;&#x8FD9;&#x4E9B;&#x9650;&#x5236;&#x7684;task&#x9020;&#x6210;&#x9EBB;&#x70E6;&#x3002;</p>
<p>&#x4E86;&#x89E3;&#x4E86;cgroups&#x7684;&#x7EC4;&#x7EC7;&#x7ED3;&#x6784;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x4E86;&#x89E3;cgroup&#x3001;task&#x3001;subsystem&#x4EE5;&#x53CA;hierarchy&#x56DB;&#x8005;&#x95F4;&#x7684;&#x76F8;&#x4E92;&#x5173;&#x7CFB;&#x53CA;&#x5176;&#x57FA;&#x672C;&#x89C4;&#x5219;{![&#x53C2;&#x7167;&#x81EA;&#xFF1A;<a href="/external_links/83a8001b8164522aea03e0c74ea640bb.html" target="blank" rel="noopener">access.redhat.com/documentati&#x2026;</a></p>
<p>&#x89C4;&#x5219;1&#xFF1A; &#x540C;&#x4E00;&#x4E2A;hierarchy&#x53EF;&#x4EE5;&#x9644;&#x52A0;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;subsystem&#x3002;&#x5982;&#x4E0B;&#x56FE;1&#xFF0C;cpu&#x548C;memory&#x7684;subsystem&#x9644;&#x52A0;&#x5230;&#x4E86;&#x4E00;&#x4E2A;hierarchy&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/7cec89dfc91eb3df234c07d5772f6ae6f0b047007d4a8d4531a26e51be653f90" alt="image"></p>
<p>image</p>
<p>&#x56FE;1 &#x540C;&#x4E00;&#x4E2A;hierarchy&#x53EF;&#x4EE5;&#x9644;&#x52A0;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;subsystem</p>
<p>&#x89C4;&#x5219;2&#xFF1A; &#x4E00;&#x4E2A;subsystem&#x53EF;&#x4EE5;&#x9644;&#x52A0;&#x5230;&#x591A;&#x4E2A;hierarchy&#xFF0C;&#x5F53;&#x4E14;&#x4EC5;&#x5F53;&#x8FD9;&#x4E9B;hierarchy&#x53EA;&#x6709;&#x8FD9;&#x552F;&#x4E00;&#x4E00;&#x4E2A;subsystem&#x3002;&#x5982;&#x4E0B;&#x56FE;2&#xFF0C;&#x5C0F;&#x5708;&#x4E2D;&#x7684;&#x6570;&#x5B57;&#x8868;&#x793A;subsystem&#x9644;&#x52A0;&#x7684;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#xFF0C;CPU subsystem&#x9644;&#x52A0;&#x5230;hierarchy A&#x7684;&#x540C;&#x65F6;&#x4E0D;&#x80FD;&#x518D;&#x9644;&#x52A0;&#x5230;hierarchy B&#xFF0C;&#x56E0;&#x4E3A;hierarchy B&#x5DF2;&#x7ECF;&#x9644;&#x52A0;&#x4E86;memory subsystem&#x3002;&#x5982;&#x679C;hierarchy B&#x4E0E;hierarchy A&#x72B6;&#x6001;&#x76F8;&#x540C;&#xFF0C;&#x6CA1;&#x6709;&#x9644;&#x52A0;&#x8FC7;memory subsystem&#xFF0C;&#x90A3;&#x4E48;CPU subsystem&#x540C;&#x65F6;&#x9644;&#x52A0;&#x5230;&#x4E24;&#x4E2A;hierarchy&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/1deb6215b34d7b38a4a9966b876fb8d0c8b8b7a1b4bec16a659971bf169c4355" alt="image"></p>
<p>image</p>
<p>&#x56FE;2 &#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x9644;&#x52A0;&#x5728;&#x67D0;&#x4E2A;hierarchy&#x4E0A;&#x7684;subsystem&#x4E0D;&#x80FD;&#x9644;&#x52A0;&#x5230;&#x5176;&#x4ED6;&#x542B;&#x6709;&#x522B;&#x7684;subsystem&#x7684;hierarchy&#x4E0A;<br>&#x89C4;&#x5219;3&#xFF1A; &#x7CFB;&#x7EDF;&#x6BCF;&#x6B21;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;hierarchy&#x65F6;&#xFF0C;&#x8BE5;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x6240;&#x6709;task&#x9ED8;&#x8BA4;&#x6784;&#x6210;&#x4E86;&#x8FD9;&#x4E2A;&#x65B0;&#x5EFA;&#x7684;hierarchy&#x7684;&#x521D;&#x59CB;&#x5316;cgroup&#xFF0C;&#x8FD9;&#x4E2A;cgroup&#x4E5F;&#x79F0;&#x4E3A;root cgroup&#x3002;&#x5BF9;&#x4E8E;&#x4F60;&#x521B;&#x5EFA;&#x7684;&#x6BCF;&#x4E2A;hierarchy&#xFF0C;task&#x53EA;&#x80FD;&#x5B58;&#x5728;&#x4E8E;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;cgroup&#x4E2D;&#xFF0C;&#x5373;&#x4E00;&#x4E2A;task&#x4E0D;&#x80FD;&#x5B58;&#x5728;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x7684;&#x4E0D;&#x540C;cgroup&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x4E2A;task&#x53EF;&#x4EE5;&#x5B58;&#x5728;&#x5728;&#x4E0D;&#x540C;hierarchy&#x4E2D;&#x7684;&#x591A;&#x4E2A;cgroup&#x4E2D;&#x3002;&#x5982;&#x679C;&#x64CD;&#x4F5C;&#x65F6;&#x628A;&#x4E00;&#x4E2A;task&#x6DFB;&#x52A0;&#x5230;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x4E2D;&#x7684;&#x53E6;&#x4E00;&#x4E2A;cgroup&#x4E2D;&#xFF0C;&#x5219;&#x4F1A;&#x4ECE;&#x7B2C;&#x4E00;&#x4E2A;cgroup&#x4E2D;&#x79FB;&#x9664;&#x3002;&#x5728;&#x4E0B;&#x56FE;3&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;httpd&#x8FDB;&#x7A0B;&#x5DF2;&#x7ECF;&#x52A0;&#x5165;&#x5230;hierarchy A&#x4E2D;&#x7684;/cg1&#x800C;&#x4E0D;&#x80FD;&#x52A0;&#x5165;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x4E2D;&#x7684;/cg2&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x52A0;&#x5165;hierarchy B&#x4E2D;&#x7684;/cg3&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x4E0D;&#x5141;&#x8BB8;&#x52A0;&#x5165;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x4E2D;&#x7684;&#x5176;&#x4ED6;cgroup&#x91CE;&#x751F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x51FA;&#x73B0;&#x77DB;&#x76FE;&#xFF0C;&#x5982;CPU subsystem&#x4E3A;/cg1&#x5206;&#x914D;&#x4E86;30%&#xFF0C;&#x800C;&#x4E3A;/cg2&#x5206;&#x914D;&#x4E86;50%&#xFF0C;&#x6B64;&#x65F6;&#x5982;&#x679C;httpd&#x5728;&#x8FD9;&#x4E24;&#x4E2A;cgroup&#x4E2D;&#xFF0C;&#x5C31;&#x4F1A;&#x51FA;&#x73B0;&#x77DB;&#x76FE;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/b2ecb4620cea557a645d7a6fa5776be50dbc7bf6e3a215560673ef3f552fad30" alt="image"></p>
<p>image</p>
<p>&#x56FE;3 &#x4E00;&#x4E2A;task&#x4E0D;&#x80FD;&#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x7684;&#x4E0D;&#x540C;cgroup<br>&#x89C4;&#x5219;4&#xFF1A; &#x8FDB;&#x7A0B;&#xFF08;task&#xFF09;&#x5728;fork&#x81EA;&#x8EAB;&#x65F6;&#x521B;&#x5EFA;&#x7684;&#x5B50;&#x4EFB;&#x52A1;&#xFF08;child task&#xFF09;&#x9ED8;&#x8BA4;&#x4E0E;&#x539F;task&#x5728;&#x540C;&#x4E00;&#x4E2A;cgroup&#x4E2D;&#xFF0C;&#x4F46;&#x662F;child task&#x5141;&#x8BB8;&#x88AB;&#x79FB;&#x52A8;&#x5230;&#x4E0D;&#x540C;&#x7684;cgroup&#x4E2D;&#x3002;&#x5373;fork&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x7236;&#x5B50;&#x8FDB;&#x7A0B;&#x95F4;&#x662F;&#x5B8C;&#x5168;&#x72EC;&#x7ACB;&#x7684;&#x3002;&#x5982;&#x4E0B;&#x56FE;4&#x4E2D;&#xFF0C;&#x5C0F;&#x5708;&#x4E2D;&#x7684;&#x6570;&#x5B57;&#x8868;&#x793A;task &#x51FA;&#x73B0;&#x7684;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#xFF0C;&#x5F53;httpd&#x521A;fork&#x51FA;&#x53E6;&#x4E00;&#x4E2A;httpd&#x65F6;&#xFF0C;&#x5728;&#x540C;&#x4E00;&#x4E2A;hierarchy&#x4E2D;&#x7684;&#x540C;&#x4E00;&#x4E2A;cgroup&#x4E2D;&#x3002;&#x4F46;&#x662F;&#x968F;&#x540E;&#x5982;&#x679C;PID&#x4E3A;4840&#x7684;httpd&#x9700;&#x8981;&#x79FB;&#x52A8;&#x5230;&#x5176;&#x4ED6;cgroup&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x7236;&#x5B50;&#x4EFB;&#x52A1;&#x95F4;&#x5DF2;&#x7ECF;&#x72EC;&#x7ACB;&#x3002;&#x603B;&#x7ED3;&#x8D77;&#x6765;&#x5C31;&#x662F;&#xFF1A;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x5B50;&#x4EFB;&#x52A1;&#x4E0E;&#x7236;&#x4EFB;&#x52A1;&#x5728;&#x540C;&#x4E00;&#x4E2A;cgroup&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x79CD;&#x5173;&#x7CFB;&#x968F;&#x540E;&#x53EF;&#x4EE5;&#x6539;&#x53D8;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/229cec92b4fa1401e3e4e8b2607e9135a9f11cf24c452d2b44ec07fa41f46935" alt="image"></p>
<p>image</p>
<p>&#x56FE;4 &#x521A;fork&#x51FA;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x5728;&#x521D;&#x59CB;&#x72B6;&#x6001;&#x4E0E;&#x5176;&#x7236;&#x8FDB;&#x7A0B;&#x5904;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;cgroup<br>&#x8865;&#x5145;<br>==</p>
<h2 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h2><p>kuberlet&#x6709;&#x4E2A;systemd&#x6587;&#x6863;&#x8FD9;&#x4E48;&#x8BF4;&#xFF1A;<br>This document describes how the node should be configured, and a set of enhancements that should be made to the kubelet to better integrate with these distributions independent of container runtime.</p>
<p>The Kernel direction for cgroup management is to promote a single-writer model rather than allowing multiple processes to independently write to parts of the file-system.In distributions that run systemd as their init system, the cgroup tree is managed by systemd by default since it implicitly interacts with the cgroup tree when starting units. Manual changes made by other cgroup managers to the cgroup tree are not guaranteed to be preserved unless systemd is made aware. systemd can be told to ignore sections of the cgroup tree by configuring the unit to have the Delegate= option.</p>
<p>&#x662F;&#x8BF4;&#x518D;linux&#x4E0A;&#x5C31;&#x63A8;&#x8350;&#x7528;systemd&#x6765;&#x7BA1;&#x7406;cgroup?&#x800C;&#x4E14;&#x8FD9;&#x6837;&#x8FD8;&#x80FD;&#x4E0D;&#x4F9D;&#x8D56;docker?</p>
<h2 id="sysctl"><a href="#sysctl" class="headerlink" title="sysctl"></a>sysctl</h2><p>&#x9664;&#x4E86;cgroup&#x505A;&#x8D44;&#x6E90;&#x9650;&#x5236;&#xFF0C;&#x5BF9;&#x4E8E;&#x7CFB;&#x7EDF;&#x7EA7;&#x522B;&#x7684;&#x8D44;&#x6E90;&#x9650;&#x5236;&#x76F8;&#x5173;&#x7684;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;sysctl&#x547D;&#x4EE4;<br>sysctl&#x547D;&#x4EE4;&#x88AB;&#x7528;&#x4E8E;&#x5728;&#x5185;&#x6838;&#x8FD0;&#x884C;&#x65F6;&#x52A8;&#x6001;&#x5730;&#x4FEE;&#x6539;&#x5185;&#x6838;&#x7684;&#x8FD0;&#x884C;&#x53C2;&#x6570;&#xFF0C;&#x53EF;&#x7528;&#x7684;&#x5185;&#x6838;&#x53C2;&#x6570;&#x5728;&#x76EE;&#x5F55;/proc/sys&#x4E2D;&#x3002;&#x5B83;&#x5305;&#x542B;&#x4E00;&#x4E9B;TCP/ip&#x5806;&#x6808;&#x548C;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7CFB;&#x7EDF;&#x7684;&#x9AD8;&#x7EA7;&#x9009;&#x9879;&#xFF0C; &#x8FD9;&#x53EF;&#x4EE5;&#x8BA9;&#x6709;&#x7ECF;&#x9A8C;&#x7684;&#x7BA1;&#x7406;&#x5458;&#x63D0;&#x9AD8;&#x5F15;&#x4EBA;&#x6CE8;&#x76EE;&#x7684;&#x7CFB;&#x7EDF;&#x6027;&#x80FD;&#x3002;&#x7528;sysctl&#x53EF;&#x4EE5;&#x8BFB;&#x53D6;&#x8BBE;&#x7F6E;&#x8D85;&#x8FC7;&#x4E94;&#x767E;&#x4E2A;&#x7CFB;&#x7EDF;&#x53D8;&#x91CF;&#x3002;<br> Parameters are available via /proc/sys/ virtual process file system. The parameters cover various subsystems such as:</p>
<ul>
<li>kernel (common prefix: kernel.)</li>
<li>networking (common prefix: net.)</li>
<li>virtual memory (common prefix: vm.)</li>
<li>MDADM (common prefix: dev.)</li>
</ul>
<p>docker privileged&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#xFF0C;&#x4F46;&#x662F;&#x6709;&#x4E9B;&#x53C2;&#x6570;&#x662F;&#x7CFB;&#x7EDF;&#x7EA7;&#x522B;&#x7684;&#xFF0C;&#x6CA1;&#x6709;&#x9694;&#x79BB;&#xFF0C;&#x6539;&#x4E86;&#x4F1A;&#x5F71;&#x54CD;&#x522B;&#x7684;&#x5BB9;&#x5668;&#x3002;&#x540E;&#x6765;&#x7248;&#x672C;docker&#x505A;&#x4E86;&#x9650;&#x5236;&#xFF0C;&#x53EA;&#x80FD;&#x6539;&#x4E00;&#x4E9B;whitelisted sysctls&#x3002;<br>Only namespaced kernel parameters can be modified<br>k8s&#x91CC;&#x9762;&#x7684;&#x8BBE;&#x7F6E;<a href="/external_links/0058fbbf97a30fd40c4a71fb1bf10aca.html" target="blank" rel="noopener">github.com/kubernetes/&#x2026;</a></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/59ebab96df95b0ec2f43adecf6cb5743.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512485150734.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512485150734.html" itemprop="url">Go 中任务队列的简单实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T12:03:08+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>At <a href="/external_links/3b9924111f4b4e42a6f5b355ace6c8a8.html" target="blank" rel="noopener">RapidLoop</a>, we use <a href="/external_links/f81accd2393b67eb852f5cd56ba50885.html" target="blank" rel="noopener">Go</a> for nearly everything, including our server, service and uptime monitoring product <a href="/external_links/d9639ec177271421876919d33f4f6b44.html" target="blank" rel="noopener">OpsDash</a>.</p>
<p>Go is quite good at asynchronous processing &#x2013; goroutines and channels are arguably simpler, less error-prone and yet as powerful compared to async/awaits, promises and futures from other languages. Read on to see some interesting Go code around <em>job queues</em>.</p>
<h4 id="The-&#x201C;No-Job-Queue&#x201D;-Job-Queue"><a href="#The-&#x201C;No-Job-Queue&#x201D;-Job-Queue" class="headerlink" title="The &#x201C;No-Job-Queue&#x201D; Job Queue"></a>The &#x201C;No-Job-Queue&#x201D; Job Queue</h4><p>Let&#x2019;s start with a bit of Zen &#x2013; sometimes you just don&#x2019;t need a job queue. Processing a job asynchronously can be done with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;go process(job)</span><br></pre></td></tr></table></figure>

<p>This is indeed the best option for some needs, like firing off an email while handling an HTTP request. Whether you need a more elaborate infrastructure to deal with job processing depends mostly on scale and complexity. Queuing up your jobs and processing<br> them in a controlled manner allows you to add more functionality like bounding the number of concurrent jobs, producer throttling and so on.</p>
<h4 id="The-Simplest-Job-Queue"><a href="#The-Simplest-Job-Queue" class="headerlink" title="The Simplest Job Queue"></a>The Simplest Job Queue</h4><p>Here is a simple queue and a worker that processes jobs off the queue. Goroutines and channels are just the right abstractions needed to code this into an elegant, tight piece.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;func worker(jobChan &lt;-chan Job) {</span><br><span class="line">    for job := range jobChan {</span><br><span class="line">        process(job)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// make a channel with a capacity of 100.</span><br><span class="line">jobChan := make(chan Job, 100)</span><br><span class="line"></span><br><span class="line">// start the worker</span><br><span class="line">go worker(jobChan)</span><br><span class="line"></span><br><span class="line">// enqueue a job</span><br><span class="line">jobChan &lt;- job</span><br></pre></td></tr></table></figure>

<p>The code basically creates a channel of <code>Job</code> objects, with a capacity of 100. It then starts a worker goroutine called <code>worker</code>. The worker pops jobs off the channel and processes them, one at a time. Jobs can be enqueued by pushing<br> a <code>Job</code> object into the channel.</p>
<p>Although there are just a few lines of code, there&#x2019;s a lot going on. First off, you have safe, correct, race-free code without having to mess with threads and mutexes.</p>
<p>Another feature is producer throttling.</p>
<h4 id="Producer-Throttling"><a href="#Producer-Throttling" class="headerlink" title="Producer Throttling"></a>Producer Throttling</h4><p>The channel is created with a capacity of 100:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// make a channel with a capacity of 100.</span><br><span class="line">jobChan := make(chan Job, 100)</span><br></pre></td></tr></table></figure>

<p>which means that the enqueuing of a job like so:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// enqueue a job</span><br><span class="line">jobChan &lt;- job</span><br></pre></td></tr></table></figure>

<p>will block, if there already are 100 jobs in the channel that the worker hasn&#x2019;t got around to servicing. This is usually a good thing. You don&#x2019;t want the backlog of jobs to grow too big if there is a SLA/QoS constraint, or even a reasonable assumption,<br> that a job must finish within a certain amount of time. For example, if a job takes 1 second to finish in the worst case, with a channel capacity of 100 you&#x2019;re looking at a worst case job finish time of 100 seconds.</p>
<p>If the channel is full, you&#x2019;ll want your caller to back off for a while, typically. For example, it this were a REST API call, you might return a 503 (service unavailable) error code and document that the caller has to retry after a wait. This way, you&#x2019;re<br> applying <strong>backpressure</strong> up the caller chain to maintain a predictable quality of service.</p>
<h4 id="Enqueueing-Without-Blocking"><a href="#Enqueueing-Without-Blocking" class="headerlink" title="Enqueueing Without Blocking"></a>Enqueueing Without Blocking</h4><p>So how would you only <em>try</em> to enqueue, and fail if the operation would block? That way you can fail the job submission operation, and say return a 503. The trick is to use a <code>select</code> with a <code>default</code> clause:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// TryEnqueue tries to enqueue a job to the given job channel. Returns true if</span><br><span class="line">// the operation was successful, and false if enqueuing would not have been</span><br><span class="line">// possible without blocking. Job is not enqueued in the latter case.</span><br><span class="line">func TryEnqueue(job Job, jobChan &lt;-chan Job) bool {</span><br><span class="line">    select {</span><br><span class="line">    case jobChan &lt;- job:</span><br><span class="line">        return true</span><br><span class="line">    default:</span><br><span class="line">        return false</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>With this, you can fail the submission this way:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;if !TryEnqueue(job, chan) {</span><br><span class="line">    http.Error(w, &quot;max capacity reached&quot;, 503)</span><br><span class="line">    return</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="Stopping-the-Worker"><a href="#Stopping-the-Worker" class="headerlink" title="Stopping the Worker"></a>Stopping the Worker</h4><p>OK, so far so good. Now how can we stop the worker gracefully? Assuming that we&#x2019;ve decided not to enqueue any more jobs and we want to let all the enqueued jobs finish, we can simply do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;close(jobChan)</span><br></pre></td></tr></table></figure>

<p>Yes, that&#x2019;s all there is. This works because the worker pops jobs off the queue with a for..range loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;for job := range jobChan {...}</span><br></pre></td></tr></table></figure>

<p>and this loop will exit when the channel is closed. All jobs enqueued into the channel before the channel was closed, will be popped out by the worker and processed as usual.</p>
<h4 id="Waiting-for-the-Worker"><a href="#Waiting-for-the-Worker" class="headerlink" title="Waiting for the Worker"></a>Waiting for the Worker</h4><p>That was pretty easy. But <code>close(jobChan)</code> will not wait for the goroutine to exit. For that, we&#x2019;ll use a <code>sync.WaitGroup</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// use a WaitGroup </span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">func worker(jobChan &lt;-chan Job) {</span><br><span class="line">    defer wg.Done()</span><br><span class="line"></span><br><span class="line">    for job := range jobChan {</span><br><span class="line">        process(job)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// increment the WaitGroup before starting the worker</span><br><span class="line">wg.Add(1)</span><br><span class="line">go worker(jobChan)</span><br><span class="line"></span><br><span class="line">// to stop the worker, first close the job channel</span><br><span class="line">close(jobChan)</span><br><span class="line"></span><br><span class="line">// then wait using the WaitGroup</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure>

<p>With this, we&#x2019;ll signal the worker to stop by closing the channel, and then wait for the worker goroutine to end with the <code>wg.Wait()</code>.</p>
<p>Note that we&#x2019;ve to increment the wait group <em>before</em> starting the goroutine, and decrement it <em>once</em> from <em>within</em> the goroutine when it exits, irrespective of the return path.</p>
<h4 id="Waiting-with-a-Timeout"><a href="#Waiting-with-a-Timeout" class="headerlink" title="Waiting with a Timeout"></a>Waiting with a Timeout</h4><p>The <code>wg.Wait()</code> will wait forever for the goroutine to exit. But what if we can&#x2019;t afford to wait indefinitely?</p>
<p>Here&#x2019;s a helper function that wraps <code>wg.Wait</code> and adds a timeout:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// WaitTimeout does a Wait on a sync.WaitGroup object but with a specified</span><br><span class="line">// timeout. Returns true if the wait completed without timing out, false</span><br><span class="line">// otherwise.</span><br><span class="line">func WaitTimeout(wg *sync.WaitGroup, timeout time.Duration) bool {</span><br><span class="line">    ch := make(chan struct{})</span><br><span class="line">    go func() {</span><br><span class="line">        wg.Wait()</span><br><span class="line">        close(ch)</span><br><span class="line">    }()</span><br><span class="line">    select {</span><br><span class="line">    case &lt;-ch:</span><br><span class="line">            return true</span><br><span class="line">    case &lt;-time.After(timeout):</span><br><span class="line">            return false</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// now use the WaitTimeout instead of wg.Wait()</span><br><span class="line">WaitTimeout(&amp;wg, 5 * time.Second)</span><br></pre></td></tr></table></figure>

<p>This now let&#x2019;s you wait for your worker to exit, but places a bound on the amount of time it may take to do so.</p>
<h4 id="Cancelling-Workers"><a href="#Cancelling-Workers" class="headerlink" title="Cancelling Workers"></a>Cancelling Workers</h4><p>So far we have allowed our worker the liberty to finish processing it&#x2019;s jobs even after we signalled it to stop. What if we need to say: &#x201C;drop the rest, let&#x2019;s get out of here!&#x201D; to the worker?</p>
<p>Here&#x2019;s how to do it with <code>context.Context</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// create a context that can be cancelled</span><br><span class="line">ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">// start the goroutine passing it the context</span><br><span class="line">go worker(ctx, jobChan)</span><br><span class="line"></span><br><span class="line">func worker(ctx context.Context, jobChan &lt;-chan Job) {</span><br><span class="line">    for {</span><br><span class="line">        select {</span><br><span class="line">        case &lt;-ctx.Done():</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        case job := &lt;-jobChan:</span><br><span class="line">            process(job)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Invoke cancel when the worker needs to be stopped. This *does not* wait</span><br><span class="line">// for the worker to exit.</span><br><span class="line">cancel()</span><br></pre></td></tr></table></figure>

<p>Basically, we create a &#x201C;cancellable context&#x201D;, and pass this to the worker. The worker waits on this, in addition to the job channel. The <code>ctx.Done()</code> becomes readable when <code>cancel</code> is invoked.</p>
<p>Like with the closing of the job channel, the <code>cancel()</code> will only signal, and does not wait. You&#x2019;ll have to add the wait group code if you need to wait for the worker to exit &#x2013; although the wait should be shorter as the worker will not process<br> the remaining jobs.</p>
<p>However, there is a bit of a gotcha with this code. Consider the case when you have a backlog in the channel (so that &lt;-jobChan will not block), and cancel() has been invoked (so that &lt;-ctx.Done() also will not block). Since neither cases will block,<br> the <code>select</code> has to choose between them. Fairly, one hopes.</p>
<p>Alas, in practice, this is not true. Not only is it plausible that &#x201C;&lt;-jobChan&#x201D; is selected despite &#x201C;&lt;-ctx.Done()&#x201D; also being non-blocking, it happens disconcertingly easily in practice. Even after a job is popped despite the cancellation and there<br> are more pending, the situation remains the same &#x2013; and the runtime is free to make the same &#x201C;mistake&#x201D; again.</p>
<p>To be fair (uh!), what we need is not fairness, but priority. The context cancellation case should have a higher priority than the other. However, there is no easy, built-in way to do this.</p>
<p>A flag might help:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;var flag uint64</span><br><span class="line"></span><br><span class="line">func worker(ctx context.Context, jobChan &lt;-chan Job) {</span><br><span class="line">    for {</span><br><span class="line">        select {</span><br><span class="line">        case &lt;-ctx.Done():</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        case job := &lt;-jobChan:</span><br><span class="line">            process(job)</span><br><span class="line">            if atomic.LoadUint64(&amp;flag) == 1 {</span><br><span class="line">                return</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// set the flag first, before cancelling</span><br><span class="line">atomic.StoreUint64(&amp;flag, 1)</span><br><span class="line">cancel()</span><br></pre></td></tr></table></figure>

<p>We don&#x2019;t check the flag before processing because since we popped the job, we might as well service it, to be consistent. Of course, if bailing out is a higher priority the check can be moved before the processing.</p>
<p>Bottom line? Either live with the fact that your worker might process a few extra jobs before exiting, or design your code carefully to work around the gotchas.</p>
<h4 id="Cancelling-Workers-Without-Context"><a href="#Cancelling-Workers-Without-Context" class="headerlink" title="Cancelling Workers Without Context"></a>Cancelling Workers Without Context</h4><p><code>context.Context</code> is not magic. In fact, for this particular case, not having the context makes the code cleaner and clearer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// create a cancel channel</span><br><span class="line">cancelChan := make(chan struct{})</span><br><span class="line"></span><br><span class="line">// start the goroutine passing it the cancel channel </span><br><span class="line">go worker(jobChan, cancelChan)</span><br><span class="line"></span><br><span class="line">func worker(jobChan &lt;-chan Job, cancelChan &lt;-chan struct{}) {</span><br><span class="line">    for {</span><br><span class="line">        select {</span><br><span class="line">        case &lt;-cancelChan:</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        case job := &lt;-jobChan:</span><br><span class="line">            process(job)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// to cancel the worker, close the cancel channel</span><br><span class="line">close(cancelChan)</span><br></pre></td></tr></table></figure>

<p>This is essentially what (simple, non-hierarchical) context cancellation does behind the scenes too. The same gotchas exist, unfortunately.</p>
<h4 id="A-Pool-of-Workers"><a href="#A-Pool-of-Workers" class="headerlink" title="A Pool of Workers"></a>A Pool of Workers</h4><p>And finally, having multiple workers lets you increase your job concurrency. The easiest way is to simply spawn multiple workers and have them read off the same job channel:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;for i:=0; i&lt;workerCount; i++ {</span><br><span class="line">    go worker(jobChan)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>The rest of the code does not change. There will be multiple workers trying to read from the same channel &#x2013; this is valid, and safe. Only one of the workers will successfully read, and the rest will block.</p>
<p>Again, there is a question of fairness. Ideally, if 100 jobs were processed by 4 workers, each would do 25. However, this may or may not be the case, and your code should not assume fairness.</p>
<p>To wait for workers to exit, add a wait group as usual:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;for i:=0; i&lt;workerCount; i++ {</span><br><span class="line">    wg.Add(1)</span><br><span class="line">    go worker(jobChan)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// wait for all workers to exit</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure>

<p>For cancelling, you&#x2019;ll have to use a cancel channel per worker, then close all of them.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;// create cancel channels</span><br><span class="line">cancelChans := make([]chan struct{}, workerCount)</span><br><span class="line"></span><br><span class="line">for i:=0; i&lt;workerCount; i++ {</span><br><span class="line">    go worker(jobChan, cancelChans[i])</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">for i:=0; i&lt;workerCount; i++ {</span><br><span class="line">    close(cancelChans[i])</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="A-Generic-Job-Queue-Library"><a href="#A-Generic-Job-Queue-Library" class="headerlink" title="A Generic Job Queue Library?"></a>A Generic Job Queue Library?</h4><p>On the face of it, job queues appear simple, and wonderfully suited to spinning off into a generic, reusable component. In reality though, the nitty-gritty details for each different place you&#x2019;d want to use it will likely add to the complexity of the<br> &#x201C;generic&#x201D; component. Couple this with the fact that it&#x2019;s easier to write out a job queue in Go than in most other languages, you&#x2019;re <em>probably</em> better off writing job queues tailored to each requirement.</p>
<h4 id="License"><a href="#License" class="headerlink" title="License"></a>License</h4><p>All code listed above is published under the MIT license:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;Copyright (c) 2017 RapidLoop, Inc.</span><br><span class="line"></span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</span><br><span class="line">of this software and associated documentation files (the &quot;Software&quot;), to deal</span><br><span class="line">in the Software without restriction, including without limitation the rights</span><br><span class="line">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span><br><span class="line">copies of the Software, and to permit persons to whom the Software is</span><br><span class="line">furnished to do so, subject to the following conditions:</span><br><span class="line"></span><br><span class="line">The above copyright notice and this permission notice shall be included in</span><br><span class="line">all copies or substantial portions of the Software.</span><br><span class="line"></span><br><span class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span><br><span class="line">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span><br><span class="line">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span><br><span class="line">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span><br><span class="line">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span><br><span class="line">THE SOFTWARE.</span><br></pre></td></tr></table></figure>

<h5 id="New-Here"><a href="#New-Here" class="headerlink" title="New Here?"></a>New Here?</h5><p>OpsDash is a server monitoring, service monitoring, and database monitoring solution for monitoring Docker, MySQL, PostgreSQL, MongoDB, memcache, Redis, Apache, Nginx, Elasticsearch and more. It provides intelligent, customizable dashboards and rule-based<br> alerting via email, HipChat, Slack, PagerDuty, OpsGenie, VictorOps and Webhooks. Send in your custom metrics with StatsD and Graphite interfaces built into each agent.</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/835ee0618f5094cde1d1469e940e65a9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512413831181.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512413831181.html" itemprop="url">redis源码分析之有序集SortedSet</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T12:00:24+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x6709;&#x5E8F;&#x96C6;SortedSet&#x7B97;&#x662F;redis&#x4E2D;&#x4E00;&#x4E2A;&#x5F88;&#x6709;&#x7279;&#x8272;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x8FD9;&#x5757;&#x77E5;&#x8BC6;&#x70B9;&#x3002;</p>
</blockquote>
<p>&#x539F;&#x6587;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/99b417882107c32f516d2dedb23fa150.html" target="blank" rel="noopener">www.jianshu.com/p/75ca5a359&#x2026;</a></p>
<h3 id="&#x4E00;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x7B80;&#x4ECB;"><a href="#&#x4E00;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x7B80;&#x4ECB;" class="headerlink" title="&#x4E00;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x7B80;&#x4ECB;"></a>&#x4E00;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x7B80;&#x4ECB;</h3><p>redis&#x4E2D;&#x7684;&#x6709;&#x5E8F;&#x96C6;&#xFF0C;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x4F7F;&#x7528;&#x6307;&#x5B9A;&#x503C;&#x5BF9;&#x653E;&#x8FDB;&#x53BB;&#x7684;&#x5143;&#x7D20;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x5E76;&#x4E14;&#x57FA;&#x4E8E;&#x8BE5;&#x5DF2;&#x6392;&#x5E8F;&#x7684;&#x96C6;&#x5408;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x4E30;&#x5BCC;&#x7684;&#x64CD;&#x4F5C;&#x96C6;&#x5408;&#x7684;API&#x3002;<br>&#x4E3E;&#x4F8B;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;//&#x6DFB;&#x52A0;&#x5143;&#x7D20;&#xFF0C;table1&#x4E3A;&#x6709;&#x5E8F;&#x96C6;&#x7684;&#x540D;&#x5B57;&#xFF0C;100&#x4E3A;&#x7528;&#x4E8E;&#x6392;&#x5E8F;&#x5B57;&#x6BB5;&#xFF08;redis&#x628A;&#x5B83;&#x53EB;&#x505A;score&#xFF09;&#xFF0C;a&#x4E3A;&#x6211;&#x4EEC;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x5143;&#x7D20;</span><br><span class="line">127.0.0.1:6379&gt; zadd table1 100 a</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd table1 200 b</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd table1 300 c</span><br><span class="line">(integer) 1</span><br><span class="line">//&#x6309;&#x7167;&#x5143;&#x7D20;&#x7D22;&#x5F15;&#x8FD4;&#x56DE;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x7D22;&#x5F15;&#x4ECE;0&#x5F00;&#x59CB;</span><br><span class="line">127.0.0.1:6379&gt; zrange table1 0 1</span><br><span class="line">1) &quot;a&quot;</span><br><span class="line">2) &quot;b&quot;</span><br><span class="line">//&#x6309;&#x7167;&#x5143;&#x7D20;&#x6392;&#x5E8F;&#x8303;&#x56F4;&#x8FD4;&#x56DE;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x91CC;&#x7528;&#x4E8E;&#x6392;&#x5E8F;&#x7684;&#x5B57;&#x6BB5;&#x5728;redis&#x4E2D;&#x53EB;&#x505A;score</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore table1 150 400</span><br><span class="line">1) &quot;b&quot;</span><br><span class="line">2) &quot;c&quot;</span><br><span class="line">//&#x5220;&#x9664;&#x5143;&#x7D20;</span><br><span class="line">127.0.0.1:6379&gt; zrem table1 b</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p><strong>&#x5728;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#xFF0C;&#x7528;&#x4E8E;&#x6392;&#x5E8F;&#x7684;&#x503C;&#x53EB;&#x505A;score&#xFF0C;&#x5B9E;&#x9645;&#x5B58;&#x50A8;&#x7684;&#x503C;&#x53EB;&#x505A;member&#x3002;</strong></p>
<p>&#x7531;&#x4E8E;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x63D0;&#x4F9B;&#x7684;API&#x8F83;&#x591A;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x4E3E;&#x4E86;&#x51E0;&#x4E2A;&#x5E38;&#x89C1;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;redis&#x6587;&#x6863;&#x3002;</p>
<p>&#x5173;&#x4E8E;&#x6709;&#x5E8F;&#x96C6;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x5341;&#x5206;&#x5E38;&#x89C1;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x5C31;&#x662F;&#x7528;&#x6237;&#x8BC4;&#x8BBA;&#x3002;&#x5728;APP&#x6216;&#x8005;&#x7F51;&#x7AD9;&#x4E0A;&#x53D1;&#x5E03;&#x4E00;&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x4E0B;&#x9762;&#x4F1A;&#x6709;&#x5F88;&#x591A;&#x8BC4;&#x8BBA;&#xFF0C;&#x901A;&#x5E38;&#x5C55;&#x793A;&#x662F;&#x6309;&#x7167;&#x53D1;&#x5E03;&#x65F6;&#x95F4;&#x5012;&#x5E8F;&#x6392;&#x5217;&#xFF0C;&#x8FD9;&#x4E2A;&#x9700;&#x6C42;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6709;&#x5E8F;&#x96C6;&#xFF0C;&#x4EE5;&#x53D1;&#x5E03;&#x8BC4;&#x8BBA;&#x7684;&#x65F6;&#x95F4;&#x6233;&#x4F5C;&#x4E3A;score&#xFF0C;&#x7136;&#x540E;&#x6309;&#x7167;&#x5C55;&#x793A;&#x8BC4;&#x8BBA;&#x7684;&#x6570;&#x91CF;&#x5012;&#x5E8F;&#x67E5;&#x627E;&#x6709;&#x5E8F;&#x96C6;&#x3002;</p>
<h3 id="&#x4E8C;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x6E90;&#x7801;&#x5206;&#x6790;"><a href="#&#x4E8C;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x6E90;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x4E8C;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x6E90;&#x7801;&#x5206;&#x6790;"></a>&#x4E8C;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x6E90;&#x7801;&#x5206;&#x6790;</h3><p>&#x8001;&#x89C4;&#x77E9;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x4ECE;server.c&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x8868;&#x4E2D;&#x627E;&#x5230;&#x76F8;&#x5173;&#x547D;&#x4EE4;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x4E00;&#x5206;&#x6790;&#x3002;<br>&#x4F9D;&#x65E7;&#x4ECE;&#x6DFB;&#x52A0;&#x5143;&#x7D20;&#x5F00;&#x59CB;&#xFF0C;zaddCommand&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;void zaddCommand(client *c) {</span><br><span class="line">    zaddGenericCommand(c,ZADD_NONE);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6D41;&#x7A0B;&#x8F6C;&#x5411;&#x4E86;zaddGenericCommand&#xFF0C;&#x5E76;&#x4E14;&#x4F20;&#x5165;&#x4E86;&#x4E00;&#x4E2A;&#x6A21;&#x5F0F;&#x6807;&#x8BB0;&#x3002;<br>&#x5173;&#x4E8E;SortedSet&#x7684;&#x64CD;&#x4F5C;&#x6A21;&#x5F0F;&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x8BF4;&#x660E;&#x4E00;&#x4E0B;&#xFF0C;&#x5148;&#x6765;&#x770B;&#x4E00;&#x6761;&#x5B8C;&#x6574;&#x7684;zadd&#x547D;&#x4EE4;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;zadd key [NX|XX] [CH] [INCR] score member [score member ...]</span><br></pre></td></tr></table></figure>

<p>&#x5176;&#x4E2D;&#x7684;&#x53EF;&#x9009;&#x9879;&#x6211;&#x4EEC;&#x4F9D;&#x6B21;&#x770B;&#x4E0B;&#xFF1A;</p>
<ol>
<li>NX&#x8868;&#x793A;&#x5982;&#x679C;&#x5143;&#x7D20;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x4E0D;&#x6267;&#x884C;&#x66FF;&#x6362;&#x64CD;&#x4F5C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x3002;</li>
<li>XX&#x8868;&#x793A;&#x53EA;&#x64CD;&#x4F5C;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x5143;&#x7D20;&#x3002;</li>
<li>CH&#x8868;&#x793A;&#x8FD4;&#x56DE;&#x4FEE;&#x6539;&#xFF08;&#x5305;&#x62EC;&#x6DFB;&#x52A0;&#xFF0C;&#x66F4;&#x65B0;&#xFF09;&#x5143;&#x7D20;&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x53EA;&#x80FD;&#x88AB;ZADD&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#x3002;</li>
<li>INCR&#x8868;&#x793A;&#x5728;&#x539F;&#x6765;&#x7684;score&#x57FA;&#x7840;&#x4E0A;&#x52A0;&#x4E0A;&#x65B0;&#x7684;score&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x66FF;&#x6362;&#x3002;</li>
</ol>
<p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x4E2D;&#x7684;ZADD_NONE&#x8868;&#x793A;&#x666E;&#x901A;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x4E0B;zaddGenericCommand&#x51FD;&#x6570;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5F88;&#x957F;&#xFF0C;&#x8010;&#x5FC3;&#x4E00;&#x70B9;&#x70B9;&#x770B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;void zaddGenericCommand(client *c, int flags) {</span><br><span class="line">    //&#x4E00;&#x6761;&#x9519;&#x8BEF;&#x63D0;&#x793A;&#x4FE1;&#x606F;</span><br><span class="line">    static char *nanerr = &quot;resulting score is not a number (NaN)&quot;;</span><br><span class="line">    //&#x6709;&#x5E8F;&#x96C6;&#x540D;&#x5B57;</span><br><span class="line">    robj *key = c-&gt;argv[1];</span><br><span class="line">    robj *zobj;</span><br><span class="line">    sds ele;</span><br><span class="line">    double score = 0, *scores = NULL;</span><br><span class="line">    int j, elements;</span><br><span class="line">    int scoreidx = 0;</span><br><span class="line">    //&#x8BB0;&#x5F55;&#x5143;&#x7D20;&#x64CD;&#x4F5C;&#x4E2A;&#x6570;</span><br><span class="line">    int added = 0;     </span><br><span class="line">    int updated = 0;    </span><br><span class="line">    int processed = 0;  </span><br><span class="line"></span><br><span class="line">    //&#x67E5;&#x627E;score&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x9ED8;&#x8BA4;score&#x5728;&#x4F4D;&#x7F6E;2&#x4E0A;&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x6709;&#x5404;&#x79CD;&#x6A21;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5224;&#x65AD;</span><br><span class="line">    scoreidx = 2;</span><br><span class="line">    while(scoreidx &lt; c-&gt;argc) {</span><br><span class="line">        char *opt = c-&gt;argv[scoreidx]-&gt;ptr;</span><br><span class="line">        //&#x5224;&#x65AD;&#x547D;&#x4EE4;&#x4E2D;&#x662F;&#x5426;&#x8BBE;&#x7F6E;&#x4E86;&#x5404;&#x79CD;&#x6A21;&#x5F0F;</span><br><span class="line">        if (!strcasecmp(opt,&quot;nx&quot;)) flags |= ZADD_NX;</span><br><span class="line">        else if (!strcasecmp(opt,&quot;xx&quot;)) flags |= ZADD_XX;</span><br><span class="line">        else if (!strcasecmp(opt,&quot;ch&quot;)) flags |= ZADD_CH;</span><br><span class="line">        else if (!strcasecmp(opt,&quot;incr&quot;)) flags |= ZADD_INCR;</span><br><span class="line">        else break;</span><br><span class="line">        scoreidx++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    //&#x8BBE;&#x7F6E;&#x6A21;&#x5F0F;</span><br><span class="line">    int incr = (flags &amp; ZADD_INCR) != 0;</span><br><span class="line">    int nx = (flags &amp; ZADD_NX) != 0;</span><br><span class="line">    int xx = (flags &amp; ZADD_XX) != 0;</span><br><span class="line">    int ch = (flags &amp; ZADD_CH) != 0;</span><br><span class="line"></span><br><span class="line">    //&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x89E3;&#x6790;&#xFF0C;scoreidx&#x4E3A;&#x771F;&#x5B9E;&#x7684;&#x521D;&#x59CB;score&#x7684;&#x7D22;&#x5F15;&#x4F4D;&#x7F6E;</span><br><span class="line">    //&#x8FD9;&#x91CC;&#x5BA2;&#x6237;&#x7AEF;&#x53C2;&#x6570;&#x6570;&#x91CF;&#x51CF;&#x53BB;scoreidx&#x5C31;&#x662F;&#x5269;&#x4F59;&#x6240;&#x6709;&#x5143;&#x7D20;&#x7684;&#x6570;&#x91CF;</span><br><span class="line">    elements = c-&gt;argc - scoreidx;</span><br><span class="line">    //&#x7531;&#x4E8E;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;score&#xFF0C;member&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#xFF0C;&#x6240;&#x4EE5;&#x52A0;&#x4E00;&#x5C42;&#x5224;&#x65AD;</span><br><span class="line">    if (elements % 2 || !elements) {</span><br><span class="line">        addReply(c,shared.syntaxerr);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    //&#x8FD9;&#x91CC;&#x8BA1;&#x7B97;score&#xFF0C;member&#x6709;&#x591A;&#x5C11;&#x5BF9;</span><br><span class="line">    elements /= 2; </span><br><span class="line"></span><br><span class="line">    //&#x53C2;&#x6570;&#x5408;&#x6CD5;&#x6027;&#x6821;&#x9A8C;</span><br><span class="line">    if (nx &amp;&amp; xx) {</span><br><span class="line">        addReplyError(c,</span><br><span class="line">            &quot;XX and NX options at the same time are not compatible&quot;);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    //&#x53C2;&#x6570;&#x5408;&#x6CD5;&#x6027;&#x6821;&#x9A8C;</span><br><span class="line">    if (incr &amp;&amp; elements &gt; 1) {</span><br><span class="line">        addReplyError(c,</span><br><span class="line">            &quot;INCR option supports a single increment-element pair&quot;);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    //&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x89E3;&#x6790;score&#xFF0C;&#x5148;&#x521D;&#x59CB;&#x5316;scores&#x6570;&#x7EC4;</span><br><span class="line">    scores = zmalloc(sizeof(double)*elements);</span><br><span class="line">    for (j = 0; j &lt; elements; j++) {</span><br><span class="line">        //&#x586B;&#x5145;&#x6570;&#x7EC4;&#xFF0C;&#x8FD9;&#x91CC;&#x6CE8;&#x610F;&#x5143;&#x7D20;&#x662F;&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#xFF0C;&#x6240;&#x4EE5;&#x5404;&#x4E2A;score&#x4E4B;&#x95F4;&#x8981;&#x9694;&#x4E00;&#x4E2A;member</span><br><span class="line">        if (getDoubleFromObjectOrReply(c,c-&gt;argv[scoreidx+j*2],&amp;scores[j],NULL)</span><br><span class="line">            != C_OK) goto cleanup;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    //&#x8FD9;&#x91CC;&#x9996;&#x5148;&#x5728;client&#x5BF9;&#x5E94;&#x7684;db&#x4E2D;&#x67E5;&#x627E;&#x8BE5;key&#xFF0C;&#x5373;&#x6709;&#x5E8F;&#x96C6;</span><br><span class="line">    zobj = lookupKeyWrite(c-&gt;db,key);</span><br><span class="line">    if (zobj == NULL) {</span><br><span class="line">        //&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x6709;&#x5E8F;&#x96C6;&#x4E14;&#x6A21;&#x5F0F;&#x4E3A;XX&#xFF08;&#x53EA;&#x64CD;&#x4F5C;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x5143;&#x7D20;&#xFF09;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">        if (xx) goto reply_to_client; </span><br><span class="line">        //&#x6839;&#x636E;&#x5143;&#x7D20;&#x6570;&#x91CF;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x521D;&#x59CB;&#x5316;&#x6709;&#x5E8F;&#x96C6;</span><br><span class="line">        if (server.zset_max_ziplist_entries == 0 ||</span><br><span class="line">            server.zset_max_ziplist_value &lt; sdslen(c-&gt;argv[scoreidx+1]-&gt;ptr))</span><br><span class="line">        {</span><br><span class="line">            //&#x54C8;&#x5E0C;&#x8868; + &#x8DF3;&#x8868;&#x7684;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;</span><br><span class="line">            zobj = createZsetObject();</span><br><span class="line">        } else {</span><br><span class="line">            //ziplist&#xFF08;&#x538B;&#x7F29;&#x94FE;&#x8868;&#xFF09;&#x6A21;&#x5F0F;</span><br><span class="line">            zobj = createZsetZiplistObject();</span><br><span class="line">        }</span><br><span class="line">        //&#x52A0;&#x5165;db&#x4E2D;</span><br><span class="line">        dbAdd(c-&gt;db,key,zobj);</span><br><span class="line">    } else {</span><br><span class="line">        //&#x5982;&#x679C;ZADD&#x64CD;&#x4F5C;&#x7684;&#x96C6;&#x5408;&#x7C7B;&#x578B;&#x4E0D;&#x5BF9;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;</span><br><span class="line">        if (zobj-&gt;type != OBJ_ZSET) {</span><br><span class="line">            addReply(c,shared.wrongtypeerr);</span><br><span class="line">            goto cleanup;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    //&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x5F80;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x6DFB;&#x52A0;&#x5143;&#x7D20;</span><br><span class="line">    for (j = 0; j &lt; elements; j++) {</span><br><span class="line">        double newscore;</span><br><span class="line">        //&#x53D6;&#x51FA;client&#x4F20;&#x8FC7;&#x6765;&#x7684;score</span><br><span class="line">        score = scores[j];</span><br><span class="line">        int retflags = flags;</span><br><span class="line">        //&#x53D6;&#x51FA;&#x4E0E;&#x4E4B;&#x5BF9;&#x5E94;&#x7684;member</span><br><span class="line">        ele = c-&gt;argv[scoreidx+1+j*2]-&gt;ptr;</span><br><span class="line">        //&#x5411;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x6DFB;&#x52A0;&#x5143;&#x7D20;&#xFF0C;&#x53C2;&#x6570;&#x4F9D;&#x6B21;&#x662F;&#x6709;&#x5E8F;&#x96C6;&#xFF0C;&#x8981;&#x6DFB;&#x52A0;&#x7684;&#x5143;&#x7D20;&#x7684;score&#xFF0C;&#x8981;&#x6DFB;&#x52A0;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x64CD;&#x4F5C;&#x6A21;&#x5F0F;&#xFF0C;&#x65B0;&#x7684;score</span><br><span class="line">        int retval = zsetAdd(zobj, score, ele, &amp;retflags, &amp;newscore);</span><br><span class="line">        //&#x6DFB;&#x52A0;&#x5931;&#x8D25;&#x5219;&#x8FD4;&#x56DE;</span><br><span class="line">        if (retval == 0) {</span><br><span class="line">            addReplyError(c,nanerr);</span><br><span class="line">            goto cleanup;</span><br><span class="line">        }</span><br><span class="line">        //&#x8BB0;&#x5F55;&#x64CD;&#x4F5C;</span><br><span class="line">        if (retflags &amp; ZADD_ADDED) added++;</span><br><span class="line">        if (retflags &amp; ZADD_UPDATED) updated++;</span><br><span class="line">        if (!(retflags &amp; ZADD_NOP)) processed++;</span><br><span class="line">        //&#x8BBE;&#x7F6E;&#x65B0;score&#x503C;</span><br><span class="line">        score = newscore;</span><br><span class="line">    }</span><br><span class="line">    //&#x64CD;&#x4F5C;&#x8BB0;&#x5F55;</span><br><span class="line">    server.dirty += (added+updated);</span><br><span class="line"></span><br><span class="line">//&#x8FD4;&#x56DE;&#x903B;&#x8F91;</span><br><span class="line">reply_to_client:</span><br><span class="line">    if (incr) {</span><br><span class="line">        if (processed)</span><br><span class="line">            addReplyDouble(c,score);</span><br><span class="line">        else</span><br><span class="line">            addReply(c,shared.nullbulk);</span><br><span class="line">    } else {</span><br><span class="line">        addReplyLongLong(c,ch ? added+updated : added);</span><br><span class="line">    }</span><br><span class="line">//&#x6E05;&#x7406;&#x903B;&#x8F91;</span><br><span class="line">cleanup:</span><br><span class="line">    zfree(scores);</span><br><span class="line">    if (added || updated) {</span><br><span class="line">        signalModifiedKey(c-&gt;db,key);</span><br><span class="line">        notifyKeyspaceEvent(NOTIFY_ZSET,</span><br><span class="line">            incr ? &quot;zincr&quot; : &quot;zadd&quot;, key, c-&gt;db-&gt;id);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x7801;&#x6709;&#x70B9;&#x957F;&#xFF0C;&#x6765;&#x5F20;&#x56FE;&#x770B;&#x4E00;&#x4E0B;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#xFF1A;  </p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/e47d0cc3bc38617571beb1cfc1b09f9dde482b68120a9250d8a87f310c00c046" alt="&#x6709;&#x5E8F;&#x96C6;&#x5B58;&#x50A8;&#x7ED3;&#x6784;"></p>
<p>&#x6709;&#x5E8F;&#x96C6;&#x5B58;&#x50A8;&#x7ED3;&#x6784;</p>
<p><strong>&#x6CE8;&#xFF1A;&#x6BCF;&#x4E2A;entry&#x90FD;&#x662F;&#x7531;score+member&#x7EC4;&#x6210;</strong><br>&#x6709;&#x4E86;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x56FE;&#x4EE5;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x60F3;&#x5230;&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#xFF0C;&#x5982;&#x679C;&#x662F;ziplist&#x5C31;&#x6267;&#x884C;&#x94FE;&#x8868;&#x5220;&#x9664;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x54C8;&#x5E0C;&#x8868;+&#x8DF3;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x90A3;&#x5C31;&#x8981;&#x628A;&#x4E24;&#x4E2A;&#x96C6;&#x5408;&#x90FD;&#x8FDB;&#x884C;&#x5220;&#x9664;&#x3002;&#x771F;&#x5B9E;&#x903B;&#x8F91;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;<br>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5220;&#x9664;&#x51FD;&#x6570;zremCommand&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x76F8;&#x5BF9;&#x77ED;&#x4E00;&#x70B9;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;void zremCommand(client *c) {</span><br><span class="line">    //&#x83B7;&#x53D6;&#x6709;&#x5E8F;&#x96C6;&#x540D;</span><br><span class="line">    robj *key = c-&gt;argv[1];</span><br><span class="line">    robj *zobj;</span><br><span class="line">    int deleted = 0, keyremoved = 0, j;</span><br><span class="line">    //&#x505A;&#x6821;&#x9A8C;</span><br><span class="line">    if ((zobj = lookupKeyWriteOrReply(c,key,shared.czero)) == NULL ||</span><br><span class="line">        checkType(c,zobj,OBJ_ZSET)) return;</span><br><span class="line"></span><br><span class="line">    for (j = 2; j &lt; c-&gt;argc; j++) {</span><br><span class="line">        //&#x4E00;&#x6B21;&#x5220;&#x9664;&#x6307;&#x5B9A;&#x5143;&#x7D20;</span><br><span class="line">        if (zsetDel(zobj,c-&gt;argv[j]-&gt;ptr)) deleted++;</span><br><span class="line">        //&#x5982;&#x679C;&#x6709;&#x5E8F;&#x96C6;&#x4E2D;&#x5168;&#x90E8;&#x5143;&#x7D20;&#x90FD;&#x88AB;&#x5220;&#x9664;&#xFF0C;&#x5219;&#x56DE;&#x6536;&#x6709;&#x5E8F;&#x8868;</span><br><span class="line">        if (zsetLength(zobj) == 0) {</span><br><span class="line">            dbDelete(c-&gt;db,key);</span><br><span class="line">            keyremoved = 1;</span><br><span class="line">            break;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    //&#x540C;&#x6B65;&#x64CD;&#x4F5C;</span><br><span class="line">    if (deleted) {</span><br><span class="line">        notifyKeyspaceEvent(NOTIFY_ZSET,&quot;zrem&quot;,key,c-&gt;db-&gt;id);</span><br><span class="line">        if (keyremoved)</span><br><span class="line">            notifyKeyspaceEvent(NOTIFY_GENERIC,&quot;del&quot;,key,c-&gt;db-&gt;id);</span><br><span class="line">        signalModifiedKey(c-&gt;db,key);</span><br><span class="line">        server.dirty += deleted;</span><br><span class="line">    }</span><br><span class="line">    //&#x8FD4;&#x56DE;</span><br><span class="line">    addReplyLongLong(c,deleted);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x770B;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x6E90;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;//&#x53C2;&#x6570;zobj&#x4E3A;&#x6709;&#x5E8F;&#x96C6;&#xFF0C;ele&#x4E3A;&#x8981;&#x5220;&#x9664;&#x7684;&#x5143;&#x7D20;</span><br><span class="line">int zsetDel(robj *zobj, sds ele) {</span><br><span class="line">    //&#x4E0E;&#x6DFB;&#x52A0;&#x5143;&#x7D20;&#x76F8;&#x540C;&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x6267;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x5220;&#x9664;&#x903B;&#x8F91;</span><br><span class="line">    if (zobj-&gt;encoding == OBJ_ENCODING_ZIPLIST) {</span><br><span class="line">        unsigned char *eptr;</span><br><span class="line">        //ziplist&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x94FE;&#x8868;&#x5220;&#x9664;&#x8282;&#x70B9;&#x64CD;&#x4F5C;</span><br><span class="line">        if ((eptr = zzlFind(zobj-&gt;ptr,ele,NULL)) != NULL) {</span><br><span class="line">            zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</span><br><span class="line">            return 1;</span><br><span class="line">        }</span><br><span class="line">    } else if (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) {</span><br><span class="line">        zset *zs = zobj-&gt;ptr;</span><br><span class="line">        dictEntry *de;</span><br><span class="line">        double score;</span><br><span class="line"></span><br><span class="line">        de = dictUnlink(zs-&gt;dict,ele);</span><br><span class="line">        if (de != NULL) {</span><br><span class="line">            //&#x67E5;&#x8BE2;&#x8BE5;&#x5143;&#x7D20;&#x7684;score</span><br><span class="line">            score = *(double*)dictGetVal(de);</span><br><span class="line">            //&#x4ECE;&#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#x5220;&#x9664;&#x5143;&#x7D20;</span><br><span class="line">            dictFreeUnlinkedEntry(zs-&gt;dict,de);</span><br><span class="line"></span><br><span class="line">            //&#x4ECE;&#x8DF3;&#x8868;&#x4E2D;&#x5220;&#x9664;&#x5143;&#x7D20;</span><br><span class="line">            int retval = zslDelete(zs-&gt;zsl,score,ele,NULL);</span><br><span class="line">            serverAssert(retval);</span><br><span class="line">            //&#x5982;&#x679C;&#x6709;&#x9700;&#x8981;&#x5219;&#x5BF9;&#x54C8;&#x5E0C;&#x8868;&#x8FDB;&#x884C;resize&#x64CD;&#x4F5C;</span><br><span class="line">            if (htNeedsResize(zs-&gt;dict)) dictResize(zs-&gt;dict);</span><br><span class="line">            return 1;</span><br><span class="line">        }</span><br><span class="line">    } else {</span><br><span class="line">        serverPanic(&quot;Unknown sorted set encoding&quot;);</span><br><span class="line">    }</span><br><span class="line">    //&#x6CA1;&#x6709;&#x627E;&#x5230;&#x6307;&#x5B9A;&#x5143;&#x7D20;&#x8FD4;&#x56DE;0</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6700;&#x540E;&#x770B;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x51FD;&#x6570;zrangeCommand&#x6E90;&#x7801;&#xFF0C;&#x4E5F;&#x662F;&#x5F88;&#x957F;&#xFF0C;&#x6C57;<del>~</del>&#xFF0C;&#x4E0D;&#x8FC7;&#x653E;&#x5FC3;&#xFF0C;&#x6709;&#x4E86;&#x4E0A;&#x9762;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x5927;&#x81F4;&#x4E5F;&#x80FD;&#x731C;&#x5230;&#x67E5;&#x8BE2;&#x903B;&#x8F91;&#x5E94;&#x8BE5;&#x662F;&#x4EC0;&#x4E48;&#x6837;&#x5B50;&#x7684;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;void zrangeCommand(client *c) {</span><br><span class="line">    //&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;0&#x8868;&#x793A;&#x987A;&#x5E8F;&#xFF0C;1&#x8868;&#x793A;&#x5012;&#x5E8F;</span><br><span class="line">    zrangeGenericCommand(c,0);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void zrangeGenericCommand(client *c, int reverse) {</span><br><span class="line">    //&#x6709;&#x5E8F;&#x96C6;&#x540D;</span><br><span class="line">    robj *key = c-&gt;argv[1];</span><br><span class="line">    robj *zobj;</span><br><span class="line">    int withscores = 0;</span><br><span class="line">    long start;</span><br><span class="line">    long end;</span><br><span class="line">    int llen;</span><br><span class="line">    int rangelen;</span><br><span class="line">    //&#x53C2;&#x6570;&#x6821;&#x9A8C;</span><br><span class="line">    if ((getLongFromObjectOrReply(c, c-&gt;argv[2], &amp;start, NULL) != C_OK) ||</span><br><span class="line">        (getLongFromObjectOrReply(c, c-&gt;argv[3], &amp;end, NULL) != C_OK)) return;</span><br><span class="line"></span><br><span class="line">    //&#x6839;&#x636E;&#x53C2;&#x6570;&#x9644;&#x52A0;&#x4FE1;&#x606F;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8FD4;&#x56DE;score</span><br><span class="line">    if (c-&gt;argc == 5 &amp;&amp; !strcasecmp(c-&gt;argv[4]-&gt;ptr,&quot;withscores&quot;)) {</span><br><span class="line">        withscores = 1;</span><br><span class="line">    } else if (c-&gt;argc &gt;= 5) {</span><br><span class="line">        addReply(c,shared.syntaxerr);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    //&#x6709;&#x5E8F;&#x96C6;&#x6821;&#x9A8C;</span><br><span class="line">    if ((zobj = lookupKeyReadOrReply(c,key,shared.emptymultibulk)) == NULL</span><br><span class="line">         || checkType(c,zobj,OBJ_ZSET)) return;</span><br><span class="line"></span><br><span class="line">    //&#x7D22;&#x5F15;&#x503C;&#x91CD;&#x7F6E;</span><br><span class="line">    llen = zsetLength(zobj);</span><br><span class="line">    if (start &lt; 0) start = llen+start;</span><br><span class="line">    if (end &lt; 0) end = llen+end;</span><br><span class="line">    if (start &lt; 0) start = 0;</span><br><span class="line">     //&#x8FD4;&#x56DE;&#x7A7A;&#x96C6;</span><br><span class="line">    if (start &gt; end || start &gt;= llen) {</span><br><span class="line">        addReply(c,shared.emptymultibulk);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    if (end &gt;= llen) end = llen-1;</span><br><span class="line">    rangelen = (end-start)+1;</span><br><span class="line"></span><br><span class="line">    //&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7ED3;&#x679C;&#x957F;&#x5EA6;</span><br><span class="line">    addReplyMultiBulkLen(c, withscores ? (rangelen*2) : rangelen);</span><br><span class="line">    //&#x540C;&#x6837;&#x662F;&#x6839;&#x636E;&#x6709;&#x5E8F;&#x96C6;&#x7684;&#x4E0D;&#x540C;&#x7ED3;&#x6784;&#x6267;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x67E5;&#x8BE2;&#x903B;&#x8F91;</span><br><span class="line">    if (zobj-&gt;encoding == OBJ_ENCODING_ZIPLIST) {</span><br><span class="line">        unsigned char *zl = zobj-&gt;ptr;</span><br><span class="line">        unsigned char *eptr, *sptr;</span><br><span class="line">        unsigned char *vstr;</span><br><span class="line">        unsigned int vlen;</span><br><span class="line">        long long vlong;</span><br><span class="line">        //&#x6839;&#x636E;&#x6B63;&#x5E8F;&#x8FD8;&#x662F;&#x5012;&#x5E8F;&#x8BA1;&#x7B97;&#x8D77;&#x59CB;&#x7D22;&#x5F15;</span><br><span class="line">        if (reverse)</span><br><span class="line">            eptr = ziplistIndex(zl,-2-(2*start));</span><br><span class="line">        else</span><br><span class="line">            eptr = ziplistIndex(zl,2*start);</span><br><span class="line"></span><br><span class="line">        serverAssertWithInfo(c,zobj,eptr != NULL);</span><br><span class="line">        sptr = ziplistNext(zl,eptr);</span><br><span class="line"></span><br><span class="line">        while (rangelen--) {</span><br><span class="line">            serverAssertWithInfo(c,zobj,eptr != NULL &amp;&amp; sptr != NULL);</span><br><span class="line">            //&#x6CE8;&#x610F;&#x5D4C;&#x5957;&#x7684;ziplistGet&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x628A;eptr&#x7D22;&#x5F15;&#x7684;&#x503C;&#x8BFB;&#x51FA;&#x6765;&#x4FDD;&#x5B58;&#x5728;&#x540E;&#x9762;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x4E2D;</span><br><span class="line">            serverAssertWithInfo(c,zobj,ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vlong));</span><br><span class="line">            //&#x8FD4;&#x56DE;value</span><br><span class="line">            if (vstr == NULL)</span><br><span class="line">                addReplyBulkLongLong(c,vlong);</span><br><span class="line">            else</span><br><span class="line">                addReplyBulkCBuffer(c,vstr,vlen);</span><br><span class="line">            //&#x5982;&#x679C;&#x9700;&#x8981;&#x5219;&#x8FD4;&#x56DE;score</span><br><span class="line">            if (withscores)</span><br><span class="line">                addReplyDouble(c,zzlGetScore(sptr));</span><br><span class="line">            //&#x5012;&#x5E8F;&#x4ECE;&#x540E;&#x5F80;&#x524D;&#xFF0C;&#x6B63;&#x5E8F;&#x4ECE;&#x524D;&#x5F80;&#x540E;</span><br><span class="line">            if (reverse)</span><br><span class="line">                zzlPrev(zl,&amp;eptr,&amp;sptr);</span><br><span class="line">            else</span><br><span class="line">                zzlNext(zl,&amp;eptr,&amp;sptr);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    } else if (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) {</span><br><span class="line">        zset *zs = zobj-&gt;ptr;</span><br><span class="line">        zskiplist *zsl = zs-&gt;zsl;</span><br><span class="line">        zskiplistNode *ln;</span><br><span class="line">        sds ele;</span><br><span class="line"></span><br><span class="line">        //&#x627E;&#x5230;&#x8D77;&#x59CB;&#x8282;&#x70B9;</span><br><span class="line">        if (reverse) {</span><br><span class="line">            ln = zsl-&gt;tail;</span><br><span class="line">            if (start &gt; 0)</span><br><span class="line">                ln = zslGetElementByRank(zsl,llen-start);</span><br><span class="line">        } else {</span><br><span class="line">            ln = zsl-&gt;header-&gt;level[0].forward;</span><br><span class="line">            if (start &gt; 0)</span><br><span class="line">                ln = zslGetElementByRank(zsl,start+1);</span><br><span class="line">        }</span><br><span class="line">         //&#x904D;&#x5386;&#x5E76;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;</span><br><span class="line">        while(rangelen--) {</span><br><span class="line">            serverAssertWithInfo(c,zobj,ln != NULL);</span><br><span class="line">            ele = ln-&gt;ele;</span><br><span class="line">            addReplyBulkCBuffer(c,ele,sdslen(ele));</span><br><span class="line">            if (withscores)</span><br><span class="line">                addReplyDouble(c,ln-&gt;score);</span><br><span class="line">            ln = reverse ? ln-&gt;backward : ln-&gt;level[0].forward;</span><br><span class="line">        }</span><br><span class="line">    } else {</span><br><span class="line">        serverPanic(&quot;Unknown sorted set encoding&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x5C31;&#x662F;&#x5173;&#x4E8E;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x7684;&#x6DFB;&#x52A0;&#xFF0C;&#x5220;&#x9664;&#xFF0C;&#x67E5;&#x627E;&#x7684;&#x6E90;&#x7801;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x51FA;SortedSet&#x4F1A;&#x6839;&#x636E;&#x5B58;&#x653E;&#x5143;&#x7D20;&#x7684;&#x6570;&#x91CF;&#x9009;&#x62E9;ziplist&#x6216;&#x8005;&#x54C8;&#x5E0C;&#x8868;+&#x8DF3;&#x8868;&#x4E24;&#x79CD;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#x5B9E;&#x73B0;&#xFF0C;&#x4E4B;&#x6240;&#x4EE5;&#x6E90;&#x7801;&#x770B;&#x4E0A;&#x53BB;&#x5F88;&#x957F;&#xFF0C;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x4E5F;&#x5C31;&#x662F;&#x8981;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x3002;&#x53EA;&#x8981;&#x638C;&#x63E1;&#x4E86;&#x8FD9;&#x4E2A;&#x6838;&#x5FC3;&#x601D;&#x8DEF;&#xFF0C;&#x518D;&#x770B;&#x6E90;&#x7801;&#x5C31;&#x4E0D;&#x4F1A;&#x592A;&#x96BE;&#x3002;</p>
<h3 id="&#x4E09;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x603B;&#x7ED3;"><a href="#&#x4E09;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x603B;&#x7ED3;" class="headerlink" title="&#x4E09;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x603B;&#x7ED3;"></a>&#x4E09;&#x3001;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x547D;&#x4EE4;&#x603B;&#x7ED3;</h3><p>&#x6709;&#x5E8F;&#x96C6;&#x7684;&#x903B;&#x8F91;&#x4E0D;&#x96BE;&#xFF0C;&#x5C31;&#x662F;&#x4EE3;&#x7801;&#x6709;&#x70B9;&#x957F;&#xFF0C;&#x6D89;&#x53CA;&#x5230;ziplist&#xFF0C;skiplist&#xFF0C;dict&#x4E09;&#x5957;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x4E2D;&#x9664;&#x4E86;&#x5E38;&#x89C4;&#x7684;dict&#x4E4B;&#x5916;&#xFF0C;&#x53E6;&#x5916;&#x4E24;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5185;&#x5BB9;&#x90FD;&#x4E0D;&#x5C11;&#xFF0C;&#x51C6;&#x5907;&#x4E13;&#x95E8;&#x5199;&#x6587;&#x7AE0;&#x8FDB;&#x884C;&#x603B;&#x7ED3;&#xFF0C;&#x5C31;&#x4E0D;&#x5728;&#x8FD9;&#x91CC;&#x8D58;&#x8FF0;&#x4E86;&#x3002;&#x672C;&#x6587;&#x4E3B;&#x8981;&#x76EE;&#x7684;&#x662F;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x6709;&#x5E8F;&#x96C6;SortedSet&#x7684;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/9dd82fedd54b6388013c9c6f3107429a.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512455774216.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512455774216.html" itemprop="url">Unix Web服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T11:58:50+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>Web&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4EA4;&#x4E92;&#x7528;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x7684;&#x5E94;&#x7528;&#x7EA7;&#x534F;&#x8BAE; &#x2014;&#x2014; HTTP(Hypertext Transfer Protocol)&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E00;&#x4E2A;&#x5178;&#x578B;&#x4EA4;&#x4E92;&#x8FC7;&#x7A0B;&#x4E3A;&#xFF1A;&#x4E00;&#x4E2A;Web&#x5BA2;&#x6237;&#x7AEF;(&#x5373;&#x6D4F;&#x89C8;&#x5668;)&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7684;&#x56E0;&#x7279;&#x7F51;&#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x4E14;&#x8BF7;&#x6C42;&#x67D0;&#x4E9B;&#x5185;&#x5BB9;&#xFF1B;&#x670D;&#x52A1;&#x5668;&#x54CD;&#x5E94;&#x6240;&#x8BF7;&#x6C42;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF1B;&#x6D4F;&#x89C8;&#x5668;&#x8BFB;&#x53D6;&#x8FD9;&#x4E9B;&#x5185;&#x5BB9;&#xFF0C;&#x5E76;&#x628A;&#x5B83;&#x663E;&#x793A;&#x5728;&#x5C4F;&#x5E55;&#x4E0A;&#x3002;</p>
<p>Web&#x4E0E;&#x5E38;&#x89C4;&#x7684;&#x6587;&#x4EF6;&#x68C0;&#x7D22;&#x670D;&#x52A1;(&#x5982;FTP)&#x7684;&#x4E3B;&#x8981;&#x533A;&#x522B;&#x662F;: Web&#x5185;&#x5BB9;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;HTML(Hypertext Markup Language)&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x63D0;&#x4F9B;&#x683C;&#x5F0F;&#x548C;&#x5E03;&#x5C40;&#x7684;&#x63A7;&#x5236;&#xFF0C;&#x5E76;&#x4E14;&#x5305;&#x542B;&#x8D85;&#x94FE;&#x63A5;&#x3002;</p>
<h3 id="Web&#x5185;&#x5BB9;"><a href="#Web&#x5185;&#x5BB9;" class="headerlink" title="Web&#x5185;&#x5BB9;"></a>Web&#x5185;&#x5BB9;</h3><p>&#x5BF9;&#x4E8E;Web&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x800C;&#x8A00;&#xFF0C;&#x5185;&#x5BB9;&#x662F;&#x4E0E;&#x4E00;&#x4E2A;MIME(Multipurpose Internet Mail Extensions)&#x7C7B;&#x578B;&#x76F8;&#x5173;&#x7684;&#x5B57;&#x8282;&#x5E8F;&#x5217;&#x3002;</p>
<p>Web&#x670D;&#x52A1;&#x5668;&#x4EE5;&#x4E24;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x5F0F;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x63D0;&#x4F9B;&#x5185;&#x5BB9;:</p>
<ol>
<li>&#x53D6;&#x4E00;&#x4E2A;&#x78C1;&#x76D8;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x7684;&#x5185;&#x5BB9;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
<li>&#x8FD0;&#x884C;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x7684;&#x8F93;&#x51FA;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
</ol>
<p>&#x6BCF;&#x6761;&#x7531;Web&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7684;&#x5185;&#x5BB9;&#x90FD;&#x662F;&#x548C;&#x5B83;&#x7BA1;&#x7406;&#x7684;&#x7684;&#x67D0;&#x4E2A;&#x6587;&#x4EF6;&#x76F8;&#x5173;&#x8054;&#x7684;&#x3002;&#x8FD9;&#x4E9B;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x90FD;&#x6709;&#x552F;&#x4E00;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x53EB;&#x505A;URL(Universal Resource Locator)&#x3002;&#x4F8B;&#x5982;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;http://www.google.com:80/index.html</span><br></pre></td></tr></table></figure>

<p>&#x6807;&#x8BC6;&#x56E0;&#x7279;&#x7F51;&#x4E3B;&#x673A;<a href="/external_links/217ea0eddb56326ed6f492a502629060.html" target="blank" rel="noopener">www.google.com&#x4E0A;&#x4E00;&#x4E2A;&#x79F0;&#x4E3A;/index.html&#x7684;HTML&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x662F;&#x7531;&#x4E00;&#x4E2A;&#x76D1;&#x542C;&#x7AEF;&#x53E3;80&#x7684;Web&#x670D;&#x52A1;&#x5668;&#x7BA1;&#x7406;&#x7684;&#x3002;</a></p>
<p>&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;URL&#x53EF;&#x4EE5;&#x5728;&#x6587;&#x4EF6;&#x540D;&#x540E;&#x5305;&#x62EC;&#x7A0B;&#x5E8F;&#x53C2;&#x6570;&#x3002;<code>?</code>&#x5206;&#x9694;&#x6587;&#x4EF6;&#x540D;&#x548C;&#x53C2;&#x6570;&#xFF0C;&#x800C;&#x4E14;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x90FD;&#x7528;<code>&amp;</code>&#x5206;&#x9694;&#x5F00;&#x3002;&#x4F8B;&#x5982;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;http://example.com:80/cig-bin/adder?123&amp;345</span><br></pre></td></tr></table></figure>

<p>&#x6807;&#x8BC6;&#x4E86;&#x4E00;&#x4E2A;&#x53EB;&#x505A;/cig-bin/adder&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x4F1A;&#x5E26;&#x4E24;&#x4E2A;&#x53C2;&#x6570;123&#x548C;345&#x6765;&#x8C03;&#x7528;&#x5B83;&#x3002;&#x5728;&#x4E8B;&#x52A1;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x7684;URL&#x7684;&#x4E0D;&#x540C;&#x90E8;&#x5206;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x524D;&#x7F00;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;http://www.google.com:80</span><br></pre></td></tr></table></figure>

<p>&#x6765;&#x51B3;&#x5B9A;&#x4E0E;&#x54EA;&#x7C7B;&#x670D;&#x52A1;&#x5668;&#x8054;&#x7CFB;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5728;&#x54EA;&#xFF0C;&#x4EE5;&#x53CA;&#x5B83;&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x662F;&#x591A;&#x5C11;&#x3002;&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x540E;&#x7F00;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;/index.html</span><br></pre></td></tr></table></figure>

<p>&#x6765;&#x53D1;&#x73B0;&#x5728;&#x5B83;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x786E;&#x5B9A;&#x8BF7;&#x6C42;&#x7684;&#x662F;&#x52A8;&#x6001;&#x5185;&#x5BB9;&#x8FD8;&#x662F;&#x9759;&#x6001;&#x5185;&#x5BB9;&#x3002;</p>
<h3 id="HTTP&#x4E8B;&#x52A1;"><a href="#HTTP&#x4E8B;&#x52A1;" class="headerlink" title="HTTP&#x4E8B;&#x52A1;"></a>HTTP&#x4E8B;&#x52A1;</h3><p>HTTP&#x4E8B;&#x52A1;&#x662F;&#x6307;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;HTTP&#x8BF7;&#x6C42;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;HTTP&#x54CD;&#x5E94;&#xFF0C;&#x7136;&#x540E;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;</p>
<h4 id="1-HTTP&#x8BF7;&#x6C42;"><a href="#1-HTTP&#x8BF7;&#x6C42;" class="headerlink" title="1.HTTP&#x8BF7;&#x6C42;"></a>1.HTTP&#x8BF7;&#x6C42;</h4><p>HTTP&#x8BF7;&#x6C42;&#x7684;&#x7EC4;&#x6210;:</p>
<ol>
<li>&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x884C;(request line)</li>
<li>(&#x7D27;&#x8DDF;&#x7740;)&#x96F6;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x8BF7;&#x6C42;&#x62A5;&#x5934;(request header)</li>
<li>(&#x6700;&#x540E;&#x4EE5;)&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x6587;&#x672C;&#x884C;&#x6765;&#x7EC8;&#x6B62;&#x62A5;&#x5934;&#x5217;&#x8868;</li>
<li>(POST&#x65B9;&#x6CD5;&#x53EF;&#x80FD;&#x4F1A;&#x5728;&#x8FD9;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x4E3B;&#x4F53;)</li>
</ol>
<p>&#x6BCF;&#x4E2A;&#x6587;&#x672C;&#x884C;&#x90FD;&#x7531;&#x4E00;&#x5BF9;&#x56DE;&#x8F66;&#x548C;&#x6362;&#x884C;&#x7B26;&#x7ED3;&#x675F;<code>\r\n</code></p>
<p>&#x8BF7;&#x6C42;&#x884C;&#x7684;&#x5F62;&#x5F0F;&#x662F;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;method&gt; &lt;uri&gt; &lt;version&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;method&gt;</code>&#x662F;HTTP&#x652F;&#x6301;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x62EC;GET&#x3001;POST&#x3001;OPTIONS&#x3001;HEAD&#x3001;PUT&#x3001;DELETE&#x548C;TRACE&#x3002;&#x5E94;&#x7528;&#x6700;&#x591A;&#x7684;GET&#x65B9;&#x6CD5;&#x6307;&#x5BFC;&#x670D;&#x52A1;&#x5668;&#x751F;&#x6210;&#x548C;&#x8FD4;&#x56DE;<code>&lt;URI&gt;</code>(Uniform Resource Identifier)&#x6807;&#x8BC6;&#x7684;&#x5185;&#x5BB9;&#x3002;POST&#x65B9;&#x6CD5;&#x7ECF;&#x5E38;&#x7528;&#x4E8E;&#x63D0;&#x4EA4;&#x8868;&#x5355;&#x3002;HEAD&#x65B9;&#x6CD5;&#x7C7B;&#x4F3C;&#x4E0E;GET&#x65B9;&#x6CD5;&#xFF0C;&#x5F53;&#x670D;&#x52A1;&#x5668;&#x63A5;&#x53D7;&#x5230;HEAD&#x65B9;&#x6CD5;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x5C06;&#x4F1A;&#x7528;&#x4E00;&#x4E2A;HTTP&#x62A5;&#x6587;&#x8FDB;&#x884C;&#x54CD;&#x5E94;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x8FD4;&#x56DE;&#x8BF7;&#x6C42;&#x4E3B;&#x4F53;&#x3002;PUT&#x65B9;&#x6CD5;&#x5E38;&#x4E0E;Web&#x53D1;&#x884C;&#x5DE5;&#x5177;&#x8054;&#x5408;&#x4F7F;&#x7528;&#xFF0C;&#x7528;&#x6237;&#x4F7F;&#x7528;&#x5B83;&#x4E0A;&#x4F20;&#x5BF9;&#x8C61;&#x5230;&#x6307;&#x5B9A;&#x7684;Web&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x6307;&#x5B9A;&#x8DEF;&#x5F84;&#x3002;DELETE&#x65B9;&#x6CD5;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x5220;&#x9664;Web&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p><code>&lt;uri&gt;</code>&#x662F;&#x76F8;&#x5E94;URL&#x7684;&#x540E;&#x7F00;&#xFF0C;&#x5305;&#x62EC;&#x6587;&#x4EF6;&#x540D;&#x548C;&#x53EF;&#x9009;&#x7684;&#x53C2;&#x6570;&#x3002;</p>
<p><code>&lt;version&gt;</code>&#x8868;&#x660E;&#x4E86;&#x8BE5;&#x8BF7;&#x6C42;&#x9075;&#x5FAA;&#x7684;HTTP&#x7248;&#x672C;&#x3002;</p>
<p>&#x8BF7;&#x6C42;&#x62A5;&#x5934;&#x4E3A;&#x670D;&#x52A1;&#x5668;&#x63D0;&#x4F9B;&#x4E86;&#x989D;&#x5916;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4F8B;&#x5982;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5546;&#x6807;&#x540D;&#xFF0C;&#x6216;&#x8005;&#x6D4F;&#x89C8;&#x5668;&#x7406;&#x89E3;&#x7684;MIME&#x7C7B;&#x578B;&#x3002;&#x8BF7;&#x6C42;&#x62A5;&#x5934;&#x7684;&#x683C;&#x5F0F;&#x4E3A;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;header name&gt;: &lt;header data&gt;</span><br></pre></td></tr></table></figure>

<p>&#x9488;&#x5BF9;HTTP/1.1&#x8BF7;&#x6C42;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;HOST&#x62A5;&#x5934;&#xFF0C;&#x5982;<code>Host: www.google.com</code>&#xFF0C;&#x5B83;&#x7684;&#x6570;&#x636E;&#x6307;&#x793A;&#x4E86;&#x539F;&#x59CB;&#x670D;&#x52A1;&#x5668;&#x7684;&#x57DF;&#x540D;&#x3002;</p>
<h4 id="2-HTTP&#x54CD;&#x5E94;"><a href="#2-HTTP&#x54CD;&#x5E94;" class="headerlink" title="2.HTTP&#x54CD;&#x5E94;"></a>2.HTTP&#x54CD;&#x5E94;</h4><p>HTTP&#x54CD;&#x5E94;&#x7684;&#x7EC4;&#x6210;:</p>
<ol>
<li>&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x884C;(response line)</li>
<li>(&#x7D27;&#x8DDF;&#x7740;)&#x96F6;&#x4E2A;&#x6216;&#x66F4;&#x591A;&#x7684;&#x54CD;&#x5E94;&#x62A5;&#x5934;(response header)</li>
<li>(&#x5728;&#x7D27;&#x8DDF;&#x7740;)&#x4E00;&#x4E2A;&#x7EC8;&#x6B62;&#x62A5;&#x5934;&#x7684;&#x7A7A;&#x767D;&#x884C;</li>
<li>(&#x518D;&#x7D27;&#x8DDF;&#x7740;)&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x4E3B;&#x4F53;(response body)</li>
</ol>
<p>&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#x884C;&#x7684;&#x683C;&#x5F0F;&#x662F;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;version&gt; &lt;status code&gt; &lt;status message&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;version&gt;</code>&#x63CF;&#x8FF0;&#x4E86;&#x54CD;&#x5E94;&#x6240;&#x9075;&#x5FAA;&#x7684;HTTP&#x7248;&#x672C;&#x3002;<code>&lt;status code&gt;</code>&#x662F;&#x4E00;&#x4E2A;&#x4E09;&#x4F4D;&#x7684;&#x6B63;&#x6574;&#x6570;&#xFF0C;&#x6307;&#x660E;&#x5BF9;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;&#xFF0C;<code>&lt;status message&gt;</code>&#x7ED9;&#x51FA;&#x4E0E;&#x9519;&#x8BEF;&#x7801;&#x7B49;&#x4EF7;&#x7684;&#x82F1;&#x6587;&#x63CF;&#x8FF0;&#x3002;&#x4EE5;&#x4E0B;&#x662F;&#x4E00;&#x4E9B;&#x5E38;&#x89C1;&#x7684;&#x72B6;&#x6001;&#x7801;:</p>
<table>
<thead>
<tr>
<th>Status Code</th>
<th>Status Message</th>
<th>&#x63CF;&#x8FF0;</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>&#x6210;&#x529F;</td>
<td>&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x65E0;&#x8BEF;</td>
</tr>
<tr>
<td>301</td>
<td>&#x6C38;&#x4E45;&#x79FB;&#x52A8;</td>
<td>&#x5185;&#x5BB9;&#x5DF2;&#x79FB;&#x81F3;&#x7531;&#x54CD;&#x5E94;&#x62A5;&#x5934;Location&#x6307;&#x660E;&#x7684;&#x65B0;URL&#x4E0A;</td>
</tr>
<tr>
<td>400</td>
<td>&#x9519;&#x8BEF;&#x8BF7;&#x6C42;</td>
<td>&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x80FD;&#x7406;&#x89E3;&#x8BF7;&#x6C42;</td>
</tr>
<tr>
<td>403</td>
<td>&#x7981;&#x6B62;</td>
<td>&#x670D;&#x52A1;&#x5668;&#x65E0;&#x6743;&#x8BBF;&#x95EE;&#x8BF7;&#x6C42;&#x7684;&#x6587;&#x4EF6;</td>
</tr>
<tr>
<td>404</td>
<td>&#x672A;&#x53D1;&#x73B0;</td>
<td>&#x670D;&#x52A1;&#x5668;&#x627E;&#x4E0D;&#x5230;&#x6240;&#x8BF7;&#x6C42;&#x7684;&#x6587;&#x4EF6;</td>
</tr>
<tr>
<td>501</td>
<td>&#x672A;&#x5B9E;&#x73B0;</td>
<td>&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x652F;&#x6301;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5;</td>
</tr>
<tr>
<td>505</td>
<td>HTTP&#x7248;&#x672C;&#x4E0D;&#x652F;&#x6301;</td>
<td>&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x652F;&#x6301;&#x8BF7;&#x6C42;&#x7684;&#x7248;&#x672C;</td>
</tr>
</tbody></table>
<p><em>&#x72B6;&#x6001;&#x7801;&#x5206;&#x7C7B;&#xFF1A;1xx&#x6D88;&#x606F;&#xFF0C;2xx&#x6210;&#x529F;&#xFF0C;3xx&#x91CD;&#x5B9A;&#x5411;&#xFF0C;4xx&#x5BA2;&#x6237;&#x7AEF;&#x9519;&#x8BEF;&#xFF0C;5xx&#x670D;&#x52A1;&#x5668;&#x9519;&#x8BEF;</em></p>
<p>&#x54CD;&#x5E94;&#x62A5;&#x5934;&#x63D0;&#x4F9B;&#x4E86;&#x5173;&#x4E8E;&#x54CD;&#x5E94;&#x7684;&#x9644;&#x52A0;&#x4FE1;&#x606F;&#x3002;&#x6BD4;&#x5982;<code>Content-Type</code>&#x544A;&#x8BC9;&#x5BA2;&#x6237;&#x7AEF;&#x54CD;&#x5E94;&#x4E3B;&#x4F53;&#x4E2D;&#x5185;&#x5BB9;&#x7684;MIME&#x7C7B;&#x578B;&#xFF1B;<code>Content-Length</code>&#x6307;&#x793A;&#x54CD;&#x5E94;&#x4E3B;&#x4F53;&#x7684;&#x5927;&#x5C0F;&#x3002;</p>
<p>&#x7EC8;&#x6B62;&#x54CD;&#x5E94;&#x62A5;&#x5934;&#x7684;&#x7A7A;&#x6587;&#x672C;&#x884C;&#x4E4B;&#x540E;&#xFF0C;&#x8DDF;&#x968F;&#x7684;&#x662F;&#x54CD;&#x5E94;&#x4E3B;&#x4F53;&#xFF0C;&#x54CD;&#x5E94;&#x4E3B;&#x4F53;&#x4E2D;&#x5305;&#x542B;&#x7740;&#x88AB;&#x8BF7;&#x6C42;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<h3 id="&#x670D;&#x52A1;&#x52A8;&#x6001;&#x5185;&#x5BB9;"><a href="#&#x670D;&#x52A1;&#x52A8;&#x6001;&#x5185;&#x5BB9;" class="headerlink" title="&#x670D;&#x52A1;&#x52A8;&#x6001;&#x5185;&#x5BB9;"></a>&#x670D;&#x52A1;&#x52A8;&#x6001;&#x5185;&#x5BB9;</h3><p>CGI(Common Gateway Interface)&#x7684;&#x5B9E;&#x9645;&#x6807;&#x51C6;&#x7528;&#x6765;&#x89E3;&#x51B3;&#x5982;&#x4E0B;&#x95EE;&#x9898;:</p>
<ol>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x5982;&#x4F55;&#x5C06;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;&#x670D;&#x52A1;&#x5668;</li>
</ol>
<p>Get&#x8BF7;&#x6C42;&#x7684;&#x53C2;&#x6570;&#x5728;URL&#x4E2D;&#x4F20;&#x9012;&#x3002;&#x4E00;&#x4E2A;<code>?</code>&#x5206;&#x5272;&#x6587;&#x4EF6;&#x540D;&#x548C;&#x53C2;&#x6570;&#xFF0C;&#x800C;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x90FD;&#x7528;&#x4E00;&#x4E2A;<code>&amp;</code>&#x5B57;&#x7B26;&#x9694;&#x5F00;&#x3002;&#x53C2;&#x6570;&#x4E2D;&#x4E0D;&#x5141;&#x8BB8;&#x6709;&#x7A7A;&#x683C;&#xFF0C;&#x800C;&#x5FC5;&#x987B;&#x7528;&#x5B57;&#x7B26;&#x4E32;<code>%20</code>&#x6765;&#x8868;&#x793A;&#xFF0C;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x7279;&#x6B8A;&#x5B57;&#x7B26;&#xFF0C;&#x4E5F;&#x5B58;&#x5728;&#x7740;&#x76F8;&#x4F3C;&#x7684;&#x7F16;&#x7801;&#x3002;POST&#x8BF7;&#x6C42;&#x7684;&#x53C2;&#x6570;&#x662F;&#x5728;&#x8BF7;&#x6C42;&#x4E3B;&#x4F53;&#x4E2D;&#x800C;&#x4E0D;&#x662F;&#x5728;URI&#x4E2D;&#x4F20;&#x9012;&#x7684;&#x3002;<br>2. &#x670D;&#x52A1;&#x5668;&#x5982;&#x4F55;&#x5C06;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;&#x5B50;&#x8FDB;&#x7A0B;</p>
<p>&#x5728;&#x670D;&#x52A1;&#x5668;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x4E2A;&#x5982;&#x4E0B;&#x7684;&#x8BF7;&#x6C42;&#x540E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801; GET /cgi-bin/adder?123&amp;345 HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>&#x5B83;&#x8C03;&#x7528;<code>fork</code>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x8C03;&#x7528;<code>execve</code>&#x5728;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6267;&#x884C;<code>/cgi-bin/adder</code>&#x7A0B;&#x5E8F;&#x3002;&#x50CF;<code>adder</code>&#x8FD9;&#x6837;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x5E38;&#x5E38;&#x88AB;&#x79F0;&#x4E3A;CGI&#x7A0B;&#x5E8F;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x9075;&#x5B88;CGI&#x6807;&#x51C6;&#x3002;&#x5728;&#x8C03;&#x7528;<code>execve</code>&#x4E4B;&#x524D;&#xFF0C;&#x5B50;&#x8FDB;&#x7A0B;&#x5C06;CGI&#x73AF;&#x5883;&#x53D8;&#x91CF;<code>QUERY_STRING</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>123&amp;345</code>&#xFF0C;<code>adder</code>&#x7A0B;&#x5E8F;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Unix<br> <code>getenv</code>&#x51FD;&#x6570;&#x6765;&#x5F15;&#x7528;&#x5B83;&#x3002;<br>3. &#x670D;&#x52A1;&#x5668;&#x5982;&#x4F55;&#x5C06;&#x5176;&#x4ED6;&#x4FE1;&#x606F;&#x4F20;&#x9012;&#x7ED9;&#x5B50;&#x8FDB;&#x7A0B;</p>
<p>CGI&#x5B9A;&#x4E49;&#x4E86;&#x5927;&#x91CF;&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x4E00;&#x4E2A;CGI&#x7A0B;&#x5E8F;&#x5728;&#x5B83;&#x8FD0;&#x884C;&#x65F6;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E9B;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3002;</p>
<table>
<thead>
<tr>
<th>&#x73AF;&#x5883;&#x53D8;&#x91CF;</th>
<th>&#x63CF;&#x8FF0;</th>
</tr>
</thead>
<tbody><tr>
<td>QUERY_STRING</td>
<td>&#x7A0B;&#x5E8F;&#x53C2;&#x6570;</td>
</tr>
<tr>
<td>SERVER_PORT</td>
<td>&#x7236;&#x8FDB;&#x7A0B;&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;</td>
</tr>
<tr>
<td>REQUEST_METHOD</td>
<td>GET&#x6216;POST</td>
</tr>
<tr>
<td>REMOTE_HOST</td>
<td>&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x57DF;&#x540D;</td>
</tr>
<tr>
<td>REMOTE_ADDR</td>
<td>&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x70B9;&#x5206;&#x5341;&#x8FDB;&#x5236;IP&#x5730;&#x5740;</td>
</tr>
<tr>
<td>CONTENT_TYPE</td>
<td>&#x53EA;&#x5BF9;POST&#x800C;&#x8A00;: &#x8BF7;&#x6C42;&#x4F53;&#x7684;MIME&#x7C7B;&#x578B;</td>
</tr>
<tr>
<td>CONTEMT_LENGTH</td>
<td>&#x53EA;&#x5BF9;POST&#x800C;&#x8A00;: &#x8BF7;&#x6C42;&#x4F53;&#x7684;&#x5B57;&#x8282;&#x5927;&#x5C0F;</td>
</tr>
<tr>
<td>4. &#x5B50;&#x8FDB;&#x7A0B;&#x5C06;&#x5B83;&#x7684;&#x8F93;&#x51FA;&#x53D1;&#x9001;&#x5230;&#x54EA;&#x91CC;</td>
<td></td>
</tr>
</tbody></table>
<p>&#x4E00;&#x4E2A;CGI&#x7A0B;&#x5E8F;&#x5C06;&#x5B83;&#x7684;&#x52A8;&#x6001;&#x5185;&#x5BB9;&#x53D1;&#x9001;&#x5230;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#x3002;&#x5728;&#x5B50;&#x8FDB;&#x7A0B;&#x4E2D;&#x52A0;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;CGI&#x7A0B;&#x5E8F;&#x4E4B;&#x524D;&#xFF0C;&#x5B83;&#x4F7F;&#x7528;Unix <code>dup2</code>&#x51FD;&#x6570;&#x5C06;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x76F8;&#x5173;&#x8054;&#x7684;&#x5DF2;&#x8FDE;&#x63A5;&#x63CF;&#x8FF0;&#x7B26;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x4EFB;&#x4F55;CGI&#x7A0B;&#x5E8F;&#x5199;&#x5230;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#x7684;&#x5185;&#x5BB9;&#x90FD;&#x4F1A;&#x76F4;&#x63A5;&#x5230;&#x8FBE;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x56E0;&#x4E3A;&#x7236;&#x8FDB;&#x7A0B;&#x4E0D;&#x77E5;&#x9053;&#x5B50;&#x8FDB;&#x7A0B;&#x751F;&#x6210;&#x7684;&#x5185;&#x5BB9;&#x7684;&#x7C7B;&#x578B;&#x548C;&#x5927;&#x5C0F;&#xFF0C;&#x6240;&#x4EE5;&#x5B50;&#x8FDB;&#x7A0B;&#x8D1F;&#x8D23;&#x751F;&#x6210;<code>Content-type</code>&#x548C;<code>Content-length</code>&#x54CD;&#x5E94;&#x62A5;&#x5934;&#xFF0C;&#x4EE5;&#x53CA;&#x7EC8;&#x6B62;&#x62A5;&#x5934;&#x7684;&#x7A7A;&#x884C;&#x3002;</p>
<h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>HTTP&#x670D;&#x52A1;&#x5668;&#x662F;&#x65E0;&#x72B6;&#x6001;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x5411;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x4E0D;&#x540C;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x80FD;&#x8BC6;&#x5230;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x6765;&#x81EA;&#x6765;&#x81EA;&#x540C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x3002;</p>
<p>&#x7136;&#x800C;&#x4E00;&#x4E2A;Web&#x7AD9;&#x70B9;&#x901A;&#x5E38;&#x5E0C;&#x671B;&#x80FD;&#x591F;&#x8BC6;&#x522B;&#x7528;&#x6237;&#xFF0C;&#x4E3A;&#x6B64;HTTP&#x4F7F;&#x7528;&#x4E86;cookie&#x3002;cookie&#x7684;&#x5DE5;&#x4F5C;&#x8FC7;&#x7A0B;&#x4E3A;:</p>
<ol>
<li>&#x7528;&#x6237;&#x6D4F;&#x89C8;&#x5668;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x8BF7;&#x6C42;</li>
<li>&#x670D;&#x52A1;&#x5668;&#x63A5;&#x6536;&#x7684;&#x8BF7;&#x6C42;&#x540E;&#xFF0C;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;&#x6807;&#x8BC6;&#x7801;<code>&lt;identification code&gt;</code>&#xFF0C;&#x5E76;&#x4EE5;&#x6B64;&#x4E3A;&#x7D22;&#x5F15;&#x5728;&#x5B83;&#x7684;&#x540E;&#x7AEF;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x8868;&#x9879;</li>
<li>&#x670D;&#x52A1;&#x5668;&#x7528;&#x4E00;&#x4E2A;&#x5305;&#x542B;<code>Set-cookie: &lt;identification code&gt;</code>&#x54CD;&#x5E94;&#x62A5;&#x5934;&#x7684;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x5BF9;&#x7528;&#x6237;&#x6D4F;&#x89C8;&#x5668;&#x8FDB;&#x884C;&#x54CD;&#x5E94;</li>
<li>&#x7528;&#x6237;&#x6D4F;&#x89C8;&#x5668;&#x6536;&#x5230;&#x8BE5;HTTP&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x770B;&#x5230;<code>Set-cookie</code>&#x62A5;&#x5934;&#xFF0C;&#x8BE5;&#x6D4F;&#x89C8;&#x5668;&#x5728;&#x5B83;&#x7BA1;&#x7406;&#x7684;&#x7279;&#x5B9A;cookie&#x6587;&#x4EF6;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x884C;&#xFF0C;&#x6539;&#x884C;&#x5305;&#x542B;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E3B;&#x673A;&#x540D;&#x548C;&#x5728;<code>Set-cookie</code>&#x62A5;&#x5934;&#x4E2D;&#x58F0;&#x660E;&#x7684;<code>&lt;identification code&gt;</code></li>
<li>&#x4E4B;&#x540E;&#x5F53;&#x7528;&#x6237;&#x6D4F;&#x89C8;&#x5668;&#x7EE7;&#x7EED;&#x5411;&#x76F8;&#x540C;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;HTTP&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x90FD;&#x5305;&#x542B;<code>Cookie: &lt;identification code&gt;</code>&#x8BF7;&#x6C42;&#x62A5;&#x5934;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x636E;&#x6B64;&#x8DDF;&#x8E2A;&#x7528;&#x6237;&#xFF0C;&#x4FDD;&#x5B58;&#x7528;&#x6237;&#x72B6;&#x6001;</li>
</ol>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/9dc5f57218e4061b1e561ac43ca223aa.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512459968520.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512459968520.html" itemprop="url">ConcurrentLinkedQueue的实现具体分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T11:58:36+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##&#x5F15;&#x8A00;## &#x5728;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E2D;&#x6211;&#x4EEC;&#x6709;&#x65F6;&#x5019;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#x961F;&#x5217;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8981;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#x961F;&#x5217;&#x6709;&#x4E24;&#x79CD;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x4E00;&#x79CD;&#x662F;&#x4F7F;&#x7528;&#x963B;&#x585E;&#x7B97;&#x6CD5;&#xFF0C;&#x53E6;&#x4E00;&#x79CD;&#x662F;&#x4F7F;&#x7528;&#x975E;&#x963B;&#x585E;&#x7B97;&#x6CD5;&#x3002;&#x4F7F;&#x7528;&#x963B;&#x585E;&#x7B97;&#x6CD5;&#x7684;&#x961F;&#x5217;&#x53EF;&#x4EE5;&#x7528;&#x4E00;&#x4E2A;&#x9501;&#xFF08;&#x5165;&#x961F;&#x548C;&#x51FA;&#x961F;&#x7528;&#x540C;&#x4E00;&#x628A;&#x9501;&#xFF09;&#x6216;&#x4E24;&#x4E2A;&#x9501;&#xFF08;&#x5165;&#x961F;&#x548C;&#x51FA;&#x961F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x9501;&#xFF09;&#x7B49;&#x65B9;&#x5F0F;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x800C;&#x975E;&#x963B;&#x585E;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5FAA;&#x73AF;CAS&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x672C;&#x6587;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x6765;&#x7814;&#x7A76;&#x4E0B;Doug Lea&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x975E;&#x963B;&#x585E;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x961F;&#x5217;ConcurrentLinkedQueue&#x7684;&#xFF0C;&#x76F8;&#x4FE1;&#x4ECE;&#x5927;&#x5E08;&#x8EAB;&#x4E0A;&#x6211;&#x4EEC;&#x80FD;&#x5B66;&#x5230;&#x4E0D;&#x5C11;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x7684;&#x6280;&#x5DE7;&#x3002; ##ConcurrentLinkedQueue&#x7684;&#x4ECB;&#x7ECD;##<br> ConcurrentLinkedQueue&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x94FE;&#x63A5;&#x8282;&#x70B9;&#x7684;&#x65E0;&#x754C;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x961F;&#x5217;&#xFF0C;&#x5B83;&#x91C7;&#x7528;&#x5148;&#x8FDB;&#x5148;&#x51FA;&#x7684;&#x89C4;&#x5219;&#x5BF9;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x4F1A;&#x6DFB;&#x52A0;&#x5230;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x90E8;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x8FD4;&#x56DE;&#x961F;&#x5217;&#x5934;&#x90E8;&#x7684;&#x5143;&#x7D20;&#x3002;&#x5B83;&#x91C7;&#x7528;&#x4E86;&#x201C;wait&#xFF0D;free&#x201D;&#x7B97;&#x6CD5;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x8BE5;&#x7B97;&#x6CD5;&#x5728;Michael &amp; Scott&#x7B97;&#x6CD5;&#x4E0A;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E9B;&#x4FEE;&#x6539;&#x3002; ##ConcurrentLinkedQueue&#x7684;&#x7ED3;&#x6784;## &#x6211;&#x4EEC;&#x901A;&#x8FC7;ConcurrentLinkedQueue&#x7684;&#x7C7B;&#x56FE;&#x6765;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x7ED3;&#x6784;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/52904b78207e3caf52bc41d775ea86ef43317ccacd1791675146117056a92bcb" alt="&#x5728;&#x6B64;&#x8F93;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"> ConcurrentLinkedQueue&#x7531;head&#x8282;&#x70B9;&#x548C;tair&#x8282;&#x70B9;&#x7EC4;&#x6210;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#xFF08;Node&#xFF09;&#x7531;&#x8282;&#x70B9;&#x5143;&#x7D20;&#xFF08;item&#xFF09;&#x548C;&#x6307;&#x5411;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x5F15;&#x7528;(next)&#x7EC4;&#x6210;&#xFF0C;&#x8282;&#x70B9;&#x4E0E;&#x8282;&#x70B9;&#x4E4B;&#x95F4;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;next&#x5173;&#x8054;&#x8D77;&#x6765;&#xFF0C;&#x4ECE;&#x800C;&#x7EC4;&#x6210;&#x4E00;&#x5F20;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x7684;&#x961F;&#x5217;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;head&#x8282;&#x70B9;&#x5B58;&#x50A8;&#x7684;&#x5143;&#x7D20;&#x4E3A;&#x7A7A;&#xFF0C;tair&#x8282;&#x70B9;&#x7B49;&#x4E8E;head&#x8282;&#x70B9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;private transient volatile Node&lt;e&gt; tail = head;</span><br></pre></td></tr></table></figure>

<p>##&#x5165;&#x961F;&#x5217;## <strong>&#x5165;&#x961F;&#x5217;&#x5C31;&#x662F;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x6DFB;&#x52A0;&#x5230;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x90E8;</strong>&#x3002;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7406;&#x89E3;&#x5165;&#x961F;&#x65F6;&#x961F;&#x5217;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x4EE5;&#x53CA;head&#x8282;&#x70B9;&#x548C;tair&#x8282;&#x70B9;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x6BCF;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x6211;&#x5C31;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x7684;&#x5FEB;&#x7167;&#x56FE;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/475f0bdbab8fa620ae7f963a94e9386cd997b884d90ed3962fd4f8b005d0356e" alt="&#x5728;&#x6B64;&#x8F93;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p><strong>&#x7B2C;&#x4E00;&#x6B65;&#x6DFB;&#x52A0;&#x5143;&#x7D20;1</strong>&#xFF1A;&#x961F;&#x5217;&#x66F4;&#x65B0;head&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x5143;&#x7D20;1&#x8282;&#x70B9;&#x3002;&#x53C8;&#x56E0;&#x4E3A;tail&#x8282;&#x70B9;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7B49;&#x4E8E;head&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x4EEC;&#x7684;next&#x8282;&#x70B9;&#x90FD;&#x6307;&#x5411;&#x5143;&#x7D20;1&#x8282;&#x70B9;&#x3002; <strong>&#x7B2C;&#x4E8C;&#x6B65;&#x6DFB;&#x52A0;&#x5143;&#x7D20;2</strong>&#xFF1A;&#x961F;&#x5217;&#x9996;&#x5148;&#x8BBE;&#x7F6E;&#x5143;&#x7D20;1&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x5143;&#x7D20;2&#x8282;&#x70B9;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#x6307;&#x5411;&#x5143;&#x7D20;2&#x8282;&#x70B9;&#x3002; <strong>&#x7B2C;&#x4E09;&#x6B65;&#x6DFB;&#x52A0;&#x5143;&#x7D20;3</strong>&#xFF1A;&#x8BBE;&#x7F6E;tail&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x5143;&#x7D20;3&#x8282;&#x70B9;&#x3002; <strong>&#x7B2C;&#x56DB;&#x6B65;&#x6DFB;&#x52A0;&#x5143;&#x7D20;4</strong>&#xFF1A;&#x8BBE;&#x7F6E;&#x5143;&#x7D20;3&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x5143;&#x7D20;4&#x8282;&#x70B9;&#xFF0C;&#x7136;&#x540E;&#x5C06;tail&#x8282;&#x70B9;&#x6307;&#x5411;&#x5143;&#x7D20;4&#x8282;&#x70B9;&#x3002;</p>
<p>&#x901A;&#x8FC7;debug&#x5165;&#x961F;&#x8FC7;&#x7A0B;&#x5E76;&#x89C2;&#x5BDF;head&#x8282;&#x70B9;&#x548C;tail&#x8282;&#x70B9;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x53D1;&#x73B0;&#x5165;&#x961F;&#x4E3B;&#x8981;&#x505A;&#x4E24;&#x4EF6;&#x4E8B;&#x60C5;&#xFF0C;&#x7B2C;&#x4E00;&#x662F;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;&#x5F53;&#x524D;&#x961F;&#x5217;&#x5C3E;&#x8282;&#x70B9;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x3002;&#x7B2C;&#x4E8C;&#x662F;&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x679C;tail&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;tail&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x679C;tail&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;tail&#x7684;next&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;tail&#x8282;&#x70B9;&#x4E0D;&#x603B;&#x662F;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x7406;&#x89E3;&#x8FD9;&#x4E00;&#x70B9;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x7814;&#x7A76;&#x6E90;&#x7801;&#x4F1A;&#x975E;&#x5E38;&#x6709;&#x5E2E;&#x52A9;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#x8BA9;&#x6211;&#x4EEC;&#x4ECE;&#x5355;&#x7EBF;&#x7A0B;&#x5165;&#x961F;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x7406;&#x89E3;&#x5165;&#x961F;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F46;&#x662F;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x540C;&#x65F6;&#x8FDB;&#x884C;&#x5165;&#x961F;&#x60C5;&#x51B5;&#x5C31;&#x53D8;&#x5F97;&#x66F4;&#x52A0;&#x590D;&#x6742;&#xFF0C;&#x56E0;&#x4E3A;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x63D2;&#x961F;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x5982;&#x679C;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6B63;&#x5728;&#x5165;&#x961F;&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x5FC5;&#x987B;&#x5148;&#x83B7;&#x53D6;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x7136;&#x540E;&#x8BBE;&#x7F6E;&#x5C3E;&#x8282;&#x70B9;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x4E3A;&#x5165;&#x961F;&#x8282;&#x70B9;&#xFF0C;&#x4F46;&#x8FD9;&#x65F6;&#x53EF;&#x80FD;&#x6709;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x63D2;&#x961F;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x8282;&#x70B9;&#x5C31;&#x4F1A;&#x53D1;&#x751F;&#x53D8;&#x5316;&#xFF0C;&#x8FD9;&#x65F6;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x8981;&#x6682;&#x505C;&#x5165;&#x961F;&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0;&#x83B7;&#x53D6;&#x5C3E;&#x8282;&#x70B9;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x901A;&#x8FC7;&#x6E90;&#x7801;&#x6765;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x4E0B;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528;CAS&#x7B97;&#x6CD5;&#x6765;&#x5165;&#x961F;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public boolean offer(E e) {</span><br><span class="line">    if (e == null) throw new NullPointerException();</span><br><span class="line"></span><br><span class="line">    //&#x5165;&#x961F;&#x524D;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5165;&#x961F;&#x8282;&#x70B9;</span><br><span class="line">    Node&lt;E&gt; n = new Node&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    retry:</span><br><span class="line">        //&#x6B7B;&#x5FAA;&#x73AF;&#xFF0C;&#x5165;&#x961F;&#x4E0D;&#x6210;&#x529F;&#x53CD;&#x590D;&#x5165;&#x961F;&#x3002;</span><br><span class="line">        for (;;) {</span><br><span class="line">            //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6307;&#x5411;tail&#x8282;&#x70B9;&#x7684;&#x5F15;&#x7528;</span><br><span class="line">            Node&lt;E&gt; t = tail;</span><br><span class="line">            //p&#x7528;&#x6765;&#x8868;&#x793A;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7B49;&#x4E8E;tail&#x8282;&#x70B9;&#x3002;</span><br><span class="line">            Node&lt;E&gt; p = t;</span><br><span class="line"></span><br><span class="line">            for (int hops = 0; ; hops++) {</span><br><span class="line">                //&#x83B7;&#x5F97;p&#x8282;&#x70B9;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x3002;</span><br><span class="line">                Node&lt;E&gt; next = succ(p);</span><br><span class="line">                //next&#x8282;&#x70B9;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x8BF4;&#x660E;p&#x4E0D;&#x662F;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x9700;&#x8981;&#x66F4;&#x65B0;p&#x540E;&#x5728;&#x5C06;&#x5B83;&#x6307;&#x5411;next&#x8282;&#x70B9;</span><br><span class="line">                if (next != null) {</span><br><span class="line">                    //&#x5FAA;&#x73AF;&#x4E86;&#x4E24;&#x6B21;&#x53CA;&#x5176;&#x4EE5;&#x4E0A;&#xFF0C;&#x5E76;&#x4E14;&#x5F53;&#x524D;&#x8282;&#x70B9;&#x8FD8;&#x662F;&#x4E0D;&#x7B49;&#x4E8E;&#x5C3E;&#x8282;&#x70B9;</span><br><span class="line">                    if (hops &gt; HOPS &amp;&amp; t != tail)</span><br><span class="line">                        continue retry;</span><br><span class="line">                    p = next;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                //&#x5982;&#x679C;p&#x662F;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;p&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4E3A;&#x5165;&#x961F;&#x8282;&#x70B9;&#x3002;</span><br><span class="line">                else if (p.casNext(null, n)) {</span><br><span class="line">                    //&#x5982;&#x679C;tail&#x8282;&#x70B9;&#x6709;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;1&#x4E2A;next&#x8282;&#x70B9;&#xFF0C;&#x5219;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;tair&#x8282;&#x70B9;&#xFF0C;&#x66F4;&#x65B0;&#x5931;&#x8D25;&#x4E86;&#x4E5F;&#x6CA1;&#x5173;&#x7CFB;&#xFF0C;&#x56E0;&#x4E3A;&#x5931;&#x8D25;&#x4E86;&#x8868;&#x793A;&#x6709;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x6210;&#x529F;&#x66F4;&#x65B0;&#x4E86;tair&#x8282;&#x70B9;</span><br><span class="line">                    if (hops &gt;= HOPS)</span><br><span class="line">                        casTail(t, n); // &#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#xFF0C;&#x5141;&#x8BB8;&#x5931;&#x8D25;</span><br><span class="line">                    return true;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                // p&#x6709;next&#x8282;&#x70B9;,&#x8868;&#x793A;p&#x7684;next&#x8282;&#x70B9;&#x662F;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x5219;&#x91CD;&#x65B0;&#x8BBE;&#x7F6E;p&#x8282;&#x70B9;</span><br><span class="line">                else {</span><br><span class="line">                    p = succ(p);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x4ECE;&#x6E90;&#x4EE3;&#x7801;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#x6574;&#x4E2A;&#x5165;&#x961F;&#x8FC7;&#x7A0B;&#x4E3B;&#x8981;&#x505A;&#x4E8C;&#x4EF6;&#x4E8B;&#x60C5;</strong>&#x3002;&#x7B2C;&#x4E00;&#x662F;&#x5B9A;&#x4F4D;&#x51FA;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x7B2C;&#x4E8C;&#x662F;&#x4F7F;&#x7528;CAS&#x7B97;&#x6CD5;&#x80FD;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;&#x5C3E;&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x4E0D;&#x6210;&#x529F;&#x5219;&#x91CD;&#x8BD5;&#x3002;</p>
<p><strong>&#x7B2C;&#x4E00;&#x6B65;&#x5B9A;&#x4F4D;&#x5C3E;&#x8282;&#x70B9;</strong>&#x3002;tail&#x8282;&#x70B9;&#x5E76;&#x4E0D;&#x603B;&#x662F;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x6BCF;&#x6B21;&#x5165;&#x961F;&#x90FD;&#x5FC5;&#x987B;&#x5148;&#x901A;&#x8FC7;tail&#x8282;&#x70B9;&#x6765;&#x627E;&#x5230;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x5C3E;&#x8282;&#x70B9;&#x53EF;&#x80FD;&#x5C31;&#x662F;tail&#x8282;&#x70B9;&#xFF0C;&#x4E5F;&#x53EF;&#x80FD;&#x662F;tail&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x3002;&#x4EE3;&#x7801;&#x4E2D;&#x5FAA;&#x73AF;&#x4F53;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;if&#x5C31;&#x662F;&#x5224;&#x65AD;tail&#x662F;&#x5426;&#x6709;next&#x8282;&#x70B9;&#xFF0C;&#x6709;&#x5219;&#x8868;&#x793A;next&#x8282;&#x70B9;&#x53EF;&#x80FD;&#x662F;&#x5C3E;&#x8282;&#x70B9;&#x3002;&#x83B7;&#x53D6;tail&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;p&#x8282;&#x70B9;&#x7B49;&#x4E8E;p&#x7684;next&#x8282;&#x70B9;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x79CD;&#x53EF;&#x80FD;&#x5C31;&#x662F;p&#x8282;&#x70B9;&#x548C;p&#x7684;next&#x8282;&#x70B9;&#x90FD;&#x7B49;&#x4E8E;&#x7A7A;&#xFF0C;&#x8868;&#x793A;&#x8FD9;&#x4E2A;&#x961F;&#x5217;&#x521A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6B63;&#x51C6;&#x5907;&#x6DFB;&#x52A0;&#x7B2C;&#x4E00;&#x6B21;&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x8FD4;&#x56DE;head&#x8282;&#x70B9;&#x3002;&#x83B7;&#x53D6;p&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;final Node&lt;E&gt; succ(Node&lt;E&gt; p) {</span><br><span class="line">    Node&lt;E&gt; next = p.getNext();</span><br><span class="line">    return (p == next) ? head : next;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x7B2C;&#x4E8C;&#x6B65;&#x8BBE;&#x7F6E;&#x5165;&#x961F;&#x8282;&#x70B9;&#x4E3A;&#x5C3E;&#x8282;&#x70B9;</strong>&#x3002;p.casNext(null, n)&#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x4E3A;&#x5F53;&#x524D;&#x961F;&#x5217;&#x5C3E;&#x8282;&#x70B9;&#x7684;next&#x8282;&#x70B9;&#xFF0C;p&#x5982;&#x679C;&#x662F;null&#x8868;&#x793A;p&#x662F;&#x5F53;&#x524D;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x4E3A;null&#x8868;&#x793A;&#x6709;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x66F4;&#x65B0;&#x4E86;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x8282;&#x70B9;&#x3002;</p>
<p><strong>hops&#x7684;&#x8BBE;&#x8BA1;&#x610F;&#x56FE;</strong>&#x3002;&#x4E0A;&#x9762;&#x5206;&#x6790;&#x8FC7;&#x5BF9;&#x4E8E;&#x5148;&#x8FDB;&#x5148;&#x51FA;&#x7684;&#x961F;&#x5217;&#x5165;&#x961F;&#x6240;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x662F;&#x5C06;&#x5165;&#x961F;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;doug lea&#x5199;&#x7684;&#x4EE3;&#x7801;&#x548C;&#x903B;&#x8F91;&#x8FD8;&#x662F;&#x7A0D;&#x5FAE;&#x6709;&#x70B9;&#x590D;&#x6742;&#x3002;&#x90A3;&#x4E48;&#x6211;&#x7528;&#x4EE5;&#x4E0B;&#x65B9;&#x5F0F;&#x6765;&#x5B9E;&#x73B0;&#x884C;&#x4E0D;&#x884C;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public boolean offer(E e) {</span><br><span class="line">    if (e == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    Node&lt;/e&gt;&lt;e&gt; n = new Node&lt;/e&gt;&lt;e&gt;(e);</span><br><span class="line">    for (;;) {</span><br><span class="line">        Node&lt;/e&gt;&lt;e&gt; t = tail;</span><br><span class="line">        if (t.casNext(null, n) &amp;&amp; casTail(t, n)) {</span><br><span class="line">            return true;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8BA9;tail&#x8282;&#x70B9;&#x6C38;&#x8FDC;&#x4F5C;&#x4E3A;&#x961F;&#x5217;&#x7684;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x8FD9;&#x6837;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x91CF;&#x975E;&#x5E38;&#x5C11;&#xFF0C;&#x800C;&#x4E14;&#x903B;&#x8F91;&#x975E;&#x5E38;&#x6E05;&#x695A;&#x548C;&#x6613;&#x61C2;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x4E48;&#x505A;&#x6709;&#x4E2A;&#x7F3A;&#x70B9;&#x5C31;&#x662F;&#x6BCF;&#x6B21;&#x90FD;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5FAA;&#x73AF;CAS&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#x3002;&#x5982;&#x679C;&#x80FD;&#x51CF;&#x5C11;CAS&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x5C31;&#x80FD;&#x63D0;&#x9AD8;&#x5165;&#x961F;&#x7684;&#x6548;&#x7387;&#xFF0C;&#x6240;&#x4EE5;doug lea&#x4F7F;&#x7528;hops&#x53D8;&#x91CF;&#x6765;&#x63A7;&#x5236;&#x5E76;&#x51CF;&#x5C11;tail&#x8282;&#x70B9;&#x7684;&#x66F4;&#x65B0;&#x9891;&#x7387;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;&#x8282;&#x70B9;&#x5165;&#x961F;&#x540E;&#x90FD;&#x5C06; tail&#x8282;&#x70B9;&#x66F4;&#x65B0;&#x6210;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x800C;&#x662F;&#x5F53; tail&#x8282;&#x70B9;&#x548C;&#x5C3E;&#x8282;&#x70B9;&#x7684;&#x8DDD;&#x79BB;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;&#x5E38;&#x91CF;HOPS&#x7684;&#x503C;&#xFF08;&#x9ED8;&#x8BA4;&#x7B49;&#x4E8E;1&#xFF09;&#x65F6;&#x624D;&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#xFF0C;tail&#x548C;&#x5C3E;&#x8282;&#x70B9;&#x7684;&#x8DDD;&#x79BB;&#x8D8A;&#x957F;&#x4F7F;&#x7528;CAS&#x66F4;&#x65B0;tail&#x8282;&#x70B9;&#x7684;&#x6B21;&#x6570;&#x5C31;&#x4F1A;&#x8D8A;&#x5C11;&#xFF0C;&#x4F46;&#x662F;&#x8DDD;&#x79BB;&#x8D8A;&#x957F;&#x5E26;&#x6765;&#x7684;&#x8D1F;&#x9762;&#x6548;&#x679C;&#x5C31;&#x662F;&#x6BCF;&#x6B21;&#x5165;&#x961F;&#x65F6;&#x5B9A;&#x4F4D;&#x5C3E;&#x8282;&#x70B9;&#x7684;&#x65F6;&#x95F4;&#x5C31;&#x8D8A;&#x957F;&#xFF0C;&#x56E0;&#x4E3A;&#x5FAA;&#x73AF;&#x4F53;&#x9700;&#x8981;&#x591A;&#x5FAA;&#x73AF;&#x4E00;&#x6B21;&#x6765;&#x5B9A;&#x4F4D;&#x51FA;&#x5C3E;&#x8282;&#x70B9;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x6837;&#x4ECD;&#x7136;&#x80FD;&#x63D0;&#x9AD8;&#x5165;&#x961F;&#x7684;&#x6548;&#x7387;&#xFF0C;&#x56E0;&#x4E3A;&#x4ECE;&#x672C;&#x8D28;&#x4E0A;&#x6765;&#x770B;&#x5B83;&#x901A;&#x8FC7;&#x589E;&#x52A0;&#x5BF9;volatile&#x53D8;&#x91CF;&#x7684;&#x8BFB;&#x64CD;&#x4F5C;&#x6765;&#x51CF;&#x5C11;&#x4E86;&#x5BF9;volatile&#x53D8;&#x91CF;&#x7684;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x800C;&#x5BF9;volatile&#x53D8;&#x91CF;&#x7684;&#x5199;&#x64CD;&#x4F5C;&#x5F00;&#x9500;&#x8981;&#x8FDC;&#x8FDC;&#x5927;&#x4E8E;&#x8BFB;&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x5165;&#x961F;&#x6548;&#x7387;&#x4F1A;&#x6709;&#x6240;&#x63D0;&#x5347;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;private static final int HOPS = 1;</span><br></pre></td></tr></table></figure>

<p>&#x8FD8;&#x6709;&#x4E00;&#x70B9;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x5165;&#x961F;&#x65B9;&#x6CD5;&#x6C38;&#x8FDC;&#x8FD4;&#x56DE;true&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x8981;&#x901A;&#x8FC7;&#x8FD4;&#x56DE;&#x503C;&#x5224;&#x65AD;&#x5165;&#x961F;&#x662F;&#x5426;&#x6210;&#x529F;&#x3002; ##&#x51FA;&#x961F;&#x5217;## &#x51FA;&#x961F;&#x5217;&#x7684;&#x5C31;&#x662F;&#x4ECE;&#x961F;&#x5217;&#x91CC;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x5143;&#x7D20;&#xFF0C;&#x5E76;&#x6E05;&#x7A7A;&#x8BE5;&#x8282;&#x70B9;&#x5BF9;&#x5143;&#x7D20;&#x7684;&#x5F15;&#x7528;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x51FA;&#x961F;&#x7684;&#x5FEB;&#x7167;&#x6765;&#x89C2;&#x5BDF;&#x4E0B;head&#x8282;&#x70B9;&#x7684;&#x53D8;&#x5316;&#x3002; <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/62337be5ad01d4464929783e7f27ade346aa0d63f8d3a5fdf479c7c1d54ca1dc" alt="&#x5728;&#x6B64;&#x8F93;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x4ECE;&#x4E0A;&#x56FE;&#x53EF;&#x77E5;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;&#x51FA;&#x961F;&#x65F6;&#x90FD;&#x66F4;&#x65B0;head&#x8282;&#x70B9;&#xFF0C;&#x5F53;head&#x8282;&#x70B9;&#x91CC;&#x6709;&#x5143;&#x7D20;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x5F39;&#x51FA;head&#x8282;&#x70B9;&#x91CC;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x800C;&#x4E0D;&#x4F1A;&#x66F4;&#x65B0;head&#x8282;&#x70B9;&#x3002;&#x53EA;&#x6709;&#x5F53;head&#x8282;&#x70B9;&#x91CC;&#x6CA1;&#x6709;&#x5143;&#x7D20;&#x65F6;&#xFF0C;&#x51FA;&#x961F;&#x64CD;&#x4F5C;&#x624D;&#x4F1A;&#x66F4;&#x65B0;head&#x8282;&#x70B9;&#x3002;&#x8FD9;&#x79CD;&#x505A;&#x6CD5;&#x4E5F;&#x662F;&#x901A;&#x8FC7;hops&#x53D8;&#x91CF;&#x6765;&#x51CF;&#x5C11;&#x4F7F;&#x7528;CAS&#x66F4;&#x65B0;head&#x8282;&#x70B9;&#x7684;&#x6D88;&#x8017;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x51FA;&#x961F;&#x6548;&#x7387;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x901A;&#x8FC7;&#x6E90;&#x7801;&#x6765;&#x6DF1;&#x5165;&#x5206;&#x6790;&#x4E0B;&#x51FA;&#x961F;&#x8FC7;&#x7A0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public E poll() {</span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line"></span><br><span class="line">    // p&#x8868;&#x793A;&#x5934;&#x8282;&#x70B9;&#xFF0C;&#x9700;&#x8981;&#x51FA;&#x961F;&#x7684;&#x8282;&#x70B9;</span><br><span class="line">    Node&lt;E&gt; p = h;</span><br><span class="line">    for (int hops = 0;; hops++) {</span><br><span class="line">        // &#x83B7;&#x53D6;p&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;</span><br><span class="line">        E item = p.getItem();</span><br><span class="line"></span><br><span class="line">        // &#x5982;&#x679C;p&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x4F7F;&#x7528;CAS&#x8BBE;&#x7F6E;p&#x8282;&#x70B9;&#x5F15;&#x7528;&#x7684;&#x5143;&#x7D20;&#x4E3A;null,&#x5982;&#x679C;&#x6210;&#x529F;&#x5219;&#x8FD4;&#x56DE;p&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#x3002;</span><br><span class="line">        if (item != null &amp;&amp; p.casItem(item, null)) {</span><br><span class="line">            if (hops &gt;= HOPS) {</span><br><span class="line">                // &#x5C06;p&#x8282;&#x70B9;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;head&#x8282;&#x70B9;</span><br><span class="line">                Node&lt;E&gt; q = p.getNext();</span><br><span class="line"></span><br><span class="line">                updateHead(h, (q != null) ? q : p);</span><br><span class="line">            }</span><br><span class="line">            return item;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // &#x5982;&#x679C;&#x5934;&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#x4E3A;&#x7A7A;&#x6216;&#x5934;&#x8282;&#x70B9;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;&#xFF0C;&#x8FD9;&#x8BF4;&#x660E;&#x5934;&#x8282;&#x70B9;&#x5DF2;&#x7ECF;&#x88AB;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x4FEE;&#x6539;&#x4E86;&#x3002;&#x90A3;&#x4E48;&#x83B7;&#x53D6;p&#x8282;&#x70B9;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;</span><br><span class="line">        Node&lt;E&gt; next = succ(p);</span><br><span class="line"></span><br><span class="line">        // &#x5982;&#x679C;p&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x4E5F;&#x4E3A;&#x7A7A;&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x961F;&#x5217;&#x5DF2;&#x7ECF;&#x7A7A;&#x4E86;</span><br><span class="line">        if (next == null) {</span><br><span class="line">            // &#x66F4;&#x65B0;&#x5934;&#x8282;&#x70B9;&#x3002;</span><br><span class="line">            updateHead(h, p);</span><br><span class="line">            break;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // &#x5982;&#x679C;&#x4E0B;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5C06;&#x5934;&#x8282;&#x70B9;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x8BBE;&#x7F6E;&#x6210;&#x5934;&#x8282;&#x70B9;</span><br><span class="line">        p = next;</span><br><span class="line">    }</span><br><span class="line">    return null;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x83B7;&#x53D6;&#x5934;&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x7136;&#x540E;&#x5224;&#x65AD;&#x5934;&#x8282;&#x70B9;&#x5143;&#x7D20;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;&#x5982;&#x679C;&#x4E3A;&#x7A7A;&#xFF0C;&#x8868;&#x793A;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5DF2;&#x7ECF;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x6B21;&#x51FA;&#x961F;&#x64CD;&#x4F5C;&#x5C06;&#x8BE5;&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#x53D6;&#x8D70;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x4F7F;&#x7528;CAS&#x7684;&#x65B9;&#x5F0F;&#x5C06;&#x5934;&#x8282;&#x70B9;&#x7684;&#x5F15;&#x7528;&#x8BBE;&#x7F6E;&#x6210;null&#xFF0C;&#x5982;&#x679C;CAS&#x6210;&#x529F;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x5934;&#x8282;&#x70B9;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6210;&#x529F;&#xFF0C;&#x8868;&#x793A;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5DF2;&#x7ECF;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x6B21;&#x51FA;&#x961F;&#x64CD;&#x4F5C;&#x66F4;&#x65B0;&#x4E86;head&#x8282;&#x70B9;&#xFF0C;&#x5BFC;&#x81F4;&#x5143;&#x7D20;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;&#xFF0C;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x83B7;&#x53D6;&#x5934;&#x8282;&#x70B9;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2cd2e11c4946c76876b80761707010f5.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512480940045.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512480940045.html" itemprop="url">OpenResty 1136 发布</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T11:36:09+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>upgraded the <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">Nginx</a> core to 1.13.6.<ul>
<li>see the changes here: <a href="/external_links/8e9b2880f13f91db0cf77a98fa80a527.html" target="blank" rel="noopener">nginx.org/en/CHANGES</a></li>
</ul>
</li>
<li>bundled the new component, <a href="/external_links/722a3d6fd324e32af338f115c1a8b5df.html" target="blank" rel="noopener">ngx_stream_lua_module</a> 0.0.4, which is also enabled by default. One can disable this 3rd-party <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">Nginx</a> C module by passing <code>--without-stream_lua_module</code> to the <code>./configure</code> script. We provide compatible Lua API with <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ngx_lua</a> wherever it makes sense. Currently<br>we support <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">content_by_lua*</a>, preread_by_lua* (similar to <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ngx_lua</a>&#x2018;s <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">access_by_lua*</a> ), <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">log_by_lua*</a>, and <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">balancer_by_lua*</a> in the stream subsystem. thanks Mashape Inc. for<br>sponsoring the <a href="/external_links/13b99122def6e36569f7236b2c24953c.html" target="blank" rel="noopener">OpenResty Inc.</a> team to do the development work on rewriting <a href="/external_links/722a3d6fd324e32af338f115c1a8b5df.html" target="blank" rel="noopener">ngx_stream_lua</a> for recent <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">nginx</a> core version.</li>
<li>change: applied a patch to the <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">nginx</a> core to make sure the &#x201C;server&#x201D; header in HTTP/2 response shows &#x201C;openresty&#x201D; when the <code>server_tokens</code> diretive is turned off.</li>
<li>feature: added <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">nginx</a> core patches needed by <a href="/external_links/722a3d6fd324e32af338f115c1a8b5df.html" target="blank" rel="noopener">ngx_stream_lua_module</a>&#x2018;s <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">balancer_by_lua*</a>.</li>
<li>win32: upgraded PCRE to 8.41.</li>
<li>upgraded <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ngx_lua</a> to 0.10.11.<ul>
<li>feature: shdict: added pure C API for getting free page size and total capacity for <a href="/external_links/0914b5973b5b89e20f48d8e339f191b3.html" target="blank" rel="noopener">lua-resty-core</a>. thanks Hiroaki Nakamura for the patch.</li>
<li>feature: added pure C functions for <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:ttl</a>() and <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:expire</a>() API functions.<br>thanks Thibault Charbonnier for the patch.</li>
<li>bugfix: <code>*_by_lua_block</code> directives might break <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">nginx</a> config dump (<code>-T</code> switch). thanks Oleg A. Mamontov for the patch.</li>
<li>bugfix: segmentation faults might happen when pipelined http requests are used in the downsteram connection. thanks Gao Yan for the report.</li>
<li>bugfix: the ssl connections might be drained and reused prematurely when <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ssl_certificate_by_lua*</a> or <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ssl_session_fetch_by_lua*</a> were used. this might lead to segmentation faults under load. thanks guanglinlv for the report and the original patch.</li>
<li>bugfix: <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">tcpsock:connect()</a>: when the <a href="/external_links/6bf5aafc77d409f2ed0bf13aa4c7b41e.html" target="blank" rel="noopener">nginx</a> resolver&#x2019;s <code>send()</code> immediately fails without yielding, we<br>didn&#x2019;t clean up the coroutine ctx state properly. This might lead to segmentation faults. thanks xiaocang for the report and root for the patch.</li>
<li>bugfix: added fallthrough comment to silence GCC 7&#x2019;s <code>-Wimplicit-fallthrough</code>. thanks Andriy Kornatskyy for the report and spacewander for the patch.</li>
<li>bugfix: <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">tcpsock:settimeout</a>, <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">tcpsock:settimeouts</a>: throws an error when the timeout<br>argument values overflow. Here we only support timeout values no greater than the max value of a 32 bits integer. thanks spacewander for the patch.</li>
<li>doc: added &#x201C;413 Request Entity Too Large&#x201D; to the possible short circuit response list. thanks Datong Sun for the patch.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/0914b5973b5b89e20f48d8e339f191b3.html" target="blank" rel="noopener">lua-resty-core</a> to 0.1.13.<ul>
<li>feature: <a href="/external_links/40223c84cbb6168a0e84374db8944ed9.html" target="blank" rel="noopener">ngx.balancer</a> now supports the <a href="/external_links/722a3d6fd324e32af338f115c1a8b5df.html" target="blank" rel="noopener">ngx_stream_lua</a>; also disabled<br>all the other <a href="/external_links/97b014ff1c68ec54b7d941efebb1888c.html" target="blank" rel="noopener">FFI</a> APIs for the stream subsystem for now.</li>
<li>feature: <a href="/external_links/8a7d038c26dd6c0e5c5b27f99f0d9de5.html" target="blank" rel="noopener">resty.core.shdict</a>: added new methods <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:free_space</a>()<br>and <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:capacity</a>(). thanks Hiroaki Nakamura for the patch.</li>
<li>feature: implemented the <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">ngx.re.gmatch</a> function with <a href="/external_links/97b014ff1c68ec54b7d941efebb1888c.html" target="blank" rel="noopener">FFI</a>. thanks spacewander for the patch.</li>
<li>bugfix: <a href="/external_links/7e19908d52ba385c4dd43c3f6e146c74.html" target="blank" rel="noopener">ngx.re</a>: fix an edge-case where <a href="/external_links/7e19908d52ba385c4dd43c3f6e146c74.html" target="blank" rel="noopener">re.split()</a> might<br>not destroy compiled regexes. thanks Thibault Charbonnier for the patch.</li>
<li>feature: implemented the <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:ttl</a>() and <a href="/external_links/314758c7aa1e42a02c531f47c13bb496.html" target="blank" rel="noopener">shdict:expire</a>() API functions using<br><a href="/external_links/97b014ff1c68ec54b7d941efebb1888c.html" target="blank" rel="noopener">FFI</a>.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/855b9eebfae191fe84c8bc5da1d2edad.html" target="blank" rel="noopener">lua-resty-dns</a> to 0.20.<ul>
<li>feature: allows <code>RRTYPE</code> values larger than 255. thanks Peter Wu for the patch.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/896093e0a52ee077b66a2b57a8d3d56b.html" target="blank" rel="noopener">lua-resty-limit-traffic</a> to 0.05.<ul>
<li>feature: added new module <a href="/external_links/fd30f0b585ec985a56f97b611fd61a9f.html" target="blank" rel="noopener">resty.limit.count</a> for GitHub API style request count limiting. thanks Ke Zhu for the original patch<br>and Ming Wen for the followup tweaks.</li>
<li>bugfix: <a href="/external_links/a882d157af146b4f1f703c79776261e4.html" target="blank" rel="noopener">resty.limit.traffic</a>: we might not uncommit previous limiters if a limiter got rejected while committing a state. thanks<br>Thibault Charbonnier for the patch.</li>
<li>bugfix: <a href="/external_links/b9e947a88ceb4c6f433200a48ad4b072.html" target="blank" rel="noopener">resty.limit.conn</a>: we incorrectly specified the exceeded connection count as the initial value for the shdict key decrement<br>which may lead to dead locks when the key has been evicted in very busy systems. thanks bug had appeared in v0.04.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/2a2391d5f02227a853195851db4cb50d.html" target="blank" rel="noopener">resty-cli</a> to 0.20.<ul>
<li>feature: resty: impelented the <code>-j off</code> option to turn off the JIT compiler.</li>
<li>feature: resty: implemented the <code>-j v</code> and <code>-j dump</code> options similar to luajit&#x2019;s.</li>
<li>feature: resty: added new command-line option <code>-l LIB</code> to mimic lua and luajit -l parameter. thanks Michal Cichra for the patch.</li>
<li>bugfix: resty: handle <code>SIGPIPE</code> ourselves by simply killing the process. thanks Ingy dot Net for the report.</li>
<li>bugfix: resty: hot looping Lua scripts failed to respond to the <code>INT</code> signal.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/40a1159f4d527dfd02f7d87711950775.html" target="blank" rel="noopener">opm</a> to 0.0.4.<ul>
<li>bugfix: <a href="/external_links/40a1159f4d527dfd02f7d87711950775.html" target="blank" rel="noopener">opm</a>: when curl uses HTTP/2 by default <a href="/external_links/40a1159f4d527dfd02f7d87711950775.html" target="blank" rel="noopener">opm</a> would complain about &#x201C;bad response status line received&#x201D;. thanks Donal Byrne<br>and Andrew Redden for the report.</li>
<li>debug: <a href="/external_links/40a1159f4d527dfd02f7d87711950775.html" target="blank" rel="noopener">opm</a>: added more details in the &#x201C;bad response status line received from server&#x201D; error.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/3342a90c0206a90d88f91d7d15d75667.html" target="blank" rel="noopener">ngx_headers_more</a> to 0.33.<ul>
<li>feature: add wildcard match support for <a href="/external_links/3342a90c0206a90d88f91d7d15d75667.html" target="blank" rel="noopener">more_clear_input_headers</a>.</li>
<li>doc: fixed <a href="/external_links/3342a90c0206a90d88f91d7d15d75667.html" target="blank" rel="noopener">more_clear_input_headers</a> usage examples. thanks Daniel Paniagua for the patch.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/33192d0426b641426225ab4d2ab239ed.html" target="blank" rel="noopener">ngx_encrypted_session</a> to 0.07.<ul>
<li>bugfix: fixed one potential memory leak in an error condition. thanks dyu for the patch.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/7f19fcea07bc9c879c5f15158170c8d8.html" target="blank" rel="noopener">ngx_rds_json</a> to 0.15.<ul>
<li>bugfix: fixed warnings with C compilers without variadic macro support.</li>
<li>doc: added context info for all the config directives.</li>
</ul>
</li>
<li>upgraded <a href="/external_links/af31545f35bb1dc862c92a016f4d45b6.html" target="blank" rel="noopener">ngx_rds_csv</a> to 0.08.<ul>
<li>tests: varous changes in the test suite.</li>
</ul>
</li>
<li>upgraded LuaJIT to v2.1-20171103: <a href="/external_links/c77e789bee595bb60c47bc345e8bb2a6.html" target="blank" rel="noopener">github.com/openresty/l&#x2026;</a><ul>
<li>optimize: use more appressive JIT compiler parameters as the default to help large OpenResty Lua apps. We now use the following jit.opt defaults: <code>maxtrace=8000 maxrecord=16000 minstitch=3 maxmcode=40960 -- in KB</code>.</li>
<li>imported Mike Pall&#x2019;s latest changes:<ul>
<li><code>LJ_GC64</code>: Make <code>ASMREF_L</code> references 64 bit.</li>
<li><code>LJ_GC64</code>: Fix ir_khash for non-string GCobj.</li>
<li>DynASM/x86: Fix potential <code>REL_A</code> overflow. Thanks to Joshua Haberman.</li>
<li>MIPS64: Hide internal function.</li>
<li>x64/<code>LJ_GC64</code>: Fix type-check-only variant of SLOAD. Thanks to Peter Cawley.</li>
<li>PPC: Add soft-float support to JIT compiler backend. Contributed by Djordje Kovacevic and Stefan Pejic from RT-RK.com. Sponsored by Cisco Systems, Inc.</li>
<li>x64/<code>LJ_GC64</code>: Fix fallback case of <code>asm_fuseloadk64()</code>. Contributed by Peter Cawley.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/1f395b2a5d295c1b3deeb773fa09323b.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512443207688.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512443207688.html" itemprop="url">AI 学习之路——轻松初探 Python 篇（三）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T10:16:19+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x559C;&#x6B22;&#x5C0F;&#x4E4B;&#x7684;&#x6587;&#x7AE0;&#x7684;&#x53EF;&#x4EE5;&#x5173;&#x6CE8;&#x516C;&#x4F17;&#x53F7;&#x300C;WeaponZhi&#x300D;&#x6301;&#x7EED;&#x5173;&#x6CE8;&#x52A8;&#x6001;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/ccfaa49e56c6cd877763ea498db6e10ef3bb040651a1ce8f6774aedfae1dea08" alt></p>
<blockquote>
<p>&#x8FD9;&#x662F;&#x300C;AI &#x5B66;&#x4E60;&#x4E4B;&#x8DEF;&#x300D;&#x7684;&#x7B2C; 3 &#x7BC7;&#xFF0C;&#x300C;Python &#x5B66;&#x4E60;&#x300D;&#x7684;&#x7B2C; 3 &#x7BC7;</p>
</blockquote>
<p>Python &#x5B57;&#x7B26;&#x4E32;&#x4F7F;&#x7528;&#x548C; C &#x8BED;&#x8A00;&#x6BD4;&#x8F83;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6211;&#x4EEC;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x5730;&#x65B9;&#x9700;&#x8981;&#x5173;&#x6CE8;&#xFF0C;&#x7528;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x638C;&#x63E1; Python &#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5427;&#xFF01;</p>
<h2 id="&#x7F16;&#x7801;"><a href="#&#x7F16;&#x7801;" class="headerlink" title="&#x7F16;&#x7801;"></a>&#x7F16;&#x7801;</h2><p>&#x4E0D;&#x8BBA;&#x4EC0;&#x4E48;&#x8BED;&#x8A00;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x9700;&#x8981;&#x8003;&#x8651;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x8BED;&#x8A00;&#x7684;&#x7F16;&#x7801;&#x95EE;&#x9898;&#x3002;&#x300C;ASCII&#x300D;&#x7F16;&#x7801;&#x662F;&#x6211;&#x4EEC;&#x6700;&#x719F;&#x6089;&#x7684;&#x7F16;&#x7801;&#xFF0C;&#x4F46;&#x5B83;&#x53EA;&#x6709; 127 &#x4E2A;&#x5B57;&#x7B26;&#x88AB;&#x7F16;&#x7801;&#x5230;&#x8BA1;&#x7B97;&#x673A;&#x91CC;&#x9762;&#x4E86;&#xFF0C;&#x663E;&#x7136;&#xFF0C;&#x50CF;&#x4E2D;&#x65E5;&#x97E9;&#x8FD9;&#x7C7B;&#x56FD;&#x5BB6;&#xFF0C;&#x8BED;&#x8A00;&#x6587;&#x5B57;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x6765;&#x6307;&#x5B9A;&#x7F16;&#x7801;&#x683C;&#x5F0F;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#xFF0C;&#x4E2D;&#x56FD;&#x81EA;&#x5DF1;&#x5C31;&#x5236;&#x5B9A;&#x4E86;&#x300C;GB2312&#x300D;&#x7F16;&#x7801;&#xFF0C;&#x97E9;&#x6587;&#x5219;&#x662F;&#x300C;EUC_KR&#x300D;&#xFF0C;&#x4FC4;&#x8BED;&#x662F;&#x300C;KOI8-R&#x300D;&#xFF0C;&#x663E;&#x7136;&#xFF0C;&#x5982;&#x679C;&#x6BCF;&#x4E00;&#x4E2A;&#x56FD;&#x5BB6;&#x90FD;&#x9700;&#x8981;&#x5236;&#x4F5C;&#x4E00;&#x4E2A;&#x9002;&#x914D;&#x7684;&#x7F16;&#x7801;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x4E16;&#x754C;&#x5C31;&#x8981;&#x4E71;&#x5957;&#x4E86;&#xFF0C;&#x4E0D;&#x540C;&#x56FD;&#x5BB6;&#x4E4B;&#x95F4;&#x4FE1;&#x606F;&#x7684;&#x4F20;&#x8F93;&#x5C06;&#x53D8;&#x7684;&#x5BF8;&#x6B65;&#x96BE;&#x884C;&#x3002;&#x5982;&#x679C;&#x7535;&#x8111;&#x91CC;&#x6CA1;&#x6709;&#x67D0;&#x4E2A;&#x8BED;&#x8A00;&#x7684;&#x7F16;&#x7801;&#xFF0C;&#x90A3;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#x4E71;&#x7801;&#x51B2;&#x7A81;&#xFF0C;&#x8FD9;&#x662F;&#x76F8;&#x5F53;&#x9EBB;&#x70E6;&#x7684;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#xFF0C;&#x5927;&#x5BB6;&#x5546;&#x91CF;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x5C31;&#x505A;&#x51FA;&#x4E86;&#x300C;Unicode&#x300D;&#x8FD9;&#x4E48;&#x4E2A;&#x7F16;&#x7801;&#x683C;&#x5F0F;&#xFF0C;&#x5B83;&#x5E72;&#x8106;&#x628A;&#x6240;&#x6709;&#x7684;&#x7F16;&#x7801;&#x90FD;&#x7EDF;&#x4E00;&#x4E86;&#xFF0C;&#x53EA;&#x8981;&#x4F60;&#x7528; Unicode &#x5B83;&#x5C31;&#x80FD;&#x4FDD;&#x8BC1;&#x6CA1;&#x6709;&#x4E71;&#x7801;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x4F46; Unicode &#x4E5F;&#x6709;&#x7F3A;&#x70B9;&#x3002;&#x6BD4;&#x5982;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x662F;&#x7EAF;&#x82F1;&#x6587;&#x6765;&#x5199;&#x7684;&#xFF0C;&#x90A3;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x5B9E;&#x9645;&#x4E0A;&#x90FD;&#x53EF;&#x4EE5;&#x7528;&#x8FC7; ASCII &#x7684; 8 &#x4F4D;&#x4E8C;&#x8FDB;&#x5236;&#x6765;&#x8868;&#x793A;&#x3002;&#x6211;&#x4EEC;&#x77E5;&#x9053; Unicode &#x662F;&#x901A;&#x8FC7;&#x8865; 0 &#x6765;&#x8868;&#x793A;&#x4E00;&#x4E9B;&#x4F4E;&#x4F4D;&#x6570;&#x7684;&#x5B57;&#x7B26;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x517C;&#x5BB9;&#x6027;&#xFF0C;&#x4F60;&#x5B9E;&#x9645;&#x4E0A;&#x767D;&#x767D;&#x6D6A;&#x8D39;&#x4E86;&#x4E24;&#x500D;&#x7684;&#x7A7A;&#x95F4;&#x3002;</p>
<p>UTF-8 &#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x6837;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x800C;&#x51FA;&#x73B0;&#x7684;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;**&#x300C;&#x53EF;&#x53D8;&#x957F;&#x7F16;&#x7801;&#x300D;**&#xFF0C;&#x4F60;&#x4E0D;&#x662F;&#x5ACC;&#x7A7A;&#x95F4;&#x6D6A;&#x8D39;&#x5417;&#xFF0C;&#x90A3;&#x4E48;&#x73B0;&#x5728;&#x53EA;&#x8981;&#x4F60;&#x7528;&#x4E86; UTF-8&#xFF0C;&#x4ECE;&#x6B64;&#x4EE5;&#x540E;&#x82F1;&#x6587;&#x5B57;&#x6BCD;&#x54B1;&#x5C31;&#x53EF;&#x4EE5;&#x7528; 1 &#x4E2A;&#x5B57;&#x8282;&#x6765;&#x5B58;&#x50A8;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x9047;&#x5230;&#x50CF;&#x4E2D;&#x6587;&#x8FD9;&#x79CD;&#x300C;&#x9AD8;&#x5927;&#x4E0A;&#x300D;&#x4F46;&#x53C8;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#x5B57;&#x4F53;&#xFF0C;&#x6211;&#x4EEC;&#x7075;&#x6D3B;&#x5BF9;&#x5F85;&#xFF0C;&#x7528;&#x4E09;&#x4E2A;&#x5B57;&#x8282;&#x6765;&#x8868;&#x793A;&#xFF0C;&#x5B9E;&#x5728;&#x6709;&#x67D0;&#x4E9B;&#x66F4;&#x52A0;&#x53D8;&#x6001;&#x800C;&#x590D;&#x6742;&#x7684;&#x5B57;&#x4F53;&#xFF0C;&#x90A3;&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x62D3;&#x5C55;&#x5230;&#x7528; 6 &#x4E2A;&#x5B57;&#x8282;&#x6765;&#x5B58;&#x50A8;&#x3002;&#x603B;&#x4E4B;&#xFF0C;&#x8FD9;&#x6837;&#x4E0B;&#x53BB;&#xFF0C;&#x65E2;&#x89E3;&#x51B3;&#x4E86;&#x517C;&#x5BB9;&#x6027;&#x95EE;&#x9898;&#xFF0C;&#x53C8;&#x53EF;&#x4EE5;&#x8282;&#x7EA6;&#x8D44;&#x6E90;&#xFF0C;&#x8D44;&#x6E90;&#x95EE;&#x9898;&#x8FCE;&#x5203;&#x800C;&#x89E3;&#x4E86;&#x3002;</p>
<p>Python &#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x662F;&#x7528; Unicode &#x7F16;&#x7801;&#x7684;&#xFF0C;&#x6240;&#x4EE5; Python &#x53EF;&#x4EE5;&#x652F;&#x6301;&#x591A;&#x8BED;&#x8A00;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x4FDD;&#x5B58;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x628A; Unicode &#x8F6C;&#x6362;&#x4E3A; UTF-8&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x518D;&#x4ECE;&#x6587;&#x4EF6;&#x4E2D;&#x8F6C;&#x6362; UTF-8 &#x5230; Unicode &#x5230;&#x5185;&#x5B58;&#x4E2D;&#x3002;</p>
<p><strong>&#x901A;&#x8FC7;&#x7F16;&#x7801;&#x7684;&#x8FD9;&#x79CD;&#x6F14;&#x8FDB;&#x8FC7;&#x7A0B;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x4F1A;&#x6709;&#x6240;&#x542F;&#x53D1;&#x5462;&#xFF1F;</strong></p>
<p>**&#x4F60;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x4E00;&#x5207;&#x6280;&#x672F;&#x7684;&#x4EA7;&#x751F;&#x548C;&#x53D1;&#x5C55;&#xFF0C;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#x800C;&#x51FA;&#x73B0;&#x7684;&#x3002;**&#x5927;&#x5BB6;&#x5982;&#x679C;&#x7EC6;&#x7EC6;&#x7684;&#x601D;&#x8003;&#x4E00;&#x4E0B;&#xFF0C;&#x4E0D;&#x8BBA;&#x662F;&#x8BED;&#x8A00;&#x3001;&#x6280;&#x672F;&#x3001;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x3001;&#x67B6;&#x6784;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x4ED6;&#x4EEC;&#x7684;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x51ED;&#x7A7A;&#x7684;&#x6280;&#x672F;&#x5347;&#x7EA7;&#x884C;&#x4E3A;&#xFF0C;&#x800C;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x67D0;&#x79CD;&#x95EE;&#x9898;&#x800C;&#x8BDE;&#x751F;&#x7684;&#x3002;</p>
<p>&#x300C;GB2312&#x300D;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3; ASCII &#x6CA1;&#x6709;&#x4E2D;&#x6587;&#x800C;&#x624D;&#x521B;&#x9020;&#x51FA;&#x6765;&#x7684;&#xFF0C;&#x300C;Unicode&#x300D;&#x662F;&#x56E0;&#x4E3A;&#x5404;&#x56FD;&#x8BED;&#x8A00;&#x4E0D;&#x517C;&#x5BB9;&#x800C;&#x521B;&#x9020;&#x51FA;&#x6765;&#x7684;&#x3002;&#x800C; Unicode &#x5BF9;&#x4E8E;&#x8D44;&#x6E90;&#x7684;&#x6D6A;&#x8D39;&#x53C8;&#x4FC3;&#x6210;&#x4E86; UTF-8 &#x7684;&#x4EA7;&#x751F;&#x3002;&#x6700;&#x5178;&#x578B;&#x7684;&#x95EE;&#x9898;&#x9A71;&#x52A8;&#x6280;&#x672F;&#xFF0C;&#x5C31;&#x662F;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x4E86;&#xFF0C;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x4EA7;&#x751F;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;&#x5404;&#x79CD;&#x4E3A;&#x89E3;&#x51B3;&#x67D0;&#x4E9B;&#x7279;&#x5B9A;&#x95EE;&#x9898;&#x800C;&#x603B;&#x7ED3;&#x51FA;&#x6765;&#x7684;&#x65B9;&#x6848;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5728;&#x6280;&#x672F;&#x4E0A;&#xFF0C;&#x9047;&#x5230;&#x95EE;&#x9898;&#x5E76;&#x4E0D;&#x53EF;&#x6015;&#xFF0C;<strong>&#x95EE;&#x9898;&#x6070;&#x6070;&#x662F;&#x6700;&#x80FD;&#x5E2E;&#x52A9;&#x81EA;&#x5DF1;&#x63D0;&#x5347;&#x7684;&#xFF0C;&#x95EE;&#x9898;&#x662F;&#x521B;&#x9020;&#x529B;&#x7684;&#x6E90;&#x5934;&#x4E4B;&#x4E00;</strong>&#x3002;&#x6211;&#x4EEC;&#x540C;&#x65F6;&#x5728;&#x5E73;&#x65F6;&#x770B;&#x4E66;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x8981;&#x62B1;&#x7740;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x5B66;&#x4E60;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x5355;&#x7EAF;&#x7684;&#x53BB;&#x8BFB;&#x4E00;&#x672C;&#x6280;&#x672F;&#x4E66;&#xFF0C;&#x8FD9;&#x672C;&#x4E66;&#x53C8;&#x53EA;&#x6709;&#x7406;&#x8BBA;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x4F60;&#x4F1A;&#x89C9;&#x5F97;&#x5F88;&#x67AF;&#x71E5;&#x3002;&#x5982;&#x679C;&#x4E66;&#x91CC;&#x53EF;&#x4EE5;&#x7ED3;&#x5408;&#x4E00;&#x4E9B;&#x6848;&#x4F8B;&#x548C;&#x95EE;&#x9898;&#xFF0C;&#x4ECE;&#x8FD9;&#x91CC;&#x5C55;&#x5F00;&#x8BB2;&#x89E3;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x4ECB;&#x7ECD;&#x4E00;&#x4E9B;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x79CD;&#x6559;&#x5B66;&#x65B9;&#x5F0F;&#x6548;&#x679C;&#x5C31;&#x4F1A;&#x7279;&#x522B;&#x597D;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4E4B;&#x524D;&#x770B;&#x8FC7;&#x7684;&#x4E00;&#x672C;&#x4E66;&#x300C;Android &#x6E90;&#x7801;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x300D;&#xFF0C;&#x5B83;&#x5C31;&#x662F;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x6765;&#x8FDB;&#x884C;&#x5C55;&#x5F00;&#x7684;&#x8BF4;&#x660E;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x770B;&#x5B8C;&#x4E86;&#x8FD9;&#x672C;&#x4E66;&#x540E;&#xFF0C;&#x4EE5;&#x540E;&#x9762;&#x5BF9;&#x67D0;&#x79CD;&#x573A;&#x666F;&#xFF0C;&#x6211;&#x5C31;&#x7279;&#x522B;&#x5BB9;&#x6613;&#x56DE;&#x60F3;&#x8D77;&#x4E4B;&#x524D;&#x4E66;&#x4E2D;&#x5199;&#x8FC7;&#x7684;&#x4E00;&#x4E9B;&#x573A;&#x666F;&#xFF0C;&#x4ECE;&#x800C;&#x4EA7;&#x751F;&#x8BB0;&#x5FC6;&#x8054;&#x60F3;&#x3002;</p>
<p>&#x4E0D;&#x4EC5;&#x5982;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x7684;&#x518D;&#x6DF1;&#x4E00;&#x70B9;&#xFF0C;&#x4F60;&#x5C31;&#x4F1A;&#x7A81;&#x7136;&#x9192;&#x609F;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x4EBA;&#x7C7B;&#x793E;&#x4F1A;&#x597D;&#x50CF;&#x4E5F;&#x662F;&#x4EE5;&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#x6765;&#x53D1;&#x5C55;&#x7684;&#x2026;</p>
<p>&#x662F;&#x4E0D;&#x662F;&#x6709;&#x70B9;&#x626F;&#x8FDC;&#x4E86;&#xFF1F;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x6765;&#x770B;&#x770B;&#x5B57;&#x7B26;&#x4E32;&#x5427;&#x3002;</p>
<h2 id="&#x5B57;&#x7B26;&#x4E32;"><a href="#&#x5B57;&#x7B26;&#x4E32;" class="headerlink" title="&#x5B57;&#x7B26;&#x4E32;"></a>&#x5B57;&#x7B26;&#x4E32;</h2><p>Python &#x7684;&#x5B57;&#x7B26;&#x4E32;&#x548C; C &#x8BED;&#x8A00;&#x6709;&#x4E9B;&#x7C7B;&#x4F3C;&#x3002;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x7684;&#x628A;&#x5E38;&#x7528;&#x7684;&#x7528;&#x6CD5;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x5373;&#x53EF;&#xFF0C;&#x5E73;&#x65F6;&#x53EA;&#x8981;&#x591A;&#x5199;&#x51E0;&#x6B21;&#xFF0C;&#x5C31;&#x80FD;&#x6BD4;&#x8F83;&#x719F;&#x7EC3;&#x7684;&#x638C;&#x63E1;&#x4E86;(&#x6B64;&#x8282;&#x5F15;&#x7528;&#x5ED6;&#x96EA;&#x5CF0;&#x6559;&#x7A0B;&#x793A;&#x4F8B;&#xFF0C;&#x4F5C;&#x4E86;&#x7B80;&#x5316;)&#x3002;</p>
<h3 id="ord-&#x548C;-chr"><a href="#ord-&#x548C;-chr" class="headerlink" title="ord() &#x548C; chr()"></a>ord() &#x548C; chr()</h3><p>&#x4F7F;&#x7528; ord() &#x83B7;&#x53D6;&#x5B57;&#x7B26;&#x7684;&#x6574;&#x6570;&#x8868;&#x793A;&#xFF0C;chr() &#x5219;&#x662F;&#x628A;&#x7F16;&#x7801;&#x8F6C;&#x5316;&#x4E3A;&#x5B57;&#x7B26;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; ord(&apos;A&apos;)</span><br><span class="line">65</span><br><span class="line">&gt;&gt;&gt; ord(&apos;&#x4E2D;&apos;)</span><br><span class="line">20013</span><br><span class="line">&gt;&gt;&gt; chr(66)</span><br><span class="line">&apos;B&apos;</span><br><span class="line">&gt;&gt;&gt; chr(25991)</span><br><span class="line">&apos;&#x6587;&apos;</span><br></pre></td></tr></table></figure>

<h3 id="bytes"><a href="#bytes" class="headerlink" title="bytes"></a>bytes</h3><p>&#x7528;&#x5E26;&#x300C;b&#x300D;&#x524D;&#x7F00;&#x7684;&#x5355;&#x5F15;&#x53F7;&#x6216;&#x8005;&#x53CC;&#x5F15;&#x53F7;&#x5B57;&#x7B26;&#x6765;&#x8868;&#x793A;&#x300C;bytes&#x300D;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x975E;&#x5E38;&#x65B9;&#x4FBF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;x = b&apos;ABC&apos;</span><br><span class="line">encode() &#x548C; decode()</span><br></pre></td></tr></table></figure>

<p>&#x5F00;&#x53D1;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7ECF;&#x5E38;&#x8981;&#x628A; str &#x548C; bytes &#x8FDB;&#x884C;&#x76F8;&#x4E92;&#x8F6C;&#x6362;, str &#x901A;&#x8FC7; encode() &#x8F6C;&#x5316;&#x4E3A; bytes&#xFF0C;bytes &#x901A;&#x8FC7; decode() &#x8F6C;&#x5316;&#x4E3A; str</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; &apos;ABC&apos;.encode(&apos;ascii&apos;)</span><br><span class="line">b&apos;ABC&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &apos;&#x4E2D;&#x6587;&apos;.encode(&apos;utf-8&apos;)</span><br><span class="line">b&apos;\xe4\xb8\xad\xe6\x96\x87&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &apos;&#x4E2D;&#x6587;&apos;.encode(&apos;ascii&apos;)</span><br><span class="line">Trace back (most recent call last):</span><br><span class="line">    File &quot;&lt;stdin&gt;&quot;, line 1, in&lt;module&gt;</span><br><span class="line">UnicodeEncodeError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; b&apos;ABC&apos;.decode(&apos;ascii&apos;)</span><br><span class="line">&apos;ABC&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; b&apos;\xe4\xb8\xad\xe6\x96\x87&apos;</span><br><span class="line">&apos;&#x4E2D;&#x6587;&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; b&apos;\xe4\xb8\xad\xff&apos;.decode(&apos;utf-8&apos;)</span><br><span class="line">Tradeback(most recent call last):</span><br><span class="line">    ...</span><br><span class="line">UnicodeDecodeError</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x8981;&#x6CE8;&#x610F;&#x5BB9;&#x9519;&#xFF0C;encode &#x4E0D;&#x80FD;&#x8F6C;&#x5316;&#x8D85;&#x8FC7;&#x53C2;&#x6570;&#x7F16;&#x7801;&#x8303;&#x56F4;&#x7684;&#x5B57;&#x7B26;&#xFF0C;&#x800C;&#x5982;&#x679C; bytes &#x4E2D;&#x5305;&#x542B;&#x7F16;&#x7801;&#x683C;&#x5F0F;&#x65E0;&#x6CD5;&#x89E3;&#x6790;&#x7684;&#x5B57;&#x7B26;&#xFF0C;decode() &#x4E5F;&#x4F1A;&#x62A5;&#x9519;&#x3002;</p>
<h3 id="len"><a href="#len" class="headerlink" title="len()"></a>len()</h3><p>&#x901A;&#x8FC7; len &#x8BA1;&#x7B97;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x5B57;&#x7B26;&#x6570;&#x6216;&#x8005; bytes &#x7684;&#x5B57;&#x8282;&#x6570;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; len(&apos;ABC&apos;)</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; len(&apos;&#x4E2D;&#x6587;&apos;)</span><br><span class="line">2</span><br><span class="line">&gt;&gt;&gt; len(b&apos;ABC&apos;)</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; len(b&apos;\xe4\xb8\xad\xe6\x87&apos;)</span><br><span class="line">6</span><br><span class="line">&gt;&gt;&gt; len(&apos;&#x4E2D;&#x6587;&apos;.encode(&apos;utf-8&apos;))</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x53D1;&#x73B0;&#xFF0C;&#x4E2D;&#x6587;&#x5360; 3 &#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x82F1;&#x6587;&#x5360; 1 &#x4E2A;&#x5B57;&#x8282;</p>
<h3 id="&#x58F0;&#x660E;&#x7F16;&#x7801;&#x683C;&#x5F0F;"><a href="#&#x58F0;&#x660E;&#x7F16;&#x7801;&#x683C;&#x5F0F;" class="headerlink" title="&#x58F0;&#x660E;&#x7F16;&#x7801;&#x683C;&#x5F0F;"></a>&#x58F0;&#x660E;&#x7F16;&#x7801;&#x683C;&#x5F0F;</h3><p>&#x5982;&#x679C;&#x5E0C;&#x671B; Python &#x89E3;&#x91CA;&#x5668;&#x53EF;&#x4EE5;&#x6309; UTF-8 &#x7F16;&#x7801;&#x6765;&#x8BFB;&#x53D6; .py &#x6587;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;#1 /usr/bin/env python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br></pre></td></tr></table></figure>

<p>&#x7B2C;&#x4E00;&#x884C;&#x53EA;&#x5BF9; Linux/OS X &#x6709;&#x6548;&#xFF0C;&#x5B83;&#x544A;&#x8BC9;&#x7CFB;&#x7EDF;&#x8FD9;&#x662F;&#x4E00;&#x4E2A; Python &#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x3002;&#x7B2C;&#x4E8C;&#x884C;&#x5219;&#x544A;&#x8BC9; Python &#x89E3;&#x91CA;&#x5668;&#xFF0C;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8981;&#x6309;&#x7167; UTF-8 &#x7F16;&#x7801;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x8FD9;&#x6837;&#x5199;&#xFF0C;&#x4E2D;&#x6587;&#x8F93;&#x51FA;&#x4F1A;&#x6709;&#x4E71;&#x7801;&#x3002;</p>
<p>&#x5B57;&#x7B26;&#x4E32;&#x683C;&#x5F0F;&#x5316;</p>
<p>&#x683C;&#x5F0F;&#x5316;&#x548C; C &#x6709;&#x70B9;&#x50CF;&#xFF0C;&#x7528;&#x300C;%&#x300D;&#x5B9E;&#x73B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; &apos;Hello,%s&apos; % &apos;world&apos;</span><br><span class="line">&apos;Hello , world&apos;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &apos;&#x4F60;&#x597D;%s&#xFF0C;&#x4F60;&#x6709; &#xFFE5;%d &#x5417;&apos; % (&apos;&#x5C0F;&#x4E4B;&apos;,50)</span><br><span class="line">&apos;&#x4F60;&#x597D;&#x5C0F;&#x4E4B;&#xFF0C;&#x4F60;&#x6709; &#xFFE5;50 &#x5417;&apos;</span><br></pre></td></tr></table></figure>

<p>&#x5360;&#x4F4D;&#x7B26;&#x4E2D;&#xFF0C;%d &#x4EE3;&#x8868;&#x6574;&#x6570;&#xFF0C;%f &#x4EE3;&#x8868;&#x6D6E;&#x70B9;&#x6570;&#xFF0C;%s &#x4EE3;&#x8868;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;%x &#x4EE3;&#x8868;&#x5341;&#x516D;&#x8FDB;&#x5236;&#x6574;&#x6570;&#xFF0C;&#x5360;&#x4F4D;&#x7B26;&#x8981;&#x548C; % &#x53F7;&#x540E;&#x9762;&#x7684;&#x53D8;&#x91CF;&#x6216;&#x8005;&#x503C;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#xFF0C;&#x5982;&#x679C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5360;&#x4F4D;&#x7B26;&#xFF0C;% &#x53F7;&#x540E;&#x4E0D;&#x9700;&#x8981;&#x62EC;&#x53F7;&#x3002;</p>
<p>&#x5360;&#x4F4D;&#x7B26;&#x8FD8;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x7A7A;&#x683C;&#x3001;&#x5C0F;&#x6570;&#x70B9;&#x548C;&#x8865; 0 &#x7684;&#x4F4D;&#x6570;&#x3002;&#x6BD4;&#x5982;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; print(&apos;%2d-%02d&apos; % (5,1))</span><br><span class="line">  5-01</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(&apos;%.2f&apos; % 3.1415)</span><br><span class="line">3.14</span><br></pre></td></tr></table></figure>

<p>&#x6CE8;&#x610F;&#xFF0C;&#x300C;5-01&#x300D;&#x4E2D;&#xFF0C;5 &#x7684;&#x524D;&#x9762;&#x662F;&#x6709;&#x4E24;&#x4E2A;&#x7A7A;&#x683C;&#x7684;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x9700;&#x8981;&#x4F7F;&#x7528; % &#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x663E;&#x793A;&#x5728;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x8F6C;&#x4E49;&#x4E86;&#xFF0C;%% &#x8868;&#x793A;&#x4E00;&#x4E2A; %</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; &apos;&#x5C0F;&#x4E4B;&#x516C;&#x4F17;&#x53F7;&#x7684;&#x70B9;&#x8D5E;&#x7387;&#x7ADF;&#x7136;&#x8D85;&#x8FC7;&#x4E86; %d%%&apos; % 50</span><br><span class="line">&apos;&#x5C0F;&#x4E4B;&#x516C;&#x4F17;&#x53F7;&#x7684;&#x70B9;&#x8D5E;&#x7387;&#x7ADF;&#x7136;&#x8D85;&#x8FC7;&#x4E86; 50%&apos;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x6211;&#x7684;&#x516C;&#x4F17;&#x53F7;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/73169e8463cb820fad64395bd8037b34f2d8bb52d7647c1a0cf60f600af4e91e" alt></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/82706b48c3c64614cdb54dfa406ceb2f.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512413831182.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512413831182.html" itemprop="url">JDK不同操作系统的FileSystem（Windows）中</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T08:35:30+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6709;&#x5404;&#x81EA;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x8FD9;&#x4E9B;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x53C8;&#x5B58;&#x5728;&#x5F88;&#x591A;&#x5DEE;&#x5F02;&#xFF0C;&#x800C;Java &#x56E0;&#x4E3A;&#x662F;&#x8DE8;&#x5E73;&#x53F0;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5FC5;&#x987B;&#x8981;&#x7EDF;&#x4E00;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x4E0D;&#x540C;&#x5E73;&#x53F0;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#xFF0C;&#x624D;&#x80FD;&#x5F80;&#x4E0A;&#x63D0;&#x4F9B;&#x7EDF;&#x4E00;&#x7684;&#x5165;&#x53E3;&#x3002;</p>
<h2 id="&#x5173;&#x4E8E;FileSystem&#x7C7B;"><a href="#&#x5173;&#x4E8E;FileSystem&#x7C7B;" class="headerlink" title="&#x5173;&#x4E8E;FileSystem&#x7C7B;"></a>&#x5173;&#x4E8E;FileSystem&#x7C7B;</h2><p>JDK &#x91CC;&#x9762;&#x62BD;&#x8C61;&#x51FA;&#x4E86;&#x4E00;&#x4E2A; FileSystem &#x6765;&#x8868;&#x793A;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x8BE5;&#x7C7B;&#x5B9E;&#x73B0;&#x5404;&#x81EA;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x6BD4;&#x5982; Windows NT/2000 &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5219;&#x4E3A; WinNTFileSystem&#xFF0C;&#x800C; unix-like &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E3A; UnixFileSystem&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x4E00;&#x70B9;&#x662F;&#xFF0C;WinNTFileSystem&#x7C7B; &#x548C; UnixFileSystem&#x7C7B;&#x5E76;&#x4E0D;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A; JDK &#x91CC;&#x9762;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5B83;&#x4EEC;&#x662F;&#x5206;&#x5F00;&#x7684;&#xFF0C;&#x4F60;&#x53EA;&#x80FD;&#x5728; Windows &#x7248;&#x672C;&#x7684; JDK &#x4E2D;&#x627E;&#x5230; WinNTFileSystem&#xFF0C;&#x800C;&#x5728; Linux &#x7248;&#x672C;&#x7684; JDK &#x4E2D;&#x627E;&#x5230; UnixFileSystem&#xFF0C;&#x540C;&#x6837;&#x5730;&#xFF0C;&#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E5F;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x5B9E;&#x73B0;&#x7C7B;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x5206;&#x6210;&#x4E24;&#x4E2A;&#x7CFB;&#x5217;&#x5206;&#x6790; JDK &#x5BF9;&#x4E24;&#x79CD;&#xFF08;Windows &#x548C;Linux&#xFF09;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x5148;&#x8BB2; Windows&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#xFF0C;&#x5BF9;&#x5E94;&#x4E3A; WinNTFileSystem &#x7C7B;&#x3002; &#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x8F83;&#x957F;&#xFF0C;&#x300A;JDK&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;FileSystem&#xFF08;Windows&#xFF09;&#x300B;&#x5206;&#x4E3A;&#x4E0A;&#x4E2D;&#x4E0B;&#x7BC7;&#xFF0C;&#x6B64;&#x4E3A;&#x4E2D;&#x7BC7;&#x3002;</p>
<h2 id="&#x7EE7;&#x627F;&#x7ED3;&#x6784;"><a href="#&#x7EE7;&#x627F;&#x7ED3;&#x6784;" class="headerlink" title="&#x7EE7;&#x627F;&#x7ED3;&#x6784;"></a>&#x7EE7;&#x627F;&#x7ED3;&#x6784;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;--java.lang.Object</span><br><span class="line">  --java.io.FileSystem</span><br><span class="line">    --java.io.WinNTFileSystem</span><br></pre></td></tr></table></figure>

<h3 id="getDefaultParent&#x65B9;&#x6CD5;"><a href="#getDefaultParent&#x65B9;&#x6CD5;" class="headerlink" title="getDefaultParent&#x65B9;&#x6CD5;"></a>getDefaultParent&#x65B9;&#x6CD5;</h3><p>&#x8FD4;&#x56DE;&#x9ED8;&#x8BA4;&#x7684;&#x7236;&#x8DEF;&#x5F84;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE; slash &#x5373;<code>\</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public String getDefaultParent() {</span><br><span class="line">        return (&quot;&quot; + slash);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="fromURIPath&#x65B9;&#x6CD5;"><a href="#fromURIPath&#x65B9;&#x6CD5;" class="headerlink" title="fromURIPath&#x65B9;&#x6CD5;"></a>fromURIPath&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x683C;&#x5F0F;&#x5316;&#x8DEF;&#x5F84;&#x3002;&#x4E3B;&#x8981;&#x903B;&#x8F91;&#x662F;&#x5B8C;&#x6210;&#x7C7B;&#x4F3C;&#x4EE5;&#x4E0B;&#x7684;&#x8F6C;&#x6362;&#x5904;&#x7406;&#xFF1A;</p>
<ol>
<li><code>/c:/test</code> &#x2013;&gt; <code>c:/test</code>&#x3002;</li>
<li><code>c:/test/</code> &#x2013;&gt; <code>c:/test</code>&#xFF0C;&#x4F46;&#x8981;&#x6CE8;&#x610F;&#xFF0C;<code>c:/</code> &#x2013;&gt; <code>c:/</code>&#xFF0C;&#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x957F;&#x5EA6;&#x6765;&#x9650;&#x5236;&#x7684;&#xFF0C;&#x5373;&#x5F53;&#x957F;&#x5EA6;&#x8D85;&#x8FC7;3&#x65F6;&#x624D;&#x4F1A;&#x53BB;&#x6389;&#x5C3E;&#x90E8;&#x7684; <code>/</code>&#x3002;</li>
<li><code>/test/</code> &#x2013;&gt; <code>/test</code>&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public String fromURIPath(String path) {</span><br><span class="line">        String p = path;</span><br><span class="line">        if ((p.length() &gt; 2) &amp;&amp; (p.charAt(2) == &apos;:&apos;)) {</span><br><span class="line">            p = p.substring(1);</span><br><span class="line">            if ((p.length() &gt; 3) &amp;&amp; p.endsWith(&quot;/&quot;))</span><br><span class="line">                p = p.substring(0, p.length() - 1);</span><br><span class="line">        } else if ((p.length() &gt; 1) &amp;&amp; p.endsWith(&quot;/&quot;)) {</span><br><span class="line">            p = p.substring(0, p.length() - 1);</span><br><span class="line">        }</span><br><span class="line">        return p;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="isAbsolute&#x65B9;&#x6CD5;"><a href="#isAbsolute&#x65B9;&#x6CD5;" class="headerlink" title="isAbsolute&#x65B9;&#x6CD5;"></a>isAbsolute&#x65B9;&#x6CD5;</h3><p>&#x5224;&#x65AD;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x662F;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5148;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x5934;&#x90E8;&#x957F;&#x5EA6;&#xFF0C;&#x5982;&#x679C;&#x957F;&#x5EA6;&#x4E3A;3&#x5219;&#x4E3A;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5982;&#x679C;&#x957F;&#x5EA6;&#x4E3A;2&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;<code>\</code>&#x4E5F;&#x4E3A;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;    public boolean isAbsolute(File f) {</span><br><span class="line">        int pl = f.getPrefixLength();</span><br><span class="line">        return (((pl == 2) &amp;&amp; (f.getPath().charAt(0) == slash))</span><br><span class="line">                || (pl == 3));</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="canonicalize&#x65B9;&#x6CD5;"><a href="#canonicalize&#x65B9;&#x6CD5;" class="headerlink" title="canonicalize&#x65B9;&#x6CD5;"></a>canonicalize&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x65B9;&#x6CD5;&#x7528;&#x6765;&#x6807;&#x51C6;&#x5316;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;&#xFF0C;&#x6807;&#x51C6;&#x8DEF;&#x5F84;&#x4E0D;&#x4EC5;&#x662F;&#x4E00;&#x4E2A;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x552F;&#x4E00;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x800C;&#x4E14;&#x6807;&#x51C6;&#x7684;&#x5B9A;&#x4E49;&#x662F;&#x4F9D;&#x8D56;&#x4E8E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#xFF0C;&#x4E00;&#x822C;&#x5728;&#x6807;&#x51C6;&#x5316;&#x8DEF;&#x5F84;&#x65F6;&#x4F1A;&#x5148;&#x5C06;&#x8DEF;&#x5F84;&#x8F6C;&#x6210;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x6839;&#x636E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x89E3;&#x6790;&#x6210;&#x552F;&#x4E00;&#x5F62;&#x5F0F;&#x7684;&#x8DEF;&#x5F84;&#x3002;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x6BD4;&#x8F83;&#x5178;&#x578B;&#x7684;&#x5C31;&#x662F;&#x5904;&#x7406;&#x5305;&#x542B;&#x201D;.&#x201D;&#x6216;&#x201D;..&#x201D;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x8FD8;&#x6709;&#x7B26;&#x53F7;&#x94FE;&#x63A5;&#x548C;&#x9A71;&#x52A8;&#x76D8;&#x7B26;&#x53F7;&#x5927;&#x5C0F;&#x5199;&#x7B49;&#x3002;</p>
<ol>
<li>&#x5982;&#x679C;&#x8DEF;&#x5F84;&#x957F;&#x5EA6;&#x4E3A;2&#xFF0C;&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;&#x5B57;&#x6BCD;&#xFF0C;&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E8C;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;<code>:</code>&#xFF0C;&#x6B64;&#x65F6;&#x8DEF;&#x5F84;&#x7C7B;&#x4F3C;&#x4E3A;<code>c:</code>&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x8DEF;&#x5F84;&#x6216;&#x52A0;&#x4E0A;<code>:</code>&#x8FD4;&#x56DE;&#x3002;</li>
<li>&#x5982;&#x679C;&#x8DEF;&#x5F84;&#x957F;&#x5EA6;&#x4E3A;3&#xFF0C;&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;&#x5B57;&#x6BCD;&#xFF0C;&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E8C;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;<code>:</code>&#xFF0C;&#x4E14;&#x8DEF;&#x5F84;&#x7B2C;&#x4E09;&#x4E2A;&#x5B57;&#x7B26;&#x4E3A;<code>\</code>&#xFF0C;&#x6B64;&#x65F6;&#x8DEF;&#x5F84;&#x7C7B;&#x4F3C;&#x4E3A;<code>c:\</code>&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x8DEF;&#x5F84;&#x6216;&#x52A0;&#x4E0A;<code>:</code>&#x8FD4;&#x56DE;&#x3002;</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528; canonicalize0 &#x672C;&#x5730;&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6807;&#x51C6;&#x5316;&#x8DEF;&#x5F84;&#x3002;</li>
<li>&#x5982;&#x679C;&#x4F7F;&#x7528;&#x4E86;&#x7F13;&#x5B58;&#x5219;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x627E;&#xFF0C;&#x5B58;&#x5728;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x5426;&#x5219;&#x5148;&#x8C03;&#x7528; canonicalize0 &#x672C;&#x5730;&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6807;&#x51C6;&#x5316;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x5C06;&#x8DEF;&#x5F84;&#x653E;&#x8FDB;&#x7F13;&#x5B58;&#x4E2D;&#x3002;</li>
<li>&#x53E6;&#x5916;&#xFF0C;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x524D;&#x7F00;&#x7F13;&#x5B58;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;&#x5B83;&#x7F13;&#x5B58;&#x4E86;&#x6807;&#x51C6;&#x8DEF;&#x5F84;&#x7684;&#x7236;&#x76EE;&#x5F55;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x4E86;&#x524D;&#x7F00;&#x90E8;&#x5206;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x524D;&#x7F00;&#x7F13;&#x5B58;&#x7684;&#x903B;&#x8F91;&#x4E5F;&#x662F;&#x7B2C;&#x4E00;&#x6B21;&#x6807;&#x51C6;&#x5316;&#x540E;&#x5C06;&#x5176;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#xFF0C;&#x4E0B;&#x6B21;&#x5219;&#x53EF;&#x4ECE;&#x524D;&#x7F00;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x8BE2;&#x3002;</li>
<li>&#x4F7F;&#x7528;&#x524D;&#x7F00;&#x7F13;&#x5B58;&#x6765;&#x6807;&#x51C6;&#x5316;&#x8DEF;&#x5F84;&#x65F6;&#x662F;&#x8C03;&#x7528; canonicalizeWithPrefix &#x65B9;&#x6CD5;&#x7684;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x8C03;&#x4E00;&#x4E2A;&#x672C;&#x5730;&#x65B9;&#x6CD5; canonicalizeWithPrefix0&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x5217;&#x51FA;&#x8BE5;&#x65B9;&#x6CD5;&#x4EE3;&#x7801;&#xFF0C;&#x6B64;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x4E0E;&#x524D;&#x9762;&#x7684; canonicalize0 &#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x552F;&#x4E00;&#x4E0D;&#x540C;&#x7684;&#x662F;&#x5B83;&#x4E0D;&#x7528;&#x904D;&#x5386;&#x6574;&#x4E2A;&#x8DEF;&#x5F84;&#x4ECE;&#x5934;&#x5F00;&#x59CB;&#x68C0;&#x67E5;&#x8DEF;&#x5F84;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x800C;&#x53EA;&#x9700;&#x8981;&#x68C0;&#x67E5;&#x4E00;&#x6B21;&#x6574;&#x4E2A;&#x8DEF;&#x5F84;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x5B58;&#x5728;&#x524D;&#x7F00;&#x7F13;&#x5B58;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x8282;&#x7701;&#x4E86;&#x4E00;&#x4E9B;&#x5DE5;&#x4F5C;&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;    public String canonicalize(String path) throws IOException {</span><br><span class="line">        int len = path.length();</span><br><span class="line">        if ((len == 2) &amp;&amp;</span><br><span class="line">            (isLetter(path.charAt(0))) &amp;&amp;</span><br><span class="line">            (path.charAt(1) == &apos;:&apos;)) {</span><br><span class="line">            char c = path.charAt(0);</span><br><span class="line">            if ((c &gt;= &apos;A&apos;) &amp;&amp; (c &lt;= &apos;Z&apos;))</span><br><span class="line">                return path;</span><br><span class="line">            return &quot;&quot; + ((char) (c-32)) + &apos;:&apos;;</span><br><span class="line">        } else if ((len == 3) &amp;&amp;</span><br><span class="line">                   (isLetter(path.charAt(0))) &amp;&amp;</span><br><span class="line">                   (path.charAt(1) == &apos;:&apos;) &amp;&amp;</span><br><span class="line">                   (path.charAt(2) == &apos;\\&apos;)) {</span><br><span class="line">            char c = path.charAt(0);</span><br><span class="line">            if ((c &gt;= &apos;A&apos;) &amp;&amp; (c &lt;= &apos;Z&apos;))</span><br><span class="line">                return path;</span><br><span class="line">            return &quot;&quot; + ((char) (c-32)) + &apos;:&apos; + &apos;\\&apos;;</span><br><span class="line">        }</span><br><span class="line">        if (!useCanonCaches) {</span><br><span class="line">            return canonicalize0(path);</span><br><span class="line">        } else {</span><br><span class="line">            String res = cache.get(path);</span><br><span class="line">            if (res == null) {</span><br><span class="line">                String dir = null;</span><br><span class="line">                String resDir = null;</span><br><span class="line">                if (useCanonPrefixCache) {</span><br><span class="line">                    dir = parentOrNull(path);</span><br><span class="line">                    if (dir != null) {</span><br><span class="line">                        resDir = prefixCache.get(dir);</span><br><span class="line">                        if (resDir != null) {</span><br><span class="line">                            String filename = path.substring(1 + dir.length());</span><br><span class="line">                            res = canonicalizeWithPrefix(resDir, filename);</span><br><span class="line">                            cache.put(dir + File.separatorChar + filename, res);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                if (res == null) {</span><br><span class="line">                    res = canonicalize0(path);</span><br><span class="line">                    cache.put(path, res);</span><br><span class="line">                    if (useCanonPrefixCache &amp;&amp; dir != null) {</span><br><span class="line">                        resDir = parentOrNull(res);</span><br><span class="line">                        if (resDir != null) {</span><br><span class="line">                            File f = new File(res);</span><br><span class="line">                            if (f.exists() &amp;&amp; !f.isDirectory()) {</span><br><span class="line">                                prefixCache.put(dir, resDir);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            return res;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">private native String canonicalize0(String path)</span><br><span class="line">            throws IOException;</span><br><span class="line"></span><br><span class="line">private String canonicalizeWithPrefix(String canonicalPrefix,</span><br><span class="line">            String filename) throws IOException</span><br><span class="line">    {</span><br><span class="line">        return canonicalizeWithPrefix0(canonicalPrefix,</span><br><span class="line">                canonicalPrefix + File.separatorChar + filename);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private native String canonicalizeWithPrefix0(String canonicalPrefix,</span><br><span class="line">            String pathWithCanonicalPrefix)</span><br><span class="line">            throws IOException;</span><br></pre></td></tr></table></figure>

<p>&#x56E0;&#x4E3A;&#x6807;&#x51C6;&#x5316;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x662F;&#x4F9D;&#x8D56;&#x4E8E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x90E8;&#x5206;&#x5DE5;&#x4F5C;&#x4EA4;&#x7531;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x53BB;&#x505A;&#xFF0C;&#x4E3B;&#x8981;&#x903B;&#x8F91;&#x5982;&#x4E0B;&#xFF0C;</p>
<ul>
<li>&#x6807;&#x51C6;&#x8DEF;&#x5F84;&#x6700;&#x5927;&#x957F;&#x5EA6;&#x662F; MAX_PATH_LENGTH &#x5373;1024&#x4E2A;&#x5B57;&#x7B26;&#x3002;</li>
<li>&#x83B7;&#x53D6;&#x8DEF;&#x5F84;&#x957F;&#x5EA6;&#x5E76;&#x4E14;&#x901A;&#x8FC7; currentDirLength &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x957F;&#x5EA6;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x4EE3;&#x7801;&#x4E0D;&#x518D;&#x8D34;&#x51FA;&#x6765;&#xFF0C;&#x4E3B;&#x8981;&#x903B;&#x8F91;&#x662F;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x9A71;&#x52A8;&#x76D8;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#x5219;&#x6839;&#x636E;&#x9A71;&#x52A8;&#x76D8;&#x7B26;&#x53F7;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x9A71;&#x52A8;&#x76D8;&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x5E76;&#x8FD4;&#x56DE;&#x8BE5;&#x76EE;&#x5F55;&#x957F;&#x5EA6;&#x3002;&#x5426;&#x5219;&#x5C31;&#x6839;&#x636E;C&#x7684;API&#x51FD;&#x6570; _wgetcwd &#x83B7;&#x53D6;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x5E76;&#x8FD4;&#x56DE;&#x957F;&#x5EA6;&#x3002;&#x8DEF;&#x5F84;&#x957F;&#x5EA6;&#x52A0;&#x4E0A;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x957F;&#x5EA6;&#x5219;&#x4E3A;&#x603B;&#x957F;&#x5EA6;&#x3002;</li>
<li>&#x901A;&#x8FC7; malloc &#x5206;&#x914D;&#x7A7A;&#x95F4;&#xFF0C;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x662F;&#x5BBD;&#x5B57;&#x7B26;&#x3002;</li>
<li>&#x6700;&#x540E;&#x901A;&#x8FC7; wcanonicalize &#x51FD;&#x6570;&#x6807;&#x51C6;&#x5316;&#x8DEF;&#x5F84;&#x3002;&#x4EE3;&#x7801;&#x8F83;&#x957F;&#xFF0C;&#x4E0D;&#x518D;&#x8D34;&#x51FA;&#xFF0C;&#x4E3B;&#x8981;&#x903B;&#x8F91;&#x662F;&#xFF0C;</li>
</ul>
<ol>
<li>&#x68C0;&#x67E5;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x5305;&#x542B;&#x901A;&#x914D;&#x7B26;&#xFF0C;&#x662F;&#x5219;&#x6807;&#x51C6;&#x5316;&#x5931;&#x8D25;&#x3002;</li>
<li>&#x901A;&#x8FC7; _wfullpath &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4ED6;&#x4F1A;&#x5904;&#x7406; <code>\</code>&#x548C;<code>..</code>&#x7B49;&#x7B26;&#x53F7;&#xFF0C;&#x6BD4;&#x5982; &#x201C;test&#x201D;&#x3001;&#x201D;\test&#x201D; &#x548C;&#x201D;..\test&#x201D;&#xFF0C;&#x5219;&#x4F1A;&#x5904;&#x7406;&#x6210;&#x201D;C:\Documents and Settings\user\My Documents\test&#x201D;&#x3001;&#x201D;C:\test&#x201D;&#x548C;&#x201D;C:\Documents and Settings\user\test&#x201D;&#x3002;</li>
<li>&#x68C0;&#x67E5;&#x8DEF;&#x5F84;&#x4E2D;&#x662F;&#x5426;&#x5305;&#x542B;&#x4E86;&#x975E;&#x6CD5;&#x7684; <code>.</code>&#x3002;</li>
<li>&#x83B7;&#x53D6;&#x6807;&#x51C6;&#x5316;&#x9A71;&#x52A8;&#x76D8;&#x7B26;&#x53F7;&#xFF0C;&#x5C06;&#x5176;&#x5927;&#x5199;&#xFF0C;&#x4FDD;&#x5B58;&#x5230;&#x7ED3;&#x679C;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</li>
<li>&#x5982;&#x679C;&#x662F; UNC &#x8DEF;&#x5F84;&#x7684;&#x8BDD;&#xFF0C;UNC&#x8DEF;&#x5F84;&#x683C;&#x5F0F;&#x5982;<code>\\server\share\file_path</code>&#xFF0C;&#x5219;&#x6B64;&#x65F6;&#x5206;&#x522B;&#x83B7;&#x53D6; server &#x548C; share&#xFF0C;&#x5C06;&#x5176;&#x4FDD;&#x5B58;&#x5230;&#x7ED3;&#x679C;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</li>
<li>&#x901A;&#x8FC7;&#x5FAA;&#x73AF;&#x68C0;&#x6D4B;&#x5269;&#x4F59;&#x8DEF;&#x5F84;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4F7F;&#x7528; FindFirstFileW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x8DEF;&#x5F84;&#x5BF9;&#x5E94;&#x6587;&#x4EF6;&#x7684;&#x5C5E;&#x6027;&#x4FE1;&#x606F;&#xFF0C;&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x503C;&#x53EF;&#x5224;&#x65AD;&#x5176;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x6709;&#x6548;&#x5730;&#x8DEF;&#x5F84;&#x5219;&#x4FDD;&#x5B58;&#x5230;&#x7ED3;&#x679C;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</li>
<li>&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x5B57;&#x7B26;&#x6570;&#x7EC4;&#x5219;&#x4E3A;&#x6807;&#x51C6;&#x5316;&#x540E;&#x7684;&#x8DEF;&#x5F84;&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;JNIEXPORT jstring JNICALL</span><br><span class="line">Java_java_io_WinNTFileSystem_canonicalize0(JNIEnv *env, jobject this,</span><br><span class="line">                                           jstring pathname)</span><br><span class="line">{</span><br><span class="line">    jstring rv = NULL;</span><br><span class="line">    WCHAR canonicalPath[MAX_PATH_LENGTH];</span><br><span class="line"></span><br><span class="line">    WITH_UNICODE_STRING(env, pathname, path) {</span><br><span class="line">        int len = (int)wcslen(path);</span><br><span class="line">        len += currentDirLength(path, len);</span><br><span class="line">        if (len  &gt; MAX_PATH_LENGTH - 1) {</span><br><span class="line">            WCHAR *cp = (WCHAR*)malloc(len * sizeof(WCHAR));</span><br><span class="line">            if (cp != NULL) {</span><br><span class="line">                if (wcanonicalize(path, cp, len) &gt;= 0) {</span><br><span class="line">                    rv = (*env)-&gt;NewString(env, cp, (jsize)wcslen(cp));</span><br><span class="line">                }</span><br><span class="line">                free(cp);</span><br><span class="line">            }</span><br><span class="line">        } else</span><br><span class="line">        if (wcanonicalize(path, canonicalPath, MAX_PATH_LENGTH) &gt;= 0) {</span><br><span class="line">            rv = (*env)-&gt;NewString(env, canonicalPath, (jsize)wcslen(canonicalPath));</span><br><span class="line">        }</span><br><span class="line">    } END_UNICODE_STRING(env, path);</span><br><span class="line">    if (rv == NULL) {</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, &quot;Bad pathname&quot;);</span><br><span class="line">    }</span><br><span class="line">    return rv;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="getBooleanAttributes&#x65B9;&#x6CD5;"><a href="#getBooleanAttributes&#x65B9;&#x6CD5;" class="headerlink" title="getBooleanAttributes&#x65B9;&#x6CD5;"></a>getBooleanAttributes&#x65B9;&#x6CD5;</h3><p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x4E3B;&#x8981;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5224;&#x65AD; File &#x5BF9;&#x8C61;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5224;&#x65AD; File &#x5BF9;&#x8C61;&#x5BF9;&#x5E94;&#x7684;&#x662F;&#x4E0D;&#x662F;&#x6587;&#x4EF6;&#xFF0C;&#x5224;&#x65AD; File &#x5BF9;&#x8C61;&#x5BF9;&#x5E94;&#x7684;&#x662F;&#x4E0D;&#x662F;&#x76EE;&#x5F55;&#xFF0C;&#x5224;&#x65AD; File &#x5BF9;&#x8C61;&#x662F;&#x4E0D;&#x662F;&#x9690;&#x85CF;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x3002;</p>
<p>&#x4F46;&#x8FD9;&#x91CC;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A; int &#x7C7B;&#x578B;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x9AD8;&#x6548;&#x5229;&#x7528;&#x6570;&#x636E;&#xFF0C;&#x7528;&#x4F4D;&#x4F5C;&#x4E3A;&#x4E0D;&#x540C;&#x5C5E;&#x6027;&#x7684;&#x6807;&#x8BC6;&#xFF0C;&#x5206;&#x522B;&#x4E3A;<br><code>0x01&#x3001;0x02&#x3001;0x04&#x3001;0x08</code>&#xFF0C;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x662F;&#x5426;&#x5B58;&#x5728;&#x3001;&#x662F;&#x5426;&#x4E3A;&#x6587;&#x4EF6;&#x3001;&#x662F;&#x5426;&#x4E3A;&#x76EE;&#x5F55;&#x548C;&#x662F;&#x5426;&#x4E3A;&#x9690;&#x85CF;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public native int getBooleanAttributes(File f);</span><br></pre></td></tr></table></figure>

<p>&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x7684;&#x4E3B;&#x8981;&#x903B;&#x8F91;&#x662F;&#x5148;&#x5F97;&#x5230;&#x6587;&#x4EF6;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x5224;&#x65AD;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x4E3A; windows &#x4FDD;&#x7559;&#x8BBE;&#x5907;&#x540D;&#x79F0;&#xFF0C;&#x5B83;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x8FD9;&#x4E9B;&#xFF0C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;static WCHAR* ReservedDEviceNames[] = {</span><br><span class="line">    L&quot;CON&quot;, L&quot;PRN&quot;, L&quot;AUX&quot;, L&quot;NUL&quot;,</span><br><span class="line">    L&quot;COM1&quot;, L&quot;COM2&quot;, L&quot;COM3&quot;, L&quot;COM4&quot;, L&quot;COM5&quot;, L&quot;COM6&quot;, L&quot;COM7&quot;, L&quot;COM8&quot;, L&quot;COM9&quot;,</span><br><span class="line">    L&quot;LPT1&quot;, L&quot;LPT2&quot;, L&quot;LPT3&quot;, L&quot;LPT4&quot;, L&quot;LPT5&quot;, L&quot;LPT6&quot;, L&quot;LPT7&quot;, L&quot;LPT8&quot;, L&quot;LPT9&quot;,</span><br><span class="line">    L&quot;CLOCK$&quot;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x901A;&#x8FC7; GetFileAttributesExW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#xFF0C;&#x5982;&#x679C;&#x6587;&#x4EF6;&#x5C5E;&#x4E8E;&#x8D85;&#x94FE;&#x63A5;&#x6216;&#x8005;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x518D;&#x901A;&#x8FC7; CreateFileW &#x51FD;&#x6570;&#x4E0E; GetFileInformationByHandle &#x51FD;&#x6570;&#x7EC4;&#x5408;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x5176;&#x4E2D; CreateFileW &#x51FD;&#x6570;&#x8981;&#x4F7F;&#x7528; OPEN_EXISTING &#x8868;&#x793A;&#x4EC5;&#x4EC5;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#x3002;&#x5F97;&#x5230;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#x540E;&#x901A;&#x8FC7;&#x4F4D;&#x7684;&#x6216;&#x64CD;&#x4F5C;&#x6765;&#x6807;&#x8BC6;&#x662F;&#x5426;&#x5B58;&#x5728;&#x3001;&#x662F;&#x5426;&#x6587;&#x4EF6;&#x3001;&#x662F;&#x5426;&#x76EE;&#x5F55;&#x3001;&#x662F;&#x5426;&#x9690;&#x85CF;&#x3002;</p>
<p>&#x6B64;&#x5916;&#x6709;&#x4E00;&#x4E2A;&#x7279;&#x4F8B;&#x4E5F;&#x9700;&#x8981;&#x5904;&#x7406;&#xFF0C;&#x5C31;&#x662F; pagefile.sys &#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x865A;&#x62DF;&#x5185;&#x5B58;&#xFF0C;&#x5B83;&#x662F;&#x6587;&#x4EF6;&#x800C;&#x4E0D;&#x662F;&#x76EE;&#x5F55;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;JNIEXPORT jint JNICALL</span><br><span class="line">Java_java_io_WinNTFileSystem_getBooleanAttributes(JNIEnv *env, jobject this,</span><br><span class="line">                                                  jobject file)</span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    jint rv = 0;</span><br><span class="line">    jint pathlen;</span><br><span class="line"></span><br><span class="line">#define SPECIALFILE_NAMELEN 12</span><br><span class="line"></span><br><span class="line">    WCHAR *pathbuf = fileToNTPath(env, file, ids.path);</span><br><span class="line">    WIN32_FILE_ATTRIBUTE_DATA wfad;</span><br><span class="line">    if (pathbuf == NULL)</span><br><span class="line">        return rv;</span><br><span class="line">    if (!isReservedDeviceNameW(pathbuf)) {</span><br><span class="line">        if (GetFileAttributesExW(pathbuf, GetFileExInfoStandard, &amp;wfad)) {</span><br><span class="line">            DWORD a = getFinalAttributesIfReparsePoint(pathbuf, wfad.dwFileAttributes);</span><br><span class="line">            if (a != INVALID_FILE_ATTRIBUTES) {</span><br><span class="line">                rv = (java_io_FileSystem_BA_EXISTS</span><br><span class="line">                    | ((a &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">                        ? java_io_FileSystem_BA_DIRECTORY</span><br><span class="line">                        : java_io_FileSystem_BA_REGULAR)</span><br><span class="line">                    | ((a &amp; FILE_ATTRIBUTE_HIDDEN)</span><br><span class="line">                        ? java_io_FileSystem_BA_HIDDEN : 0));</span><br><span class="line">            }</span><br><span class="line">        } else { </span><br><span class="line">            if (GetLastError() == ERROR_SHARING_VIOLATION) {</span><br><span class="line">                rv = java_io_FileSystem_BA_EXISTS;</span><br><span class="line">                if ((pathlen = (jint)wcslen(pathbuf)) &gt;= SPECIALFILE_NAMELEN &amp;&amp;</span><br><span class="line">                    (_wcsicmp(pathbuf + pathlen - SPECIALFILE_NAMELEN,</span><br><span class="line">                              L&quot;pagefile.sys&quot;) == 0) ||</span><br><span class="line">                    (_wcsicmp(pathbuf + pathlen - SPECIALFILE_NAMELEN,</span><br><span class="line">                              L&quot;hiberfil.sys&quot;) == 0))</span><br><span class="line">                  rv |= java_io_FileSystem_BA_REGULAR;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    free(pathbuf);</span><br><span class="line">    return rv;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="checkAccess&#x65B9;&#x6CD5;"><a href="#checkAccess&#x65B9;&#x6CD5;" class="headerlink" title="checkAccess&#x65B9;&#x6CD5;"></a>checkAccess&#x65B9;&#x6CD5;</h3><p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x4E3B;&#x8981;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5224;&#x65AD;&#x67D0;&#x4E2A;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#x3001;&#x662F;&#x5426;&#x53EF;&#x5199;&#x3001;&#x662F;&#x5426;&#x53EF;&#x6267;&#x884C;&#x3002;&#x8FD9;&#x91CC;&#x540C;&#x6837;&#x7528;&#x4F4D;&#x6807;&#x8BC6;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#xFF0C;&#x5206;&#x522B;&#x7528;<code>0x01&#x3001;0x02&#x3001;0x04</code>&#x8868;&#x793A;&#x53EF;&#x6267;&#x884C;&#x3001;&#x53EF;&#x5199;&#x3001;&#x53EF;&#x8BFB;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public native boolean checkAccess(File f, int access);</span><br></pre></td></tr></table></figure>

<p>&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x662F;&#x5148;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x8DEF;&#x5F84;&#xFF0C;&#x63A5;&#x7740;&#x901A;&#x8FC7; GetFileAttributesW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#xFF0C;&#x5982;&#x679C;&#x6587;&#x4EF6;&#x5C5E;&#x4E8E;&#x8D85;&#x94FE;&#x63A5;&#x6216;&#x8005;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x518D;&#x901A;&#x8FC7; CreateFileW &#x51FD;&#x6570;&#x4E0E; GetFileInformationByHandle &#x51FD;&#x6570;&#x7EC4;&#x5408;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x5176;&#x4E2D; CreateFileW &#x51FD;&#x6570;&#x8981;&#x4F7F;&#x7528; OPEN_EXISTING &#x8868;&#x793A;&#x4EC5;&#x4EC5;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x679C;&#x4E3A; INVALID_FILE_ATTRIBUTES &#x5219;&#x662F;&#x83B7;&#x53D6;&#x5931;&#x8D25;&#x4E86;&#xFF0C;&#x6B64;&#x65F6;&#x4EFB;&#x4F55;&#x6743;&#x9650;&#x90FD;&#x662F;&#x6CA1;&#x6709;&#x7684;&#x3002;&#x83B7;&#x53D6;&#x6210;&#x529F;&#x5219;&#x5F53;&#x5224;&#x65AD;&#x53EF;&#x8BFB;&#x6027;&#x548C;&#x53EF;&#x6267;&#x884C;&#x6027;&#x65F6;&#x90FD;&#x8FD4;&#x56DE;true&#xFF0C;&#x4F46;&#x68C0;&#x67E5;&#x53EF;&#x5199;&#x65F6;&#x5219;&#x8FD8;&#x8981;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x76EE;&#x5F55;&#xFF08;&#x76EE;&#x5F55;&#x76F4;&#x63A5;&#x53EF;&#x5199;&#xFF09;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x8981;&#x770B;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#x662F;&#x5426;&#x4E3A; FILE_ATTRIBUTE_READONLY&#xFF0C;&#x53EA;&#x8BFB;&#x7684;&#x8BDD;&#x5219;&#x4E0D;&#x53EF;&#x5199;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;JNIEXPORT jboolean</span><br><span class="line">JNICALL Java_java_io_WinNTFileSystem_checkAccess(JNIEnv *env, jobject this,</span><br><span class="line">                                                 jobject file, jint access)</span><br><span class="line">{</span><br><span class="line">    DWORD attr;</span><br><span class="line">    WCHAR *pathbuf = fileToNTPath(env, file, ids.path);</span><br><span class="line">    if (pathbuf == NULL)</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    attr = GetFileAttributesW(pathbuf);</span><br><span class="line">    attr = getFinalAttributesIfReparsePoint(pathbuf, attr);</span><br><span class="line">    free(pathbuf);</span><br><span class="line">    if (attr == INVALID_FILE_ATTRIBUTES)</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    switch (access) {</span><br><span class="line">    case java_io_FileSystem_ACCESS_READ:</span><br><span class="line">    case java_io_FileSystem_ACCESS_EXECUTE:</span><br><span class="line">        return JNI_TRUE;</span><br><span class="line">    case java_io_FileSystem_ACCESS_WRITE:</span><br><span class="line">        if ((attr &amp; FILE_ATTRIBUTE_DIRECTORY) ||</span><br><span class="line">            (attr &amp; FILE_ATTRIBUTE_READONLY) == 0)</span><br><span class="line">            return JNI_TRUE;</span><br><span class="line">        else</span><br><span class="line">            return JNI_FALSE;</span><br><span class="line">    default:</span><br><span class="line">        assert(0);</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="getLastModifiedTime&#x65B9;&#x6CD5;"><a href="#getLastModifiedTime&#x65B9;&#x6CD5;" class="headerlink" title="getLastModifiedTime&#x65B9;&#x6CD5;"></a>getLastModifiedTime&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x7684;&#x6700;&#x540E;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF0C;&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x5148;&#x83B7;&#x53D6; File &#x5BF9;&#x8C61;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x901A;&#x8FC7; CreateFileW &#x51FD;&#x6570;&#x548C; GetFileTime &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6700;&#x540E;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF0C;&#x5176;&#x4E2D; CreateFileW &#x51FD;&#x6570;&#x8981;&#x4F7F;&#x7528; OPEN_EXISTING &#x8868;&#x793A;&#x4EC5;&#x4EC5;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public native long getLastModifiedTime(File f);</span><br><span class="line"></span><br><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line">Java_java_io_WinNTFileSystem_getLastModifiedTime(JNIEnv *env, jobject this,</span><br><span class="line">                                                 jobject file)</span><br><span class="line">{</span><br><span class="line">    jlong rv = 0;</span><br><span class="line">    LARGE_INTEGER modTime;</span><br><span class="line">    FILETIME t;</span><br><span class="line">    HANDLE h;</span><br><span class="line">    WCHAR *pathbuf = fileToNTPath(env, file, ids.path);</span><br><span class="line">    if (pathbuf == NULL)</span><br><span class="line">        return rv;</span><br><span class="line">    h = CreateFileW(pathbuf,</span><br><span class="line">                    0,</span><br><span class="line">                    FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line">                    NULL,</span><br><span class="line">                    OPEN_EXISTING,</span><br><span class="line">                    FILE_FLAG_BACKUP_SEMANTICS,</span><br><span class="line">                    NULL);</span><br><span class="line">    if (h != INVALID_HANDLE_VALUE) {</span><br><span class="line">        if (GetFileTime(h, NULL, NULL, &amp;t)) {</span><br><span class="line">            modTime.LowPart = (DWORD) t.dwLowDateTime;</span><br><span class="line">            modTime.HighPart = (LONG) t.dwHighDateTime;</span><br><span class="line">            rv = modTime.QuadPart / 10000;</span><br><span class="line">            rv -= 11644473600000;</span><br><span class="line">        }</span><br><span class="line">        CloseHandle(h);</span><br><span class="line">    }</span><br><span class="line">    free(pathbuf);</span><br><span class="line">    return rv;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="getLength&#x65B9;&#x6CD5;"><a href="#getLength&#x65B9;&#x6CD5;" class="headerlink" title="getLength&#x65B9;&#x6CD5;"></a>getLength&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x65B9;&#x6CD5;&#x5FA1;&#x7528;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x6216;&#x76EE;&#x5F55;&#x7684;&#x957F;&#x5EA6;&#x3002;&#x903B;&#x8F91;&#x4E3A;&#xFF0C;</p>
<ol>
<li>&#x83B7;&#x53D6; File &#x5BF9;&#x8C61;&#x7684;&#x8DEF;&#x5F84;&#x3002;</li>
<li>&#x901A;&#x8FC7; GetFileAttributesExW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7; nFileSizeHigh &#x548C; nFileSizeLow &#x5F97;&#x5230;&#x6587;&#x4EF6;&#x7684;&#x957F;&#x5EA6;&#x3002;</li>
<li>&#x5982;&#x679C;&#x6587;&#x4EF6;&#x5C5E;&#x4E8E;&#x8D85;&#x94FE;&#x63A5;&#x6216;&#x8005;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x518D;&#x901A;&#x8FC7; CreateFileW &#x51FD;&#x6570;&#x4E0E; GetFileInformationByHandle &#x51FD;&#x6570;&#x7EC4;&#x5408;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x5176;&#x4E2D; CreateFileW &#x51FD;&#x6570;&#x8981;&#x4F7F;&#x7528; OPEN_EXISTING &#x8868;&#x793A;&#x4EC5;&#x4EC5;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7; nFileSizeHigh &#x548C; nFileSizeLow &#x5F97;&#x5230;&#x6587;&#x4EF6;&#x7684;&#x957F;&#x5EA6;&#x3002;</li>
<li>&#x5982;&#x679C;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5728;&#x4F7F;&#x7528;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x8BE5;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x62A5;&#x9519; ERROR_SHARING_VIOLATION&#xFF0C;&#x6B64;&#x65F6;&#x5C1D;&#x8BD5;&#x7528; _wstati64 &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x7684;&#x957F;&#x5EA6;&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801; public native long getLength(File f);</span><br><span class="line"></span><br><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line">Java_java_io_WinNTFileSystem_getLength(JNIEnv *env, jobject this, jobject file)</span><br><span class="line">{</span><br><span class="line">    jlong rv = 0;</span><br><span class="line">    WIN32_FILE_ATTRIBUTE_DATA wfad;</span><br><span class="line">    WCHAR *pathbuf = fileToNTPath(env, file, ids.path);</span><br><span class="line">    if (pathbuf == NULL)</span><br><span class="line">        return rv;</span><br><span class="line">    if (GetFileAttributesExW(pathbuf,</span><br><span class="line">                             GetFileExInfoStandard,</span><br><span class="line">                             &amp;wfad)) {</span><br><span class="line">        if ((wfad.dwFileAttributes &amp; FILE_ATTRIBUTE_REPARSE_POINT) == 0) {</span><br><span class="line">            rv = wfad.nFileSizeHigh * ((jlong)MAXDWORD + 1) + wfad.nFileSizeLow;</span><br><span class="line">        } else {</span><br><span class="line">            BY_HANDLE_FILE_INFORMATION finfo;</span><br><span class="line">            if (getFileInformation(pathbuf, &amp;finfo)) {</span><br><span class="line">                rv = finfo.nFileSizeHigh * ((jlong)MAXDWORD + 1) +</span><br><span class="line">                    finfo.nFileSizeLow;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } else {</span><br><span class="line">        if (GetLastError() == ERROR_SHARING_VIOLATION) {</span><br><span class="line">            struct _stati64 sb;</span><br><span class="line">            if (_wstati64(pathbuf, &amp;sb) == 0) {</span><br><span class="line">                rv = sb.st_size;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    free(pathbuf);</span><br><span class="line">    return rv;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="setPermission&#x65B9;&#x6CD5;"><a href="#setPermission&#x65B9;&#x6CD5;" class="headerlink" title="setPermission&#x65B9;&#x6CD5;"></a>setPermission&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8BBE;&#x7F6E; File &#x5BF9;&#x8C61;&#x7684;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x3002;&#x903B;&#x8F91;&#x5982;&#x4E0B;&#xFF0C;</p>
<ol>
<li>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x989D;&#x6743;&#x9650;&#x4E3A; ACCESS_READ &#x6216; ACCESS_EXECUTE&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;enable&#x3002;</li>
<li>&#x83B7;&#x53D6; File &#x5BF9;&#x8C61;&#x7684;&#x8DEF;&#x5F84;&#x3002;</li>
<li>&#x901A;&#x8FC7; GetFileAttributesW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#x3002;</li>
<li>&#x5982;&#x679C;&#x6587;&#x4EF6;&#x5C5E;&#x4E8E;&#x8D85;&#x94FE;&#x63A5;&#x6216;&#x8005;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;&#xFF0C;&#x5219;&#x5148;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6700;&#x7EC8;&#x8DEF;&#x5F84;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x7528; GetFileAttributesW &#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5C5E;&#x6027;&#x3002;</li>
<li>&#x5224;&#x65AD;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x76EE;&#x5F55;&#x7684;&#x8BDD;&#x5219;&#x6839;&#x636E;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;enable&#x8BBE;&#x7F6E;&#x5C5E;&#x6027;&#xFF0C;&#x5E76;&#x4E14;&#x901A;&#x8FC7; SetFileAttributesW &#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8BFB;&#x5199;&#x6743;&#x9650;&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;public native boolean setPermission(File f, int access, boolean enable,</span><br><span class="line">            boolean owneronly);</span><br><span class="line"></span><br><span class="line">JNIEXPORT jboolean JNICALL</span><br><span class="line">Java_java_io_WinNTFileSystem_setPermission(JNIEnv *env, jobject this,</span><br><span class="line">                                           jobject file,</span><br><span class="line">                                           jint access,</span><br><span class="line">                                           jboolean enable,</span><br><span class="line">                                           jboolean owneronly)</span><br><span class="line">{</span><br><span class="line">    jboolean rv = JNI_FALSE;</span><br><span class="line">    WCHAR *pathbuf;</span><br><span class="line">    DWORD a;</span><br><span class="line">    if (access == java_io_FileSystem_ACCESS_READ ||</span><br><span class="line">        access == java_io_FileSystem_ACCESS_EXECUTE) {</span><br><span class="line">        return enable;</span><br><span class="line">    }</span><br><span class="line">    pathbuf = fileToNTPath(env, file, ids.path);</span><br><span class="line">    if (pathbuf == NULL)</span><br><span class="line">        return JNI_FALSE;</span><br><span class="line">    a = GetFileAttributesW(pathbuf);</span><br><span class="line"></span><br><span class="line">    if ((a != INVALID_FILE_ATTRIBUTES) &amp;&amp;</span><br><span class="line">        ((a &amp; FILE_ATTRIBUTE_REPARSE_POINT) != 0))</span><br><span class="line">    {</span><br><span class="line">        WCHAR *fp = getFinalPath(env, pathbuf);</span><br><span class="line">        if (fp == NULL) {</span><br><span class="line">            a = INVALID_FILE_ATTRIBUTES;</span><br><span class="line">        } else {</span><br><span class="line">            free(pathbuf);</span><br><span class="line">            pathbuf = fp;</span><br><span class="line">            a = GetFileAttributesW(pathbuf);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    if ((a != INVALID_FILE_ATTRIBUTES) &amp;&amp;</span><br><span class="line">        ((a &amp; FILE_ATTRIBUTE_DIRECTORY) == 0))</span><br><span class="line">    {</span><br><span class="line">        if (enable)</span><br><span class="line">            a =  a &amp; ~FILE_ATTRIBUTE_READONLY;</span><br><span class="line">        else</span><br><span class="line">            a =  a | FILE_ATTRIBUTE_READONLY;</span><br><span class="line">        if (SetFileAttributesW(pathbuf, a))</span><br><span class="line">            rv = JNI_TRUE;</span><br><span class="line">    }</span><br><span class="line">    free(pathbuf);</span><br><span class="line">    return rv;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE5;&#x4E0B;&#x662F;<strong><em>&#x5E7F;&#x544A;</em></strong>&#x548C;<strong><em>&#x76F8;&#x5173;&#x9605;&#x8BFB;</em></strong></p>
<p>========&#x5E7F;&#x544A;&#x65F6;&#x95F4;========</p>
<p>&#x9119;&#x4EBA;&#x7684;&#x65B0;&#x4E66;&#x300A;Tomcat&#x5185;&#x6838;&#x8BBE;&#x8BA1;&#x5256;&#x6790;&#x300B;&#x5DF2;&#x7ECF;&#x5728;&#x4EAC;&#x4E1C;&#x9500;&#x552E;&#x4E86;&#xFF0C;&#x6709;&#x9700;&#x8981;&#x7684;&#x670B;&#x53CB;&#x53EF;&#x4EE5;&#x5230; <a href="/external_links/f595bc3995af2e5f462672d39500238d.html" target="blank" rel="noopener">item.jd.com/12185360.ht&#x2026;</a> &#x8FDB;&#x884C;&#x9884;&#x5B9A;&#x3002;&#x611F;&#x8C22;&#x5404;&#x4F4D;&#x670B;&#x53CB;&#x3002;</p>
<p><a href="/external_links/1054677517988dca01f26bb397d50624.html" target="blank" rel="noopener">&#x4E3A;&#x4EC0;&#x4E48;&#x5199;&#x300A;Tomcat&#x5185;&#x6838;&#x8BBE;&#x8BA1;&#x5256;&#x6790;&#x300B;</a></p>
<p>=========================</p>
<p>&#x76F8;&#x5173;&#x9605;&#x8BFB;&#xFF1A;</p>
<p><a href="/external_links/81ffc7be5928b5be9872c364d9d95f55.html" target="blank" rel="noopener">JDK&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;FileSystem&#xFF08;Windows&#xFF09;&#x4E0A;&#x7BC7;</a></p>
<p>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/45c488056f371451c91549de71082f085eb0795c9b0a1a447b8aca5cdf43c311" alt="&#x8FD9;&#x91CC;&#x5199;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x8FD9;&#x91CC;&#x5199;&#x56FE;&#x7247;&#x63CF;&#x8FF0;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/5cea826361bd82fa36a4b125a51dd4473776cc66a4d921bd0eea1193a259ed96" alt="&#x8FD9;&#x91CC;&#x5199;&#x56FE;&#x7247;&#x63CF;&#x8FF0;"></p>
<p>&#x8FD9;&#x91CC;&#x5199;&#x56FE;&#x7247;&#x63CF;&#x8FF0;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/ff14e8eeb2797283ab1e38eeed11329d.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512405442567.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512405442567.html" itemprop="url">SpringMvc4x高级配置(五) Spring MVC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-20T07:18:05+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/dd9bad57dd6e5a51ecd88569611df838fd5b433d00ebb23a1c2e19360d95578c" alt></p>
<h2 id="&#x4E00;-&#x70B9;&#x775B;"><a href="#&#x4E00;-&#x70B9;&#x775B;" class="headerlink" title="&#x4E00;. &#x70B9;&#x775B;"></a>&#x4E00;. &#x70B9;&#x775B;</h2><p>&#x6D4B;&#x8BD5;&#x662F;&#x4FDD;&#x8BC1;&#x8F6F;&#x4EF6;&#x8D28;&#x91CF;&#x7684;&#x5173;&#x952E;&#xFF0C;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x8BB2;&#x89E3;&#x4E2D;&#x53EA;&#x662F;&#x4ECB;&#x7ECD;&#x4E86;&#x7B80;&#x5355;&#x7684;&#x6D4B;&#x8BD5;&#xFF0C;&#x4E0B;&#x9762;&#x8981;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x548C;<code>Spring</code> <code>MVC</code>&#x76F8;&#x5173;&#x7684;&#x6D4B;&#x8BD5;&#xFF0C;&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x63A7;&#x5236;&#x5668;&#x7684;&#x6D4B;&#x8BD5;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x6D4B;&#x8BD5;<code>Web</code>&#x9879;&#x76EE;&#x901A;&#x5E38;&#x4E0D;&#x9700;&#x8981;&#x542F;&#x52A8;&#x9879;&#x76EE;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E9B;<code>Servlet</code>&#x76F8;&#x5173;&#x7684;&#x6A21;&#x62DF;&#x5BF9;&#x8C61;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;<code>MockMVC</code>&#xFF0C;<code>MockHttpServletRequest</code>&#xFF0C;<code>MockHttpServletResponse</code>&#xFF0C;<code>MockHttpSession</code>&#x7B49;&#x3002;</p>
<p>&#x5728;<code>Spring</code>&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<code>@WebAppConfiguration</code>&#x6307;&#x5B9A;&#x52A0;&#x8F7D;&#x7684;<code>ApplicationContext</code>&#x662F;&#x4E00;&#x4E2A;<code>WebAppConfiguration</code>&#x3002;</p>
<p>&#x5728;&#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x91CC;&#x9762;&#x501F;&#x52A9;<code>JUnit</code>&#x548C;<code>Spring TestContext framework</code>&#xFF0C;&#x5206;&#x522B;&#x6F14;&#x793A;&#x5BF9;&#x666E;&#x901A;&#x9875;&#x9762;&#x8F6C;&#x5411;&#x5F62;&#x63A7;&#x5236;&#x5668;&#x548C;<code>RestController</code>&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x3002;</p>
<h2 id="&#x4E8C;-&#x793A;&#x4F8B;&#xFF1A;"><a href="#&#x4E8C;-&#x793A;&#x4F8B;&#xFF1A;" class="headerlink" title="&#x4E8C;. &#x793A;&#x4F8B;&#xFF1A;"></a>&#x4E8C;. &#x793A;&#x4F8B;&#xFF1A;</h2><ol>
<li>&#x6D4B;&#x8BD5;&#x4F9D;&#x8D56;</li>
</ol>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;        &lt;!-- spring-test --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;${spring-framework.version}&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- junit --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.11&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;"><a href="#&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;" class="headerlink" title="&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;"></a>&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;</h2><blockquote>
<p>&#x8FD9;&#x91CC;<code>&lt;scope&gt;test&lt;/scope&gt;</code>&#x8BF4;&#x660E;&#x8FD9;&#x4E9B;&#x5305;&#x7684;&#x5B58;&#x6D3B;&#x662F;&#x5728;<code>test</code>&#x5468;&#x671F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x610F;&#x5473;&#x7740;&#x53D1;&#x5E03;&#x65F6;&#x6211;&#x4EEC;&#x5C06;&#x4E0D;&#x5305;&#x542B;&#x8FD9;&#x4E9B;<code>jar</code>&#x5305;&#x3002;</p>
</blockquote>
<ol start="2">
<li>&#x6F14;&#x793A;&#x670D;&#x52A1;&#xFF1A;</li>
</ol>
<hr>
<p>&#x5728;<code>src/main/java</code>&#x4E0B;&#x65B0;&#x589E;<code>DemoService</code> &#x7C7B;&#xFF0C;<strong>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;package org.light4j.springMvc4.service;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class DemoService {</span><br><span class="line"></span><br><span class="line">    public String saySomething(){</span><br><span class="line">        return &quot;hello&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;</li>
</ol>
<hr>
<p>&#x5728;<code>src/test/java</code>&#x4E0B;&#x65B0;&#x5EFA;<code>TestControllerIntegrationTests</code>&#x7C7B;&#xFF0C;<strong>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;package org.light4j.springMvc4.web;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.forwardedUrl;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.model;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.view;</span><br><span class="line"></span><br><span class="line">import org.junit.Before;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.light4j.springMvc4.MyMvcConfig;</span><br><span class="line">import org.light4j.springMvc4.service.DemoService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.mock.web.MockHttpServletRequest;</span><br><span class="line">import org.springframework.mock.web.MockHttpSession;</span><br><span class="line">import org.springframework.test.context.ContextConfiguration;</span><br><span class="line">import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line">import org.springframework.test.context.web.WebAppConfiguration;</span><br><span class="line">import org.springframework.test.web.servlet.MockMvc;</span><br><span class="line">import org.springframework.test.web.servlet.setup.MockMvcBuilders;</span><br><span class="line">import org.springframework.web.context.WebApplicationContext;</span><br><span class="line"></span><br><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(classes = {MyMvcConfig.class})</span><br><span class="line">@WebAppConfiguration(&quot;src/main/resources&quot;) //&#x2460;</span><br><span class="line">public class TestControllerIntegrationTests {</span><br><span class="line">    private MockMvc mockMvc; //&#x2461;</span><br><span class="line"></span><br><span class="line">   @Autowired</span><br><span class="line">   private DemoService demoService;//&#x2462;</span><br><span class="line"></span><br><span class="line">   @Autowired </span><br><span class="line">   WebApplicationContext wac; //&#x2463;</span><br><span class="line"></span><br><span class="line">    @Autowired </span><br><span class="line">    MockHttpSession session; //&#x2464;</span><br><span class="line"></span><br><span class="line">    @Autowired </span><br><span class="line">    MockHttpServletRequest request; //&#x2465;</span><br><span class="line"></span><br><span class="line">    @Before //7</span><br><span class="line">    public void setup() {</span><br><span class="line">        mockMvc =</span><br><span class="line">                MockMvcBuilders.webAppContextSetup(this.wac).build(); //&#x2461;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testNormalController() throws Exception{</span><br><span class="line">        mockMvc.perform(get(&quot;/normal&quot;)) //&#x2467;</span><br><span class="line">                .andExpect(status().isOk())//&#x2468;</span><br><span class="line">                .andExpect(view().name(&quot;page&quot;))//&#x2469;</span><br><span class="line">                .andExpect(forwardedUrl(&quot;/WEB-INF/classes/views/page.jsp&quot;))//11</span><br><span class="line">                .andExpect(model().attribute(&quot;msg&quot;, demoService.saySomething()));//12</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testRestController() throws Exception{</span><br><span class="line">        mockMvc.perform(get(&quot;/testRest&quot;)) //13</span><br><span class="line">        .andExpect(status().isOk())</span><br><span class="line">         .andExpect(content().contentType(&quot;text/plain;charset=UTF-8&quot;))//14</span><br><span class="line">        .andExpect(content().string(demoService.saySomething()));//15</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;-1"><a href="#&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;-1" class="headerlink" title="&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;"></a>&#x4EE3;&#x7801;&#x89E3;&#x91CA;&#xFF1A;</h2><blockquote>
<p>&#x2460; <code>@WebAppConfiguration</code>&#x6CE8;&#x89E3;&#x5728;&#x7C7B;&#x4E0A;&#xFF0C;&#x7528;&#x6765;&#x58F0;&#x660E;&#x52A0;&#x8F7D;&#x7684;<code>ApplicationContext</code>&#x662F;&#x4E00;&#x4E2A;<code>WebApplicationContext</code>&#x3002;&#x5B83;&#x7684;&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x7684;&#x662F;<code>Web</code>&#x8D44;&#x6E90;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;<code>src/main/webapp</code>,&#x672C;&#x4F8B;&#x4FEE;&#x6539;&#x4E3A;<code>src/main/resource</code>&#x3002;<br> &#x2461; <code>MockMvc</code>&#x6A21;&#x62DF;<code>MVC</code>&#x5BF9;&#x8C61;&#xFF0C;&#x901A;&#x8FC7;<code>MockMvcBuilders.webAppContextSetup(this.wac).build()</code>&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x3002;<br> &#x2462; &#x53EF;&#x4EE5;&#x5728;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x4E2D;&#x6CE8;&#x5165;<code>Spring</code>&#x7684;<code>Bean</code>&#x3002;<br> &#x2463; &#x53EF;&#x6CE8;&#x5165;<code>WebApplicationContext</code>&#x3002;<br> &#x2464; &#x53EF;&#x6CE8;&#x5165;&#x6A21;&#x62DF;&#x7684;<code>http session</code>&#xFF0C;&#x6B64;&#x5904;&#x4EC5;&#x4F5C;&#x6F14;&#x793A;&#xFF0C;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x3002;<br> &#x2465; &#x53EF;&#x6CE8;&#x5165;&#x6A21;&#x62DF;&#x7684;<code>http request</code>&#xFF0C;&#x6B64;&#x5904;&#x4EC5;&#x4F5C;&#x6F14;&#x793A;&#xFF0C;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x3002;<br> &#x2466; <code>@Before</code> &#x5728;&#x6D4B;&#x8BD5;&#x5F00;&#x59CB;&#x524D;&#x8FDB;&#x884C;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#x3002;<br> &#x2467; &#x6A21;&#x62DF;&#x5411;<code>/normal</code>&#x8FDB;&#x884C;<code>get</code>&#x8BF7;&#x6C42;&#x3002;<br> &#x2468; &#x9884;&#x671F;&#x63A7;&#x5236;&#x8FD4;&#x56DE;&#x72B6;&#x6001;&#x4E3A;<code>200</code>.<br> &#x2469; &#x9884;&#x671F;<code>view</code>&#x7684;&#x540D;&#x79F0;&#x4E3A;<code>page</code>&#x3002;<br> 11 &#x9884;&#x671F;&#x9875;&#x9762;&#x8F6C;&#x5411;&#x7684;&#x771F;&#x6B63;&#x8DEF;&#x5F84;&#x4E3A;<code>/WEB-INF/classes/views/page.jsp</code>&#x3002;<br> 12 &#x9884;&#x671F;<code>model</code>&#x91CC;&#x9762;&#x7684;&#x503C;&#x662F;<code>demoService.saySomething()</code>&#x8FD4;&#x56DE;&#x503C;<code>hello</code>&#x3002;<br> 13.&#x6A21;&#x62DF;&#x5411;<code>/testRest</code>&#x8FDB;&#x884C;<code>get</code>&#x8BF7;&#x6C42;&#x3002;<br> 14 &#x9884;&#x671F;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x5A92;&#x4F53;&#x7C7B;&#x578B;&#x662F;<code>text/plain;charset=UTF-8</code>&#x3002;<br> 15 &#x9884;&#x671F;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x5185;&#x5BB9;&#x4E3A;<code>demoService.saySomething()</code>&#x8FD4;&#x56DE;&#x503C;<code>hello</code>&#x3002;</p>
</blockquote>
<p>&#x6B64;&#x65F6;&#xFF0C;&#x8FD0;&#x884C;&#x8BE5;&#x6D4B;&#x8BD5;&#xFF0C;<strong>&#x6548;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</strong><br> <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/6d809945e71bbecd7b411b20c12128739eeaee4d114c494206ea0456a8b8215c" alt="xxx"></p>
<ol start="4">
<li>&#x7F16;&#x5199;&#x666E;&#x901A;&#x63A7;&#x5236;&#x5668;</li>
</ol>
<hr>
<p>&#x5728;<code>src/main/java</code>&#x4E0B;&#x65B0;&#x589E;<code>NormalController</code> &#x7C7B;&#xFF0C;<strong>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;package org.light4j.springMvc4.web;</span><br><span class="line"></span><br><span class="line">import org.light4j.springMvc4.service.DemoService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.ui.Model;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class NormalController {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    DemoService demoService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/normal&quot;)</span><br><span class="line">    public  String testPage(Model model){</span><br><span class="line">        model.addAttribute(&quot;msg&quot;, demoService.saySomething());</span><br><span class="line">        return &quot;page&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>&#x7F16;&#x5199;&#x666E;&#x901A;&#x63A7;&#x5236;&#x5668;&#x7684;&#x6F14;&#x793A;&#x9875;&#x9762;</li>
</ol>
<hr>
<p>&#x5728;<code>src/main/resources/view</code>&#x4E0B;&#x65B0;&#x5EFA;<code>page.jsp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;</span><br><span class="line">    pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;Test page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;pre&gt;</span><br><span class="line">        Welcome to Spring MVC world</span><br><span class="line">    &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>&#x7F16;&#x5199;RestController&#x63A7;&#x5236;&#x5668;</li>
</ol>
<hr>
<p>&#x5728;<code>src/main/java</code>&#x4E0B;&#x65B0;&#x589E;<code>RestController</code>&#x7C7B;&#xFF0C;<strong>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;package org.light4j.springMvc4.web;</span><br><span class="line"></span><br><span class="line">import org.light4j.springMvc4.service.DemoService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class MyRestController {</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    DemoService demoService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/testRest&quot; ,produces=&quot;text/plain;charset=UTF-8&quot;)</span><br><span class="line">    public @ResponseBody String testRest(){</span><br><span class="line">        return demoService.saySomething();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>&#x8FD0;&#x884C;&#x6D4B;&#x8BD5;</li>
</ol>
<hr>
<p><strong>&#x6548;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</strong><br> <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/2899612dab12cc241a94680fe9824bc485e93852f54f4617feb60897cc146cd1" alt="xxx"></p>
<h2 id="&#x4E09;-&#x6E90;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#xFF1A;"><a href="#&#x4E09;-&#x6E90;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#xFF1A;" class="headerlink" title="&#x4E09;. &#x6E90;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#xFF1A;"></a>&#x4E09;. &#x6E90;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#xFF1A;</h2><blockquote>
<p><code>github</code>&#x5730;&#x5740;&#xFF1A;<a href="/external_links/52a6cc988ba9ca6a44c36089ee814e55.html" target="blank" rel="noopener">&#x70B9;&#x51FB;&#x67E5;&#x770B;</a><br> &#x7801;&#x4E91;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/7c5e009076de21957c4407cfe2ff51cc.html" target="blank" rel="noopener">&#x70B9;&#x51FB;&#x67E5;&#x770B;</a></p>
</blockquote>
<p><a href="/external_links/e94a0bfceb5172f503f7c819f9c8a17e.html" target="blank" rel="noopener">&#x6253;&#x8D4F;</a> <strong>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x4EBA;&#x751F;&#x8BBE;&#x8BA1;&#x5E08;&#x7684;&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x8D26;&#x53F7;</strong><br> <strong>&#x516C;&#x4F17;&#x53F7;ID&#xFF1A;longjiazuoA</strong> <img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/2acb01ef64a935cd2dcd1469910a1a95379daf550df3ac4ae44648dc2db6b2ec" alt>  </p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/655696470fd551198faa3e3fdd5d1719.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../6844903512359305223.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../6844903512359305223.html" itemprop="url">Docker的那点事儿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-19T19:59:32+08:00">
                2017-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Docker&#x662F;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#Docker&#x662F;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="Docker&#x662F;&#x4EC0;&#x4E48;&#xFF1F;"></a>Docker&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</h3><hr>
<p>Docker&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x8F7B;&#x91CF;&#x7EA7;&#x865A;&#x62DF;&#x5316;&#x6280;&#x672F;&#x7684;&#x5BB9;&#x5668;&#xFF0C;&#x6574;&#x4E2A;&#x9879;&#x76EE;&#x57FA;&#x4E8E;Go&#x8BED;&#x8A00;&#x5F00;&#x53D1;&#xFF0C;&#x5E76;&#x91C7;&#x7528;&#x4E86;Apache 2.0&#x534F;&#x8BAE;&#x3002;Docker&#x53EF;&#x4EE5;&#x5C06;&#x6211;&#x4EEC;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6253;&#x5305;&#x5C01;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;&#x8BE5;&#x5BB9;&#x5668;&#x5305;&#x542B;&#x4E86;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4EE3;&#x7801;&#x3001;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x3001;&#x4F9D;&#x8D56;&#x5E93;&#x3001;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7B49;&#x5FC5;&#x9700;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x901A;&#x8FC7;&#x5BB9;&#x5668;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x65B9;&#x4FBF;&#x5FEB;&#x901F;&#x5E76;&#x4E14;&#x4E0E;&#x5E73;&#x53F0;&#x89E3;&#x8026;&#x7684;&#x81EA;&#x52A8;&#x5316;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#xFF0C;&#x65E0;&#x8BBA;&#x4F60;&#x90E8;&#x7F72;&#x65F6;&#x7684;&#x73AF;&#x5883;&#x5982;&#x4F55;&#xFF0C;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x4F1A;&#x8FD0;&#x884C;&#x5728;&#x540C;&#x4E00;&#x79CD;&#x73AF;&#x5883;&#x4E0B;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x6817;&#x5B50;&#xFF0C;&#x5C0F;&#x660E;&#x5199;&#x4E86;&#x4E00;&#x4E2A;CMS&#x7CFB;&#x7EDF;&#xFF0C;&#x8BE5;&#x7CFB;&#x7EDF;&#x7684;&#x6280;&#x672F;&#x6808;&#x975E;&#x5E38;&#x5E7F;&#xFF0C;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x5E93;&#x548C;&#x4E2D;&#x95F4;&#x4EF6;&#x3002;&#x5982;&#x679C;&#x6309;&#x7167;&#x7EAF;&#x624B;&#x52A8;&#x7684;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#xFF0C;&#x5C0F;&#x660E;&#x9700;&#x8981;&#x5B89;&#x88C5;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x8F6F;&#x4EF6;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5199;&#x597D;&#x6BCF;&#x4E2A;&#x5F00;&#x6E90;&#x8F6F;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;&#x5982;&#x679C;&#x53EA;&#x662F;&#x90E8;&#x7F72;&#x4E00;&#x6B21;&#xFF0C;&#x8FD9;&#x70B9;&#x65F6;&#x95F4;&#x5F00;&#x9500;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x7684;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x5C0F;&#x660E;&#x6BCF;&#x9694;&#x51E0;&#x5929;&#x5C31;&#x9700;&#x8981;&#x6362;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x53BB;&#x90E8;&#x7F72;&#x4ED6;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E9B;&#x7E41;&#x7410;&#x7684;&#x91CD;&#x590D;&#x5DE5;&#x4F5C;&#x65E0;&#x7591;&#x662F;&#x4F1A;&#x4EE4;&#x4EBA;&#x53D1;&#x72C2;&#x7684;&#x3002;&#x8FD9;&#x65F6;&#x5019;&#xFF0C;Docker&#x7684;&#x7528;&#x5904;&#x5C31;&#x6D3E;&#x4E0A;&#x573A;&#x4E86;&#xFF0C;&#x5C0F;&#x660E;&#x53EA;&#x9700;&#x8981;&#x6839;&#x636E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x90E8;&#x7F72;&#x6B65;&#x9AA4;&#x7F16;&#x5199;&#x4E00;&#x4EFD;Dockerfile&#x6587;&#x4EF6;&#xFF08;&#x5C06;&#x5B89;&#x88C5;&#x3001;&#x914D;&#x7F6E;&#x7B49;&#x64CD;&#x4F5C;&#x4EA4;&#x7531;Docker&#x81EA;&#x52A8;&#x5316;&#x5904;&#x7406;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x6784;&#x5EFA;&#x5E76;&#x53D1;&#x5E03;&#x4ED6;&#x7684;&#x955C;&#x50CF;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x4E0D;&#x7BA1;&#x5728;&#x4EC0;&#x4E48;&#x673A;&#x5668;&#x4E0A;&#xFF0C;&#x5C0F;&#x660E;&#x90FD;&#x53EA;&#x9700;&#x8981;&#x62C9;&#x53D6;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x955C;&#x50CF;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x90E8;&#x7F72;&#x8FD0;&#x884C;&#x4E86;&#xFF0C;&#x8FD9;&#x6B63;&#x662F;Docker&#x7684;&#x9B45;&#x529B;&#x6240;&#x5728;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x955C;&#x50CF;&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x955C;&#x50CF;&#x662F;Docker&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x6982;&#x5FF5;&#xFF1A;</p>
<ul>
<li>Image&#xFF08;&#x955C;&#x50CF;&#xFF09;&#xFF1A;&#x5B83;&#x7C7B;&#x4F3C;&#x4E8E;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x4F7F;&#x7528;&#x5230;&#x7684;&#x955C;&#x50CF;&#xFF0C;&#x7531;&#x4E8E;&#x4EFB;&#x4F55;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x9700;&#x8981;&#x6709;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;Image&#x5C31;&#x662F;&#x7528;&#x6765;&#x63D0;&#x4F9B;&#x6240;&#x9700;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#x7684;&#x4E00;&#x4E2A;&#x6A21;&#x677F;&#x3002;</li>
<li>Container&#xFF08;&#x5BB9;&#x5668;&#xFF09;&#xFF1A;Container&#x662F;Docker&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x5C42;&#xFF0C;&#x5B83;&#x5C31;&#x50CF;&#x4E00;&#x4E2A;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x6C99;&#x76D2;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E86;&#x4E00;&#x4E2A;&#x6781;&#x7B80;&#x7684;Linux&#x7CFB;&#x7EDF;&#x73AF;&#x5883;&#x4E0E;&#x8FD0;&#x884C;&#x5728;&#x5176;&#x4E2D;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;Container&#x662F;Image&#x7684;&#x8FD0;&#x884C;&#x5B9E;&#x4F8B;&#xFF08;Image&#x672C;&#x8EAB;&#x662F;&#x53EA;&#x8BFB;&#x7684;&#xFF0C;Container&#x542F;&#x52A8;&#x65F6;&#xFF0C;Docker&#x4F1A;&#x5728;Image&#x7684;&#x4E0A;&#x5C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x53EF;&#x5199;&#x5C42;&#xFF0C;&#x4EFB;&#x4F55;&#x5728;Container&#x4E2D;&#x7684;&#x4FEE;&#x6539;&#x90FD;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5230;Image&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8981;&#x5728;Image&#x4FDD;&#x5B58;Container&#x4E2D;&#x7684;&#x4FEE;&#x6539;&#xFF0C;Docker&#x91C7;&#x7528;&#x4E86;&#x57FA;&#x4E8E;Container&#x751F;&#x6210;&#x65B0;&#x7684;Image&#x5C42;&#x7684;&#x7B56;&#x7565;&#xFF09;&#xFF0C;Docker&#x5F15;&#x64CE;&#x5229;&#x7528;Container&#x6765;&#x64CD;&#x4F5C;&#x5E76;&#x9694;&#x79BB;&#x6BCF;&#x4E2A;&#x5E94;&#x7528;&#xFF08;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6BCF;&#x4E2A;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x5E94;&#x7528;&#x90FD;&#x662F;&#x4E92;&#x76F8;&#x72EC;&#x7ACB;&#x7684;&#xFF09;&#x3002;</li>
</ul>
<p>&#x5176;&#x5B9E;&#x4ECE;Docker&#x4E0E;Container&#x7684;&#x82F1;&#x6587;&#x5355;&#x8BCD;&#x539F;&#x610F;&#x4E2D;&#x5C31;&#x53EF;&#x4EE5;&#x4F53;&#x4F1A;&#x51FA;Docker&#x7684;&#x601D;&#x60F3;&#x3002;Container&#x53EF;&#x4EE5;&#x91CA;&#x4E49;&#x4E3A;&#x96C6;&#x88C5;&#x7BB1;&#xFF0C;&#x96C6;&#x88C5;&#x7BB1;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x4FBF;&#x4E8E;&#x673A;&#x68B0;&#x8BBE;&#x5907;&#x88C5;&#x5378;&#x7684;&#x5C01;&#x88C5;&#x8D27;&#x7269;&#x7684;&#x901A;&#x7528;&#x6807;&#x51C6;&#x89C4;&#x683C;&#xFF0C;&#x5B83;&#x7684;&#x53D1;&#x660E;&#x7B80;&#x5316;&#x4E86;&#x7269;&#x6D41;&#x8FD0;&#x8F93;&#x7684;&#x673A;&#x68B0;&#x5316;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F7F;&#x5176;&#x5EFA;&#x7ACB;&#x8D77;&#x4E86;&#x4E00;&#x5957;&#x6807;&#x51C6;&#x5316;&#x7684;&#x7269;&#x6D41;&#x8FD0;&#x8F93;&#x4F53;&#x7CFB;&#x3002;&#x800C;Docker&#x7684;&#x610F;&#x601D;&#x4E3A;&#x7801;&#x5934;&#x5DE5;&#x4EBA;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#xFF0C;Docker&#x5C31;&#x50CF;&#x662F;&#x5728;&#x7801;&#x5934;&#x4E0A;&#x8F9B;&#x52E4;&#x5DE5;&#x4F5C;&#x7684;&#x5DE5;&#x4EBA;&#xFF0C;&#x628A;&#x5E94;&#x7528;&#x6253;&#x5305;&#x6210;&#x4E00;&#x4E2A;&#x4E2A;&#x5177;&#x6709;&#x67D0;&#x79CD;&#x6807;&#x51C6;&#x5316;&#x89C4;&#x683C;&#x7684;&#x201D;&#x96C6;&#x88C5;&#x7BB1;&#x201D;&#xFF08;&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x6307;&#x51FA;&#x7684;&#x96C6;&#x88C5;&#x7BB1;&#x5BF9;&#x5E94;&#x7684;&#x662F;Image&#xFF0C;&#x5728;Docker&#x4E2D;Container&#x66F4;&#x50CF;&#x662F;&#x4E00;&#x4E2A;&#x8FD0;&#x884C;&#x4E2D;&#x7684;&#x6C99;&#x76D2;&#xFF09;&#xFF0C;&#x5F53;&#x8D27;&#x7269;&#x8FD0;&#x8F93;&#x5230;&#x76EE;&#x7684;&#x5730;&#x540E;&#xFF0C;&#x7801;&#x5934;&#x5DE5;&#x4EBA;&#x4EEC;&#xFF08;Docker&#xFF09;&#x5C31;&#x53EF;&#x4EE5;&#x628A;&#x96C6;&#x88C5;&#x7BB1;&#x62C6;&#x5F00;&#x53D6;&#x51FA;&#x5176;&#x4E2D;&#x7684;&#x8D27;&#x7269;&#xFF08;&#x57FA;&#x4E8E;Image&#x6765;&#x521B;&#x5EFA;Container&#x5E76;&#x8FD0;&#x884C;&#xFF09;&#x3002;&#x8FD9;&#x79CD;&#x6807;&#x51C6;&#x5316;&#x4E0E;&#x9694;&#x79BB;&#x6027;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x5730;&#x7EC4;&#x5408;&#x4F7F;&#x7528;&#x591A;&#x4E2A;Image&#x6765;&#x6784;&#x5EFA;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x73AF;&#x5883;&#xFF08;Docker&#x4E5F;&#x63D0;&#x5021;&#x6BCF;&#x4E2A;Image&#x90FD;&#x9075;&#x5FAA;&#x5355;&#x4E00;&#x804C;&#x8D23;&#x539F;&#x5219;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x53EA;&#x505A;&#x597D;&#x4E00;&#x4EF6;&#x4E8B;&#xFF09;&#xFF0C;&#x6216;&#x8005;&#x4E0E;&#x5176;&#x4ED6;&#x4EBA;&#x5171;&#x4EAB;&#x4F60;&#x7684;Image&#x3002;</p>
<blockquote>
<p>&#x672C;&#x6587;&#x4F5C;&#x8005;&#x4E3A;<a href="/external_links/5b52fd82daec1d99f5e4ee652dfe1afd.html" target="blank" rel="noopener">SylvanasSun(sylvanas.sun@gmail.com)</a>&#xFF0C;&#x9996;&#x53D1;&#x4E8E;<a href="/external_links/ee05ddcd09d6517ffe37ca3b1f17bb6d.html" target="blank" rel="noopener">SylvanasSun&#x2019;s Blog</a>&#x3002;<br>&#x539F;&#x6587;&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/4959705a6445aa38c3c6067148b7d8ac.html" target="blank" rel="noopener">sylvanassun.github.io/2017/11/19/&#x2026;</a><br>&#xFF08;&#x8F6C;&#x8F7D;&#x8BF7;&#x52A1;&#x5FC5;&#x4FDD;&#x7559;&#x672C;&#x6BB5;&#x58F0;&#x660E;&#xFF0C;&#x5E76;&#x4E14;&#x4FDD;&#x7559;&#x8D85;&#x94FE;&#x63A5;&#x3002;&#xFF09;</p>
</blockquote>
<h3 id="Docker-VS-&#x865A;&#x62DF;&#x673A;"><a href="#Docker-VS-&#x865A;&#x62DF;&#x673A;" class="headerlink" title="Docker VS &#x865A;&#x62DF;&#x673A;"></a>Docker VS &#x865A;&#x62DF;&#x673A;</h3><hr>
<p>&#x5728;&#x4E0A;&#x6587;&#x4E2D;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x4E86;Docker&#x662F;&#x57FA;&#x4E8E;&#x8F7B;&#x91CF;&#x7EA7;&#x865A;&#x62DF;&#x5316;&#x6280;&#x672F;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x4E0E;&#x6211;&#x4EEC;&#x5E73;&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x865A;&#x62DF;&#x673A;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x3002;&#x865A;&#x62DF;&#x673A;&#x6280;&#x672F;&#x53EF;&#x4EE5;&#x5206;&#x6210;&#x4EE5;&#x4E0B;&#x4E24;&#x7C7B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/ff99f050ebb10b13a144e72c59a29ac75e34492b88c3afb9d2dc87ccfcfb7698" alt="&#x7CFB;&#x7EDF;&#x865A;&#x62DF;&#x673A;"></p>
<p>&#x7CFB;&#x7EDF;&#x865A;&#x62DF;&#x673A;</p>
<ul>
<li>&#x7CFB;&#x7EDF;&#x865A;&#x62DF;&#x673A;&#xFF1A;&#x901A;&#x8FC7;&#x8F6F;&#x4EF6;&#x5BF9;&#x8BA1;&#x7B97;&#x673A;&#x7CFB;&#x7EDF;&#x7684;&#x6A21;&#x62DF;&#x6765;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x8BA1;&#x7B97;&#x673A;&#x7684;&#x66FF;&#x4EE3;&#x54C1;&#x3002;&#x5B83;&#x662F;&#x7269;&#x7406;&#x786C;&#x4EF6;&#x7684;&#x62BD;&#x8C61;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;&#x8FD0;&#x884C;&#x5B8C;&#x6574;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6240;&#x9700;&#x7684;&#x529F;&#x80FD;&#x3002;&#x865A;&#x62DF;&#x673A;&#x901A;&#x8FC7;&#x7269;&#x7406;&#x673A;&#x5668;&#x6765;&#x7BA1;&#x7406;&#x548C;&#x5171;&#x4EAB;&#x786C;&#x4EF6;&#xFF0C;&#x8FD9;&#x6837;&#x5B9E;&#x73B0;&#x4E86;&#x591A;&#x4E2A;&#x865A;&#x62DF;&#x673A;&#x73AF;&#x5883;&#x5F7C;&#x6B64;&#x4E4B;&#x95F4;&#x7684;&#x9694;&#x79BB;&#xFF0C;&#x4E00;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x591A;&#x4E2A;&#x865A;&#x62DF;&#x673A;&#xFF0C;&#x6BCF;&#x4E2A;&#x865A;&#x62DF;&#x673A;&#x5305;&#x62EC;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x5B8C;&#x6574;&#x526F;&#x672C;&#x3002;&#x5728;&#x7CFB;&#x7EDF;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#xFF0C;&#x6240;&#x8FD0;&#x884C;&#x7684;&#x6240;&#x6709;&#x8F6F;&#x4EF6;&#x6216;&#x64CD;&#x4F5C;&#x90FD;&#x53EA;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x8BE5;&#x865A;&#x62DF;&#x673A;&#x7684;&#x73AF;&#x5883;&#x3002;&#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684;VMWare&#x5C31;&#x662F;&#x7CFB;&#x7EDF;&#x865A;&#x62DF;&#x673A;&#x7684;&#x5B9E;&#x73B0;&#x3002;</li>
<li>&#x7A0B;&#x5E8F;&#x865A;&#x62DF;&#x673A;&#xFF1A;&#x5141;&#x8BB8;&#x7A0B;&#x5E8F;&#x72EC;&#x7ACB;&#x8FD0;&#x884C;&#x5728;&#x5E73;&#x53F0;&#x4E4B;&#x5916;&#x3002;&#x6BD4;&#x8F83;&#x5178;&#x578B;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x662F;JVM&#xFF0C;Java&#x901A;&#x8FC7;JVM&#x8FD9;&#x4E00;&#x62BD;&#x8C61;&#x5C42;&#x4F7F;&#x5F97;Java&#x7A0B;&#x5E8F;&#x4E0E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x548C;&#x786C;&#x4EF6;&#x5E73;&#x53F0;&#x89E3;&#x8026;&#xFF08;&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;Java&#x7A0B;&#x5E8F;&#x90FD;&#x662F;&#x8FD0;&#x884C;&#x5728;JVM&#x4E2D;&#x7684;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x5B9E;&#x73B0;&#x4E86;&#x6240;&#x8C13;&#x7684;compile once, run everywhere&#x3002;</li>
</ul>
<p>Docker&#x6240;&#x7528;&#x5230;&#x7684;&#x6280;&#x672F;&#x4E0E;&#x4E0A;&#x8FF0;&#x4E24;&#x79CD;&#x90FD;&#x4E0D;&#x76F8;&#x540C;&#xFF0C;&#x5B83;&#x4F7F;&#x7528;&#x4E86;&#x66F4;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x865A;&#x62DF;&#x5316;&#x6280;&#x672F;&#xFF0C;&#x591A;&#x4E2A;Container&#x5171;&#x4EAB;&#x4E86;&#x540C;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#xFF0C;&#x5E76;&#x4E14;&#x5C31;&#x50CF;&#x8FD0;&#x884C;&#x5728;&#x672C;&#x5730;&#x4E0A;&#x4E00;&#x6837;&#x3002;Container&#x6280;&#x672F;&#x76F8;&#x5BF9;&#x4E8E;&#x865A;&#x62DF;&#x673A;&#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C42;&#x7684;&#x62BD;&#x8C61;&#xFF0C;&#x5B83;&#x5C06;&#x4EE3;&#x7801;&#x4E0E;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x6253;&#x5305;&#x5230;&#x4E00;&#x8D77;&#xFF0C;&#x591A;&#x4E2A;Container&#x53EF;&#x4EE5;&#x5728;&#x540C;&#x4E00;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x8FD0;&#x884C;&#xFF08;&#x610F;&#x5473;&#x7740;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x673A;&#x4E0A;&#x4E5F;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x591A;&#x4E2A;Container&#xFF09;&#xFF0C;&#x5E76;&#x4E0E;&#x5176;&#x5B83;Container&#x5171;&#x4EAB;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;Container&#x90FD;&#x5728;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x4E2D;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;&#xFF0C;&#x8FD9;&#x4E9B;&#x7279;&#x6027;&#x90FD;&#x8BC1;&#x660E;&#x4E86;Container&#x8981;&#x6BD4;&#x865A;&#x62DF;&#x673A;&#x66F4;&#x52A0;&#x7075;&#x6D3B;&#x4E0E;&#x8F7B;&#x91CF;&#xFF08;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x7ED3;&#x5408;&#x865A;&#x62DF;&#x673A;&#x4E0E;Docker&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#xFF09;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/1e01e57f4653537be5740b84557938f44c8a8556cde441af54f72e8787fd8e2a" alt></p>
<p>Container&#x6280;&#x672F;&#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x662F;&#x4E2A;&#x65B0;&#x9C9C;&#x4E8B;&#x7269;&#xFF0C;&#x6700;&#x65E9;&#x53EF;&#x4EE5;&#x8FFD;&#x6EAF;&#x5230;UNIX&#x4E2D;&#x7684;chroot&#xFF08;&#x5728;1979&#x5E74;&#x7684;V7 Unix&#x4E2D;&#x5F15;&#x5165;&#xFF09;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x6539;&#x53D8;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#x53CA;&#x5176;&#x5B50;&#x76EE;&#x5F55;&#x7684;&#x6839;&#x76EE;&#x5F55;&#xFF0C;&#x5728;&#x8FD9;&#x79CD;&#x4FEE;&#x6539;&#x8FC7;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#x8FD0;&#x884C;&#x7684;&#x7A0B;&#x5E8F;&#x4E0D;&#x80FD;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x76EE;&#x5F55;&#x6811;&#x4E4B;&#x5916;&#x8BBF;&#x95EE;&#x6587;&#x4EF6;&#xFF0C;&#x4ECE;&#x800C;&#x9650;&#x5236;&#x7528;&#x6237;&#x7684;&#x6D3B;&#x52A8;&#x8303;&#x56F4;&#xFF0C;&#x4E3A;&#x8FDB;&#x7A0B;&#x63D0;&#x4F9B;&#x4E86;&#x9694;&#x79BB;&#x7A7A;&#x95F4;&#x3002;</p>
<p>&#x4E4B;&#x540E;&#x5404;&#x79CD;Unix&#x7248;&#x672C;&#x6D8C;&#x73B0;&#x51FA;&#x5F88;&#x591A;Container&#x6280;&#x672F;&#xFF0C;&#x5728;2006&#x5E74;&#xFF0C;Google&#x63D0;&#x51FA;&#x4E86;&#x201D;Process Containers&#x201D;&#x671F;&#x671B;&#x5728;Linux&#x5185;&#x6838;&#x4E2D;&#x5B9E;&#x73B0;&#x8FDB;&#x7A0B;&#x8D44;&#x6E90;&#x9694;&#x79BB;&#x7684;&#x76F8;&#x5173;&#x7279;&#x6027;&#xFF0C;&#x7531;&#x4E8E;Container&#x5728;Linux&#x5185;&#x6838;&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#x8FC7;&#x4E8E;&#x5BBD;&#x6CDB;&#x6DF7;&#x4E71;&#xFF0C;&#x540E;&#x6765;&#x8BE5;&#x9879;&#x76EE;&#x6539;&#x540D;&#x4E3A;CGroups&#xFF08;Control Groups&#xFF09;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x5BF9;&#x8FDB;&#x7A0B;&#x7684;&#x8D44;&#x6E90;&#x9650;&#x5236;&#x3002;</p>
<p>2008&#x5E74;&#xFF0C;LXC&#xFF08;Linux Containers&#xFF09;&#x53D1;&#x5E03;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x79CD;&#x5728;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5C42;&#x7EA7;&#x4E0A;&#x7684;&#x865A;&#x62DF;&#x5316;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x4E8E;&#x5728;Linux&#x7CFB;&#x7EDF;&#x4E0A;&#x901A;&#x8FC7;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x6765;&#x8FD0;&#x884C;&#x591A;&#x4E2A;&#x4E92;&#x76F8;&#x9694;&#x79BB;&#x7684;&#x7A0B;&#x5E8F;&#xFF08;Container&#xFF09;&#x3002;LXC&#x6B63;&#x662F;&#x7ED3;&#x5408;&#x4E86;Linux&#x5185;&#x6838;&#x4E2D;&#x7684;CGroups&#x548C;&#x5BF9;&#x5206;&#x79BB;&#x7684;&#x540D;&#x79F0;&#x7A7A;&#x95F4;&#x7684;&#x652F;&#x6301;&#x6765;&#x4E3A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9694;&#x79BB;&#x7684;&#x73AF;&#x5883;&#x3002;&#x800C;Docker&#x4E5F;&#x662F;&#x57FA;&#x4E8E;LXC&#x5B9E;&#x73B0;&#x7684;&#xFF08;Docker&#x7684;&#x524D;&#x8EAB;&#x662F;dotClound&#x516C;&#x53F8;&#x4E2D;&#x7684;&#x5185;&#x90E8;&#x9879;&#x76EE;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x5BB6;&#x63D0;&#x4F9B;PaaS&#x670D;&#x52A1;&#x7684;&#x516C;&#x53F8;&#x3002;&#xFF09;&#xFF0C;&#x5E76;&#x4F5C;&#x51FA;&#x4E86;&#x8BB8;&#x591A;&#x6539;&#x8FDB;&#x3002;</p>
<h3 id="&#x4F7F;&#x7528;Docker"><a href="#&#x4F7F;&#x7528;Docker" class="headerlink" title="&#x4F7F;&#x7528;Docker"></a>&#x4F7F;&#x7528;Docker</h3><hr>
<p>&#x5728;&#x4F7F;&#x7528;Docker&#x4E4B;&#x524D;&#x4F60;&#x9700;&#x8981;&#x5148;&#x5B89;&#x88C5;Docker&#xFF08;&#x8FD9;&#x597D;&#x50CF;&#x662F;&#x4E00;&#x53E5;&#x5E9F;&#x8BDD;&#x3002;&#x3002;&#x3002;&#xFF09;&#xFF0C;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5E73;&#x53F0;&#x5B89;&#x88C5;&#x65B9;&#x6CD5;&#x90FD;&#x4E0D;&#x76F8;&#x540C;&#xFF0C;&#x53EF;&#x4EE5;&#x53BB;&#x53C2;&#x8003;<a href="/external_links/47fe57ed485bd5d3faa72d391dce002e.html" target="blank" rel="noopener">Install Docker | Docker Documentation</a>&#x6216;&#x8005;&#x81EA;&#x884C;Google&#x3002;</p>
<p>&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#x4E4B;&#x540E;&#xFF0C;&#x8F93;&#x5165;<code>docker --version</code>&#x6765;&#x786E;&#x8BA4;&#x662F;&#x5426;&#x5B89;&#x88C5;&#x6210;&#x529F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;$ docker --version</span><br><span class="line">Docker version 17.05.0-ce-rc1, build 2878a85</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;<a href="/external_links/939085619eb0ae46b4cc41c488483967.html" target="blank" rel="noopener">Docker Hub</a>&#x4E2D;&#x53EF;&#x4EE5;pull&#x5230;&#x5176;&#x4ED6;&#x4EBA;&#x53D1;&#x5E03;&#x7684;Image&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x8D26;&#x53F7;&#x53BB;&#x53D1;&#x5E03;&#x81EA;&#x5DF1;&#x7684;Image&#x4E0E;&#x4ED6;&#x4EBA;&#x5171;&#x4EAB;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;[root@Jack ~]# docker search redis # &#x67E5;&#x770B;redis&#x955C;&#x50CF;&#x662F;&#x5426;&#x5B58;&#x5728;</span><br><span class="line">[root@Jack ~]# docker pull redis # &#x62C9;&#x53D6;redis&#x955C;&#x50CF;&#x5230;&#x672C;&#x673A;</span><br><span class="line">Using default tag: latest</span><br><span class="line">Trying to pull repository docker.io/library/redis ... </span><br><span class="line">latest: Pulling from docker.io/library/redis</span><br><span class="line">Digest: sha256:cd277716dbff2c0211c8366687d275d2b53112fecbf9d6c86e9853edb0900956</span><br><span class="line">[root@Jack ~]# docker images # &#x67E5;&#x770B;&#x955C;&#x50CF;&#x4FE1;&#x606F;</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/python    3.6-onbuild         7195f9298ffb        2 weeks ago         691.1 MB</span><br><span class="line">docker.io/mongo     latest              d22888af0ce0        2 weeks ago         360.9 MB</span><br><span class="line">docker.io/redis     latest              8f2e175b3bd1        2 weeks ago         106.6 MB</span><br></pre></td></tr></table></figure>

<p>&#x6709;&#x4E86;Image&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x5728;&#x5176;&#x4E4B;&#x4E0A;&#x8FD0;&#x884C;&#x4E00;&#x4E2A;Container&#x4E86;&#xFF0C;&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;[root@Jack ~]# docker run -d -p 6379:6379 redis # &#x8FD0;&#x884C;redis&#xFF0C;-p&#x4EE3;&#x8868;&#x5C06;&#x672C;&#x673A;&#x4E0A;6379&#x7AEF;&#x53E3;&#x6620;&#x5C04;&#x5230;Container&#x7684;6379&#x7AEF;&#x53E3; -d&#x4EE3;&#x8868;&#x5728;&#x540E;&#x53F0;&#x542F;&#x52A8;</span><br><span class="line">[root@Jack ~]# docker ps -a # &#x67E5;&#x770B;&#x5BB9;&#x5668;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x52A0;-a&#x53EA;&#x4F1A;&#x663E;&#x793A;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x4E2D;&#x7684;&#x5BB9;&#x5668;</span><br><span class="line"># &#x5982;&#x679C;&#x60F3;&#x8981;&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;</span><br><span class="line">[root@Jack ~]# docker ps # &#x5148;&#x83B7;&#x5F97;&#x5BB9;&#x5668;&#x7684;id</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">1f928073b7eb        redis               &quot;docker-entrypoint.sh&quot;   45 seconds ago      Up 44 seconds       0.0.0.0:6379-&gt;6379/tcp   desperate_khorana</span><br><span class="line">[root@Jack ~]# docker exec -it 1f928073b7eb /bin/bash # &#x7136;&#x540E;&#x518D;&#x6267;&#x884C;&#x8BE5;&#x547D;&#x4EE4;&#x8FDB;&#x5165;&#x5230;&#x5BB9;&#x5668;&#x4E2D;</span><br><span class="line">root@1f928073b7eb:/data# touch hello_docker.txt # &#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;</span><br><span class="line">root@1f928073b7eb:/data# exit # &#x9000;&#x51FA;</span><br><span class="line">exit</span><br><span class="line">[root@Jack ~]# </span><br><span class="line"># &#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x76F4;&#x63A5;&#x8FDB;&#x5165; &#x547D;&#x4EE4;&#x5982;&#x4E0B;</span><br><span class="line">[root@Jack ~]# docker run -d -it -p 6379:6379 redis /bin/bash</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x5BF9;Container&#x505A;&#x51FA;&#x4E86;&#x4FEE;&#x6539;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8981;&#x4FDD;&#x7559;&#x8FD9;&#x4E2A;&#x4FEE;&#x6539;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;commit&#x547D;&#x4EE4;&#x6765;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Image&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;# -m&#x4E3A;&#x63CF;&#x8FF0;&#x4FE1;&#x606F; -a&#x4E3A;&#x4F5C;&#x8005; 1f9&#x662F;&#x4F60;&#x8981;&#x4FDD;&#x5B58;&#x7684;&#x5BB9;&#x5668;id &#x53D6;&#x524D;3&#x4E2A;&#x5B57;&#x7B26; docker&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x8BC6;&#x522B;</span><br><span class="line"># sylvanassun/redis&#x4E3A;&#x955C;&#x50CF;&#x540D; :test &#x4E3A;&#x4E00;&#x4E2A;tag &#x4E00;&#x822C;&#x7528;&#x4E8E;&#x6807;&#x8BC6;&#x7248;&#x672C;</span><br><span class="line">[root@Jack ~]# docker commit -m &quot;test&quot; -a &quot;SylvanasSun&quot; 1f9 sylvanassun/redis:test</span><br><span class="line">sha256:e7073e8e5bd70b8d58092fd6bd8c2551e65dd29241c235eddf2a7f4b4b25cbbd</span><br><span class="line">[root@Jack ~]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">sylvanassun/redis   test                e7073e8e5bd7        2 seconds ago       106.6 MB</span><br><span class="line">docker.io/python    3.6-onbuild         7195f9298ffb        2 weeks ago         691.1 MB</span><br><span class="line">docker.io/mongo     latest              d22888af0ce0        2 weeks ago         360.9 MB</span><br><span class="line">docker.io/redis     latest              8f2e175b3bd1        2 weeks ago         106.6 MB</span><br></pre></td></tr></table></figure>

<p>&#x60F3;&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;&#x6216;&#x955C;&#x50CF;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x5728;&#x5220;&#x9664;&#x955C;&#x50CF;&#x524D;&#x9700;&#x8981;&#x5148;&#x5220;&#x9664;&#x4F9D;&#x8D56;&#x4E8E;&#x5B83;&#x7684;&#x5BB9;&#x5668;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;[root@Jack ~]# docker stop 1f9 # &#x5173;&#x95ED;&#x8FD0;&#x884C;&#x4E2D;&#x7684;&#x5BB9;&#x5668;&#xFF0C;&#x76F8;&#x5E94;&#x7684;&#x4E5F;&#x6709;docker start id&#x547D;&#x4EE4;&#x6765;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;</span><br><span class="line">1f9</span><br><span class="line">[root@Jack ~]# docker rm 1f9 # &#x5220;&#x9664;&#x5BB9;&#x5668;</span><br><span class="line">1f9</span><br><span class="line">[root@Jack ~]# docker rmi e70 # &#x5220;&#x9664;&#x4E0A;&#x9762;&#x4FDD;&#x5B58;&#x7684;&#x955C;&#x50CF;</span><br><span class="line">Untagged: sylvanassun/redis:test</span><br><span class="line">Deleted: sha256:e7073e8e5bd70b8d58092fd6bd8c2551e65dd29241c235eddf2a7f4b4b25cbbd</span><br><span class="line">Deleted: sha256:751db4a870e5f703082b31c1614a19c86e0c967334a61f5d22b2511072aef56d</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x679C;&#x60F3;&#x8981;&#x81EA;&#x5DF1;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x955C;&#x50CF;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x7F16;&#x5199;Dockerfile&#x6587;&#x4EF6;&#xFF0C;&#x8BE5;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x4E86;&#x955C;&#x50CF;&#x7684;&#x4F9D;&#x8D56;&#x73AF;&#x5883;&#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x73AF;&#x5883;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;# &#x4F7F;&#x7528;python:2.7-slim &#x4F5C;&#x4E3A;&#x7236;&#x955C;&#x50CF;</span><br><span class="line">FROM python:2.7-slim</span><br><span class="line"></span><br><span class="line"># &#x8DF3;&#x8F6C;&#x5230;/app &#x5176;&#x5B9E;&#x5C31;&#x662F;cd&#x547D;&#x4EE4;</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"># &#x5C06;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x7684;&#x5185;&#x5BB9;(.)&#x590D;&#x5236;&#x5230;&#x955C;&#x50CF;&#x7684;/app&#x76EE;&#x5F55;&#x4E0B;</span><br><span class="line">ADD . /app</span><br><span class="line"></span><br><span class="line"># RUN&#x4EE3;&#x8868;&#x8FD0;&#x884C;&#x7684;shell&#x547D;&#x4EE4;&#xFF0C;&#x4E0B;&#x9762;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#x662F;&#x6839;&#x636E;requirements.txt&#x5B89;&#x88C5;python&#x5E94;&#x7528;&#x7684;&#x4F9D;&#x8D56;&#x5305;</span><br><span class="line">RUN pip install --trusted-host pypi.python.org -r requirements.txt</span><br><span class="line"></span><br><span class="line"># &#x66B4;&#x9732;80&#x7AEF;&#x53E3;&#x8BA9;&#x5916;&#x754C;&#x8BBF;&#x95EE;</span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line"># &#x5B9A;&#x4E49;&#x73AF;&#x5883;&#x53D8;&#x91CF;</span><br><span class="line">ENV NAME World</span><br><span class="line"></span><br><span class="line"># &#x5F53;&#x5BB9;&#x5668;&#x542F;&#x52A8;&#x65F6;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;&#xFF0C;&#x5B83;&#x4E0E;RUN&#x4E0D;&#x540C;&#xFF0C;&#x53EA;&#x5728;&#x5BB9;&#x5668;&#x542F;&#x52A8;&#x65F6;&#x6267;&#x884C;&#x4E00;&#x6B21;</span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br></pre></td></tr></table></figure>

<p>&#x7136;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>docker build -t xxx/xxxx .</code>&#x547D;&#x4EE4;&#x6765;&#x6784;&#x5EFA;&#x955C;&#x50CF;&#xFF0C;<code>-t</code>&#x540E;&#x9762;&#x662F;&#x955C;&#x50CF;&#x540D;&#x4E0E;tag&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x6CE8;&#x610F;<code>.</code>&#x8868;&#x793A;&#x5728;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x4E0B;&#x5BFB;&#x627E;Dockerfile&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5B66;&#x4F1A;&#x5982;&#x4F55;&#x6784;&#x5EFA;&#x81EA;&#x5DF1;&#x7684;&#x955C;&#x50CF;&#x4E4B;&#x540E;&#xFF0C;&#x4F60;&#x662F;&#x5426;&#x4E5F;&#x60F3;&#x5C06;&#x5B83;&#x53D1;&#x5E03;&#x5230;<a href="/external_links/939085619eb0ae46b4cc41c488483967.html" target="blank" rel="noopener">Docker Hub</a>&#x4E0A;&#x4E0E;&#x4ED6;&#x4EBA;&#x5206;&#x4EAB;&#x5462;&#xFF1F;&#x8981;&#x60F3;&#x505A;&#x5230;&#x8FD9;&#x4E00;&#x70B9;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;<a href="/external_links/939085619eb0ae46b4cc41c488483967.html" target="blank" rel="noopener">Docker Hub</a>&#x8D26;&#x53F7;&#xFF0C;&#x4E4B;&#x540E;&#x901A;&#x8FC7;<code>docker login</code>&#x547D;&#x4EE4;&#x767B;&#x5F55;&#xFF0C;&#x7136;&#x540E;&#x518D;<code>docker push image name</code>&#xFF0C;&#x5C31;&#x50CF;&#x5728;&#x4F7F;&#x7528;Git&#x4E00;&#x6837;&#x7B80;&#x5355;&#x3002;</p>
<p>&#x5173;&#x4E8E;Docker&#x7684;&#x66F4;&#x591A;&#x547D;&#x4EE4;&#x4E0E;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;&#x8BF7;&#x53C2;&#x8003;<a href="/external_links/df79dce6c14ba39e68ae4f23f8105818.html" target="blank" rel="noopener">Docker Documentation | Docker Documentation</a>&#xFF0C;&#x53E6;&#x5916;&#x6211;&#x8FD8;&#x63A8;&#x8350;&#x4F7F;&#x7528;<a href="/external_links/b290a7295e2f3753bd8c2d0761a6a41f.html" target="blank" rel="noopener">Docker Compose</a>&#x6765;&#x6784;&#x5EFA;&#x955C;&#x50CF;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x5730;&#x7EC4;&#x5408;&#x7BA1;&#x7406;&#x591A;&#x4E2A;&#x955C;&#x50CF;&#x3002;</p>
<h3 id="&#x7ED3;&#x8BED;"><a href="#&#x7ED3;&#x8BED;" class="headerlink" title="&#x7ED3;&#x8BED;"></a>&#x7ED3;&#x8BED;</h3><hr>
<p>Docker&#x63D0;&#x4F9B;&#x4E86;&#x975E;&#x5E38;&#x5F3A;&#x5927;&#x7684;&#x81EA;&#x52A8;&#x5316;&#x90E8;&#x7F72;&#x65B9;&#x5F0F;&#x4E0E;&#x7075;&#x6D3B;&#x6027;&#xFF0C;&#x5BF9;&#x591A;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E4B;&#x95F4;&#x505A;&#x5230;&#x4E86;&#x89E3;&#x8026;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x5F00;&#x53D1;&#x4E0A;&#x7684;&#x654F;&#x6377;&#x6027;&#x3001;&#x53EF;&#x63A7;&#x6027;&#x4EE5;&#x53CA;&#x53EF;&#x79FB;&#x690D;&#x6027;&#x3002;&#x540C;&#x65F6;&#xFF0C;Docker&#x4E5F;&#x5728;&#x4E0D;&#x65AD;&#x5730;&#x5E2E;&#x52A9;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#x7684;&#x4F01;&#x4E1A;&#x5B9E;&#x73B0;&#x4E86;&#x5411;&#x4E91;&#x7AEF;&#x8FC1;&#x79FB;&#x3001;&#x5411;&#x5FAE;&#x670D;&#x52A1;&#x8F6C;&#x578B;&#x4EE5;&#x53CA;&#x5411;DevOps&#x6A21;&#x5F0F;&#x7684;&#x5B9E;&#x8DF5;&#x3002;</p>
<p>&#x5982;&#x4ECA;&#xFF0C;&#x5FAE;&#x670D;&#x52A1;&#x4E0E;DevOps&#x706B;&#x7206;&#x7A0B;&#x5EA6;&#x65E5;&#x76CA;&#x6E10;&#x9AD8;&#xFF0C;&#x4F60;&#x53C8;&#x6709;&#x4F55;&#x7406;&#x7531;&#x9009;&#x62E9;&#x62D2;&#x7EDD;Docker&#x5462;&#xFF1F;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x9009;&#x62E9;&#x62E5;&#x62B1;Docker&#xFF0C;&#x62E5;&#x62B1;&#x672A;&#x6765;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/a53168ade50751ea8a6e5d20ef838dab.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../284/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../284/">284</a><span class="page-number current">285</span><a class="page-number" href="../286/">286</a><span class="space">&hellip;</span><a class="page-number" href="../298/">298</a><a class="extend next" rel="next" href="../286/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">2975</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1162</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
