<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/75/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/75/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340865231379628041.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340865231379628041.html" itemprop="url">一文带你理解什么是分布式事务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-29T19:23:29+08:00">
                2024-02-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x4E4B;&#x524D;&#x5728;&#x670B;&#x53CB;&#x5708;&#x770B;&#x5230;&#x6709;&#x5927;&#x4F6C;&#x63A8;&#x8350;&#x300A;&#x5FAE;&#x670D;&#x52A1;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x300B;&#x4E00;&#x4E66;&#xFF0C;&#x9646;&#x9646;&#x7EED;&#x7EED;&#x82B1;&#x4E86;&#x6570;&#x4E2A;&#x6708;&#x9605;&#x8BFB;&#x5B8C;&#x6210;&#xFF0C;&#x662F;&#x4E00;&#x672C;&#x975E;&#x5E38;&#x503C;&#x5F97;&#x540E;&#x7AEF;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x9605;&#x8BFB;&#x7684;&#x4E66;&#x7C4D;&#xFF0C;&#x91CC;&#x9762;&#x4ECE;&#x5206;&#x5E03;&#x5F0F;&#x5F00;&#x59CB;&#xFF0C;&#x4E00;&#x76F4;&#x8BB2;&#x5230;&#x5FAE;&#x670D;&#x52A1;&#x67B6;&#x6784;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF0C;&#x865A;&#x62DF;&#x5316;&#xFF0C;&#x4E8B;&#x4EF6;&#x6EAF;&#x6E90;&#x5F00;&#x53D1;&#x7B49;&#x7B49;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x670B;&#x53CB;&#x53EF;&#x4EE5;&#x4E70;&#x6765;&#x770B;&#x770B;&#x3002;</p>
<p>&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x6458;&#x81EA;&#x6B64;&#x4E66;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7AE0;&#x8282;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x5219;&#x662F;&#x7B14;&#x8005;&#x7684;&#x7406;&#x89E3;&#x548C;&#x7F51;&#x4E0A;&#x641C;&#x96C6;&#x7684;&#x65B9;&#x6848;&#x3002;</p>
<p>&#x5728;&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x8BB2;&#x4E00;&#x4E2A;&#x5C0F;&#x6545;&#x4E8B;&#x3002;</p>
<p>&#x5728;&#x4E00;&#x4E2A;&#x53E4;&#x8001;&#x7684;&#x68EE;&#x6797;&#x91CC;&#xFF0C;&#x4F4F;&#x7740;&#x5404;&#x79CD;&#x5404;&#x6837;&#x7684;&#x5C0F;&#x52A8;&#x7269;&#x3002;&#x5B83;&#x4EEC;&#x548C;&#x8C10;&#x76F8;&#x5904;&#xFF0C;&#x4F46;&#x6709;&#x4E00;&#x5929;&#xFF0C;&#x4E00;&#x53EA;&#x53EB;&#x505A;&#x5C0F;&#x677E;&#x9F20;&#x7684;&#x5C0F;&#x52A8;&#x7269;&#xFF0C;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x6BCF;&#x6B21;&#x5B83;&#x4EEC;&#x8981;&#x4E00;&#x8D77;&#x7B56;&#x5212;&#x4E00;&#x573A;&#x5927;&#x578B;&#x7684;&#x665A;&#x5BB4;&#x65F6;&#xFF0C;&#x603B;&#x662F;&#x53D1;&#x751F;&#x6DF7;&#x4E71;&#xFF0C;&#x56E0;&#x4E3A;&#x98DF;&#x6750;&#x3001;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x7B49;&#x4E8B;&#x52A1;&#x65E0;&#x6CD5;&#x5F88;&#x597D;&#x5730;&#x534F;&#x540C;&#x3002;</p>
<p>&#x4E8E;&#x662F;&#xFF0C;&#x5C0F;&#x677E;&#x9F20;&#x51B3;&#x5B9A;&#x53EC;&#x96C6;&#x68EE;&#x6797;&#x91CC;&#x7684;&#x5C0F;&#x52A8;&#x7269;&#x4EEC;&#x5F00;&#x4E86;&#x4E00;&#x6B21;&#x7D27;&#x6025;&#x4F1A;&#x8BAE;&#xFF0C;&#x8BA8;&#x8BBA;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x5728;&#x4F1A;&#x8BAE;&#x4E0A;&#xFF0C;&#x5404;&#x79CD;&#x5C0F;&#x52A8;&#x7269;&#x90FD;&#x7EB7;&#x7EB7;&#x53D1;&#x8A00;&#xFF0C;&#x63D0;&#x51FA;&#x4E86;&#x5404;&#x81EA;&#x7684;&#x5EFA;&#x8BAE;&#x3002;</p>
<p>&#x5C0F;&#x677E;&#x9F20;&#x8BF4;&#xFF1A;&#x201C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x5206;<strong>&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7684;&#x601D;&#x7EF4;&#xFF0C;&#x786E;&#x4FDD;&#x6BCF;&#x4E2A;&#x73AF;&#x8282;&#x90FD;&#x80FD;&#x534F;&#x540C;&#x5DE5;&#x4F5C;</strong>&#xFF0C;&#x4EE5;&#x4FDD;&#x8BC1;&#x6211;&#x4EEC;&#x7684;&#x665A;&#x5BB4;&#x80FD;&#x591F;&#x6210;&#x529F;&#x3002;&#x201D;</p>
<p>&#x8001;&#x72D0;&#x72F8;&#x63D0;&#x51FA;&#xFF1A;&#x201C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x665A;&#x5BB4;&#x7684;&#x7B79;&#x5907;&#x8FC7;&#x7A0B;&#x5206;&#x4E3A;&#x51E0;&#x4E2A;&#x9636;&#x6BB5;&#xFF0C;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7531;&#x4E0D;&#x540C;&#x7684;&#x5C0F;&#x52A8;&#x7269;&#x8D1F;&#x8D23;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x5C31;&#x50CF;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x786E;&#x8BA4;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x624D;&#x80FD;&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x9636;&#x6BB5;&#x3002;&#x201D;</p>
<p>&#x5C0F;&#x677E;&#x9F20;&#x70B9;&#x5934;&#x79F0;&#x8D5E;&#x9053;&#xFF1A;&#x201C;&#x8FD9;&#x4E2A;&#x4E3B;&#x610F;&#x4E0D;&#x9519;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x6574;&#x4E2A;&#x7B79;&#x5907;&#x8FC7;&#x7A0B;&#x5206;&#x4E3A;&#x91C7;&#x8D2D;&#x3001;&#x51C6;&#x5907;&#x3001;&#x70F9;&#x996A;&#x548C;&#x5E03;&#x7F6E;&#x7B49;&#x51E0;&#x4E2A;&#x9636;&#x6BB5;&#x3002;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7531;&#x4E0D;&#x540C;&#x7684;&#x5C0F;&#x52A8;&#x7269;&#x56E2;&#x961F;&#x8D1F;&#x8D23;&#x3002;&#x201D;</p>
<p>&#x4E8E;&#x662F;&#xFF0C;&#x5C0F;&#x5154;&#x5B50;&#x8D1F;&#x8D23;&#x98DF;&#x6750;&#x91C7;&#x8D2D;&#xFF0C;&#x5C0F;&#x718A;&#x8D1F;&#x8D23;&#x7B79;&#x5907;&#x5DE5;&#x4F5C;&#xFF0C;&#x5C0F;&#x72F8;&#x732B;&#x8D1F;&#x8D23;&#x70F9;&#x996A;&#xFF0C;&#x800C;&#x5C0F;&#x9E7F;&#x8D1F;&#x8D23;&#x5E03;&#x7F6E;&#x73B0;&#x573A;&#x3002;&#x6BCF;&#x4E2A;&#x5C0F;&#x52A8;&#x7269;&#x56E2;&#x961F;&#x5728;&#x5B8C;&#x6210;&#x81EA;&#x5DF1;&#x7684;&#x4EFB;&#x52A1;&#x540E;&#xFF0C;&#x90FD;&#x4F1A;&#x5411;&#x5176;&#x4ED6;&#x56E2;&#x961F;&#x53D1;&#x9001;&#x901A;&#x77E5;&#xFF0C;&#x8868;&#x793A;&#x81EA;&#x5DF1;&#x7684;&#x4EFB;&#x52A1;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#xFF0C;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x9636;&#x6BB5;&#x3002;</p>
<p>&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x6574;&#x4E2A;&#x665A;&#x5BB4;&#x7684;&#x7B79;&#x5907;&#x8FC7;&#x7A0B;&#x5C31;&#x50CF;&#x662F;&#x4E00;&#x4E2A;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7CFB;&#x7EDF;&#xFF0C;&#x6BCF;&#x4E2A;&#x5C0F;&#x52A8;&#x7269;&#x56E2;&#x961F;&#x90FD;&#x5728;&#x5404;&#x81EA;&#x7684;&#x9636;&#x6BB5;&#x5B8C;&#x6210;&#x4EFB;&#x52A1;&#xFF0C;&#x786E;&#x4FDD;&#x4E86;&#x665A;&#x5BB4;&#x7684;&#x6709;&#x5E8F;&#x8FDB;&#x884C;&#x3002;&#x6700;&#x7EC8;&#xFF0C;&#x4ED6;&#x4EEC;&#x6210;&#x529F;&#x5730;&#x4E3E;&#x529E;&#x4E86;&#x4E00;&#x573A;&#x7F8E;&#x5999;&#x7684;&#x665A;&#x5BB4;&#xFF0C;&#x5927;&#x5BB6;&#x90FD;&#x975E;&#x5E38;&#x6EE1;&#x610F;&#x3002;</p>
<h2 id="&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;"><a href="#&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;"></a>&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;</h2><p>&#x5728;&#x5F53;&#x4ECA;&#x7684;&#x8F6F;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x727A;&#x7272;&#x5F3A;&#x4E00;&#x81F4;&#x6027;&#x6765;&#x6362;&#x53D6;&#x7CFB;&#x7EDF;&#x7684;&#x9AD8;&#x6027;&#x80FD;&#x548C;&#x9AD8;&#x53EF;&#x7528;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4FDD;&#x8BC1;&#x6570;&#x636E;&#x7684;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x8FD9;&#x4E2A;&#x8FBE;&#x5230;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;&#x7684;&#x65F6;&#x95F4;&#x9700;&#x8981;&#x5728;&#x7528;&#x6237;&#x548C;&#x4EA7;&#x54C1;&#x5C42;&#x9762;&#x662F;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x7684;&#x3002;&#x5F53;&#x7136;&#x6709;&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x5BF9;&#x4E8E;&#x4E00;&#x81F4;&#x6027;&#x7684;&#x8981;&#x6C42;&#x66F4;&#x9AD8;&#xFF0C;&#x6BD4;&#x5982;&#x91D1;&#x878D;&#x7CFB;&#x7EDF;&#xFF0C;&#x91D1;&#x878D;&#x7CFB;&#x7EDF;&#x4E00;&#x822C;&#x90FD;&#x9700;&#x8981;&#x4FDD;&#x6301;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x7684;&#x5F3A;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x4F1A;&#x53D1;&#x751F;&#x94B1;&#x51ED;&#x7A7A;&#x6D88;&#x5931;&#x7684;&#x53EF;&#x80FD;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x5728;&#x4EE5;&#x4E0A;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x6211;&#x4EEC;&#x6570;&#x636E;&#x7684;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;&#x5462;&#xFF1F;</p>
<p>&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x6211;&#x4EEC;&#x4F1A;&#x91C7;&#x7528;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x3001;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x7B49;&#x65B9;&#x6848;&#x3002;</p>
<p>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x4E00;&#x6837;&#xFF0C;&#x540C;&#x6837;&#x5177;&#x6709;ACID&#xFF08;&#x539F;&#x5B50;&#x3001;&#x4E00;&#x81F4;&#x3001;&#x9694;&#x79BB;&#x3001;&#x6301;&#x4E45;&#xFF09;&#x56DB;&#x4E2A;&#x6570;&#x5B66;&#xFF0C;&#x6700;&#x7EC8;&#x4FDD;&#x8BC1;&#x7684;&#x662F;&#x7CFB;&#x7EDF;&#x72B6;&#x6001;&#x7684;&#x4E00;&#x81F4;&#x6027;</p>
<p>&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x5462;&#xFF1F;</p>
<p>&#x73B0;&#x5728;&#x7684;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x5FAE;&#x670D;&#x52A1;&#x67B6;&#x6784;&#xFF0C;&#x5373;&#x4F7F;&#x4E0D;&#x662F;&#x5FAE;&#x670D;&#x52A1;&#x67B6;&#x6784;&#xFF0C;&#x90A3;&#x4E48;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x4E5F;&#x4F1A;&#x6709;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x6765;&#x7EC4;&#x6210;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x4E1A;&#x52A1;&#x7684;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x6D41;&#x7A0B;&#x5F88;&#x53EF;&#x80FD;&#x5C31;&#x9700;&#x8981;&#x5206;&#x522B;&#x8C03;&#x7528;&#x6563;&#x843D;&#x5728;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x5404;&#x4E2A;&#x4E0D;&#x540C;&#x670D;&#x52A1;&#x4E0A;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x4FDD;&#x8BC1;&#x8FD9;&#x4E2A;&#x5B8C;&#x6574;&#x6D41;&#x7A0B;&#x7684;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x4FDD;&#x8BC1;&#x8BF7;&#x6C42;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#xFF0C;&#x8981;&#x4E48;&#x90FD;&#x6210;&#x529F;&#xFF0C;&#x8981;&#x4E48;&#x90FD;&#x5931;&#x8D25;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F7F;&#x7528;&#x5F3A;&#x4E00;&#x81F4;&#x6027;&#x65B9;&#x6848;&#xFF0C;&#x57FA;&#x672C;&#x5C31;&#x9760;&#x300E;&#x591A;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;&#x300F;&#x8FD9;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;&#x679C;&#x91C7;&#x7528;&#x5F31;&#x4E00;&#x81F4;&#x6027;&#x65B9;&#x6848;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x9009;&#x62E9;&#x7684;&#x65B9;&#x6848;&#x5C31;&#x6BD4;&#x8F83;&#x591A;&#x3002;</p>
<h2 id="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;-VS-&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE;-VS-&#x5206;&#x5E03;&#x5F0F;&#x9501;-VS-&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;"><a href="#&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;-VS-&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE;-VS-&#x5206;&#x5E03;&#x5F0F;&#x9501;-VS-&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;" class="headerlink" title="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1; VS &#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE; VS &#x5206;&#x5E03;&#x5F0F;&#x9501; VS &#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;"></a>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1; VS &#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE; VS &#x5206;&#x5E03;&#x5F0F;&#x9501; VS &#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;</h2><h3 id="&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;"><a href="#&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;" class="headerlink" title="&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;"></a>&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;</h3><p>&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE;&#x9488;&#x5BF9;&#x7684;&#x662F;<strong>&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x91CD;&#x590D;&#x505A;&#x76F8;&#x540C;&#x7684;&#x4E00;&#x4EF6;&#x4E8B;&#x60C5;</strong>&#xFF0C;&#x4E3B;&#x8981;&#x5904;&#x7406;&#x7684;&#x662F;&#x591A;&#x526F;&#x672C;&#x4E4B;&#x95F4;&#x7684;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x66F4;&#x50CF;&#x662F;&#x5171;&#x8BC6;&#x7B97;&#x6CD5;&#xFF0C;&#x6BD4;&#x5982;Paxos&#x7B97;&#x6CD5;&#x3001;ZAB&#x7B97;&#x6CD5;&#x3001;Raft&#x7B97;&#x6CD5;&#x3001;Gossip&#x7B97;&#x6CD5;&#x3002;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x534F;&#x8BAE;&#x9700;&#x8981;&#x5904;&#x7406;&#x7684;&#x4EFB;&#x52A1;&#x903B;&#x8F91;&#x662F;&#xFF1A;</p>
<p>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x670D;&#x52A1;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x5BF9;&#x5916;&#x6765;&#x8BF4;&#xFF0C;&#x90FD;&#x662F;&#x76F8;&#x7B49;&#x7684;&#xFF0C;n1-n5&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x611F;&#x77E5;&#x4E2D;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x533A;&#x522B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/004aca44f1375028a27c4054ec6090c0dd6d13912819fbdf36b25f23f72dec4f" alt></p>
<p><strong>&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x90FD;&#x8981;&#x5B8C;&#x6210;&#x540C;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x5E76;&#x4E14;&#x4FDD;&#x8BC1;&#x8282;&#x70B9;&#x4E4B;&#x95F4;&#x7684;&#x5904;&#x7406;&#x72B6;&#x6001;&#x5B8C;&#x5168;&#x4E00;&#x81F4;</strong></p>
<h3 id="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;"><a href="#&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;" class="headerlink" title="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;"></a>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;</h3><p>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x5219;&#x9488;&#x5BF9;&#x7684;&#x662F;&#x51E0;&#x4E2A;<strong>&#x4E0D;&#x540C;&#x7684;&#x4EFB;&#x52A1;&#x6216;&#x6D41;&#x7A0B;</strong>&#xFF0C;&#x5B83;&#x4EEC;&#x8981;&#x6346;&#x7ED1;&#x5728;&#x4E00;&#x8D77;&#x6210;&#x529F;&#x6216;&#x8005;&#x5931;&#x8D25;&#xFF0C;&#x8981;&#x4E48;&#x90FD;&#x6210;&#x529F;&#x3001;&#x8981;&#x4E48;&#x90FD;&#x5931;&#x8D25;&#xFF0C;&#x8981;&#x4FDD;&#x8BC1;&#x591A;&#x4E2A;&#x6D41;&#x7A0B;&#x7684;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x9488;&#x5BF9;&#x7684;&#x6574;&#x4F53;&#x4E14;&#x5B8C;&#x6574;&#x6D41;&#x7A0B;&#x7684;&#x539F;&#x5B50;&#x6027;</p>
<p>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;n1-n5&#x6240;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x5B83;&#x4EEC;&#x7406;&#x89E3;&#x6210;&#x662F;&#x6709;&#x987A;&#x5E8F;&#x7684;&#xFF08;&#x5411;&#x8C03;&#x5EA6;&#x8005;&#x8BF7;&#x6C42;&#x7684;&#x987A;&#x5E8F;&#xFF09;&#xFF0C;&#x53EA;&#x6709;&#x4E0A;&#x4E00;&#x6B65;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x505A;&#x4E0B;&#x4E00;&#x6B65;&#x624D;&#x6709;&#x610F;&#x4E49;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/1553dda0b96333652b77076ea6fce38450935563347f78f2c17d73f302896e27" alt></p>
<p><strong>&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x90FD;&#x8981;&#x5B8C;&#x6210;&#x4E0D;&#x540C;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x4E14;&#x4FDD;&#x8BC1;&#x540C;&#x65F6;&#x6210;&#x529F;&#x6216;&#x8005;&#x540C;&#x65F6;&#x5931;&#x8D25;</strong></p>
<h3 id="&#x5206;&#x5E03;&#x5F0F;&#x9501;"><a href="#&#x5206;&#x5E03;&#x5F0F;&#x9501;" class="headerlink" title="&#x5206;&#x5E03;&#x5F0F;&#x9501;"></a>&#x5206;&#x5E03;&#x5F0F;&#x9501;</h3><p>&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x5219;&#x7528;&#x4E8E;&#x89E3;&#x51B3;<strong>&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x4E2D;&#x591A;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF08;&#x4EFB;&#x52A1;&#xFF09;&#x4E4B;&#x95F4;&#x5BF9;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x7684;&#x7ADE;&#x4E89;&#x95EE;&#x9898;</strong>&#xFF0C;&#x5728;&#x5355;&#x673A;&#x7CFB;&#x7EDF;&#x4E2D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x9501;&#x6765;&#x786E;&#x4FDD;&#x540C;&#x4E00;&#x65F6;&#x523B;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#xFF1B;&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x4E0B;&#x5219;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x6765;&#x505A;&#x5230;&#x5BF9;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x8FDB;&#x884C;&#x540C;&#x6B65;</p>
<p>&#x5982;&#x56FE;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x591A;&#x4E2A;&#x7ED3;&#x70B9;&#x901A;&#x8FC7;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x8BF7;&#x6C42;&#x8D44;&#x6E90;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x591F;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#xFF0C;&#x4F5C;&#x51FA;&#x76F8;&#x5E94;&#xFF0C;&#x8FD9;&#x91CC;&#x540C;&#x65F6;&#x53EA;&#x80FD;&#x6709;N&#x4E2A;&#x7ED3;&#x70B9;&#x62FF;&#x5230;&#x9501;&#xFF0C;&#x4ECE;&#x800C;&#x62FF;&#x5230;&#x9700;&#x8981;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x6BD4;&#x5982;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x7B49;&#x7B49;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/f571cccfc321256a6e46003535ad5eb1b675b823c0b0194d6afabeeb324dc41c" alt></p>
<p><strong>&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x90FD;&#x60F3;&#x62FF;&#x5230;&#x8D44;&#x6E90;&#xFF0C;&#x4F46;&#x662F;&#x540C;&#x4E00;&#x65F6;&#x523B;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x62FF;&#x5230;&#x8D44;&#x6E90;</strong></p>
<h3 id="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;vs&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;"><a href="#&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;vs&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;" class="headerlink" title="&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;vs&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;"></a>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;vs&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;</h3><p>&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x6BD4;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x4F1A;&#x5BB9;&#x6613;&#x5B9E;&#x73B0;&#x5F88;&#x591A;&#xFF0C;&#x6570;&#x636E;&#x5E93;&#x7CFB;&#x7EDF;&#x4F1A;&#x5C06;&#x8DE8;&#x8868;&#x4E8B;&#x52A1;&#x7684;&#x95EE;&#x9898;&#x6536;&#x62E2;&#x5230;&#x7CFB;&#x7EDF;&#x5185;&#x90E8;&#x6765;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x7CFB;&#x7EDF;&#x5185;&#x90E8;&#x57FA;&#x4E8E;XA&#x6216;&#x8005;&#x5176;&#x4ED6;&#x534F;&#x8BAE;&#xFF0C;&#x7ED3;&#x5408;MVCC&#x4E8B;&#x52A1;&#x9501;&#x4E4B;&#x7C7B;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x597D;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;</p>
<p>&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x800C;&#x8A00;&#xFF0C;&#x5B83;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x662F;&#x6563;&#x843D;&#x5728;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x8282;&#x70B9;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x673A;&#x5236;&#x548C;&#x65B9;&#x6848;&#x90FD;&#x662F;&#x4E0D;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5C31;&#x65E0;&#x6CD5;&#x91C7;&#x7528;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x65E0;&#x6CD5;&#x6536;&#x5F52;&#x4E0B;&#x6E38;&#x5176;&#x4ED6;&#x670D;&#x52A1;&#x4EE5;&#x53CA;&#x5185;&#x90E8;&#x4E0D;&#x540C;&#x5B58;&#x50A8;&#x7CFB;&#x7EDF;&#x4E4B;&#x95F4;&#x7684;&#x4E8B;&#x52A1;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x9488;&#x5BF9;&#x4E1A;&#x52A1;&#x5C42;&#x9762;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x4E00;&#x822C;&#x7684;&#x505A;&#x6CD5;&#x5C31;&#x662F;&#x52A0;&#x4E00;&#x5C42;&#x6216;&#x591A;&#x5C42;&#x62BD;&#x8C61;&#xFF1A;</p>
<p>&#x25CF; &#x589E;&#x52A0;&#x5916;&#x5728;&#x7684;&#x4E8B;&#x52A1;&#x5B58;&#x50A8;</p>
<p>&#x25CF; &#x8981;&#x6C42;&#x4E8B;&#x52A1;&#x53C2;&#x4E0E;&#x65B9;&#x9075;&#x5FAA;&#x67D0;&#x4E9B;&#x7EA6;&#x675F;&#xFF0C;&#x8C03;&#x7528;&#x7279;&#x5B9A;&#x7684;&#x4E00;&#x4E9B;API&#x5C06;&#x4E8B;&#x52A1;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x4E0A;&#x62A5;&#x5173;&#x8054;</p>
<p>&#x25CF; &#x5F15;&#x5165;&#x4E8B;&#x52A1;&#x534F;&#x8C03;&#x8005;&#xFF0C;&#x7531;&#x5B83;&#x6765;&#x6839;&#x636E;&#x53C2;&#x4E0E;&#x65B9;&#x4E0A;&#x62A5;&#x7684;&#x4FE1;&#x606F;&#x505A;&#x4E00;&#x4E9B;&#x4E8B;&#x52A1;&#x7684;&#x9A71;&#x52A8;&#x903B;&#x8F91;</p>
<h2 id="&#x7ED3;&#x8BED;"><a href="#&#x7ED3;&#x8BED;" class="headerlink" title="&#x7ED3;&#x8BED;"></a>&#x7ED3;&#x8BED;</h2><p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x5411;&#x5927;&#x5BB6;&#x4ECB;&#x7ECD;&#x4E86;&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF0C;&#x4EE5;&#x53CA;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x548C;&#x5176;&#x4ED6;&#x6280;&#x672F;&#xFF0C;&#x6BD4;&#x5982;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x3001;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x7B49;&#x6280;&#x672F;&#x7684;&#x533A;&#x522B;&#x3002;<br>&#x521B;&#x4F5C;&#x4E0D;&#x6613;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x6536;&#x83B7;&#x6B22;&#x8FCE;<strong>&#x70B9;&#x8D5E;&#x3001;&#x8BC4;&#x8BBA;&#x3001;&#x6536;&#x85CF;</strong>&#xFF0C;&#x60A8;&#x7684;&#x652F;&#x6301;&#x5C31;&#x662F;&#x6211;&#x6700;&#x5927;&#x7684;&#x52A8;&#x529B;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/72a7239efe9124d6d71a2223059e7e5e.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340909611098554409.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340909611098554409.html" itemprop="url">手把手带你入门 Threejs Shader 系列（八）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-29T19:05:33+08:00">
                2024-02-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x672C;&#x7CFB;&#x5217;&#x6559;&#x7A0B;&#x7684;&#x4EE3;&#x7801;&#x5C06;&#x5F00;&#x6E90;&#x5230;&#x8BE5;&#x4ED3;&#x5E93;&#xFF0C;&#x524D;&#x51E0;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x4EE3;&#x7801;&#x4E5F;&#x4F1A;&#x9646;&#x7EED;&#x8865;&#x4E0A;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6; Star&#xFF1A;<a href="/external_links/a2667a09d61d88ca3b5c5d6e7cf4a89f.html" target="blank" rel="noopener">github.com/DesertsX/th&#x2026;</a></p>
<p>&#x672C;&#x7CFB;&#x5217;&#x7684;&#x4EE3;&#x7801;&#x540C;&#x65F6;&#x653E;&#x5230;&#x4E86; Codepen Collection&#xFF0C;&#x6B22;&#x8FCE;&#x5B66;&#x4E60;&#xFF1A;<a href="/external_links/864d40b49f87bc02d80dcb6cf4448049.html" target="blank" rel="noopener">codepen.io/collection/&#x2026;</a></p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x4E4B;&#x524D;&#x548C;&#x4E4B;&#x540E;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x7684;&#x4F8B;&#x5B50;&#x90FD;&#x5C06;&#x66F4;&#x65B0;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x65B9;&#x4FBF;&#x5927;&#x5BB6;&#x548C;&#x53E4;&#x67F3;&#x4E00;&#x8D77;&#x89C1;&#x8BC1;&#x672C;&#x7CFB;&#x5217;&#x5185;&#x5BB9;&#x7684;&#x4E0D;&#x65AD;&#x58EE;&#x5927;&#x4E0E;&#x5B8C;&#x5584;&#x8FC7;&#x7A0B; <a href="/external_links/907ee66291fdfdbf9cb49c6d85cd13d9.html" target="blank" rel="noopener">www.canva.com/design/DAF3&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c9636d6ac3cc432f62f8555dcc4c086a7ee9cef3a89bbcacec6480380fa3db7c" alt></p>
<p>&#x7EE7;&#x7EED;&#x653E;&#x65B0;&#x52A0;&#x4E0A;&#x7684;&#x7FA4;&#x53CB;&#x7684;&#x8D5E;&#x626C;&#xFF01;&#x770B;&#x5230;&#x7FA4;&#x53CB;&#x628A;&#x524D;&#x9762;&#x4E03;&#x7BC7;&#x5168;&#x8BA4;&#x771F;&#x770B;&#x4E86;&#x5E76;&#x6BCF;&#x7BC7;&#x90FD;&#x70B9;&#x8D5E;&#xFF0C;&#x751A;&#x81F3;&#x53D1;&#x73B0;&#x4E86;&#x6B64;&#x524D;&#x6CA1;&#x4EBA;&#x53D1;&#x73B0;&#x7684; bug&#xFF0C;&#x503C;&#x5F97;&#x8868;&#x626C;&#x1F44D;&#xFF01;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/5adb7bc0eb063dc714b515768befdba135b667dd88304a70a85dd23ed1d181bd" alt></p>
<h2 id="&#x6B63;&#x6587;"><a href="#&#x6B63;&#x6587;" class="headerlink" title="&#x6B63;&#x6587;"></a>&#x6B63;&#x6587;</h2><p>&#x5728;&#x524D;&#x4E24;&#x7BC7;&#x5173;&#x4E8E;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x7684;&#x6587;&#x7AE0;&#x91CC;&#xFF0C;&#x53E4;&#x67F3;&#x6559;&#x5927;&#x5BB6;&#x5E94;&#x7528; sin&#x3001;random&#x3001;noise &#x7B49;&#x51FD;&#x6570;&#x6765;&#x79FB;&#x52A8;&#x9876;&#x70B9;&#x3001;&#x6539;&#x53D8;&#x51E0;&#x4F55;&#x4F53;&#x5F62;&#x72B6;&#xFF0C;&#x5E76;&#x4ECB;&#x7ECD;&#x4E86;&#x5C06; noise &#x6570;&#x503C;&#x4F5C;&#x4E3A;&#x989C;&#x8272;&#x7684;&#x4E00;&#x4E9B;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x672C;&#x6587;&#x53E4;&#x67F3;&#x5C06;&#x6559;&#x5927;&#x5BB6;&#x5982;&#x4F55;&#x5BF9;&#x9876;&#x70B9;&#x8FDB;&#x884C;&#x65CB;&#x8F6C;&#xFF0C;&#x4E0D;&#x8FC7;&#x56E0;&#x4E3A;&#x7403;&#x4F53;&#x7684;&#x9876;&#x70B9;&#x600E;&#x4E48;&#x65CB;&#x8F6C;&#x7403;&#x4F53;&#x5F62;&#x72B6;&#x90FD;&#x4E0D;&#x53D8;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x7528;&#x957F;&#x65B9;&#x4F53;&#x8BB2;&#x89E3;&#x66F4;&#x76F4;&#x89C2;&#x3002;&#x901A;&#x8FC7;&#x5BF9;&#x9876;&#x70B9;&#x65CB;&#x8F6C;&#x4E0D;&#x540C;&#x89D2;&#x5EA6;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x7C7B;&#x4F3C;&#x201C;&#x626D;&#x9EBB;&#x82B1;&#x201D;&#x7684;&#x6548;&#x679C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6a7f4339f53decdd74367eb81f9f9ca74b1331cafc876d763268bcbdde78809d" alt></p>
<h2 id="&#x957F;&#x65B9;&#x4F53;"><a href="#&#x957F;&#x65B9;&#x4F53;" class="headerlink" title="&#x957F;&#x65B9;&#x4F53;"></a>&#x957F;&#x65B9;&#x4F53;</h2><p>&#x4E0B;&#x9762;&#x662F;&#x7B80;&#x5355;&#x7684;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528; <code>BoxGeometry</code> &#x5E76;&#x4E14;&#x5728; shader &#x91CC;&#x7528; vUv &#x4F5C;&#x4E3A;&#x989C;&#x8272;&#xFF0C;&#x76F8;&#x673A;&#x5728; z=3 &#x7684;&#x4F4D;&#x7F6E;&#x770B;&#x5411;&#x573A;&#x666F;&#x4E2D;&#x5FC3;&#x3001;&#x6B63;&#x5BF9;&#x957F;&#x65B9;&#x4F53;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const camera = new THREE.PerspectiveCamera(75, 1, 0.01, 100);</span><br><span class="line">camera.position.set(0, 0, 3);</span><br><span class="line"></span><br><span class="line">const vertexShader = /* GLSL */ `</span><br><span class="line">  uniform float uTime;</span><br><span class="line">  varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">  void main() {</span><br><span class="line">    vUv = uv;</span><br><span class="line">    vec3 newPos = position;</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">const fragmentShader = /* GLSL */ `</span><br><span class="line">  varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(vUv, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line">  </span><br><span class="line">// const geometry = new THREE.BoxGeometry(1, 1, 1);</span><br><span class="line">const geometry = new THREE.BoxGeometry(3, 1, 1);</span><br><span class="line">const material = new THREE.ShaderMaterial({</span><br><span class="line">  uniforms: {</span><br><span class="line">    uTime: { value: 0 },</span><br><span class="line">  },</span><br><span class="line">  vertexShader,</span><br><span class="line">  fragmentShader,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">const mesh = new THREE.Mesh(geometry, material);</span><br><span class="line">scene.add(mesh);</span><br><span class="line"></span><br><span class="line">const clock = new THREE.Clock();</span><br><span class="line">function render() {</span><br><span class="line">  const time = clock.getElapsedTime();</span><br><span class="line">  material.uniforms.uTime.value = time;</span><br><span class="line">  // mesh.rotation.y = time;</span><br><span class="line">  renderer.render(scene, camera);</span><br><span class="line">  requestAnimationFrame(render);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">render();</span><br></pre></td></tr></table></figure>

<p>&#x5F53;&#x957F;&#x5BBD;&#x9AD8;&#x90FD;&#x4E3A;1&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7ACB;&#x65B9;&#x4F53;&#x6BCF;&#x4E2A;&#x9762;&#x90FD;&#x6709;&#x5404;&#x81EA;&#x7684; (0,0)-(1,1) uv &#x503C;&#xFF0C;&#x770B;&#x7740;&#x50CF;&#x7531;6&#x4E2A; plane &#x7EC4;&#x6210;&#x3002;&#x4E0D;&#x540C;&#x51E0;&#x4F55;&#x4F53;&#x7684; uv &#x6548;&#x679C;&#x4F1A;&#x5F88;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x70B9;&#x5927;&#x5BB6;&#x66FF;&#x6362;&#x51E0;&#x4F55;&#x4F53;&#x770B;&#x770B;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x4E0D;&#x8FC7;&#x6570;&#x503C;&#x8303;&#x56F4;&#x90FD;&#x662F;0-1&#x4E0D;&#x4F1A;&#x53D8;&#x5316;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/773fc8ba6f3515ed4da258aa3720d20f2b3fba6d0fe12e11a4cf9cfbb7b3920a" alt></p>
<p>&#x5C06;&#x957F;&#x5EA6;&#x8BBE;&#x4E3A;3&#xFF0C;&#x65B9;&#x4FBF;&#x540E;&#x7EED;&#x6CBF;x&#x8F74;&#x626D;&#x9EBB;&#x82B1;&#x3002;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x957F;&#x5EA6;&#x62C9;&#x957F;&#x540E;&#xFF0C;uv &#x9752;&#x7EA2;&#x989C;&#x8272;&#x6548;&#x679C;&#x4E5F;&#x53EA;&#x662F;&#x76F8;&#x5E94;&#x7684;&#x62C9;&#x957F;&#xFF0C;4&#x4E2A;&#x89D2;&#x7684;&#x989C;&#x8272;&#x4E0D;&#x53D8;&#xFF0C;&#x80CC;&#x540E;&#x6570;&#x503C;&#x8303;&#x56F4;&#x4E5F;&#x662F;&#x4E0D;&#x53D8;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4e23c375383fdf786d7ba2a5b3b0eae56382006d0195df8559fa60866e0805a8" alt></p>
<p>&#x4E4B;&#x524D;&#x8BB2;&#x89E3;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#x65F6;&#x9009;&#x7528; 1:1 &#x7684; plane &#x4F5C;&#x4E3A;&#x4F8B;&#x5B50;&#x662F;&#x4E3A;&#x4E86;&#x4E0D;&#x4F7F;&#x5927;&#x5BB6;&#x5BF9; uv &#x4EA7;&#x751F;&#x56F0;&#x60D1;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x4E0D;&#x8BBA;&#x662F;&#x8FD9;&#x91CC;&#x7684; 3:1&#xFF0C;&#x8FD8;&#x662F;&#x4EFB;&#x4F55;&#x6BD4;&#x4F8B;&#xFF0C;uv &#x5404;&#x81EA;&#x90FD;&#x662F;0-1&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x53EA;&#x662F;&#x56FE;&#x5F62;&#x4E0D;&#x662F; 1:1 &#x65F6;&#x548B;&#x770B;&#x8D77;&#x6765;&#x4F1A;&#x6709;&#x4E9B;&#x5947;&#x602A;&#x3002;</p>
<h2 id="&#x6761;&#x7EB9;&#x6548;&#x679C;"><a href="#&#x6761;&#x7EB9;&#x6548;&#x679C;" class="headerlink" title="&#x6761;&#x7EB9;&#x6548;&#x679C;"></a>&#x6761;&#x7EB9;&#x6548;&#x679C;</h2><p>&#x77E5;&#x9053;&#x957F;&#x65B9;&#x4F53;&#x4E0A; uv &#x7684;&#x6548;&#x679C;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06; vUv.y &#x4E58;&#x4EE5;3.0&#x518D;&#x901A;&#x8FC7; fract &#x53D6;&#x5C0F;&#x6570;&#x7136;&#x540E;&#x5BF9;0.5&#x53D6; step &#x4ECE;&#x800C;&#x4F7F;&#x5F97;&#x6570;&#x503C;&#x5728;0/1/0/1/0/1&#x4E4B;&#x95F4;&#x53D8;&#x5316;&#xFF0C;&#x6700;&#x540E;&#x7528;&#x8BE5;&#x6570;&#x503C;&#x6765; mix &#x63D2;&#x503C;&#x4E24;&#x79CD;&#x989C;&#x8272;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x91CD;&#x590D;&#x6761;&#x7EB9;&#x6548;&#x679C;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x7684;&#x7EA2;&#x8272;&#x662F; <code>#d8345f</code>&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BE5;&#x94FE;&#x63A5;&#x5C06;16&#x8FDB;&#x5236;&#x683C;&#x5F0F;&#x76F4;&#x63A5;&#x8F6C;&#x5316;&#x6210; GLSL &#x91CC;&#x7684; rgb &#x6570;&#x503C;&#xFF0C;&#x5373; <code>vec3(0.847, 0.204, 0.373)</code>&#x3002;&#x94FE;&#x63A5;&#x4E0D;&#x7528;&#x8BB0;&#x4E5F;&#x6CA1;&#x4E8B;&#xFF0C;&#x8981;&#x7528;&#x65F6;&#x76F4;&#x63A5;&#x8C37;&#x6B4C; <code>glsl hex to rgb</code> &#x5373;&#x53EF;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/fc1dba7f54a2163356552695dd26f372.html" target="blank" rel="noopener">airtightinteractive.com/util/hex-to&#x2026;</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main() {</span><br><span class="line">  vec3 color1 = vec3(0.847, 0.204, 0.373);</span><br><span class="line">  vec3 color2 = vec3(1.0);</span><br><span class="line">  float mixer = step(0.5, fract(vUv.y * 3.0));</span><br><span class="line">  // vec3 color = vec3(mixer);</span><br><span class="line">  vec3 color = mix(color1, color2, mixer);</span><br><span class="line">  gl_FragColor = vec4(color, 1.0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/cf4335caf419992000b444c90f0361d80f79b2056549a484ecad5145d542e7ad" alt></p>
<p>&#x5982;&#x679C;&#x5927;&#x5BB6;&#x662F;&#x8DDF;&#x7740;&#x672C;&#x7CFB;&#x5217;&#x6559;&#x7A0B;&#x4E00;&#x7BC7;&#x7BC7;&#x5B66;&#x4E0B;&#x6765;&#x7684;&#xFF0C;&#x76F8;&#x4FE1;&#x8FD9;&#x91CC;&#x7EA2;&#x767D;&#x6761;&#x7EB9;&#x7684;&#x5B9E;&#x73B0;&#x95ED;&#x7740;&#x773C;&#x775B;&#x4E5F;&#x80FD;&#x5199;&#x51FA;&#x6765;&#x4E86;&#x5427;&#x3002;&#x5982;&#x679C;&#x6709;&#x4E0D;&#x7406;&#x89E3;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x524D;&#x9762;&#x6587;&#x7AE0;&#x590D;&#x4E60;&#x4E0B;&#xFF1A;<a href="https://dev.newban.cn/7256039179087380535">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E8C;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230716&#x300D;</a>&#x3002;</p>
<h2 id="&#x65CB;&#x8F6C;&#x9876;&#x70B9;"><a href="#&#x65CB;&#x8F6C;&#x9876;&#x70B9;" class="headerlink" title="&#x65CB;&#x8F6C;&#x9876;&#x70B9;"></a>&#x65CB;&#x8F6C;&#x9876;&#x70B9;</h2><p>&#x5B8C;&#x6210;&#x4E0A;&#x8FF0;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x5BF9;&#x9876;&#x70B9;&#x8FDB;&#x884C;&#x65CB;&#x8F6C;&#x3002;&#x8C37;&#x6B4C;&#x641C;&#x7D22; <code>glsl rotate</code> &#x540E;&#x4ECE;&#x8FD9;&#x4E2A;&#x94FE;&#x63A5;&#x62F7;&#x8D1D; <code>glsl-rotation-3d</code> &#x90E8;&#x5206;&#x7684;&#x51FD;&#x6570;&#x5230;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x3002;rotate() &#x51FD;&#x6570;&#x63A5;&#x6536;&#x5F85;&#x65CB;&#x8F6C;&#x7684;&#x4E09;&#x7EF4;&#x70B9;&#x5750;&#x6807;&#x3001;&#x65CB;&#x7ED5;&#x7684;&#x8F74;&#x3001;&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x8FD9;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x65CB;&#x8F6C;&#x540E;&#x70B9;&#x7684;&#x5750;&#x6807;&#x4F4D;&#x7F6E;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/945e0e50c3d964834304b34081738c07.html" target="blank" rel="noopener">gist.github.com/yiwenl/3f80&#x2026;</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;// glsl-rotation-3d</span><br><span class="line">mat4 rotationMatrix(vec3 axis, float angle) {</span><br><span class="line">    axis = normalize(axis);</span><br><span class="line">    float s = sin(angle);</span><br><span class="line">    float c = cos(angle);</span><br><span class="line">    float oc = 1.0 - c;</span><br><span class="line">    </span><br><span class="line">    return mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,</span><br><span class="line">                oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,</span><br><span class="line">                oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,</span><br><span class="line">                0.0,                                0.0,                                0.0,                                1.0);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vec3 rotate(vec3 v, vec3 axis, float angle) {</span><br><span class="line">	mat4 m = rotationMatrix(axis, angle);</span><br><span class="line">	return (m * vec4(v, 1.0)).xyz;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x957F;&#x65B9;&#x4F53;&#x6CBF;x&#x8F74;&#x62C9;&#x957F;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8BA9;&#x9876;&#x70B9; position &#x90FD;&#x7ED5;x&#x8F74;&#x65CB;&#x8F6C;&#xFF0C;&#x5373; axis &#x7528; (1.0, 0.0, 0.0) &#x8868;&#x793A;&#xFF1B;&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x7528;&#x5F27;&#x5EA6;&#x503C;&#x8868;&#x793A;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x5230; PI &#x503C;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>const float PI</code> &#x58F0;&#x660E;&#x548C;&#x8D4B;&#x503C;&#x3002;&#x5148;&#x8BA9;&#x6240;&#x6709;&#x9876;&#x70B9;&#x7EDF;&#x4E00;&#x7ED5;x&#x8F74;&#x65CB;&#x8F6C; PI/4.0 &#x5373;45&#x5EA6;&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x5DF2;&#x7ECF;&#x6210;&#x529F;&#x751F;&#x6548;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;uniform float uTime;</span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">const float PI = 3.1415925;</span><br><span class="line"></span><br><span class="line">// vec3 rotate(...){ ... }</span><br><span class="line"></span><br><span class="line">void main() {</span><br><span class="line">  vUv = uv;</span><br><span class="line">  // vec3 newPos = position;</span><br><span class="line">  vec3 axis = vec3(1.0, 0.0, 0.0);</span><br><span class="line">  float angle = PI / 4.0;</span><br><span class="line">  vec3 newPos = rotate(position, axis, angle);</span><br><span class="line">  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6952c650b4e1fec448b875f70eb0936721e7fef8a66fd580f7d5a15dbacbe9f7" alt></p>
<p>&#x8BA9;&#x89D2;&#x5EA6;&#x968F;&#x65F6;&#x95F4;&#x53D8;&#x5316;&#xFF0C;&#x5C31;&#x80FD;&#x5B9E;&#x73B0; mesh.rotation.y=time &#x540C;&#x6837;&#x7684;&#x6548;&#x679C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;// float angle = PI / 4.0;</span><br><span class="line">float angle = uTime;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/d7856e6505e2c8ce6698e3253792628737787c086a82a26aa20a2b4bea3fb2ae" alt></p>
<p>&#x6539;&#x53D8; axis &#x5C31;&#x80FD;&#x7ED5;&#x5176;&#x4ED6;&#x8F74;&#x65CB;&#x8F6C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;// vec3 axis = vec3(1.0, 0.0, 0.0);</span><br><span class="line">vec3 axis = vec3(0.0, 1.0, 0.0);</span><br><span class="line">// vec3 axis = vec3(0.0, 0.0, 1.0);</span><br><span class="line">// vec3 axis = vec3(1.0, 1.0, 1.0);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/84971114498728ff1face30e7dc30fd81eca4814095f500e5ce2c2602916955d" alt></p>
<h2 id="&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x968F;x&#x503C;&#x800C;&#x53D8;&#x5316;"><a href="#&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x968F;x&#x503C;&#x800C;&#x53D8;&#x5316;" class="headerlink" title="&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x968F;x&#x503C;&#x800C;&#x53D8;&#x5316;"></a>&#x65CB;&#x8F6C;&#x89D2;&#x5EA6;&#x968F;x&#x503C;&#x800C;&#x53D8;&#x5316;</h2><p>&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x7ED5;x&#x8F74;&#x65CB;&#x8F6C;&#x6240;&#x4EE5; axis &#x4E0D;&#x7528;&#x53D8;&#x3002;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x524D;&#x6587;&#x6240;&#x8BF4;&#x7684;&#x6CBF;x&#x8F74;&#x626D;&#x9EBB;&#x82B1;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4F7F;&#x65CB;&#x8F6C;&#x7684;&#x89D2;&#x5EA6;&#x968F;&#x9876;&#x70B9;&#x5750;&#x6807;&#x91CC;&#x7684;x&#x503C;&#x800C;&#x53D8;&#x5316;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x6240;&#x6709;&#x9876;&#x70B9;&#x90FD;&#x7528;&#x7EDF;&#x4E00;&#x7684;&#x6570;&#x503C;&#x3002;&#x6B64;&#x65F6;&#x4F1A;&#x53D1;&#x73B0;&#x957F;&#x65B9;&#x4F53;&#x5F62;&#x72B6;&#x53D8;&#x5F97;&#x633A;&#x522B;&#x626D;&#x3001;&#x633A;&#x5947;&#x602A;&#xFF0C;&#x4E2D;&#x95F4;&#x533A;&#x57DF;&#x8FC7;&#x6E21;&#x5730;&#x4E0D;&#x591F;&#x4E1D;&#x6ED1;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;float angle = position.x;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/5d9ac0677b9a7ada111c4c937286624198c5cfe7b820202793722795c6907875" alt></p>
<p>&#x539F;&#x56E0;&#x60F3;&#x6765;&#x5927;&#x5BB6;&#x4E5F;&#x80FD;&#x731C;&#x5230;&#xFF0C;&#x5C31;&#x662F;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;&#x4E0D;&#x591F;&#x3001;&#x9876;&#x70B9;&#x4E0D;&#x591F;&#x591A;&#xFF0C;&#x4E2D;&#x95F4;&#x6CA1;&#x6709;&#x9876;&#x70B9;&#x3001;&#x6CA1;&#x6709;&#x64CD;&#x4F5C;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x53EA;&#x6709;&#x4E24;&#x7AEF;&#x624D;&#x80FD;&#x65CB;&#x8F6C;&#xFF0C;&#x6240;&#x4EE5;&#x626D;&#x8F6C;&#x5F97;&#x5F88;&#x751F;&#x786C;&#x3002;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; material &#x7684; wireframe:true &#x5C31;&#x80FD;&#x5E94;&#x8BC1;&#x6211;&#x4EEC;&#x7684;&#x60F3;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const geometry = new THREE.BoxGeometry(3, 1, 1);</span><br><span class="line">const material = new THREE.ShaderMaterial({</span><br><span class="line">  uniforms: {</span><br><span class="line">    uTime: { value: 0 },</span><br><span class="line">  },</span><br><span class="line">  vertexShader,</span><br><span class="line">  fragmentShader,</span><br><span class="line">  wireframe: true,</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9b7fc0d94395c44fc65b5cdd6e5099b704518e4b873fe6f9b933c837516141de" alt></p>
<h2 id="&#x589E;&#x52A0;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;"><a href="#&#x589E;&#x52A0;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;" class="headerlink" title="&#x589E;&#x52A0;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;"></a>&#x589E;&#x52A0;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;</h2><p>&#x6211;&#x4EEC;&#x4EE5;2&#x3001;4&#x3001;8&#x3001;16&#x3001;32&#x3001;64&#x2026;&#x2026;&#x7B49;2&#x7684;&#x500D;&#x6570;&#x6765;&#x589E;&#x52A0;&#x957F;&#x65B9;&#x4F53;&#x7684;&#x7EC6;&#x5206;&#x6570;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5DEE;&#x4E0D;&#x591A;&#x5728;32&#x4EE5;&#x540E;&#x4E2D;&#x95F4;&#x626D;&#x8F6C;&#x8FC7;&#x6E21;&#x5C31;&#x5F88;&#x4E1D;&#x6ED1;&#x4E86;&#x3002;&#x6BD5;&#x7ADF;&#x56FE;&#x4E2D;&#x957F;&#x65B9;&#x4F53;&#x5C31;&#x8FD9;&#x4E48;&#x70B9;&#x957F;&#x5EA6;&#xFF0C;&#x5207;&#x6210;32&#x4EFD;&#x5DF2;&#x7ECF;&#x5F88;&#x7EC6;&#x4E86;&#x3002;&#x8FD9;&#x91CC;&#x91C7;&#x7528;64&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x7F18;&#x6545;&#xFF0C;&#x53CD;&#x6B63; shader &#x91CC;&#x90FD;&#x662F;&#x540C;&#x6837;&#x8F7B;&#x677E;&#x62FF;&#x634F;&#xFF0C;&#x7528;&#x5927;&#x4E9B;&#x7684;&#x6570;&#x503C;&#x4E5F;&#x65E0;&#x59A8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// const geometry = new THREE.BoxGeometry(3, 1, 1);</span><br><span class="line">// const geometry = new THREE.BoxGeometry(3, 1, 1, 4, 4, 4);</span><br><span class="line">const geometry = new THREE.BoxGeometry(3, 1, 1, 64, 64, 64);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6d0ef2e1504a9861bac4a6ffef31cd673117760be4b3cff0ba00b72bbad92d93" alt></p>
<p>&#x968F;&#x7740;&#x7EC6;&#x5206;&#x6570;&#x589E;&#x52A0;&#x3001;&#x9876;&#x70B9;&#x6570;&#x589E;&#x591A;&#xFF0C;&#x4E2D;&#x95F4;&#x9876;&#x70B9;&#x968F;&#x7740;x&#x5750;&#x6807;&#x7684;&#x53D8;&#x5316;&#x4EE5;&#x4E0D;&#x540C;&#x89D2;&#x5EA6;&#x53D1;&#x751F;&#x65CB;&#x8F6C;&#xFF0C;&#x4ECE;&#x800C;&#x6709;&#x4E86;&#x4E1D;&#x6ED1;&#x7684;&#x626D;&#x66F2;&#x6548;&#x679C;&#x3002;&#x5F53;&#x6211;&#x4EEC;&#x628A; <code>position.x + uTime</code> &#x4F5C;&#x4E3A; angle &#x65F6;&#x5C31;&#x80FD;&#x4F7F;&#x626D;&#x8F6C;&#x6548;&#x679C;&#x968F;&#x4E4B;&#x52A8;&#x8D77;&#x6765;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;// ...</span><br><span class="line"></span><br><span class="line">void main() {</span><br><span class="line">  vUv = uv;</span><br><span class="line">  vec3 axis = vec3(1.0, 0.0, 0.0);</span><br><span class="line">  // float angle = position.x;</span><br><span class="line">  float angle = position.x + uTime;</span><br><span class="line">  vec3 newPos = rotate(position, axis, angle);</span><br><span class="line">  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2fe0eb0b4a1bf2994cfaedf19d827763a37f3d1ee88f1cd4dc856a868cc073b9" alt></p>
<h2 id="&#x5176;&#x4ED6;&#x53D8;&#x4F53;"><a href="#&#x5176;&#x4ED6;&#x53D8;&#x4F53;" class="headerlink" title="&#x5176;&#x4ED6;&#x53D8;&#x4F53;"></a>&#x5176;&#x4ED6;&#x53D8;&#x4F53;</h2><p>&#x9664;&#x6B64;&#x4E4B;&#x5916;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x968F;&#x610F;&#x5728; angle &#x52A0;&#x4E9B;&#x5185;&#x5BB9;&#x6765;&#x5B9E;&#x73B0;&#x4E0D;&#x540C;&#x7684;&#x626D;&#x66F2;&#x52A8;&#x753B;&#x6548;&#x679C;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x81EA;&#x7531;&#x53D1;&#x6325;&#xFF0C;&#x6CA1;&#x51C6;&#x4F1A;&#x6709;&#x610F;&#x5916;&#x4E4B;&#x559C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;float angle = position.x + sin(uTime) * 3.0 + uTime;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6d3ca509b36714b7e45b8cd3dd7ea5143a5bfd4db9af2c4f4ad52d6d46db3637" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C#&#x590D;&#x5236;&#x4EE3;&#x7801;float angle = position.x * sin(uTime) - uTime;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f97967ce2556a8b2e180e1023462cd37aa467b5e9ab61ed32ef9dbc91f26022c" alt></p>
<h2 id="Kinetic-Typography"><a href="#Kinetic-Typography" class="headerlink" title="Kinetic Typography"></a>Kinetic Typography</h2><p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x201C;&#x626D;&#x9EBB;&#x82B1;&#x201D;&#x6548;&#x679C;&#x7684;&#x5168;&#x90E8;&#x5185;&#x5BB9;&#xFF0C;&#x5E76;&#x4E0D;&#x590D;&#x6742;&#x3001;&#x5E76;&#x4E0D;&#x96BE;&#x61C2;&#x3002;</p>
<p>&#x53E4;&#x67F3;&#x4E4B;&#x6240;&#x4EE5;&#x60F3;&#x8BB2;&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#xFF0C;&#x4E00;&#x65B9;&#x9762;&#x662F;&#x56E0;&#x4E3A;&#x60F3;&#x6559;&#x5927;&#x5BB6;&#x9876;&#x70B9;&#x65CB;&#x8F6C;&#xFF0C;&#x4E00;&#x65B9;&#x9762;&#x662F;&#x60F3;&#x5230;&#x8FD9;&#x4E2A; <code>Kinetic Typography</code> &#x52A8;&#x6001;&#x6587;&#x5B57;&#x6392;&#x7248;/&#x6587;&#x5B57;&#x52A8;&#x6548;&#x7684;&#x5B9E;&#x9645;&#x4F8B;&#x5B50;&#xFF08;&#x4E5F;&#x8FD9;&#x662F;&#x4E0A;&#x9762; <code>#d8345f</code> &#x7EA2;&#x8272;&#x7684;&#x51FA;&#x5904;&#xFF0C;&#x5E76;&#x975E;&#x51ED;&#x7A7A;&#x5192;&#x51FA;&#x6765;&#x7684;&#xFF09;&#x3002;</p>
<p>&#x626D;&#x8F6C;&#x957F;&#x65B9;&#x4F53;&#x540E;&#x518D;&#x7ED3;&#x5408;&#x6587;&#x5B57;&#x4F1A;&#x4F7F;&#x4EBA;&#x773C;&#x524D;&#x4E00;&#x4EAE;&#xFF0C;&#x540E;&#x7EED;&#x8BB2;&#x89E3;&#x5230; shader &#x91CC;&#x7684;&#x7EB9;&#x7406;&#x8D34;&#x56FE;&#x3001;&#x7EB9;&#x7406;&#x91C7;&#x6837;&#x65F6;&#xFF0C;&#x53E4;&#x67F3;&#x4F1A;&#x518D;&#x5E26;&#x5927;&#x5BB6;&#x628A;&#x7ED3;&#x5408;&#x6587;&#x5B57;&#x90E8;&#x5206;&#x8865;&#x4E0A;&#xFF0C;&#x656C;&#x8BF7;&#x671F;&#x5F85;&#xFF01;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/34e017d6d38f44ed636b57b3c505f289.html" target="blank" rel="noopener">tympanus.net/Tutorials/c&#x2026;</a></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/929db4428dbfe439bd44f6cda93d9b7be7013dd96933f1bdbcd65fe608286d76" alt></p>
<p>&#x5176;&#x4ED6;&#x6587;&#x5B57;&#x6548;&#x679C;&#x540C;&#x6837;&#x4E0D;&#x9519;&#xFF0C;&#x6709;&#x673A;&#x4F1A;&#x53E4;&#x67F3;&#x4F1A;&#x5728;&#x6559;&#x7A0B;&#x91CC;&#x591A;&#x8BB2;&#x4E9B;&#x4F8B;&#x5B50;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/055d89156ce3e33ca3e9f9fa982d2e1270a4ecbcb3f68aba69f1a9bc646f9f76" alt></p>
<h2 id="&#x6682;&#x65F6;&#x820D;&#x5F03;&#x7684;-WebGL-Blob"><a href="#&#x6682;&#x65F6;&#x820D;&#x5F03;&#x7684;-WebGL-Blob" class="headerlink" title="&#x6682;&#x65F6;&#x820D;&#x5F03;&#x7684; WebGL Blob"></a>&#x6682;&#x65F6;&#x820D;&#x5F03;&#x7684; WebGL Blob</h2><p>&#x5176;&#x5B9E;&#x4E00;&#x5F00;&#x59CB;&#x53E4;&#x67F3;&#x8BBE;&#x60F3;&#x7684;&#x8BB2;&#x89E3;&#x9876;&#x70B9;&#x65CB;&#x8F6C;&#x7684;&#x4F8B;&#x5B50;&#x662F;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#xFF0C;&#x5373;&#x5728; noise &#x503C;&#x504F;&#x79FB;&#x9876;&#x70B9;&#x540E;&#xFF0C;&#x52A0;&#x4E0A;&#x65CB;&#x8F6C;&#x9876;&#x70B9;&#xFF0C;&#x518D;&#x52A0;&#x4E0A; <code>Cosine Palette</code>&#xFF08;&#x53E6;&#x4E00;&#x79CD; shader &#x91CC;&#x7684;&#x914D;&#x8272;&#x65B9;&#x6CD5;&#xFF09;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x51FA;&#x8FD9;&#x79CD;&#x9177;&#x70AB;&#x7684; WebGL Blob &#x6548;&#x679C;&#x3002;&#x4E0D;&#x8FC7;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x89E3;&#x91CA;&#x4E0D;&#x597D;&#xFF0C;&#x8FDC;&#x4E0D;&#x5982;&#x957F;&#x65B9;&#x4F53;&#x201C;&#x626D;&#x9EBB;&#x82B1;&#x201D;&#x76F4;&#x89C2;&#x597D;&#x61C2;&#xFF0C;&#x6545;&#x800C;&#x8FDB;&#x884C;&#x4E86;&#x53D6;&#x820D;&#x3002;&#x5F53;&#x7136;&#x5176;&#x4E2D;&#x7684; <code>Cosine Palette</code> &#x53E4;&#x67F3;&#x540E;&#x7EED;&#x8FD8;&#x662F;&#x4F1A;&#x6559;&#x5927;&#x5BB6;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4537e4ffa078400242f401f1f6f038a7fc0ccecc86065ee3137351f6a9e898ac" alt></p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x672C;&#x6587;&#x7684;&#x5185;&#x5BB9;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x6CA1;&#x5565;&#x597D;&#x603B;&#x7ED3;&#x7684;&#x3002;&#x6700;&#x540E;&#x7167;&#x65E7;&#x662F;&#x672C;&#x6587;&#x7684;&#x6240;&#x6709;&#x4F8B;&#x5B50;&#x5408;&#x96C6;&#xFF0C;&#x5927;&#x5BB6;&#x8981;&#x597D;&#x597D;&#x590D;&#x4E60;&#x54C8;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/7ba2dd1c247e55c69b4beb36a52551881144ba6057e032ff6a7aea7658cf14fc" alt></p>
<h2 id="&#x76F8;&#x5173;&#x9605;&#x8BFB;"><a href="#&#x76F8;&#x5173;&#x9605;&#x8BFB;" class="headerlink" title="&#x76F8;&#x5173;&#x9605;&#x8BFB;"></a>&#x76F8;&#x5173;&#x9605;&#x8BFB;</h2><p>&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#x300D;&#x76EE;&#x5F55;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><a href="https://dev.newban.cn/7222410870675439673">&#x300C;&#x65AD;&#x66F4;19&#x4E2A;&#x6708;&#xFF0C;&#x643A; Three.js Shader &#x5F52;&#x6765;&#xFF01;&#xFF08;&#x4E0A;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230416&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7224314619865628709">&#x300C;&#x65AD;&#x66F4;19&#x4E2A;&#x6708;&#xFF0C;&#x643A; Three.js Shader &#x5F52;&#x6765;&#xFF01;&#xFF08;&#x4E0B;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230421&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7332305149589225483">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E03;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230206&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7314572755696189494">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x516D;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20231220&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7305371899138654235">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E94;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20231126&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7303797715393183796">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x56DB;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20231121&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7259411780375314490">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E09;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230725&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7256039179087380535">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E8C;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230716&#x300D;</a></li>
<li><a href="https://dev.newban.cn/7233359844974182437">&#x300C;&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E00;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3; - 20230515&#x300D;</a></li>
</ul>
<h2 id="&#x7167;&#x4F8B;"><a href="#&#x7167;&#x4F8B;" class="headerlink" title="&#x7167;&#x4F8B;"></a>&#x7167;&#x4F8B;</h2><p>&#x5982;&#x679C;&#x4F60;&#x559C;&#x6B22;&#x672C;&#x6587;&#x5185;&#x5BB9;&#xFF0C;&#x6B22;&#x8FCE;&#x4EE5;&#x5404;&#x79CD;&#x65B9;&#x5F0F;&#x652F;&#x6301;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x5BF9;&#x53E4;&#x67F3;&#x8F93;&#x51FA;&#x6559;&#x7A0B;&#x7684;&#x4E00;&#x79CD;&#x6B63;&#x5411;&#x9F13;&#x52B1;&#xFF01;</p>
<p>&#x6700;&#x540E;&#x6B22;&#x8FCE;&#x52A0;&#x5165;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x4EA4;&#x6D41;&#x7FA4;&#x300D;</code>&#xFF0C;&#x8FDB;&#x7FA4;&#x591A;&#x591A;&#x4EA4;&#x6D41;&#xFF0C;&#x5BF9;&#x672C;&#x6587;&#x4EFB;&#x4F55;&#x5730;&#x65B9;&#x6709;&#x7591;&#x60D1;&#x7684;&#x53EF;&#x4EE5;&#x7FA4;&#x91CC;&#x63D0;&#x95EE;&#x3002;&#x52A0;&#x53E4;&#x67F3;&#x5FAE;&#x4FE1;&#xFF1A;<code>xiaoaizhj</code>&#xFF0C;&#x5907;&#x6CE8;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x52A0;&#x7FA4;&#x300D;</code>&#x5373;&#x53EF;&#x3002;</p>
<p>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x53E4;&#x67F3;&#x7684;&#x516C;&#x4F17;&#x53F7;<code>&#x300C;&#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</code>&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x661F;&#x6807;&#xFF0C;&#x4EE5;&#x4FBF;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x6536;&#x5230;&#x66F4;&#x65B0;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e58586d168cadbcebbb71d3dbd704ff6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340574992256466953.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340574992256466953.html" itemprop="url">不引入ES，如何利用MySQL实现模糊匹配 1 业务场景概</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-29T10:07:48+08:00">
                2024-02-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><h1 id="&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x6982;&#x8FF0;"><a href="#&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x6982;&#x8FF0;" class="headerlink" title="&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x6982;&#x8FF0;"></a>&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x6982;&#x8FF0;</h1></li>
</ol>
<p>&#x76EE;&#x6807;&#x662F;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x516C;&#x53F8;&#x7684;&#x7533;&#x8BF7;&#x5BA1;&#x6279;&#x6D41;&#x7A0B;&#xFF0C;&#x6574;&#x4E2A;&#x4E1A;&#x52A1;&#x6D41;&#x7A0B;&#x6D89;&#x53CA;&#x5230;&#x4E24;&#x79CD;&#x89D2;&#x8272;&#xFF0C;&#x5206;&#x522B;&#x4E3A;<strong>&#x5546;&#x52A1;</strong>&#x89D2;&#x8272;&#x4E0E;<strong>&#x7BA1;&#x7406;&#x5458;</strong>&#x89D2;&#x8272;&#x3002;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/5a6c6fdff4e3e1c58671fbdadc93fd7e5fb969dccfb165c2f60bed65a4efa599" alt="&#x6D41;&#x7A0B;&#x56FE;"><br>&#x6838;&#x5FC3;&#x6D41;&#x7A0B;&#x603B;&#x7ED3;&#x4E3A;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A;<strong>&#x5546;&#x52A1;&#x89D2;&#x8272;&#x7533;&#x8BF7;&#x6DFB;&#x52A0;&#x516C;&#x53F8;&#x540E;&#x7531;&#x7BA1;&#x7406;&#x5458;&#x8FDB;&#x884C;&#x5BA1;&#x6279;</strong>&#x3002;</p>
<p>&#x5546;&#x52A1;&#x5728;&#x6DFB;&#x52A0;&#x516C;&#x53F8;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#xFF0C;&#x76F4;&#x63A5;&#x586B;&#x5199;&#x516C;&#x53F8;&#x7B80;&#x79F0;&#xFF0C;&#x800C;&#x516C;&#x53F8;&#x5168;&#x79F0;&#x53EF;&#x80FD;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x88AB;&#x6DFB;&#x52A0;&#x8FC7;&#x4E86;&#xFF0C;<strong>&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x6DFB;&#x52A0;&#x91CD;&#x590D;&#x7684;&#x516C;&#x53F8;</strong>&#xFF0C;&#x6240;&#x4EE5;&#x7BA1;&#x7406;&#x5458;&#x5728;&#x9488;&#x5BF9;&#x516C;&#x53F8;&#x4FE1;&#x606F;&#x5BA1;&#x6279;&#x4E4B;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x67E5;&#x770B;&#x4EE5;&#x5F80;&#x6DFB;&#x52A0;&#x7684;&#x516C;&#x53F8;&#x4FE1;&#x606F;&#x91CC;&#x6709;&#x65E0;&#x540C;&#x4E00;&#x4E2A;&#x516C;&#x53F8;&#x3002;</p>
<ol start="2">
<li><h1 id="&#x5B9E;&#x73B0;&#x601D;&#x8DEF;"><a href="#&#x5B9E;&#x73B0;&#x601D;&#x8DEF;" class="headerlink" title="&#x5B9E;&#x73B0;&#x601D;&#x8DEF;"></a>&#x5B9E;&#x73B0;&#x601D;&#x8DEF;</h1></li>
</ol>
<p>&#x4EE5;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x7684;&#x5927;&#x6982;&#x4ECB;&#x7ECD;&#x3002;&#x4ECE;&#x6280;&#x672F;&#x5C42;&#x9762;&#x9700;&#x8981;&#x8003;&#x8651;&#x5B9E;&#x73B0;&#x7684;&#x529F;&#x80FD;&#x70B9;&#xFF1A;</p>
<ul>
<li><strong>&#x5206;&#x8BCD;</strong></li>
<li><strong>&#x4E0E;&#x5E93;&#x91CC;&#x5DF2;&#x6709;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x5339;&#x914D;</strong></li>
<li><strong>&#x6309;&#x7167;&#x5339;&#x914D;&#x5EA6;&#x5BF9;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;</strong></li>
</ul>
<p>&#x5206;&#x8BCD;&#x529F;&#x80FD;&#x6709;&#x73B0;&#x6210;&#x7684;&#x5206;&#x8BCD;&#x5668;&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x4E2A;&#x9700;&#x6C42;&#x7684;&#x6838;&#x5FC3;&#x91CD;&#x70B9;&#x5728;&#x4E8E;<strong>&#x5982;&#x4F55;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5339;&#x914D;&#x5E76;&#x6309;&#x7167;&#x5339;&#x914D;&#x5EA6;&#x6392;&#x5E8F;</strong>&#x3002;</p>
<ol start="3">
<li><h1 id="&#x6A21;&#x7CCA;&#x5339;&#x914D;&#x6280;&#x672F;&#x9009;&#x578B;"><a href="#&#x6A21;&#x7CCA;&#x5339;&#x914D;&#x6280;&#x672F;&#x9009;&#x578B;" class="headerlink" title="&#x6A21;&#x7CCA;&#x5339;&#x914D;&#x6280;&#x672F;&#x9009;&#x578B;"></a>&#x6A21;&#x7CCA;&#x5339;&#x914D;&#x6280;&#x672F;&#x9009;&#x578B;</h1></li>
</ol>
<ul>
<li>&#x65B9;&#x6848;&#x4E00;&#xFF1A;<strong>&#x5F15;&#x5165;ES</strong></li>
<li>&#x65B9;&#x6848;&#x4E8C;&#xFF1A;<strong>&#x5229;&#x7528;MySQL&#x5B9E;&#x73B0;</strong></li>
</ul>
<p>&#x672C;&#x7CFB;&#x7EDF;&#x89C4;&#x6A21;&#x8F83;&#x5C0F;&#xFF0C;&#x5355;&#x7EAF;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x5F15;&#x5165;ES&#x6210;&#x672C;&#x8F83;&#x5927;&#xFF0C;&#x8FD8;&#x8981;&#x6D89;&#x53CA;&#x5230;&#x6570;&#x636E;&#x540C;&#x6B65;&#x7B49;&#x95EE;&#x9898;&#xFF0C;<strong>&#x7CFB;&#x7EDF;&#x590D;&#x6742;&#x6027;&#x4F1A;&#x63D0;&#x9AD8;</strong>&#xFF0C;&#x6240;&#x4EE5;&#x5C3D;&#x91CF;&#x4F7F;&#x7528;<strong>MySQL</strong>&#x5DF2;&#x6709;&#x7684;&#x529F;&#x80FD;&#x8FDB;&#x884C;&#x5B9E;&#x73B0;&#x3002;</p>
<p>MySQL&#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x4E09;&#x79CD;<strong>&#x6A21;&#x7CCA;&#x641C;&#x7D22;</strong>&#x7684;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ul>
<li><code>like&#x5339;&#x914D;</code>&#xFF1A;&#x8981;&#x6C42;&#x6A21;&#x5F0F;&#x4E32;&#x4E0E;&#x6574;&#x4E2A;&#x76EE;&#x6807;&#x5B57;&#x6BB5;&#x5B8C;&#x5168;&#x5339;&#x914D;&#xFF1B;</li>
<li><code>RegExp&#x6B63;&#x5219;&#x5339;&#x914D;</code>&#xFF1A;&#x8981;&#x6C42;&#x76EE;&#x6807;&#x5B57;&#x6BB5;&#x5305;&#x542B;&#x6A21;&#x5F0F;&#x4E32;&#x5373;&#x53EF;&#xFF1B;</li>
<li><code>Fulltext&#x5168;&#x6587;&#x7D22;&#x5F15;</code>&#xFF1A;&#x5728;&#x5B57;&#x6BB5;&#x7C7B;&#x578B;&#x4E3A;<code>CHAR</code>,<code>VARCHAR</code>&#xFF0C;<code>TEXT</code>&#x7684;&#x5217;&#x4E0A;&#x521B;&#x5EFA;&#x5168;&#x6587;&#x7D22;&#x5F15;&#xFF0C;&#x6267;&#x884C;SQL&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x3002;</li>
</ul>
<p>&#x9488;&#x5BF9;&#x4E8E;&#x4E0A;&#x8FF0;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#xFF0C;&#x5BF9;&#x76F8;&#x5173;&#x6280;&#x672F;&#x8FDB;&#x884C;&#x4F18;&#x52A3;&#x5206;&#x6790;&#xFF1A;</p>
<ul>
<li><strong>like&#x5339;&#x914D;</strong>&#xFF0C;&#x65E0;&#x6CD5;&#x6EE1;&#x8DB3;&#x9700;&#x6C42;&#xFF0C;&#x6240;&#x4EE5;<code>pass</code>&#xFF1B;</li>
<li><strong>&#x5168;&#x6587;&#x7D22;&#x5F15;</strong>&#xFF1A;&#x53EF;&#x5B9A;&#x5236;&#x6027;&#x5DEE;&#xFF0C;&#x4E0D;&#x652F;&#x6301;&#x4EFB;&#x610F;&#x5339;&#x914D;&#x67E5;&#x8BE2;&#xFF0C;<code>pass</code>&#xFF1B;</li>
<li><strong>&#x6B63;&#x5219;&#x5339;&#x914D;</strong>&#xFF1A;&#x53EF;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x6A21;&#x5F0F;&#x5339;&#x914D;&#xFF0C;&#x7F3A;&#x70B9;&#x5728;&#x4E8E;&#x6267;&#x884C;&#x6548;&#x7387;&#x4E0D;&#x5982;&#x5168;&#x6587;&#x7D22;&#x5F15;&#x3002;</li>
</ul>
<p>&#x9488;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x573A;&#x666F;&#xFF0C;&#x8BB0;&#x5F55;&#x6570;&#x76EE;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x6CA1;&#x6709;&#x90A3;&#x4E48;&#x591A;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x6548;&#x7387;&#x7A0D;&#x4F4E;&#x7684;&#x7ED3;&#x679C;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#xFF0C;&#x56E0;&#x6B64;&#x6280;&#x672F;&#x9009;&#x578B;&#x65B9;&#x9762;&#x91C7;&#x7528;<code>RegExp&#x6B63;&#x5219;&#x5339;&#x914D;</code>&#x6765;&#x5B9E;&#x73B0;<strong>&#x6A21;&#x7CCA;&#x5339;&#x914D;</strong>&#x7684;&#x9700;&#x6C42;&#x3002;</p>
<ol start="4">
<li><h1 id="&#x5B9E;&#x73B0;&#x6548;&#x679C;&#x5C55;&#x793A;"><a href="#&#x5B9E;&#x73B0;&#x6548;&#x679C;&#x5C55;&#x793A;" class="headerlink" title="&#x5B9E;&#x73B0;&#x6548;&#x679C;&#x5C55;&#x793A;"></a>&#x5B9E;&#x73B0;&#x6548;&#x679C;&#x5C55;&#x793A;</h1></li>
</ol>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/94ead3aa1d1d8f579d20f49398c86ece50e5d50c7204fcf996eaee61970f6805" alt="image.png"></p>
<ol start="5">
<li><h1 id="&#x6838;&#x5FC3;&#x4EE3;&#x7801;"><a href="#&#x6838;&#x5FC3;&#x4EE3;&#x7801;" class="headerlink" title="&#x6838;&#x5FC3;&#x4EE3;&#x7801;"></a>&#x6838;&#x5FC3;&#x4EE3;&#x7801;</h1></li>
</ol>
<p>&#x6574;&#x4E2A;&#x903B;&#x8F91;&#x57FA;&#x4E8E; <strong>&#x63D0;&#x53D6;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x5173;&#x952E;&#x4FE1;&#x606F; &#x2013;&gt;&#x5206;&#x8BCD; &#x2013;&gt; &#x5339;&#x914D;</strong> &#x4E09;&#x4E2A;&#x6838;&#x5FC3;&#x6B65;&#x9AA4;&#x3002;</p>
<h2 id="5-1-&#x63D0;&#x53D6;&#x516C;&#x53F8;&#x5173;&#x952E;&#x4FE1;&#x606F;"><a href="#5-1-&#x63D0;&#x53D6;&#x516C;&#x53F8;&#x5173;&#x952E;&#x4FE1;&#x606F;" class="headerlink" title="5.1 &#x63D0;&#x53D6;&#x516C;&#x53F8;&#x5173;&#x952E;&#x4FE1;&#x606F;"></a>5.1 &#x63D0;&#x53D6;&#x516C;&#x53F8;&#x5173;&#x952E;&#x4FE1;&#x606F;</h2><p>&#x5BF9;&#x8F93;&#x5165;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x53BB;&#x9664;<code>&#x65E0;&#x7528;&#x4FE1;&#x606F;</code>&#xFF0C;&#x4FDD;&#x7559;&#x5173;&#x952E;&#x4FE1;&#x606F;&#x3002;&#x8FD9;&#x91CC;&#x7684;&#x65E0;&#x7528;&#x4FE1;&#x606F;&#x6307;&#x7684;&#x662F;&#x5730;&#x540D;&#xFF0C;&#x5706;&#x62EC;&#x53F7;&#xFF0C;&#x4EE5;&#x53CA;&#x96C6;&#x56E2;&#xFF0C;&#x80A1;&#x4EFD;&#xFF0C;&#x6709;&#x9650;&#x7B49;&#x3002;</p>
<ul>
<li><strong>&#x5339;&#x914D;&#x524D;&#x5904;&#x7406;&#x516C;&#x53F8;&#x540D;&#x79F0;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    /**</span><br><span class="line">     * &#x5339;&#x914D;&#x524D;&#x53BB;&#x9664;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x7684;&#x65E0;&#x610F;&#x4E49;&#x4FE1;&#x606F;</span><br><span class="line">     * @param targetCompanyName</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private String formatCompanyName(String targetCompanyName){</span><br><span class="line"></span><br><span class="line">        String regex = &quot;(?&lt;province&gt;[^&#x7701;]+&#x81EA;&#x6CBB;&#x533A;|.*?&#x7701;|.*?&#x884C;&#x653F;&#x533A;|.*?&#x5E02;)&quot; +</span><br><span class="line">                &quot;?(?&lt;city&gt;[^&#x5E02;]+&#x81EA;&#x6CBB;&#x5DDE;|.*?&#x5730;&#x533A;|.*?&#x884C;&#x653F;&#x5355;&#x4F4D;|.+&#x76DF;|&#x5E02;&#x8F96;&#x533A;|.*?&#x5E02;|.*?&#x53BF;)&quot; +</span><br><span class="line">                &quot;?(?&lt;county&gt;[^(&#x533A;|&#x5E02;|&#x53BF;|&#x65D7;|&#x5C9B;)]+&#x533A;|.*?&#x5E02;|.*?&#x53BF;|.*?&#x65D7;|.*?&#x5C9B;)&quot; +</span><br><span class="line">                &quot;?(?&lt;village&gt;.*)&quot;;</span><br><span class="line">        Matcher matcher = Pattern.compile(regex).matcher(targetCompanyName);</span><br><span class="line">        while(matcher.find()){</span><br><span class="line">            String province = matcher.group(&quot;province&quot;);</span><br><span class="line">            log.info(&quot;province:{}&quot;,province);</span><br><span class="line">            if (StringUtils.isNotBlank(province) &amp;&amp; targetCompanyName.contains(province)){</span><br><span class="line">                targetCompanyName = targetCompanyName.replace(province,&quot;&quot;);</span><br><span class="line">            }</span><br><span class="line">            log.info(&quot;&#x5904;&#x7406;&#x5B8C;&#x7701;&#x4EFD;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;:{}&quot;,targetCompanyName);</span><br><span class="line">            String city = matcher.group(&quot;city&quot;);</span><br><span class="line">            log.info(&quot;city:{}&quot;,city);</span><br><span class="line">            if (StringUtils.isNotBlank(city) &amp;&amp; targetCompanyName.contains(city)){</span><br><span class="line">                targetCompanyName = targetCompanyName.replace(city,&quot;&quot;);</span><br><span class="line">            }</span><br><span class="line">            log.info(&quot;&#x5904;&#x7406;&#x5B8C;&#x57CE;&#x5E02;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;:{}&quot;,targetCompanyName);</span><br><span class="line">            String county = matcher.group(&quot;county&quot;);</span><br><span class="line">            log.info(&quot;county:{}&quot;,county);</span><br><span class="line">            if (StringUtils.isNotBlank(county) &amp;&amp; targetCompanyName.contains(county)){</span><br><span class="line">                targetCompanyName = targetCompanyName.replace(county,&quot;&quot;);</span><br><span class="line">            }</span><br><span class="line">            log.info(&quot;&#x5904;&#x7406;&#x5B8C;&#x533A;&#x53BF;&#x7EA7;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;:{}&quot;,targetCompanyName);</span><br><span class="line">        }</span><br><span class="line">        String[][] address = AddressUtil.ADDRESS;</span><br><span class="line">        for (String [] city: address) {</span><br><span class="line">            for (String b : city ) {</span><br><span class="line">                if (targetCompanyName.contains(b)){</span><br><span class="line">                    targetCompanyName = targetCompanyName.replace(b, &quot;&quot;);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        log.info(&quot;&#x5904;&#x7406;&#x540E;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;:{}&quot;,targetCompanyName);</span><br><span class="line">        return targetCompanyName;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>&#x5730;&#x540D;&#x5DE5;&#x5177;&#x7C7B;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public class AddressUtil {</span><br><span class="line">    public static final String[][] ADDRESS = {</span><br><span class="line">            {&quot;&#x5317;&#x4EAC;&quot;},</span><br><span class="line">            {&quot;&#x5929;&#x6D25;&quot;},</span><br><span class="line">            {&quot;&#x5B89;&#x5FBD;&quot;,&quot;&#x5B89;&#x5E86;&quot;,&quot;&#x868C;&#x57E0;&quot;,&quot;&#x4EB3;&#x5DDE;&quot;,&quot;&#x5DE2;&#x6E56;&quot;,&quot;&#x6C60;&#x5DDE;&quot;,&quot;&#x6EC1;&#x5DDE;&quot;,&quot;&#x961C;&#x9633;&quot;,&quot;&#x5408;&#x80A5;&quot;,&quot;&#x6DEE;&#x5317;&quot;,&quot;&#x6DEE;&#x5357;&quot;,&quot;&#x9EC4;&#x5C71;&quot;,&quot;&#x516D;&#x5B89;&quot;,&quot;&#x9A6C;&#x978D;&#x5C71;&quot;,&quot;&#x5BBF;&#x5DDE;&quot;,&quot;&#x94DC;&#x9675;&quot;,&quot;&#x829C;&#x6E56;&quot;,&quot;&#x5BA3;&#x57CE;&quot;},</span><br><span class="line">            {&quot;&#x6FB3;&#x95E8;&quot;},</span><br><span class="line">            {&quot;&#x9999;&#x6E2F;&quot;},</span><br><span class="line">            {&quot;&#x798F;&#x5EFA;&quot;,&quot;&#x798F;&#x5DDE;&quot;,&quot;&#x9F99;&#x5CA9;&quot;,&quot;&#x5357;&#x5E73;&quot;,&quot;&#x5B81;&#x5FB7;&quot;,&quot;&#x8386;&#x7530;&quot;,&quot;&#x6CC9;&#x5DDE;&quot;,&quot;&#x53A6;&#x95E8;&quot;,&quot;&#x6F33;&#x5DDE;&quot;},</span><br><span class="line">            {&quot;&#x7518;&#x8083;&quot;,&quot;&#x767D;&#x94F6;&quot;,&quot;&#x5B9A;&#x897F;&quot;,&quot;&#x7518;&#x5357;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5609;&#x5CEA;&#x5173;&quot;,&quot;&#x91D1;&#x660C;&quot;,&quot;&#x9152;&#x6CC9;&quot;,&quot;&#x5170;&#x5DDE;&quot;,&quot;&#x4E34;&#x590F;&#x56DE;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x9647;&#x5357;&quot;,&quot;&#x5E73;&#x51C9;&quot;,&quot;&#x5E86;&#x9633;&quot;,&quot;&#x5929;&#x6C34;&quot;,&quot;&#x6B66;&#x5A01;&quot;,&quot;&#x5F20;&#x6396;&quot;},</span><br><span class="line">            {&quot;&#x5E7F;&#x4E1C;&quot;,&quot;&#x6F6E;&#x5DDE;&quot;,&quot;&#x4E1C;&#x839E;&quot;,&quot;&#x4F5B;&#x5C71;&quot;,&quot;&#x5E7F;&#x5DDE;&quot;,&quot;&#x6CB3;&#x6E90;&quot;,&quot;&#x60E0;&#x5DDE;&quot;,&quot;&#x6C5F;&#x95E8;&quot;,&quot;&#x63ED;&#x9633;&quot;,&quot;&#x8302;&#x540D;&quot;,&quot;&#x6885;&#x5DDE;&quot;,&quot;&#x6E05;&#x8FDC;&quot;,&quot;&#x6C55;&#x5934;&quot;,&quot;&#x6C55;&#x5C3E;&quot;,&quot;&#x97F6;&#x5173;&quot;,&quot;&#x6DF1;&#x5733;&quot;,&quot;&#x9633;&#x6C5F;&quot;,&quot;&#x4E91;&#x6D6E;&quot;,&quot;&#x6E5B;&#x6C5F;&quot;,&quot;&#x8087;&#x5E86;&quot;,&quot;&#x4E2D;&#x5C71;&quot;,&quot;&#x73E0;&#x6D77;&quot;},</span><br><span class="line">            {&quot;&#x5E7F;&#x897F;&quot;,&quot;&#x767E;&#x8272;&quot;,&quot;&#x5317;&#x6D77;&quot;,&quot;&#x5D07;&#x5DE6;&quot;,&quot;&#x9632;&#x57CE;&#x6E2F;&quot;,&quot;&#x8D35;&#x6E2F;&quot;,&quot;&#x6842;&#x6797;&quot;,&quot;&#x6CB3;&#x6C60;&quot;,&quot;&#x8D3A;&#x5DDE;&quot;,&quot;&#x6765;&#x5BBE;&quot;,&quot;&#x67F3;&#x5DDE;&quot;,&quot;&#x5357;&#x5B81;&quot;,&quot;&#x94A6;&#x5DDE;&quot;,&quot;&#x68A7;&#x5DDE;&quot;,&quot;&#x7389;&#x6797;&quot;},</span><br><span class="line">            {&quot;&#x8D35;&#x5DDE;&quot;,&quot;&#x5B89;&#x987A;&quot;,&quot;&#x6BD5;&#x8282;&#x5730;&#x533A;&quot;,&quot;&#x8D35;&#x9633;&quot;,&quot;&#x516D;&#x76D8;&#x6C34;&quot;,&quot;&#x9ED4;&#x4E1C;&#x5357;&#x82D7;&#x65CF;&#x4F97;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x9ED4;&#x5357;&#x5E03;&#x4F9D;&#x65CF;&#x82D7;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x9ED4;&#x897F;&#x5357;&#x5E03;&#x4F9D;&#x65CF;&#x82D7;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x94DC;&#x4EC1;&#x5730;&#x533A;&quot;,&quot;&#x9075;&#x4E49;&quot;},</span><br><span class="line">            {&quot;&#x6D77;&#x5357;&quot;,&quot;&#x6D77;&#x53E3;&quot;,&quot;&#x4E09;&#x4E9A;&quot;,&quot;&#x76F4;&#x8F96;&#x53BF;&#x7EA7;&#x884C;&#x653F;&#x533A;&#x5212;&quot;},</span><br><span class="line">            {&quot;&#x6CB3;&#x5317;&quot;,&quot;&#x4FDD;&#x5B9A;&quot;,&quot;&#x6CA7;&#x5DDE;&quot;,&quot;&#x627F;&#x5FB7;&quot;,&quot;&#x90AF;&#x90F8;&quot;,&quot;&#x8861;&#x6C34;&quot;,&quot;&#x5ECA;&#x574A;&quot;,&quot;&#x79E6;&#x7687;&#x5C9B;&quot;,&quot;&#x77F3;&#x5BB6;&#x5E84;&quot;,&quot;&#x5510;&#x5C71;&quot;,&quot;&#x90A2;&#x53F0;&quot;,&quot;&#x5F20;&#x5BB6;&#x53E3;&quot;},</span><br><span class="line">            {&quot;&#x6CB3;&#x5357;&quot;,&quot;&#x5B89;&#x9633;&quot;,&quot;&#x9E64;&#x58C1;&quot;,&quot;&#x7126;&#x4F5C;&quot;,&quot;&#x5F00;&#x5C01;&quot;,&quot;&#x6D1B;&#x9633;&quot;,&quot;&#x6F2F;&#x6CB3;&quot;,&quot;&#x5357;&#x9633;&quot;,&quot;&#x5E73;&#x9876;&#x5C71;&quot;,&quot;&#x6FEE;&#x9633;&quot;,&quot;&#x4E09;&#x95E8;&#x5CE1;&quot;,&quot;&#x5546;&#x4E18;&quot;,&quot;&#x65B0;&#x4E61;&quot;,&quot;&#x4FE1;&#x9633;&quot;,&quot;&#x8BB8;&#x660C;&quot;,&quot;&#x90D1;&#x5DDE;&quot;,&quot;&#x5468;&#x53E3;&quot;,&quot;&#x9A7B;&#x9A6C;&#x5E97;&quot;},</span><br><span class="line">            {&quot;&#x9ED1;&#x9F99;&#x6C5F;&quot;,&quot;&#x5927;&#x5E86;&quot;,&quot;&#x5927;&#x5174;&#x5B89;&#x5CAD;&#x5730;&#x533A;&quot;,&quot;&#x54C8;&#x5C14;&#x6EE8;&quot;,&quot;&#x9E64;&#x5C97;&quot;,&quot;&#x9ED1;&#x6CB3;&quot;,&quot;&#x9E21;&#x897F;&quot;,&quot;&#x4F73;&#x6728;&#x65AF;&quot;,&quot;&#x7261;&#x4E39;&#x6C5F;&quot;,&quot;&#x4E03;&#x53F0;&#x6CB3;&quot;,&quot;&#x9F50;&#x9F50;&#x54C8;&#x5C14;&quot;,&quot;&#x53CC;&#x9E2D;&#x5C71;&quot;,&quot;&#x7EE5;&#x5316;&quot;,&quot;&#x4F0A;&#x6625;&quot;},</span><br><span class="line">            {&quot;&#x6E56;&#x5317;&quot;,&quot;&#x9102;&#x5DDE;&quot;,&quot;&#x6069;&#x65BD;&#x571F;&#x5BB6;&#x65CF;&#x82D7;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x9EC4;&#x5188;&quot;,&quot;&#x9EC4;&#x77F3;&quot;,&quot;&#x8346;&#x95E8;&quot;,&quot;&#x8346;&#x5DDE;&quot;,&quot;&#x5341;&#x5830;&quot;,&quot;&#x968F;&#x5DDE;&quot;,&quot;&#x6B66;&#x6C49;&quot;,&quot;&#x54B8;&#x5B81;&quot;,&quot;&#x8944;&#x6A0A;&quot;,&quot;&#x5B5D;&#x611F;&quot;,&quot;&#x5B9C;&#x660C;&quot;},</span><br><span class="line">            {&quot;&#x6E56;&#x5357;&quot;,&quot;&#x957F;&#x6C99;&quot;,&quot;&#x5E38;&#x5FB7;&quot;,&quot;&#x90F4;&#x5DDE;&quot;,&quot;&#x8861;&#x9633;&quot;,&quot;&#x6000;&#x5316;&quot;,&quot;&#x5A04;&#x5E95;&quot;,&quot;&#x90B5;&#x9633;&quot;,&quot;&#x6E58;&#x6F6D;&quot;,&quot;&#x6E58;&#x897F;&#x571F;&#x5BB6;&#x65CF;&#x82D7;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x76CA;&#x9633;&quot;,&quot;&#x6C38;&#x5DDE;&quot;,&quot;&#x5CB3;&#x9633;&quot;,&quot;&#x5F20;&#x5BB6;&#x754C;&quot;,&quot;&#x682A;&#x6D32;&quot;},</span><br><span class="line">            {&quot;&#x5409;&#x6797;&quot;,&quot;&#x767D;&#x57CE;&quot;,&quot;&#x767D;&#x5C71;&quot;,&quot;&#x957F;&#x6625;&quot;,&quot;&#x5409;&#x6797;&quot;,&quot;&#x8FBD;&#x6E90;&quot;,&quot;&#x56DB;&#x5E73;&quot;,&quot;&#x677E;&#x539F;&quot;,&quot;&#x901A;&#x5316;&quot;,&quot;&#x5EF6;&#x8FB9;&#x671D;&#x9C9C;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;},</span><br><span class="line">            {&quot;&#x6C5F;&#x82CF;&quot;,&quot;&#x5E38;&#x5DDE;&quot;,&quot;&#x6DEE;&#x5B89;&quot;,&quot;&#x8FDE;&#x4E91;&#x6E2F;&quot;,&quot;&#x5357;&#x4EAC;&quot;,&quot;&#x5357;&#x901A;&quot;,&quot;&#x82CF;&#x5DDE;&quot;,&quot;&#x5BBF;&#x8FC1;&quot;,&quot;&#x6CF0;&#x5DDE;&quot;,&quot;&#x65E0;&#x9521;&quot;,&quot;&#x5F90;&#x5DDE;&quot;,&quot;&#x76D0;&#x57CE;&quot;,&quot;&#x626C;&#x5DDE;&quot;,&quot;&#x9547;&#x6C5F;&quot;},</span><br><span class="line">            {&quot;&#x6C5F;&#x897F;&quot;,&quot;&#x629A;&#x5DDE;&quot;,&quot;&#x8D63;&#x5DDE;&quot;,&quot;&#x5409;&#x5B89;&quot;,&quot;&#x666F;&#x5FB7;&#x9547;&quot;,&quot;&#x4E5D;&#x6C5F;&quot;,&quot;&#x5357;&#x660C;&quot;,&quot;&#x840D;&#x4E61;&quot;,&quot;&#x4E0A;&#x9976;&quot;,&quot;&#x65B0;&#x4F59;&quot;,&quot;&#x5B9C;&#x6625;&quot;,&quot;&#x9E70;&#x6F6D;&quot;},</span><br><span class="line">            {&quot;&#x8FBD;&#x5B81;&quot;,&quot;&#x978D;&#x5C71;&quot;,&quot;&#x672C;&#x6EAA;&quot;,&quot;&#x671D;&#x9633;&quot;,&quot;&#x5927;&#x8FDE;&quot;,&quot;&#x4E39;&#x4E1C;&quot;,&quot;&#x629A;&#x987A;&quot;,&quot;&#x961C;&#x65B0;&quot;,&quot;&#x846B;&#x82A6;&#x5C9B;&quot;,&quot;&#x9526;&#x5DDE;&quot;,&quot;&#x8FBD;&#x9633;&quot;,&quot;&#x76D8;&#x9526;&quot;,&quot;&#x6C88;&#x9633;&quot;,&quot;&#x94C1;&#x5CAD;&quot;,&quot;&#x8425;&#x53E3;&quot;},</span><br><span class="line">            {&quot;&#x5185;&#x8499;&#x53E4;&quot;,&quot;&#x963F;&#x62C9;&#x5584;&#x76DF;&quot;,&quot;&#x5DF4;&#x5F66;&#x6DD6;&#x5C14;&quot;,&quot;&#x5305;&#x5934;&quot;,&quot;&#x8D64;&#x5CF0;&quot;,&quot;&#x9102;&#x5C14;&#x591A;&#x65AF;&quot;,&quot;&#x547C;&#x548C;&#x6D69;&#x7279;&quot;,&quot;&#x547C;&#x4F26;&#x8D1D;&#x5C14;&quot;,&quot;&#x901A;&#x8FBD;&quot;,&quot;&#x4E4C;&#x6D77;&quot;,&quot;&#x4E4C;&#x5170;&#x5BDF;&#x5E03;&quot;,&quot;&#x9521;&#x6797;&#x90ED;&#x52D2;&#x76DF;&quot;,&quot;&#x5174;&#x5B89;&#x76DF;&quot;},</span><br><span class="line">            {&quot;&#x5B81;&#x590F;&#x56DE;&#x65CF;&quot;,&quot;&#x56FA;&#x539F;&quot;,&quot;&#x77F3;&#x5634;&#x5C71;&quot;,&quot;&#x5434;&#x5FE0;&quot;,&quot;&#x94F6;&#x5DDD;&quot;,&quot;&#x4E2D;&#x536B;&quot;},</span><br><span class="line">            {&quot;&#x9752;&#x6D77;&quot;,&quot;&#x679C;&#x6D1B;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x6D77;&#x5317;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x6D77;&#x4E1C;&#x5730;&#x533A;&quot;,&quot;&#x6D77;&#x5357;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x6D77;&#x897F;&#x8499;&#x53E4;&#x65CF;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x9EC4;&#x5357;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x897F;&#x5B81;&quot;,&quot;&#x7389;&#x6811;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;},</span><br><span class="line">            {&quot;&#x5C71;&#x4E1C;&quot;,&quot;&#x6EE8;&#x5DDE;&quot;,&quot;&#x5FB7;&#x5DDE;&quot;,&quot;&#x4E1C;&#x8425;&quot;,&quot;&#x83CF;&#x6CFD;&quot;,&quot;&#x6D4E;&#x5357;&quot;,&quot;&#x6D4E;&#x5B81;&quot;,&quot;&#x83B1;&#x829C;&quot;,&quot;&#x804A;&#x57CE;&quot;,&quot;&#x4E34;&#x6C82;&quot;,&quot;&#x9752;&#x5C9B;&quot;,&quot;&#x65E5;&#x7167;&quot;,&quot;&#x6CF0;&#x5B89;&quot;,&quot;&#x5A01;&#x6D77;&quot;,&quot;&#x6F4D;&#x574A;&quot;,&quot;&#x70DF;&#x53F0;&quot;,&quot;&#x67A3;&#x5E84;&quot;,&quot;&#x6DC4;&#x535A;&quot;},</span><br><span class="line">            {&quot;&#x5C71;&#x897F;&quot;,&quot;&#x957F;&#x6CBB;&quot;,&quot;&#x5927;&#x540C;&quot;,&quot;&#x664B;&#x57CE;&quot;,&quot;&#x664B;&#x4E2D;&quot;,&quot;&#x4E34;&#x6C7E;&quot;,&quot;&#x5415;&#x6881;&quot;,&quot;&#x6714;&#x5DDE;&quot;,&quot;&#x592A;&#x539F;&quot;,&quot;&#x5FFB;&#x5DDE;&quot;,&quot;&#x9633;&#x6CC9;&quot;,&quot;&#x8FD0;&#x57CE;&quot;},</span><br><span class="line">            {&quot;&#x9655;&#x897F;&quot;,&quot;&#x5B89;&#x5EB7;&quot;,&quot;&#x5B9D;&#x9E21;&quot;,&quot;&#x6C49;&#x4E2D;&quot;,&quot;&#x5546;&#x6D1B;&quot;,&quot;&#x94DC;&#x5DDD;&quot;,&quot;&#x6E2D;&#x5357;&quot;,&quot;&#x897F;&#x5B89;&quot;,&quot;&#x54B8;&#x9633;&quot;,&quot;&#x5EF6;&#x5B89;&quot;,&quot;&#x6986;&#x6797;&quot;},</span><br><span class="line">            {&quot;&#x4E0A;&#x6D77;&quot;},</span><br><span class="line">            {&quot;&#x56DB;&#x5DDD;&quot;,&quot;&#x963F;&#x575D;&#x85CF;&#x65CF;&#x7F8C;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5DF4;&#x4E2D;&quot;,&quot;&#x6210;&#x90FD;&quot;,&quot;&#x8FBE;&#x5DDE;&quot;,&quot;&#x5FB7;&#x9633;&quot;,&quot;&#x7518;&#x5B5C;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5E7F;&#x5B89;&quot;,&quot;&#x5E7F;&#x5143;&quot;,&quot;&#x4E50;&#x5C71;&quot;,&quot;&#x51C9;&#x5C71;&#x5F5D;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x6CF8;&#x5DDE;&quot;,&quot;&#x7709;&#x5C71;&quot;,&quot;&#x7EF5;&#x9633;&quot;,&quot;&#x5185;&#x6C5F;&quot;,&quot;&#x5357;&#x5145;&quot;,&quot;&#x6500;&#x679D;&#x82B1;&quot;,&quot;&#x9042;&#x5B81;&quot;,&quot;&#x96C5;&#x5B89;&quot;,&quot;&#x5B9C;&#x5BBE;&quot;,&quot;&#x8D44;&#x9633;&quot;,&quot;&#x81EA;&#x8D21;&quot;},</span><br><span class="line">            {&quot;&#x897F;&#x85CF;&quot;,&quot;&#x963F;&#x91CC;&#x5730;&#x533A;&quot;,&quot;&#x660C;&#x90FD;&#x5730;&#x533A;&quot;,&quot;&#x62C9;&#x8428;&quot;,&quot;&#x6797;&#x829D;&#x5730;&#x533A;&quot;,&quot;&#x90A3;&#x66F2;&#x5730;&#x533A;&quot;,&quot;&#x65E5;&#x5580;&#x5219;&#x5730;&#x533A;&quot;,&quot;&#x5C71;&#x5357;&#x5730;&#x533A;&quot;},</span><br><span class="line">            {&quot;&#x65B0;&#x7586;&#x7EF4;&#x543E;&#x5C14;&quot;,&quot;&#x963F;&#x514B;&#x82CF;&#x5730;&#x533A;&quot;,&quot;&#x963F;&#x52D2;&#x6CF0;&#x5730;&#x533A;&quot;,&quot;&#x5DF4;&#x97F3;&#x90ED;&#x695E;&#x8499;&#x53E4;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x535A;&#x5C14;&#x5854;&#x62C9;&#x8499;&#x53E4;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x660C;&#x5409;&#x56DE;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x54C8;&#x5BC6;&#x5730;&#x533A;&quot;,&quot;&#x548C;&#x7530;&#x5730;&#x533A;&quot;,&quot;&#x5580;&#x4EC0;&#x5730;&#x533A;&quot;,&quot;&#x514B;&#x62C9;&#x739B;&#x4F9D;&quot;,&quot;&#x514B;&#x5B5C;&#x52D2;&#x82CF;&#x67EF;&#x5C14;&#x514B;&#x5B5C;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5854;&#x57CE;&#x5730;&#x533A;&quot;,&quot;&#x5410;&#x9C81;&#x756A;&#x5730;&#x533A;&quot;,&quot;&#x4E4C;&#x9C81;&#x6728;&#x9F50;&quot;,&quot;&#x4F0A;&#x7281;&#x54C8;&#x8428;&#x514B;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x76F4;&#x8F96;&#x53BF;&#x7EA7;&#x884C;&#x653F;&#x533A;&#x5212;&quot;},</span><br><span class="line">            {&quot;&#x4E91;&#x5357;&quot;,&quot;&#x4FDD;&#x5C71;&quot;,&quot;&#x695A;&#x96C4;&#x5F5D;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5927;&#x7406;&#x767D;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x5FB7;&#x5B8F;&#x50A3;&#x65CF;&#x666F;&#x9887;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x8FEA;&#x5E86;&#x85CF;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x7EA2;&#x6CB3;&#x54C8;&#x5C3C;&#x65CF;&#x5F5D;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x6606;&#x660E;&quot;,&quot;&#x4E3D;&#x6C5F;&quot;,&quot;&#x4E34;&#x6CA7;&quot;,&quot;&#x6012;&#x6C5F;&#x50F3;&#x50F3;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x666E;&#x6D31;&quot;,&quot;&#x66F2;&#x9756;&quot;,&quot;&#x6587;&#x5C71;&#x58EE;&#x65CF;&#x82D7;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x897F;&#x53CC;&#x7248;&#x7EB3;&#x50A3;&#x65CF;&#x81EA;&#x6CBB;&#x5DDE;&quot;,&quot;&#x7389;&#x6EAA;&quot;,&quot;&#x662D;&#x901A;&quot;},</span><br><span class="line">            {&quot;&#x6D59;&#x6C5F;&quot;,&quot;&#x676D;&#x5DDE;&quot;,&quot;&#x6E56;&#x5DDE;&quot;,&quot;&#x5609;&#x5174;&quot;,&quot;&#x91D1;&#x534E;&quot;,&quot;&#x4E3D;&#x6C34;&quot;,&quot;&#x5B81;&#x6CE2;&quot;,&quot;&#x8862;&#x5DDE;&quot;,&quot;&#x7ECD;&#x5174;&quot;,&quot;&#x53F0;&#x5DDE;&quot;,&quot;&#x6E29;&#x5DDE;&quot;,&quot;&#x821F;&#x5C71;&quot;},</span><br><span class="line">            {&quot;&#x91CD;&#x5E86;&quot;},</span><br><span class="line">            {&quot;&#x53F0;&#x6E7E;&quot;,&quot;&#x53F0;&#x5317;&quot;,&quot;&#x9AD8;&#x96C4;&quot;,&quot;&#x57FA;&#x9686;&quot;,&quot;&#x53F0;&#x4E2D;&quot;,&quot;&#x53F0;&#x5357;&quot;,&quot;&#x65B0;&#x7AF9;&quot;,&quot;&#x5609;&#x4E49;&quot;},</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="5-2-&#x5206;&#x8BCD;&#x76F8;&#x5173;&#x4EE3;&#x7801;"><a href="#5-2-&#x5206;&#x8BCD;&#x76F8;&#x5173;&#x4EE3;&#x7801;" class="headerlink" title="5.2 &#x5206;&#x8BCD;&#x76F8;&#x5173;&#x4EE3;&#x7801;"></a>5.2 &#x5206;&#x8BCD;&#x76F8;&#x5173;&#x4EE3;&#x7801;</h2><ul>
<li><strong>pom&#x6587;&#x4EF6;&#xFF1A;&#x5F15;&#x5165;IK&#x5206;&#x8BCD;&#x5668;&#x76F8;&#x5173;&#x4F9D;&#x8D56;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801; &lt;!-- ikAnalyzer &#x4E2D;&#x6587;&#x5206;&#x8BCD;&#x5668;  --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.janeluo&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;ikanalyzer&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2012_u6&lt;/version&gt;</span><br><span class="line">        &lt;exclusions&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;/exclusion&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;lucene-queryparser&lt;/artifactId&gt;</span><br><span class="line">            &lt;/exclusion&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;lucene-analyzers-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;/exclusion&gt;</span><br><span class="line">        &lt;/exclusions&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--  lucene-queryParser &#x67E5;&#x8BE2;&#x5206;&#x6790;&#x5668;&#x6A21;&#x5757; --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lucene-queryparser&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>IKAnalyzerSupport&#x7C7B;&#xFF1A;&#x7528;&#x4E8E;&#x914D;&#x7F6E;&#x5206;&#x8BCD;&#x5668;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class IKAnalyzerSupport {</span><br><span class="line">    /**</span><br><span class="line">     * IK&#x5206;&#x8BCD;</span><br><span class="line">     * @param target</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static List&lt;String&gt; iKSegmenterToList(String target) throws Exception {</span><br><span class="line">        if (StringUtils.isEmpty(target)){</span><br><span class="line">            return new ArrayList();</span><br><span class="line">        }</span><br><span class="line">        List&lt;String&gt; result = new ArrayList&lt;&gt;();</span><br><span class="line">        StringReader sr = new StringReader(target);</span><br><span class="line">        // false:&#x5173;&#x95ED;&#x667A;&#x80FD;&#x5206;&#x8BCD; (&#x5BF9;&#x5206;&#x8BCD;&#x7684;&#x7CBE;&#x5EA6;&#x5F71;&#x54CD;&#x8F83;&#x5927;)</span><br><span class="line">        IKSegmenter ik = new IKSegmenter(sr, true);</span><br><span class="line">        Lexeme lex;</span><br><span class="line">        while((lex=ik.next())!=null) {</span><br><span class="line">            String lexemeText = lex.getLexemeText();</span><br><span class="line">            result.add(lexemeText);</span><br><span class="line">        }</span><br><span class="line">        return result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ServiceImpl&#x7C7B;&#xFF1A;&#x8FDB;&#x884C;&#x5206;&#x8BCD;&#x5904;&#x7406;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801; /**</span><br><span class="line"> * &#x5BF9;&#x76EE;&#x6807;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x8FDB;&#x884C;&#x5206;&#x8BCD;</span><br><span class="line"> * @param targetCompanyName</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private String splitWord(String targetCompanyName){</span><br><span class="line">    log.info(&quot;&#x5BF9;&#x5904;&#x7406;&#x540E;&#x7AEF;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x8FDB;&#x884C;&#x5206;&#x8BCD;&quot;);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; splitWord = new ArrayList&lt;&gt;();</span><br><span class="line">    String result = targetCompanyName;</span><br><span class="line">    try {</span><br><span class="line">        splitWord = iKSegmenterToList(targetCompanyName);</span><br><span class="line">        result =  splitWord.stream().map(String::valueOf).distinct().collect(Collectors.joining(&quot;|&quot;)) ;</span><br><span class="line">        log.info(&quot;&#x5206;&#x8BCD;&#x7ED3;&#x679C;:{}&quot;,result);</span><br><span class="line">    } catch (Exception e) {</span><br><span class="line">        log.error(&quot;&#x5206;&#x8BCD;&#x62A5;&#x9519;:{}&quot;,e.getMessage());</span><br><span class="line">    }</span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="5-3-&#x5339;&#x914D;"><a href="#5-3-&#x5339;&#x914D;" class="headerlink" title="5.3 &#x5339;&#x914D;"></a>5.3 &#x5339;&#x914D;</h2><ul>
<li><strong>ServiceImpl&#x7C7B;&#xFF1A;&#x5339;&#x914D;&#x6838;&#x5FC3;&#x4EE3;&#x7801;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    public JsonResult matchCompanyName(CompanyDTO companyDTO, String accessToken, String localIp) {</span><br><span class="line">        // &#x5BF9;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x8FDB;&#x884C;&#x5904;&#x7406;</span><br><span class="line">        String sourceCompanyName = companyDTO.getCompanyName();</span><br><span class="line">        String targetCompanyName = sourceCompanyName;</span><br><span class="line">        log.info(&quot;&#x5904;&#x7406;&#x524D;&#x516C;&#x53F8;&#x540D;&#x79F0;:{}&quot;,targetCompanyName);</span><br><span class="line">        // &#x5904;&#x7406;&#x5706;&#x62EC;&#x53F7;</span><br><span class="line">        targetCompanyName = targetCompanyName.replaceAll(&quot;[&#xFF08;]|[&#xFF09;]|[(]|[)]&quot;,&quot;&quot;);</span><br><span class="line">        // &#x5904;&#x7406;&#x516C;&#x53F8;&#x76F8;&#x5173;&#x5173;&#x952E;&#x8BCD;</span><br><span class="line">        targetCompanyName = targetCompanyName.replaceAll(&quot;[(&#x96C6;&#x56E2;|&#x80A1;&#x4EFD;|&#x6709;&#x9650;|&#x8D23;&#x4EFB;|&#x5206;&#x516C;&#x53F8;)]&quot;, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">        if (!targetCompanyName.contains(&quot;&#x94F6;&#x884C;&quot;)){</span><br><span class="line">            // &#x53BB;&#x9664;&#x884C;&#x653F;&#x533A;&#x57DF;</span><br><span class="line">            targetCompanyName = formatCompanyName(targetCompanyName);</span><br><span class="line">        }</span><br><span class="line">        // &#x5206;&#x8BCD;</span><br><span class="line">        String splitCompanyName = splitWord(targetCompanyName);</span><br><span class="line">        //  &#x5339;&#x914D;</span><br><span class="line">        List&lt;Company&gt; matchedCompany = companyRepository.queryMatchCompanyName(splitCompanyName,targetCompanyName);</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; result = new ArrayList();</span><br><span class="line">        for (Company companyInfo : matchedCompany) {</span><br><span class="line">            result.add(companyInfo.getCompanyName());</span><br><span class="line">            if (companyDTO.getCompanyId().equals(companyInfo.getCompanyId())){</span><br><span class="line">                result.remove(companyInfo.getCompanyName());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return JsonResult.successResult(result);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Repository&#x7C7B;&#xFF1A;&#x7F16;&#x5199;SQL&#x8BED;&#x53E5;</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;/**  </span><br><span class="line">* &#x6A21;&#x7CCA;&#x5339;&#x914D;&#x516C;&#x53F8;&#x540D;&#x79F0;  </span><br><span class="line">* @param companyNameRegex &#x5206;&#x8BCD;&#x540E;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;</span><br><span class="line">* @param companyName &#x5206;&#x8BCD;&#x524D;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;  </span><br><span class="line">* @return  </span><br><span class="line">*/</span><br><span class="line">@Query(value = </span><br><span class="line">&quot;SELECT * FROM company WHERE isDeleted = &apos;0&apos; and companyName REGEXP ?1 </span><br><span class="line">ORDER BY length(REPLACE(companyName,?2,&apos;&apos;))/length(companyName) &quot;,</span><br><span class="line">nativeQuery = true)  </span><br><span class="line">List&lt;Company&gt; queryMatchCompanyName(String companyNameRegex,String companyName);</span><br></pre></td></tr></table></figure>

<p><strong>&#x6309;&#x7167;&#x5339;&#x914D;&#x5EA6;&#x6392;&#x5E8F;</strong>&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x70B9;&#xFF0C;<code>LENGTH(companyName)</code>&#x8FD4;&#x56DE;companyName&#x7684;&#x957F;&#x5EA6;&#xFF0C;<code>LENGTH(REPLACE(companyName, ?2, &apos;&apos;))</code>&#x8BA1;&#x7B97;&#x51FA;companyName&#x4E2D;&#x5173;&#x952E;&#x8BCD;&#x51FA;&#x73B0;&#x7684;&#x6B21;&#x6570;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5339;&#x914D;&#x7A0B;&#x5EA6;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x5339;&#x914D;&#x6B21;&#x6570;&#x8D8A;&#x591A;&#x7684;&#x516C;&#x53F8;&#x540D;&#x79F0;&#x6392;&#x5E8F;&#x8D8A;&#x9760;&#x524D;&#x3002;</p>
<h1 id="&#x53C2;&#x8003;&#x8D44;&#x6599;"><a href="#&#x53C2;&#x8003;&#x8D44;&#x6599;" class="headerlink" title="&#x53C2;&#x8003;&#x8D44;&#x6599;"></a>&#x53C2;&#x8003;&#x8D44;&#x6599;</h1><ul>
<li><a href="/external_links/50d28f4f9ee1ec843453c1be59c76fda.html" target="blank" rel="noopener">zhuanlan.zhihu.com/p/343198664</a> &#x3010;MySQL&#x6A21;&#x7CCA;&#x641C;&#x7D22;&#x3011;</li>
<li><a href="/external_links/b5e155a759e6690044899fe869e510fa.html" target="blank" rel="noopener">blog.csdn.net/Cy_LightBul&#x2026;</a> &#x3010;IK&#x5206;&#x8BCD;&#x5668;&#x96C6;&#x6210;Spring Boot&#x3011;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/6711a54be7a194f8a444cf635b6d6cce.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340461584643112971.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340461584643112971.html" itemprop="url">零基础入门AI：四步快速搭建本地的编程助手 Step 1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T19:29:22+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x7531;&#x4E8E;&#x79CD;&#x79CD;&#x539F;&#x56E0;&#xFF0C;&#x5C0F;&#x4F19;&#x4F34;&#x4EEC;&#x5728;&#x5199;&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x4E0D;&#x4E00;&#x5B9A;&#x80FD;&#x7528;&#x4E0A;Github Copilot&#xFF1B;&#x6216;&#x8005;&#x7531;&#x4E8E;&#x4EE3;&#x7801;&#x5B89;&#x5168;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x5916;&#x7F51;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#x3002;&#x4ECA;&#x5929;&#x6211;&#x5C31;&#x4ECB;&#x7ECD;&#x4E00;&#x79CD;&#x5229;&#x7528;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x5728;&#x672C;&#x5730;&#x642D;&#x5EFA;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#x7684;&#x65B9;&#x6848;&#xFF1A;</p>
<ul>
<li>IDE&#x63D2;&#x4EF6;&#xFF1A;Continue</li>
<li>&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6846;&#x67B6;&#xFF1A;Ollama</li>
<li>&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF08;&#x63A8;&#x8350; Code Llama&#xFF09;</li>
</ul>
<p>&#x8BE5;&#x65B9;&#x6848;&#x9002;&#x7528;&#x4E8E; VS Code &#x548C; PyCharm&#xFF0C;&#x642D;&#x5EFA;&#x7684;&#x6B65;&#x9AA4;&#x7C7B;&#x4F3C;&#xFF0C;&#x5982;&#x4E0B;&#x6B65;&#x9AA4;&#x4E2D;&#x4EE5;VS Code&#x4E3A;&#x4F8B;&#x8BF4;&#x660E;&#x3002;</p>
<h1 id="Step-1-&#x5B89;&#x88C5;-Continue-&#x63D2;&#x4EF6;"><a href="#Step-1-&#x5B89;&#x88C5;-Continue-&#x63D2;&#x4EF6;" class="headerlink" title="Step 1: &#x5B89;&#x88C5; Continue &#x63D2;&#x4EF6;"></a>Step 1: &#x5B89;&#x88C5; Continue &#x63D2;&#x4EF6;</h1><p>&#x5728;VS Code &#x548C; PyCharm&#x7684;&#x63D2;&#x4EF6;&#x5E02;&#x573A;&#x4E2D;&#x641C;&#x7D22;&#x5E76;&#x5B89;&#x88C5; Continue &#x63D2;&#x4EF6;&#xFF0C;&#x4EE5;VS Code&#x4E3A;&#x4F8B;&#xFF0C;&#x5B89;&#x88C5;&#x6B65;&#x9AA4;&#x622A;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ae6f24d7083be86ffac25c9460c9399413484252f44cc7adca3155e067494d2a" alt="1.png"><br>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x5728;&#x7EBF;&#x7684;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x4F9B;&#x8BD5;&#x7528;&#xFF08;&#x9700;&#x8981;&#x8054;&#x7F51;&#xFF09;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f5cd4238efcee240cd041e3bcaff244451c9c41cd45a8b631bff71c9f562561e" alt="2.png"></p>
<p>&#x66F4;&#x591A;&#x5173;&#x4E8E;Continue&#x63D2;&#x4EF6;&#x7684;&#x7EC6;&#x8282;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;Continue&#x63D2;&#x4EF6;&#x7684;&#x5B98;&#x7F51;&#xFF1A;<a href="/external_links/914ccbe1748ac19e25d9af71234c5ffc.html" target="blank" rel="noopener">Continue&#x5B98;&#x7F51;</a></p>
<p>Continue&#x63D2;&#x4EF6;&#x652F;&#x6301;GPT-4 / Claude-2 &#x7B49;&#x6536;&#x8D39;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x81EA;&#x5DF1;&#x7684; api key &#x66F4;&#x65B0;&#x5230;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684; <code>apiKey</code> &#x5373;&#x53EF;&#xFF0C;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x5C06;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x4F7F;&#x7528; Continue &#x63D2;&#x4EF6;&#x8C03;&#x7528;&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;</p>
<h1 id="Step-2-&#x5B89;&#x88C5;&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6846;&#x67B6;-Ollama"><a href="#Step-2-&#x5B89;&#x88C5;&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6846;&#x67B6;-Ollama" class="headerlink" title="Step 2: &#x5B89;&#x88C5;&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6846;&#x67B6; Ollama"></a>Step 2: &#x5B89;&#x88C5;&#x672C;&#x5730;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6846;&#x67B6; Ollama</h1><p>Ollama &#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x5730;&#x90E8;&#x7F72;&#x548C;&#x7BA1;&#x7406;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x7531;&#x4E8E;&#x5B83;&#x6781;&#x5927;&#x7684;&#x7B80;&#x5316;&#x4E86;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#x7EC6;&#x8282;&#xFF0C;&#x4E00;&#x7ECF;&#x63A8;&#x51FA;&#x5C31;&#x5E7F;&#x53D7;&#x597D;&#x8BC4;&#xFF0C;&#x76EE;&#x524D;&#x5DF2;&#x5728;github&#x4E0A;&#x83B7;&#x5F97;&#x4E86;46k star&#x3002;</p>
<p>&#x5173;&#x4E8E;Ollama&#x7684;&#x66F4;&#x591A;&#x4ECB;&#x7ECD;&#x548C;&#x5B89;&#x88C5;&#x65B9;&#x6CD5;&#x8BF7;&#x53C2;&#x89C1; <a href="https://dev.newban.cn/7340197367515414538">&#x96F6;&#x57FA;&#x7840;&#x5165;&#x95E8;AI&#xFF1A;&#x4E00;&#x952E;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B; - Ollama</a>&#x3002;</p>
<h1 id="Step-3-&#x4E0B;&#x8F7D;&#x4EE3;&#x7801;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;-Code-Llama"><a href="#Step-3-&#x4E0B;&#x8F7D;&#x4EE3;&#x7801;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;-Code-Llama" class="headerlink" title="Step 3: &#x4E0B;&#x8F7D;&#x4EE3;&#x7801;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B; Code Llama"></a>Step 3: &#x4E0B;&#x8F7D;&#x4EE3;&#x7801;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B; Code Llama</h1><p>&#x5B89;&#x88C5;Ollama&#x540E;&#xFF0C;&#x5373;&#x53EF;&#x4E00;&#x952E;&#x5B89;&#x88C5;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;Ollama&#x652F;&#x6301;&#x5927;&#x90E8;&#x5206;&#x4E3B;&#x6D41;&#x7684;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4E0B;&#xFF0C;&#x6211;&#x66F4;&#x63A8;&#x8350;Meta&#x53D1;&#x5E03;&#x7684; <strong>CodeLlama</strong>&#xFF0C;&#x5305;&#x542B; 7b / 13b / 34b / 70b &#x56DB;&#x79CD;&#x53C2;&#x6570;&#x89C4;&#x6A21;&#xFF0C;&#x5C0F;&#x4F19;&#x4F34;&#x4EEC;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x672C;&#x5730;GPU&#x7684;&#x6027;&#x80FD;&#xFF0C;&#x4E0B;&#x8F7D;&#x5408;&#x9002;&#x7684;Code Llama&#x7248;&#x672C;</p>
<table>
<thead>
<tr>
<th>&#x53C2;&#x6570;&#x7248;&#x672C;</th>
<th>&#x94FE;&#x63A5;</th>
<th>&#x547D;&#x4EE4;</th>
</tr>
</thead>
<tbody><tr>
<td>7 billion</td>
<td><a href="/external_links/c7dadd46ad3753741ee4423f8c2b8677.html" target="blank" rel="noopener">View</a></td>
<td><code>ollama run codellama:7b</code></td>
</tr>
<tr>
<td>13 billion</td>
<td><a href="/external_links/609e85cf6caf20f3d011dd7f9097469e.html" target="blank" rel="noopener">View</a></td>
<td><code>ollama run codellama:13b</code></td>
</tr>
<tr>
<td>34 billion</td>
<td><a href="/external_links/6f962c60e432eda1fefcaec19d8e3f5c.html" target="blank" rel="noopener">View</a></td>
<td><code>ollama run codellama:34b</code></td>
</tr>
<tr>
<td>70 billion</td>
<td><a href="/external_links/a23b56ca96b4fa0e8607c3eac41d61e3.html" target="blank" rel="noopener">View</a></td>
<td><code>ollama run codellama:70b</code></td>
</tr>
</tbody></table>
<p>PS: Code Llama&#x9664;&#x4E86;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x53C2;&#x6570;&#x7248;&#x672C;&#xFF0C;&#x6839;&#x636E;&#x5FAE;&#x8C03;&#x8BED;&#x6599;&#x7684;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#xFF0C;&#x8FD8;&#x6709;&#x57FA;&#x7840;&#x3001;Python&#x3001;instruct&#x4E09;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x5FAE;&#x8C03;&#x7248;&#x672C;&#xFF0C;&#x5176;&#x4E2D;instruct&#x662F;&#x7ECF;&#x8FC7;&#x81EA;&#x7136;&#x8BED;&#x8A00;&#x6307;&#x4EE4;&#x5FAE;&#x8C03;&#x7684;&#xFF0C;&#x66F4;&#x9002;&#x5408;&#x672C;&#x6587;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x6240;&#x4EE5;&#x63A8;&#x8350;&#x4F7F;&#x7528; instruct &#x7248;&#x672C;&#xFF0C;&#x4EE5;&#x4E0A;&#x8868;&#x683C;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x9ED8;&#x8BA4;&#x4E0B;&#x8F7D;&#x7684;&#x5C31;&#x662F;instruct&#x7248;&#x672C;&#x3002;</p>
<h1 id="Step-4-&#x914D;&#x7F6E;-Continue-Ollama"><a href="#Step-4-&#x914D;&#x7F6E;-Continue-Ollama" class="headerlink" title="Step 4: &#x914D;&#x7F6E; Continue + Ollama"></a>Step 4: &#x914D;&#x7F6E; Continue + Ollama</h1><p>Ollama&#x670D;&#x52A1;&#x8FD0;&#x884C;&#x540E;&#xFF0C;&#x9ED8;&#x8BA4;&#x7684;API&#x63A5;&#x53E3;&#x5730;&#x5740;&#x662F;<code>localhost:11434</code>&#xFF0C;&#x80FD;&#x591F;&#x4E3A;&#x672C;&#x673A;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x3002;</p>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x5728;Ollama&#x4E2D;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF; <code>OLLAMA_HOST=0.0.0.0:11434</code> &#x6765;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF0C;API&#x63A5;&#x53E3;&#x5730;&#x5740;&#x5C31;&#x662F;<code>&lt;ollama server IP&gt;:11434</code>&#x3002;&#xFF08;&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x89C1; <a href="https://dev.newban.cn/7340197367515414538">&#x96F6;&#x57FA;&#x7840;&#x5165;&#x95E8;AI&#xFF1A;&#x4E00;&#x952E;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B; - Ollama</a>&#xFF09;</p>
<p>&#x5C06;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x4FE1;&#x606F;&#x548C;API&#x63A5;&#x53E3;&#x5730;&#x5740;&#x6DFB;&#x52A0;&#x5230; Continue &#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x4E3E;&#x4F8B;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;&quot;models&quot;: [</span><br><span class="line">&#xA0; &#xA0; {</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;title&quot;: &quot;codellama:7b&quot;,</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;provider&quot;: &quot;ollama&quot;,</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;model&quot;: &quot;codellama:7b&quot;,</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;api_base&quot;: &quot;localhost:11434&quot;</span><br><span class="line">&#xA0; &#xA0; }</span><br></pre></td></tr></table></figure>

<p>&#x4FEE;&#x6539;&#x5B8C;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x540E;&#xFF0C;&#x5728; IDE &#x7684; Continue &#x63D2;&#x4EF6;&#x754C;&#x9762;&#x9009;&#x62E9;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x6109;&#x5FEB;&#x7684;&#x4F7F;&#x7528;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x73A9;&#x800D;&#x4E86;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/7f7b7753f2e71e963d70cb889c285241cbbf424e5581c32d2a0809e922be5093" alt="3.png"></p>
<p>&#x81F3;&#x6B64;&#xFF0C;Continue&#x63D2;&#x4EF6;&#x5C31;&#x53EF;&#x4EE5;&#x548C;&#x672C;&#x5730;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x8054;&#x52A8;&#xFF0C;&#x8C03;&#x7528;&#x672C;&#x5730;&#x7684;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6765;&#x8F85;&#x52A9;&#x7F16;&#x7A0B;&#xFF0C;&#x5B9E;&#x73B0;&#x672C;&#x5730;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#x3002;</p>
<h1 id="Bingo-&#x8FD0;&#x884C;-Continue-Ollama"><a href="#Bingo-&#x8FD0;&#x884C;-Continue-Ollama" class="headerlink" title="Bingo! &#x8FD0;&#x884C; Continue + Ollama"></a>Bingo! &#x8FD0;&#x884C; Continue + Ollama</h1><p>&#x5982;&#x4E0B;&#x56FE;&#x4E2D;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x8BA9;&#x5927;&#x6A21;&#x578B;&#x5E2E;&#x5FD9;&#x5199;&#x4E00;&#x4E0B;python&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x7528;&#x4E8E;&#x5224;&#x65AD;&#x8F93;&#x5165;&#x7684;&#x6570;&#x5B57;&#x662F;&#x4E0D;&#x662F;&#x8D28;&#x6570;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/13022b66efb01c68d9d6c0220f3f7c81866c4dc5a8e3ffdf6ff5c5fd597b0d3e" alt="4.png"></p>
<h1 id="&#x6DFB;&#x52A0;&#x5E38;&#x7528;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4;-&#x53EF;&#x9009;"><a href="#&#x6DFB;&#x52A0;&#x5E38;&#x7528;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4;-&#x53EF;&#x9009;" class="headerlink" title="&#x6DFB;&#x52A0;&#x5E38;&#x7528;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4; (&#x53EF;&#x9009;)"></a>&#x6DFB;&#x52A0;&#x5E38;&#x7528;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4; (&#x53EF;&#x9009;)</h1><p>&#x9605;&#x8BFB; Continue &#x63D2;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5176;&#x4E2D;&#x5DF2;&#x7ECF;&#x5185;&#x7F6E;&#x4E86;&#x4E00;&#x4E9B;&#x5FEB;&#x6377;&#x6307;&#x4EE4;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C06;&#x4E00;&#x6BB5;&#x63D0;&#x793A;&#x8BCD;&#x7B80;&#x5316;&#x4E3A;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#xFF0C;&#x6BD4;&#x5982;:</p>
<ul>
<li>comment: &#x4E3A;&#x9009;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x6DFB;&#x52A0;&#x6CE8;&#x91CA;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x63D0;&#x793A;&#x8BCD;&#x662F; <code>Write comments for the highlighted code</code></li>
<li>edit: &#x7F16;&#x8F91;&#x9009;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x63D0;&#x793A;&#x8BCD;&#x662F; <code>Edit highlighted code</code></li>
</ul>
<p>&#x53C2;&#x7167;&#x8FD9;&#x4E9B;&#x793A;&#x4F8B;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x81EA;&#x5DF1;&#x5E38;&#x7528;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4;&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x4EE3;&#x7801;&#x8BC4;&#x5BA1;&#x7684;&#x5FEB;&#x6377;&#x6307;&#x4EE4; <code>review</code>&#xFF0C;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;&quot;custom_commands&quot;: [</span><br><span class="line">&#xA0; &#xA0; {</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;name&quot;: &quot;review&quot;,</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;prompt&quot;: &quot;Act as a comprehensive code review assistant to help me analyze and improve the selected code&quot;,</span><br><span class="line">&#xA0; &#xA0; &#xA0; &quot;description&quot;: &quot;Code review for highlighted code&quot;</span><br><span class="line">&#xA0; &#xA0; }</span><br><span class="line">&#xA0; ]</span><br></pre></td></tr></table></figure>

<p>PS:</p>
<ul>
<li>&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x6765;&#x8F85;&#x52A9;&#x751F;&#x6210;&#x4EE3;&#x7801;&#x3001;&#x6539;BUG&#x3001;&#x6DFB;&#x52A0;&#x6CE8;&#x91CA;&#x3001;&#x89E3;&#x91CA;&#x4EE3;&#x7801;&#x7B49;&#x7B49;&#x3002;</li>
<li>&#x4EE5;&#x4E0A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EC5;&#x4EE5;&#x6700;&#x5C0F;&#x89C4;&#x6A21;&#x7684;7B&#x7248;&#x672C;&#x4E3A;&#x4F8B;&#xFF0C;&#x672C;&#x5730;GPU&#x6027;&#x80FD;&#x66F4;&#x5F3A;&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x66F4;&#x5927;&#x53C2;&#x6570;&#x89C4;&#x6A21;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x4F7F;&#x7528;&#x6548;&#x679C;&#x4F1A;&#x66F4;&#x597D;&#x4E00;&#x4E9B;&#x3002;</li>
<li>&#x672C;&#x6587;&#x63A8;&#x8350;&#x7684;&#x4EE3;&#x7801;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B; Code Llama &#x7684;&#x8BAD;&#x7EC3;&#x8BED;&#x6599;&#x4E2D;&#xFF0C;&#x4E2D;&#x6587;&#x8BED;&#x6599;&#x6240;&#x5360;&#x7684;&#x6BD4;&#x4F8B;&#x8F83;&#x5C11;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;&#x82F1;&#x6587;&#x63D0;&#x95EE;&#x7684;&#x6548;&#x679C;&#x4F1A;&#x66F4;&#x597D;&#x4E00;&#x4E9B;&#x3002;</li>
<li>Ollama&#x540C;&#x6837;&#x4E5F;&#x652F;&#x6301;&#x4E00;&#x4E9B;&#x4E2D;&#x6587;&#x7684;&#x5F00;&#x6E90;&#x6A21;&#x578B;&#xFF0C;&#x6BD4;&#x5982;qwen &#x3001;Yi&#x7B49;&#x7B49;&#xFF0C;&#x8FD9;&#x4E9B;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x4E2D;&#x6587;&#x7684;&#x652F;&#x6301;&#x5C31;&#x4F1A;&#x66F4;&#x597D;&#x4E00;&#x4E9B;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x7167;&#x6587;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x5B89;&#x88C5;&#x4F7F;&#x7528;&#x3002;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/ed7879c214f2a14a75d1024ce9df79ce.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340278606391738387.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340278606391738387.html" itemprop="url">【Android 13源码分析】Activity启动流程-3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T16:58:16+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#xFF0C;&#x672C;&#x7BC7;&#x4E3A;Activity&#x542F;&#x52A8;&#x7684;&#x7B2C;&#x4E09;&#x7BC7;&#xFF0C; &#x4E3B;&#x8981;&#x662F;&#x5728;&#x76EE;&#x6807;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x540E;&#x7684;&#x903B;&#x8F91;&#x3002;</p>
<ol>
<li><h1 id="&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;"><a href="#&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;" class="headerlink" title="&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;"></a>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;</h1></li>
</ol>
<p>java&#x7684;&#x65B9;&#x6CD5;&#x7684;main&#x51FD;&#x6570;<br>&#x5176;&#x5B9E;&#x5728;&#x6267;&#x884C;&#x5230;AMS::attachApplication&#x524D;&#xFF0C;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x4E5F;&#x6709;&#x4E00;&#x6BB5;&#x903B;&#x8F91;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityThread</span><br><span class="line">    // ApplicationThread &#x662F; AMS &#x4F5C;&#x4E3A; C &#x7AEF;&#x65F6;&#xFF0C;&#x4E0E;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x7684;&#x65B9;&#x5F0F;</span><br><span class="line">    final ApplicationThread mAppThread = new ApplicationThread();</span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        ......</span><br><span class="line">        // &#x91CD;&#x70B9; *1. &#x4E3B;&#x7EBF;&#x7A0B;Looper &#x5904;&#x7406;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;ActivityThread</span><br><span class="line">        // &#x4E3B;&#x7EBF;&#x7A0B;Looper</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        ......</span><br><span class="line">        ActivityThread thread = new ActivityThread();</span><br><span class="line">        thread.attach(false, startSeq);</span><br><span class="line">        // &#x4E3B;&#x7EBF;&#x7A0B;Looper</span><br><span class="line">         Looper.loop();</span><br><span class="line">    }</span><br><span class="line">    private void attach(boolean system, long startSeq) {</span><br><span class="line">        ......</span><br><span class="line">            final IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            try {</span><br><span class="line">                //&#x91CD;&#x70B9; *2.  &#x5C06;mAppThread&#x544A;&#x77E5;AMS&#xFF0C;&#x7528;&#x4E8E;AMS&#x4E0E;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;</span><br><span class="line">                mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">            } catch (RemoteException ex) {</span><br><span class="line">                throw ex.rethrowFromSystemServer();</span><br><span class="line">            }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#xFF08;&#x7535;&#x8BDD;&#xFF09;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x5728;main&#x65B9;&#x6CD5;&#x91CC;&#x4F1A;&#x6267;&#x884C;attach&#xFF0C;&#x5C31;&#x662F;&#x8981;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x4FE1;&#x606F;&#x544A;&#x77E5;AMS&#xFF0C;&#x6BD5;&#x7ADF;AMS &#x662F;&#x7BA1;&#x7406;&#x6A21;&#x5757;&#x3002;</p>
<ol start="2">
<li><h1 id="AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C;-realStartActivityLocked"><a href="#AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C;-realStartActivityLocked" class="headerlink" title="AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C; realStartActivityLocked"></a>AMS&#x6536;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x7684;&#x6267;&#x884C; realStartActivityLocked</h1></li>
</ol>
<p>&#x56E0;&#x4E3A;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4E5F;&#x4E0D;&#x662F;&#x7531;AMS&#x6267;&#x884C;&#xFF0C;AMS&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x5177;&#x4F53;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x597D;&#x540E;&#xFF0C;&#x4F1A;&#x6267;&#x884C; AMS::attachApplication&#x6765;&#x544A;&#x77E5;&#x3002; &#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;AMS&#x5C31;&#x77E5;&#x9053;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x5904;&#x7406;&#x540E;&#x7EED;&#x903B;&#x8F91;&#x4E86;</p>
<h2 id="2-1-&#x8C03;&#x7528;&#x94FE;"><a href="#2-1-&#x8C03;&#x7528;&#x94FE;" class="headerlink" title="2.1 &#x8C03;&#x7528;&#x94FE;"></a>2.1 &#x8C03;&#x7528;&#x94FE;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;AMS::attachApplication</span><br><span class="line">    AMS::attachApplicationLocked</span><br><span class="line">        ActivityThread::bindApplication</span><br><span class="line">            ActivityTaskManagerService.LocalService::attachApplication</span><br><span class="line">                WindowContainer::forAllRootTasks  --- &#x7701;&#x7565;forAllRootTasks&#x7B49;&#x56FA;&#x5B9A;&#x5806;&#x6808;</span><br><span class="line">                    Task::forAllRootTasks</span><br><span class="line">                        WindowContainer::forAllActivities</span><br><span class="line">                            ActivityRecord::forAllActivities</span><br><span class="line">                                RootWindowContainer.AttachApplicationHelper::test</span><br><span class="line">                                    RootWindowContainer.AttachApplicationHelper::test</span><br><span class="line">                                        ActivityTaskSupervisor::realStartActivityLocked  -- &#x6784;&#x5EFA;LaunchActivityItem</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/df061568cceb4ea83c4b9f9d7e4a8b9a79927e83e4b4e52d4817dbf6ab158b0f" alt="&#x8C03;&#x7528;&#x94FE;realStartActivityLocked.png"></p>
<p>&#x63A5;&#x4E0A;&#x4E00;&#x7BC7;&#x77E5;&#x9053;&#x5982;&#x679C;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x4E86;ActivityTaskSupervisor::startSpecificActivity&#x5C31;&#x4F1A;&#x8D70;&#x8FDB;&#x53BB;ActivityTaskSupervisor::realStartActivityLocked&#x3002;<br>&#x4F46;&#x662F;&#x53EF;&#x80FD;&#x4F1A;&#x597D;&#x5947;&#x600E;&#x4E48;&#x5C31;&#x77E5;&#x9053;&#x8981;&#x6267;&#x884C;&#x5E94;&#x7528;MainActivity&#x5230;onCreate&#x5C31;&#x4E00;&#x5B9A;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x5462;&#xFF1F; &#x8C03;&#x8BD5;&#x65B9;&#x6CD5;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#x52A0;log&#xFF0C;&#x6253;&#x5806;&#x6808;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x5E94;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x7684;&#x662F;&#xFF0C;&#x9700;&#x8981;&#x6267;&#x884C;Activity&#x542F;&#x52A8;&#x5230;onCreate&#x7684;&#x63A7;&#x5236;&#x5728;LaunchActivityItem&#x4E2D;&#xFF0C;&#x800C;LaunchActivityItem&#x5728;framework&#x7684;&#x5F15;&#x7528;&#x51FA;&#x4E86;&#x672C;&#x8EAB;&#xFF0C;&#x5C31;&#x53EA;&#x6709;&#x5728;ActivityTaskSupervisor&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/abe6ed303476e2d45795fa992fa4762eced986d1a27197730417592798b843cd" alt="&#x4E3A;&#x4EC0;&#x4E48;&#x770B;ActivityTaskSupervisor.png"></p>
<h2 id="2-2-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-2-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.2 &#x4E3B;&#x6D41;&#x7A0B;"></a>2.2 &#x4E3B;&#x6D41;&#x7A0B;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# AMS </span><br><span class="line">    // &#x5F53;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x8C03;&#x7528;attachApplication &#x6267;&#x884C;</span><br><span class="line">    public final void attachApplication(IApplicationThread thread, long startSeq) {</span><br><span class="line">        if (thread == null) {</span><br><span class="line">            throw new SecurityException(&quot;Invalid application interface&quot;);</span><br><span class="line">        }</span><br><span class="line">        synchronized (this) {</span><br><span class="line">            // &#x83B7;&#x53D6; &#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7684;&#x4FE1;&#x606F;&#x540E;&#x6267;&#x884C;attachApplicationLocked</span><br><span class="line">            int callingPid = Binder.getCallingPid();</span><br><span class="line">            final int callingUid = Binder.getCallingUid();</span><br><span class="line">            final long origId = Binder.clearCallingIdentity();</span><br><span class="line">            attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    private boolean attachApplicationLocked(@NonNull IApplicationThread thread,</span><br><span class="line">            int pid, int callingUid, long startSeq) {</span><br><span class="line">            // &#x9700;&#x8981;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x7684;&#x8FDB;&#x7A0B;&#x6570;&#x636E;</span><br><span class="line">            ProcessRecord app;</span><br><span class="line">            ......</span><br><span class="line">            if (pid != MY_PID &amp;&amp; pid &gt;= 0) {</span><br><span class="line">                synchronized (mPidsSelfLocked) {</span><br><span class="line">                    // &#x901A;&#x8FC7;mPidsSelfLocked&#x83B7;&#x53D6;</span><br><span class="line">                    app = mPidsSelfLocked.get(pid);</span><br><span class="line">                }</span><br><span class="line">                ......</span><br><span class="line">            } </span><br><span class="line">            ...... </span><br><span class="line">            // &#x89E6;&#x53D1;ActivityThread::bindApplication &#x903B;&#x8F91;</span><br><span class="line">            if (app.getIsolatedEntryPoint() != null) {</span><br><span class="line"></span><br><span class="line">            } else if (instr2 != null) {</span><br><span class="line">                // bindApplication</span><br><span class="line">                thread.bindApplication(processName, appInfo,</span><br><span class="line">                        app.sdkSandboxClientAppVolumeUuid, app.sdkSandboxClientAppPackage,</span><br><span class="line">                        providerList,</span><br><span class="line">                        instr2.mClass,</span><br><span class="line">                        profilerInfo, instr2.mArguments,</span><br><span class="line">                        instr2.mWatcher,</span><br><span class="line">                        instr2.mUiAutomationConnection, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        new Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.getCompat(), getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                        app.getDisabledCompatChanges(), serializedSystemFontMap,</span><br><span class="line">                        app.getStartElapsedTime(), app.getStartUptime());      </span><br><span class="line">            } else {</span><br><span class="line">                // bindApplication</span><br><span class="line">                thread.bindApplication(processName, appInfo,</span><br><span class="line">                        app.sdkSandboxClientAppVolumeUuid, app.sdkSandboxClientAppPackage,</span><br><span class="line">                        providerList, null, profilerInfo, null, null, null, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        new Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.getCompat(), getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                        app.getDisabledCompatChanges(), serializedSystemFontMap,</span><br><span class="line">                        app.getStartElapsedTime(), app.getStartUptime());</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            if (normalMode) {</span><br><span class="line">                try {</span><br><span class="line">                    // &#x91CD;&#x70B9; &#x89E6;&#x53D1;&#x6784;&#x5EFA; LaunchActivityItem &#x6D41;&#x7A0B;</span><br><span class="line">                    didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e);</span><br><span class="line">                    badApp = true;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x662F;&#x89E6;&#x53D1; LaunchActivityItem &#x7684;&#x6D41;&#x7A0B;&#x4E3B;&#x7EBF; , mAtmInternal&#x662F; ATMS &#x7684;&#x5185;&#x90E8;&#x7C7B; LocalService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskManagerService.LocalService</span><br><span class="line">        @Override</span><br><span class="line">        public boolean attachApplication(WindowProcessController wpc) throws RemoteException {</span><br><span class="line">            ......</span><br><span class="line">            return mRootWindowContainer.attachApplication(wpc);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line"># RootWindowContainer</span><br><span class="line">        boolean attachApplication(WindowProcessController app) throws RemoteException {</span><br><span class="line">            try {</span><br><span class="line">                return mAttachApplicationHelper.process(app);</span><br><span class="line">            } finally {</span><br><span class="line">                mAttachApplicationHelper.reset();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"># RootWindowContainer.AttachApplicationHelper</span><br><span class="line">        boolean process(WindowProcessController app) throws RemoteException {</span><br><span class="line">            mApp = app;</span><br><span class="line">            for (int displayNdx = getChildCount() - 1; displayNdx &gt;= 0; --displayNdx) {</span><br><span class="line">                // &#x91CD;&#x70B9;* &#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x5BB9;&#x5668;&#x7684; forAllRootTasks</span><br><span class="line">                getChildAt(displayNdx).forAllRootTasks(this);</span><br><span class="line">                if (mRemoteException != null) {</span><br><span class="line">                    throw mRemoteException;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x91CD;&#x70B9;&#x662F;&#x6267;&#x884C;&#x4E86;forAllRootTasks&#xFF0C;&#x5F53;&#x5B69;&#x5B50;&#x662F;RootTask&#x5BB9;&#x5668;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x6267;&#x884C;Lambda&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p>AttachApplicationHelper &#x5FC5;&#x7136;&#x5B9E;&#x73B0;&#x4E86; Consumer &#x63A5;&#x53E3;&#xFF0C; &#x76F4;&#x63A5;&#x770B;&#x5176; accept &#x5B9E;&#x73B0;&#x5373;&#x53EF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# RootWindowContainer.AttachApplicationHelper</span><br><span class="line">  private class AttachApplicationHelper implements Consumer&lt;Task&gt;, Predicate&lt;ActivityRecord&gt; {</span><br><span class="line">        ......</span><br><span class="line">        boolean process(WindowProcessController app) throws RemoteException {</span><br><span class="line">            mApp = app;</span><br><span class="line">            for (int displayNdx = getChildCount() - 1; displayNdx &gt;= 0; --displayNdx) {</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x5BB9;&#x5668;&#x7684; forAllRootTasks</span><br><span class="line">                getChildAt(displayNdx).forAllRootTasks(this);</span><br><span class="line">                if (mRemoteException != null) {</span><br><span class="line">                    throw mRemoteException;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        @Override</span><br><span class="line">        public void accept(Task rootTask) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x6267;&#x884C; topRunningActivity</span><br><span class="line">            mTop = rootTask.topRunningActivity();</span><br><span class="line">            // &#x91CD;&#x70B9;*2. &#x6267;&#x884C;accept &#x8BA9;&#x5BB9;&#x5668;&#x4E0B;&#x7684;&#x6BCF;&#x4E2A; ActivityRecord &#x6267;&#x884C;</span><br><span class="line">            rootTask.forAllActivities(this);</span><br><span class="line">        }</span><br><span class="line">        @Override</span><br><span class="line">        public boolean test(ActivityRecord r) {</span><br><span class="line">            ......</span><br><span class="line">            try {</span><br><span class="line">                // &#x91CD;&#x70B9;*3. &#x6267;&#x884C; realStartActivityLocked &#x89E6;&#x53D1;&#x521B;&#x5EFA;LaunchActivityItem</span><br><span class="line">                if (mTaskSupervisor.realStartActivityLocked(r, mApp,</span><br><span class="line">                        mTop == r &amp;&amp; r.getTask().canBeResumed(r) /* andResume */,</span><br><span class="line">                        true /* checkConfig */)) {</span><br><span class="line">                    mHasActivityStarted = true;</span><br><span class="line">                }</span><br><span class="line">            } catch (RemoteException e) {</span><br><span class="line">                Slog.w(TAG, &quot;Exception in new application when starting activity &quot; + mTop, e);</span><br><span class="line">                mRemoteException = e;</span><br><span class="line">                return true;</span><br><span class="line">            }</span><br><span class="line">            return false;</span><br><span class="line">        }</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x91CD;&#x70B9;&#x5206;&#x6790;&#xFF1A;<br>AttachApplicationHelper &#x5B9E;&#x73B0;&#x7C7B;Consumer&#xFF0C;Predicate&#x63A5;&#x53E3;&#x3002; &#x5BF9;&#x5E94;&#x8981;&#x5B9E;&#x73B0;&#x7684;&#x51FD;&#x6570;&#x5206;&#x522B;&#x4E3A;accept&#x548C;test</p>
<ol>
<li>RootWindowContainer &#x7684; child &#x81EA;&#x7136;&#x662F; WindowContainer</li>
</ol>
<p>&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x6709;&#x4E2A;&#x7591;&#x95EE;&#x5C31;&#x662F; forAllRootTasks &#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x65B9;&#x6CD5;&#x6709;2&#x4E2A;&#x91CD;&#x8F7D;&#xFF0C;&#x53C2;&#x6570;&#x5206;&#x522B;&#x4E3A;Consumer &#x63A5;&#x53E3;&#x548C;Predicate &#x63A5;&#x53E3;&#x3002; &#x5F53;&#x524D;&#x7684;AttachApplicationHelper&#x7C7B;&#x8FD9;&#x4E24;&#x4E2A;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;<br>&#x600E;&#x4E48;&#x5224;&#x65AD;&#x6267;&#x884C;&#x7684;&#x662F;&#x54EA;&#x4E2A;&#x5462;&#xFF1F;<br>&#x7B54;&#x6848;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C; &#x53EA;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x6CDB;&#x578B;&#x53C2;&#x6570;&#x5373;&#x53EF;&#x3002;<br>2. &#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x89E3;&#x91CA;&#xFF0C; &#x7B2C;&#x4E8C;&#x6B65;&#x6267;&#x884C; accept&#x56DE;&#x8C03;&#xFF0C; &#x5185;&#x90E8;&#x6267;&#x884C; Task::forAllActivities &#x51FD;&#x6570;&#xFF0C; &#x4F46;&#x662F;Task&#x672C;&#x8EAB;&#x6CA1;&#x6709;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C; &#x8BE5;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5728;&#x7236;&#x7C7B; WindowContainer &#x4E2D;</p>
<ol start="3">
<li>&#x90A3;&#x4E48;&#x903B;&#x8F91;&#x5C31;&#x6765;&#x5230;&#x4E86;&#x6C14;&#x5230;&#x7684;realStartActivityLocked &#xFF0C;&#x5176;&#x5185;&#x90E8;&#x4F1A;&#x6784;&#x5EFA; LaunchActivityItem&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x3010;Activity&#x751F;&#x547D;&#x5468;&#x671F;&#x4E8B;&#x52A1;&#x6267;&#x884C;&#x903B;&#x8F91;&#x3011;&#x6709;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;<br>&#x5728;&#x628A; ActivityTaskSupervisor::realStartActivityLocked&#x65B9;&#x6CD5;&#x770B;&#x4E00;&#x4E0B;&#xFF0C;&#x73B0;&#x5728;&#x5DF2;&#x77E5; setLifecycleStateRequest&#x4E3A;ResumeActivityItem</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskSupervisor </span><br><span class="line"></span><br><span class="line">    boolean realStartActivityLocked(ActivityRecord r, WindowProcessController proc,</span><br><span class="line">            boolean andResume, boolean checkConfig) throws RemoteException {</span><br><span class="line">            //  &#x91CD;&#x70B9;* &#x5224;&#x65AD;&#x662F;&#x5426;&#x6267;&#x884C;&#x5B8C;&#x4E86;pause &#x3002; &#x4E5F;&#x5C31;&#x662F;2&#x4E2A;&#x6761;&#x4EF6;&#x4E4B;&#x4E00;&#xFF0C;&#x5FC5;&#x987B;&#x8981;&#x6267;&#x884C;&#x5B8C;pause&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x540E;&#x9762;</span><br><span class="line">            if (!mRootWindowContainer.allPausedActivitiesComplete()) {</span><br><span class="line">                // While there are activities pausing we skipping starting any new activities until</span><br><span class="line">                // pauses are complete. NOTE: that we also do this for activities that are starting in</span><br><span class="line">                // the paused state because they will first be resumed then paused on the client side.</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES,</span><br><span class="line">                        &quot;realStartActivityLocked: Skipping start of r=%s some activities pausing...&quot;,</span><br><span class="line">                        r);</span><br><span class="line">                return false;</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x521B;&#x5EFA;Activity&#x542F;&#x52A8;&#x4E8B;&#x52A1;.</span><br><span class="line">                final ClientTransaction clientTransaction = ClientTransaction.obtain(proc.getThread(), r.token);</span><br><span class="line">                // &#x5224;&#x65AD;Activity&#x662F;&#x5426;&#x5904;&#x4E8E;&#x5411;&#x524D;&#x8F6C;&#x573A;&#x72B6;&#x6001;</span><br><span class="line">                final boolean isTransitionForward = r.isTransitionForward();</span><br><span class="line">                // &#x83B7;&#x53D6;Activity&#x6240;&#x5728; TaskFragment Token</span><br><span class="line">                final IBinder fragmentToken = r.getTaskFragment().getFragmentToken();</span><br><span class="line">                // &#x91CD;&#x70B9;*2. &#x5C06;&#x6784;&#x5EFA;&#x7684; LaunchActivityItem &#x6DFB;&#x52A0;&#x5230; clientTransaction &#x4E2D;</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        // TODO: Have this take the merged configuration instead of separate global</span><br><span class="line">                        // and override configs.</span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.getFilteredReferrer(r.launchedFromPackage), task.voiceInteractor,</span><br><span class="line">                        proc.getReportedProcState(), r.getSavedState(), r.getPersistentSavedState(),</span><br><span class="line">                        results, newIntents, r.takeOptions(), isTransitionForward,</span><br><span class="line">                        proc.createProfilerInfoIfNeeded(), r.assistToken, activityClientController,</span><br><span class="line">                        r.shareableActivityToken, r.getLaunchedFromBubble(), fragmentToken));</span><br><span class="line">                // &#x91CD;&#x70B9;*3. &#x8BBE;&#x7F6E;&#x9884;&#x671F;&#x7684;&#x6700;&#x7EC8;&#x72B6;&#x6001;</span><br><span class="line">                final ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                if (andResume) {</span><br><span class="line">                    // Resume&#x903B;&#x8F91;,&#x542F;&#x52A8;&#x8D70;&#x7684;&#x8FD9;&#x3002; &#x8868;&#x793A;&#x9700;&#x8981;&#x6267;&#x884C;&#x5230;onCreate</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(isTransitionForward);</span><br><span class="line">                } else {</span><br><span class="line">                    //  Pause &#x903B;&#x8F91;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                }</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line">                // &#x91CD;&#x70B9;*4. &#x8C03;&#x5EA6;&#x4E8B;&#x52A1;&#xFF0C;&#x5C06;clientTransaction&#x6DFB;&#x52A0;&#x5230;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x5668;&#x4E2D;</span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h2 id="2-2-1-LaunchActivityItem-handleLaunchActivity-&#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;"><a href="#2-2-1-LaunchActivityItem-handleLaunchActivity-&#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;" class="headerlink" title="2.2.1 LaunchActivityItem handleLaunchActivity &#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;"></a>2.2.1 LaunchActivityItem handleLaunchActivity &#xFF08;&#x542F;&#x52A8;ActivityonCreate&#xFF09;</h2><h3 id="2-2-1-1-&#x8C03;&#x7528;&#x94FE;"><a href="#2-2-1-1-&#x8C03;&#x7528;&#x94FE;" class="headerlink" title="2.2.1.1 &#x8C03;&#x7528;&#x94FE;"></a>2.2.1.1 &#x8C03;&#x7528;&#x94FE;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;LaunchActivityItem::execute</span><br><span class="line">    ActivityThread::handleLaunchActivity</span><br><span class="line">        ActivityThread::performLaunchActivity</span><br><span class="line">            Instrumentation::newActivity --- &#x521B;&#x5EFA;Activity</span><br><span class="line">            Activity::attach  ---&#x5904;&#x7406;Window&#x76F8;&#x5173;</span><br><span class="line">                Window::init</span><br><span class="line">                Window::setWindowManager</span><br><span class="line">            Instrumentation::callActivityOnCreate ---onCreate&#x6D41;&#x7A0B;</span><br><span class="line">                Activity::performCreate</span><br><span class="line">                    Activity::onCreate  --over</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-2-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-2-1-2-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.2.1.2 &#x4E3B;&#x6D41;&#x7A0B;"></a>2.2.1.2 &#x4E3B;&#x6D41;&#x7A0B;</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x770B; LaunchActivityItem::execute</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;# LaunchActivityItem </span><br><span class="line">    public void execute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</span><br><span class="line">        ActivityClientRecord r = new ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">                mPendingResults, mPendingNewIntents, mActivityOptions, mIsForward, mProfilerInfo,</span><br><span class="line">                client, mAssistToken, mShareableActivityToken, mLaunchedFromBubble,</span><br><span class="line">                mTaskFragmentToken);</span><br><span class="line">        client.handleLaunchActivity(r, pendingActions, null /* customIntent */);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684; client &#x662F; ClientTransactionHandler &#x7C7B;&#x578B;&#xFF0C; &#x800C; ActivityThread &#x662F; ClientTransactionHandler&#x5B50;&#x7C7B;</p>
<p><strong>&#x91CD;&#x70B9;&#x662F;&#x8FD9;&#x8FB9;&#x521B;&#x5EFA;&#x4E86;ActivityClientRecord&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8981;&#x627E;&#x7684;token</strong></p>
<p>&#x903B;&#x8F91;&#x6765;&#x5230;&#x5E94;&#x7528;&#x8FDB;&#x7A0B; ActivityThread</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityThread</span><br><span class="line"></span><br><span class="line">    public Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">                PendingTransactionActions pendingActions, Intent customIntent) {</span><br><span class="line">                    ......</span><br><span class="line">                    final Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">    private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {</span><br><span class="line">        ......</span><br><span class="line">                Activity activity = null;</span><br><span class="line">                try {</span><br><span class="line">                    // &#x91CD;&#x70B9;* 1. &#x901A;&#x8FC7;Instrumentation &#x53CD;&#x5C04;&#x521B;&#x5EFA;Activity</span><br><span class="line">                    java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">                    activity = mInstrumentation.newActivity(</span><br><span class="line">                            cl, component.getClassName(), r.intent);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">                try {</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x91CD;&#x70B9;* 2. &#x6267;&#x884C; attach &#x6D41;&#x7A0B;</span><br><span class="line">                    activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">                            r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                            r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                            r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                            r.assistToken, r.shareableActivityToken);</span><br><span class="line">                    if (r.isPersistable()) {</span><br><span class="line">                        mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                    } else {</span><br><span class="line">                        &#x91CD;&#x70B9;* 3. OnCreate&#x6D41;&#x7A0B;</span><br><span class="line">                        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"># Instrumentation</span><br><span class="line">    public void callActivityOnCreate(Activity activity, Bundle icicle) {</span><br><span class="line">        prePerformCreate(activity);</span><br><span class="line">        // onCreate&#x6D41;&#x7A0B;</span><br><span class="line">        activity.performCreate(icicle);</span><br><span class="line">        postPerformCreate(activity);</span><br><span class="line">    }</span><br><span class="line"># Activity</span><br><span class="line">    final void performCreate(Bundle icicle) {</span><br><span class="line">        performCreate(icicle, null);</span><br><span class="line">    }</span><br><span class="line">    final void performCreate(Bundle icicle, PersistableBundle persistentState) {</span><br><span class="line">        ......</span><br><span class="line">        if (persistentState != null) {</span><br><span class="line">            onCreate(icicle, persistentState);</span><br><span class="line">        } else {</span><br><span class="line">            // &#x6267;&#x884C;onCreate</span><br><span class="line">            onCreate(icicle);</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x5199;&#x8FC7;&#x5E94;&#x7528;&#x7684;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x9ED8;&#x8BA4;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x7684;onCreate&#x3002;<br>&#x6D41;&#x7A0B;&#x7ED3;&#x675F;</p>
<p>tip:&#x5728;&#x6DFB;&#x52A0;&#x56DE;&#x8C03;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD8;&#x52A0;&#x4E86;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C; &#x56E0;&#x4E3A; LaunchActivityItem &#x53EA;&#x662F;&#x521B;&#x5EFA;&#xFF0C;&#x4F46;&#x662F;&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x6267;&#x884C;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;<br>&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x90FD;&#x662F;&#x5E0C;&#x671B;&#x6267;&#x884C;&#x5230;onResume&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x8BBE;&#x7F6E; ResumeActivityItem,&#x4E0D;&#x8FC7;&#x4E0D;&#x662F;&#x5206;&#x6790;&#x91CD;&#x70B9;&#xFF0C;&#x53EF;&#x81EA;&#x884C;&#x4E86;&#x89E3;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e21a714e0aa8a5b3425fc1edae62a909.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340464722279661579.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340464722279661579.html" itemprop="url">【Android 13源码分析】Activity启动流程-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T16:57:47+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#xFF0C;&#x672C;&#x7BC7;&#x4E3A;&#x7B2C;&#x4E8C;&#x7BC7;&#x3002;</p>
<p>&#x63A5;<a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a>&#x5728;ActivityStarer::startActivityInner&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;getOrCreateRootTask&#x65B9;&#x6CD5;&#x521B;&#x5EFA;Task&#xFF0C;&#x800C;&#x540E;&#x901A;&#x8FC7;setNewTask&#x65B9;&#x6CD5;&#x5C06;&#x65B0;&#x5EFA;&#x7684;ActivityRecord&#x8FDB;&#x884C;&#x6302;&#x5728;&#x5230;&#x65B0;&#x5EFA;&#x7684;Task&#x4E0A;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x9700;&#x8981;&#x5904;&#x7406;&#x65B0;&#x7684;Activity&#x542F;&#x52A8;&#x548C;&#x663E;&#x793A;&#x903B;&#x8F91;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x7684;&#x6D41;&#x7A0B;&#x7531;resumeFocusedTasksTopActivities&#x6267;&#x884C;&#x3002;</p>
<h1 id="&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities"><a href="#&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities" class="headerlink" title="&#x663E;&#x793A;Activity resumeFocusedTasksTopActivities"></a>&#x663E;&#x793A;Activity resumeFocusedTasksTopActivities</h1><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;RootWindowContainer::resumeFocusedTasksTopActivities</span><br><span class="line">    Task::resumeTopActivityUncheckedLocked</span><br><span class="line">        Task::resumeTopActivityInnerLocked</span><br><span class="line">            TaskFragment::resumeTopActivity </span><br><span class="line">                TaskDisplayArea::pauseBackTasks  --   2.2.1 pause LauncherActivity </span><br><span class="line">                    WindowContainer::forAllLeafTask</span><br><span class="line">                        TaskFragment::forAllLeafTaskFragments</span><br><span class="line">                            TaskFragment::startPausing</span><br><span class="line">                                TaskFragment::startPausing</span><br><span class="line">                                    TaskFragment::schedulePauseActivity --&#x6784;&#x5EFA; PauseActivityItem&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x89E6;&#x53D1;&#x6682;&#x505C;launch</span><br><span class="line">                ActivityTaskManagerService::startProcessAsync     -- 2.2.2&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x7ECF;&#x8FC7;&#x51E0;&#x6B21;&#x8C03;&#x7528;&#x4F1A;&#x6267;&#x884C;&#x5230;TaskFragment::resumeTopActivity&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x975E;&#x5E38;&#x590D;&#x6742;,&#x573A;&#x666F;&#x4E0D;&#x540C;&#x6267;&#x884C;&#x7684;&#x5206;&#x652F;&#x4E5F;&#x4E0D;&#x540C;,&#x503C;&#x5F97;&#x91CD;&#x70B9;&#x5206;&#x6790;&#x3002;&#x800C;&#x4E14;&#x5F88;&#x591A;&#x91CD;&#x8981;&#x7684;&#x903B;&#x8F91;&#x90FD;&#x96C6;&#x4E2D;&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x540E;&#x7EED;&#x4F1A;&#x88AB;&#x91CD;&#x6784;&#x7684;&#x3002;<br>&#x5F53;&#x524D;&#x8FD8;&#x662F;&#x53EA;&#x5206;&#x6790;launcher &#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;&#x573A;&#x666F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    final boolean resumeTopActivity(ActivityRecord prev, ActivityOptions options,</span><br><span class="line">            boolean deferPause) {</span><br><span class="line">                // &#x8FD9;&#x91CC;&#x7684;next&#x8FD4;&#x56DE;&#x7684;&#x662F; &#x7535;&#x8BDD;&#x7684;main activity&#xFF0C;&#x8868;&#x793A;&#x4E0B;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x73B0;&#x5B9E;&#x7684;</span><br><span class="line">                ActivityRecord next = topRunningActivity(true /* focusableOnly */);</span><br><span class="line">                ......</span><br><span class="line">                // &#x5982;&#x679C;&#x8DF3;&#x8FC7;&#x7684;&#x8FD9;&#x4E9B;&#x903B;&#x8F91;&#x90FD;&#x6CA1;&#x6267;&#x884C;return&#xFF0C;&#x5219;&#x6B63;&#x5728;&#x5F00;&#x59CB;&#x6267;&#x884C; resume&#x6D41;&#x7A0B;&#xFF0C;&#x6253;&#x5370;&#x5173;&#x952E;&#x65E5;&#x5FD7;&#x3002;    </span><br><span class="line">                // &#x524D;&#x9762;&#x6D41;&#x7A0B;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x4E5F;&#x6709;&#x54CD;&#x5E94;&#x65E5;&#x5FD7;&#x7684;&#x6253;&#x5370;</span><br><span class="line">                // &#x6253;&#x5370;&#x65E5;&#x5FD7;&#xFF0C;&#x9700;&#x8981;&#x663E;&#x793A;&#x54EA;&#x4E2A;Activity</span><br><span class="line">                if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, &quot;Resuming &quot; + next);</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;* 1. &#x8FD9;&#x91CC;&#x4F1A;&#x5C06; launch&#x7684;Activity pause &#x3002;&#x53C2;&#x6570;&#x662F; &#x7535;&#x8BDD;&#x7684;ActivityRecord</span><br><span class="line">                boolean pausing = !deferPause &amp;&amp; taskDisplayArea.pauseBackTasks(next);</span><br><span class="line">                ......</span><br><span class="line">                if (pausing) {</span><br><span class="line">                    ProtoLog.v(WM_DEBUG_STATES, &quot;resumeTopActivity: Skip resume: need to&quot;+ &quot; start pausing&quot;);</span><br><span class="line">                    if (next.attachedToProcess()) {</span><br><span class="line">                        ......</span><br><span class="line">                    } else if (!next.isProcessRunning()) {</span><br><span class="line">                        // &#x91CD;&#x70B9;*2. &#x8FDB;&#x7A0B;&#x6CA1;&#x6709;&#x8FD0;&#x884C;&#xFF0C;&#x5219;&#x89E6;&#x53D1;&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002; &#x5F53;&#x524D;&#x903B;&#x8F91;&#x80AF;&#x5B9A;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x4E00;&#x6761;</span><br><span class="line">                        final boolean isTop = this == taskDisplayArea.getFocusedRootTask();</span><br><span class="line">                        mAtmService.startProcessAsync(next, false /* knownToBeDead */, isTop,</span><br><span class="line">                            isTop ? HostingRecord.HOSTING_TYPE_NEXT_TOP_ACTIVITY</span><br><span class="line">                                    : HostingRecord.HOSTING_TYPE_NEXT_ACTIVITY);</span><br><span class="line">                    }</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;return&#xFF0C;</span><br><span class="line">                    return true;</span><br><span class="line">                }</span><br><span class="line">                ......</span><br><span class="line">                //&#x540E;&#x9762;&#x8FD8;&#x6709;&#x91CD;&#x8981;&#x903B;&#x8F91;&#xFF0C;&#x5F53;&#x524D;&#x53EF;&#x5FFD;&#x7565;</span><br><span class="line">            }</span><br></pre></td></tr></table></figure>

<p>&#x91CD;&#x70B9;&#x5206;&#x6790;:<br>&#x4E0A;&#x9762;&#x8BF4;&#x8FC7;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x5728;&#x5F53;&#x524D;&#x903B;&#x8F91;&#x6709;2&#x4E2A;&#x4E3B;&#x7EBF;</p>
<ol>
<li>pause&#x5F53;&#x524D;Activity&#xFF0C;&#x4E5F;&#x5C31;&#x662F;launcher</li>
<li>&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;&#x8FDB;&#x7A0B;</li>
</ol>
<p>&#x5728;&#x7B2C;&#x4E00;&#x6B65;&#x5C06;launcher&#x7684;Activity&#x6267;&#x884C;pauser&#xFF0C; &#x8FD9;&#x4E00;&#x6B65;&#x6267;&#x884C;&#x5230;&#x6700;&#x540E;&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B65;&#x521B;&#x5EFA;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#xFF0C;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x80AF;&#x5B9A;&#x4E5F;&#x4F1A;&#x6267;&#x884C;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#xFF0C;&#x8FD9;&#x4E48;&#x770B;&#x6765;&#x5C31;&#x6709;2&#x4E2A;&#x5730;&#x65B9;&#x89E6;&#x53D1;&#x4E86;&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x662F;&#x5F02;&#x6B65;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x8C01;&#x5148;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x660E;&#x786E;&#x7684;&#x662F;&#xFF0C;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x5FC5;&#x987B;&#x6709;2&#x4E2A;&#x6761;&#x4EF6;&#xFF1A;</p>
<ol>
<li>&#x524D;&#x4E00;&#x4E2A;Activity&#x6267;&#x884C;&#x5B8C;pause</li>
<li>&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6210;</li>
</ol>
<p><strong>&#x6240;&#x4EE5;&#x65E0;&#x8BBA;2&#x4E2A;&#x5206;&#x652F;&#x54EA;&#x4E00;&#x4E2A;&#x5148;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x7B49;&#x540E;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x5B8C;&#x7684;&#x6765;&#x89E6;&#x53D1;&#x540E;&#x7EED;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;MainActivity&#x7684;&#x542F;&#x52A8;&#x3002;</strong></p>
<p>&#x5148;&#x770B;launcher&#x7684;pause&#x6D41;&#x7A0B;</p>
<ol>
<li><h1 id="pause-&#x6D41;&#x7A0B;-pauseBackTasks"><a href="#pause-&#x6D41;&#x7A0B;-pauseBackTasks" class="headerlink" title="pause &#x6D41;&#x7A0B; pauseBackTasks"></a>pause &#x6D41;&#x7A0B; pauseBackTasks</h1></li>
</ol>
<p>&#x9700;&#x8981;&#x663E;&#x793A;&#x65B0;&#x7684;Activity&#xFF0C;&#x90A3;&#x4E48;&#x4E4B;&#x524D;&#x7684;&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x6267;&#x884C;pause&#x7684;&#xFF0C;&#x5C31;&#x5728;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x3002;&#x53C2;&#x6570;next&#x4E3A;&#x201C;&#x7535;&#x8BDD;&#x7684;&#x201D;ActivityRecord</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskDisplayArea</span><br><span class="line"></span><br><span class="line">    // &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x201C;&#x7535;&#x8BDD;&#x201D;ActivityRecord&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x88AB;&#x79F0;&#x4E3A;resuming</span><br><span class="line">    boolean pauseBackTasks(ActivityRecord resuming) {</span><br><span class="line">        final int[] someActivityPaused = {0};</span><br><span class="line">        forAllLeafTasks(leafTask -&gt; {</span><br><span class="line">            // Check if the direct child resumed activity in the leaf task needed to be paused if</span><br><span class="line">            // the leaf task is not a leaf task fragment.</span><br><span class="line">            if (!leafTask.isLeafTaskFragment()) {</span><br><span class="line">                // &#x5F53;&#x524D;&#x4E0D;&#x4F1A;&#x8D70;&#x8FD9;&#x91CC;</span><br><span class="line">                final ActivityRecord top = topRunningActivity();</span><br><span class="line">                final ActivityRecord resumedActivity = leafTask.getResumedActivity();</span><br><span class="line">                if (resumedActivity != null &amp;&amp; top.getTaskFragment() != leafTask) {</span><br><span class="line">                    // Pausing the resumed activity because it is occluded by other task fragment.</span><br><span class="line">                    if (leafTask.startPausing(false /* uiSleeping*/, resuming, &quot;pauseBackTasks&quot;)) {</span><br><span class="line">                        someActivityPaused[0]++;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            leafTask.forAllLeafTaskFragments((taskFrag) -&gt; {</span><br><span class="line">                final ActivityRecord resumedActivity = taskFrag.getResumedActivity();</span><br><span class="line">                if (resumedActivity != null &amp;&amp; !taskFrag.canBeResumed(resuming)) {</span><br><span class="line">                    if (taskFrag.startPausing(false /* uiSleeping*/, resuming, &quot;pauseBackTasks&quot;)) {</span><br><span class="line">                        someActivityPaused[0]++;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }, true /* traverseTopToBottom */);</span><br><span class="line">        }, true /* traverseTopToBottom */);</span><br><span class="line">        return someActivityPaused[0] &gt; 0;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>forAllLeafTasks&#x548C;forAllLeafTaskFragments&#x5728;&#x3010;<a href="https://dev.newban.cn/7342330487078699047">WMS/AMS &#x5E38;&#x89C1;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x63D0;&#x53D6;</a>&#x3011;&#x4E2D;&#x6709;&#x89E3;&#x91CA;&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x524D;&#x8FD9;&#x6BB5;&#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8BA9;DefaultTaskDisplayArea&#x4E0B;&#x7684;&#x6BCF;&#x4E2A;&#x53F6;&#x5B50;LeafTaskFragments&#x6267;&#x884C;startPausing&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    boolean startPausing(boolean userLeaving, boolean uiSleeping, ActivityRecord resuming,</span><br><span class="line">            String reason) {</span><br><span class="line">        ......</span><br><span class="line">        // &#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x5F53;&#x524D;TaskFragment&#x548C;mResumedActivity&#x7684;&#x5173;&#x7CFB;&#x3002;&#x540E;&#x9762;&#x4F1A;&#x8D34;&#x4E0A;&#x65E5;&#x5FD7;&#x8BC1;&#x660E;</span><br><span class="line">        ProtoLog.d(WM_DEBUG_STATES, &quot;startPausing: taskFrag =%s &quot; + &quot;mResumedActivity=%s&quot;, this,</span><br><span class="line">                mResumedActivity);</span><br><span class="line">        ......</span><br><span class="line">        //  &#x540E;&#x9762;&#x7684;prev&#x5C31;&#x662F;launcher&#x7684;ActivityRecord&#x4E86;</span><br><span class="line">        ActivityRecord prev = mResumedActivity;</span><br><span class="line">        ......</span><br><span class="line">        // &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Moving to PAUSING: %s&quot;, prev);</span><br><span class="line">        mPausingActivity = prev;</span><br><span class="line">        mLastPausedActivity = prev;</span><br><span class="line">        if (!prev.finishing &amp;&amp; prev.isNoHistory()</span><br><span class="line">                &amp;&amp; !mTaskSupervisor.mNoHistoryActivities.contains(prev)) {</span><br><span class="line">            mTaskSupervisor.mNoHistoryActivities.add(prev);</span><br><span class="line">        }</span><br><span class="line">        // &#x8BBE;&#x7F6E;window&#x72B6;&#x6001;&#x4E3A;PAUSING</span><br><span class="line">        prev.setState(PAUSING, &quot;startPausingLocked&quot;);</span><br><span class="line">        prev.getTask().touchActiveTime();</span><br><span class="line">        ......</span><br><span class="line">        if (prev.attachedToProcess()) {</span><br><span class="line">            // launcher&#x7684;&#x8FDB;&#x7A0B;&#x80AF;&#x5B9A;&#x662F;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;</span><br><span class="line">            if (shouldAutoPip) {</span><br><span class="line">                boolean didAutoPip = mAtmService.enterPictureInPictureMode(</span><br><span class="line">                        prev, prev.pictureInPictureArgs);</span><br><span class="line">                ProtoLog.d(WM_DEBUG_STATES, &quot;Auto-PIP allowed, entering PIP mode &quot;</span><br><span class="line">                        + &quot;directly: %s, didAutoPip: %b&quot;, prev, didAutoPip);</span><br><span class="line">            } else {</span><br><span class="line">                // &#x91CD;&#x70B9;*1. &#x6839;&#x636E;&#x5806;&#x6808;&#x662F;&#x6267;&#x884C;&#x8FD9;&#x91CC;&#x3002;&#x4E0A;&#x9762;&#x7684;PIP&#x65E5;&#x5FD7;&#x6CA1;&#x8F93;&#x51FA;&#xFF0C;&#x4E5F;&#x80FD;&#x786E;&#x5B9A;&#x662F;&#x8D70;&#x7684;&#x8FD9;&#x4E2A;</span><br><span class="line">                schedulePauseActivity(prev, userLeaving, pauseImmediately, reason);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    void schedulePauseActivity(ActivityRecord prev, boolean userLeaving,</span><br><span class="line">            boolean pauseImmediately, String reason) {</span><br><span class="line">        // &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Enqueueing pending pause: %s&quot;, prev);</span><br><span class="line">        try {</span><br><span class="line">            // &#x8F93;&#x51FA;events &#x65E5;&#x5FD7;</span><br><span class="line">            EventLogTags.writeWmPauseActivity(prev.mUserId, System.identityHashCode(prev),</span><br><span class="line">                    prev.shortComponentName, &quot;userLeaving=&quot; + userLeaving, reason);</span><br><span class="line">            // &#x91CD;&#x70B9;&#x6784;&#x5EFA;&#x5E76;&#x6267;&#x884C;PauseActivityItem</span><br><span class="line">            mAtmService.getLifecycleManager().scheduleTransaction(prev.app.getThread(),</span><br><span class="line">                    prev.token, PauseActivityItem.obtain(prev.finishing, userLeaving,</span><br><span class="line">                            prev.configChangeFlags, pauseImmediately));</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            // Ignore exception, if process died other code will cleanup.</span><br><span class="line">            Slog.w(TAG, &quot;Exception thrown during pause&quot;, e);</span><br><span class="line">            mPausingActivity = null;</span><br><span class="line">            mLastPausedActivity = null;</span><br><span class="line">            mTaskSupervisor.mNoHistoryActivities.remove(prev);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6700;&#x7EC8;&#x5728;TaskFragment::schedulePauseActivity&#x6784;&#x5EFA;&#x5E76;&#x6267;&#x884C;&#x4E86;launcher&#x7684;pause&#x4E8B;&#x4EF6;&#x3002;<br>&#x8FD9;&#x5757;&#x76F8;&#x5173;&#x7684;&#x65E5;&#x5FD7;&#x8F93;&#x5165;&#x5982;&#x56FE;:<br>&#x56E0;&#x4E3A;&#x662F;&#x540E;&#x9762;&#x8865;&#x5145;&#x7684;&#x6240;&#x4EE5;&#x5BF9;&#x8C61;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x662F;&#x80FD;&#x786E;&#x5B9A;&#x8FD9;&#x91CC;&#x5904;&#x7406;&#x7684;TaskFragment&#x548C;mResumedActivity&#x90FD;&#x662F;launcher&#x5BF9;&#x8C61;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d5842087f67b79507da27f0f9546c6f4151dd0ae62db331f6022eb0afb5042c" alt="Plotolog-startPausing.png"></p>
<p>tip:<br>State movement&#x8FD9;&#x6BB5;&#x7684;&#x8F93;&#x51FA;&#x662F;&#x5728;ActivityRecord::setState &#x53EA;&#x6709;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x90FD;&#x4F1A;&#x8F93;&#x51FA;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x91CD;&#x70B9;&#x662F;&#x770B;PauseActivityItem&#x7684;&#x6267;&#x884C;&#x903B;&#x8F91;</p>
<h2 id="1-1-PauseActivityItem"><a href="#1-1-PauseActivityItem" class="headerlink" title="1.1 PauseActivityItem"></a>1.1 PauseActivityItem</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# PauseActivityItem</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void execute(ClientTransactionHandler client, ActivityClientRecord r,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityPause&quot;);</span><br><span class="line">        // &#x91CD;&#x70B9;*1. &#x89E6;&#x53D1; handlePauseActivity &#x6D41;&#x7A0B;</span><br><span class="line">        client.handlePauseActivity(r, mFinished, mUserLeaving, mConfigChanges, pendingActions,</span><br><span class="line">                &quot;PAUSE_ACTIVITY_ITEM&quot;);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getTargetState() {</span><br><span class="line">        return ON_PAUSE;</span><br><span class="line">    }</span><br><span class="line">    //  pauser&#x6267;&#x884C;&#x540E;&#x8C03;&#x7528; postExecute</span><br><span class="line">    @Override</span><br><span class="line">    public void postExecute(ClientTransactionHandler client, IBinder token,</span><br><span class="line">            PendingTransactionActions pendingActions) {</span><br><span class="line">        if (mDontReport) {</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        //  &#x91CD;&#x70B9;*2. &#x89E6;&#x53D1;&#x542F;&#x52A8;&#x65B0;&#x7684;Activity</span><br><span class="line">        ActivityClient.getInstance().activityPaused(token);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x9ED8;&#x8BA4;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;ClientTransaction&#x8C03;&#x7528;&#x903B;&#x8F91;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x79FB;&#x6B65;&#x3010;&#x3011;<br>&#x8FD9;&#x91CC;&#x5148;&#x6267;&#x884C;execute &#x7684;&#x903B;&#x8F91;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; launcher&#x7684;pause&#x6D41;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E0D;&#x662F;&#x4E3B;&#x7EBF;&#xFF0C;&#x5355;&#x72EC;&#x89E3;&#x91CA;&#x3010;&#x3011;&#x3002;&#x7136;&#x540E;&#x6267;&#x884C;postExecute&#x3002;&#x8FD9;&#x91CC;&#x4F1A;&#x89E6;&#x53D1;&#x65B0;Activity&#x7684;&#x542F;&#x52A8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityClient</span><br><span class="line"></span><br><span class="line">    public void activityPaused(IBinder token) {</span><br><span class="line">        try {</span><br><span class="line">            getActivityClientController().activityPaused(token);</span><br><span class="line">        } catch (RemoteException e) {</span><br><span class="line">            e.rethrowFromSystemServer();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>getActivityClientController&#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityClientController&#x5BF9;&#x8C61;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityClientController::activityPaused</span><br><span class="line">    ActivityRecord::activityPaused</span><br><span class="line">        TaskFragment::completePause</span><br><span class="line">            RootWindowContainer::resumeFocusedTasksTopActivities       --&#x5206;&#x652F;1 &#xFF0C;&#x518D;&#x6B21;&#x6267;&#x884C; resumeFocusedTasksTopActivities</span><br><span class="line">                RootWindowContainer::resumeFocusedTasksTopActivities</span><br><span class="line">                    Task::resumeTopActivityUncheckedLocked</span><br><span class="line">                        Task::resumeTopActivityInnerLocked</span><br><span class="line">                            TaskFragment::resumeTopActivity</span><br><span class="line">                                ActivityTaskSupervisor::startSpecificActivity                           --&#x89E6;&#x53D1; startSpecificActivity &#x5224;&#x65AD;&#x5E94;&#x7528;&#x662F;&#x5426;&#x521B;&#x5EFA;</span><br><span class="line">            RootWindowContainer::ensureActivitiesVisible              --&#x5206;&#x652F;2</span><br><span class="line">                RootWindowContainer::ensureActivitiesVisible</span><br><span class="line">                    DisplayContent::ensureActivitiesVisible </span><br><span class="line">                        WindowContainer::forAllRootTasks  --&#x5FFD;&#x7565;&#x56FA;&#x5B9A;&#x903B;&#x8F91;</span><br><span class="line">                            Task::ensureActivitiesVisible</span><br><span class="line">                                Task::forAllLeafTasks --&#x5FFD;&#x7565;&#x56FA;&#x5B9A;&#x903B;&#x8F91;</span><br><span class="line">                                    TaskFragment::updateActivityVisibilities</span><br><span class="line">                                        EnsureActivitiesVisibleHelper::process</span><br><span class="line">                                            EnsureActivitiesVisibleHelper::setActivityVisibilityState</span><br><span class="line">                                                EnsureActivitiesVisibleHelper::makeVisibleAndRestartIfNeeded</span><br><span class="line">                                                    ActivityTaskSupervisor::startSpecificActivity       --&#x89E6;&#x53D1; startSpecificActivity &#x5224;&#x65AD;&#x5E94;&#x7528;&#x662F;&#x5426;&#x521B;&#x5EFA;</span><br></pre></td></tr></table></figure>

<p>&#x8C03;&#x7528;&#x5806;&#x6808;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ccf094c52745ad76c8907082aa2d850c58704e25d10c465115859711ef64802e" alt="pause-startProcessAsync.png"></p>
<p>&#x4E0D;&#x662F;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x90FD;&#x8981;&#x53BB;&#x8DDF;&#xFF0C;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#xFF0C;&#x8DDF;&#x8E2A;&#x91CD;&#x70B9;&#x51FD;&#x6570;&#xFF0C;&#x5173;&#x6CE8;&#x91CD;&#x70B9;&#x5904;&#x7406;&#x7684;&#x5730;&#x65B9;&#x5373;&#x53EF;&#x3002; &#x5426;&#x5219;&#x4E0B;&#x4E2A;&#x7248;&#x672C;&#x91CD;&#x6784;&#x540E;&#xFF0C;&#x5C31;&#x5B8C;&#x5168;&#x4E0D;&#x4E00;&#x6837;&#x3002; &#x6240;&#x4EE5;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x91CD;&#x70B9;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x597D;&#x3002;<br>&#x8FD9;&#x8FB9;&#x53C8;2&#x4E2A;&#x5730;&#x65B9;&#x90FD;&#x4F1A;&#x51FA;&#x53D1;ActivityTaskSupervisor::startSpecificActivity&#xFF0C;&#x800C;&#x4E14;&#x90FD;&#x662F;&#x7531;ActivityClientController::activityPaused&#x4E3A;&#x6E90;&#x5934;&#x3002;<br>&#x7531;activityPaused&#x65B9;&#x6CD5;&#x540D;&#x4E5F;&#x80FD;&#x77E5;&#x9053;&#x8FD9;&#x6BB5;&#x903B;&#x8F91;&#x662F;&#x5728;launcher &#x6267;&#x884C;&#x5B8C;pause&#x540E;&#x518D;&#x6267;&#x884C;&#x7684;</p>
<p><strong>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x5206;&#x652F; RootWindowContainer::resumeFocusedTasksTopActivities&#x5230;TaskFragment::resumeTopActivity&#x76F4;&#x63A5;&#x7684;&#x8C03;&#x7528;&#x6808;&#x548C;&#x4E0A;&#x4E00;&#x7BC7;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x6700;&#x540E;&#x6267;&#x884C;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#x800C;&#x5DF2;</strong></p>
<p><strong>pause&#x540E;&#xFF0C;&#x867D;&#x7136;&#x53C8;2&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x4F46;&#x662F;&#x6839;&#x636E;&#x51FD;&#x6570;&#x540D;&#xFF0C;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x80FD;&#x8BA9;&#x4E0B;&#x4E00;&#x4E2A;Activity&#x53EF;&#x89C1;&#x3002;&#x6BD5;&#x7ADF;&#x4E0D;&#x80FD;&#x8BA9;&#x7528;&#x6237;&#x4EC0;&#x4E48;&#x90FD;&#x770B;&#x4E0D;&#x89C1;&#xFF0C; &#x603B;&#x5F97;&#x663E;&#x793A;&#x4E00;&#x4E2A;&#x5427;</strong></p>
<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8FDB;&#x5165;&#x4EE3;&#x7801;&#x5206;&#x6790;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityRecord</span><br><span class="line">    void activityPaused(boolean timeout) {</span><br><span class="line">        ......</span><br><span class="line">            if (pausingActivity == this) {</span><br><span class="line">                // &#x6253;&#x5370;&#x65E5;&#x5FD7;</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES, &quot;Moving to PAUSED: %s %s&quot;, this,</span><br><span class="line">                        (timeout ? &quot;(due to timeout)&quot; : &quot; (pause complete)&quot;));</span><br><span class="line">                mAtmService.deferWindowLayout();</span><br><span class="line">                try {</span><br><span class="line">                    // &#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6CE8;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;null</span><br><span class="line">                    taskFragment.completePause(true /* resumeNext */, null /* resumingActivity */);</span><br><span class="line">                } finally {</span><br><span class="line">                    mAtmService.continueWindowLayout();</span><br><span class="line">                }</span><br><span class="line">                return;</span><br><span class="line">            }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">// &#x6253;&#x5370;&#x5982;&#x4E0B;</span><br><span class="line">WindowManager: Moving to PAUSED: ActivityRecord{1f58beb u0 com.android.launcher3/.uioverrides.QuickstepLauncher} t8}  (pause complete)</span><br><span class="line"></span><br><span class="line">//TaskFragment::completePause</span><br><span class="line"># TaskFragment</span><br><span class="line">    @VisibleForTesting</span><br><span class="line">    void completePause(boolean resumeNext, ActivityRecord resuming) {</span><br><span class="line">        // &#x62FF;&#x5230;&#x5148;&#x53BB;&#x7684;Activity&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x9700;&#x8981; pause&#x7684;</span><br><span class="line">        ActivityRecord prev = mPausingActivity;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_STATES, &quot;Complete pause: %s&quot;, prev);</span><br><span class="line">        if (prev != null) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x8BBE;&#x7F6E;&#x7A97;&#x53E3;&#x72B6;&#x6001;&#x4E3A;PAUSED</span><br><span class="line">            prev.setState(PAUSED, &quot;completePausedLocked&quot;);</span><br><span class="line">            if (prev.finishing) {</span><br><span class="line">                ...... &#x5982;&#x679C;&#x5DF2;&#x7ECF;finish&#xFF0C;&#x4E0A;&#x9762;&#x8FD8;&#x5728;&#x8BBE;&#x7F6E; pause&#xFF0C;&#x90A3;&#x6B63;&#x5E38;&#x5E94;&#x8BE5;&#x662F;&#x8FD8;&#x6CA1;finish</span><br><span class="line">            } else if (prev.hasProcess()) {</span><br><span class="line">                // &#x6253;&#x5370;&#x72B6;&#x6001;&#x65E5;&#x5FD7;</span><br><span class="line">                ProtoLog.v(WM_DEBUG_STATES, &quot;Enqueue pending stop if needed: %s &quot;</span><br><span class="line">                        + &quot;wasStopping=%b visibleRequested=%b&quot;,  prev,  wasStopping,prev.mVisibleRequested);</span><br><span class="line">            }else {</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            if (resumeNext) {</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;* 1. &#x7B2C;1&#x4E2A;&#x5206;&#x652F;</span><br><span class="line">                mRootWindowContainer.resumeFocusedTasksTopActivities(topRootTask, prev,null /* targetOptions */);</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            // &#x91CD;&#x70B9;* 2. </span><br><span class="line">            mRootWindowContainer.ensureActivitiesVisible(resuming, 0, !PRESERVE_WINDOWS);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x7ED3;&#x5408;&#x524D;&#x9762;TaskFragment::resumeTopActivity&#x7684;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5806;&#x6808;&#x77E5;&#x9053;&#x8FD9;2&#x4E2A;&#x5206;&#x652F;&#x4E5F;&#x4E5F;&#x521B;&#x5EFA;&#x65B0;&#x8FDB;&#x7A0B;&#xFF0C;&#x90A3;&#x5DF2;&#x77E5;3&#x5730;&#x65B9;&#x89E6;&#x53D1;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002;</p>
<p><strong>&#x8FD9;&#x91CC;&#x7684; topRootTask &#x5C31;&#x662F;SourceActivity&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;Activity,prev&#x662F;launcher&#x7684;&#xFF0C;resuming&#x4E3A;null&#x3002;</strong></p>
<h3 id="1-1-1-&#x5206;&#x652F;1-resumeFocusedTasksTopActivities"><a href="#1-1-1-&#x5206;&#x652F;1-resumeFocusedTasksTopActivities" class="headerlink" title="1.1.1 &#x5206;&#x652F;1 resumeFocusedTasksTopActivities"></a>1.1.1 &#x5206;&#x652F;1 resumeFocusedTasksTopActivities</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragment</span><br><span class="line">    final boolean resumeTopActivity(ActivityRecord prev, ActivityOptions options,</span><br><span class="line">            boolean deferPause) {</span><br><span class="line">                ......</span><br><span class="line">                // pause</span><br><span class="line">                boolean pausing = !deferPause &amp;&amp; taskDisplayArea.pauseBackTasks(next);</span><br><span class="line">                ......</span><br><span class="line">                if (pausing) {</span><br><span class="line">                        ...... </span><br><span class="line">                        // &#x542F;&#x52A8;&#x8FDB;&#x7A0B;</span><br><span class="line">                        mAtmService.startProcessAsync(next, false /* knownToBeDead */, isTop,</span><br><span class="line">                            isTop ? HostingRecord.HOSTING_TYPE_NEXT_TOP_ACTIVITY</span><br><span class="line">                                    : HostingRecord.HOSTING_TYPE_NEXT_ACTIVITY);</span><br><span class="line">                    ......</span><br><span class="line">                    //return&#xFF0C;</span><br><span class="line">                    return true;</span><br><span class="line">                }</span><br><span class="line">                // &#x672C;&#x6B21;&#x903B;&#x8F91;&#x8D70;&#x8FD9;</span><br><span class="line">                ......</span><br><span class="line">                // pause &#x903B;&#x8F91;&#x4F1A;&#x518D;&#x6B21;&#x8D70;&#x5230;&#x8FD9;&#xFF0C;&#x65B0;&#x8FDB;&#x7A0B;&#x76EE;&#x524D;&#x8FD8;&#x6CA1;&#x6709;&#x542F;&#x52A8;&#x6240;&#x4EE5;&#x8D70;else</span><br><span class="line">                if (next.attachedToProcess()) {</span><br><span class="line">                    ......</span><br><span class="line">                } else {</span><br><span class="line">                    ......</span><br><span class="line">                    // &#x6253;&#x5370;log</span><br><span class="line">                    ProtoLog.d(WM_DEBUG_STATES, &quot;resumeTopActivity: Restarting %s&quot;, next);</span><br><span class="line">                    // &#x91CD;&#x70B9;* &#x6267;&#x884C;startSpecificActivity</span><br><span class="line">                    mTaskSupervisor.startSpecificActivity(next, true, true);</span><br><span class="line">                }</span><br><span class="line">            }</span><br></pre></td></tr></table></figure>

<p>&#x53C8;&#x662F;TaskFragment::resumeTopActivity&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6B21;&#x662F;&#x76F4;&#x63A5;&#x8D70;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6700;&#x4E0B;&#x9762;&#xFF0C;&#x542F;&#x52A8;Activity&#x3002;</p>
<h3 id="1-1-2-ensureActivitiesVisible&#x5206;&#x652F;"><a href="#1-1-2-ensureActivitiesVisible&#x5206;&#x652F;" class="headerlink" title="1.1.2 ensureActivitiesVisible&#x5206;&#x652F;"></a>1.1.2 ensureActivitiesVisible&#x5206;&#x652F;</h3><p>&#x770B;&#x65B9;&#x6CD5;&#x540D;&#x662F;&#x4E3A;&#x4E86; Activity&#x7684;&#x53EF;&#x89C1;<br>&#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x8C03;&#x7528;&#x94FE;&#xFF0C;&#x4F1A;&#x6267;&#x884C;&#x5230; DisplayContent::ensureActivitiesVisible</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# DisplayContent</span><br><span class="line">    void ensureActivitiesVisible(ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        if (mInEnsureActivitiesVisible) {</span><br><span class="line">            // Don&apos;t do recursive work.</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        mInEnsureActivitiesVisible = true;</span><br><span class="line">        mAtmService.mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            forAllRootTasks(rootTask -&gt; {</span><br><span class="line">                rootTask.ensureActivitiesVisible(starting, configChanges, preserveWindows,</span><br><span class="line">                        notifyClients);</span><br><span class="line">            });</span><br><span class="line">            if (mTransitionController.isCollecting()</span><br><span class="line">                    &amp;&amp; mWallpaperController.getWallpaperTarget() != null) {</span><br><span class="line">                // Also update wallpapers so that their requestedVisibility immediately reflects</span><br><span class="line">                // the changes to activity visibility.</span><br><span class="line">                // TODO(b/206005136): Move visibleRequested logic up to WindowToken.</span><br><span class="line">                mWallpaperController.adjustWallpaperWindows();</span><br><span class="line">            }</span><br><span class="line">        } finally {</span><br><span class="line">            mAtmService.mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">            mInEnsureActivitiesVisible = false;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x62FF;&#x51FA;&#x6765;&#x4E3B;&#x8981;&#x662F;&#x9047;&#x5230;&#x4E86;forAllRootTasks&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x548C;&#x4E4B;&#x524D;&#x7684;forAllLeafTasks&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;&#x5BF9;&#x6BCF;&#x4E2A;rootTask&#x6267;&#x884C;Lambda&#x800C;&#x5DF2;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# Task</span><br><span class="line">    void ensureActivitiesVisible(@Nullable ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            forAllLeafTasks(task -&gt; {</span><br><span class="line">                task.updateActivityVisibilities(starting, configChanges, preserveWindows,</span><br><span class="line">                        notifyClients);</span><br><span class="line">            }, true /* traverseTopToBottom */);</span><br><span class="line"></span><br><span class="line">            if (mTranslucentActivityWaiting != null &amp;&amp;</span><br><span class="line">                    mUndrawnActivitiesBelowTopTranslucent.isEmpty()) {</span><br><span class="line">                // Nothing is getting drawn or everything was already visible, don&apos;t wait for</span><br><span class="line">                // timeout.</span><br><span class="line">                notifyActivityDrawnLocked(null);</span><br><span class="line">            }</span><br><span class="line">        } finally {</span><br><span class="line">            mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x53C8;&#x6709;&#x4E2A;forAllLeafTasks&#xFF0C;&#x8C03;&#x7528;&#x6BCF;&#x4E2A;&#x53F6;&#x5B50;Task&#x7684;updateActivityVisibilities&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;Task&#x7684;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x6C14;&#x7236;&#x7C7B;TaskFragmet&#x91CC;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x770B;TaskFragmet&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# TaskFragmet</span><br><span class="line">    private final EnsureActivitiesVisibleHelper mEnsureActivitiesVisibleHelper =</span><br><span class="line">            new EnsureActivitiesVisibleHelper(this);</span><br><span class="line">    final void updateActivityVisibilities(@Nullable ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        mTaskSupervisor.beginActivityVisibilityUpdate();</span><br><span class="line">        try {</span><br><span class="line">            // &#x91CD;&#x70B9;</span><br><span class="line">            mEnsureActivitiesVisibleHelper.process(</span><br><span class="line">                    starting, configChanges, preserveWindows, notifyClients);</span><br><span class="line">        } finally {</span><br><span class="line">            mTaskSupervisor.endActivityVisibilityUpdate();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x8FD9;&#x4E00;&#x6761;&#x7EBF;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x5904;&#x7406;Activity&#x53EF;&#x89C1;&#x7684;&#x3002; &#x5728;&#x8FD9;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4E13;&#x95E8;&#x7684;&#x7C7B;&#x6765;&#x5904;&#x7406;&#x3002;<br>&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x6267;&#x884C;&#x591A;&#x6B21;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x662F;&#x904D;&#x5386;&#x6BCF;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x5B50;&#x5BB9;&#x5668;&#xFF0C;&#x4ECE;&#x4E0A;&#x5230;&#x4E0B;&#x904D;&#x5386;&#x3002;</p>
<h3 id="1-1-3-EnsureActivitiesVisibleHelper-process"><a href="#1-1-3-EnsureActivitiesVisibleHelper-process" class="headerlink" title="1.1.3 EnsureActivitiesVisibleHelper::process"></a>1.1.3 EnsureActivitiesVisibleHelper::process</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# EnsureActivitiesVisibleHelper</span><br><span class="line">    void process(@Nullable ActivityRecord starting, int configChanges, boolean preserveWindows, boolean notifyClients) {</span><br><span class="line">        // &#x8C03;&#x7528; reset &#x65B9;&#x6CD5;&#xFF0C;&#x5BF9;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x91CD;&#x7F6E;&#x5904;&#x7406;</span><br><span class="line">        reset(starting, configChanges, preserveWindows, notifyClients);</span><br><span class="line">        ......</span><br><span class="line">        for (int i = mTaskFragment.mChildren.size() - 1; i &gt;= 0; --i) {</span><br><span class="line">            // &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5B50;&#x5143;&#x7D20;</span><br><span class="line">            final WindowContainer child = mTaskFragment.mChildren.get(i);</span><br><span class="line">            // &#x5C06;&#x5F53;&#x524D;&#x5B50;&#x5143;&#x7D20;&#x8F6C;&#x6362;&#x4E3A;TaskFragment,&#x53EA;&#x6709;TaskFragment&#x91CD;&#x5199;&#x4E86;&#xFF0C;Task&#x6216;ActivityRecord&#x4E3A;null</span><br><span class="line">            // Task&#x7684;&#x5B69;&#x5B50;&#x4E00;&#x822C;&#x5C31;&#x662F;ActivityRecord&#x6216;&#x8005;Task</span><br><span class="line">            final TaskFragment childTaskFragment = child.asTaskFragment();</span><br><span class="line">            if (childTaskFragment != null</span><br><span class="line">                    &amp;&amp; childTaskFragment.getTopNonFinishingActivity() != null) {</span><br><span class="line">                ......</span><br><span class="line">            } else {</span><br><span class="line">                // &#x53EA;&#x6709;ActivityRecord&#x91CD;&#x5199;&#x4E86;</span><br><span class="line">                setActivityVisibilityState(child.asActivityRecord(), starting, resumeTopActivity);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void setActivityVisibilityState(ActivityRecord r, ActivityRecord starting,</span><br><span class="line">        final boolean resumeTopActivity) {</span><br><span class="line">        ......</span><br><span class="line">        if (reallyVisible) {</span><br><span class="line">            .......</span><br><span class="line">            if (!r.attachedToProcess()) {</span><br><span class="line">                // &#x4E3B;&#x6D41;&#x7A0B;</span><br><span class="line">                makeVisibleAndRestartIfNeeded(mStarting, mConfigChanges, isTop,</span><br><span class="line">                        resumeTopActivity &amp;&amp; isTop, r);</span><br><span class="line">            } else {</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">        } else {</span><br><span class="line">            if (DEBUG_VISIBILITY) {</span><br><span class="line">                Slog.v(TAG_VISIBILITY, &quot;Make invisible? &quot; + r</span><br><span class="line">                        + &quot; finishing=&quot; + r.finishing + &quot; state=&quot; + r.getState()</span><br><span class="line">                        + &quot; containerShouldBeVisible=&quot; + mContainerShouldBeVisible</span><br><span class="line">                        + &quot; behindFullyOccludedContainer=&quot; + mBehindFullyOccludedContainer</span><br><span class="line">                        + &quot; mLaunchTaskBehind=&quot; + r.mLaunchTaskBehind);</span><br><span class="line">            }</span><br><span class="line">            // &#x4E0D;&#x53EF;&#x89C1;&#x8C03;&#x7528;makeInvisible</span><br><span class="line">            r.makeInvisible();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;r &#x8868;&#x793A;&#x9700;&#x8981;&#x542F;&#x52A8;&#x7684;ActivityRecord&#xFF0C;&#x5F53;&#x524D;&#x6D41;&#x7A0B;&#x8FD8;&#x662F;onPause&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5E76;&#x6CA1;&#x6709;&#x77E5;&#x9053;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x90A3;&#x4E00;&#x6B65;&#xFF0C;&#x6240;&#x4EE5;&#x8FDB;&#x7A0B;&#x662F;&#x6CA1;&#x6709;attached&#x7684;&#x3002;&#x90A3;&#x5C31;&#x4F1A;&#x6267;&#x884C;makeVisibleAndRestartIfNeeded</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;# EnsureActivitiesVisibleHelper</span><br><span class="line">    private void makeVisibleAndRestartIfNeeded(ActivityRecord starting, int configChanges,</span><br><span class="line">            boolean isTop, boolean andResume, ActivityRecord r) {</span><br><span class="line">        ......</span><br><span class="line">        if (!r.mVisibleRequested || r.mLaunchTaskBehind) {</span><br><span class="line">            if (DEBUG_VISIBILITY) {</span><br><span class="line">                Slog.v(TAG_VISIBILITY, &quot;Starting and making visible: &quot; + r);</span><br><span class="line">            }</span><br><span class="line">            // &#x8BBE;&#x7F6E;Visibility</span><br><span class="line">            r.setVisibility(true);</span><br><span class="line">        }</span><br><span class="line">        if (r != starting) {</span><br><span class="line">            mTaskFragment.mTaskSupervisor.startSpecificActivity(r, andResume,</span><br><span class="line">                    true /* checkConfig */);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-ActivityTaskSupervisor-startSpecificActivity"><a href="#1-1-4-ActivityTaskSupervisor-startSpecificActivity" class="headerlink" title="1.1.4 ActivityTaskSupervisor::startSpecificActivity"></a>1.1.4 ActivityTaskSupervisor::startSpecificActivity</h3><p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E5F;&#x88AB;&#x8C03;&#x7528;&#x4E86;2&#x6B21;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityTaskSupervisor</span><br><span class="line"></span><br><span class="line">    void startSpecificActivity(ActivityRecord r, boolean andResume, boolean checkConfig) {</span><br><span class="line">        // Is this activity&apos;s application already running?</span><br><span class="line">        // &#x62FF;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;</span><br><span class="line">        final WindowProcessController wpc =</span><br><span class="line">                mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        boolean knownToBeDead = false;</span><br><span class="line">        //  &#x8FDB;&#x7A0B;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x4E14;&#x4E3B;&#x7EBF;&#x7A0B;&#x5DF2;&#x6267;&#x884C;</span><br><span class="line">        if (wpc != null &amp;&amp; wpc.hasThread()) {</span><br><span class="line">            try {</span><br><span class="line">                // &#x8FDB;&#x7A0B;&#x8FDB;&#x7A0B; &#x5219;&#x6267;&#x884C; realStartActivityLocked &#x6D41;&#x7A0B;</span><br><span class="line">                realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">                return;</span><br><span class="line">            } catch (RemoteException e) {</span><br><span class="line">                Slog.w(TAG, &quot;Exception when starting activity &quot;</span><br><span class="line">                        + r.intent.getComponent().flattenToShortString(), e);1111111111</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">        // &#x5F02;&#x6B65;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;</span><br><span class="line">        mService.startProcessAsync(r, knownToBeDead, isTop,</span><br><span class="line">                isTop ? HostingRecord.HOSTING_TYPE_TOP_ACTIVITY</span><br><span class="line">                        : HostingRecord.HOSTING_TYPE_ACTIVITY);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x6709;2&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x5982;&#x679C;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x4E86;&#xFF0C;&#x5219;&#x8D70;realStartActivityLocked&#xFF0C;&#x5426;&#x5219;&#x6267;&#x884C;&#x521B;&#x5EFA;&#x7684;&#x903B;&#x8F91;&#x3002;&#x4E0D;&#x8FC7;&#x5C31;&#x76EE;&#x524D;2&#x4E2A;&#x8C03;&#x7528;&#x7684;&#x5730;&#x65B9;&#x90FD;&#x662F;&#x6267;&#x884C;onPause&#x7684;&#x903B;&#x8F91;&#x6027;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x5176;&#x5B9E;&#x90FD;&#x662F;&#x5236;&#x4F5C;&#x5230;startProcessAsync&#x3002; &#x800C;&#x4E0D;&#x4F1A;&#x8D70;&#x8FDB;realStartActivityLocked</p>
<h1 id="2-&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;"><a href="#2-&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;" class="headerlink" title="2 &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;"></a>2 &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x903B;&#x8F91;</h1><p>&#x8FD9;&#x91CC;&#x662F;&#x56DE;&#x5230;&#x6267;&#x884C;pause&#x7684;&#x540C;&#x7EA7;&#x6D41;&#x7A0B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6700;&#x524D;&#x9762;&#x7684;TaskFragment::resumeTopActivity<br>&#x6267;&#x884C;pause&#x540E;&#x4F1A;&#x6267;&#x884C; ActivityTaskManagerService::startProcessAsync,&#x6700;&#x540E;&#x4E5F;&#x662F;&#x901A;&#x8FC7; ActivityManagerService&#x6765;&#x89E6;&#x53D1;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684;&#x3002;<br>&#x770B;&#x770B;AMS&#x8FD9;&#x5757;&#x6267;&#x884C;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x7684;&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ATMS  </span><br><span class="line">    void startProcessAsync(ActivityRecord activity, boolean knownToBeDead, boolean isTop,</span><br><span class="line">            String hostingType) {</span><br><span class="line">        try {</span><br><span class="line">            if (Trace.isTagEnabled(TRACE_TAG_WINDOW_MANAGER)) {</span><br><span class="line">                Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, &quot;dispatchingStartProcess:&quot;</span><br><span class="line">                        + activity.processName);</span><br><span class="line">            }</span><br><span class="line">            // &#x53D1;&#x751F;&#x6D88;&#x606F;&#xFF0C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#xFF0C;&#x8C03;&#x7528;ActivityManagerInternal::startProcess</span><br><span class="line">            final Message m = PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,</span><br><span class="line">                    mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,</span><br><span class="line">                    isTop, hostingType, activity.intent.getComponent());</span><br><span class="line">            mH.sendMessage(m);</span><br><span class="line">        } finally {</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">// ActivityManagerInternal::startProcess &#x7684;&#x5B9E;&#x73B0;&#x5728;AMS&#x7684;&#x5185;&#x90E8;&#x7C7B; LocalService &#x4E2D;</span><br><span class="line"># AMS.LocalService </span><br><span class="line">        public void startProcess(String processName, ApplicationInfo info, boolean knownToBeDead,</span><br><span class="line">                boolean isTop, String hostingType, ComponentName hostingName) {</span><br><span class="line">            try {</span><br><span class="line">                if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) {</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;startProcess:&quot;</span><br><span class="line">                            + processName);</span><br><span class="line">                }</span><br><span class="line">                synchronized (ActivityManagerService.this) {</span><br><span class="line">                    // &#x91CD;&#x70B9;&#x8C03;&#x7528;</span><br><span class="line">                    startProcessLocked(processName, info, knownToBeDead, 0 /* intentFlags */,</span><br><span class="line">                            new HostingRecord(hostingType, hostingName, isTop),</span><br><span class="line">                            ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, false /* allowWhileBooting */,</span><br><span class="line">                            false /* isolated */);</span><br><span class="line">                }</span><br><span class="line">            } finally {</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        @GuardedBy(&quot;this&quot;)</span><br><span class="line">        final ProcessRecord startProcessLocked(String processName,</span><br><span class="line">                ApplicationInfo info, boolean knownToBeDead, int intentFlags,</span><br><span class="line">                HostingRecord hostingRecord, int zygotePolicyFlags, boolean allowWhileBooting,</span><br><span class="line">                boolean isolated) {</span><br><span class="line">            return mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,</span><br><span class="line">                    hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, 0 /* isolatedUid */,</span><br><span class="line">                    false /* isSdkSandbox */, 0 /* sdkSandboxClientAppUid */,</span><br><span class="line">                    null /* sdkSandboxClientAppPackage */,</span><br><span class="line">                    null /* ABI override */, null /* entryPoint */,</span><br><span class="line">                    null /* entryPointArgs */, null /* crashHandler */);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"># ProcessList</span><br><span class="line">    boolean startProcessLocked(......) {</span><br><span class="line">                ......</span><br><span class="line">                mService.mProcStartHandler.post(() -&gt; handleProcessStart(</span><br><span class="line">                    app, entryPoint, gids, runtimeFlags, zygotePolicyFlags, mountExternal,</span><br><span class="line">                    requiredAbi, instructionSet, invokeWith, startSeq));     </span><br><span class="line">                ......   </span><br><span class="line">        }</span><br><span class="line">        private void handleProcessStart(......) {</span><br><span class="line">            &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">            final Runnable startRunnable = () -&gt; {</span><br><span class="line">                try {    // &#x8C03;&#x7528; startProcess &#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x83B7;&#x53D6;&#x542F;&#x52A8;&#x7ED3;&#x679C; ProcessStartResult</span><br><span class="line">                        final Process.ProcessStartResult startResult = startProcess(app.getHostingRecord(),</span><br><span class="line">                            entryPoint, app, app.getStartUid(), gids, runtimeFlags, zygotePolicyFlags,</span><br><span class="line">                            mountExternal, app.getSeInfo(), requiredAbi, instructionSet, invokeWith,</span><br><span class="line">                            app.getStartTime());</span><br><span class="line">                         // &#x5728;&#x9501;&#x5B9A; ActivityManagerService &#x540E;&#xFF0C;&#x5904;&#x7406;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x7ED3;&#x679C;</span><br><span class="line">                        synchronized (mService) {</span><br><span class="line">                            handleProcessStartedLocked(app, startResult, startSeq);</span><br><span class="line">                        }</span><br><span class="line">                } catch (RuntimeException e) {</span><br><span class="line">                    ......&#x5F02;&#x5E38;&#x5904;&#x7406;</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            // // &#x5982;&#x679C;&#x6709;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x5E76;&#x4E14;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6B63;&#x5728;&#x6B7B;&#x4EA1;&#x4E2D;</span><br><span class="line">            final ProcessRecord predecessor = app.mPredecessor;</span><br><span class="line">            if (predecessor != null &amp;&amp; predecessor.getDyingPid() &gt; 0) {</span><br><span class="line">                 // &#x901A;&#x8FC7;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">                handleProcessStartWithPredecessor(predecessor, startRunnable);</span><br><span class="line">            } else {</span><br><span class="line">                // &#x5982;&#x679C;&#x6CA1;&#x6709;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x6216;&#x524D;&#x4EFB;&#x8FDB;&#x7A0B;&#x672A;&#x6B7B;&#x4EA1;&#xFF0C;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#x542F;&#x52A8;&#x8FDB;&#x7A0B;&#x7684; Runnable &#x5BF9;&#x8C61;</span><br><span class="line">                // &#x8D70;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x903B;&#x8F91;</span><br><span class="line">                startRunnable.run();</span><br><span class="line">            }</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p><strong>&#x901A;&#x8FC7; startProcess &#x6765;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;</strong></p>
<p>&#x6267;&#x884C;&#x5B8C;&#x540E;&#x8F93;&#x51FA;&#x65E5;&#x5FD7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;07-26 19:19:05.477  8737  8782 I ActivityManager: Start proc 19643:com.example.myapplication/u0a198 for next-top-activity {com.example.myapplication/com.example.myapplication.MainActivity}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6BB5;&#x65E5;&#x5FD7;&#x662F;&#x5728; ProcessList::handleProcessStart &#x65B9;&#x6CD5;&#x91CC;&#x6784;&#x5EFA;&#x4E86;&#x4E2A;StringBuilder&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x9012;&#x7ED9;AMS::reportUidInfoMessageLocked&#x8FDB;&#x884C;&#x6253;&#x5370;&#x7684;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/015b67c90cb13536e975c4e1ea04bee9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340301649766727721.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340301649766727721.html" itemprop="url">【Android 13源码分析】Activity启动流程-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T13:43:16+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5BF9;WMS&#x5F88;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x6240;&#x4EE5;&#x51B3;&#x5B9A;&#x4EE5;&#x5728;&#x684C;&#x9762;&#x70B9;&#x51FB;&#x5E94;&#x7528;&#x56FE;&#x6807;&#xFF0C;&#x5230;&#x5E94;&#x7528;&#x7684;Activity&#x663E;&#x793A;&#x5230;&#x5C4F;&#x5E55;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E00;&#x7B80;&#x5355;&#x64CD;&#x4F5C;&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x5206;&#x6790;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x975E;&#x5E38;&#x591A;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x4F46;&#x662F;&#x9996;&#x5148;&#x9700;&#x8981;&#x5206;&#x6790;&#x7684;&#x5C31;&#x662F;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;3&#x90E8;&#x5206;&#xFF1A;</p>
<p><a href="https://dev.newban.cn/7340301649766727721">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-1</a></p>
<p><a href="https://dev.newban.cn/7340464722279661579">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-2</a></p>
<p><a href="https://dev.newban.cn/7340278606391738387">&#x3010;Android 13&#x6E90;&#x7801;&#x5206;&#x6790;&#x3011;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;-3</a></p>
<p>&#x867D;&#x7136;&#x6574;&#x4E2A;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;2S&#x65F6;&#x95F4;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x4E0B;&#x6765;&#x4E5F;&#x9700;&#x8981;&#x51E0;&#x4E2A;&#x6708;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x4EC5;&#x4EC5;&#x662F;&#x542F;&#x52A8;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;</p>
<p>&#x8FD9;&#x4E09;&#x7BC7;&#x5BF9;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EA;&#x5173;&#x5FC3;&#x4E3B;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0D;&#x770B;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x5F53;&#x7136;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#x4F1A;&#x7740;&#x91CD;&#x4ECB;&#x7ECD;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x540E;&#x5982;&#x679C;&#x6709;&#x9047;&#x5230;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x7684;&#x4FEE;&#x6539;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x7B14;&#x8BB0;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x95EE;&#x9898;&#x5206;&#x6790;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x57FA;&#x7840;&#x4E0A;&#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x7684;&#x5404;&#x4E2A;&#x5206;&#x652F;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6BD4;&#x5982;&#x7A97;&#x53E3;&#x7684;&#x521B;&#x5EFA;&#x4E0E;&#x6302;&#x8F7D;&#xFF0C;Surface&#x76F8;&#x5173;&#xFF0C;&#x7A97;&#x53E3;&#x7684;&#x52A8;&#x753B;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E9B;&#x6D41;&#x7A0B;&#x7684;&#x5206;&#x6790;&#x90FD;&#x9700;&#x8981;&#x57FA;&#x4E8E;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x542F;&#x52A8;Activity&#x7684;&#x65B9;&#x5F0F;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x5F53;&#x524D;&#x4EE5;&#x5728;Launch&#x4E2D;&#x70B9;&#x51FB;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x4E3A;&#x4F8B;&#x3002;</p>
<h1 id="&#x6A21;&#x5757;&#x6846;&#x56FE;"><a href="#&#x6A21;&#x5757;&#x6846;&#x56FE;" class="headerlink" title="&#x6A21;&#x5757;&#x6846;&#x56FE;"></a>&#x6A21;&#x5757;&#x6846;&#x56FE;</h1><h2 id="&#x4E00;&#x7EA7;&#x6846;&#x56FE;"><a href="#&#x4E00;&#x7EA7;&#x6846;&#x56FE;" class="headerlink" title="&#x4E00;&#x7EA7;&#x6846;&#x56FE;"></a>&#x4E00;&#x7EA7;&#x6846;&#x56FE;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/abc07d9563225229aa1aaf5912a804f7e547e15da07d758b43117b2912c449a2" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--&#x4E00;&#x7EA7;&#x6846;&#x56FE;.png"></p>
<p>&#x5BF9;&#x4E8E;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x4E2A;&#x6A21;&#x5757;&#xFF1A;</p>
<p><strong>SourceActivity</strong>&#xFF1A;&#x6267;&#x884C;startActivity&#x65B9;&#x6CD5;&#x7684;Activity&#xFF0C;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x7684;Activity&#xFF0C;&#x5F53;&#x524D;&#x5C31;&#x662F;Launch&#x7684;Activity</p>
<p><strong>TargetActivity</strong>&#xFF1A;&#x9700;&#x8981;&#x88AB;&#x542F;&#x52A8;&#x7684;Activity&#xFF0C;&#x5F53;&#x524D;&#x5C31;&#x662F;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;&#x5728;&#x6E05;&#x5355;&#x6587;&#x4EF6;&#x914D;&#x7F6E;&#x7684;MainActivity</p>
<p><strong>AMS</strong>: &#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x6307;AMS&#x8FD9;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x800C;&#x662F;&#x6307;&#x5904;&#x7406;&#x6574;&#x4E2A;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x7684;&#x7BA1;&#x7406;&#x7C7B;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C; &#x4EE5;&#x5728;&#x516C;&#x53F8;&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C; launch&#x6A21;&#x5757;&#x7684;&#x5F00;&#x53D1;&#xFF0C;&#x5728;&#x5904;&#x7406;&#x4E00;&#x4E2A;bug&#xFF0C;&#x4F46;&#x662F;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x901A;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x80AF;&#x5B9A;&#x662F;&#x9700;&#x8981;&#x627E;&#x5230;&#x901A;&#x8BAF;&#x7EC4;&#x7684;&#x540C;&#x4E8B;&#x6765;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002; &#x4F46;&#x662F;&#x516C;&#x53F8;&#x5F88;&#x5927;&#xFF0C;&#x4ED6;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x901A;&#x8BAF;&#x6A21;&#x5757;&#x662F;&#x8C01;&#x8D1F;&#x8D23;&#xFF0C;&#x66F4;&#x4E0D;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x9700;&#x8981;&#x4EA4;&#x7ED9;&#x901A;&#x8BAF;&#x7EC4;&#x5177;&#x4F53;&#x7684;&#x54EA;&#x4E2A;&#x540C;&#x4E8B;&#x5904;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x8981;&#x6C42;&#x5411;&#x516C;&#x53F8;&#x9886;&#x5BFC;&#xFF08;&#x7BA1;&#x7406;&#xFF09;&#x6C47;&#x62A5;&#xFF1A;&#x9700;&#x8981;&#x901A;&#x8BAF;&#x7EC4;&#x7684;&#x540C;&#x4E8B;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x524D;&#x4F8B;&#x5B50;&#x8BBE;&#x8BA1;&#x5230;launcher&#x548C;&#x901A;&#x8BAF;2&#x4E2A;&#x6A21;&#x5757;&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#xFF0C;&#x8FD8;&#x6D89;&#x53CA;&#x5230;&#x516C;&#x53F8;&#x7684;&#x7BA1;&#x7406;&#x8005;&#x3002;&#x5728;Activity&#x542F;&#x52A8;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#xFF0C; &#x5BF9;&#x4E8E;sourceActivity&#x3001;targetActivity&#x4ED6;&#x4EEC;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x76F4;&#x63A5;&#x4F5C;&#x7528;&#x5BF9;&#x65B9;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E00;&#x6D41;&#x7A0B;&#x9700;&#x8981;AMS&#x6765;&#x505A;&#x7BA1;&#x7406;&#x3002;</p>
<p>&#x5E76;&#x4E14;&#xFF0C;&#x8FD9;3&#x4E2A;&#x6A21;&#x5757;&#x4E5F;&#x5BF9;&#x5E94;3&#x4E2A;&#x8FDB;&#x7A0B;&#xFF0C;&#x5F53;&#x524D;&#x6848;&#x4F8B;&#x6765;&#x8BF4;&#x5206;&#x522B;&#x4E3A;&#xFF1A;launch&#x8FDB;&#x7A0B;&#xFF0C;&#x7535;&#x8BDD;&#x8FDB;&#x7A0B;&#xFF0C;system_service&#x8FDB;&#x7A0B;&#x3002;</p>
<p>&#x8FD9;&#x91CC;AMS&#x5BF9;launch&#x591A;&#x4E86;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x7BAD;&#x5934;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;launch&#x80AF;&#x5B9A;&#x662F;&#x9700;&#x8981;&#x6267;&#x884C;pause&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x6574;&#x4E2A;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x6267;&#x884C;pause&#x7684;&#x65F6;&#x673A;launch&#x81EA;&#x8EAB;&#x65E0;&#x6CD5;&#x63A7;&#x5236;&#xFF0C;&#x53EA;&#x80FD;&#x7531;AMS&#x63A7;&#x5236;&#x3002;</p>
<h2 id="&#x4E8C;&#x7EA7;&#x6846;&#x56FE;"><a href="#&#x4E8C;&#x7EA7;&#x6846;&#x56FE;" class="headerlink" title="&#x4E8C;&#x7EA7;&#x6846;&#x56FE;"></a>&#x4E8C;&#x7EA7;&#x6846;&#x56FE;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c81e40e941e6423dd2572a56842ea1f59f4f50be11db051518a20903d1f7e3ed" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--&#x4E8C;&#x7EA7;&#x6846;&#x56FE;.png"></p>
<p>&#x8FD9;&#x91CC;&#x6709;3&#x4E2A;&#x989C;&#x8272;&#xFF0C;&#x4EE3;&#x8868;3&#x4E2A;&#x9636;&#x6BB5;&#x3002;</p>
<p>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>&#x7531;launcher &#x8FDB;&#x7A0B;&#x53D1;&#x8D77;&#x542F;&#x52A8;Activity&#x7684;&#x8BF7;&#x6C42;</li>
<li>AMS&#x5904;&#x7406;&#xFF0C;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;ActivityRecord&#x548C;Task&#xFF0C;&#x5E76;&#x6302;&#x8F7D;&#x5230;&#x7A97;&#x53E3;&#x5C42;&#x7EA7;&#x6811;&#x4E2D;</li>
</ol>
<p>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>AMS &#x89E6;&#x53D1;launcher &#x7684;pause&#x6D41;&#x7A0B;</li>
<li>AMS &#x89E6;&#x53D1;&#x201D;&#x7535;&#x8BDD;&#x201D;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7684;&#x521B;&#x5EFA;</li>
<li>launcher&#x6267;&#x884C;pause&#x6D41;&#x7A0B;</li>
<li>launcher&#x6267;&#x884C;&#x5B8C;pause&#x540E;&#x6267;&#x884C;&#x8C03;&#x7528;AMS&#x7684;startSpecificActivity&#x65B9;&#x6CD5;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;Activity</li>
</ol>
<p>ASM &#x901A;&#x77E5; launcher &#x6267;&#x884C;pause&#x548C;&#x901A;&#x8FC7; Zygote &#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x90FD;&#x662F;&#x5F02;&#x6B65;&#x7684;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x6267;&#x884C;&#x7684;&#x987A;&#x5E8F;&#x3002;&#x6240;&#x4EE5;launcher&#x6267;&#x884C;completePause&#x540E;&#x8C03;&#x7528;&#x542F;&#x52A8;Activity&#x65F6;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;&#x8FDB;&#x7A0B;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x3002;</p>
<p>&#x7B2C;&#x4E09;&#x9636;&#x6BB5;&#xFF1A;</p>
<ol>
<li>&#x201C;&#x7535;&#x8BDD;&#x201D;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#xFF0C;&#x901A;&#x77E5;AMS</li>
<li>AMS&#x89E6;&#x53D1;realStartActivityLocked&#xFF0C;&#x901A;&#x77E5;&#x5E94;&#x7528;&#x542F;&#x52A8;Activity</li>
<li>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x6267;&#x884C;Activity&#x7684;&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#xFF0C;&#x751F;&#x547D;&#x5468;&#x671F; &#x8D70;&#x5230;onCreate&#x548C;onResume</li>
</ol>
<p>&#x8FD9;&#x91CC;&#x7B2C;&#x4E8C;&#x6B65;&#xFF0C;&#x91CC;&#x9762;&#x4F1A;&#x5224;&#x65AD;launcher&#x662F;&#x5426;&#x6267;&#x884C;&#x5B8C;pause&#x4E86;&#xFF0C; &#x5982;&#x679C;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x5219;&#x76F4;&#x63A5;return&#x3002;</p>
<p><strong>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x9700;&#x8981;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7684;Activity&#xFF0C;&#x5FC5;&#x987B;&#x6709;2&#x4E2A;&#x6761;&#x4EF6;&#xFF1A;1. &#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5; 2. launcher&#x6267;&#x884C;&#x5B8C;pause</strong></p>
<p>&#x5728;&#x65B0;&#x7684;Activity&#x663E;&#x793A;&#x524D;&#xFF0C; launch&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x6267;&#x884C;pause&#x7684;&#x3002;</p>
<ol>
<li><h1 id="launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;"><a href="#launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;" class="headerlink" title="launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;"></a>launch&#x70B9;&#x51FB;&#x56FE;&#x6807;&#x542F;&#x52A8;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;</h1></li>
</ol>
<p>&#x8FD9;&#x4E00;&#x9636;&#x6BB5;&#x8C03;&#x7528;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5806;&#x6808;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/94ddd7d2c822362cd19f4ea901218afc7ac5dbf646482cfccad95e9e703cbba9" alt="activity&#x542F;&#x52A8;&#x5806;&#x6808;--launch&#x8FDB;&#x7A0B;.png"></p>
<p>&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x6B63;&#x5E38;&#x901A;&#x8FC7; startActivity &#x4F20;&#x9012; intent &#x542F;&#x52A8;Activity&#x7684;&#x6D41;&#x7A0B;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002; &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x5230;Instrumentation::execStartActivity&#x3002;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x8DE8;&#x8FDB;&#x7A0B;&#x4E0E;AMS&#x901A;&#x4FE1;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<p>Activity::startActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;    Activity::startActivity</span><br><span class="line">        Activity::startActivityForResult</span><br><span class="line">            Instrumentation::execStartActivity</span><br><span class="line">                ActivityTaskManagerService::startActivity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x5728;&#x53D1;&#x8D77;&#x542F;&#x52A8;Activity&#x7684;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x7AEF;&#xFF0C;&#x903B;&#x8F91;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#xFF0C;&#x65E0;&#x8BBA;&#x54EA;&#x79CD;&#x53C2;&#x6570;&#x7684; startActivity &#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x90FD;&#x662F;&#x8C03;&#x5230; startActivityForResult &#x65B9;&#x6CD5;&#x3002;<br>&#x7136;&#x540E;&#x5728; Instrumentation &#x6700;&#x540E;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x8DE8;&#x8FDB;&#x7A0B;&#x4F20;&#x9012;&#x5230; system_service &#x8FDB;&#x7A0B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# Activity</span><br><span class="line">    public void startActivityForResult(@RequiresPermission Intent intent, int requestCode,</span><br><span class="line">            @Nullable Bundle options) {</span><br><span class="line">        if (mParent == null) {</span><br><span class="line">            options = transferSpringboardActivityOptions(options);</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    this, mMainThread.getApplicationThread(), mToken, this,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"># Instrumentation</span><br><span class="line">    public ActivityResult execStartActivity(</span><br><span class="line">            Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">            Intent intent, int requestCode, Bundle options) {</span><br><span class="line">        ......</span><br><span class="line">            // &#x5F53;&#x524D;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x5904;&#x7406;&#x7ED3;&#x675F;&#xFF0C;&#x5F00;&#x59CB;&#x4F20;&#x9012;&#x7ED9;ActivityTaskManagerService</span><br><span class="line">            int result = ActivityTaskManager.getService().startActivity(whoThread,</span><br><span class="line">                who.getOpPackageName(), who.getAttributionTag(), intent,</span><br><span class="line">                intent.resolveTypeIfNeeded(who.getContentResolver()), token,</span><br><span class="line">                target != null ? target.mEmbeddedID : null, requestCode, 0, null, options);</span><br><span class="line">            // &#x5BF9;&#x8DE8;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x7684;&#x7ED3;&#x679C;&#x505A;check</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>checkStartActivityResult &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x5982;&#x5E38;&#x89C1;&#x7684;&#x672A;&#x5728;AndroidManifest.xml&#x6CE8;&#x518C;Activity&#x7684;&#x62A5;&#x9519;&#x5C31;&#x5728;&#x8FD9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# Instrumentation</span><br><span class="line">    public static void checkStartActivityResult(int res, Object intent) {</span><br><span class="line">        if (!ActivityManager.isStartResultFatalError(res)) {</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        switch (res) {</span><br><span class="line">            case ActivityManager.START_INTENT_NOT_RESOLVED:</span><br><span class="line">            case ActivityManager.START_CLASS_NOT_FOUND:  // &#x672A;&#x5728;AndroidManifest.xml&#x6CE8;&#x518C;</span><br><span class="line">                if (intent instanceof Intent &amp;&amp; ((Intent)intent).getComponent() != null)</span><br><span class="line">                    throw new ActivityNotFoundException(</span><br><span class="line">                            &quot;Unable to find explicit activity class &quot;</span><br><span class="line">                            + ((Intent)intent).getComponent().toShortString()</span><br><span class="line">                            + &quot;; have you declared this activity in your AndroidManifest.xml&quot;</span><br><span class="line">                            + &quot;, or does your intent not match its declared &lt;intent-filter&gt;?&quot;);</span><br><span class="line">                throw new ActivityNotFoundException(</span><br><span class="line">                        &quot;No Activity found to handle &quot; + intent);</span><br><span class="line">            case ActivityManager.START_PERMISSION_DENIED:</span><br><span class="line">                throw new SecurityException(&quot;Not allowed to start activity &quot;</span><br><span class="line">                        + intent);</span><br><span class="line">            case ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT:</span><br><span class="line">                throw new AndroidRuntimeException(</span><br><span class="line">                        &quot;FORWARD_RESULT_FLAG used while also requesting a result&quot;);</span><br><span class="line">            case ActivityManager.START_NOT_ACTIVITY:</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;PendingIntent is not an activity&quot;);</span><br><span class="line">            case ActivityManager.START_NOT_VOICE_COMPATIBLE:</span><br><span class="line">                throw new SecurityException(</span><br><span class="line">                        &quot;Starting under voice control not allowed for: &quot; + intent);</span><br><span class="line">            case ActivityManager.START_VOICE_NOT_ACTIVE_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Session calling startVoiceActivity does not match active session&quot;);</span><br><span class="line">            case ActivityManager.START_VOICE_HIDDEN_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Cannot start voice activity on a hidden session&quot;);</span><br><span class="line">            case ActivityManager.START_ASSISTANT_NOT_ACTIVE_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Session calling startAssistantActivity does not match active session&quot;);</span><br><span class="line">            case ActivityManager.START_ASSISTANT_HIDDEN_SESSION:</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Cannot start assistant activity on a hidden session&quot;);</span><br><span class="line">            case ActivityManager.START_CANCELED:</span><br><span class="line">                throw new AndroidRuntimeException(&quot;Activity could not be started for &quot;</span><br><span class="line">                        + intent);</span><br><span class="line">            default:</span><br><span class="line">                throw new AndroidRuntimeException(&quot;Unknown error code &quot;</span><br><span class="line">                        + res + &quot; when starting &quot; + intent);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><h1 id="system-service-&#x5904;&#x7406;"><a href="#system-service-&#x5904;&#x7406;" class="headerlink" title="system_service &#x5904;&#x7406;"></a>system_service &#x5904;&#x7406;</h1></li>
</ol>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityTaskManagerService::startActivity</span><br><span class="line">    ActivityTaskManagerService::startActivityAsUser</span><br><span class="line">        ActivityTaskManagerService::startActivityAsUser</span><br><span class="line">            ActivityStartController::obtainStarter</span><br><span class="line">                ActivityStarter::execute</span><br><span class="line">                    ActivityStarter::executeRequest -- &#x6784;&#x5EFA; ActivityRecord --2..1 &#x521B;&#x5EFA;ActivityRecord</span><br><span class="line">                        ActivityStarter::startActivityUnchecked</span><br><span class="line">                            ActivityStarter::startActivityInner        -- 2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner</span><br><span class="line">                                ActivityStarter::getOrCreateRootTask   -- 2.2.1 &#x521B;&#x5EFA;&#x6216;&#x8005;&#x62FF;&#x5230;Task</span><br><span class="line">                                ActivityStarter::setNewTask            -- 2.2.2 &#x5C06;task&#x4E0E;activityRecord &#x7ED1;&#x5B9A;</span><br><span class="line">                                RootWindowContainer::resumeFocusedTasksTopActivities    --2.2.3 &#x663E;&#x793A;Activity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x8DDF;&#x8E2A;</strong></p>
<p>&#x6D41;&#x7A0B;&#x6765;&#x5230;ActivityTaskManagerService::startActivity&#xFF0C;&#x7ECF;&#x8FC7;2&#x6B21;&#x7B80;&#x5355;&#x7684;&#x8DF3;&#x8F6C;&#x4F1A;&#x6267;&#x884C; startActivityAsUser &#x65B9;&#x6CD5;&#x3002;<br>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4F1A;&#x6784;&#x5EFA;&#x4E00;&#x4E2A; ActivityStartController &#xFF0C;&#x6839;&#x636E;&#x7C7B;&#x540D;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x7C7B;&#x662F;&#x63A7;&#x5236;Activity&#x542F;&#x52A8;&#x3002;</p>
<p>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;    private int startActivityAsUser(IApplicationThread caller, String callingPackage,</span><br><span class="line">            @Nullable String callingFeatureId, Intent intent, String resolvedType,</span><br><span class="line">            IBinder resultTo, String resultWho, int requestCode, int startFlags,</span><br><span class="line">            ProfilerInfo profilerInfo, Bundle bOptions, int userId, boolean validateIncomingUser) {</span><br><span class="line">            ......</span><br><span class="line">            // &#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityStartController</span><br><span class="line">            return getActivityStartController().obtainStarter(intent, &quot;startActivityAsUser&quot;)</span><br><span class="line">                .setCaller(caller)</span><br><span class="line">                .setCallingPackage(callingPackage)</span><br><span class="line">                .setCallingFeatureId(callingFeatureId)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setResultTo(resultTo)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setStartFlags(startFlags)</span><br><span class="line">                .setProfilerInfo(profilerInfo)</span><br><span class="line">                .setActivityOptions(bOptions)</span><br><span class="line">                .setUserId(userId)</span><br><span class="line">                .execute();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ActivityStartController getActivityStartController() {</span><br><span class="line">        return mActivityStartController;</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>ActivityStartController::obtainStarter&#x8FD4;&#x56DE;&#x7684;&#x662F;ActivityStarter&#x5BF9;&#x8C61;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStartController</span><br><span class="line">    ActivityStarter obtainStarter(Intent intent, String reason) {</span><br><span class="line">        return mFactory.obtain().setIntent(intent).setReason(reason);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#x5728;ActivityTaskManagerService::startActivityAsUser&#x65B9;&#x6CD5;&#x4E2D;&#x7684;build&#x6A21;&#x5F0F;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x5BF9; ActivityStarter &#x5BF9;&#x8C61;&#x505A;&#x6784;&#x5EFA;&#x3002;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5176; execute &#x65B9;&#x6CD5;&#x3002;<br>&#x7136;&#x540E;&#x8C03;&#x7528; executeRequest &#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line"></span><br><span class="line">    int execute() {</span><br><span class="line">        ......</span><br><span class="line">        res = executeRequest(mRequest);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h2 id="2-1&#x521B;&#x5EFA;ActivityRecord"><a href="#2-1&#x521B;&#x5EFA;ActivityRecord" class="headerlink" title="2.1&#x521B;&#x5EFA;ActivityRecord"></a>2.1&#x521B;&#x5EFA;ActivityRecord</h2><p>ActivityStarter::executeRequest&#x662F;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x5185;&#x90E8;&#x4F1A;&#x521B;&#x5EFA; ActivityRecord &#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A; ActivityRecord &#x5BF9;&#x8C61;&#x6301;&#x6709; token &#xFF0C;&#x8FD9;&#x4E2A;token&#x5C31;&#x662F;&#x4EE5;&#x540E;&#x5206;&#x6790;&#x5176;&#x4ED6;&#x903B;&#x8F91;&#x4E00;&#x76F4;&#x4F1A;&#x51FA;&#x73B0;&#x7684;token&#x3002;</p>
<p>&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x4E2D;&#x7684;Activity&#x5728;AMS&#x7684;&#x4EE3;&#x8868;&#x5C31;&#x662F;ActivityRecord</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">  private int executeRequest(Request request) {</span><br><span class="line">        ......</span><br><span class="line">        final ActivityRecord r = new ActivityRecord.Builder(mService)</span><br><span class="line">                .setCaller(callerApp)</span><br><span class="line">                .setLaunchedFromPid(callingPid)</span><br><span class="line">                .setLaunchedFromUid(callingUid)</span><br><span class="line">                .setLaunchedFromPackage(callingPackage)</span><br><span class="line">                .setLaunchedFromFeature(callingFeatureId)</span><br><span class="line">                .setIntent(intent)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setActivityInfo(aInfo)</span><br><span class="line">                .setConfiguration(mService.getGlobalConfiguration())</span><br><span class="line">                .setResultTo(resultRecord)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setComponentSpecified(request.componentSpecified)</span><br><span class="line">                .setRootVoiceInteraction(voiceSession != null)</span><br><span class="line">                .setActivityOptions(checkedOptions)</span><br><span class="line">                .setSourceRecord(sourceRecord)</span><br><span class="line">                .build();</span><br><span class="line">        ......</span><br><span class="line">        // &#x7EE7;&#x7EED;&#x6267;&#x884C;startActivityUnchecked</span><br><span class="line">        mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class="line">                request.voiceInteractor, startFlags, true /* doResume */, checkedOptions,</span><br><span class="line">                inTask, inTaskFragment, restrictedBgActivity, intentGrants);</span><br><span class="line">        ......</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x800C; startActivityUnchecked &#x4E3B;&#x8981;&#x8C03;&#x7528;&#x7684;&#x662F; startActivityInner , &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x6D41;&#x7A0B;&#x7684;&#x5173;&#x952E;&#x70B9;&#x3002;</p>
<h2 id="2-2-&#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner"><a href="#2-2-&#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner" class="headerlink" title="2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner"></a>2.2 &#x5173;&#x952E;&#x51FD;&#x6570;startActivityInner</h2><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;AMS&#x5728;Activity&#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x6700;&#x91CD;&#x8981;&#x7684;&#x51FD;&#x6570;&#x4E4B;&#x4E00;&#xFF0C;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x5230;&#x3010;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x3011;&#x76F8;&#x5173;&#xFF0C;&#x5148;&#x770B;&#x770B;&#x6B63;&#x5E38;&#x5728;launch&#x7684;&#x548C;&#x542F;&#x52A8;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x540E;&#x7684;&#x5C42;&#x7EA7;&#x6811;&#x5BF9;&#x6BD4;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/641050b07704bbd27f03b4deeaba61d5afd7f222a8321f47cdd5cef8cd1e3f4e" alt="&#x524D;&#x540E;&#x5C42;&#x7EA7;&#x6811;&#x5BF9;&#x6BD4;.png"></p>
<p>&#x8FD9;&#x91CC;&#x9996;&#x5148;&#x591A;&#x4E86;3&#x4E2A;&#x4E1C;&#x897F;:1&#x4E2A;Task,1&#x4E2A;&#x4E0A;&#x4E00;&#x6B65;&#x521B;&#x5EFA;&#x7684;ActivityRecord&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x5C31;&#x662F;WindowState&#x3002;</p>
<p>&#x53E6;&#x5916;&#x8FD9;&#x4E2A;Task&#x8FD8;&#x79FB;&#x52A8;&#x5230;&#x4E86;<strong>DefaultTaskDisplayArea</strong>&#x7684;&#x6700;&#x9876;&#x90E8;&#x3002;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x521B;&#x5EFA;Task</li>
<li>ActivityRecord&#x6302;&#x5728;&#x5230;&#x8FD9;&#x4E2A;Task&#x4E0B;</li>
<li>&#x5C06;&#x8FD9;&#x4E2A;Task&#x79FB;&#x52A8;&#x5230;&#x6700;&#x4E0A;&#x9762;</li>
</ol>
<p>&#x81F3;&#x4E8E;&#x6700;&#x4E0B;&#x9762;&#x7684;&#x90A3;&#x4E2A; 546fce2 &#x4E3A;&#x4EC0;&#x4E48;&#x662F;WindowState&#x5BF9;&#x8C61;&#xFF0C;&#x53C8;&#x662F;&#x600E;&#x4E48;&#x6302;&#x5728;&#x5230;ActivityRecord&#x4E0A;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x3010;&#x5E94;&#x7528;&#x7684;addWindow&#x6D41;&#x7A0B;&#x3011;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">    int startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">            int startFlags, boolean doResume, ActivityOptions options, Task inTask,</span><br><span class="line">            TaskFragment inTaskFragment, boolean restrictedBgActivity,</span><br><span class="line">            NeededUriGrants intentGrants) {</span><br><span class="line">            ......</span><br><span class="line">            / computeTargetTask&#x5185;&#x90E8;&#x4F1A;&#x6839;&#x636E;&#x5177;&#x4F53;&#x6761;&#x4EF6;&#x8FD4;&#x56DE;Task&#xFF08;&#x6BD4;&#x5982;&#x6807;&#x5FD7;&#x4F4D;FLAG_ACTIVITY_NEW_TASK&#x59D0;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x521B;&#x5EFA;Task   &#xFF09;</span><br><span class="line">            // &#x8FD9;&#x91CC;reusedTask&#x4E3A; null&#xFF0C;&#x56E0;&#x4E3A;&#x662F;&#x65B0;&#x542F;&#x52A8;&#x7684;&#x5E94;&#x7528;&#xFF0C;&#x6240;&#x4EE5;computeTargetTask&#x4E5F;&#x627E;&#x4E0D;&#x5230;task&#xFF0C;&#x6700;&#x7EC8;&#x4E5F;&#x4E3A;null</span><br><span class="line">            /</span><br><span class="line">            final Task targetTask = reusedTask != null ? reusedTask : computeTargetTask();</span><br><span class="line">            // &#x90A3;&#x4E48;newTask&#x4E3A;true&#xFF0C; &#x8868;&#x793A;&#x9700;&#x8981;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;task</span><br><span class="line">            final boolean newTask = targetTask == null;</span><br><span class="line">            // &#x540C;&#x6837;&#x4E3A;null</span><br><span class="line">            mTargetTask = targetTask;</span><br><span class="line">            ......</span><br><span class="line">            if (mTargetRootTask == null) {</span><br><span class="line">            // &#x91CD;&#x70B9;* 1. &#x521B;&#x5EFA;Task   23</span><br><span class="line">            mTargetRootTask = getOrCreateRootTask(mStartActivity, mLaunchFlags, targetTask,</span><br><span class="line">                    mOptions);</span><br><span class="line">            }</span><br><span class="line">            if (newTask) {</span><br><span class="line">                // taskToAffiliate &#x4E3A;null</span><br><span class="line">                final Task taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != null)</span><br><span class="line">                        ? mSourceRecord.getTask() : null;</span><br><span class="line">                // &#x91CD;&#x70B9;* 2. &#x5C06;&#x9700;&#x8981;&#x542F;&#x52A8;&#x7684;ActivityRecord&#x4E0E; &#x65B0;&#x521B;&#x5EFA;&#x7684;Task &#x8FDB;&#x884C;&#x7ED1;&#x5B9A;</span><br><span class="line">                setNewTask(taskToAffiliate);</span><br><span class="line">            } else if (mAddingToTask) {</span><br><span class="line">                addOrReparentStartingActivity(targetTask, &quot;adding to task&quot;);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            if (!mAvoidMoveToFront &amp;&amp; mDoResume) {</span><br><span class="line">                // &#x79FB;&#x52A8;&#x5230;&#x6808;&#x9876; </span><br><span class="line">                mTargetRootTask.getRootTask().moveToFront(&quot;reuseOrNewTask&quot;, targetTask);</span><br><span class="line">                ......</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">            if (mDoResume) {</span><br><span class="line">                ......</span><br><span class="line">                // &#x91CD;&#x70B9;*3. task &#x5904;&#x7406;&#x5B8C;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x5C06;task&#x9876;&#x90E8;&#x7684;Activity&#x663E;&#x793A;&#xFF08;resume&#xFF09; </span><br><span class="line">                mRootWindowContainer.resumeFocusedTasksTopActivities(</span><br><span class="line">                        mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p>&#x5177;&#x4F53;&#x539F;&#x56E0;&#x5728;&#x4EE3;&#x7801;&#x52A0;&#x4E86;&#x6CE8;&#x91CA;&#xFF0C;&#x90A3;&#x4E48;&#x7B2C;&#x4E00;&#x6B65;&#x5C31;&#x662F;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Task&#x4E86;&#x3002;</p>
<h3 id="2-2-1-&#x521B;&#x5EFA;Task-getOrCreateRootTask"><a href="#2-2-1-&#x521B;&#x5EFA;Task-getOrCreateRootTask" class="headerlink" title="2.2.1 &#x521B;&#x5EFA;Task getOrCreateRootTask"></a>2.2.1 &#x521B;&#x5EFA;Task getOrCreateRootTask</h3><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;ActivityStarter::getOrCreateRootTask</span><br><span class="line">    RootWindowContainer::getOrCreateRootTask</span><br><span class="line">        RootWindowContainer::getOrCreateRootTask</span><br><span class="line">            TaskDisplayArea::getOrCreateRootTask</span><br><span class="line">                TaskDisplayArea::getOrCreateRootTask</span><br><span class="line">                    Task::Build     ---&#x521B;&#x5EFA;Task</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarter</span><br><span class="line">    private Task getOrCreateRootTask(ActivityRecord r, int launchFlags, Task task,</span><br><span class="line">            ActivityOptions aOptions) {</span><br><span class="line">        final boolean onTop =</span><br><span class="line">                (aOptions == null || !aOptions.getAvoidMoveToFront()) &amp;&amp; !mLaunchTaskBehind;</span><br><span class="line">        final Task sourceTask = mSourceRecord != null ? mSourceRecord.getTask() : null;</span><br><span class="line">        return mRootWindowContainer.getOrCreateRootTask(r, aOptions, task, sourceTask, onTop,</span><br><span class="line">                mLaunchParams, launchFlags);</span><br><span class="line">    }</span><br><span class="line">// onTop &#x8868;&#x793A;&#x662F;&#x5426;&#x8981;&#x79FB;&#x5230;&#x5230;&#x5F53;&#x524D;&#x6808;&#x9876;&#xFF0C;&#x90A3;&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x7684;&#xFF0C;&#x65B0;&#x542F;&#x52A8;&#x7684;Activity&#x5F53;&#x524D;&#x8981;&#x518D;&#x6700;&#x4E0A;&#x9762;&#xFF0C;&#x8FD9;&#x91CC; aOptions &#x4E3A;null&#xFF0C;&#x6240;&#x4EE5;&#x4E3A;true</span><br><span class="line">// sourceTask &#x8868;&#x793A;&#x4ECE;&#x54EA;&#x91CC;&#x542F;&#x52A8;&#x7684;&#xFF0C;&#x5F53;&#x524D;launch&#x6240;&#x5728;&#x7684;Task &#x5C31;&#x662F;sourceTask</span><br><span class="line"></span><br><span class="line"># RootWindowContainer</span><br><span class="line">    Task getOrCreateRootTask(@Nullable ActivityRecord r, @Nullable ActivityOptions options,</span><br><span class="line">            @Nullable Task candidateTask, boolean onTop) {</span><br><span class="line">        return getOrCreateRootTask(r, options, candidateTask, null /* sourceTask */, onTop,</span><br><span class="line">                null /* launchParams */, 0 /* launchFlags */);</span><br><span class="line">    }</span><br><span class="line">    Task getOrCreateRootTask(@Nullable ActivityRecord r,</span><br><span class="line">            @Nullable ActivityOptions options, @Nullable Task candidateTask,</span><br><span class="line">            @Nullable Task sourceTask, boolean onTop,</span><br><span class="line">            @Nullable LaunchParamsController.LaunchParams launchParams, int launchFlags) {</span><br><span class="line">            ......</span><br><span class="line">            final int activityType = resolveActivityType(r, options, candidateTask);</span><br><span class="line">            if (taskDisplayArea != null) {</span><br><span class="line">                if (canLaunchOnDisplay(r, taskDisplayArea.getDisplayId())) {</span><br><span class="line">                    // &#x91CD;&#x70B9;*1. &#x4F20;&#x9012;&#x5230;TaskDisplayArea</span><br><span class="line">                    return taskDisplayArea.getOrCreateRootTask(r, options, candidateTask,</span><br><span class="line">                            sourceTask, launchParams, launchFlags, activityType, onTop);</span><br><span class="line">                } else {</span><br><span class="line">                    taskDisplayArea = null;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">    }</span><br><span class="line">// &#x7ECF;&#x8FC7;&#x540C;&#x540D;&#x8C03;&#x7528;&#x540E;&#xFF0C;&#x903B;&#x8F91;&#x8FDB;&#x5165;&#x5230;  TaskDisplayArea</span><br><span class="line"></span><br><span class="line"># TaskDisplayArea</span><br><span class="line">    Task getOrCreateRootTask(int windowingMode, int activityType, boolean onTop,</span><br><span class="line">            @Nullable Task candidateTask, @Nullable Task sourceTask,</span><br><span class="line">            @Nullable ActivityOptions options, int launchFlags) {</span><br><span class="line">            if(....) {</span><br><span class="line">                // &#x62FF;&#x5230;&#x4E4B;&#x524D;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">                return candidateTask.getRootTask();</span><br><span class="line">            }</span><br><span class="line">            ......// &#x7B2C;&#x4E00;&#x6B21;&#x663E;&#x793A;&#x6240;&#x4EE5;&#x662F;&#x65B0;&#x5EFA;Task</span><br><span class="line">            return new Task.Builder(mAtmService)</span><br><span class="line">                .setWindowingMode(windowingMode)</span><br><span class="line">                .setActivityType(activityType)</span><br><span class="line">                .setOnTop(onTop)</span><br><span class="line">                .setParent(this)  // &#x4E3B;&#x8981;&#x8FD9;&#x4E2A;this&#x88AB;&#x8BBE;&#x7F6E;&#x4E3A;Parent&#x3002;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x6302;&#x8F7D;&#x5230;&#x4E86;DefaultTaskDisplayArea&#x4E0B;</span><br><span class="line">                .setSourceTask(sourceTask)</span><br><span class="line">                .setActivityOptions(options)</span><br><span class="line">                .setLaunchFlags(launchFlags)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">// &#x770B;&#x65B9;&#x6CD5;&#x540D;&#x662F;&#x83B7;&#x53D6;&#x6216;&#x521B;&#x5EFA;Task, &#x8FD9;&#x8FB9;&#x662F;&#x65B0;&#x542F;&#x52A8;&#x7684;Activity&#x6240;&#x4EE5;&#x9700;&#x8981;&#x521B;&#x5EFA;Task&#x3002;&#x5982;&#x679C;&#x662F;&#x4EE5;&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x65B9;&#x5F0F;&#x6253;&#x5F00;&#x5E94;&#x7528;&#x5185;&#x7684;&#x53E6;&#x4E00;&#x4E2A;Activity&#xFF0C;&#x5C31;&#x8D70;&#x7684;&#x662F;&#x4E0A;&#x9762;&#x7684; return candidateTask.getRootTask();</span><br><span class="line">&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x771F;&#x6B63;&#x89E6;&#x53D1;Task&#x7684;&#x521B;&#x5EFA;&#x3002;</span><br><span class="line">// &#x53E6;&#x5916;&#x8BBE;&#x7F6E;&#x7684;parent&#x5C31;&#x662F;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x5E94;&#x7528;&#x6240;&#x5728;&#x7684;&#x540D;&#x4E3A;&#x201C;DefaultTaskDisplayArea&#x201D;&#x7684;TaskDisplayArea</span><br><span class="line"># Task</span><br><span class="line">    # Task.Builder</span><br><span class="line">        Task build() {</span><br><span class="line">            if (mParent != null &amp;&amp; mParent instanceof TaskDisplayArea) {</span><br><span class="line">                validateRootTask((TaskDisplayArea) mParent);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            if (mActivityInfo == null) {</span><br><span class="line">                mActivityInfo = new ActivityInfo();</span><br><span class="line">                mActivityInfo.applicationInfo = new ApplicationInfo();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            mUserId = UserHandle.getUserId(mActivityInfo.applicationInfo.uid);</span><br><span class="line">            mTaskAffiliation = mTaskId;</span><br><span class="line">            mLastTimeMoved = System.currentTimeMillis();</span><br><span class="line">            mNeverRelinquishIdentity = true;</span><br><span class="line">            mCallingUid = mActivityInfo.applicationInfo.uid;</span><br><span class="line">            mCallingPackage = mActivityInfo.packageName;</span><br><span class="line">            mResizeMode = mActivityInfo.resizeMode;</span><br><span class="line">            mSupportsPictureInPicture = mActivityInfo.supportsPictureInPicture();</span><br><span class="line">            if (mActivityOptions != null) {</span><br><span class="line">                mRemoveWithTaskOrganizer = mActivityOptions.getRemoveWithTaskOranizer();</span><br><span class="line">            }</span><br><span class="line">            // &#x91CD;&#x70B9;* 1. &#x521B;&#x5EFA;task</span><br><span class="line">            final Task task = buildInner();</span><br><span class="line">            task.mHasBeenVisible = mHasBeenVisible;</span><br><span class="line"></span><br><span class="line">            // Set activity type before adding the root task to TaskDisplayArea, so home task can</span><br><span class="line">            // be cached, see TaskDisplayArea#addRootTaskReferenceIfNeeded().</span><br><span class="line">            if (mActivityType != ACTIVITY_TYPE_UNDEFINED) {</span><br><span class="line">                task.setActivityType(mActivityType);</span><br><span class="line">            }</span><br><span class="line">            // &#x91CD;&#x70B9;* 2. &#x5165;&#x6808; &#x8FD9;&#x91CC;&#x7684; mOnTop&#x4E3A;true</span><br><span class="line">            if (mParent != null) {</span><br><span class="line">                if (mParent instanceof Task) {</span><br><span class="line">                    final Task parentTask = (Task) mParent;</span><br><span class="line">                    parentTask.addChild(task, mOnTop ? POSITION_TOP : POSITION_BOTTOM,</span><br><span class="line">                            (mActivityInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != 0);</span><br><span class="line">                } else {</span><br><span class="line">                    mParent.addChild(task, mOnTop ? POSITION_TOP : POSITION_BOTTOM);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            // Set windowing mode after attached to display area or it abort silently.</span><br><span class="line">            if (mWindowingMode != WINDOWING_MODE_UNDEFINED) {</span><br><span class="line">                task.setWindowingMode(mWindowingMode, true /* creating */);</span><br><span class="line">            }</span><br><span class="line">            // &#x8FD4;&#x56DE;</span><br><span class="line">            return task;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // &#x521B;&#x5EFA;</span><br><span class="line">        Task buildInner() {</span><br><span class="line">            return new Task(mAtmService, mTaskId, mIntent, mAffinityIntent, mAffinity,</span><br><span class="line">                    mRootAffinity, mRealActivity, mOrigActivity, mRootWasReset, mAutoRemoveRecents,</span><br><span class="line">                    mAskedCompatMode, mUserId, mEffectiveUid, mLastDescription, mLastTimeMoved,</span><br><span class="line">                    mNeverRelinquishIdentity, mLastTaskDescription, mLastSnapshotData,</span><br><span class="line">                    mTaskAffiliation, mPrevAffiliateTaskId, mNextAffiliateTaskId, mCallingUid,</span><br><span class="line">                    mCallingPackage, mCallingFeatureId, mResizeMode, mSupportsPictureInPicture,</span><br><span class="line">                    mRealActivitySuspended, mUserSetupComplete, mMinWidth, mMinHeight,</span><br><span class="line">                    mActivityInfo, mVoiceSession, mVoiceInteractor, mCreatedByOrganizer,</span><br><span class="line">                    mLaunchCookie, mDeferTaskAppear, mRemoveWithTaskOrganizer);</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<p><strong>&#x5C0F;&#x7ED3;&#xFF1A;</strong></p>
<p>&#x6700;&#x540E;&#x63CF;&#x8FF0;&#x4E00;&#x4E0B;&#x6700;&#x540E;&#x521B;&#x5EFA;&#x7684;2&#x4E2A;&#x91CD;&#x70B9;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li>&#x770B;&#x5230;&#x901A;&#x8FC7;buildInner &#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;task&#xFF0C;&#x800C;buildInner &#x4E5F;&#x5F88;&#x7B80;&#x5355;&#x7C97;&#x66B4;&#xFF0C;&#x901A;&#x8FC7;&#x5404;&#x4E2A;&#x53D8;&#x91CF;&#x76F4;&#x63A5;new Task &#x5BF9;&#x8C61;&#x3002;</li>
<li>mParent &#x4E0D;&#x4E3A;null&#xFF0C; &#x662F; &#x56E0;&#x4E3A;&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019; setParent&#xFF08;this&#xFF09;,&#x5F53;&#x524D;&#x7684;&#x8FD9;&#x4E2A;this&#xFF0C;&#x5C31;&#x662F; getDefaultTaskDisplayArea&#x8FD4;&#x56DE;&#x7684;&#x3002;&#x5C31;&#x662F; 37&#x5C42;&#x7684;&#x7B2C;&#x4E8C;&#x5C42;&#x5E94;&#x7528;Activity&#x5B58;&#x5728;&#x7684;&#x201D;DefaultTaskDisplayArea&#x201D;&#x3002;</li>
</ol>
<p>&#x5728; RootWindowContainer::getOrCreateRootTask &#x4F53;&#x73B0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/816de32ddfd4af4a5cf20a70ba414c909e148e75437ed1d15a40d9a737b87514" alt="&#x521B;&#x5EFA;Task-getOrCreateRootTask.png"></p>
<p>&#x6CE8;&#x610F;log&#x91CC;&#x7684; #17 &#x7684;&#x8FD9;&#x4E2A;Task&#xFF0C;&#x4E0E;&#x524D;&#x9762;&#x7684;&#x5C42;&#x7EA7;&#x7ED3;&#x6784;&#x6811;&#x65B0;&#x589E;&#x7684;Task,&#x662F;&#x5BF9;&#x5E94;&#x7684;&#x4E0A;&#x7684;&#x3002;&#x800C;&#x4E14;this= DefaultTaskDisplayArea &#x8BF4;&#x660E;&#x4E5F;&#x786E;&#x5B9E;&#x662F;&#x5F80;DefaultTaskDisplayArea&#x91CC;&#x6DFB;&#x52A0;&#x4E86;&#x3002;<br>&#x53E6;&#x5916; log&#x91CC;index&#x4E3A;3&#xFF0C;&#x7ED3;&#x5408;&#x6700;&#x4E0A;&#x9762;&#x7684;&#x524D;&#x540E;&#x5BF9;&#x6BD4;&#xFF0C;&#x8BF4;&#x660E;&#x4E5F;&#x7684;&#x5F80;&#x9876;&#x90E8;&#x6DFB;&#x52A0;&#x3002;</p>
<h3 id="2-2-2-&#x5C06;task&#x4E0E;activityRecord-setNewTask"><a href="#2-2-2-&#x5C06;task&#x4E0E;activityRecord-setNewTask" class="headerlink" title="2.2.2 &#x5C06;task&#x4E0E;activityRecord setNewTask"></a>2.2.2 &#x5C06;task&#x4E0E;activityRecord setNewTask</h3><p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;    ActivityStarer::setNewTask</span><br><span class="line">        ActivityStarer::addOrReparentStartingActivity</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarer</span><br><span class="line">    private void setNewTask(Task taskToAffiliate) {</span><br><span class="line">        // &#x4E3A;true</span><br><span class="line">        final boolean toTop = !mLaunchTaskBehind &amp;&amp; !mAvoidMoveToFront;</span><br><span class="line">        // &#x5C31;&#x662F;mTargetRootTask,&#x4E5F;&#x5C31;&#x662F;&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">        final Task task = mTargetRootTask.reuseOrCreateTask(</span><br><span class="line">                mNewTaskInfo != null ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                mNewTaskIntent != null ? mNewTaskIntent : mIntent, mVoiceSession,</span><br><span class="line">                mVoiceInteractor, toTop, mStartActivity, mSourceRecord, mOptions);</span><br><span class="line">        task.mTransitionController.collectExistenceChange(task);</span><br><span class="line">        // ActivityRecord&#x7684;&#x6302;&#x8F7D;</span><br><span class="line">        addOrReparentStartingActivity(task, &quot;setTaskFromReuseOrCreateNewTask&quot;);</span><br><span class="line">        // &#x9700;&#x8981;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684;&#x65E5;&#x5FD7;&#x6253;&#x5370;</span><br><span class="line">        ProtoLog.v(WM_DEBUG_TASKS, &quot;Starting new activity %s in new task %s&quot;,</span><br><span class="line">                mStartActivity, mStartActivity.getTask());</span><br><span class="line"></span><br><span class="line">        // mLaunchTaskBehind &#x4E3A;false&#xFF0C;&#x6240;&#x4EE5;taskToAffiliate &#x4E3A;null </span><br><span class="line">        if (taskToAffiliate != null) {</span><br><span class="line">            mStartActivity.setTaskToAffiliateWith(taskToAffiliate);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;task &#x548C;mTargetRootTask&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C; &#x8FDB;&#x6E90;&#x7801;&#x8DDF;&#x5230;&#x6D41;&#x7A0B;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x3002;<br>&#x7136;&#x540E;&#x8FDB;&#x5165; addOrReparentStartingActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;# ActivityStarer</span><br><span class="line">    private void addOrReparentStartingActivity(@NonNull Task task, String reason) {</span><br><span class="line">        //  newParent = task &#x90FD;&#x662F;&#x521A;&#x521A;&#x521B;&#x5EFA;&#x7684;Task</span><br><span class="line">        TaskFragment newParent = task;</span><br><span class="line">        ......</span><br><span class="line">        if (mStartActivity.getTaskFragment() == null</span><br><span class="line">                || mStartActivity.getTaskFragment() == newParent) {</span><br><span class="line">            // &#x91CD;&#x70B9;&#xFF0C; &#x5C06; ActivityRecord&#x6302;&#x5728;&#x5230;&#x65B0;&#x521B;&#x5EFA;&#x7684;Task&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x9876;&#x90E8;</span><br><span class="line">            newParent.addChild(mStartActivity, POSITION_TOP);</span><br><span class="line">        } else {</span><br><span class="line">            mStartActivity.reparent(newParent, newParent.getChildCount() /* top */, reason);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x903B;&#x8F91;&#x8BBE;&#x8BA1;&#x5230;&#x7684;Task&#x5C31;&#x662F;&#x4E0A;&#x4E00;&#x6B65;&#x521B;&#x5EFA;&#x7684;Task&#xFF0C;mStartActivity&#x5219;&#x662F;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x5728;&#x4E4B;&#x524D;&#x903B;&#x8F91;&#x521B;&#x5EFA;&#x7684;ActivityRecord&#x3002;</p>
<p><strong>setNewTask&#x7684;&#x5806;&#x6808;&#x4FE1;&#x606F;&#x5982;&#x4E0B;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/d5b867d3024696e4f0b4a8e8ace66c70fee7893f6520664b4f980566a6fc1996" alt="AcvtivityRecord&#x6302;&#x5728;&#x5230;Task.png"></p>
<p>&#x53E6;&#x5916;&#x8FD9;&#x6BB5;&#x903B;&#x8F91;&#x91CC;&#x6709;&#x4E2A;ProtoLog&#x6253;&#x5370;&#xFF0C;&#x65E5;&#x5FD7;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/850b73b8b4ee169e903d5b920ffa720aa48d06b9cf7d94145b4ffdbc0c092c7e" alt="setNewTask&#x7684;ProtoLog.png"></p>
<p><strong>&#x5C0F;&#x7ED3;&#xFF1A;</strong></p>
<p>&#x7ED3;&#x5408;&#x903B;&#x8F91;&#x5206;&#x6790;+&#x5806;&#x6808;&#x4FE1;&#x606F;+ProtoLog&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x8BA4;setNewTask&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x662F;&#x5C06;ActivityRecord&#x6302;&#x5728;&#x5230;Task&#x4E2D;&#xFF0C;&#x800C;&#x4E14;&#x5728;&#x9876;&#x90E8;</p>
<h3 id="2-2-2-3-&#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8;-moveToFront"><a href="#2-2-2-3-&#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8;-moveToFront" class="headerlink" title="2.2.2.3 &#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8; moveToFront"></a>2.2.2.3 &#x79FB;&#x52A8;Task&#x5230;&#x5BB9;&#x5668;&#x9876;&#x90E8; moveToFront</h3><p>&#x8FD9;&#x91CC;&#x63D0;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;moveToFront&#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x524D;&#x9762;&#x521B;&#x5EFA;Task&#x5E76;&#x6DFB;&#x52A0;&#x5230; DefaultTaskDisplayArea &#x65F6;&#x662F;&#x5F80;&#x9876;&#x90E8;&#x6DFB;&#x52A0;&#xFF0C;&#x540E;&#x9762;&#x5C06;ActivityRecord&#x6302;&#x5728;&#x5230;Task,&#x4E5F;&#x662F;&#x6302;&#x5728;&#x5230;&#x5176;&#x9876;&#x90E8;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5176;&#x5B9E;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x3002;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x573A;&#x666F;&#xFF0C;&#x8FD9;&#x91CC;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x91CD;&#x70B9;&#x65B9;&#x6CD5;&#x3002;</p>
<p><strong>&#x8C03;&#x7528;&#x94FE;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;Task::moveToFront                      -- 2.1.3 &#x79FB;&#x52A8;Task</span><br><span class="line">    Task::moveToFrontInner</span><br><span class="line">        TaskDisplayArea::positionChildAt</span><br><span class="line">            TaskDisplayArea::positionChildTaskAt</span><br><span class="line">                ActivityTaskSupervisor::updateTopResumedActivityIfNeeded</span><br><span class="line">                    ActivityRecord::onTopResumedActivityChanged      --&#x89E6;&#x53D1;TopResumedActivityChangeItem</span><br></pre></td></tr></table></figure>

<p><strong>&#x4E3B;&#x6D41;&#x7A0B;&#x4EE3;&#x7801;</strong></p>
<p>&#x9996;&#x5148;&#x786E;&#x5B9A;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002; &#x9700;&#x8981;&#x79FB;&#x52A8;&#x5230;&#x9876;&#x90E8;&#x7684;&#x662F;&#x54EA;&#x4E2A;task&#xFF1F; &#x8FD9;&#x4E2A;task&#x6240;&#x5728;&#x7684;&#x662F;&#x5728;&#x54EA;&#x4E2A;task&#xFF1F; &#x8FD9;&#x91CC;&#x8BBE;&#x8BA1;&#x5230;&#x4E86;2&#x4E2A;task<br>&#x5728;ActivityStarter::startActivityInner&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x7684;&#x662F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;mTargetRootTask.getRootTask().moveToFront(&quot;reuseOrNewTask&quot;, targetTask);</span><br></pre></td></tr></table></figure>

<p>&#x5DF2;&#x77E5;mTargetRootTask&#x662F;&#x65B0;&#x521B;&#x5EFA;&#x7ED9;&#x201C;&#x7535;&#x8BDD;&#x201D;&#x7528;&#x7684;Task, mTargetRootTask.getRootTask()&#x80AF;&#x5B9A;&#x5C31;&#x662F;&#x8FD8;&#x662F;&#x672C;&#x8EAB;&#x3002;</p>
<p>tip &#xFF1A;getRootTask&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x9876;&#x90E8;&#x7684;Task, &#x5F53;&#x5929;Task&#x4E0A;&#x4E00;&#x5C42;&#x662F;TaskDisplayArea&#x7C7B;&#x578B; &#xFF08;name&#x4E3A;DefaultTaskDisplayArea&#xFF09;<br>&#x800C;mTargetRootTask.getParent&#x8FD4;&#x56DE;&#x7684;&#x7236;&#x5BB9;&#x5668;&#xFF0C;&#x5219;&#x662F; name&#x4E3A;DefaultTaskDisplayArea&#x7684;TaskDisplayArea&#x3002;<br>&#x5177;&#x4F53;&#x4E0D;&#x6DF1;&#x5165;&#xFF0C;&#x4EE5;&#x4E3B;&#x6D41;&#x7A0B;&#x4E3A;&#x4E3B;.&#x3002;</p>
<p><strong>&#x5230;&#x8FD9;&#x91CC;&#xFF0C;AMS&#x5DF2;&#x7ECF;&#x5C06;&#x9700;&#x8981;&#x7684;ActivityRecord&#x548C;Task&#x521B;&#x5EFA;&#x5E76;&#x4E14;&#x6302;&#x8F7D;&#x5230;&#x5C42;&#x7EA7;&#x6811;&#x4E2D;&#x63A5;&#x4E0B;&#x6765;&#x5C06;&#x662F;&#x9700;&#x8981;&#x5904;&#x7406;&#x65B0;&#x7684;Activity&#x542F;&#x52A8;&#x548C;&#x663E;&#x793A;&#x903B;&#x8F91;&#x4E86;</strong></p>
<h3 id="2-2-3-&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities"><a href="#2-2-3-&#x663E;&#x793A;Activity-resumeFocusedTasksTopActivities" class="headerlink" title="2.2.3 &#x663E;&#x793A;Activity resumeFocusedTasksTopActivities"></a>2.2.3 &#x663E;&#x793A;Activity resumeFocusedTasksTopActivities</h3><p>&#x7BC7;&#x5E45;&#x539F;&#x56E0;&#xFF0C;&#x540E;&#x7EED;&#x6D41;&#x7A0B;&#x5728;&#x4E0B;&#x4E00;&#x7BC7;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/0bf09f6e3ae2b1c7d20cfbb1c0be261d.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340197367515578378.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340197367515578378.html" itemprop="url">如果iconfont停止服务了，我们怎么办</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T09:50:36+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9d9b0890fa0fe742ad1771f22fea3001a66210f000e7b188489bfea67744a753" alt="&#x4E16;&#x754C;&#x6700;&#x5927;&#x7684;&#x65E0;&#x8F90;&#x6469;&#x5929;&#x8F6E;.webp"></p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x4E2A;&#x4EBA;&#x4E00;&#x76F4;&#x90FD;&#x6BD4;&#x8F83;&#x559C;&#x6B22;&#x963F;&#x91CC;&#x5927;&#x4F6C;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x4E9B;&#x7EC4;&#x4EF6;&#x670D;&#x52A1;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x53EA;&#x8BF4;&#x56FE;&#x6807;&#x7BA1;&#x7406;&#x5427;&#xFF0C;&#x6700;&#x5F00;&#x59CB;&#x7684;&#x65F6;&#x5019;&#x6211;&#x662F;&#x4F7F;&#x7528;&#x7684;<a href="/external_links/3d03404d59e5656529e414bbf80b04e4.html" target="blank" rel="noopener">icomoon.io</a> &#x540E;&#x9762;&#x53D1;&#x73B0;<a href="/external_links/14b9e6faed15376ced2bf66eed9a10f2.html" target="blank" rel="noopener">www.iconfont.cn/</a> &#x5728;&#x4EE5;&#x524D;&#x5F00;&#x53D1;&#x662F;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x4E3A;&#x4E86;&#x56FE;&#x7247;&#x7684;&#x8BF7;&#x6C42;&#x5C11;&#x70B9;&#xFF0C;&#x63D0;&#x5347;&#x7F51;&#x7AD9;&#x7684;&#x6027;&#x80FD;&#x4F1A;&#x628A;&#x8FD9;&#x4E9B;&#x5C0F;&#x56FE;&#x6807;&#x505A;&#x5230;&#x4E00;&#x5F20;&#x56FE;&#x4E0A;&#x9762;&#x4E13;&#x4E1A;&#x53EB;&#x6CD5;&#x662F;&#x96EA;&#x78A7;&#x56FE;&#xFF0C;&#x540E;&#x6765;&#x968F;&#x7740;&#x524D;&#x7AEF;&#x53D1;&#x5C55;&#x6709;&#x4E86;&#x5B57;&#x4F53;&#x56FE;&#x6807;&#xFF0C;&#x4E0D;&#x5570;&#x55E6;&#x4E86;&#x5427;&#xFF0C;&#x56DE;&#x5230;&#x6B63;&#x9898;&#xFF0C;&#x7531;&#x4E8E;&#x4E0A;&#x6B21;icofont&#x5B98;&#x7F51;&#x6302;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x7684;&#x9879;&#x76EE;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x6B63;&#x5E38;&#x8FED;&#x4EE3;&#xFF0C;&#x6211;&#x5C31;&#x51B3;&#x5B9A;&#x8981;&#x81EA;&#x5DF1;&#x5F04;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x56FE;&#x6807;&#x7BA1;&#x7406;&#x3002;</p>
<h2 id="&#x9700;&#x6C42;"><a href="#&#x9700;&#x6C42;" class="headerlink" title="&#x9700;&#x6C42;"></a>&#x9700;&#x6C42;</h2><p>&#x4E00;&#x822C;&#x4F7F;&#x7528;&#x9700;&#x8981;&#x7684;&#x662F;&#x628A;&#x8BBE;&#x8BA1;&#x505A;&#x597D;&#x7684;&#x56FE;&#x6807;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x4E0B;&#x8F7D;&#x7684;svg&#x56FE;&#x6807;&#x4E0A;&#x4F20;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#xFF0C;&#x5E76;&#x4E14;&#x6253;&#x5305;&#x6210;&#x4E00;&#x4E2A;js&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#x3002;</p>
<h2 id="&#x51C6;&#x5907;"><a href="#&#x51C6;&#x5907;" class="headerlink" title="&#x51C6;&#x5907;"></a>&#x51C6;&#x5907;</h2><p>&#x90FD;&#x8BF4;&#x5929;&#x4E0B;&#x6587;&#x7AE0;&#x4E00;&#x5927;&#x6284;&#xFF0C;&#x6211;&#x4E5F;&#x662F;&#x53BB;&#x6284;iconfont,&#x6211;&#x628A;iconfont&#x7684;&#x4F7F;&#x7528;demo&#x6253;&#x5F00;&#x7814;&#x7A76;&#x4E86;&#x4E00;&#x4E0B;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/0f739810422d023d39af2170d02b486277da490fb604be02c0a11f6664cc2e2b" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2795407031b00527c974856d8311a823f66914cae4ccaf6845349f6f22c44112" alt="image.png"></p>
<p>&#x6211;&#x8FD9;&#x91CC;&#x53EA;&#x8BF4;Symbol&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;&#x770B;&#x5230;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5F15;&#x5165;./iconfont.js</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a9ebcba6c0a3ac94fcdf9f6fbb8f5cfc234b3444f02419bb5c733f22d2763812" alt="image.png"></p>
<p>iconfont&#x628A;&#x6211;&#x4EEC;&#x4E0A;&#x4F20;&#x7684;&#x56FE;&#x6807;&#x8FDB;&#x884C;&#x4E86;&#x5220;&#x51CF;&#x4F18;&#x5316;,&#x6700;&#x5916;&#x5C42;&#x5C31;&#x4E00;&#x4E2A;svg&#x6807;&#x7B7E;&#x91CC;&#x9762;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;symbol&#x6807;&#x7B7E;&#x6765;&#x5305;&#x88F9;&#x4E4B;&#x524D;&#x7684;&#x56FE;&#x6807;&#x5185;&#x5BB9;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;symbol&#x7684;id&#x90FD;&#x5BF9;&#x5E94;&#x4E4B;&#x524D;&#x7684;svg&#x56FE;&#x6807;&#x540D;&#x79F0;&#x3002;</p>
<blockquote>
<p>iconfont&#x4E5F;&#x6CA1;&#x6709;&#x5F00;&#x6E90;,&#x5177;&#x4F53;&#x600E;&#x4E48;&#x505A;&#x7684;&#x54B1;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#xFF0C;&#x53EA;&#x80FD;&#x77E5;&#x9053;&#x76EE;&#x524D;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4E86;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x6309;&#x7167;&#x81EA;&#x5DF1;&#x7406;&#x89E3;&#x5F00;&#x59CB;&#x5F00;&#x53D1;&#x5B9E;&#x73B0;&#x4E86;</p>
</blockquote>
<h2 id="&#x524D;&#x7AEF;&#x5F00;&#x53D1;"><a href="#&#x524D;&#x7AEF;&#x5F00;&#x53D1;" class="headerlink" title="&#x524D;&#x7AEF;&#x5F00;&#x53D1;"></a>&#x524D;&#x7AEF;&#x5F00;&#x53D1;</h2><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x524D;&#x7AEF;&#x9700;&#x8981;&#x7684;&#x662F;&#x628A;&#x8BBE;&#x8BA1;&#x7A3F;&#x7684;svg&#x56FE;&#x53D8;&#x6210;symbol&#x91CC;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6253;&#x5F00;svg&#x56FE;<br>&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x6D4B;&#x8BD5;&#x4E0B;&#xFF0C;&#x76F4;&#x63A5;&#x628A;&#x5185;&#x5BB9;&#x590D;&#x5236;&#x7136;&#x540E;&#x7C98;&#x8D34;&#x5E26;&#x4E86;iconfont.js&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x8FD0;&#x884C;demo&#x56FE;&#x6807;&#x6B63;&#x5E38;&#x663E;&#x793A;&#x5C31;&#x8BF4;&#x660E;&#x662F;ok&#x7684;&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x505A;&#x662F;&#x4E0D;&#x884C;&#x7684;&#x3002;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/251bbeaed0fbe470cd8e42560c67f28672aa99c558cf00c745c04ae00e7e4754" alt="image.png"></p>
<p>&#x901A;&#x8FC7;&#x56FE;&#x7247;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x73B0;&#x5728;&#x9700;&#x8981;&#x7684;&#x5C31;&#x662F;&#x628A;svg&#x91CC;&#x9762;&#x7684;path&#x6539;&#x6210;&#x7528;symblo&#x6765;&#x5305;&#x88F9;&#xFF0C;&#x5728;&#x5F00;&#x53D1;&#x4E2D;svg&#x56FE;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7;&#x6587;&#x6863;&#x6D41;&#x4E0A;&#x4F20;&#x4E0A;&#x6765;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x5BF9;&#x6587;&#x6863;&#x6D41;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#xFF0C;&#x5148;&#x628A;&#x6587;&#x6863;&#x6D41;&#x53D8;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x7136;&#x540E;js&#x64CD;&#x4F5C;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FBE;&#x5230;&#x76EE;&#x7684;&#x3002;</p>
<ol>
<li>&#x4F7F;&#x7528;&#x5230;FileReader&#x548C;readAsText&#x83B7;&#x53D6;&#x5230;&#x5B57;&#x7B26;&#x4E32;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801; const fileParse = (file) =&gt; {</span><br><span class="line">   return new Promise((resolve) =&gt; {</span><br><span class="line">     const fileReader = new FileReader();</span><br><span class="line">     fileReader.readAsText(file, &quot;UTF-8&quot;);</span><br><span class="line">     fileReader.onload = (e) =&gt; {</span><br><span class="line">       resolve({ content: e.target?.result, name: file.name })</span><br><span class="line">     }</span><br><span class="line">   })</span><br><span class="line"> }</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x5B57;&#x7B26;&#x64CD;&#x4F5C;&#x62FC;&#x63A5;&#x6211;&#x4F7F;&#x7528;&#x7684;&#x662F;cheerio</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;  const handleUploadSvg = ($, result) =&gt; {</span><br><span class="line">    let index = result.indexOf(&apos;&lt;svg&apos;);</span><br><span class="line">    const str = result.slice(index);</span><br><span class="line">    const svgNode = $(str);</span><br><span class="line"></span><br><span class="line">    $(&apos;svg&apos;).attr(&apos;viewBox&apos;, svgNode.attr(&apos;viewBox&apos;));</span><br><span class="line">    const findPath = svgNode.find(&apos;path&apos;);</span><br><span class="line">    if (!findPath.length) {</span><br><span class="line">      message.error(&apos;&#x56FE;&#x6807;&#x9519;&#x8BEF;&#xFF0C;&#x4E0D;&#x5B58;&#x5728;path&apos;)</span><br><span class="line">      return &apos;&apos;;</span><br><span class="line">    };</span><br><span class="line">    findPath.each((i, el) =&gt; {</span><br><span class="line">      $(el).removeAttr(&apos;id&apos;);</span><br><span class="line">    });</span><br><span class="line">    const gDom = svgNode.find(&apos;g&apos;);</span><br><span class="line"></span><br><span class="line">    gDom.each((i, el) =&gt; {</span><br><span class="line">      const path = $(el).children(&apos;path&apos;);</span><br><span class="line">      const fill = $(el).attr(&apos;fill&apos;);</span><br><span class="line">      if (fill &amp;&amp; fill !== &apos;none&apos; &amp;&amp; path.length &amp;&amp; !$(path[0])?.attr?.(&apos;fill&apos;)) {</span><br><span class="line">        $(path[0])?.attr?.(&apos;fill&apos;, fill)</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">    removeArrtId($, gDom);</span><br><span class="line"></span><br><span class="line">    if (gDom.length) {</span><br><span class="line">      $(&apos;svg&apos;).html(svgNode.html());</span><br><span class="line">    } else {</span><br><span class="line">      $(&apos;svg&apos;).html(svgNode.find(&apos;path&apos;));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return $.html(&quot;svg&quot;)</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;svg&#x6E90;&#x7801;&#xFF0C;&#x56FE;&#x6807;&#x663E;&#x793A;&#x8FD8;&#x662F;flow</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1893028f19b515a865dfda14764f9ced0099b87b24c3376b98dd14e7ad136564" alt="image.png"></p>
<p>&#x7136;&#x540E;&#x6211;&#x628A;&#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x4F20;&#x9001;&#x7ED9;&#x540E;&#x7AEF;&#x5C31;&#x884C;&#x4E86;</p>
<h2 id="&#x540E;&#x7AEF;&#x5F00;&#x53D1;"><a href="#&#x540E;&#x7AEF;&#x5F00;&#x53D1;" class="headerlink" title="&#x540E;&#x7AEF;&#x5F00;&#x53D1;"></a>&#x540E;&#x7AEF;&#x5F00;&#x53D1;</h2><p>&#x540E;&#x7AEF;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x628A;&#x6211;&#x4E0A;&#x4F20;&#x4E0A;&#x6765;&#x7684;svg&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x5230;&#x4E00;&#x8D77;&#xFF0C;&#x7136;&#x540E;&#x4EE5;iconfont.js&#x4E00;&#x6837;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;get&#x63A5;&#x53E3;&#x8FD4;&#x56DE;&#x7ED9;&#x6211;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;,<br>&#x901A;&#x8FC7;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x5C31;&#x8BF4;&#x660E;ok&#x4E86;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/361da9b48b1dd012185535ee3877e20fdb975f7811e33a439b207bf83ed8dc3c" alt="image.png"></p>
<p>&#x5176;&#x4ED6;&#x4E24;&#x79CD;&#x9700;&#x8981;&#x7528;&#x5230;&#x4E9B;&#x7B2C;&#x4E09;&#x65B9;&#x5E93;&#x5F53;&#x65F6;&#x4E5F;&#x6709;&#x987A;&#x4FBF;&#x7814;&#x7A76;&#x770B;&#x5230;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x9700;&#x8981;&#x6211;&#x518D;&#x5199;&#x4E00;&#x7BC7;&#x3002;</p>
<p>&#x6587;&#x7AE0;&#x4E2D;&#x4F1A;&#x6709;&#x4E9B;&#x4E0D;&#x600E;&#x4E48;&#x6E05;&#x6670;&#x6216;&#x8005;&#x6709;&#x95EE;&#x9898;&#x7684;&#x5730;&#x65B9;&#x8FD8;&#x671B;&#x5404;&#x4F4D;&#x5927;&#x4F6C;&#x89C1;&#x8C05;&#xFF0C;&#x521A;&#x521A;&#x5F00;&#x59CB;&#x51B3;&#x5B9A;&#x5199;&#x4E00;&#x4E9B;&#x6280;&#x672F;&#x76F8;&#x5173;&#x6587;&#x7AE0;&#xFF0C;&#x8FD8;&#x5F88;&#x751F;&#x758F;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/a8b7cc75dbc41fafcd798693371e5fc9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340197367515414538.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340197367515414538.html" itemprop="url">零基础入门AI：一键本地运行各种开源大语言模型 - Olla</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T09:33:08+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x4EC0;&#x4E48;&#x662F;-Ollama&#xFF1F;"><a href="#&#x4EC0;&#x4E48;&#x662F;-Ollama&#xFF1F;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F; Ollama&#xFF1F;"></a>&#x4EC0;&#x4E48;&#x662F; Ollama&#xFF1F;</h1><p>Ollama &#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x5730;&#x90E8;&#x7F72;&#x548C;&#x7BA1;&#x7406;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x7531;&#x4E8E;&#x5B83;&#x6781;&#x5927;&#x7684;&#x7B80;&#x5316;&#x4E86;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#x7EC6;&#x8282;&#xFF0C;&#x4E00;&#x7ECF;&#x63A8;&#x51FA;&#x5C31;&#x5E7F;&#x53D7;&#x597D;&#x8BC4;&#xFF0C;&#x76EE;&#x524D;&#x5DF2;&#x5728;github&#x4E0A;&#x83B7;&#x5F97;&#x4E86;46k star&#x3002;</p>
<p>&#x4E0D;&#x7BA1;&#x662F;&#x8457;&#x540D;&#x7684;&#x7F8A;&#x9A7C;&#x7CFB;&#x5217;&#xFF0C;&#x8FD8;&#x662F;&#x6700;&#x65B0;&#x7684;AI&#x65B0;&#x8D35;Mistral&#xFF0C;&#x7B49;&#x7B49;&#x5404;&#x79CD;&#x5F00;&#x6E90;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x90FD;&#x53EF;&#x4EE5;&#x7528;Ollama&#x5B9E;&#x73B0;&#x4E00;&#x952E;&#x5B89;&#x88C5;&#x5E76;&#x8FD0;&#x884C;&#xFF0C;&#x652F;&#x6301;&#x7684;&#x66F4;&#x591A;&#x6A21;&#x578B;&#x7684;&#x5217;&#x8868;&#x53EF;&#x4EE5;&#x67E5;&#x770B;Ollama&#x5B98;&#x7F51;&#x3002;</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Parameters</th>
<th>Size</th>
<th>Download</th>
</tr>
</thead>
<tbody><tr>
<td>Llama 2</td>
<td>7B</td>
<td>3.8GB</td>
<td><code>ollama run llama2</code></td>
</tr>
<tr>
<td>Mistral</td>
<td>7B</td>
<td>4.1GB</td>
<td><code>ollama run mistral</code></td>
</tr>
</tbody></table>
<p>&#x672C;&#x6587;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x5165;&#x95E8;Ollama&#x3002;</p>
<h1 id="&#x5982;&#x4F55;&#x5B89;&#x88C5;-Ollama&#x6846;&#x67B6;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x5B89;&#x88C5;-Ollama&#x6846;&#x67B6;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x5B89;&#x88C5; Ollama&#x6846;&#x67B6;&#xFF1F;"></a>&#x5982;&#x4F55;&#x5B89;&#x88C5; Ollama&#x6846;&#x67B6;&#xFF1F;</h1><p>Ollama&#x652F;&#x6301;&#x5404;&#x4E2A;&#x5E73;&#x53F0;&#xFF1A;Mac&#x3001;Windows &#x548C; Linux&#xFF0C;&#x4E5F;&#x63D0;&#x4F9B;&#x4E86;docker image&#x3002;<br>&#x5728;Ollama&#x5B98;&#x7F51;&#x6216;&#x8005;Github&#x53EF;&#x4EE5;&#x4E0B;&#x8F7D;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x952E;&#x5B89;&#x88C5;Ollama&#x6846;&#x67B6;&#xFF1A;</p>
<ul>
<li><a href="/external_links/234177bbf722239043d3336e8c156bfe.html" target="blank" rel="noopener">macOS</a></li>
<li><a href="/external_links/923a8018b1049b9d03e348d8b242f346.html" target="blank" rel="noopener">Windows</a></li>
<li>Linux: <code>curl -fsSL https://ollama.com/install.sh | sh</code></li>
</ul>
<p>&#x7531;&#x4E8E;Ollama&#x521A;&#x652F;&#x6301;windows&#x4E0D;&#x4E45;&#xFF0C;&#x5728;windows&#x4E0A;&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x8FD8;&#x4E0D;&#x591F;&#x5B8C;&#x5584;&#xFF0C;&#x4EE5;&#x4E0B;&#x6211;&#x5C06;&#x4E3B;&#x8981;&#x4EE5;Linux&#x4E0A;&#x8FD0;&#x884C;Ollama&#x6765;&#x4E3E;&#x4F8B;&#x8BF4;&#x660E;&#x3002;</p>
<h1 id="&#x8FD0;&#x884C;-Ollama-&#x670D;&#x52A1;"><a href="#&#x8FD0;&#x884C;-Ollama-&#x670D;&#x52A1;" class="headerlink" title="&#x8FD0;&#x884C; Ollama &#x670D;&#x52A1;"></a>&#x8FD0;&#x884C; Ollama &#x670D;&#x52A1;</h1><p>&#x5728;Ollama&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C; &#x4E00;&#x822C;&#x4F1A;&#x81EA;&#x52A8;&#x542F;&#x52A8; Ollama &#x670D;&#x52A1;&#xFF0C;&#x800C;&#x4E14;&#x4F1A;&#x81EA;&#x52A8;&#x8BBE;&#x7F6E;&#x4E3A;&#x5F00;&#x673A;&#x81EA;&#x542F;&#x52A8;&#x3002;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x662F;&#x5426;Ollama&#x662F;&#x5426;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#x3002;&#x5982;&#x4E0B;&#x4F8B;&#x5B50;&#x4E2D;&#x663E;&#x793A;&#x201C;Active: active (running)&#x201D;&#x8868;&#x793A;Ollama&#x5DF2;&#x7ECF;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;$ systemctl status ollama</span><br><span class="line">&#x25CF; ollama.service - Ollama Service</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/ollama.service; enabled; vendor preset: enabled)</span><br><span class="line">    Drop-In: /etc/systemd/system/ollama.service.d</span><br><span class="line">             &#x2514;&#x2500;environment.conf</span><br><span class="line">     Active: active (running) since Thu 2024-03-07 09:09:39 HKT; 4 days ago</span><br><span class="line">   Main PID: 19975 (ollama)</span><br><span class="line">      Tasks: 29 (limit: 69456)</span><br><span class="line">     Memory: 1.1G</span><br><span class="line">        CPU: 14min 44.702s</span><br><span class="line">     CGroup: /system.slice/ollama.service</span><br><span class="line">             &#x2514;&#x2500;19975 /usr/local/bin/ollama serve</span><br></pre></td></tr></table></figure>

<p>&#x5728;Linux&#x4E0A;&#xFF0C;&#x5982;&#x679C;Ollama&#x672A;&#x542F;&#x52A8;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x542F;&#x52A8; Ollama &#x670D;&#x52A1;&#xFF1A;<code>ollama serve</code>&#xFF0C;&#x6216;&#x8005; <code>sudo systemctl start ollama</code>&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x5206;&#x6790;Linux&#x7684;&#x5B89;&#x88C5;&#x811A;&#x672C;install.sh&#xFF0C;&#x5C31;&#x4F1A;&#x770B;&#x5230;&#x5176;&#x4E2D;&#x5DF2;&#x7ECF;&#x5C06;<code>ollama serve</code>&#x914D;&#x7F6E;&#x4E3A;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x670D;&#x52A1;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>systemctl</code>&#x6765; start / stop ollama&#x8FDB;&#x7A0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    status &quot;Creating ollama systemd service...&quot;</span><br><span class="line">    cat &lt;&lt;EOF | $SUDO tee /etc/systemd/system/ollama.service &gt;/dev/null</span><br><span class="line">[Unit]</span><br><span class="line">Description=Ollama Service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=$BINDIR/ollama serve</span><br><span class="line">User=ollama</span><br><span class="line">Group=ollama</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=3</span><br><span class="line">Environment=&quot;PATH=$PATH&quot;</span><br></pre></td></tr></table></figure>

<p>&#x542F;&#x52A8;Ollama&#x670D;&#x52A1;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5F53;&#x524D;&#x7684;Ollama&#x7248;&#x672C;&#xFF0C;&#x4EE5;&#x53CA;&#x5E38;&#x7528;&#x547D;&#x4EE4;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;~$ ollama -v</span><br><span class="line">ollama version is 0.1.20</span><br><span class="line">~$ ollama --help</span><br><span class="line">Large language model runner</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  ollama [flags]</span><br><span class="line">  ollama [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  serve       Start ollama</span><br><span class="line">  create      Create a model from a Modelfile</span><br><span class="line">  show        Show information for a model</span><br><span class="line">  run         Run a model</span><br><span class="line">  pull        Pull a model from a registry</span><br><span class="line">  push        Push a model to a registry</span><br><span class="line">  list        List models</span><br><span class="line">  cp          Copy a model</span><br><span class="line">  rm          Remove a model</span><br><span class="line">  help        Help about any command</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help      help for ollama</span><br><span class="line">  -v, --version   Show version information</span><br><span class="line"></span><br><span class="line">Use &quot;ollama [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure>

<h1 id="&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;"></a>&#x5982;&#x4F55;&#x4E0B;&#x8F7D;&#x5E76;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF1F;</h1><p>&#x81F3;&#x6B64;&#xFF0C;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;Ollama&#x6846;&#x67B6;&#x7684;&#x5B89;&#x88C5;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x4E00;&#x6761;&#x547D;&#x4EE4;&#x5728;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;&#x4EE5;&#x8457;&#x540D;&#x7684;&#x7F8A;&#x9A7C;&#x4E3E;&#x4F8B;&#xFF1A;<code>ollama run llama2</code>&#x3002;</p>
<p>&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x4E0B;&#x8F7D;&#x8FC7;&#x6307;&#x5B9A;&#x7684;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#xFF0C;&#x8FD9;&#x6761;&#x547D;&#x4EE4;&#x5C06;&#x4F1A;&#x5148;&#x6267;&#x884C;<code>ollama pull llama2</code>&#xFF0C;&#x5C06;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;&#xFF0C;&#x518D;&#x5728;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x3002;</p>
<p>&#x4E0B;&#x8F7D;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x8FD0;&#x884C;&#x6548;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ ollama run llama2</span><br><span class="line">&gt;&gt;&gt; who are you?</span><br><span class="line"></span><br><span class="line">I am LLaMA, an AI assistant developed by Meta AI that can understand and respond to human input in a conversational manner. I am trained on a massive dataset of text from the internet and can </span><br><span class="line">generate human-like responses to a wide range of topics and questions. I can be used to create chatbots, virtual assistants, and other applications that require natural language understanding and</span><br><span class="line">generation capabilities.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Send a message (/? for help)</span><br></pre></td></tr></table></figure>

<h1 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h1><p>Ollama&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;API&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;curl http://localhost:11434/api/generate -d &apos;{</span><br><span class="line">  &quot;model&quot;: &quot;llama2&quot;,</span><br><span class="line">  &quot;prompt&quot;:&quot;Why is the sky blue?&quot;,</span><br><span class="line">  &quot;stream&quot;: false</span><br><span class="line">}&apos;</span><br></pre></td></tr></table></figure>

<p>&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;{</span><br><span class="line">    &quot;model&quot;: &quot;llama2&quot;,</span><br><span class="line">    &quot;created_at&quot;: &quot;2024-02-26T04:35:10.787352404Z&quot;,</span><br><span class="line">    &quot;response&quot;: &quot;The sky appears blue because of a phenomenon called Rayleigh scattering, which occurs when sunlight enters Earth&apos;s atmosphere. The sunlight encounters tiny molecules of gases such as nitrogen and oxygen, which scatter the light in all directions. The shorter wavelengths of light, such as blue and violet, are scattered more than the longer wavelengths, such as red and orange. This is known as Rayleigh scattering, named after Lord Rayleigh, who first described the phenomenon in the late 19th century. As a result of this scattering, the light that reaches our eyes from the sun appears blue, especially when viewed from a distance. The closer we get to the horizon, the more the blue color appears to fade, as the light has to travel through more of the atmosphere, which scatters the shorter wavelengths even more. It&apos;s worth noting that the exact shade of blue can vary depending on the time of day and atmospheric conditions. For example, during sunrise and sunset, when the sun is low in the sky, the sky can take on a more orange or red hue due to the scattering of light by atmospheric particles. So, to summarize, the sky appears blue because of the way light interacts with the tiny molecules of gases in Earth&apos;s atmosphere, particularly nitrogen and oxygen.&quot;,</span><br><span class="line">    &quot;done&quot;: true,</span><br><span class="line">    &quot;total_duration&quot;: 7001870820,</span><br><span class="line">    &quot;load_duration&quot;: 4930376,</span><br><span class="line">    &quot;prompt_eval_duration&quot;: 60907000,</span><br><span class="line">    &quot;eval_count&quot;: 309,</span><br><span class="line">    &quot;eval_duration&quot;: 6931593000</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4F7F;&#x7528;API&#x63A5;&#x53E3;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x66F4;&#x591A;&#x7075;&#x6D3B;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6BD4;&#x5982;&#x4E0E;IDE&#x63D2;&#x4EF6;&#x914D;&#x5408;&#xFF0C;&#x5B9E;&#x73B0;&#x672C;&#x5730;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;&#xFF0C;&#x53EF;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#x6587;&#x7AE0;&#xFF1A;<br><a href="https://dev.newban.cn/7340461584643112971">&#x96F6;&#x57FA;&#x7840;&#x5165;&#x95E8;AI&#xFF1A;&#x642D;&#x5EFA;&#x672C;&#x5730;&#x7684;&#x7F16;&#x7A0B;&#x52A9;&#x624B;</a></p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;"></a>&#x5982;&#x4F55;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x7684;&#x65E5;&#x5FD7;&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x8FD0;&#x884C;&#x547D;&#x4EE4;<code>journalctl -u ollama</code>&#xFF0C;&#x5373;&#x53EF;&#x67E5;&#x770B;&#x8FD0;&#x884C;&#x65E5;&#x5FD7;&#x3002;</p>
<h2 id="&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;"></a>&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x5927;&#x6A21;&#x578B;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF; <code>OLLAMA_HOST</code> &#x6765;&#x6307;&#x5B9A;&#x5BF9;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=OLLAMA_HOST=0.0.0.0:11434</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x6B64;&#x914D;&#x7F6E;&#x540E;&#xFF0C;&#x5373;&#x53EF;&#x7531;&#x4E00;&#x53F0;GPU&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x672C;&#x5730;&#x5C40;&#x57DF;&#x7F51;&#x63D0;&#x4F9B;&#x5927;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684;&#x670D;&#x52A1;&#x3002;</p>
<h2 id="&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;"><a href="#&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;" class="headerlink" title="&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;"></a>&#x672C;&#x5730;&#x6709;&#x591A;&#x5F20;GPU&#xFF0C;&#x5982;&#x4F55;&#x7528;&#x6307;&#x5B9A;&#x7684;GPU&#x6765;&#x8FD0;&#x884C;Ollama&#xFF1F;</h2><p>&#x5728;Linux&#x4E0A;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF; <code>CUDA_VISIBLE_DEVICES</code> &#x6765;&#x6307;&#x5B9A;&#x8FD0;&#x884C;Ollama&#x7684;GPU&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=CUDA_VISIBLE_DEVICES=1,2</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;"><a href="#&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;" class="headerlink" title="&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;"></a>&#x4E0B;&#x8F7D;&#x7684;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5728;&#x54EA;&#x4E2A;&#x8DEF;&#x5F84;&#xFF1F;</h2><p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>macOS: <code>~/.ollama/models</code></li>
<li>Linux: <code>/usr/share/ollama/.ollama/models</code></li>
<li>Windows: <code>C:\Users&lt;username&gt;.ollama\models</code></li>
</ul>
<h2 id="&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;"><a href="#&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;" class="headerlink" title="&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;"></a>&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x7684;&#x8DEF;&#x5F84;&#xFF1F;</h2><p>Linux&#x5E73;&#x53F0;&#x5B89;&#x88C5;Ollama&#x65F6;&#xFF0C;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x65F6;&#x4F1A;&#x521B;&#x5EFA;&#x7528;&#x6237;ollama&#xFF0C;&#x518D;&#x5C06;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5230;&#x8BE5;&#x7528;&#x6237;&#x7684;&#x76EE;&#x5F55;<code>/usr/share/ollama/.ollama/models</code>&#x3002;&#x4F46;&#x7531;&#x4E8E;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5F80;&#x5F80;&#x7279;&#x522B;&#x5927;&#xFF0C;&#x6709;&#x65F6;&#x9700;&#x8981;&#x5C06;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5230;&#x4E13;&#x95E8;&#x7684;&#x6570;&#x636E;&#x76D8;&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x7684;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#x3002;</p>
<p>&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x8BBE;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x201C;OLLAMA_MODELS&#x201D;&#xFF0C;&#x4F46;&#x6211;&#x5728;Linux&#x4E0A;&#x5C1D;&#x8BD5;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x6210;&#x529F;&#x3002;</p>
<p>&#x5206;&#x6790;Linux&#x7248;&#x7684;&#x5B89;&#x88C5;&#x811A;&#x672C;install.sh&#x540E;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x662F;&#x7531;&#x4E8E;&#x5176;&#x4E2D;&#x521B;&#x5EFA;&#x4E86;&#x7528;&#x6237;ollama&#x548C;&#x7528;&#x6237;&#x7EC4;ollama&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5927;&#x6A21;&#x578B;&#x5B58;&#x50A8;&#x5230;&#x4E86;&#x8BE5;&#x7528;&#x6237;&#x7684;&#x76EE;&#x5F55;<code>/usr/share/ollama/.ollama/models</code>&#xFF0C;&#x800C;&#x6211;&#x7684;&#x5E10;&#x6237;&#x5BF9;ollama&#x5E10;&#x6237;&#x7684;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#x5E76;&#x4E0D;&#x80FD;&#x751F;&#x6548;&#xFF0C;&#x5373;&#x4F7F;&#x6211;&#x518D;&#x624B;&#x52A8;&#x5C06;&#x6211;&#x7684;&#x5E10;&#x6237;&#x6DFB;&#x52A0;&#x8FDB;ollama&#x7528;&#x6237;&#x7EC4;&#xFF0C;&#x4E5F;&#x4ECD;&#x7136;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x6743;&#x9650;&#x95EE;&#x9898;&#xFF0C;&#x5BFC;&#x81F4;&#x5BF9;ollama&#x5E10;&#x6237;&#x7684;&#x76EE;&#x5F55;&#x64CD;&#x4F5C;&#x4E0D;&#x751F;&#x6548;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x65B0;&#x5EFA;&#x7684;ollama&#x5E10;&#x6237;&#x5E76;&#x6CA1;&#x6709;&#x7ED9;&#x6211;&#x5E26;&#x6765;&#x989D;&#x5916;&#x7684;&#x4FBF;&#x5229;&#xFF0C;&#x6700;&#x540E;&#x6211;&#x7528;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x6765;&#x5B9E;&#x73B0;&#x4FEE;&#x6539;&#x5927;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x7684;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF1A;</p>
<ol>
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x53D6;&#x6D88;&#x5176;&#x4E2D;&#x521B;&#x5EFA;&#x7528;&#x6237;ollama&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;# if ! id ollama &gt;/dev/null 2&gt;&amp;1; then </span><br><span class="line">    # status &quot;Creating ollama user...&quot; </span><br><span class="line">    # $SUDO useradd -r -s /bin/false -m -d /usr/share/ollama ollama </span><br><span class="line"># fi </span><br><span class="line"># status &quot;Adding current user to ollama group...&quot; </span><br><span class="line"># $SUDO usermod -a -G ollama $(whoami)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x4F7F;&#x7528;&#x6211;&#x7684;&#x5E10;&#x6237;&#x6765;&#x542F;&#x52A8;ollama&#x670D;&#x52A1;&#xFF0C;&#x53C2;&#x8003;&#x5982;&#x4E0B;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;    status &quot;Creating ollama systemd service...&quot;</span><br><span class="line">    cat &lt;&lt;EOF | $SUDO tee /etc/systemd/system/ollama.service &gt;/dev/null</span><br><span class="line">[Unit]</span><br><span class="line">Description=Ollama Service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=$BINDIR/ollama serve</span><br><span class="line">User=&lt;myusername&gt;</span><br><span class="line">Group=&lt;myusername&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>&#x4FEE;&#x6539;&#x5B89;&#x88C5;&#x6587;&#x4EF6; install.sh&#xFF0C;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x4E2D;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x53D8;&#x91CF;<code>OLLAMA_MODELS</code>&#x6307;&#x5B9A;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x7528;&#x6B64;&#x5B89;&#x88C5;&#x6587;&#x4EF6;&#x6765;&#x5B89;&#x88C5;ollama&#x3002;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;Environment=&quot;OLLAMA_MODELS=/home/paco/lab/LLM/ollama/OLLAMA_MODELS&quot;</span><br></pre></td></tr></table></figure>

<p>&#x6216;&#x8005;&#x5728;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x521B;&#x5EFA;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x914D;&#x7F6E;&#x73AF;&#x5883;&#x53D8;&#x91CF;<code>OLLAMA_MODELS</code>&#x6765;&#x6307;&#x5B9A;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;&#xFF0C;&#x518D;&#x91CD;&#x542F;Ollama&#x670D;&#x52A1;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;:~$ cat /etc/systemd/system/ollama.service.d/environment.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=OLLAMA_MODELS=&lt;path&gt;/OLLAMA_MODELS</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/62d4adc0d7ba6b2eb79e434743543698.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7340127788053856293.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7340127788053856293.html" itemprop="url">工作三年，为什么你还不会排查堆外内存泄漏？（下） 一 排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-28T08:11:09+08:00">
                2024-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/2c38644c865fe641756f5619d34aecf0c274f90550996002372cae349c7aec77" alt="image.png"></p>
<blockquote>
<p>&#x1F448;&#x1F448;&#x1F448; <strong>&#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x5173;&#x6CE8;&#x54DF;</strong></p>
</blockquote>
<p>&#x672C;&#x6587;&#x662F;<a href="/external_links/b865190bf577074c796a70b00086c411.html" target="blank" rel="noopener">Java&#x6545;&#x969C;&#x6848;&#x4F8B;&#x5206;&#x6790;</a>&#x7684;&#x7B2C;&#x4E09;&#x7BC7;, &#x4E0A;&#x4E00;&#x7BC7;&#x4E2D;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86;&#x4E00;&#x4E2A;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x95EE;&#x9898;: <a href="https://dev.newban.cn/7338388292969283584">&#x5DE5;&#x4F5C;&#x4E09;&#x5E74;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F60;&#x8FD8;&#x4E0D;&#x4F1A;&#x6392;&#x67E5;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;(&#x4E0A;)&#xFF08;&#x6587;&#x672B;&#x9644;&#x8D60;&#x4E00;&#x4E2A;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x5DE5;&#x5177;&#xFF09; - &#x6398;&#x91D1; (juejin.cn)</a>(&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x91CC;&#x662F;&#x4F7F;&#x7528;NMT+PMAP&#x89E3;&#x51B3;&#x7684;&#x975E;Netty&#x9020;&#x6210;&#x7684;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;), &#x800C;&#x4ECA;&#x5929;&#x6211;&#x4EEC;&#x8981;&#x804A;&#x7684;&#x662F;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x4EE4;&#x4EBA;&#x5934;&#x75BC;&#x7684;&#x95EE;&#x9898;&#x2014;&#x2014;<strong>Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;</strong>&#x3002;&#x672C;&#x6587;&#x5C06;&#x5E26;&#x9886;&#x5927;&#x5BB6;&#x8DDF;&#x6211;&#x4E00;&#x8D77;&#x6392;&#x67E5;&#x7EBF;&#x4E0A;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x6848;&#x4F8B;, &#x5E76;&#x4E14;&#x6DF1;&#x5165;&#x4E86;&#x89E3;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#xFF0C;&#x6700;&#x540E;&#x63D0;&#x4F9B;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;<strong>&#x4E09;&#x4E2A;&#x5173;&#x952E;&#x6B65;&#x9AA4;</strong>&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x83B7;&#x5F97;&#x5BF9;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x7684;&#x6DF1;&#x523B;&#x7406;&#x89E3;&#xFF0C;&#x5E76;&#x5B66;&#x4F1A;&#x5982;&#x4F55;&#x6709;&#x6548;&#x5730;&#x9884;&#x9632;&#x548C;&#x89E3;&#x51B3;&#x53EF;&#x80FD;&#x7684;&#x6CC4;&#x6F0F;&#x95EE;&#x9898;.</p>
<p>&#x7ED3;&#x5408;&#x4E0A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;, &#x5982;&#x679C;&#x9762;&#x8BD5;&#x5B98;&#x518D;&#x95EE;&#x4F60;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x6392;&#x67E5;&#x601D;&#x8DEF;&#x4F60;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x56DE;&#x7B54;&#x4E86;&#x5427;&#x1F60C;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x770B;&#x5168;&#x6587;&#x4E5F;&#x6CA1;&#x5173;&#x7CFB;&#x54E6;, &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x7ED3;&#x5C3E;&#x90E8;&#x5206;, &#x6211;&#x5E2E;&#x4F60;&#x603B;&#x7ED3;&#x597D;&#x4E86;&#x1F576;.</p>
</blockquote>
<h1 id="&#x4E00;-&#x6392;&#x67E5;&#x8FC7;&#x7A0B;"><a href="#&#x4E00;-&#x6392;&#x67E5;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x4E00;. &#x6392;&#x67E5;&#x8FC7;&#x7A0B;"></a>&#x4E00;. &#x6392;&#x67E5;&#x8FC7;&#x7A0B;</h1><p>&#x8D77;&#x56E0;&#x662F;&#x534A;&#x591C;&#x63A5;&#x5230;&#x673A;&#x5668;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#x544A;&#x8B66;&#x7535;&#x8BDD;, &#x673A;&#x5668;&#x5B95;&#x673A;&#x1F623;&#xFF0C;&#x4E8E;&#x662F;&#x722C;&#x8D77;&#x6765;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x6392;&#x67E5;&#x8FC7;&#x7A0B;.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/a2452e898a7444bae0d1cedf5bca73aee387f5f0df1b5dce359653149e5b842e" alt="image.png"></p>
<h2 id="1-1-&#x521D;&#x6B65;&#x5B9A;&#x4F4D;"><a href="#1-1-&#x521D;&#x6B65;&#x5B9A;&#x4F4D;" class="headerlink" title="1.1 &#x521D;&#x6B65;&#x5B9A;&#x4F4D;"></a>1.1 &#x521D;&#x6B65;&#x5B9A;&#x4F4D;</h2><p>&#x521D;&#x6B65;&#x53D1;&#x73B0;&#x662F;&#x6211;&#x4EEC;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6240;&#x5728;&#x673A;&#x5668;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;&#xFF0C;&#x4E0A;&#x673A;&#x5668;&#x6392;&#x67E5;&#xFF0C;&#x53D1;&#x73B0;&#x65E5;&#x5FD7;&#x4E2D;&#x6709;&#x5927;&#x91CF;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. Enable advanced leak reporting to find out where the leak occurred. To enable advanced leak reporting, specify the JVM option &apos;-Dio.netty.leakDetectionLevel=advanced&apos; or call ResourceLeakDetector.setLevel()</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x67E5;&#x9605;&#x76F8;&#x5173;&#x6587;&#x6863;&#x548C;&#x6E90;&#x7801;&#xFF0C;&#x5F53;Netty&#x5206;&#x914D;&#x7684;<code>ByteBuf</code>&#x5728;GC&#x524D;&#x6CA1;&#x6709;&#x8C03;&#x7528;<code>release</code>&#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x8BB0;&#x5F55;&#x8FD9;&#x6761;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF0C;&#x8BF4;&#x660E;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x6CA1;&#x6709;&#x91CA;&#x653E;&#xFF0C;&#x4F46;&#x662F;&#x5355;&#x51ED;&#x8FD9;&#x6761;&#x8BB0;&#x5F55;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x5224;&#x65AD;&#x662F;&#x54EA;&#x91CC;&#x51FA;&#x4E86;&#x95EE;&#x9898;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x786E;&#x5B9A;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#x1F914;&#xFF1A;</p>
<p>1&#x3001;&#x8FD9;&#x4E9B;&#x6CC4;&#x6F0F;&#x7684;Buffer&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x5206;&#x914D;&#x7684;&#xFF1F;</p>
<p>2&#x3001;&#x8FD9;&#x4E2A;Buffer&#x6700;&#x540E;&#x662F;&#x8C01;&#x6301;&#x6709;&#x7684;&#xFF1F;</p>
<p>&#x6309;&#x7167;&#x4E0A;&#x9762;Netty&#x7ED9;&#x6211;&#x4EEC;&#x7684;&#x63D0;&#x793A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;<code>-Dio.netty.leakDetectionLevel=advanced</code>&#x53C2;&#x6570;&#xFF0C;Netty&#x9ED8;&#x8BA4;&#x7684;<code>io.netty.leakDetectionLevel</code>&#x53C2;&#x6570;&#x662F;<code>simple</code>&#xFF0C;&#x53EA;&#x80FD;&#x8F93;&#x51FA;&#x4E00;&#x6761;&#x7B80;&#x5355;&#x7684;&#x6CC4;&#x6F0F;&#x8BB0;&#x5F55;&#xFF0C;&#x800C;&#x8981;&#x8F93;&#x51FA;&#x66F4;&#x52A0;&#x8BE6;&#x7EC6;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x8C03;&#x6574;level&#x53C2;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6309;&#x7167;&#x63D0;&#x793A;&#x8BBE;&#x7F6E;&#x4E3A;<code>advanced</code>&#x4E0A;&#x7EBF;&#x540E;&#x540C;&#x65F6;&#x914D;&#x7F6E;&#x544A;&#x8B66;&#x7EE7;&#x7EED;&#x89C2;&#x5BDF;&#x3002;</p>
<h2 id="1-2-&#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;"><a href="#1-2-&#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;" class="headerlink" title="1.2 &#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;"></a>1.2 &#x6CC4;&#x6F0F;&#x5806;&#x6808;&#x5206;&#x6790;</h2><p>&#x679C;&#x4E0D;&#x5176;&#x7136;&#xFF0C;&#x8FC7;&#x4E86;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;&#x65E5;&#x5FD7;&#x91CC;&#x53C8;&#x51FA;&#x73B0;&#x4E86;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x6B21;&#x66F4;&#x52A0;&#x8BE6;&#x7EC6;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x5806;&#x6808;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;[ERROR] epollEventLoopGroup-3-20 - io.netty.util.ResourceLeakDetector : LEAK: ByteBuf.release() was not called before it&apos;s garbage-collected. See https://netty.io/wiki/reference-counted-objects.html for more information.</span><br><span class="line">Recent access records:</span><br><span class="line">#1:</span><br><span class="line">        io.netty.buffer.AdvancedLeakAwareByteBuf.readByte(AdvancedLeakAwareByteBuf.java:401)</span><br><span class="line">        com.dianping.cat.message.spi.codec.PlainTextMessageCodec$BufferHelper.read(PlainTextMessageCodec.java:485)</span><br><span class="line">        com.dianping.cat.message.spi.codec.PlainTextMessageCodec.decodeLine(PlainTextMessageCodec.java:184)</span><br><span class="line">        // ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)</span><br><span class="line">        io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)</span><br><span class="line">        io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">        io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">        java.lang.Thread.run(Thread.java:745)</span><br><span class="line">#2:</span><br><span class="line">        io.netty.buffer.AdvancedLeakAwareByteBuf.readByte(AdvancedLeakAwareByteBuf.java:401)</span><br><span class="line">        // ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">Created at:</span><br><span class="line">        io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:402)</span><br><span class="line">        io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:188)</span><br><span class="line">        io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:124)</span><br><span class="line">        io.netty.buffer.AbstractByteBuf.readBytes(AbstractByteBuf.java:871)</span><br><span class="line">        com.dianping.cat.analysis.TcpSocketReceiver$MessageDecoder.decode(TcpSocketReceiver.java:155)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:507)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:446)</span><br><span class="line">        io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276)</span><br><span class="line">		// ..&#x7701;&#x7565;&#x90E8;&#x5206;&#x8F93;&#x51FA;</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)</span><br><span class="line">        io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)</span><br><span class="line">        io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)</span><br><span class="line">        io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">        io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">        java.lang.Thread.run(Thread.java:745)</span><br><span class="line">: 3 leak records were discarded because they were duplicates</span><br><span class="line">: 337 leak records were discarded because the leak record count is targeted to 4. Use system property io.netty.leakDetection.targetRecords to increase the limit.</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E9B;&#x5806;&#x6808;&#x9664;&#x4E86;&#x6700;&#x8FD1;&#x7684;&#x8BBF;&#x95EE;&#x8BB0;&#x5F55;&#xFF0C;&#x8FD8;&#x6709;&#x5728;&#x54EA;&#x91CC;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;&#x8FD9;&#x4E0B;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;&#xFF1A;</p>
<p>1&#x3001;&#x8FD9;&#x4E9B;Buffer&#x662F;&#x7528;&#x6237;Java&#x5E94;&#x7528;&#x4E0A;&#x62A5;&#x7684;&#x57CB;&#x70B9;&#x6D88;&#x606F;&#x3002;</p>
<p>2&#x3001;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;Buffer&#x662F;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;Buffer&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E0B;&#x6211;&#x4EEC;&#x7684;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x5904;&#x7406;&#x7528;&#x6237;&#x57CB;&#x70B9;&#x7684;&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/cf76f0c2cc3bf24e85e5fcf498d05371f1d3665914d615de71aa78d401dc1b9b" alt="image.png"></p>
<p>Netty&#x8BB0;&#x5F55;&#x7684;&#x201C;&#x6CC4;&#x6F0F;&#x8BB0;&#x5F55;&#x201D;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7;ByteBuf&#x7684;read/write&#x7B49;&#x64CD;&#x4F5C;&#x8BB0;&#x5F55;&#x7684;, &#x6BD4;&#x5982;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public ByteBuf readBytes(ByteBuf dst, int dstIndex, int length) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak); // &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x5806;&#x6808;</span><br><span class="line">    return super.readBytes(dst, dstIndex, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(byte[] dst) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(byte[] dst, int dstIndex, int length) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst, dstIndex, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ByteBuf readBytes(ByteBuffer dst) {</span><br><span class="line">    recordLeakNonRefCountingOperation(leak);</span><br><span class="line">    return super.readBytes(dst);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4F46;&#x662F;&#x6839;&#x636E;&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x8FF0;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x89E3;&#x6790;ByteBuf&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x4F1A;&#x9001;&#x5230;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#xFF0C;&#x4F46;&#x662F;Netty&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x8FD8;&#x662F;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF01;&#x6240;&#x4EE5;&#x6CC4;&#x6F0F;<strong>&#x4E00;&#x5B9A;&#x53D1;&#x751F;&#x5728;&#x5B58;&#x50A8;&#x4E4B;&#x524D;&#xFF0C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x4E4B;&#x540E;</strong>&#xFF01;&#xFF08;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x53D1;&#x751F;&#x4E86;&#x67D0;&#x4E9B;&#x5F02;&#x5E38;&#x6CA1;&#x6709;<em>catch</em>&#x5BFC;&#x81F4;<em>ByteBuf</em>&#x6CA1;&#x6709;&#x88AB;&#x91CA;&#x653E;&#xFF09;.</p>
<p>&#x597D;&#xFF0C;&#x7F29;&#x5C0F;&#x8303;&#x56F4;&#x4E4B;&#x540E;&#x8BE5;&#x600E;&#x4E48;&#x786E;&#x5B9A;&#x7CBE;&#x786E;&#x4F4D;&#x7F6E;&#x8FDB;&#x884C;&#x6392;&#x67E5;&#x5462;&#xFF1F;</p>
<h2 id="1-3-&#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf-touch"><a href="#1-3-&#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf-touch" class="headerlink" title="1.3 &#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf.touch()"></a>1.3 &#x7CBE;&#x51C6;&#x5B9A;&#x4F4D;&#x6280;&#x5DE7;&#xFF1A;ByteBuf.touch()</h2><p>&#x8FD9;&#x5C31;&#x6709;&#x8BF7;ByteBuf&#x63D0;&#x4F9B;&#x7684;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;<code>touch()</code>&#x4E86;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public abstract ByteBuf touch();</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>touch</code>&#x4E2D;Netty&#x4E5F;&#x4F1A;&#x548C;read/write&#x4E00;&#x6837;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x7684;&#x5806;&#x6808;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5728;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x6CC4;&#x6F0F;&#x7684;&#x5730;&#x65B9;&#x52A0;&#x5165;<code>touch</code>&#x5C31;&#x80FD;&#x5728;Netty&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x4E2D;&#x770B;&#x5230;&#x8FD9;&#x4E2A;ByteBuf&#x6700;&#x540E;&#x662F;&#x5728;&#x54EA;&#x91CC;&#x5F15;&#x7528;&#x7684;, &#x5C31;&#x80FD;&#x89E3;&#x51B3;&#x4E86;&#xFF01;&#x95EE;&#x9898;&#x89E3;&#x51B3;&#x4E86;&#x5417;&#xFF1F; &#x5982;&#x89E3;&#xFF01;</p>
<p>&#x5B9E;&#x9645;&#x5206;&#x6790;&#x4EE3;&#x7801;&#x8DEF;&#x5F84;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5F88;&#x53EF;&#x7591;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF08;&#x65B9;&#x6CD5;&#x540D;&#x5C31;&#x53EB;<em>method</em>&#x5427;&#xFF09;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x52A0;&#x5165;&#x591A;&#x4E2A;<code>touch</code>&#xFF0C;&#x4F46;&#x8FD9;&#x6837;&#x5C31;&#x51FA;&#x73B0;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6700;&#x7EC8;&#x5728;Netty&#x65E5;&#x5FD7;&#x91CC;&#x663E;&#x793A;&#x7684;&#x5806;&#x6808;&#x9876;&#x5C42;&#x90FD;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x77E5;&#x9053;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x54EA;&#x4E00;&#x4E2A;<code>touch</code>&#x8F93;&#x51FA;&#x7684;&#xFF0C;&#x8BE5;&#x600E;&#x4E48;&#x533A;&#x5206;&#x5462;&#xFF1F;</p>
<p>&#x53D1;&#x73B0;<em>Netty</em>&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5E26;&#x53C2;&#x6570;&#x7684;<em>API</em>&#xFF0C;&#x8FD9;&#x4E2A;<em>API</em>&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public abstract ByteBuf touch(Object hint);</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7;&#x67E5;&#x9605;&#x6587;&#x6863;&#x548C;&#x6E90;&#x7801;&#xFF1A;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x80FD;&#x5728;Netty&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A;<code>hint.toString()</code>&#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x8C03;&#x7528;<code>buffer.touch(-5)</code>, &#x90A3;&#x4E48;Netty&#x8F93;&#x51FA;&#x7684;&#x65E5;&#x5FD7;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/98904bcae8a8f5de1e121d4907b671655c3bd0efe99941714c14f1258ad64575" alt="image.png"></p>
<p>&#x6211;&#x4EEC;&#x5728;method&#x65B9;&#x6CD5;&#x91CC;&#x7684;&#x5173;&#x952E;&#x5730;&#x65B9;&#x90FD;&#x52A0;&#x4E0A;<code>touch</code>&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x5730;&#x65B9;&#x7684;<code>hint</code>&#x90FD;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6700;&#x540E;&#x7EC8;&#x4E8E;&#x5B9A;&#x4F4D;&#x5230;&#x4E86;&#x539F;&#x56E0;&#xFF01;</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x539F;&#x56E0;&#x7684;&#x5927;&#x81F4;&#x63CF;&#x8FF0;&#xFF1A;</p>
<blockquote>
<p>&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6BCF;&#x4E2A;&#x5C0F;&#x65F6;&#x4F1A;&#x505C;&#x6B62;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#xFF08;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;&#x72B6;&#x6001;&#x4E3A;disable&#xFF09;&#x548C;&#x961F;&#x5217;&#xFF0C;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x548C;&#x961F;&#x5217;&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5728;&#x653E;&#x5165;&#x961F;&#x5217;&#x65F6;<strong>&#x6CA1;&#x6709;&#x5224;&#x65AD;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x7EBF;&#x7A0B;&#x72B6;&#x6001;</strong>&#xFF0C;&#x6BCF;&#x4E2A;&#x5C0F;&#x65F6;&#x521D;&#x653E;&#x5165;&#x961F;&#x5217;&#x7684;ByteBuf&#x6CA1;&#x6709;&#x88AB;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#xFF0C;&#x6700;&#x540E;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF01;</p>
</blockquote>
<p>&#x8FD9;&#x6B21;&#x7ED9;&#x4E86;&#x6211;&#x4EEC;&#x4E00;&#x4E2A;&#x4E0D;&#x5C0F;&#x7684;&#x6559;&#x8BAD;, &#x90A3;&#x4E48;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x4E0B;&#x6B21;&#x518D;&#x51FA;&#x73B0;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;, &#x6211;&#x540E;&#x9762;&#x7ED9;&#x51FA;&#x4E86;&#x4E00;&#x4E9B;&#x5EFA;&#x8BAE;&#x548C;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/e63c8d333cca6c938782a21c1da6637e91bca9391b3f88fdd47418d91ba1d460" alt="image.png"></p>
<h1 id="&#x4E8C;-&#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;"><a href="#&#x4E8C;-&#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;" class="headerlink" title="&#x4E8C;. &#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;"></a>&#x4E8C;. &#x5982;&#x4F55;&#x66F4;&#x597D;&#x7684;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#xFF1F;</h1><p>&#x8FD9;&#x4E00;&#x8282;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x8BB2;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x6B63;&#x786E;&#x7684;&#x7F16;&#x7801;&#x907F;&#x514D;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;, &#x4F46;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x8981;&#x5F04;&#x6E05;&#x695A;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;, &#x4E86;&#x89E3;&#x5B83;&#x7684;&#x5E95;&#x5C42;&#x539F;&#x7406;, &#x7136;&#x540E;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x5DE5;&#x7A0B;&#x4E2D;&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x6765;&#x964D;&#x4F4E;&#x6CC4;&#x6F0F;&#x7684;&#x53EF;&#x80FD;&#x6027;.</p>
<h2 id="2-1-Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;"><a href="#2-1-Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;" class="headerlink" title="2.1 Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;"></a>2.1 Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6CC4;&#x6F0F;&#xFF1F;</h2><p>Netty&#x521B;&#x5EFA;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x57FA;&#x4E8E;JDK&#x539F;&#x751F;&#x7684;<code>DirectByteBuffer</code>&#x5B9E;&#x73B0;&#xFF0C;&#x5728;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>&#x65F6;&#x80FD;&#x591F;&#x6307;&#x5B9A;&#x662F;&#x5426;&#x4F7F;&#x7528;&#x5E26;<code>Cleaner</code>&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x6307;&#x5B9A;<code>Cleaner</code>&#x7684;&#x8BDD;&#x80FD;&#x5728;&#x81EA;&#x8EAB;&#x88AB;&#x56DE;&#x6536;&#x65F6;&#x91CA;&#x653E;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x5728;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#x901A;&#x8FC7;&#x521B;&#x5EFA;<code>Cleaner</code>&#x5BF9;&#x8C61;&#x2014;&#x2014;&#x4E00;&#x4E2A;&#x865A;&#x5F15;&#x7528;&#x5BF9;&#x8C61;<code>PhantomReference</code>&#xFF0C;&#x5728;<code>DirectByteBuffer</code>&#x88AB;GC&#x65F6;&#xFF0C;<code>ReferenceHandler</code>&#x7EBF;&#x7A0B;&#x4F1A;&#x5BF9;<code>jdk.internal.ref.Cleaner</code>&#x5BF9;&#x8C61;&#x4E13;&#x95E8;&#x5904;&#x7406;&#xFF0C;&#x8C03;&#x7528;&#x5B83;&#x7684;clean&#x65B9;&#x6CD5;&#x91CA;&#x653E;&#x5185;&#x5B58;&#x3002;</p>
<p>&#x4F46;&#x662F;Netty&#x521B;&#x5EFA;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x7684;&#x662F;<code>noCleaner</code>&#x7B56;&#x7565;&#xFF0C;&#x5373;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x4E0D;&#x542B;<code>Cleaner</code>&#x7684;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x662F;&#xFF1A;</p>
<ul>
<li>&#x8981;&#x89E6;&#x53D1;Cleaner&#x7684;&#x89E6;&#x53D1;&#x5FC5;&#x987B;&#x8981;&#x7B49;Buffer&#x88AB;GC,&#x8FD9;&#x4E2A;&#x662F;&#x4E0D;&#x53EF;&#x63A7;&#x7684;.</li>
<li>&#x5728;&#x4F7F;&#x7528;Cleaner&#x7684;&#x6784;&#x9020;&#x5668;&#x91CC;,&#x5982;&#x679C;&#x5185;&#x5B58;&#x4E0D;&#x8DB3;,&#x4F1A;&#x8C03;&#x7528;<code>System.gc()</code>&#x65B9;&#x6CD5;&#x4E3B;&#x52A8;&#x89E6;&#x53D1;GC,&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4F1A;&#x9020;&#x6210;&#x6027;&#x80FD;&#x95EE;&#x9898;.</li>
</ul>
<p>&#x56E0;&#x6B64;&#x5728;&#x5927;&#x90E8;&#x5206;&#x60C5;&#x51B5;&#x4E0B;(&#x81F3;&#x5C11;&#x5728;OpenJDK&#x91CC;)Netty&#x4F1A;&#x4F7F;&#x7528;noCleaner&#x7B56;&#x7565;&#x521B;&#x5EFA;<code>DirectByteBuffer</code>, &#x6240;&#x4EE5;Netty&#x56DE;&#x6536;Buffer&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x901A;&#x8FC7;&#x4E3B;&#x52A8;release&#x91CA;&#x653E;&#x7684;, &#x800C;<strong>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6B63;&#x786E;release&#x5C31;&#x4F1A;&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;</strong>. &#x4F46;&#x5E76;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;release&#x90FD;&#x4F1A;&#x771F;&#x6B63;&#x91CA;&#x653E;, &#x5177;&#x4F53;&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;&#x548C;&#x5F15;&#x7528;&#x5B83;&#x7684;&#x8BA1;&#x6570;&#x6709;&#x5173;, &#x56E0;&#x4E3A;<strong>Netty&#x662F;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x7BA1;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;</strong>, &#x800C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x63A2;&#x8BA8;&#x5F15;&#x7528;&#x8BA1;&#x6570;.</p>
<h2 id="2-2-ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;"><a href="#2-2-ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;" class="headerlink" title="2.2 ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;"></a>2.2 ByteBuf&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#x2013;&#x5F15;&#x7528;&#x8BA1;&#x6570;</h2><p>Netty&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x7BA1;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4F7F;&#x7528;&#x5B8C;&#x6210;&#x4E86;&#x4E4B;&#x540E;&#x8981;&#x628A;&#x5B83;&#x5F52;&#x8FD8;&#x7ED9;&#x6C60;&#x5B50;&#xFF08;&#x6216;&#x8005;allocator&#xFF09;&#x3002;ByteBuf&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6700;&#x597D;&#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<p>&#x521D;&#x59CB;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1&#xFF0C;&#x5F53;&#x8C03;&#x7528;<code>release</code>&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8BA1;&#x6570;&#x51CF;&#x4E00;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x521D;&#x59CB;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1</span><br><span class="line">ByteBuf buf = ctx.alloc().directBuffer();</span><br><span class="line">assert buf.refCnt() == 1;</span><br><span class="line"></span><br><span class="line">// &#x5F53;&#x8C03;&#x7528;release&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8BA1;&#x6570;&#x51CF;&#x4E00;</span><br><span class="line">boolean destroyed = buf.release();</span><br><span class="line">assert destroyed;</span><br><span class="line">assert buf.refCnt() == 0;</span><br></pre></td></tr></table></figure>

<p><strong>&#x5F53;&#x8BA1;&#x6570;&#x5230;0&#x65F6;&#xFF0C;<code>release</code>&#x65B9;&#x6CD5;&#x4F1A;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4F1A;&#x88AB;&#x91CA;&#x653E;</strong>&#x3002;</p>
<p>&#x5982;&#x679C;&#x5C1D;&#x8BD5;&#x8BFB;&#x53D6;&#x8BA1;&#x6570;&#x4E3A;0&#x7684;&#x5BF9;&#x8C61;, &#x4F1A;&#x62A5;&#x51FA;<code>IllegalReferenceCountExeception</code> &#x5F02;&#x5E38;, &#x5FC5;&#x987B;&#x6CE8;&#x610F;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;assert buf.refCnt() == 0;</span><br><span class="line">try {</span><br><span class="line">  buf.writeLong(0xdeadbeef);</span><br><span class="line">  throw new Error(&quot;should not reach here&quot;);</span><br><span class="line">} catch (IllegalReferenceCountExeception e) {</span><br><span class="line">  // Expected</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E5F;&#x80FD;&#x901A;&#x8FC7;<code>retain</code>&#x589E;&#x52A0;&#x8BA1;&#x6570;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;ByteBuf buf = ctx.alloc().directBuffer();</span><br><span class="line">assert buf.refCnt() == 1;</span><br><span class="line"></span><br><span class="line">buf.retain();</span><br><span class="line">assert buf.refCnt() == 2;</span><br><span class="line"></span><br><span class="line">boolean destroyed = buf.release();</span><br><span class="line">assert !destroyed;</span><br><span class="line">assert buf.refCnt() == 1;</span><br></pre></td></tr></table></figure>

<p>&#x770B;&#x8D77;&#x6765;&#x5F88;&#x7B80;&#x5355;, &#x4F46;&#x662F;&#x4E00;&#x65E6;<code>ByteBuf</code> &#x5728;<strong>&#x7EBF;&#x7A0B;&#x95F4;&#x4F20;&#x9012;</strong>&#x65F6;&#x5C31;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x4E86;, &#x56E0;&#x4E3A;&#x65E0;&#x6CD5;&#x5F88;&#x597D;&#x786E;&#x5B9A;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x91CA;&#x653E;, &#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x7ED9;&#x51FA;&#x4E00;&#x4E9B;&#x53EF;&#x4EE5;&#x9075;&#x5FAA;&#x7684;&#x89C4;&#x8303;, &#x80FD;&#x5728;&#x6700;&#x5927;&#x7A0B;&#x5EA6;&#x4E0A;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;.</p>
<h2 id="2-3-&#x6700;&#x4F73;&#x5B9E;&#x8DF5;-&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;"><a href="#2-3-&#x6700;&#x4F73;&#x5B9E;&#x8DF5;-&#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;" class="headerlink" title="2.3 &#x6700;&#x4F73;&#x5B9E;&#x8DF5;: &#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;"></a>2.3 &#x6700;&#x4F73;&#x5B9E;&#x8DF5;: &#x91CA;&#x653E;&#x7684;&#x65F6;&#x673A;</h2><p>&#x4E86;&#x89E3;&#x4E86;Netty&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x673A;&#x5236;&#x540E;, &#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x7ED9;&#x51FA;&#x4E00;&#x4E9B;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;, &#x5728;&#x5DE5;&#x7A0B;&#x4E2D;&#x5408;&#x7406;&#x8FD0;&#x7528;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x53D1;&#x751F;:</p>
<ul>
<li>&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;(&#x201C;&#x7EC4;&#x4EF6;&#x201D;&#x53EF;&#x4EE5;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6216;&#x7EBF;&#x7A0B;)A&#x4F20;&#x9012;&#x7ED9;&#x7EC4;&#x4EF6;B&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5BF9;&#x8C61;, &#x901A;&#x5E38;&#x7EC4;&#x4EF6;A&#x4E0D;&#x9700;&#x8981;&#x91CA;&#x653E;, &#x800C;&#x662F;&#x7531;B&#x51B3;&#x5B9A;&#x8981;&#x4E0D;&#x8981;&#x91CA;&#x653E;.</li>
<li>&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#x6D88;&#x8D39;&#x4E86;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5BF9;&#x8C61;&#x800C;&#x4E14;&#x5B83;&#x4E0D;&#x4F1A;&#x518D;&#x4F20;&#x9012;&#x7ED9;&#x5176;&#x4ED6;&#x7EC4;&#x4EF6;&#x90A3;&#x4E48;&#x7531;&#x8FD9;&#x4E2A;&#x7EC4;&#x4EF6;&#x6765;&#x91CA;&#x653E;.</li>
</ul>
<p>&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ByteBuf a(ByteBuf input) {</span><br><span class="line">    input.writeByte(42);</span><br><span class="line">    return input;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public ByteBuf b(ByteBuf input) {</span><br><span class="line">    try {</span><br><span class="line">        output = input.alloc().directBuffer(input.readableBytes() + 1);</span><br><span class="line">        output.writeBytes(input);</span><br><span class="line">        output.writeByte(42);</span><br><span class="line">        return output;</span><br><span class="line">    } finally {</span><br><span class="line">        input.release();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void c(ByteBuf input) {</span><br><span class="line">    System.out.println(input);</span><br><span class="line">    input.release();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void main() {</span><br><span class="line">    ...</span><br><span class="line">    ByteBuf buf = ...;</span><br><span class="line">    // This will print buf to System.out and destroy it.</span><br><span class="line">    c(b(a(buf)));</span><br><span class="line">    assert buf.refCnt() == 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Action</th>
<th>&#x8C01;&#x5E94;&#x8BE5;&#x91CA;&#x653E;?</th>
<th>&#x8C01;&#x771F;&#x6B63;&#x91CA;&#x653E;&#x4E86;?</th>
</tr>
</thead>
<tbody><tr>
<td><code>main()</code> &#x521B;&#x5EFA;&#x4E86; <code>buf</code></td>
<td><code>buf</code>&#x2192;<code>main()</code></td>
<td></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86; <code>a()</code> &#x4F20;&#x5165;&#x4E86; <code>buf</code></td>
<td><code>buf</code>&#x2192;<code>a()</code></td>
<td></td>
</tr>
<tr>
<td><code>a()</code> &#x8FD4;&#x56DE;&#x4E86; <code>buf</code> .</td>
<td><code>buf</code>&#x2192;<code>main()</code></td>
<td></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86;<code>b()</code> &#x4F20;&#x5165;&#x4E86;buf</td>
<td><code>buf</code>&#x2192;<code>b()</code></td>
<td></td>
</tr>
<tr>
<td><code>b()</code> &#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A; <code>buf</code>&#x7684;copy</td>
<td><code>buf</code>&#x2192;<code>b()</code>, <code>copy</code>&#x2192;<code>main()</code></td>
<td><code>b()</code> &#x91CA;&#x653E;&#x4E86;<code>buf</code></td>
</tr>
<tr>
<td><code>main()</code> &#x8C03;&#x7528;&#x4E86;<code>c()</code> &#x4F20;&#x5165;&#x4E86;copy</td>
<td><code>copy</code>&#x2192;<code>c()</code></td>
<td></td>
</tr>
<tr>
<td><code>c()</code> &#x5403;&#x6389;&#x4E86; <code>copy</code></td>
<td><code>copy</code>&#x2192;<code>c()</code></td>
<td><code>c()</code> &#x91CA;&#x653E;&#x4E86;<code>copy</code></td>
</tr>
</tbody></table>
<p>&#x53C2;&#x8003;: <a href="/external_links/bc956cde3c9b8e0296fbee94923840da.html" target="blank" rel="noopener">netty.io/wiki/refere&#x2026;</a></p>
<hr>
<h1 id="&#x56DB;-Tips"><a href="#&#x56DB;-Tips" class="headerlink" title="&#x56DB;. Tips"></a>&#x56DB;. Tips</h1><p>1&#x3001;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x201C;<code>map -histo:live pid</code>&#x201D;&#x624B;&#x52A8;&#x89E6;&#x53D1;FullGC&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x66F4;&#x5FEB;&#x6253;&#x5370;&#x51FA;&#x6765;&#x5426;&#x5219;&#x8981;&#x7B49;&#x5230;&#x5BF9;&#x5E94;region&#x56DE;&#x6536;&#x7684;&#x65F6;&#x5019;&#x624D;&#x80FD;&#x611F;&#x77E5;&#x5230;&#x3002;&#xFF08;Netty&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x662F;&#x7528;WeakReference&#x7684;&#x539F;&#x7406;&#x89E6;&#x53D1;&#x7684;&#xFF09;</p>
<p>2&#x3001;<code>simple</code>&#x548C;<code>advanced</code>&#x7EA7;&#x522B;&#x4E0B;&#x7684;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x90FD;&#x662F;&#x91C7;&#x6837;&#x89E6;&#x53D1;&#x7684;&#xFF0C;&#x91C7;&#x6837;&#x9891;&#x7387;&#x662F;1/128&#xFF0C;&#x4F46;&#x662F;<code>advanced</code>&#x7EA7;&#x522B;&#x7684;&#x6700;&#x8FD1;&#x4E00;&#x6761;&#x662F;&#x4E00;&#x5B9A;&#x8BB0;&#x5F55;&#x7684;&#x3002;</p>
<hr>
<h1 id="&#x4E94;-Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;"><a href="#&#x4E94;-Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;" class="headerlink" title="&#x4E94;. Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;"></a>&#x4E94;. Netty&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BF4;&#x660E;</h1><table>
<thead>
<tr>
<th>&#x53C2;&#x6570;&#x540D;&#x79F0;</th>
<th>&#x542B;&#x4E49;</th>
<th>&#x5907;&#x6CE8;</th>
</tr>
</thead>
<tbody><tr>
<td><code>io.netty.leakDetectionLevel</code> &#x6216; <code>io.netty.leakDetection.level</code></td>
<td>&#x914D;&#x7F6E;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x68C0;&#x6D4B;&#x7EA7;&#x522B;&#x7684;&#x53C2;&#x6570;, &#x9ED8;&#x8BA4;<code>simple</code></td>
<td><code>io.netty.leakDetectionLevel</code>&#x662F;&#x8001;&#x7248;&#x672C;&#x7684;,&#x63A8;&#x8350;&#x7528;<code>io.netty.leakDetection.level</code></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.targetRecords</code></td>
<td>&#x5982;&#x679C;&#x5F53;&#x524D;&#x4FDD;&#x5B58;&#x7684;&#x8C03;&#x7528;&#x8F68;&#x8FF9;&#x8BB0;&#x5F55;&#x6570;Record&#x5927;&#x4E8E;&#x53C2;&#x6570;<code>io.netty.leakDetection.targetRecords</code>&#x914D;&#x7F6E;&#x7684;&#x503C;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x4EE5;&#x4E00;&#x5B9A;&#x7684;&#x6982;&#x7387;&#xFF08;1/2^n&#xFF09;&#x5220;&#x9664;&#x5934;&#x7ED3;&#x70B9;&#x4E4B;&#x540E;&#x518D;&#x52A0;&#x5165;&#x65B0;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x4E0D;&#x5220;&#x9664;&#x5934;&#x7ED3;&#x70B9;&#x76F4;&#x63A5;&#x65B0;&#x589E;&#x65B0;&#x7684;, &#x9ED8;&#x8BA4;4</td>
<td></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.acquireAndReleaseOnly</code></td>
<td>&#x63A7;&#x5236;&#x662F;&#x5426;&#x53EA;&#x662F;&#x5728;&#x8C03;&#x7528;&#x589E;&#x52A0;&#x6216;&#x51CF;&#x5C11;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#x624D;&#x8C03;&#x7528;<code>record</code>&#x65B9;&#x6CD5;&#x8BB0;&#x5F55;&#x8C03;&#x7528;&#x8F68;&#x8FF9;, &#x9ED8;&#x8BA4;<code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>io.netty.leakDetection.samplingInterval</code></td>
<td>&#x7EA7;&#x522B;<code>simple</code>&#x548C;<code>advanced</code>&#x4E0B;&#x91C7;&#x6837;&#x9891;&#x7387;, &#x9ED8;&#x8BA4;128</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h1 id="&#x516D;-&#x603B;&#x7ED3;"><a href="#&#x516D;-&#x603B;&#x7ED3;" class="headerlink" title="&#x516D;. &#x603B;&#x7ED3;"></a>&#x516D;. &#x603B;&#x7ED3;</h1><p>&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x6DF1;&#x5165;&#x63A2;&#x8BA8;&#x4E86;Netty&#x5806;&#x5916;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x6839;&#x672C;&#x539F;&#x56E0;&#x4EE5;&#x53CA;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x3002;&#x901A;&#x8FC7;&#x4E86;&#x89E3;Netty&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x53D1;&#x751F;&#x5E76;&#x975E;&#x795E;&#x79D8;&#x83AB;&#x6D4B;&#xFF0C;&#x800C;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5408;&#x7406;&#x7684;&#x7BA1;&#x7406;&#x548C;&#x91CA;&#x653E;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6765;&#x907F;&#x514D;&#x3002;</p>
<p>&#x7136;&#x800C;&#xFF0C;&#x9884;&#x9632;&#x80DC;&#x4E8E;&#x6CBB;&#x7597;&#x3002;&#x5728;&#x6587;&#x7AE0;&#x672B;&#x5C3E;&#xFF0C;&#x6211;&#x4EEC;&#x5F3A;&#x8C03;&#x4E86;&#x4E00;&#x4E9B;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x548C;&#x9884;&#x9632;&#x63AA;&#x65BD;&#xFF0C;&#x5E0C;&#x671B;&#x8BFB;&#x8005;&#x5728;&#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x4E2D;&#x80FD;&#x591F;&#x66F4;&#x52A0;&#x6CE8;&#x91CD;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF0C;&#x907F;&#x514D;&#x6F5C;&#x5728;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x6765;&#x603B;&#x7ED3;&#x4E0B;Netty&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x7684;&#x7684;&#x6392;&#x67E5;&#x65B9;&#x6CD5;, &#x5206;&#x4E3A;&#x4E09;&#x6B65;&#xFF1A;</p>
<p>1&#x3001;&#x63D0;&#x5347;&#x6CC4;&#x6F0F;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7EA7;&#x522B;&#x4E3A;<code>advanced</code>&#xFF1A;<code>java -Dio.netty.leakDetection.level=advanced ...</code></p>
<p>2&#x3001;&#x5982;&#x679C;&#x8FD8;&#x4E0D;&#x80FD;&#x5B9A;&#x4F4D;&#xFF0C;&#x5728;&#x5173;&#x952E;&#x4F4D;&#x7F6E;&#x52A0;&#x5165;<code>hint</code>&#x7684;&#x8C03;&#x7528;</p>
<p>3&#x3001;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5185;&#x9700;&#x8981;&#x5B9A;&#x4F4D;&#x7684;&#x5730;&#x65B9;&#x6709;&#x591A;&#x4E2A;&#xFF0C;&#x52A0;&#x5165;<code>hint(&#x4EFB;&#x610F;&#x5B57;&#x7B26;&#x4E32;)</code></p>
<hr>
<p>&#x1F525;&#x5982;&#x679C;&#x611F;&#x89C9;&#x535A;&#x4E3B;&#x7684;&#x6587;&#x7AE0;&#x8FD8;&#x4E0D;&#x9519;&#x7684;&#x8BDD;&#xFF0C;&#x8BF7;&#x1F44D;&#x4E09;&#x8FDE;&#x652F;&#x6301;&#x1F44D;&#x4E00;&#x4E0B;&#x535A;&#x4E3B;&#x54E6;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/777653dc016f46713a655175fa2eb7eeb5fc0d7902f8bf5e8965f569e74e88d6" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/b1e333a96ea731ebe438ed1a8d3a5052.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../74/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../74/">74</a><span class="page-number current">75</span><a class="page-number" href="../76/">76</a><span class="space">&hellip;</span><a class="page-number" href="../298/">298</a><a class="extend next" rel="next" href="../76/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">2975</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1162</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
