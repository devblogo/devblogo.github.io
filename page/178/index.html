<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/178/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/178/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7017071945447374884.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7017071945447374884.html" itemprop="url">阿里限流神器Sentinel夺命连环 17 问？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-09T22:23:35+08:00">
                2021-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x4F5C;&#x8005;&#xFF1A;bucaichenmou  </p>
<p>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/154e67aab6ae7433419933bb794776ba.html" target="blank" rel="noopener">www.cnblogs.com/cbvlog/p/15&#x2026;</a></p>
</blockquote>
<h2 id="1&#x3001;&#x524D;&#x8A00;"><a href="#1&#x3001;&#x524D;&#x8A00;" class="headerlink" title="1&#x3001;&#x524D;&#x8A00;"></a>1&#x3001;&#x524D;&#x8A00;</h2><p>&#x8FD9;&#x662F;&#x300A;spring Cloud &#x8FDB;&#x9636;&#x300B;&#x4E13;&#x680F;&#x7684;&#x7B2C;&#x4E94;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x963F;&#x91CC;&#x5F00;&#x6E90;&#x7684;&#x6D41;&#x91CF;&#x9632;&#x536B;&#x5175;Sentinel&#xFF0C;&#x4E00;&#x6B3E;&#x975E;&#x5E38;&#x4F18;&#x79C0;&#x7684;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#xFF0C;&#x7ECF;&#x8FC7;&#x8FD1;10&#x5E74;&#x7684;&#x53CC;&#x5341;&#x4E00;&#x7684;&#x8003;&#x9A8C;&#xFF0C;&#x975E;&#x5E38;&#x6210;&#x719F;&#x7684;&#x4E00;&#x6B3E;&#x4EA7;&#x54C1;&#x3002;&#x5F80;&#x671F;&#x6587;&#x7AE0;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><a href="/external_links/faf617800623ff31e2d3baf96c3c0ca3.html" target="blank" rel="noopener">&#x4E94;&#x5341;&#x4E94;&#x5F20;&#x56FE;&#x544A;&#x8BC9;&#x4F60;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x7075;&#x9B42;&#x6446;&#x6E21;&#x8005;Nacos&#x7A76;&#x7ADF;&#x6709;&#x591A;&#x5F3A;&#xFF1F;</a></li>
<li><a href="/external_links/3fc5bfeb561209e3f347b50a43f379e8.html" target="blank" rel="noopener">openFeign&#x593A;&#x547D;&#x8FDE;&#x73AF;9&#x95EE;&#xFF0C;&#x8FD9;&#x8C01;&#x53D7;&#x5F97;&#x4E86;&#xFF1F;</a></li>
<li><a href="/external_links/e62a2ffe11b235fbc3736b91a1b0d159.html" target="blank" rel="noopener">&#x963F;&#x91CC;&#x9762;&#x8BD5;&#x8FD9;&#x6837;&#x95EE;&#xFF1A;Nacos&#x3001;Apollo&#x3001;Config&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5982;&#x4F55;&#x9009;&#x578B;&#xFF1F;&#x8FD9;10&#x4E2A;&#x7EF4;&#x5EA6;&#x544A;&#x8BC9;&#x4F60;&#xFF01;</a></li>
<li><a href="/external_links/f15824721137f2f9bc42f879ae7d8c67.html" target="blank" rel="noopener">&#x963F;&#x91CC;&#x9762;&#x8BD5;&#x8D25;&#x5317;&#xFF1A;5&#x79CD;&#x5FAE;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x5982;&#x4F55;&#x9009;&#x578B;&#xFF1F;&#x8FD9;&#x51E0;&#x4E2A;&#x7EF4;&#x5EA6;&#x544A;&#x8BC9;&#x4F60;&#xFF01;</a></li>
</ul>
<p>&#x6587;&#x7AE0;&#x76EE;&#x5F55;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/dbc2a6e890821bbced99b3d5d5f865630f9cbaec8677a0e769c46df4acb60cdf" alt></p>
<h2 id="2&#x3001;&#x4EC0;&#x4E48;&#x662F;sentinel&#xFF1F;"><a href="#2&#x3001;&#x4EC0;&#x4E48;&#x662F;sentinel&#xFF1F;" class="headerlink" title="2&#x3001;&#x4EC0;&#x4E48;&#x662F;sentinel&#xFF1F;"></a>2&#x3001;&#x4EC0;&#x4E48;&#x662F;sentinel&#xFF1F;</h2><p>sentinel&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF1A;&#x536B;&#x5175;&#xFF1B;&#x5728;Redis&#x4E2D;&#x53EB;&#x505A;<strong>&#x54E8;&#x5175;</strong>&#xFF0C;&#x7528;&#x4E8E;&#x76D1;&#x63A7;&#x4E3B;&#x4ECE;&#x5207;&#x6362;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x5FAE;&#x670D;&#x52A1;&#x4E2D;&#x53EB;&#x505A;<strong>&#x6D41;&#x91CF;&#x9632;&#x536B;&#x5175;</strong>&#x3002;</p>
<p>Sentinel &#x4EE5;&#x6D41;&#x91CF;&#x4E3A;&#x5207;&#x5165;&#x70B9;&#xFF0C;&#x4ECE;<strong>&#x6D41;&#x91CF;&#x63A7;&#x5236;</strong>&#x3001;<strong>&#x7194;&#x65AD;&#x964D;&#x7EA7;</strong>&#x3001;<strong>&#x7CFB;&#x7EDF;&#x8D1F;&#x8F7D;</strong>&#x4FDD;&#x62A4;&#x7B49;&#x591A;&#x4E2A;&#x7EF4;&#x5EA6;&#x4FDD;&#x62A4;&#x670D;&#x52A1;&#x7684;&#x7A33;&#x5B9A;&#x6027;&#x3002;</p>
<p>Sentinel &#x5177;&#x6709;&#x4EE5;&#x4E0B;&#x7279;&#x5F81;:</p>
<ul>
<li><strong>&#x4E30;&#x5BCC;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;</strong>&#xFF1A;Sentinel &#x627F;&#x63A5;&#x4E86;&#x963F;&#x91CC;&#x5DF4;&#x5DF4;<strong>&#x8FD1; 10 &#x5E74;&#x7684;&#x53CC;&#x5341;&#x4E00;</strong>&#x5927;&#x4FC3;&#x6D41;&#x91CF;&#x7684;&#x6838;&#x5FC3;&#x573A;&#x666F;&#xFF0C;&#x4F8B;&#x5982;&#x79D2;&#x6740;&#xFF08;&#x5373;&#x7A81;&#x53D1;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x5728;&#x7CFB;&#x7EDF;&#x5BB9;&#x91CF;&#x53EF;&#x4EE5;&#x627F;&#x53D7;&#x7684;&#x8303;&#x56F4;&#xFF09;&#x3001;&#x6D88;&#x606F;&#x524A;&#x5CF0;&#x586B;&#x8C37;&#x3001;&#x96C6;&#x7FA4;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x3001;&#x5B9E;&#x65F6;&#x7194;&#x65AD;&#x4E0B;&#x6E38;&#x4E0D;&#x53EF;&#x7528;&#x5E94;&#x7528;&#x7B49;&#x3002;</li>
<li><strong>&#x5B8C;&#x5907;&#x7684;&#x5B9E;&#x65F6;&#x76D1;&#x63A7;</strong>&#xFF1A;Sentinel &#x540C;&#x65F6;&#x63D0;&#x4F9B;&#x5B9E;&#x65F6;&#x7684;&#x76D1;&#x63A7;&#x529F;&#x80FD;&#x3002;&#x60A8;&#x53EF;&#x4EE5;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x770B;&#x5230;&#x63A5;&#x5165;&#x5E94;&#x7528;&#x7684;&#x5355;&#x53F0;&#x673A;&#x5668;&#x79D2;&#x7EA7;&#x6570;&#x636E;&#xFF0C;&#x751A;&#x81F3; 500 &#x53F0;&#x4EE5;&#x4E0B;&#x89C4;&#x6A21;&#x7684;&#x96C6;&#x7FA4;&#x7684;&#x6C47;&#x603B;&#x8FD0;&#x884C;&#x60C5;&#x51B5;&#x3002;</li>
<li><strong>&#x5E7F;&#x6CDB;&#x7684;&#x5F00;&#x6E90;&#x751F;&#x6001;</strong>&#xFF1A;Sentinel &#x63D0;&#x4F9B;&#x5F00;&#x7BB1;&#x5373;&#x7528;&#x7684;&#x4E0E;&#x5176;&#x5B83;&#x5F00;&#x6E90;&#x6846;&#x67B6;/&#x5E93;&#x7684;&#x6574;&#x5408;&#x6A21;&#x5757;&#xFF0C;&#x4F8B;&#x5982;&#x4E0E; Spring Cloud&#x3001;Apache Dubbo&#x3001;gRPC&#x3001;Quarkus &#x7684;&#x6574;&#x5408;&#x3002;&#x60A8;&#x53EA;&#x9700;&#x8981;&#x5F15;&#x5165;&#x76F8;&#x5E94;&#x7684;&#x4F9D;&#x8D56;&#x5E76;&#x8FDB;&#x884C;&#x7B80;&#x5355;&#x7684;&#x914D;&#x7F6E;&#x5373;&#x53EF;&#x5FEB;&#x901F;&#x5730;&#x63A5;&#x5165; Sentinel&#x3002;&#x540C;&#x65F6; Sentinel &#x63D0;&#x4F9B; Java/Go/C++ &#x7B49;&#x591A;&#x8BED;&#x8A00;&#x7684;&#x539F;&#x751F;&#x5B9E;&#x73B0;&#x3002;</li>
<li><strong>&#x5B8C;&#x5584;&#x7684; SPI &#x6269;&#x5C55;&#x673A;&#x5236;</strong>&#xFF1A;Sentinel &#x63D0;&#x4F9B;&#x7B80;&#x5355;&#x6613;&#x7528;&#x3001;&#x5B8C;&#x5584;&#x7684; SPI &#x6269;&#x5C55;&#x63A5;&#x53E3;&#x3002;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5B9E;&#x73B0;&#x6269;&#x5C55;&#x63A5;&#x53E3;&#x6765;&#x5FEB;&#x901F;&#x5730;&#x5B9A;&#x5236;&#x903B;&#x8F91;&#x3002;&#x4F8B;&#x5982;&#x5B9A;&#x5236;&#x89C4;&#x5219;&#x7BA1;&#x7406;&#x3001;&#x9002;&#x914D;&#x52A8;&#x6001;&#x6570;&#x636E;&#x6E90;&#x7B49;&#x3002;</li>
</ul>
<p><strong>Sentinel &#x7684;&#x4E3B;&#x8981;&#x7279;&#x6027;&#x5982;&#x4E0B;&#x56FE;</strong>&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/86b9443320ce0787fb6f52276cf6584e9f26d1cf592cc0e7f1e26b6290f8816c" alt></p>
<p><strong>Sentinel &#x5206;&#x4E3A;&#x4E24;&#x4E2A;&#x90E8;&#x5206;</strong>:</p>
<ul>
<li>&#x6838;&#x5FC3;&#x5E93;&#xFF08;Java &#x5BA2;&#x6237;&#x7AEF;&#xFF09;&#x4E0D;&#x4F9D;&#x8D56;&#x4EFB;&#x4F55;&#x6846;&#x67B6;/&#x5E93;&#xFF0C;&#x80FD;&#x591F;&#x8FD0;&#x884C;&#x4E8E;&#x6240;&#x6709; Java &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#xFF0C;&#x540C;&#x65F6;&#x5BF9; Dubbo / Spring Cloud &#x7B49;&#x6846;&#x67B6;&#x4E5F;&#x6709;&#x8F83;&#x597D;&#x7684;&#x652F;&#x6301;&#x3002;</li>
<li>&#x63A7;&#x5236;&#x53F0;&#xFF08;Dashboard&#xFF09;&#x57FA;&#x4E8E; Spring Boot &#x5F00;&#x53D1;&#xFF0C;&#x6253;&#x5305;&#x540E;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8FD0;&#x884C;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684; Tomcat &#x7B49;&#x5E94;&#x7528;&#x5BB9;&#x5668;&#x3002;</li>
</ul>
<p><strong>&#x603B;&#x4E4B;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A;sentinel&#x771F;&#x725B;&#x903C;&#xFF0C;&#x5B8C;&#x7206;Hystrix&#x2026;&#x2026;&#x2026;</strong></p>
<h2 id="3&#x3001;sentinel&#x548C;Hystrix&#x6709;&#x4F55;&#x533A;&#x522B;&#xFF1F;"><a href="#3&#x3001;sentinel&#x548C;Hystrix&#x6709;&#x4F55;&#x533A;&#x522B;&#xFF1F;" class="headerlink" title="3&#x3001;sentinel&#x548C;Hystrix&#x6709;&#x4F55;&#x533A;&#x522B;&#xFF1F;"></a>3&#x3001;sentinel&#x548C;Hystrix&#x6709;&#x4F55;&#x533A;&#x522B;&#xFF1F;</h2><p>&#x4E0D;&#x591A;&#x8BF4;&#x4E86;&#xFF0C;&#x603B;&#x4E4B;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A;Hystrix&#x8D76;&#x7D27;&#x653E;&#x5F03;&#xFF0C;&#x7528;sentinel&#x2026;&#x2026;</p>
<p>&#x5177;&#x4F53;&#x533A;&#x522B;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f22f8e8af8b6791c0881480058c86d606855e795103a758bb34294e8b959412b" alt></p>
<h2 id="4&#x3001;sentinel&#x7248;&#x672C;&#x5982;&#x4F55;&#x9009;&#x62E9;&#xFF1F;"><a href="#4&#x3001;sentinel&#x7248;&#x672C;&#x5982;&#x4F55;&#x9009;&#x62E9;&#xFF1F;" class="headerlink" title="4&#x3001;sentinel&#x7248;&#x672C;&#x5982;&#x4F55;&#x9009;&#x62E9;&#xFF1F;"></a>4&#x3001;sentinel&#x7248;&#x672C;&#x5982;&#x4F55;&#x9009;&#x62E9;&#xFF1F;</h2><p>&#x7531;&#x4E8E;&#x9648;&#x67D0;&#x5199;&#x7684;&#x662F;Spring Cloud &#x8FDB;&#x9636;&#x4E00;&#x4E2A;&#x7CFB;&#x5217;&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x805A;&#x5408;&#x9879;&#x76EE;&#xFF0C;&#x56E0;&#x6B64;&#x7248;&#x672C;&#x8FD8;&#x662F;&#x4FDD;&#x6301;&#x548C;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4E00;&#x6837;&#xFF0C;&#x4E0D;&#x6E05;&#x695A;&#x7684;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#xFF1A;<a href="/external_links/f7d2e83b24add89baffdaad29bbb826d.html" target="blank" rel="noopener">&#x4E94;&#x5341;&#x4E94;&#x5F20;&#x56FE;&#x544A;&#x8BC9;&#x4F60;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x7075;&#x9B42;&#x6446;&#x6E21;&#x8005;Nacos&#x7A76;&#x7ADF;&#x6709;&#x591A;&#x5F3A;&#xFF1F;</a></p>
<p>&#x8FD9;&#x91CC;&#x9009;&#x62E9;&#x7684;<code>spring-cloud-alibaba-dependencies</code>&#x7684;&#x7248;&#x672C;&#x662F;<code>2.2.1.RELEASE</code>&#xFF0C;&#x56E0;&#x6B64;sentinel&#x7248;&#x672C;&#x9009;&#x62E9;<code>1.7.1</code>&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x7248;&#x672C;&#x9009;&#x62E9;&#x5BF9;&#x5E94;sentinel&#x7684;&#x7248;&#x672C;&#xFF0C;&#x7248;&#x672C;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/3a75fa60beaf6c16de434cd9abb688d763771b218c851b3ab7044379c2145504" alt></p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x4E00;&#x5B9A;&#x8981;&#x6309;&#x7167;&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x7684;&#x7248;&#x672C;&#x9002;&#x914D;&#xFF0C;&#x5426;&#x5219;&#x51FA;&#x73B0;&#x610F;&#x60F3;&#x4E0D;&#x5230;&#x7684;BUG&#x8FFD;&#x6094;&#x83AB;&#x53CA;&#x2026;&#x2026;&#x2026;</p>
</blockquote>
<h2 id="5&#x3001;Sentinel-&#x63A7;&#x5236;&#x53F0;&#x5982;&#x4F55;&#x5B89;&#x88C5;&#xFF1F;"><a href="#5&#x3001;Sentinel-&#x63A7;&#x5236;&#x53F0;&#x5982;&#x4F55;&#x5B89;&#x88C5;&#xFF1F;" class="headerlink" title="5&#x3001;Sentinel &#x63A7;&#x5236;&#x53F0;&#x5982;&#x4F55;&#x5B89;&#x88C5;&#xFF1F;"></a>5&#x3001;Sentinel &#x63A7;&#x5236;&#x53F0;&#x5982;&#x4F55;&#x5B89;&#x88C5;&#xFF1F;</h2><p>sentinel&#x548C;<strong>nacos</strong>&#x4E00;&#x6837;&#xFF0C;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x4E0D;&#x7528;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x642D;&#x5EFA;&#x4E00;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#xFF0C;&#x5B98;&#x65B9;&#x5DF2;&#x7ECF;&#x642D;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4E0B;&#x8F7D;&#x5BF9;&#x5E94;&#x5F97;jar&#x5305;&#x8FD0;&#x884C;&#x5373;&#x53EF;&#x3002;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/12b9a483ac0d15a0cc4e949490496035.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
<p>&#x9009;&#x62E9;&#x5BF9;&#x5E94;&#x5F97;&#x7248;&#x672C;&#x4E0B;&#x8F7D;&#x5373;&#x53EF;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x9009;&#x62E9;<code>1.7.1</code>&#x7248;&#x672C;&#xFF0C;&#x4E0B;&#x8F7D;&#x7684;jar&#x5305;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/55790d54fedd4c9a16cbd6744946f4d61be8a6461af138e852fe10d97ce5aff8" alt></p>
<blockquote>
<p>&#x5F53;&#x7136;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6E90;&#x7801;&#x6784;&#x5EFA;&#xFF1A;mvn clean package</p>
</blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;JDK&#x7248;&#x672C;&#x5FC5;&#x987B;<code>&gt;=1.8</code></p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x8FD9;&#x4E2A;jar&#x5305;&#x5373;&#x53EF;&#xFF0C;&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.7.1.jar</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x8FF0;&#x53C2;&#x6570;&#x542B;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><code>-Dserver.port</code>&#xFF1A;&#x6307;&#x5B9A;&#x542F;&#x52A8;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;<code>8080</code></li>
<li><code>-Dproject.name</code>&#xFF1A;&#x6307;&#x5B9A;&#x672C;&#x670D;&#x52A1;&#x7684;&#x540D;&#x79F0;</li>
<li><code>-Dcsp.sentinel.dashboard.server</code>&#xFF1A;&#x6307;&#x5B9A;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x7528;&#x4E8E;&#x5C06;&#x81EA;&#x5DF1;&#x6CE8;&#x518C;&#x8FDB;&#x5165;&#x5B9E;&#x73B0;&#x76D1;&#x63A7;&#x81EA;&#x5DF1;</li>
</ul>
<p>&#x542F;&#x52A8;&#x6210;&#x529F;&#x4E4B;&#x540E;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x8BBF;&#x95EE;&#xFF1A;<a href="/external_links/9825c2a542dd888e55b9b0e06b04f672.html" target="blank" rel="noopener">http://localhost:8080</a>&#xFF0C;&#x767B;&#x5F55;&#x9875;&#x9762;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/e5b3f760e4b651eab79a910dda4057332b2d1fed07ddb14aea26569f7c3357db" alt></p>
<blockquote>
<p>&#x9ED8;&#x8BA4;&#x7684;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#xFF1A;sentinel/sentinel</p>
</blockquote>
<p>&#x767B;&#x5F55;&#x6210;&#x529F;&#x4E4B;&#x540E;&#x9875;&#x9762;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/db1c3497a8a2e2b4461da9bb91186065dde4b93c77cbd3d80cca1a292de124af" alt></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x76EE;&#x524D;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x670D;&#x52A1;<code>sentinel-dashboard</code>&#x88AB;&#x76D1;&#x63A7;&#x4E86;&#xFF0C;<strong>&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#x5C31;&#x662F;&#x81EA;&#x5DF1;</strong>&#x3002;</p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x4E0A;&#x8FF0;&#x53C2;&#x6570;&#x90FD;&#x662F;&#x53EF;&#x9009;&#x7684;&#xFF0C;&#x6CA1;&#x5FC5;&#x8981;&#x53EF;&#x4EE5;&#x4E0D;&#x586B;&#x3002;</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x95EE;&#x9898;&#x6765;&#x4E86;&#xFF1A;<strong>&#x9ED8;&#x8BA4;&#x7684;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E0A;&#x80AF;&#x5B9A;&#x4E0D;&#x80FD;&#x7528;&#xFF0C;&#x5982;&#x4F55;&#x4FEE;&#x6539;&#x5462;&#xFF1F;</strong></p>
<p>&#x4ECE; Sentinel 1.6.0 &#x8D77;sentinel&#x5DF2;&#x7ECF;&#x652F;&#x6301;&#x81EA;&#x5B9A;&#x4E49;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#x4E86;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5728;&#x6267;&#x884C;jar&#x547D;&#x4EE4;&#x65F6;&#x6307;&#x5B9A;&#x5373;&#x53EF;&#xFF0C;&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;java -Dsentinel.dashboard.auth.username=admin -Dsentinel.dashboard.auth.password=123 -jar sentinel-dashboard-1.7.1.jar</span><br></pre></td></tr></table></figure>

<p>&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF1A;</p>
<ul>
<li><code>-Dsentinel.dashboard.auth.username=sentinel</code> &#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x767B;&#x5F55;&#x7528;&#x6237;&#x540D;&#x4E3A; <code>sentinel</code>&#xFF1B;</li>
<li><code>-Dsentinel.dashboard.auth.password=123456</code> &#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x767B;&#x5F55;&#x5BC6;&#x7801;&#x4E3A; <code>123456</code>&#xFF1B;&#x5982;&#x679C;&#x7701;&#x7565;&#x8FD9;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x7528;&#x6237;&#x548C;&#x5BC6;&#x7801;&#x5747;&#x4E3A; <code>sentinel</code>&#xFF1B;</li>
<li><code>-Dserver.servlet.session.timeout=7200</code> &#x7528;&#x4E8E;&#x6307;&#x5B9A; Spring Boot &#x670D;&#x52A1;&#x7AEF; session &#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#xFF0C;&#x5982; <code>7200</code> &#x8868;&#x793A; 7200 &#x79D2;&#xFF1B;<code>60m</code> &#x8868;&#x793A; 60 &#x5206;&#x949F;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 30 &#x5206;&#x949F;&#xFF1B;</li>
</ul>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x90E8;&#x7F72;&#x591A;&#x53F0;&#x63A7;&#x5236;&#x53F0;&#x65F6;&#xFF0C;session &#x9ED8;&#x8BA4;&#x4E0D;&#x4F1A;&#x5728;&#x5404;&#x5B9E;&#x4F8B;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#xFF0C;&#x8FD9;&#x4E00;&#x5757;&#x9700;&#x8981;&#x81EA;&#x884C;&#x6539;&#x9020;&#x3002;</p>
</blockquote>
<p>&#x9664;&#x4E86;&#x7528;&#x6237;&#x540D;&#x5BC6;&#x7801;&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#xFF0C;sentinel&#x63A7;&#x5236;&#x53F0;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x5176;&#x4ED6;&#x7684;&#x53EF;&#x914D;&#x7F6E;&#x9009;&#x9879;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/4226940cb592919f01b6ea3dc950098d5a4109d3cba95350fd1ad04b1ac840d3" alt></p>
<h2 id="6&#x3001;&#x5FAE;&#x670D;&#x52A1;&#x5982;&#x4F55;&#x63A5;&#x5165;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF1F;"><a href="#6&#x3001;&#x5FAE;&#x670D;&#x52A1;&#x5982;&#x4F55;&#x63A5;&#x5165;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF1F;" class="headerlink" title="6&#x3001;&#x5FAE;&#x670D;&#x52A1;&#x5982;&#x4F55;&#x63A5;&#x5165;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF1F;"></a>6&#x3001;&#x5FAE;&#x670D;&#x52A1;&#x5982;&#x4F55;&#x63A5;&#x5165;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF1F;</h2><p>&#x5FAE;&#x670D;&#x52A1;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x96C6;&#x6210;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF0C;sentinel&#x4E0D;&#x662F;&#x63D0;&#x4F9B;&#x4E86;&#x76F8;&#x5173;&#x7684;API&#x5417;&#xFF1F;</p>
<p>&#x5176;&#x5B9E;Spring Boot &#x5B98;&#x65B9;&#x4E00;&#x76F4;&#x63D0;&#x5021;<strong>&#x7EA6;&#x5B9A;&gt;&#x914D;&#x7F6E;&gt;&#x7F16;&#x7801;</strong>&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x80FD;&#x591F;&#x4E0D;&#x786C;&#x7F16;&#x7801;&#x4F55;&#x4E50;&#x800C;&#x4E0D;&#x4E3A;&#x5462;&#xFF1F;</p>
<p>&#x56E0;&#x6B64;&#x672C;&#x6587;&#x540E;&#x7EED;&#x5185;&#x5BB9;&#x4E3B;&#x8981;&#x8FD8;&#x662F;&#x7ED3;&#x5408;sentinel&#x63A7;&#x5236;&#x53F0;&#x8FDB;&#x884C;&#x8BB2;&#x89E3;&#xFF0C;&#x5173;&#x4E8E;API&#x7684;&#x4F7F;&#x7528;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x5B66;&#x4E60;&#xFF0C;&#x8BB2;&#x89E3;&#x7684;&#x975E;&#x5E38;&#x6E05;&#x695A;&#x3002;</p>
<p>&#x597D;&#x4E86;&#xFF0C;&#x8A00;&#x5F52;&#x6B63;&#x4F20;&#xFF0C;&#x5FAE;&#x670D;&#x52A1;&#x5982;&#x4F55;&#x63A5;&#x5165;sentinel&#x63A7;&#x5236;&#x53F0;&#x5462;&#xFF1F;</p>
<h3 id="1&#x3001;&#x65B0;&#x5EFA;&#x5FAE;&#x670D;&#x52A1;&#x6A21;&#x5757;&#x6CE8;&#x518C;&#x8FDB;&#x5165;Nacos"><a href="#1&#x3001;&#x65B0;&#x5EFA;&#x5FAE;&#x670D;&#x52A1;&#x6A21;&#x5757;&#x6CE8;&#x518C;&#x8FDB;&#x5165;Nacos" class="headerlink" title="1&#x3001;&#x65B0;&#x5EFA;&#x5FAE;&#x670D;&#x52A1;&#x6A21;&#x5757;&#x6CE8;&#x518C;&#x8FDB;&#x5165;Nacos"></a>1&#x3001;&#x65B0;&#x5EFA;&#x5FAE;&#x670D;&#x52A1;&#x6A21;&#x5757;&#x6CE8;&#x518C;&#x8FDB;&#x5165;Nacos</h3><p>&#x8FD9;&#x91CC;&#x7684;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x4F9D;&#x7136;&#x4F7F;&#x7528;&#x7684;&#x662F;nacos&#xFF0C;&#x6709;&#x4E0D;&#x4F1A;&#x7528;&#x7684;&#x8BF7;&#x770B;&#x4E13;&#x680F;&#x7B2C;&#x4E00;&#x7BC7;Nacos&#x6587;&#x7AE0;&#xFF1A;<a href="/external_links/faf617800623ff31e2d3baf96c3c0ca3.html" target="blank" rel="noopener">&#x4E94;&#x5341;&#x4E94;&#x5F20;&#x56FE;&#x544A;&#x8BC9;&#x4F60;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x7075;&#x9B42;&#x6446;&#x6E21;&#x8005;Nacos&#x7A76;&#x7ADF;&#x6709;&#x591A;&#x5F3A;&#xFF1F;</a></p>
<p>&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#x6A21;&#x5757;&#xFF1A;<strong>sentinel-service9008</strong>&#xFF0C;&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x4E0D;&#x8D34;&#x51FA;&#x4E86;&#x3002;</p>
<p>&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;server:</span><br><span class="line">  port: 9008</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    ## &#x6307;&#x5B9A;&#x670D;&#x52A1;&#x540D;&#x79F0;&#xFF0C;&#x5728;nacos&#x4E2D;&#x7684;&#x540D;&#x5B57;</span><br><span class="line">    name: sentinel-service</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        # nacos&#x7684;&#x670D;&#x52A1;&#x5730;&#x5740;&#xFF0C;nacos-server&#x4E2D;IP&#x5730;&#x5740;:&#x7AEF;&#x53E3;&#x53F7;</span><br><span class="line">        server-addr: 127.0.0.1:8848</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        ## yml&#x6587;&#x4EF6;&#x4E2D;&#x5B58;&#x5728;&#x7279;&#x6B8A;&#x5B57;&#x7B26;&#xFF0C;&#x5FC5;&#x987B;&#x7528;&#x5355;&#x5F15;&#x53F7;&#x5305;&#x542B;&#xFF0C;&#x5426;&#x5219;&#x542F;&#x52A8;&#x62A5;&#x9519;</span><br><span class="line">        include: &apos;*&apos;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x6E90;&#x7801;&#x5168;&#x90E8;&#x4F1A;&#x4E0A;&#x4F20;&#xFF0C;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x770B;&#x6587;&#x672B;&#xFF01;</p>
</blockquote>
<h3 id="2&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"><a href="#2&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;" class="headerlink" title="2&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"></a>2&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;</h3><p>&#x9664;&#x4E86;Nacos&#x7684;&#x4F9D;&#x8D56;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;sentinel&#x7684;&#x4F9D;&#x8D56;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;!--sentinel&#x7684;&#x4F9D;&#x8D56;--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4EE5;&#x4E0A;&#x53EA;&#x8D34;&#x51FA;&#x4E86;sentinel&#x76F8;&#x5173;&#x4F9D;&#x8D56;&#xFF0C;nacos&#x4F9D;&#x8D56;&#x4E0D;&#x518D;&#x8D34;&#x4E86;&#xFF0C;&#x89C1;&#x6E90;&#x7801;&#xFF01;</p>
</blockquote>
<h3 id="3&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x63A7;&#x5236;&#x53F0;"><a href="#3&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x63A7;&#x5236;&#x53F0;" class="headerlink" title="3&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x63A7;&#x5236;&#x53F0;"></a>3&#x3001;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x63A7;&#x5236;&#x53F0;</h3><p>&#x53EA;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x5373;&#x53EF;&#x96C6;&#x6210;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;spring:</span><br><span class="line">  cloud:</span><br><span class="line">    sentinel:</span><br><span class="line">      transport:</span><br><span class="line">      	## &#x6307;&#x5B9A;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x9ED8;&#x8BA4;&#x7AEF;&#x53E3;8080</span><br><span class="line">        dashboard: localhost:8080</span><br></pre></td></tr></table></figure>

<h3 id="4&#x3001;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;"><a href="#4&#x3001;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;" class="headerlink" title="4&#x3001;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;"></a>4&#x3001;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;</h3><p>&#x4E0B;&#x9762;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x63A5;&#x53E3;&#xFF0C;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x76F8;&#x5173;&#x89C4;&#x5219;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RestController</span><br><span class="line">@RequestMapping(&quot;/sentinel&quot;)</span><br><span class="line">public class FlowLimitController {</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/test&quot;)</span><br><span class="line">    public String test(){</span><br><span class="line">        return &quot;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x6761;&#x6D88;&#x606F;--------&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="5&#x3001;&#x542F;&#x52A8;&#x5FAE;&#x670D;&#x52A1;"><a href="#5&#x3001;&#x542F;&#x52A8;&#x5FAE;&#x670D;&#x52A1;" class="headerlink" title="5&#x3001;&#x542F;&#x52A8;&#x5FAE;&#x670D;&#x52A1;"></a>5&#x3001;&#x542F;&#x52A8;&#x5FAE;&#x670D;&#x52A1;</h3><p>&#x542F;&#x52A8;9008&#x8FD9;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#xFF0C;&#x7136;&#x540E;&#x6D4F;&#x89C8;&#x5668;&#x8F93;&#x5165;&#xFF1A;<code>http://localhost:9008/sentinel/test</code>&#xFF0C;&#x6B64;&#x65F6;&#x67E5;&#x770B;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x5C06;&#x4F1A;&#x770B;&#x89C1;<strong>sentinel-service</strong>&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#x5DF2;&#x7ECF;&#x88AB;&#x76D1;&#x63A7;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/c114f41a9168f11f707ddb14127334c30085434fb1a4813c41fa3e0fe293dbc8" alt></p>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;sentinel&#x662F;<strong>&#x61D2;&#x52A0;&#x8F7D;</strong>&#x673A;&#x5236;&#xFF0C;&#x53EA;&#x6709;&#x8BBF;&#x95EE;&#x8FC7;&#x4E00;&#x6B21;&#x7684;&#x8D44;&#x6E90;&#x624D;&#x4F1A;&#x88AB;&#x76D1;&#x63A7;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x5173;&#x95ED;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x5728;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x65F6;&#x5C31;&#x8FDE;&#x63A5;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;spring:</span><br><span class="line">    sentinel:</span><br><span class="line">      # &#x53D6;&#x6D88;&#x63A7;&#x5236;&#x53F0;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x5373;&#x8FDE;&#x63A5;Sentinel</span><br><span class="line">      eager: true</span><br></pre></td></tr></table></figure>

<h2 id="7&#x3001;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"><a href="#7&#x3001;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;" class="headerlink" title="7&#x3001;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"></a>7&#x3001;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;</h2><p><strong>&#x6D41;&#x91CF;&#x63A7;&#x5236;</strong>&#xFF08;flow control&#xFF09;&#xFF0C;&#x5176;&#x539F;&#x7406;&#x662F;&#x76D1;&#x63A7;&#x5E94;&#x7528;&#x6D41;&#x91CF;&#x7684; <strong>QPS</strong> &#x6216;<strong>&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;</strong>&#x7B49;&#x6307;&#x6807;&#xFF0C;&#x5F53;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x7684;<strong>&#x9608;&#x503C;</strong>&#x65F6;&#x5BF9;&#x6D41;&#x91CF;&#x8FDB;&#x884C;&#x63A7;&#x5236;&#xFF0C;&#x4EE5;&#x907F;&#x514D;&#x88AB;&#x77AC;&#x65F6;&#x7684;&#x6D41;&#x91CF;&#x9AD8;&#x5CF0;&#x51B2;&#x57AE;&#xFF0C;&#x4ECE;&#x800C;&#x4FDD;&#x969C;&#x5E94;&#x7528;&#x7684;<strong>&#x9AD8;&#x53EF;&#x7528;&#x6027;</strong>&#x3002;</p>
<blockquote>
<p><strong>QPS</strong>&#xFF1A;&#x6BCF;&#x79D2;&#x8BF7;&#x6C42;&#x6570;&#xFF0C;&#x5373;&#x5728;&#x4E0D;&#x65AD;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6BCF;&#x79D2;&#x80FD;&#x591F;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x91CF;&#x3002;</p>
</blockquote>
<blockquote>
<p><strong>&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;</strong>&#xFF1A;&#x6307;&#x7684;&#x662F;&#x65BD;&#x538B;&#x673A;&#x65BD;&#x52A0;&#x7684;&#x540C;&#x65F6;&#x8BF7;&#x6C42;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#x91CF;&#x3002;</p>
</blockquote>
<p>&#x540C;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x591A;&#x6761;&#x9650;&#x6D41;&#x89C4;&#x5219;&#xFF0C;&#x4E00;&#x6761;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x7531;&#x4EE5;&#x4E0B;&#x5143;&#x7D20;&#x7EC4;&#x6210;&#xFF1A;</p>
<ul>
<li><strong>resource</strong>&#xFF1A;&#x8D44;&#x6E90;&#x540D;&#xFF0C;&#x5373;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x7684;&#x4F5C;&#x7528;&#x5BF9;&#x8C61;&#x3002;</li>
<li><strong>count</strong>&#xFF1A; &#x9650;&#x6D41;&#x9608;&#x503C;</li>
<li><strong>grade</strong>&#xFF1A;&#x9650;&#x6D41;&#x9608;&#x503C;&#x7C7B;&#x578B;&#xFF08;1&#xFF1A;QPS 0&#xFF1A;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#xFF09;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;QPS</li>
<li><strong>limitApp</strong>&#xFF1A;&#x6D41;&#x63A7;&#x9488;&#x5BF9;&#x7684;&#x8C03;&#x7528;&#x6765;&#x6E90;&#xFF0C;&#x82E5;&#x4E3A; <code>default</code> &#x5219;&#x4E0D;&#x533A;&#x5206;&#x8C03;&#x7528;&#x6765;&#x6E90;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;default</li>
<li><strong>strategy</strong>&#xFF1A;&#x5224;&#x65AD;&#x7684;&#x6839;&#x636E;&#x662F;&#x8D44;&#x6E90;&#x81EA;&#x8EAB;**(0)<strong>&#xFF0C;&#x8FD8;&#x662F;&#x6839;&#x636E;&#x5176;&#x5B83;&#x5173;&#x8054;&#x8D44;&#x6E90; **(1)</strong>&#xFF0C;&#x8FD8;&#x662F;&#x6839;&#x636E;&#x94FE;&#x8DEF;&#x5165;&#x53E3;*<em>(2)\</em>*&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x6839;&#x636E;&#x8D44;&#x6E90;&#x672C;&#x8EAB;&#x3002;</li>
<li><strong>controlBehavior</strong>&#xFF1A; &#x6D41;&#x63A7;&#x6548;&#x679C;&#xFF08;&#x76F4;&#x63A5;&#x62D2;&#x7EDD;(0) / &#x6392;&#x961F;&#x7B49;&#x5F85;(2) / &#x9884;&#x70ED;&#x51B7;&#x542F;&#x52A8;(1))&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x76F4;&#x63A5;&#x62D2;&#x7EDD;&#x3002;</li>
</ul>
<p>&#x4EE5;&#x4E0A;&#x5143;&#x7D20;&#x9650;&#x6D41;&#x5143;&#x7D20;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x662F;<code>com.alibaba.csp.sentinel.slots.block.flow.FlowRule</code>&#xFF0C;&#x5404;&#x5143;&#x7D20;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/69a94b89ed0da0b653678b31eff2b5524fb0e477f9a497d6925232af951a5656" alt></p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x5404;&#x4E2A;&#x5143;&#x7D20;&#x7684;&#x53D6;&#x503C;&#x4EE5;&#x53CA;&#x9ED8;&#x8BA4;&#x503C;&#x4E00;&#x5B9A;&#x8981;&#x8BB0;&#x4F4F;&#xFF0C;&#x540E;&#x7EED;&#x914D;&#x7F6E;&#x5C06;&#x4F1A;&#x7528;&#x5230;&#x3002;</p>
</blockquote>
<p>&#x4EE5;&#x4E0A;&#x51E0;&#x4E2A;&#x5143;&#x7D20;&#x5728;sentinel&#x63A7;&#x5236;&#x53F0;&#x5BF9;&#x5E94;&#x89C4;&#x5219;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5c4aec1c63f4e1543820b009f5e4e8049c9d56e0b9f085ca06b92ba74813dc36" alt></p>
<h3 id="1&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6548;&#x679C;"><a href="#1&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6548;&#x679C;" class="headerlink" title="1&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6548;&#x679C;"></a>1&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6548;&#x679C;</h3><p>&#x6D41;&#x63A7;&#x6548;&#x679C;&#x603B;&#x5171;&#x5206;&#x4E3A;&#x4E09;&#x79CD;&#xFF0C;&#x5BF9;&#x5E94;&#x5143;&#x7D20;<code>controlBehavior</code>&#xFF0C;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<h4 id="&#x5FEB;&#x901F;&#x5931;&#x8D25;"><a href="#&#x5FEB;&#x901F;&#x5931;&#x8D25;" class="headerlink" title="&#x5FEB;&#x901F;&#x5931;&#x8D25;"></a>&#x5FEB;&#x901F;&#x5931;&#x8D25;</h4><p>&#x9ED8;&#x8BA4;&#x7684;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x65B9;&#x5F0F;&#xFF0C;&#x5F53;QPS&#x8D85;&#x8FC7;&#x4EFB;&#x610F;&#x89C4;&#x5219;&#x7684;&#x9608;&#x503C;&#x540E;&#xFF0C;&#x65B0;&#x7684;&#x8BF7;&#x6C42;&#x5C31;&#x4F1A;&#x88AB;&#x7ACB;&#x5373;&#x62D2;&#x7EDD;&#xFF0C;&#x62D2;&#x7EDD;&#x65B9;&#x5F0F;&#x4E3A;&#x629B;&#x51FA;<code>FlowException</code>&#x3002;</p>
<h4 id="warm-up"><a href="#warm-up" class="headerlink" title="warm up"></a>warm up</h4><p>&#x5373;<strong>&#x9884;&#x70ED;/&#x51B7;&#x542F;&#x52A8;</strong>&#x65B9;&#x5F0F;&#x3002;&#x5F53;&#x7CFB;&#x7EDF;&#x957F;&#x671F;&#x5904;&#x4E8E;&#x4F4E;&#x6C34;&#x4F4D;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5F53;&#x6D41;&#x91CF;&#x7A81;&#x7136;&#x589E;&#x52A0;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x628A;&#x7CFB;&#x7EDF;&#x62C9;&#x5347;&#x5230;&#x9AD8;&#x6C34;&#x4F4D;&#x53EF;&#x80FD;&#x77AC;&#x95F4;&#x628A;&#x7CFB;&#x7EDF;&#x538B;&#x57AE;&#x3002;&#x901A;&#x8FC7;&#x201D;&#x51B7;&#x542F;&#x52A8;&#x201D;&#xFF0C;&#x8BA9;&#x901A;&#x8FC7;&#x7684;&#x6D41;&#x91CF;<strong>&#x7F13;&#x6162;&#x589E;&#x52A0;</strong>&#xFF0C;&#x5728;<strong>&#x4E00;&#x5B9A;&#x65F6;&#x95F4;&#x5185;</strong>&#x9010;&#x6E10;&#x589E;&#x52A0;&#x5230;<strong>&#x9608;&#x503C;&#x4E0A;&#x9650;</strong>&#xFF0C;&#x7ED9;&#x51B7;&#x7CFB;&#x7EDF;&#x4E00;&#x4E2A;<strong>&#x9884;&#x70ED;</strong>&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x907F;&#x514D;&#x51B7;&#x7CFB;&#x7EDF;&#x88AB;&#x538B;&#x57AE;&#x3002;</p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x8FD9;&#x4E00;&#x6548;&#x679C;&#x53EA;&#x9488;&#x5BF9;QPS&#x6D41;&#x63A7;&#xFF0C;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x6D41;&#x63A7;&#x4E0D;&#x652F;&#x6301;&#x3002;</p>
</blockquote>
<p>&#x9884;&#x70ED;&#x5E95;&#x5C42;&#x662F;&#x6839;&#x636E;<strong>&#x4EE4;&#x724C;&#x6876;</strong>&#x7B97;&#x6CD5;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6E90;&#x7801;&#x5BF9;&#x5E94;&#x5F97;&#x7C7B;&#x5728;<code>com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController</code>&#x3002;</p>
<blockquote>
<p>&#x7B97;&#x6CD5;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;<strong>&#x51B7;&#x5374;&#x56E0;&#x5B50;</strong><code>coldFactor</code>&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x662F;<strong>3</strong>&#xFF0C;&#x5373;&#x8BF7;&#x6C42; QPS &#x4ECE; <strong><code>threshold(&#x9608;&#x503C;) / 3</code></strong> &#x5F00;&#x59CB;&#xFF0C;&#x7ECF;&#x9884;&#x70ED;&#x65F6;&#x957F;&#x9010;&#x6E10;&#x5347;&#x81F3;&#x8BBE;&#x5B9A;&#x7684; QPS &#x9608;&#x503C;&#x3002;</p>
</blockquote>
<p>&#x6BD4;&#x5982;&#x8BBE;&#x5B9A;QPS&#x9608;&#x503C;&#x4E3A;3&#xFF0C;&#x6D41;&#x63A7;&#x6548;&#x679C;&#x4E3A;warm up&#xFF0C;&#x9884;&#x70ED;&#x65F6;&#x957F;&#x4E3A;5&#x79D2;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/bd2263761850f1de016b56a0228c81f8b50022fd5ddc0a7e5ffe278aa71f3b4d" alt></p>
<p>&#x8FD9;&#x6837;&#x914D;&#x7F6E;&#x4E4B;&#x540E;&#x6709;&#x4EC0;&#x4E48;&#x6548;&#x679C;&#x5462;&#xFF1A;QPS&#x8D77;&#x521D;&#x4F1A;&#x4ECE;(3/3/=1)&#x6BCF;&#x79D2;&#x901A;&#x8FC7;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x5F00;&#x59CB;&#x9884;&#x70ED;&#x76F4;&#x5230;5&#x79D2;&#x4E4B;&#x540E;&#x8FBE;&#x5230;&#x6BCF;&#x79D2;&#x901A;&#x8FC7;3&#x6B21;&#x8BF7;&#x6C42;&#x3002;&#x52A8;&#x6001;&#x6548;&#x679C;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/77885493030c3761aaa9727c6f2f4d5ad78ebe1b8fcfc7a520b0712faa64a762" alt></p>
<p>&#x4ECE;&#x4E0A;&#x8FF0;&#x52A8;&#x753B;&#x53EF;&#x4EE5;&#x6E05;&#x695A;&#x7684;&#x770B;&#x89C1;&#xFF1A;&#x524D;&#x51E0;&#x79D2;&#x662F;&#x9891;&#x7E41;&#x6D41;&#x63A7;&#x7684;&#xFF0C;&#x76F4;&#x5230;5&#x79D2;&#xFF0C;QPS&#x9608;&#x503C;&#x8FBE;&#x5230;&#x4E86;3&#x3002;</p>
<blockquote>
<p>&#x5177;&#x4F53;&#x7B97;&#x6CD5;&#x539F;&#x7406;&#x8BF7;&#x770B;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<h4 id="&#x6392;&#x961F;&#x7B49;&#x5F85;"><a href="#&#x6392;&#x961F;&#x7B49;&#x5F85;" class="headerlink" title="&#x6392;&#x961F;&#x7B49;&#x5F85;"></a>&#x6392;&#x961F;&#x7B49;&#x5F85;</h4><p>&#x5300;&#x901F;&#x6392;&#x961F;&#x65B9;&#x5F0F;&#x4F1A;&#x4E25;&#x683C;&#x63A7;&#x5236;&#x8BF7;&#x6C42;&#x901A;&#x8FC7;&#x7684;&#x95F4;&#x9694;&#x65F6;&#x95F4;&#xFF0C;&#x4E5F;&#x5373;&#x662F;&#x8BA9;&#x8BF7;&#x6C42;&#x4EE5;&#x5747;&#x5300;&#x7684;&#x901F;&#x5EA6;&#x901A;&#x8FC7;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x662F;<strong>&#x6F0F;&#x6876;&#x7B97;&#x6CD5;</strong>&#x3002;&#x6E90;&#x7801;&#x5BF9;&#x5E94;&#x5F97;&#x7C7B;&#xFF1A;<code>com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController</code></p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x8FD9;&#x4E00;&#x6548;&#x679C;&#x53EA;&#x9488;&#x5BF9;QPS&#x6D41;&#x63A7;&#xFF0C;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x6D41;&#x63A7;&#x4E0D;&#x652F;&#x6301;&#x3002;</p>
</blockquote>
<p><strong>&#x7B80;&#x5355;&#x4E3E;&#x4E2A;&#x6817;&#x5B50;</strong>&#xFF1A;&#x4F60;&#x53BB;&#x5927;&#x5B66;&#x98DF;&#x5802;&#x5403;&#x996D;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x963F;&#x59E8;&#x5728;&#x6253;&#x996D;&#xFF0C;&#x90A3;&#x4E48;&#x6240;&#x6709;&#x4EBA;&#x90FD;&#x8981;&#x6392;&#x961F;&#x6253;&#x996D;&#xFF0C;&#x6BCF;&#x6B21;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x4EBA;&#x6253;&#x5230;&#x996D;&#xFF0C;&#x5176;&#x4ED6;&#x4EBA;&#x90FD;&#x5728;&#x6392;&#x961F;&#x7B49;&#x5F85;&#x3002;</p>
<p><strong>&#x4E0D;&#x540C;&#x7684;&#x662F;sentinel&#x6709;&#x4E2A;&#x8D85;&#x65F6;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#xFF0C;&#x4E00;&#x65E6;&#x8D85;&#x8FC7;&#x8FD9;&#x4E2A;&#x9884;&#x5B9A;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x95F4;&#x5C06;&#x4F1A;&#x88AB;&#x9650;&#x6D41;&#x3002;</strong></p>
<p>&#x8BE5;&#x65B9;&#x5F0F;&#x4F5C;&#x7528;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/540f899a859ab7a2b9a04a9ffdf7faa25c9aded678db771543ad19a35b041aaa" alt></p>
<blockquote>
<p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x9002;&#x5408;&#x7528;&#x4E8E;&#x8BF7;&#x6C42;&#x4EE5;&#x7A81;&#x523A;&#x72B6;&#x6765;&#x5230;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x4E0D;&#x5E0C;&#x671B;&#x4E00;&#x4E0B;&#x5B50;&#x628A;&#x6240;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x901A;&#x8FC7;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x80FD;&#x4F1A;&#x628A;&#x7CFB;&#x7EDF;&#x538B;&#x57AE;&#xFF1B;&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x4E5F;&#x671F;&#x5F85;&#x7CFB;&#x7EDF;&#x4EE5;&#x7A33;&#x5B9A;&#x7684;&#x901F;&#x5EA6;&#xFF0C;&#x9010;&#x6B65;&#x5904;&#x7406;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#xFF0C;&#x4EE5;&#x8D77;&#x5230;&#x201C;<strong>&#x524A;&#x5CF0;&#x586B;&#x8C37;</strong>&#x201D;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x62D2;&#x7EDD;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x3002;</p>
</blockquote>
<p>&#x6BD4;&#x5982;&#x8BBE;&#x7F6E;QPS&#x9608;&#x503C;&#x4E3A;1&#xFF0C;&#x8D85;&#x65F6;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x4E3A;10000&#x6BEB;&#x79D2;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f38b1494ef3b5a7e67f19f7bacd0443acf92c7b51043b43ba8d27391d85f321d" alt></p>
<p>&#x6B64;&#x65F6;&#x7684;&#x6548;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/b41ab296ff8699afc890ef94b7afed7fb34cb29b17cad93014ef0afdb8bbae84" alt></p>
<p>&#x4ECE;&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;&#x8FDE;&#x7EED;&#x70B9;&#x51FB;&#x5237;&#x65B0;&#x8BF7;&#x6C42;&#xFF0C;&#x867D;&#x7136;&#x8BBE;&#x7F6E;&#x4E86;QPS&#x9608;&#x503C;&#x4E3A;1&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x6CA1;&#x6709;&#x88AB;&#x9650;&#x6D41;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x7B49;&#x5F85;&#xFF0C;&#x56E0;&#x4E3A;&#x8BBE;&#x7F6E;&#x4E86;&#x8D85;&#x65F6;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x4E3A;10&#x79D2;&#x3002;</p>
<blockquote>
<p>&#x5177;&#x4F53;&#x7B97;&#x6CD5;&#x539F;&#x7406;&#x8BF7;&#x770B;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<h3 id="2&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6A21;&#x5F0F;"><a href="#2&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6A21;&#x5F0F;" class="headerlink" title="2&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6A21;&#x5F0F;"></a>2&#x3001;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6A21;&#x5F0F;</h3><p>&#x6D41;&#x63A7;&#x6A21;&#x5F0F;&#x603B;&#x5171;&#x5206;&#x4E3A;&#x4E09;&#x79CD;&#xFF0C;&#x5BF9;&#x5E94;&#x5143;&#x7D20;<code>strategy</code>&#xFF0C;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x76F4;&#x63A5;&#x62D2;&#x7EDD;&#xFF1A;&#x63A5;&#x53E3;&#x8FBE;&#x5230;&#x9650;&#x6D41;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x9650;&#x6D41;</li>
<li>&#x5173;&#x8054;&#xFF1A;&#x5F53;&#x5173;&#x8054;&#x7684;&#x8D44;&#x6E90;&#x8FBE;&#x5230;&#x9608;&#x503C;&#x65F6;&#xFF0C;&#x5C31;&#x9650;&#x6D41;&#x81EA;&#x5DF1;</li>
<li>&#x94FE;&#x8DEF;&#xFF1A;&#x53EA;&#x8BB0;&#x5F55;&#x6307;&#x5B9A;&#x94FE;&#x8DEF;&#x4E0A;&#x7684;&#x6D41;&#x91CF;&#xFF08;&#x6307;&#x5B9A;&#x8D44;&#x6E90;&#x4ECE;&#x5165;&#x53E3;&#x8D44;&#x6E90;&#x8FDB;&#x6765;&#x7684;&#x6D41;&#x91CF;&#xFF0C;&#x5982;&#x679C;&#x8FBE;&#x5230;&#x9608;&#x503C;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x9650;&#x6D41;&#xFF09;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x6765;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x4E0B;&#x4EE5;&#x4E0A;&#x4E09;&#x79CD;&#x6D41;&#x63A7;&#x6A21;&#x5F0F;&#x3002;</p>
<h4 id="&#x76F4;&#x63A5;&#x62D2;&#x7EDD;"><a href="#&#x76F4;&#x63A5;&#x62D2;&#x7EDD;" class="headerlink" title="&#x76F4;&#x63A5;&#x62D2;&#x7EDD;"></a>&#x76F4;&#x63A5;&#x62D2;&#x7EDD;</h4><p>&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF1A;&#x9ED8;&#x8BA4;&#x7684;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x65B9;&#x5F0F;&#xFF0C;&#x5F53;QPS&#x8D85;&#x8FC7;&#x4EFB;&#x610F;&#x89C4;&#x5219;&#x7684;&#x9608;&#x503C;&#x540E;&#xFF0C;&#x65B0;&#x7684;&#x8BF7;&#x6C42;&#x5C31;&#x4F1A;&#x88AB;&#x7ACB;&#x5373;&#x62D2;&#x7EDD;&#xFF0C;&#x62D2;&#x7EDD;&#x65B9;&#x5F0F;&#x4E3A;&#x629B;&#x51FA;<code>FlowException</code>&#x3002;&#x4E0A;&#x9762;&#x7684;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;&#x90FD;&#x662F;&#x914D;&#x7F6E;&#x4E86;&#x76F4;&#x63A5;&#x62D2;&#x7EDD;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;</p>
<h4 id="&#x5173;&#x8054;"><a href="#&#x5173;&#x8054;" class="headerlink" title="&#x5173;&#x8054;"></a>&#x5173;&#x8054;</h4><p><strong>&#x5178;&#x578B;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;</strong>&#xFF1A;&#x4E00;&#x4E2A;&#x662F;<strong>&#x652F;&#x4ED8;</strong>&#x63A5;&#x53E3;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;<strong>&#x4E0B;&#x5355;</strong>&#x63A5;&#x53E3;&#xFF0C;&#x6B64;&#x65F6;&#x4E00;&#x65E6;<strong>&#x652F;&#x4ED8;&#x63A5;&#x53E3;&#x8FBE;&#x5230;&#x4E86;&#x9608;&#x503C;</strong>&#xFF0C;&#x90A3;&#x4E48;&#x8BA2;&#x5355;&#x63A5;&#x53E3;&#x5C31;&#x5E94;&#x8BE5;&#x88AB;&#x9650;&#x6D41;&#xFF0C;&#x4E0D;&#x7136;&#x8FD9;&#x8FB9;&#x8FD8;&#x5728;&#x4E0B;&#x5355;&#xFF0C;&#x6D88;&#x8D39;&#x8005;&#x7B49;&#x5F85;&#x6216;&#x8005;&#x76F4;&#x63A5;&#x88AB;&#x62D2;&#x7EDD;&#x652F;&#x4ED8;&#x5C06;&#x4F1A;&#x6781;&#x5927;&#x7684;&#x5F71;&#x54CD;&#x7528;&#x6237;&#x4F53;&#x9A8C;&#x3002;</p>
<blockquote>
<p>&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF1A;A&#x5173;&#x8054;B&#xFF0C;&#x4E00;&#x65E6;B&#x8FBE;&#x5230;&#x9608;&#x503C;&#xFF0C;&#x5219;A&#x88AB;&#x9650;&#x6D41;</p>
</blockquote>
<p>&#x6F14;&#x793A;&#x4E00;&#x4E0B;&#x6548;&#x679C;&#xFF0C;&#x521B;&#x5EFA;&#x4EE5;&#x4E0B;&#x4E24;&#x4E2A;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@RestController</span><br><span class="line">@RequestMapping(&quot;/sentinel&quot;)</span><br><span class="line">public class FlowLimitController {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x4E0B;&#x5355;&#x63A5;&#x53E3;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/order&quot;)</span><br><span class="line">    public String order()  {</span><br><span class="line">        return &quot;&#x4E0B;&#x5355;&#x6210;&#x529F;..........&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x652F;&#x4ED8;&#x63A5;&#x53E3;</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/pay&quot;)</span><br><span class="line">    public String pay()  {</span><br><span class="line">        return &quot;&#x652F;&#x4ED8;&#x6210;&#x529F;..........&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x65F6;&#x7684;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/7fb14ea12c1c33ef5b38603370c2482c36c9802d648ffa65b95fa39a33b52b6d" alt></p>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x5173;&#x8054;&#x4E4B;&#x540E;&#xFF0C;&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x7684;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x662F;&#x5BF9;&#x88AB;&#x5173;&#x8054;&#x8D44;&#x6E90;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>/sentinel/pay</code>&#x8FD9;&#x4E2A;&#x8D44;&#x6E90;&#xFF0C;&#x4F46;&#x662F;&#x771F;&#x6B63;&#x88AB;&#x9650;&#x6D41;&#x5219;&#x662F;<code>/sentinel/order</code>&#x3002;</p>
<p>&#x5982;&#x4F55;&#x6F14;&#x793A;&#x6548;&#x679C;&#x5462;&#xFF1F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4E0D;&#x65AD;&#x7684;&#x8BF7;&#x6C42;<code>/sentinel/pay</code>&#x8FBE;&#x5230;&#x9608;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8BF7;&#x6C42;<code>/sentinel/order</code>&#x3002;</p>
<p>&#x5229;&#x7528;POSTMAN&#x4E0D;&#x65AD;&#x5411;<code>/sentinel/pay</code>&#x53D1;&#x51FA;&#x8BF7;&#x6C42;&#xFF0C;&#x7136;&#x540E;&#x6D4F;&#x89C8;&#x5668;&#x8BF7;&#x6C42;<code>/sentinel/order</code>&#xFF0C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/7308e939c269520bde87b1f535d7bc1edf6425908efec2c3c5e0f9cb071c9789" alt></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8BA2;&#x5355;&#x63A5;&#x53E3;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#x2026;&#x2026;&#x2026;&#x2026;.</p>
<h3 id="3&#x3001;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;"><a href="#3&#x3001;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;" class="headerlink" title="3&#x3001;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;"></a>3&#x3001;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;</h3><p>&#x6D41;&#x63A7;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;&#xFF0C;&#x5206;&#x522B;&#x662F;<strong>QPS</strong>&#xFF0C;<strong>&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;</strong>&#xFF0C;&#x5F88;&#x591A;&#x4EBA;&#x4E0D;&#x592A;&#x660E;&#x767D;&#x8FD9;&#x4E24;&#x79CD;&#x7EDF;&#x8BA1;&#x7C7B;&#x578B;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;&#xFF1F;</p>
<p><strong>&#x4E3E;&#x4E2A;&#x6817;&#x5B50;</strong>&#xFF1A;&#x9648;&#x67D0;&#x5E26;&#x4E86;&#x4E00;&#x4E2A;&#x4EBF;&#x53BB;&#x94F6;&#x884C;&#x5B58;&#x94B1;&#xFF0C;&#x4F46;&#x662F;&#x94F6;&#x884C;&#x5927;&#x95E8;&#x4FDD;&#x5B89;&#x8981;&#x67E5;&#x5065;&#x5EB7;&#x7801;&#xFF0C;&#x6BCF;&#x79D2;&#x6700;&#x591A;&#x53EA;&#x80FD;&#x540C;&#x65F6;&#x8FDB;&#x5165;4&#x4E2A;&#x4EBA;&#xFF0C;&#x5E76;&#x4E14;&#x94F6;&#x884C;&#x4E2D;&#x53EA;&#x6709;&#x4E24;&#x4E2A;&#x5DE5;&#x4F5C;&#x4EBA;&#x5458;&#x5DE5;&#x4F5C;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f5f748209950c3156202c933bf164b31c8ff6562d559767fa2cd5707066503ef" alt></p>
<p><strong>&#x6B64;&#x65F6;&#x7684;QPS&#x542B;&#x4E49;</strong>&#xFF1A;&#x4ECE;&#x4FDD;&#x5B89;&#x5230;&#x94F6;&#x884C;&#x8FD9;&#x4E00;&#x6BB5;&#xFF0C;&#x5373;&#x662F;&#x4FDD;&#x5B89;&#x653E;&#x884C;&#x8FDB;&#x5165;&#x94F6;&#x884C;&#x7684;&#x4EBA;&#x6570;&#x3002;</p>
<p><strong>&#x6B64;&#x65F6;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x7684;&#x542B;&#x4E49;</strong>&#xFF1A;&#x94F6;&#x884C;&#x53EA;&#x6709;&#x4E24;&#x4E2A;&#x5DE5;&#x4F5C;&#x4EBA;&#x5458;&#x5728;&#x5DE5;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;&#x6700;&#x591A;&#x53EA;&#x80FD;&#x540C;&#x65F6;&#x5904;&#x7406;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x8FD9;&#x91CC;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x7684;&#x9608;&#x503C;&#x5C31;&#x662F;2&#x3002;</p>
<h2 id="8&#x3001;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"><a href="#8&#x3001;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;" class="headerlink" title="8&#x3001;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"></a>8&#x3001;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;</h2><p>&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x5728;&#x65E5;&#x5E38;&#x751F;&#x6D3B;&#x4E2D;&#x4E5F;&#x662F;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#xFF0C;&#x573A;&#x666F;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x80A1;&#x7968;&#x5E02;&#x573A;&#x7684;&#x7194;&#x65AD;&#xFF0C;&#x5F53;&#x4EF7;&#x683C;&#x89E6;&#x53D1;&#x5230;&#x4E86;&#x7194;&#x70B9;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x6682;&#x505C;&#x4EA4;&#x6613;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x6216;&#x8005;&#x4EA4;&#x6613;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x8FDB;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x62A5;&#x4EF7;&#x4F1A;&#x9650;&#x5236;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x8303;&#x56F4;&#x3002;</li>
<li>&#x7535;&#x538B;&#x8FC7;&#x9AD8;&#x5BFC;&#x81F4;&#x4FDD;&#x9669;&#x4E1D;&#x89E6;&#x53D1;&#x7194;&#x65AD;&#x4FDD;&#x62A4;</li>
</ul>
<p>&#x5728;&#x5927;&#x578B;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4F9D;&#x8D56;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/b791a7c9f67470967c7ee8df00fc748d8059ce19fca4b981cee8485febf320af" alt></p>
<p>&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#xFF0C;&#x67D0;&#x4E2A;&#x670D;&#x52A1;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x5F02;&#x5E38;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;</p>
<ul>
<li>&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#x4E0D;&#x53EF;&#x7528;(&#x786C;&#x4EF6;&#x6545;&#x969C;&#x3001;&#x7A0B;&#x5E8F;bug&#x3001;&#x7F51;&#x7EDC;&#x6545;&#x969C;&#x3001;&#x7528;&#x6237;&#x8BF7;&#x6C42;&#x91CF;&#x8F83;&#x5927;)</li>
<li>&#x91CD;&#x8BD5;&#x5BFC;&#x81F4;&#x7684;&#x6D41;&#x91CF;&#x8FC7;&#x5927;</li>
<li>&#x670D;&#x52A1;&#x8C03;&#x7528;&#x8005;&#x4F7F;&#x7528;&#x540C;&#x6B65;&#x8C03;&#x7528;&#xFF0C;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x7684;&#x7B49;&#x5F85;&#x7EBF;&#x7A0B;&#x5360;&#x7528;&#x7CFB;&#x7EDF;&#x8D44;&#x6E90;&#xFF0C;&#x4E00;&#x65E6;&#x7EBF;&#x7A0B;&#x8D44;&#x6E90;&#x88AB;&#x8017;&#x5C3D;&#xFF0C;&#x8C03;&#x7528;&#x8005;&#x63D0;&#x4F9B;&#x7684;&#x670D;&#x52A1;&#x4E5F;&#x4F1A;&#x53D8;&#x6210;&#x4E0D;&#x53EF;&#x7528;&#x72B6;&#x6001;</li>
</ul>
<p>&#x90A3;&#x4E48;&#x5C06;&#x4F1A;&#x5BFC;&#x81F4;&#x6574;&#x4E2A;&#x670D;&#x52A1;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x7528;&#x53E4;&#x8BDD;&#x6765;&#x8BB2;&#x5C31;&#x662F;&#xFF1A;<strong>&#x5343;&#x91CC;&#x4E4B;&#x5824;&#x6BC1;&#x4E8E;&#x8681;&#x7A74;</strong>&#x3002;</p>
<p>&#x6240;&#x8C13;&#x7F16;&#x7A0B;&#x6E90;&#x4E8E;&#x751F;&#x6D3B;&#xFF0C;&#x67B6;&#x6784;&#x5E08;&#x4EEC;&#x6839;&#x636E;&#x751F;&#x6D3B;&#x7684;&#x7ECF;&#x9A8C;&#x8BBE;&#x8BA1;&#x51FA;&#x4E86;&#x670D;&#x52A1;&#x7684;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x7B56;&#x7565;&#xFF0C;&#x5F88;&#x597D;&#x7684;&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x7C7B;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x5BF9;&#x5E94;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#x8FD9;&#x4E00;&#x680F;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/52a31c925afa65e24dbc2fd0142a58ed4293483dbe76af5d1afce143c4958773" alt></p>
<p>&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x51E0;&#x4E2A;&#x5C5E;&#x6027;&#x5982;&#x4E0B;&#x8868;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/cce452b72071462c29d6e572056ff79a1d1f5334145f6617264307671bec1d50" alt></p>
<p>&#x6E90;&#x7801;&#x4E2D;&#x5BF9;&#x5E94;&#x5F97;&#x7C7B;&#x4E3A;&#xFF1A;<code>com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule</code>&#x3002;</p>
<h4 id="&#x4E09;&#x79CD;&#x7194;&#x65AD;&#x7B56;&#x7565;"><a href="#&#x4E09;&#x79CD;&#x7194;&#x65AD;&#x7B56;&#x7565;" class="headerlink" title="&#x4E09;&#x79CD;&#x7194;&#x65AD;&#x7B56;&#x7565;"></a>&#x4E09;&#x79CD;&#x7194;&#x65AD;&#x7B56;&#x7565;</h4><p>Sentinel &#x63D0;&#x4F9B;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#x7194;&#x65AD;&#x7B56;&#x7565;&#xFF1A;</p>
<ol>
<li><strong>&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4; (<code>DEGRADE_GRADE_RT</code>)</strong>&#xFF1A;&#x5F53; 1s &#x5185;&#x6301;&#x7EED;&#x8FDB;&#x5165; 5 &#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x5BF9;&#x5E94;&#x65F6;&#x523B;&#x7684;&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#xFF08;&#x79D2;&#x7EA7;&#xFF09;&#x5747;&#x8D85;&#x8FC7;&#x9608;&#x503C;&#xFF08;<code>count</code>&#xFF0C;&#x4EE5; ms &#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x63A5;&#x4E0B;&#x7684;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#xFF08;<code>DegradeRule</code> &#x4E2D;&#x7684; <code>timeWindow</code>&#xFF0C;&#x4EE5; s &#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x4E4B;&#x5185;&#xFF0C;&#x5BF9;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x81EA;&#x52A8;&#x5730;&#x7194;&#x65AD;&#xFF08;&#x629B;&#x51FA; <code>DegradeException</code>&#xFF09;&#x3002;&#x6CE8;&#x610F; Sentinel &#x9ED8;&#x8BA4;&#x7EDF;&#x8BA1;&#x7684; RT &#x4E0A;&#x9650;&#x662F; 4900 ms&#xFF0C;<strong>&#x8D85;&#x51FA;&#x6B64;&#x9608;&#x503C;&#x7684;&#x90FD;&#x4F1A;&#x7B97;&#x4F5C; 4900 ms</strong>&#xFF0C;&#x82E5;&#x9700;&#x8981;&#x53D8;&#x66F4;&#x6B64;&#x4E0A;&#x9650;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x9879; <code>-Dcsp.sentinel.statistic.max.rt=xxx</code> &#x6765;&#x914D;&#x7F6E;&#x3002;</li>
<li><strong>&#x5F02;&#x5E38;&#x6BD4;&#x4F8B; (<code>DEGRADE_GRADE_EXCEPTION_RATIO</code>)</strong>&#xFF1A;&#x5F53;&#x8D44;&#x6E90;&#x7684;&#x6BCF;&#x79D2;&#x8BF7;&#x6C42;&#x91CF; &gt;= 5&#xFF0C;<strong>&#x5E76;&#x4E14;</strong>&#x6BCF;&#x79D2;&#x5F02;&#x5E38;&#x603B;&#x6570;&#x5360;&#x901A;&#x8FC7;&#x91CF;&#x7684;&#x6BD4;&#x503C;&#x8D85;&#x8FC7;&#x9608;&#x503C;&#xFF08;<code>DegradeRule</code> &#x4E2D;&#x7684; <code>count</code>&#xFF09;&#x4E4B;&#x540E;&#xFF0C;&#x8D44;&#x6E90;&#x8FDB;&#x5165;&#x964D;&#x7EA7;&#x72B6;&#x6001;&#xFF0C;&#x5373;&#x5728;&#x63A5;&#x4E0B;&#x7684;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#xFF08;<code>DegradeRule</code> &#x4E2D;&#x7684; <code>timeWindow</code>&#xFF0C;&#x4EE5; s &#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x4E4B;&#x5185;&#xFF0C;&#x5BF9;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x81EA;&#x52A8;&#x5730;&#x8FD4;&#x56DE;&#x3002;&#x5F02;&#x5E38;&#x6BD4;&#x7387;&#x7684;&#x9608;&#x503C;&#x8303;&#x56F4;&#x662F; <code>[0.0, 1.0]</code>&#xFF0C;&#x4EE3;&#x8868; 0% - 100%&#x3002;</li>
<li><strong>&#x5F02;&#x5E38;&#x6570; (<code>DEGRADE_GRADE_EXCEPTION_COUNT</code>)</strong>&#xFF1A;&#x5F53;&#x8D44;&#x6E90;&#x8FD1; 1 &#x5206;&#x949F;&#x7684;<strong>&#x5F02;&#x5E38;&#x6570;&#x76EE;</strong>&#x8D85;&#x8FC7;&#x9608;&#x503C;&#x4E4B;&#x540E;&#x4F1A;&#x8FDB;&#x884C;&#x7194;&#x65AD;&#x3002;&#x6CE8;&#x610F;&#x7531;&#x4E8E;&#x7EDF;&#x8BA1;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x662F;&#x5206;&#x949F;&#x7EA7;&#x522B;&#x7684;&#xFF0C;&#x82E5; <code>timeWindow</code> &#x5C0F;&#x4E8E; 60s&#xFF0C;&#x5219;&#x7ED3;&#x675F;&#x7194;&#x65AD;&#x72B6;&#x6001;&#x540E;&#x4ECD;&#x53EF;&#x80FD;&#x518D;&#x8FDB;&#x5165;&#x7194;&#x65AD;&#x72B6;&#x6001;&#x3002;</li>
</ol>
<p>&#x4E0B;&#x9762;&#x6F14;&#x793A;&#x4E00;&#x4E2A;&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x7194;&#x65AD;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RestController</span><br><span class="line">@RequestMapping(&quot;/sentinel/provider&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">public class FlowLimitController {</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/test&quot;)</span><br><span class="line">    public String test() throws InterruptedException {</span><br><span class="line">        //&#x4F11;&#x7720;3&#x79D2;&#x949F;</span><br><span class="line">        Thread.sleep(3000);</span><br><span class="line">        log.info(&quot;&#x6536;&#x5230;&#x4E00;&#x6761;&#x6D88;&#x606F;----test&quot;);</span><br><span class="line">        return &quot;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x6761;&#x6D88;&#x606F;--------&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x63A7;&#x53F0;&#x4E3A;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x8BBE;&#x7F6E;&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x4E3A;200&#x6BEB;&#x79D2;&#xFF0C;&#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x4E3A;1&#x79D2;&#xFF0C;<strong>&#x5927;&#x81F4;&#x610F;&#x601D;</strong>&#xFF1A;&#x5E73;&#x5747;&#x7684;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x5927;&#x4E8E;200&#x6BEB;&#x79D2;&#x4E4B;&#x540E;&#xFF0C;&#x5728;&#x63A5;&#x4E0B;&#x6765;&#x7684;1&#x79D2;&#x65F6;&#x95F4;&#x5185;&#x5C06;&#x4F1A;&#x76F4;&#x63A5;&#x7194;&#x65AD;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ed97ca482c73ce4d862e8de3f667da45e09f8ac398da7daa0a688370d0acdb40" alt></p>
<p>&#x4F7F;&#x7528;<strong>Jmeter</strong>&#x5F00;&#x542F;10&#x4E2A;&#x7EBF;&#x7A0B;&#x5FAA;&#x73AF;&#x8DD1;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x8BBF;&#x95EE;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f1878d3a9c578222d39c81a8e9ea9e95188e08bf525ee1cf8c2738565bf5d4d7" alt></p>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x7531;&#x4E8E;&#x7684;&#x63A5;&#x53E3;&#x4E2D;&#x4F11;&#x7720;&#x4E86;3&#x79D2;&#xFF0C;&#x5E73;&#x5747;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x80AF;&#x5B9A;&#x5927;&#x4E8E;200&#x6BEB;&#x79D2;&#xFF0C;&#x56E0;&#x6B64;&#x76F4;&#x63A5;&#x88AB;&#x7194;&#x65AD;&#x4E86;&#x3002;</p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x8FD9;&#x91CC;&#x7194;&#x65AD;&#x540E;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x9ED8;&#x8BA4;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x5B9A;&#x5236;&#x7194;&#x65AD;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#x3002;</p>
</blockquote>
<h2 id="9&#x3001;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;"><a href="#9&#x3001;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;" class="headerlink" title="9&#x3001;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;"></a>9&#x3001;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;</h2><p>&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF1A;&#x70ED;&#x70B9;&#x5C31;&#x662F;&#x7ECF;&#x5E38;&#x8BBF;&#x95EE;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5F88;&#x591A;&#x65F6;&#x5019;&#x80AF;&#x5B9A;&#x662F;&#x5E0C;&#x671B;&#x7EDF;&#x8BA1;&#x67D0;&#x4E2A;&#x8BBF;&#x95EE;&#x9891;&#x6B21;<code>Top K</code>&#x6570;&#x636E;&#x5E76;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x9650;&#x6D41;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#x79D2;&#x6740;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;<strong>&#x5546;&#x54C1;ID</strong>&#xFF0C;&#x5BF9;&#x4E8E;&#x70ED;&#x70B9;&#x5546;&#x54C1;&#x90A3;&#x4E00;&#x77AC;&#x95F4;&#x7684;&#x5E76;&#x53D1;&#x91CF;&#x662F;&#x975E;&#x5E38;&#x53EF;&#x6015;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5FC5;&#x987B;&#x8981;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x9650;&#x6D41;&#x3002;</p>
<p>Sentinel &#x5229;&#x7528; <strong>LRU</strong> &#x7B56;&#x7565;&#x7EDF;&#x8BA1;&#x6700;&#x8FD1;&#x6700;&#x5E38;&#x8BBF;&#x95EE;&#x7684;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#xFF0C;&#x7ED3;&#x5408;<strong>&#x4EE4;&#x724C;&#x6876;&#x7B97;&#x6CD5;</strong>&#x6765;&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x7EA7;&#x522B;&#x7684;&#x6D41;&#x63A7;&#x3002;</p>
<p><strong>&#x6CE8;&#x610F;&#xFF1A;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x53EA;&#x9488;&#x5BF9;QPS&#x3002;</strong></p>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<p>&#x6982;&#x5FF5;&#x7406;&#x89E3;&#x4E86;&#xFF0C;&#x6765;&#x770B;&#x4E0B;sentinel&#x63A7;&#x5236;&#x53F0;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/6d2aa0e1827064fbf96fe901ec2e18125fc73a794b77d8a48f4fa5fab5ffce91" alt></p>
<p>&#x89C4;&#x5219;&#x5BF9;&#x5E94;&#x5F97;&#x6E90;&#x7801;&#x5728;<code>com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule</code>&#x8FD9;&#x4E2A;&#x7C7B;&#x4E2D;&#xFF0C;&#x5404;&#x79CD;&#x5C5E;&#x6027;&#x542B;&#x4E49;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/b29fa26456a54a3a06fbe6ffcb0935943dc8128e35296a819fd2fb967394cffe" alt></p>
<p>&#x89C4;&#x5219;&#x90FD;&#x61C2;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x5B9E;&#x6218;&#x6765;&#x6F14;&#x793A;&#x4E00;&#x4E0B;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x5230;&#x5E95;&#x662F;&#x5982;&#x4F55;&#x9650;&#x6D41;&#x7684;&#x3002;</p>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x53EA;&#x4F5C;&#x7528;&#x4E8E;&#x516B;&#x5927;&#x57FA;&#x672C;&#x7C7B;&#x578B;&#x3002;</p>
<h3 id="1&#x3001;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;"><a href="#1&#x3001;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;" class="headerlink" title="1&#x3001;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;"></a>1&#x3001;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;</h3><p>&#x73B0;&#x5728;&#x5148;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;service&#xFF0C;&#x7528;<code>@SentinelResource</code>&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;&#xFF0C;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x540E;&#x7EED;&#x5C06;&#x4F1A;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#xFF0C;&#x5148;&#x5FFD;&#x7565;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class FlowServiceImpl implements FlowService {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @SentinelResource&#x7684;value&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x4E86;&#x8D44;&#x6E90;&#x540D;&#xFF0C;&#x4E00;&#x5B9A;&#x8981;&#x552F;&#x4E00;</span><br><span class="line">     * blockHandler&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x4E86;&#x515C;&#x5E95;&#x65B9;&#x6CD5;</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    @SentinelResource(value = &quot;OrderQuery&quot;,blockHandler = &quot;handlerQuery&quot;)</span><br><span class="line">    public String query(String p1, String p2) {</span><br><span class="line">        log.info(&quot;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF0C;p1&#xFF1A;{}&#xFF0C;p2&#xFF1A;{}&quot;,p1,p2);</span><br><span class="line">        return &quot;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF1A;success&quot;;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#x5BF9;&#x5E94;&#x5F97;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x65E6;&#x88AB;&#x9650;&#x6D41;&#x5C06;&#x4F1A;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x5904;&#x7406;</span><br><span class="line">     */</span><br><span class="line">    public String handlerQuery(@RequestParam(value = &quot;p1&quot;,required = false) String p1,</span><br><span class="line">                               @RequestParam(value = &quot;p2&quot;,required = false)String p2,</span><br><span class="line">                               BlockException exception){</span><br><span class="line">        log.info(&quot;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF0C;p1&#xFF1A;{}&#xFF0C;p2&#xFF1A;{}&quot;,p1,p2);</span><br><span class="line">        return &quot;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF1A;&#x7194;&#x65AD;&#x4E86;......&quot;;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x4EC0;&#x4E48;&#x610F;&#x601D;&#x5462;&#xFF1F;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;query&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x6CA1;&#x6709;&#x88AB;&#x9650;&#x6D41;&#x5219;&#x8FD4;&#x56DE;&#xFF1A;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF1A;success</li>
<li>&#x5982;&#x679C;query&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#xFF0C;&#x5219;&#x8FDB;&#x5165;&#x4E86;&#x515C;&#x5E95;&#x65B9;&#x6CD5;<code>handlerQuery</code>&#x65B9;&#x6CD5;&#xFF0C;&#x8FD4;&#x56DE;&#xFF1A;&#x67E5;&#x8BE2;&#x5546;&#x54C1;&#xFF1A;&#x7194;&#x65AD;&#x4E86;&#x2026;&#x2026;</li>
</ul>
<h3 id="2&#x3001;&#x521B;&#x5EFA;controller&#x63A5;&#x53E3;"><a href="#2&#x3001;&#x521B;&#x5EFA;controller&#x63A5;&#x53E3;" class="headerlink" title="2&#x3001;&#x521B;&#x5EFA;controller&#x63A5;&#x53E3;"></a>2&#x3001;&#x521B;&#x5EFA;controller&#x63A5;&#x53E3;</h3><p>&#x4E0B;&#x9762;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;controller&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RestController</span><br><span class="line">@RequestMapping(&quot;/sentinel/provider&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">public class FlowLimitController {</span><br><span class="line">    @Autowired</span><br><span class="line">    private FlowService flowService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/order/query&quot;)</span><br><span class="line">    public String query(@RequestParam(value = &quot;p1&quot;,required = false) String p1, @RequestParam(value = &quot;p2&quot;,required = false)String p2){</span><br><span class="line">        return flowService.query(p1,p2);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x63A5;&#x53E3;&#x4E2D;&#x6709;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5206;&#x522B;&#x662F;<code>p1</code>&#x3001;<code>p2</code>&#x3002;</p>
<h3 id="3&#x3001;&#x6DFB;&#x52A0;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x89C4;&#x5219;"><a href="#3&#x3001;&#x6DFB;&#x52A0;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x89C4;&#x5219;" class="headerlink" title="3&#x3001;&#x6DFB;&#x52A0;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x89C4;&#x5219;"></a>3&#x3001;&#x6DFB;&#x52A0;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x89C4;&#x5219;</h3><p>&#x5728;sentinel&#x63A7;&#x5236;&#x53F0;&#x70B9;&#x51FB;<code>&#x70ED;&#x70B9;&#x89C4;&#x5219;-&gt;&#x65B0;&#x589E;&#x70ED;&#x70B9;&#x9650;&#x6D41;&#x89C4;&#x5219;</code>&#xFF0C;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x56FE;&#x89C4;&#x5219;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/0bc41544e5c94f881e76ccfb59b08b5e98e3af9d63a6ad52ab9af27f6fef4fc0" alt></p>
<p>&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x7684;&#x5177;&#x4F53;&#x542B;&#x4E49;&#xFF1A;&#x5F53;<code>OrderQuery</code>&#x8FD9;&#x4E2A;&#x8D44;&#x6E90;&#x4E2D;&#x7684;<strong>&#x7B2C;0&#x4E2A;&#x53C2;&#x6570;</strong>QPS&#x8D85;&#x8FC7;<strong>1&#x79D2;1&#x6B21;</strong>&#x5C06;&#x4F1A;&#x88AB;&#x9650;&#x6D41;&#x3002;&#x8FD9;&#x91CC;&#x53C2;&#x6570;&#x7D22;&#x5F15;&#x662F;&#x4ECE;0&#x5F00;&#x59CB;&#xFF0C;&#x7B2C;0&#x4E2A;&#x5C31;&#x662F;&#x5BF9;&#x5E94;&#x63A5;&#x53E3;&#x4E2D;&#x7684;<code>p1</code>&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x3002;</p>
<p><strong>&#x7B2C;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;</strong>&#xFF1A;&#x6D4F;&#x89C8;&#x5668;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF1A;<a href="/external_links/9bf73958fb2d5c48d14c2d85eb20e0d6.html" target="blank" rel="noopener">http://localhost:9009/sentinel/provider/order/query?p1=22&amp;p2=1222&#xFF0C;&#x8FDE;&#x7EED;&#x70B9;&#x51FB;&#x5C06;&#x4F1A;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x88AB;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/d5f84db2055e33d7b09aa1cddc219c07c13937ff4cd07ff886ffe2a120616311" alt></p>
<p>&#x8FD9;&#x4E5F;&#x6B63;&#x662F;&#x9A8C;&#x8BC1;&#x4E86;&#x4E0A;&#x8FF0;&#x7684;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#x914D;&#x7F6E;&#x3002;</p>
<p><strong>&#x7B2C;&#x4E8C;&#x4E2A;&#x6D4B;&#x8BD5;</strong>&#xFF1A;&#x6D4F;&#x89C8;&#x5668;&#x8F93;&#x5165;&#xFF1A;<a href="/external_links/0c1d5bad4470de3e76330bd202c59823.html" target="blank" rel="noopener">http://localhost:9009/sentinel/provider/order/query?p2=1222&#xFF0C;&#x8FDE;&#x7EED;&#x70B9;&#x51FB;&#x5C06;&#x4F1A;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x5E76;&#x6CA1;&#x6709;&#x88AB;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/3732656b60535a26737bd3406c562a75900f6c972a13314dae13e15bd38cf19a" alt></p>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x5BF9;&#x4E8E;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x9650;&#x6D41;&#xFF0C;&#x53EA;&#x6709;&#x5305;&#x542B;&#x6307;&#x5B9A;&#x7D22;&#x5F15;&#x7684;&#x53C2;&#x6570;&#x8BF7;&#x6C42;&#x624D;&#x4F1A;&#x88AB;&#x9650;&#x6D41;&#xFF0C;&#x5426;&#x5219;&#x4E0D;&#x5F71;&#x54CD;&#x3002;</p>
</blockquote>
<p>&#x6B64;&#x65F6;&#x4EA7;&#x54C1;&#x8BF4;&#xFF1A;ID&#x4E3A;100&#x7684;&#x8FD9;&#x4E2A;&#x4EA7;&#x54C1;&#x70B9;&#x51FB;&#x91CF;&#x592A;&#x5C11;&#x4E86;&#xFF0C;&#x4F60;&#x4EEC;&#x8D76;&#x7D27;&#x8C03;&#x6574;&#x4E0B;&#x8FD9;&#x4E2A;&#x5546;&#x54C1;&#x7684;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x3002;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x8BE5;&#x600E;&#x4E48;&#x529E;&#x5462;&#xFF1F;</p>
<p>&#x522B;&#x7740;&#x6025;&#xFF0C;sentinel&#x663E;&#x7136;&#x8003;&#x8651;&#x5230;&#x4E86;&#x8FD9;&#x4E00;&#x70B9;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;<strong>&#x53C2;&#x6570;&#x4F8B;&#x5916;&#x9879;</strong>&#x8FD9;&#x9879;&#x914D;&#x7F6E;&#xFF0C;&#x9488;&#x5BF9;&#x4EA7;&#x54C1;&#x9700;&#x6C42;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/414da70dd2a8b69406aa31e024f52acf384786b0dbb8284f530de0a8ed907807" alt></p>
<p>&#x4ECE;&#x4E0A;&#x56FE;&#x914D;&#x7F6E;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x53C2;&#x6570;&#x503C;<strong>p1</strong>&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x503C;&#x7B49;&#x4E8E;100&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9650;&#x6D41;&#x9608;&#x503C;&#x8BBE;&#x7F6E;&#x6210;&#x4E86;100&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;<code>p1=100</code>&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;QPS&#x653E;&#x5BBD;&#x5230;1&#x79D2;&#x8BF7;&#x6C42;100&#x6B21;&#x4EE5;&#x4E0A;&#x624D;&#x4F1A;&#x88AB;&#x9650;&#x6D41;&#x3002;</p>
<p><strong>&#x9A8C;&#x8BC1;</strong>&#xFF1A;&#x6D4F;&#x89C8;&#x5668;&#x8F93;&#x5165;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/58e5ee81fed59df66c19b2d54716eb3e.html" target="blank" rel="noopener">http://localhost:9009/sentinel/provider/order/query?p1=100&#xFF0C;&#x65E0;&#x8BBA;&#x70B9;&#x51FB;&#x591A;&#x4E48;&#x5FEB;&#xFF0C;&#x90FD;&#x6CA1;&#x6709;&#x88AB;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF0C;&#x663E;&#x7136;&#x662F;&#x914D;&#x7F6E;&#x751F;&#x6548;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5926f6e5e924d92740503a160453931ab9ffbd9339a4a19ab130010a829ccbda" alt></p>
<blockquote>
<p>&#x4EE5;&#x4E0A;&#x6E90;&#x7801;&#x5728;sentinel-openfeign-provider9009&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6587;&#x672B;&#x6709;&#x6E90;&#x7801;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x3002;</p>
</blockquote>
<h2 id="10&#x3001;&#x7CFB;&#x7EDF;&#x81EA;&#x9002;&#x5E94;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;"><a href="#10&#x3001;&#x7CFB;&#x7EDF;&#x81EA;&#x9002;&#x5E94;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;" class="headerlink" title="10&#x3001;&#x7CFB;&#x7EDF;&#x81EA;&#x9002;&#x5E94;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;"></a>10&#x3001;&#x7CFB;&#x7EDF;&#x81EA;&#x9002;&#x5E94;&#x5982;&#x4F55;&#x9650;&#x6D41;&#xFF1F;</h2><p>&#x524D;&#x9762;&#x70ED;&#x70B9;&#x53C2;&#x6570;&#x3001;&#x666E;&#x901A;&#x6D41;&#x91CF;&#x9650;&#x6D41;&#x90FD;&#x662F;&#x9488;&#x5BF9;&#x7684;&#x67D0;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x8FD9;&#x91CC;&#x7CFB;&#x7EDF;&#x81EA;&#x9002;&#x5E94;&#x9650;&#x6D41;&#x9488;&#x5BF9;&#x662F;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x5165;&#x53E3;&#x6D41;&#x91CF;&#xFF0C;&#x4ECE;&#x5355;&#x53F0;&#x673A;&#x5668;&#x7684; <strong>load</strong>&#x3001;<strong>CPU &#x4F7F;&#x7528;&#x7387;</strong>&#x3001;<strong>&#x5E73;&#x5747; RT</strong>&#x3001;<strong>&#x5165;&#x53E3; QPS</strong> &#x548C;<strong>&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;</strong>&#x7B49;&#x51E0;&#x4E2A;&#x7EF4;&#x5EA6;&#x76D1;&#x63A7;&#x5E94;&#x7528;&#x6307;&#x6807;&#xFF0C;&#x8BA9;&#x7CFB;&#x7EDF;&#x5C3D;&#x53EF;&#x80FD;&#x8DD1;&#x5728;&#x6700;&#x5927;&#x541E;&#x5410;&#x91CF;&#x7684;&#x540C;&#x65F6;&#x4FDD;&#x8BC1;&#x7CFB;&#x7EDF;&#x6574;&#x4F53;&#x7684;&#x7A33;&#x5B9A;&#x6027;&#x3002;</p>
<p>sentinel&#x63A7;&#x5236;&#x53F0;&#x5BF9;&#x5E94;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/0d1afcc326cbd8451bc0d02094626b14668139b41940efaccc0e69e7f21dc2f9" alt></p>
<p>&#x9608;&#x503C;&#x7C7B;&#x578B;&#x6709;&#x4E94;&#x79CD;&#xFF0C;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><strong>Load &#x81EA;&#x9002;&#x5E94;</strong>&#xFF08;&#x4EC5;&#x5BF9; Linux/Unix-like &#x673A;&#x5668;&#x751F;&#x6548;&#xFF09;&#xFF1A;&#x7CFB;&#x7EDF;&#x7684; load1 &#x4F5C;&#x4E3A;&#x542F;&#x53D1;&#x6307;&#x6807;&#xFF0C;&#x8FDB;&#x884C;&#x81EA;&#x9002;&#x5E94;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#x3002;&#x5F53;&#x7CFB;&#x7EDF; load1 &#x8D85;&#x8FC7;&#x8BBE;&#x5B9A;&#x7684;&#x542F;&#x53D1;&#x503C;&#xFF0C;&#x4E14;&#x7CFB;&#x7EDF;&#x5F53;&#x524D;&#x7684;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x8D85;&#x8FC7;&#x4F30;&#x7B97;&#x7684;&#x7CFB;&#x7EDF;&#x5BB9;&#x91CF;&#x65F6;&#x624D;&#x4F1A;&#x89E6;&#x53D1;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#xFF08;BBR &#x9636;&#x6BB5;&#xFF09;&#x3002;&#x7CFB;&#x7EDF;&#x5BB9;&#x91CF;&#x7531;&#x7CFB;&#x7EDF;&#x7684; <code>maxQps * minRt</code> &#x4F30;&#x7B97;&#x5F97;&#x51FA;&#x3002;&#x8BBE;&#x5B9A;&#x53C2;&#x8003;&#x503C;&#x4E00;&#x822C;&#x662F; <code>CPU cores * 2.5</code>&#x3002;</li>
<li><strong>CPU usage</strong>&#xFF08;1.5.0+ &#x7248;&#x672C;&#xFF09;&#xFF1A;&#x5F53;&#x7CFB;&#x7EDF; CPU &#x4F7F;&#x7528;&#x7387;&#x8D85;&#x8FC7;&#x9608;&#x503C;&#x5373;&#x89E6;&#x53D1;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#xFF08;&#x53D6;&#x503C;&#x8303;&#x56F4; 0.0-1.0&#xFF09;&#xFF0C;&#x6BD4;&#x8F83;&#x7075;&#x654F;&#x3002;</li>
<li><strong>&#x5E73;&#x5747; RT</strong>&#xFF1A;&#x5F53;&#x5355;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x6240;&#x6709;&#x5165;&#x53E3;&#x6D41;&#x91CF;&#x7684;&#x5E73;&#x5747; RT &#x8FBE;&#x5230;&#x9608;&#x503C;&#x5373;&#x89E6;&#x53D1;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#xFF0C;&#x5355;&#x4F4D;&#x662F;&#x6BEB;&#x79D2;&#x3002;</li>
<li><strong>&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;</strong>&#xFF1A;&#x5F53;&#x5355;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x6240;&#x6709;&#x5165;&#x53E3;&#x6D41;&#x91CF;&#x7684;&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#x8FBE;&#x5230;&#x9608;&#x503C;&#x5373;&#x89E6;&#x53D1;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#x3002;</li>
<li><strong>&#x5165;&#x53E3; QPS</strong>&#xFF1A;&#x5F53;&#x5355;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x6240;&#x6709;&#x5165;&#x53E3;&#x6D41;&#x91CF;&#x7684; QPS &#x8FBE;&#x5230;&#x9608;&#x503C;&#x5373;&#x89E6;&#x53D1;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;&#x3002;</li>
</ul>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<p>&#x7CFB;&#x7EDF;&#x89C4;&#x5219;&#x7684;&#x914D;&#x7F6E;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x8FD9;&#x91CC;&#x4EE5;&#x5165;&#x53E3;QPS&#x4E3A;&#x4F8B;&#x8FDB;&#x884C;&#x6F14;&#x793A;&#xFF0C;&#x4E3A;&#x4E86;&#x6F14;&#x793A;&#x771F;&#x5B9E;&#x60C5;&#x51B5;&#xFF0C;&#x6E05;&#x6389;&#x6240;&#x6709;&#x7684;&#x9650;&#x6D41;&#x89C4;&#x5219;&#xFF0C;&#x6DFB;&#x52A0;&#x7CFB;&#x7EDF;&#x89C4;&#x5219;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/8981ee5a3798919f67c2417adba88d6cb24a08ac2f7420e30656fb48ee724be0" alt></p>
<p>&#x8FD9;&#x4E2A;QPS&#x7CFB;&#x7EDF;&#x89C4;&#x5219;&#x4E00;&#x914D;&#x7F6E;&#xFF0C;&#x8BE5;&#x5FAE;&#x670D;&#x52A1;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x63A5;&#x53E3;&#x90FD;&#x5C06;&#x4F1A;&#x88AB;&#x8FD9;&#x4E2A;&#x89C4;&#x5219;&#x9650;&#x5236;&#xFF0C;&#x6BD4;&#x5982;&#x8BBF;&#x95EE;&#xFF1A;<a href="/external_links/5a5fc4ee56e16abdbe5ad4986e1a418a.html" target="blank" rel="noopener">http://localhost:9009/sentinel/provider/pay&#xFF0C;&#x8FDE;&#x7EED;&#x70B9;&#x51FB;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5932bac43b2bae1e590dab0c5b56322261056472c0b9080ac78e596b4edb590a" alt></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5DF2;&#x7ECF;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#xFF0C;&#x4E0D;&#x4EC5;&#x662F;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x6240;&#x6709;&#x63A5;&#x53E3;&#x90FD;&#x4F1A;&#x751F;&#x6548;&#x3002;</p>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x7CFB;&#x7EDF;&#x89C4;&#x5219;&#x4E2D;&#x7684;&#x5165;&#x53E3;QPS&#x8FD9;&#x4E2A;&#x89C4;&#x5219;&#x4E0D;&#x5EFA;&#x8BAE;&#x914D;&#x7F6E;&#xFF0C;&#x4E00;&#x65E6;&#x914D;&#x7F6E;&#x4E0A;&#x4E86;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x6574;&#x4E2A;&#x670D;&#x52A1;&#x4E0D;&#x53EF;&#x7528;&#x3002;</p>
<h2 id="11&#x3001;&#x5982;&#x4F55;&#x81EA;&#x5B9A;&#x4E49;&#x9650;&#x6D41;&#x8FD4;&#x56DE;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF1F;"><a href="#11&#x3001;&#x5982;&#x4F55;&#x81EA;&#x5B9A;&#x4E49;&#x9650;&#x6D41;&#x8FD4;&#x56DE;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF1F;" class="headerlink" title="11&#x3001;&#x5982;&#x4F55;&#x81EA;&#x5B9A;&#x4E49;&#x9650;&#x6D41;&#x8FD4;&#x56DE;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF1F;"></a>11&#x3001;&#x5982;&#x4F55;&#x81EA;&#x5B9A;&#x4E49;&#x9650;&#x6D41;&#x8FD4;&#x56DE;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF1F;</h2><p>&#x5728;&#x524D;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#x8FD8;&#x662F;&#x88AB;&#x9650;&#x6D41;&#x8FD4;&#x56DE;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x90FD;&#x662F;<code>Blocked by Sentinel (flow limiting)</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;Sentinel&#x9ED8;&#x8BA4;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x5F88;&#x663E;&#x7136;&#x9ED8;&#x8BA4;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x5E76;&#x4E0D;&#x80FD;&#x6EE1;&#x8DB3;&#x6211;&#x4EEC;&#x7684;&#x4E1A;&#x52A1;&#x9700;&#x6C42;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6839;&#x636E;&#x524D;&#x540E;&#x7AEF;&#x89C4;&#x5219;&#x5236;&#x5B9A;&#x81EA;&#x5DF1;&#x7684;&#x5F02;&#x5E38;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x5C06;&#x4F1A;&#x7528;&#x5230;&#x4E00;&#x4E2A;&#x6CE8;&#x89E3;<code>@SentinelResource</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x5728;&#x4E0A;&#x6587;&#x4E5F;&#x662F;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x4E2D;&#x6709;&#x4E24;&#x4E2A;&#x5173;&#x4E8E;&#x9650;&#x6D41;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><strong>blockHandler</strong>&#xFF1A; &#x5BF9;&#x5E94;&#x5904;&#x7406; <code>BlockException</code> &#x7684;&#x51FD;&#x6570;&#x540D;&#x79F0;&#x3002;blockHandler &#x51FD;&#x6570;&#x8BBF;&#x95EE;&#x8303;&#x56F4;&#x9700;&#x8981;&#x662F; <code>public</code>&#xFF0C;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x9700;&#x8981;&#x4E0E;&#x539F;&#x65B9;&#x6CD5;&#x76F8;&#x5339;&#x914D;&#xFF0C;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x9700;&#x8981;&#x548C;&#x539F;&#x65B9;&#x6CD5;&#x76F8;&#x5339;&#x914D;&#x5E76;&#x4E14;&#x6700;&#x540E;&#x52A0;&#x4E00;&#x4E2A;&#x989D;&#x5916;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7C7B;&#x578B;&#x4E3A; <code>BlockException</code>&#x3002;blockHandler &#x51FD;&#x6570;&#x9ED8;&#x8BA4;&#x9700;&#x8981;&#x548C;&#x539F;&#x65B9;&#x6CD5;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#x3002;</li>
<li><strong>blockHandlerClass</strong>&#xFF1A;&#x6307;&#x5B9A; <code>blockHandlerClass</code> &#x4E3A;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x7684; <code>Class</code> &#x5BF9;&#x8C61;&#xFF0C;&#x6CE8;&#x610F;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x5FC5;&#x9700;&#x4E3A; <code>static</code> &#x51FD;&#x6570;&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x89E3;&#x6790;&#x3002;</li>
</ul>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<p>&#x4F7F;&#x7528;<code>@SentinelResource</code>&#x6CE8;&#x89E3;&#x81EA;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x9650;&#x6D41;&#x5F02;&#x5E38;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#xFF0C;&#x5148;&#x81EA;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;&#xFF0C;&#x6307;&#x5B9A;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x4E3A;<code>handler</code>&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/50569518bad822c5b47b687452b4278875269b49b01f7c4a7012115f81db4ccd" alt></p>
<p>&#x7B2C;&#x4E8C;&#x6B65;&#xFF1A;&#x5199;&#x4E2A;&#x5BF9;&#x5E94;&#x5F97;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/495ba70804391d8049932e1fb979c9ec4b63fd42821cf154ffe28483c0a7fd07" alt></p>
<p>&#x7B2C;&#x4E09;&#x6B65;&#xFF1A;&#x5BF9;&#x8D44;&#x6E90;<code>QueryOrder</code>&#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x9650;&#x6D41;&#x89C4;&#x5219;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/4f0be835781a6dd00735fc68ffa7cc1b2ac77d5dcc49d33c7b92577ab62848f5" alt></p>
<p>&#x7B2C;&#x56DB;&#x6B65;&#xFF1A;&#x5199;&#x4E2A;controller&#xFF0C;&#x4EE3;&#x7801;&#x5C31;&#x4E0D;&#x6652;&#x4E86;&#xFF0C;&#x81EA;&#x5DF1;&#x5199;&#x5427;&#xFF0C;&#x54C8;&#x54C8;&#x3002;&#x3002;&#x3002;&#x3002;</p>
<p>&#x7B2C;&#x4E94;&#x6B65;&#xFF1A;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#xFF0C;&#x75AF;&#x72C2;&#x70B9;&#x51FB;&#xFF0C;&#x5C06;&#x4F1A;&#x51FA;&#x73B0;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/dbab71fe4408c729971d21c35bbc1214db96b2a450cd3a54a100b7df57ee3f1d" alt></p>
<p>&#x5230;&#x8FD9;&#x513F;&#x57FA;&#x672C;&#x7B97;&#x662F;&#x6210;&#x529F;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;<strong>&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x8981;&#x548C;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#x653E;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#xFF0C;&#x8FD9;&#x6837;&#x4EE3;&#x7801;&#x8026;&#x5408;&#x5EA6;&#x4E0D;&#x662F;&#x5F88;&#x9AD8;&#x5417;&#xFF1F;</strong></p>
<p><code>@SentinelResource</code>&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;<code>blockHandlerClass</code>&#xFF0C;&#x5B8C;&#x7F8E;&#x7684;&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x80FD;&#x591F;&#x5C06;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x5355;&#x72EC;&#x653E;&#x5728;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#xFF0C;&#x4E0B;&#x9762;&#x6765;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x3002;</p>
<p><strong>&#x7B2C;&#x4E00;&#x6B65;</strong>&#xFF1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7C7B;<code>CommonHandler</code>&#x6765;&#x653E;&#x7F6E;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/e5323783bc4201310d56622fde3840c01f709e33e78067e37941494d60ca8b37" alt></p>
<p><strong>&#x7B2C;&#x4E8C;&#x6B65;</strong>&#xFF1A;&#x5728;<code>@SentinelResource</code>&#x6CE8;&#x89E3;&#x4E2D;&#x6307;&#x5B9A;blockHandlerClass&#x4E3A;&#x4E0A;&#x9762;&#x7684;&#x7C7B;&#xFF0C;blockHandler&#x6307;&#x5B9A;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x540D;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/41048d64793c02d610ddea0d68a8673130ad58458bf5d77ee16cb431da230acc" alt></p>
<p>&#x597D;&#x4E86;&#xFF0C;&#x81F3;&#x6B64;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x81EA;&#x5DF1;&#x7167;&#x7740;&#x8BD5;&#x8BD5;&#x5427;&#x2026;&#x2026;.</p>
<blockquote>
<p>&#x4E0A;&#x8FF0;&#x6E90;&#x7801;&#x5728;sentinel-openfeign-provider9009&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6E90;&#x7801;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x89C1;&#x6587;&#x672B;&#x3002;</p>
</blockquote>
<h2 id="12&#x3001;&#x5982;&#x4F55;&#x5BF9;&#x5F02;&#x5E38;&#x8FDB;&#x884C;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF1F;"><a href="#12&#x3001;&#x5982;&#x4F55;&#x5BF9;&#x5F02;&#x5E38;&#x8FDB;&#x884C;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF1F;" class="headerlink" title="12&#x3001;&#x5982;&#x4F55;&#x5BF9;&#x5F02;&#x5E38;&#x8FDB;&#x884C;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF1F;"></a>12&#x3001;&#x5982;&#x4F55;&#x5BF9;&#x5F02;&#x5E38;&#x8FDB;&#x884C;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF1F;</h2><p>&#x7A0B;&#x5E8F;&#x5458;&#x6BCF;&#x5929;&#x90FD;&#x5728;&#x5236;&#x9020;BUG&#xFF0C;&#x6CA1;&#x6709;&#x5B8C;&#x7F8E;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x5B8C;&#x7F8E;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#xFF0C;&#x9488;&#x5BF9;&#x4EE3;&#x7801;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x5F02;&#x5E38;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x907F;&#x514D;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F53;&#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x7684;&#x65F6;&#x5019;&#x8FDB;&#x884C;&#x6355;&#x83B7;&#x5E76;&#x505A;&#x51FA;&#x76F8;&#x5E94;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x79F0;&#x4E4B;&#x4E3A;&#x964D;&#x7EA7;&#x5904;&#x7406;&#x3002;</p>
<p>&#x5F02;&#x5E38;&#x7684;&#x964D;&#x7EA7;&#x8FD8;&#x662F;&#x8981;&#x7528;&#x5230;<code>@SentinelResource</code>&#x6CE8;&#x89E3;&#xFF0C;&#x5176;&#x4E2D;&#x76F8;&#x5173;&#x7684;&#x51E0;&#x4E2A;&#x5C5E;&#x6027;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><strong>fallback</strong>&#xFF1A;fallback &#x51FD;&#x6570;&#x540D;&#x79F0;&#xFF0C;&#x53EF;&#x9009;&#x9879;&#xFF0C;&#x7528;&#x4E8E;&#x5728;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x7684;&#x65F6;&#x5019;&#x63D0;&#x4F9B; fallback &#x5904;&#x7406;&#x903B;&#x8F91;&#x3002;fallback &#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x6240;&#x6709;&#x7C7B;&#x578B;&#x7684;&#x5F02;&#x5E38;&#xFF08;&#x9664;&#x4E86; <code>exceptionsToIgnore</code> &#x91CC;&#x9762;&#x6392;&#x9664;&#x6389;&#x7684;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF09;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;fallback &#x51FD;&#x6570;&#x7B7E;&#x540D;&#x548C;&#x4F4D;&#x7F6E;&#x8981;&#x6C42;&#xFF1A;<ul>
<li>&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x4E0E;&#x539F;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x4E00;&#x81F4;&#xFF1B;</li>
<li>&#x65B9;&#x6CD5;&#x53C2;&#x6570;&#x5217;&#x8868;&#x9700;&#x8981;&#x548C;&#x539F;&#x51FD;&#x6570;&#x4E00;&#x81F4;&#xFF0C;&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x989D;&#x5916;&#x591A;&#x4E00;&#x4E2A; <code>Throwable</code> &#x7C7B;&#x578B;&#x7684;&#x53C2;&#x6570;&#x7528;&#x4E8E;&#x63A5;&#x6536;&#x5BF9;&#x5E94;&#x7684;&#x5F02;&#x5E38;&#x3002;</li>
<li>fallback &#x51FD;&#x6570;&#x9ED8;&#x8BA4;&#x9700;&#x8981;&#x548C;&#x539F;&#x65B9;&#x6CD5;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#x3002;&#x82E5;&#x5E0C;&#x671B;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7C7B;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x6307;&#x5B9A; <code>fallbackClass</code> &#x4E3A;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x7684; <code>Class</code> &#x5BF9;&#x8C61;</li>
</ul>
</li>
<li><strong>fallbackClass</strong>&#xFF1A;&#x6307;&#x5B9A;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x7684; <code>Class</code> &#x5BF9;&#x8C61;&#xFF0C;&#x6CE8;&#x610F;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x5FC5;&#x9700;&#x4E3A; static &#x51FD;&#x6570;&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x89E3;&#x6790;&#x3002;</li>
<li><strong>defaultFallback</strong>&#xFF08;since 1.6.0&#xFF09;&#xFF1A;&#x9ED8;&#x8BA4;&#x7684; fallback &#x51FD;&#x6570;&#x540D;&#x79F0;&#xFF0C;&#x53EF;&#x9009;&#x9879;&#xFF0C;&#x901A;&#x5E38;&#x7528;&#x4E8E;&#x901A;&#x7528;&#x7684; fallback &#x903B;&#x8F91;&#xFF08;&#x5373;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x5F88;&#x591A;&#x670D;&#x52A1;&#x6216;&#x65B9;&#x6CD5;&#xFF09;&#x3002;&#x9ED8;&#x8BA4; fallback &#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x6240;&#x6709;&#x7C7B;&#x578B;&#x7684;&#x5F02;&#x5E38;&#xFF08;&#x9664;&#x4E86; <code>exceptionsToIgnore</code> &#x91CC;&#x9762;&#x6392;&#x9664;&#x6389;&#x7684;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF09;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;<strong>&#x82E5;&#x540C;&#x65F6;&#x914D;&#x7F6E;&#x4E86; fallback &#x548C; defaultFallback&#xFF0C;&#x5219;&#x53EA;&#x6709; fallback &#x4F1A;&#x751F;&#x6548;</strong>&#x3002;defaultFallback &#x51FD;&#x6570;&#x7B7E;&#x540D;&#x8981;&#x6C42;&#xFF1A;<ul>
<li>&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x4E0E;&#x539F;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x4E00;&#x81F4;&#xFF1B;</li>
<li><strong>&#x65B9;&#x6CD5;&#x53C2;&#x6570;&#x5217;&#x8868;&#x9700;&#x8981;&#x4E3A;&#x7A7A;</strong>&#xFF0C;&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x989D;&#x5916;&#x591A;&#x4E00;&#x4E2A; <code>Throwable</code> &#x7C7B;&#x578B;&#x7684;&#x53C2;&#x6570;&#x7528;&#x4E8E;&#x63A5;&#x6536;&#x5BF9;&#x5E94;&#x7684;&#x5F02;&#x5E38;&#x3002;</li>
<li>defaultFallback &#x51FD;&#x6570;&#x9ED8;&#x8BA4;&#x9700;&#x8981;&#x548C;&#x539F;&#x65B9;&#x6CD5;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x4E2D;&#x3002;&#x82E5;&#x5E0C;&#x671B;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7C7B;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x6307;&#x5B9A; <code>fallbackClass</code> &#x4E3A;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x7684; <code>Class</code> &#x5BF9;&#x8C61;&#xFF0C;&#x6CE8;&#x610F;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x5FC5;&#x9700;&#x4E3A; static &#x51FD;&#x6570;&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x89E3;&#x6790;&#x3002;</li>
</ul>
</li>
<li><strong>exceptionsToIgnore</strong>&#xFF08;since 1.6.0&#xFF09;&#xFF1A;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x54EA;&#x4E9B;&#x5F02;&#x5E38;&#x88AB;&#x6392;&#x9664;&#x6389;&#xFF0C;&#x4E0D;&#x4F1A;&#x8BA1;&#x5165;&#x5F02;&#x5E38;&#x7EDF;&#x8BA1;&#x4E2D;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165; fallback &#x903B;&#x8F91;&#x4E2D;&#xFF0C;&#x800C;&#x662F;&#x4F1A;&#x539F;&#x6837;&#x629B;&#x51FA;&#x3002;</li>
</ul>
<p>1.8.0 &#x7248;&#x672C;&#x5F00;&#x59CB;&#xFF0C;<code>defaultFallback</code> &#x652F;&#x6301;&#x5728;&#x7C7B;&#x7EA7;&#x522B;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002;</p>
<blockquote>
<p>&#x6CE8;&#xFF1A;1.6.0 &#x4E4B;&#x524D;&#x7684;&#x7248;&#x672C; fallback &#x51FD;&#x6570;&#x53EA;&#x9488;&#x5BF9;&#x964D;&#x7EA7;&#x5F02;&#x5E38;&#xFF08;<code>DegradeException</code>&#xFF09;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;<strong>&#x4E0D;&#x80FD;&#x9488;&#x5BF9;&#x4E1A;&#x52A1;&#x5F02;&#x5E38;&#x8FDB;&#x884C;&#x5904;&#x7406;</strong>&#x3002;</p>
</blockquote>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<p>&#x4E0B;&#x9762;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x521B;&#x5EFA;&#x8BA2;&#x5355;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x624B;&#x52A8;&#x5236;&#x9020;&#x4E00;&#x4E2A;<code>1/0</code>&#x5F02;&#x5E38;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/fd6e9bef6350de53c84c3404b073ca2e17a0086cdd3a0b75761bd4088b52222d" alt></p>
<p>&#x4E0A;&#x8FF0;&#x63A5;&#x53E3;&#x5E76;&#x6CA1;&#x6709;&#x8FDB;&#x884C;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF0C;&#x56E0;&#x6B64;&#x8C03;&#x7528;&#x8BE5;&#x63A5;&#x53E3;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4E86;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF0C;&#x975E;&#x5E38;&#x4E0D;&#x53CB;&#x597D;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/a17bd4d63dbb436e62ab491d099214594872cd4fffa18fb975b58f3e2804bd02" alt></p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>fallback</code>&#x6307;&#x5B9A;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#x7684;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x65F6;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#x6539;&#x9020;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/02105562fd887939edefa3a59e512f693a1bb79d976360b7bcc06080aa342adb" alt></p>
<p>&#x4F7F;&#x7528;<code>fallbackClass</code>&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x5355;&#x72EC;&#x4E00;&#x4E2A;&#x7C7B;&#x5904;&#x7406;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#xFF0C;&#x964D;&#x4F4E;&#x4E86;&#x4EE3;&#x7801;&#x7684;&#x8026;&#x5408;&#x5EA6;&#xFF0C;<code>fallback</code>&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x4E86;&#x964D;&#x7EA7;&#x515C;&#x5E95;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ff3d9d531e4c60eb45072256494acd2d2e98ebe0d50d22fb1ae7df4f1a1cb6fb" alt></p>
<p>&#x6B64;&#x65F6;&#x518D;&#x6B21;&#x8BBF;&#x95EE;&#x63A5;&#x53E3;&#xFF0C;&#x867D;&#x7136;&#x6709;&#x5F02;&#x5E38;&#xFF0C;&#x4F46;&#x662F;&#x8FD4;&#x56DE;&#x7684;&#x786E;&#x5B9E;&#x964D;&#x7EA7;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#x4E2D;&#x7684;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5d6247d1554d04f0cb96e03fda3400149df562cde657575da1e867085cc4a1ad" alt></p>
<p>&#x5230;&#x4E86;&#x8FD9;&#x91CC;&#x57FA;&#x672C;&#x6EE1;&#x8DB3;&#x4E86;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#x7684;&#x5904;&#x7406;&#x9700;&#x6C42;&#xFF0C;&#x4F46;&#x662F;&#x4ECD;&#x7136;&#x6709;&#x4E2A;&#x7591;&#x95EE;&#xFF1A;<strong>&#x80FD;&#x5426;&#x53EA;&#x7528;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x5168;&#x90E8;&#x7684;&#x5F02;&#x5E38;&#xFF1F;</strong></p>
<p>&#x7B54;&#x6848;&#x662F;&#xFF1A;<strong>&#x80FD;</strong>&#xFF0C;<strong>&#x5FC5;&#x987B;&#x80FD;</strong>&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x8981;&#x7528;&#x5230;<code>defaultFallback</code> &#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x4E86;&#xFF0C;&#x6307;&#x5B9A;&#x9ED8;&#x8BA4;&#x7684;&#x964D;&#x7EA7;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x65F6;&#x7684;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#x53D8;&#x6210;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5c923dca16244528b9297657a6068755fc30a46e8c68f4557300d53623498cc1" alt></p>
<p><code>defaultFallback</code>&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;&#x964D;&#x7EA7;&#x515C;&#x5E95;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/2d68973390b2236a01dd801c9ca7d13f691c0dce125c964411a2c034de027a54" alt></p>
<p>&#x597D;&#x4E86;&#xFF0C;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#x5904;&#x7406;&#x5230;&#x8FD9;&#x513F;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x5B8C;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x4ECD;&#x7136;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;<strong>&#x82E5; blockHandler &#x548C; fallback &#x90FD;&#x8FDB;&#x884C;&#x4E86;&#x914D;&#x7F6E;&#xFF0C;&#x90A3;&#x4E48;&#x54EA;&#x4E2A;&#x4F1A;&#x751F;&#x6548;&#xFF1F;</strong></p>
<blockquote>
<p><strong>&#x7ED3;&#x8BBA;</strong>&#xFF1A;&#x82E5; blockHandler &#x548C; fallback &#x90FD;&#x8FDB;&#x884C;&#x4E86;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x88AB;&#x9650;&#x6D41;&#x964D;&#x7EA7;&#x800C;&#x629B;&#x51FA; <code>BlockException</code> &#x65F6;&#x53EA;&#x4F1A;&#x8FDB;&#x5165; <code>blockHandler</code> &#x5904;&#x7406;&#x903B;&#x8F91;&#x3002;&#x82E5;&#x672A;&#x914D;&#x7F6E; <code>blockHandler</code>&#x3001;<code>fallback</code> &#x548C; <code>defaultFallback</code>&#xFF0C;&#x5219;&#x88AB;&#x9650;&#x6D41;&#x964D;&#x7EA7;&#x65F6;&#x4F1A;&#x5C06; <code>BlockException</code> <strong>&#x76F4;&#x63A5;&#x629B;&#x51FA;</strong>&#x3002;</p>
</blockquote>
<p>&#x5C06;<code>createOrder</code>&#x8FD9;&#x4E2A;&#x4E1A;&#x52A1;&#x63A5;&#x53E3;&#x6539;&#x9020;&#x4E00;&#x4E0B;&#xFF0C;&#x540C;&#x65F6;&#x6307;&#x5B9A;blockHandler&#x548C;fallback&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/d61cd081996cd2683eb5ba44522cb0a2169e1c4c27f08cee8595db9c359ed99c" alt></p>
<p>&#x6B64;&#x65F6;&#x4E0D;&#x914D;&#x7F6E;&#x4EFB;&#x4F55;&#x89C4;&#x5219;&#xFF0C;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x63A5;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x4E86;&#x5F02;&#x5E38;&#x964D;&#x7EA7;&#x5904;&#x7406;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/9d682b764e31fbd70ae8033dab4a279b326fdea16d45605a33bac9b4e1e6abe0" alt></p>
<p>&#x6211;&#x4EEC;&#x5BF9;<code>createOrder</code>&#x8FD9;&#x4E2A;&#x8D44;&#x6E90;&#x914D;&#x7F6E;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#xFF1A;60&#x79D2;&#x5185;&#x5982;&#x679C;&#x51FA;&#x73B0;2&#x4E2A;&#x4EE5;&#x4E0A;&#x7684;&#x5F02;&#x5E38;&#x76F4;&#x63A5;&#x9650;&#x6D41;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/264755af32a6cfd675963d9224d2dbdcfa6bc2d1286792ffb4aaea75067485de" alt></p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x8BBF;&#x95EE;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x524D;&#x4E24;&#x6B21;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x4E86;<code>fallback</code>&#x6307;&#x5B9A;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF08;&#x5E76;&#x672A;&#x8FBE;&#x5230;&#x9650;&#x6D41;&#x7684;&#x5F02;&#x5E38;&#x6570;&#x9608;&#x503C;&#xFF09;&#xFF0C;&#x4E24;&#x6B21;&#x4E4B;&#x540E;&#x5C31;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#xFF0C;&#x8FDB;&#x5165;&#x4E86;<code>blockHandler</code>&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6548;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/62f9e4d0a6d0bd0ef51303327d226b56d61b4ddd3a1554478371aa2d625b3aba" alt></p>
<blockquote>
<p>&#x4E0A;&#x8FF0;&#x6E90;&#x7801;&#x5728;sentinel-openfeign-provider9009&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6E90;&#x7801;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x89C1;&#x6587;&#x672B;&#x3002;</p>
</blockquote>
<h2 id="13&#x3001;sentinel&#x7684;&#x9ED1;&#x767D;&#x540D;&#x5355;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#xFF1F;"><a href="#13&#x3001;sentinel&#x7684;&#x9ED1;&#x767D;&#x540D;&#x5355;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#xFF1F;" class="headerlink" title="13&#x3001;sentinel&#x7684;&#x9ED1;&#x767D;&#x540D;&#x5355;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#xFF1F;"></a>13&#x3001;sentinel&#x7684;&#x9ED1;&#x767D;&#x540D;&#x5355;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#xFF1F;</h2><p>&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;&#x9ED1;&#x540D;&#x5355;&#x5C31;&#x662F;&#x62C9;&#x9ED1;&#x5457;&#xFF0C;&#x62C9;&#x9ED1;&#x5C31;&#x662F;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x4E86;&#x5457;&#xFF0C;sentinel&#x80FD;&#x591F;&#x9488;&#x5BF9;&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#x8FDB;&#x884C;&#x662F;&#x5426;&#x653E;&#x884C;&#xFF0C;&#x82E5;&#x914D;&#x7F6E;&#x767D;&#x540D;&#x5355;&#x5219;&#x53EA;&#x6709;&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#x4F4D;&#x4E8E;&#x767D;&#x540D;&#x5355;&#x5185;&#x65F6;&#x624D;&#x53EF;&#x901A;&#x8FC7;&#xFF1B;&#x82E5;&#x914D;&#x7F6E;&#x9ED1;&#x540D;&#x5355;&#x5219;&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#x4F4D;&#x4E8E;&#x9ED1;&#x540D;&#x5355;&#x65F6;&#x4E0D;&#x901A;&#x8FC7;&#xFF0C;&#x5176;&#x4F59;&#x7684;&#x8BF7;&#x6C42;&#x901A;&#x8FC7;&#x3002;</p>
<p>sentinel&#x63A7;&#x5236;&#x53F0;&#x5BF9;&#x5E94;&#x5F97;&#x89C4;&#x5219;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/9d551b36fc0d8dcedb3a677b06d63a0350848f19a14c8acefcf9d99c2fac7fa8" alt></p>
<p>&#x8BE5;&#x89C4;&#x5219;&#x5BF9;&#x5E94;&#x5F97;&#x6E90;&#x7801;&#x4E3A;<code>com.alibaba.csp.sentinel.slots.block.authority.AuthorityRule</code>&#xFF0C;&#x51E0;&#x4E2A;&#x5C5E;&#x6027;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><code>resource</code>&#xFF1A;&#x8D44;&#x6E90;&#x540D;&#xFF0C;&#x5373;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x7684;&#x4F5C;&#x7528;&#x5BF9;&#x8C61;&#x3002;</li>
<li><code>limitApp</code>&#xFF1A;&#x5BF9;&#x5E94;&#x7684;&#x9ED1;&#x540D;&#x5355;/&#x767D;&#x540D;&#x5355;&#xFF0C;&#x4E0D;&#x540C; origin &#x7528; <code>,</code> &#x5206;&#x9694;&#xFF0C;&#x5982; <code>appA,appB</code>&#x3002;</li>
<li><code>strategy</code>&#xFF1A;&#x9650;&#x5236;&#x6A21;&#x5F0F;&#xFF0C;<code>AUTHORITY_WHITE</code> &#x4E3A;&#x767D;&#x540D;&#x5355;&#x6A21;&#x5F0F;&#xFF0C;<code>AUTHORITY_BLACK</code> &#x4E3A;&#x9ED1;&#x540D;&#x5355;&#x6A21;&#x5F0F;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x767D;&#x540D;&#x5355;&#x6A21;&#x5F0F;&#x3002;</li>
</ul>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;<strong>&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x600E;&#x4E48;&#x83B7;&#x53D6;&#xFF1F;</strong></p>
<p>Sentinel&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;<code>RequestOriginParser</code>&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x4E1A;&#x52A1;&#x7684;&#x89C4;&#x5219;&#x89E3;&#x6790;&#x51FA;&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#x540D;&#x79F0;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EE5;<strong>IP</strong>&#x4F5C;&#x4E3A;&#x533A;&#x5206;&#x8BF7;&#x6C42;&#x6765;&#x6E90;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/567ec4fb3abb94bb2fcb974337498738f4d9e1ff549805b18247674d35ddc1eb" alt></p>
<p>&#x7136;&#x540E;&#x5C06;<code>127.0.0.1</code>&#x8BBE;&#x7F6E;&#x4E3A;&#x9ED1;&#x540D;&#x5355;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/fe73b33c7b39de472f2585e092f036ee82453e05afa9d3d9aeb2826fca706d29" alt></p>
<p>&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF1A;<a href="/external_links/70f50840f11c8de8d54b573789c098df.html" target="blank" rel="noopener">http://127.0.0.1:9009/sentinel/rate/order/query?id=1002&#xFF0C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/f16b47563c91882c1eea093b886fd2c79192f1307c47cd5fad269a72406421df" alt></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#x54E6;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;..</p>
<p>&#x597D;&#x4E86;&#xFF0C;&#x9ED1;&#x767D;&#x540D;&#x5355;&#x5C31;&#x4ECB;&#x7ECD;&#x5230;&#x8FD9;&#x91CC;&#x3002;</p>
<blockquote>
<p>&#x4E0A;&#x8FF0;&#x6E90;&#x7801;&#x5728;sentinel-openfeign-provider9009&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6E90;&#x7801;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x89C1;&#x6587;&#x672B;&#x3002;</p>
</blockquote>
<h2 id="14&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x6301;&#x4E45;&#x5316;&#xFF1F;"><a href="#14&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x6301;&#x4E45;&#x5316;&#xFF1F;" class="headerlink" title="14&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x6301;&#x4E45;&#x5316;&#xFF1F;"></a>14&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x6301;&#x4E45;&#x5316;&#xFF1F;</h2><p>Sentinel&#x9ED8;&#x8BA4;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x662F;&#x5B58;&#x50A8;&#x5728;<strong>&#x5185;&#x5B58;</strong>&#x4E2D;&#xFF0C;&#x53EA;&#x8981;&#x670D;&#x52A1;&#x91CD;&#x542F;&#x4E4B;&#x540E;&#x5BF9;&#x5E94;&#x5F97;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x4E5F;&#x4F1A;&#x6D88;&#x5931;&#xFF0C;&#x5B9E;&#x9645;&#x7684;&#x751F;&#x4EA7;&#x4E2D;&#x80AF;&#x5B9A;&#x662F;&#x4E0D;&#x5141;&#x8BB8;&#x8FD9;&#x79CD;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x6B64;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x7684;&#x6301;&#x4E45;&#x5316;&#x8FEB;&#x5728;&#x7709;&#x776B;&#x3002;</p>
<p>sentinel&#x5B98;&#x65B9;&#x6587;&#x6863;&#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x79CD;&#x6301;&#x4E45;&#x5316;&#x6A21;&#x5F0F;&#xFF0C;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ce50f89aaec48f6a38ba3675725c04eb17d7d504fde233e53a7f5bb0ffb13e29" alt></p>
<p>&#x4F46;&#x662F;&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x4F7F;&#x7528;<code>Push</code>&#x6A21;&#x5F0F;&#xFF0C;&#x4E0B;&#x9762;&#x9648;&#x67D0;&#x5C31;Push&#x6A21;&#x5F0F;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x6301;&#x4E45;&#x5316;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x3002;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;Nacos&#x4F5C;&#x4E3A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x3002;</p>
<p>&#x76D7;&#x7528;&#x5B98;&#x65B9;&#x4E00;&#x5F20;&#x67B6;&#x6784;&#x56FE;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/1cb387135e19f20ea7c1b7e77b6978a57f393f881d3ab43a471add918d0347bb" alt></p>
<h3 id="1&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"><a href="#1&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;" class="headerlink" title="1&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;"></a>1&#x3001;&#x6DFB;&#x52A0;&#x4F9D;&#x8D56;</h3><p>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x4F9D;&#x8D56;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2&#x3001;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x4FE1;&#x606F;"><a href="#2&#x3001;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x4FE1;&#x606F;" class="headerlink" title="2&#x3001;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x4FE1;&#x606F;"></a>2&#x3001;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x4FE1;&#x606F;</h3><p>&#x65E2;&#x7136;&#x4F7F;&#x7528;&#x5230;&#x4E86;Nacos&#x4F5C;&#x4E3A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x80AF;&#x5B9A;&#x662F;&#x8981;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x7684;&#x5730;&#x5740;&#x3001;dataId&#x2026;</p>
<p>&#x5728;<code>application.yml</code>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;spring:</span><br><span class="line">  cloud:</span><br><span class="line">    sentinel:</span><br><span class="line">      ## nacos&#x6301;&#x4E45;&#x5316;&#x914D;&#x7F6E;</span><br><span class="line">      datasource:</span><br><span class="line">        ## &#x914D;&#x7F6E;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#xFF0C;&#x540D;&#x5B57;&#x4EFB;&#x610F;</span><br><span class="line">        ds-flow:</span><br><span class="line">          nacos:</span><br><span class="line">            ## nacos&#x7684;&#x5730;&#x5740;</span><br><span class="line">            server-addr: 127.0.0.1:8848</span><br><span class="line">            ## &#x914D;&#x7F6E;ID</span><br><span class="line">            dataId: ${spring.application.name}-flow</span><br><span class="line">            ## &#x914D;&#x7F6E;&#x5206;&#x7EC4;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;DEFAULT_GROUP</span><br><span class="line">            groupId: DEFAULT_GROUP</span><br><span class="line">            ## &#x914D;&#x7F6E;&#x5B58;&#x50A8;&#x7684;&#x683C;&#x5F0F;</span><br><span class="line">            data-type: json</span><br><span class="line">            ## rule-type&#x8BBE;&#x7F6E;&#x5BF9;&#x5E94;&#x5F97;&#x89C4;&#x5219;&#x7C7B;&#x578B;&#xFF0C;&#x603B;&#x5171;&#x4E03;&#x5927;&#x7C7B;&#x578B;&#xFF0C;&#x5728;com.alibaba.cloud.sentinel.datasource.RuleType&#x8FD9;&#x4E2A;&#x679A;&#x4E3E;&#x7C7B;&#x4E2D;&#x6709;&#x4F53;&#x73B0;</span><br><span class="line">            rule-type: flow</span><br><span class="line">        ## &#x914D;&#x7F6E;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#xFF0C;&#x540D;&#x5B57;&#x4EFB;&#x610F;</span><br><span class="line">        ds-degrade:</span><br><span class="line">          nacos:</span><br><span class="line">            ## nacos&#x7684;&#x5730;&#x5740;</span><br><span class="line">            server-addr: 127.0.0.1:8848</span><br><span class="line">            ## &#x914D;&#x7F6E;ID</span><br><span class="line">            dataId: ${spring.application.name}-degrade</span><br><span class="line">            ## &#x914D;&#x7F6E;&#x5206;&#x7EC4;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;DEFAULT_GROUP</span><br><span class="line">            groupId: DEFAULT_GROUP</span><br><span class="line">            ## &#x914D;&#x7F6E;&#x5B58;&#x50A8;&#x7684;&#x683C;&#x5F0F;</span><br><span class="line">            data-type: json</span><br><span class="line">            ## rule-type&#x8BBE;&#x7F6E;&#x5BF9;&#x5E94;&#x5F97;&#x89C4;&#x5219;&#x7C7B;&#x578B;&#xFF0C;&#x603B;&#x5171;&#x4E03;&#x5927;&#x7C7B;&#x578B;&#xFF0C;&#x5728;com.alibaba.cloud.sentinel.datasource.RuleType&#x8FD9;&#x4E2A;&#x679A;&#x4E3E;&#x7C7B;&#x4E2D;&#x6709;&#x4F53;&#x73B0;</span><br><span class="line">            rule-type: degrade</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x4EC5;&#x4EC5;&#x5C55;&#x793A;&#x4E86;&#x548C;&#x6301;&#x4E45;&#x5316;&#x76F8;&#x5173;&#x7684;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#xFF0C;&#x5176;&#x4ED6;&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#x4EE3;&#x7801;&#x5C31;&#x4E0D;&#x8D34;&#x4E86;&#xFF0C;&#x7A0D;&#x540E;&#x81EA;&#x5DF1;&#x770B;&#x6E90;&#x7801;&#x3002;</p>
<p><code>spring.cloud.sentinel.datasource</code>&#x4E0B;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x591A;&#x4E2A;&#x89C4;&#x5219;&#xFF0C;&#x9648;&#x67D0;&#x8FD9;&#x91CC;&#x53EA;&#x914D;&#x7F6E;&#x4E86;&#x9650;&#x6D41;&#x548C;&#x964D;&#x7EA7;&#x89C4;&#x5219;&#xFF0C;&#x5176;&#x4ED6;&#x89C4;&#x5219;&#x81EA;&#x5DF1;&#x5C1D;&#x8BD5;&#x914D;&#x4E00;&#x4E0B;&#xFF0C;&#x4E0D;&#x540C;&#x89C4;&#x5219;&#x901A;&#x8FC7;<code>rule-type</code>&#x533A;&#x5206;&#xFF0C;&#x5176;&#x53D6;&#x503C;&#x90FD;&#x5728;<code>com.alibaba.cloud.sentinel.datasource.RuleType</code>&#x8FD9;&#x4E2A;&#x679A;&#x4E3E;&#x7C7B;&#x4E2D;&#xFF0C;&#x5BF9;&#x5E94;&#x7740;sentinel&#x4E2D;&#x7684;&#x51E0;&#x5927;&#x7EDF;&#x8BA1;&#x89C4;&#x5219;&#x3002;</p>
<h3 id="3&#x3001;&#x5728;Nacos&#x6DFB;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x914D;&#x7F6E;"><a href="#3&#x3001;&#x5728;Nacos&#x6DFB;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x914D;&#x7F6E;" class="headerlink" title="3&#x3001;&#x5728;Nacos&#x6DFB;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x914D;&#x7F6E;"></a>3&#x3001;&#x5728;Nacos&#x6DFB;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x914D;&#x7F6E;</h3><p>&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x9650;&#x6D41;&#xFF08;flow&#xFF09;&#x89C4;&#x5219;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/e77064ddc3a7df33435450e49322e5e6b65f07199b35f750724d8e686f0a040d" alt></p>
<p>&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x964D;&#x7EA7;&#xFF08;degrade&#xFF09;&#x89C4;&#x5219;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/c16cd27887b5f8fd2588da8d099235bb33bd77936b163cf3d74720cbc614cd74" alt></p>
<p>&#x5148;&#x4E0D;&#x7EA0;&#x7ED3;JSON&#x6570;&#x636E;&#x91CC;&#x9762;&#x5230;&#x5E95;&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x5148;&#x770B;&#x6548;&#x679C;&#xFF0C;&#x5168;&#x90E8;&#x53D1;&#x5E03;&#x4E4B;&#x540E;&#xFF0C;Nacos&#x4E2D;&#x603B;&#x5171;&#x6709;&#x4E86;&#x4E24;&#x4E2A;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ff5c63239dc293fb1fb2005d333e8936b2fd91bdf0548cab7dd01066affee357" alt></p>
<p>&#x4E0A;&#x56FE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x4E24;&#x79CD;&#x89C4;&#x5219;&#x5DF2;&#x7ECF;&#x5728;Nacos&#x914D;&#x7F6E;&#x597D;&#x4E86;&#xFF0C;&#x6765;&#x770B;&#x4E00;&#x4E0B;sentinel&#x4E2D;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x751F;&#x6548;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/95b41ecde320bc66af0c712417ebfc3ae7b317d231e529c64e3aaafcfcb51008" alt></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/191921bbee7f59cc574f6beda673876fb717f4b5ee8e32f5116dad7b038a6806" alt></p>
<p>&#x54E6;&#x4E86;&#xFF0C;&#x5DF2;&#x7ECF;&#x751F;&#x6548;&#x4E86;&#xFF0C;&#x7531;&#x4E8E;&#x662F;push&#x6A21;&#x5F0F;&#xFF0C;&#x53EA;&#x8981;nacos&#x4E2D;&#x70B9;&#x51FB;&#x53D1;&#x5E03;&#x914D;&#x7F6E;&#xFF0C;&#x76F8;&#x5173;&#x89C4;&#x5219;&#x914D;&#x7F6E;&#x5C31;&#x4F1A;&#x63A8;&#x9001;&#x5230;sentinel&#x4E2D;&#x3002;</p>
<blockquote>
<p>&#x4E0A;&#x8FF0;&#x6E90;&#x7801;&#x5728;sentinel-openfeign-provider9009&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4E2D;&#xFF0C;&#x6E90;&#x7801;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x89C1;&#x6587;&#x672B;&#x3002;</p>
</blockquote>
<p><strong>&#x4F0F;&#x7B14;</strong>&#xFF1A;push&#x6A21;&#x5F0F;&#x53EA;&#x80FD;&#x4FDD;&#x8BC1;Nacos&#x4E2D;&#x7684;&#x4FEE;&#x6539;&#x63A8;&#x9001;&#x5230;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF0C;**&#x4F46;&#x662F;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x4FEE;&#x6539;&#x5982;&#x4F55;&#x63A8;&#x9001;&#x5230;Nacos&#x5462;&#xFF1F;**&#x522B;&#x7740;&#x6025;&#xFF0C;&#x4E0B;&#x9762;&#x5C06;&#x4F1A;&#x4ECB;&#x7ECD;&#x2026;&#x2026;&#x2026;&#x2026;..</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/84d4a6721780bfdec33b67947a23ddf8062dfdd18d6631c78ecac79d99b8ef1f" alt></p>
<h3 id="4&#x3001;JSON&#x4E2D;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x5199;&#xFF1F;"><a href="#4&#x3001;JSON&#x4E2D;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x5199;&#xFF1F;" class="headerlink" title="4&#x3001;JSON&#x4E2D;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x5199;&#xFF1F;"></a>4&#x3001;JSON&#x4E2D;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x5199;&#xFF1F;</h3><p>&#x5F88;&#x591A;&#x4EBA;&#x597D;&#x5947;JOSN&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x5230;&#x5E95;&#x600E;&#x4E48;&#x5199;&#xFF1F;&#x5176;&#x5B9E;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x9648;&#x67D0;&#x5728;&#x4ECB;&#x7ECD;&#x5404;&#x79CD;&#x89C4;&#x5219;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x660E;&#x786E;&#x544A;&#x8BC9;&#x4F60;&#x6BCF;&#x79CD;&#x89C4;&#x5219;&#x5BF9;&#x5E94;&#x6E90;&#x7801;&#x4E2D;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x6BD4;&#x5982;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x5C31;&#x662F;<code>com.alibaba.csp.sentinel.slots.block.flow.FlowRule</code>&#xFF0C;JOSN&#x4E2D;&#x5404;&#x4E2A;&#x5C5E;&#x6027;&#x4E5F;&#x662F;&#x6765;&#x6E90;&#x4E8E;&#x8FD9;&#x4E2A;&#x7C7B;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x9648;&#x67D0;&#x5217;&#x51FA;&#x5404;&#x4E2A;&#x89C4;&#x5219;&#x7684;JSON&#x914D;&#x7F6E;&#xFF0C;&#x5F00;&#x53D1;&#x4E2D;&#x7167;&#x7740;&#x6539;&#x5373;&#x53EF;&#x3002;</p>
<p><strong>1&#x3001;&#x6D41;&#x63A7;&#x89C4;&#x5219;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;[</span><br><span class="line">  {</span><br><span class="line">    // &#x8D44;&#x6E90;&#x540D;</span><br><span class="line">    &quot;resource&quot;: &quot;/test&quot;,</span><br><span class="line">    // &#x9488;&#x5BF9;&#x6765;&#x6E90;&#xFF0C;&#x82E5;&#x4E3A; default &#x5219;&#x4E0D;&#x533A;&#x5206;&#x8C03;&#x7528;&#x6765;&#x6E90;</span><br><span class="line">    &quot;limitApp&quot;: &quot;default&quot;,</span><br><span class="line">    // &#x9650;&#x6D41;&#x9608;&#x503C;&#x7C7B;&#x578B;(1:QPS;0:&#x5E76;&#x53D1;&#x7EBF;&#x7A0B;&#x6570;&#xFF09;</span><br><span class="line">    &quot;grade&quot;: 1,</span><br><span class="line">    // &#x9608;&#x503C;</span><br><span class="line">    &quot;count&quot;: 1,</span><br><span class="line">    // &#x662F;&#x5426;&#x662F;&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;</span><br><span class="line">    &quot;clusterMode&quot;: false,</span><br><span class="line">    // &#x6D41;&#x63A7;&#x6548;&#x679C;(0:&#x5FEB;&#x901F;&#x5931;&#x8D25;;1:Warm Up(&#x9884;&#x70ED;&#x6A21;&#x5F0F;);2:&#x6392;&#x961F;&#x7B49;&#x5F85;)</span><br><span class="line">    &quot;controlBehavior&quot;: 0,</span><br><span class="line">    // &#x6D41;&#x63A7;&#x6A21;&#x5F0F;(0:&#x76F4;&#x63A5;&#xFF1B;1:&#x5173;&#x8054;;2:&#x94FE;&#x8DEF;)</span><br><span class="line">    &quot;strategy&quot;: 0,</span><br><span class="line">    // &#x9884;&#x70ED;&#x65F6;&#x95F4;&#xFF08;&#x79D2;&#xFF0C;&#x9884;&#x70ED;&#x6A21;&#x5F0F;&#x9700;&#x8981;&#x6B64;&#x53C2;&#x6570;&#xFF09;</span><br><span class="line">    &quot;warmUpPeriodSec&quot;: 10,</span><br><span class="line">    // &#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF08;&#x6392;&#x961F;&#x7B49;&#x5F85;&#x6A21;&#x5F0F;&#x9700;&#x8981;&#x6B64;&#x53C2;&#x6570;&#xFF09;</span><br><span class="line">    &quot;maxQueueingTimeMs&quot;: 500,</span><br><span class="line">    // &#x5173;&#x8054;&#x8D44;&#x6E90;&#x3001;&#x5165;&#x53E3;&#x8D44;&#x6E90;(&#x5173;&#x8054;&#x3001;&#x94FE;&#x8DEF;&#x6A21;&#x5F0F;)</span><br><span class="line">    &quot;refResource&quot;: &quot;rrr&quot;</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>2&#x3001;&#x964D;&#x7EA7;&#x89C4;&#x5219;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;[</span><br><span class="line">  {</span><br><span class="line">  	// &#x8D44;&#x6E90;&#x540D;</span><br><span class="line">    &quot;resource&quot;: &quot;/test1&quot;,</span><br><span class="line">    &quot;limitApp&quot;: &quot;default&quot;,</span><br><span class="line">    // &#x7194;&#x65AD;&#x7B56;&#x7565;&#xFF08;0:&#x6162;&#x8C03;&#x7528;&#x6BD4;&#x4F8B;&#xFF0C;1:&#x5F02;&#x5E38;&#x6BD4;&#x7387;&#xFF0C;2:&#x5F02;&#x5E38;&#x8BA1;&#x6570;&#xFF09;</span><br><span class="line">    &quot;grade&quot;: 0,</span><br><span class="line">    // &#x6700;&#x5927;RT&#x3001;&#x6BD4;&#x4F8B;&#x9608;&#x503C;&#x3001;&#x5F02;&#x5E38;&#x6570;</span><br><span class="line">    &quot;count&quot;: 200,</span><br><span class="line">    // &#x6162;&#x8C03;&#x7528;&#x6BD4;&#x4F8B;&#x9608;&#x503C;&#xFF0C;&#x4EC5;&#x6162;&#x8C03;&#x7528;&#x6BD4;&#x4F8B;&#x6A21;&#x5F0F;&#x6709;&#x6548;&#xFF08;1.8.0 &#x5F15;&#x5165;&#xFF09;</span><br><span class="line">    &quot;slowRatioThreshold&quot;: 0.2,</span><br><span class="line">    // &#x6700;&#x5C0F;&#x8BF7;&#x6C42;&#x6570;</span><br><span class="line">    &quot;minRequestAmount&quot;: 5,</span><br><span class="line">    // &#x5F53;&#x5355;&#x4F4D;&#x7EDF;&#x8BA1;&#x65F6;&#x957F;(&#x7C7B;&#x4E2D;&#x9ED8;&#x8BA4;1000)</span><br><span class="line">    &quot;statIntervalMs&quot;: 1000,</span><br><span class="line">    // &#x7194;&#x65AD;&#x65F6;&#x957F;</span><br><span class="line">    &quot;timeWindow&quot;: 10</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>3&#x3001;&#x70ED;&#x70B9;&#x89C4;&#x5219;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ruby&#x590D;&#x5236;&#x4EE3;&#x7801;[</span><br><span class="line">  {</span><br><span class="line">  	// &#x8D44;&#x6E90;&#x540D;</span><br><span class="line">    &quot;resource&quot;: &quot;/test1&quot;,</span><br><span class="line">    // &#x9650;&#x6D41;&#x6A21;&#x5F0F;&#xFF08;QPS &#x6A21;&#x5F0F;&#xFF0C;&#x4E0D;&#x53EF;&#x66F4;&#x6539;&#xFF09;</span><br><span class="line">    &quot;grade&quot;: 1,</span><br><span class="line">    // &#x53C2;&#x6570;&#x7D22;&#x5F15;</span><br><span class="line">    &quot;paramIdx&quot;: 0,</span><br><span class="line">    // &#x5355;&#x673A;&#x9608;&#x503C;</span><br><span class="line">    &quot;count&quot;: 13,</span><br><span class="line">    // &#x7EDF;&#x8BA1;&#x7A97;&#x53E3;&#x65F6;&#x957F;</span><br><span class="line">    &quot;durationInSec&quot;: 6,</span><br><span class="line">    // &#x662F;&#x5426;&#x96C6;&#x7FA4; &#x9ED8;&#x8BA4;false</span><br><span class="line">    &quot;clusterMode&quot;: &#x9ED8;&#x8BA4;false,</span><br><span class="line">    // </span><br><span class="line">    &quot;burstCount&quot;: 0,</span><br><span class="line">    // &#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#x914D;&#x7F6E;</span><br><span class="line">    &quot;clusterConfig&quot;: {</span><br><span class="line">      // </span><br><span class="line">      &quot;fallbackToLocalWhenFail&quot;: true,</span><br><span class="line">   	  // </span><br><span class="line">      &quot;flowId&quot;: 2,</span><br><span class="line">      // </span><br><span class="line">      &quot;sampleCount&quot;: 10,</span><br><span class="line">      // </span><br><span class="line">      &quot;thresholdType&quot;: 0,</span><br><span class="line">      // </span><br><span class="line">      &quot;windowIntervalMs&quot;: 1000</span><br><span class="line">    },</span><br><span class="line">    // &#x6D41;&#x63A7;&#x6548;&#x679C;&#xFF08;&#x652F;&#x6301;&#x5FEB;&#x901F;&#x5931;&#x8D25;&#x548C;&#x5300;&#x901F;&#x6392;&#x961F;&#x6A21;&#x5F0F;&#xFF09;</span><br><span class="line">    &quot;controlBehavior&quot;: 0,</span><br><span class="line">    // </span><br><span class="line">    &quot;limitApp&quot;: &quot;default&quot;,</span><br><span class="line">    // </span><br><span class="line">    &quot;maxQueueingTimeMs&quot;: 0,</span><br><span class="line">    // &#x9AD8;&#x7EA7;&#x9009;&#x9879;</span><br><span class="line">    &quot;paramFlowItemList&quot;: [</span><br><span class="line">      {</span><br><span class="line">      	// &#x53C2;&#x6570;&#x7C7B;&#x578B;</span><br><span class="line">        &quot;classType&quot;: &quot;int&quot;,</span><br><span class="line">      	// &#x9650;&#x6D41;&#x9608;&#x503C;</span><br><span class="line">        &quot;count&quot;: 222,</span><br><span class="line">      	// &#x53C2;&#x6570;&#x503C;</span><br><span class="line">        &quot;object&quot;: &quot;2&quot;</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>4&#x3001;&#x7CFB;&#x7EDF;&#x89C4;&#x5219;</strong></p>
<p>&#x8D1F;&#x503C;&#x8868;&#x793A;&#x6CA1;&#x6709;&#x9608;&#x503C;&#x68C0;&#x67E5;&#x3002;<code>&#x4E0D;&#x9700;&#x8981;&#x5220;&#x9664;&#x53C2;&#x6570;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;[</span><br><span class="line">  {</span><br><span class="line">  	// RT</span><br><span class="line">    &quot;avgRt&quot;: 1,</span><br><span class="line">    // CPU &#x4F7F;&#x7528;&#x7387;</span><br><span class="line">    &quot;highestCpuUsage&quot;: -1,</span><br><span class="line">    // LOAD</span><br><span class="line">    &quot;highestSystemLoad&quot;: -1,</span><br><span class="line">    // &#x7EBF;&#x7A0B;&#x6570;</span><br><span class="line">    &quot;maxThread&quot;: -1,</span><br><span class="line">    // &#x5165;&#x53E3; QPS</span><br><span class="line">    &quot;qps&quot;: -1</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>5&#x3001;&#x6388;&#x6743;&#x89C4;&#x5219;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">json&#x590D;&#x5236;&#x4EE3;&#x7801;[</span><br><span class="line">  {</span><br><span class="line">    // &#x8D44;&#x6E90;&#x540D;</span><br><span class="line">    &quot;resource&quot;: &quot;sentinel_spring_web_context&quot;,</span><br><span class="line">  	// &#x6D41;&#x63A7;&#x5E94;&#x7528;</span><br><span class="line">    &quot;limitApp&quot;: &quot;/test&quot;,</span><br><span class="line">    // &#x6388;&#x6743;&#x7C7B;&#x578B;(0&#x4EE3;&#x8868;&#x767D;&#x540D;&#x5355;&#xFF1B;1&#x4EE3;&#x8868;&#x9ED1;&#x540D;&#x5355;&#x3002;)</span><br><span class="line">    &quot;strategy&quot;: 0</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x5BF9;&#x4E8E;&#x4E0A;&#x8FF0;JOSN&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x53EF;&#x9009;&#x5C5E;&#x6027;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x65F6;&#x5019;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#x3002;</p>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<h2 id="15&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x63A8;&#x9001;&#x5230;Nacos&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#xFF1F;"><a href="#15&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x63A8;&#x9001;&#x5230;Nacos&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#xFF1F;" class="headerlink" title="15&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x63A8;&#x9001;&#x5230;Nacos&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#xFF1F;"></a>15&#x3001;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5982;&#x4F55;&#x63A8;&#x9001;&#x5230;Nacos&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#xFF1F;</h2><p>sentinel&#x9ED8;&#x8BA4;&#x7684;&#x6301;&#x4E45;&#x5316;&#x53EA;&#x80FD;&#x4ECE;nacos&#x63A8;&#x9001;&#x5230;sentinel&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x751F;&#x4EA7;&#x4E2D;&#x80AF;&#x5B9A;&#x662F;&#x53CC;&#x5411;&#x4FEE;&#x6539;&#x90FD;&#x80FD;&#x63A8;&#x9001;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x5462;&#xFF1F;</p>
<p>&#x5176;&#x5B9E;sentinel&#x5B98;&#x65B9;&#x6587;&#x6863;&#x5C31;&#x6709;&#x8BF4;&#x5230;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#xFF0C;&#x4E0D;&#x8FC7;&#x9700;&#x8981;<strong>&#x81EA;&#x5DF1;&#x4FEE;&#x6539;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x6E90;&#x7801;</strong>&#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#xFF0C;sentinel&#x53EA;&#x5E2E;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x7684;demo&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x8FD8;&#x662F;&#x8981;&#x81EA;&#x5DF1;&#x4FEE;&#x6539;&#xFF0C;&#x8FD9;&#x70B9;&#x4E0D;&#x592A;&#x4EBA;&#x6027;&#x5316;&#x2026;.</p>
<p>&#x5728;&#x8FD9;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x4E0B;&#x8F7D;&#x5BF9;&#x5E94;&#x7248;&#x672C;&#x7684;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/12b9a483ac0d15a0cc4e949490496035.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
<h3 id="&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x6E90;&#x7801;&#x4FEE;&#x6539;"><a href="#&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x6E90;&#x7801;&#x4FEE;&#x6539;" class="headerlink" title="&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x6E90;&#x7801;&#x4FEE;&#x6539;"></a>&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x6E90;&#x7801;&#x4FEE;&#x6539;</h3><p>&#x5728;&#x6E90;&#x7801;&#x7684;test&#x76EE;&#x5F55;&#x4E0B;&#x6709;sentinel&#x63D0;&#x4F9B;&#x7684;demo&#xFF0C;&#x5206;&#x522B;&#x6709;apollo&#x3001;nacos&#x3001;zookeeper&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/9a7621b2e97c2cf1bc215a76981926ded70eab0e48afe18d8965552c73ef5ddc" alt></p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x662F;Nacos&#xFF0C;&#x56E0;&#x6B64;&#x53EA;&#x9700;&#x8981;nacos&#x5305;&#x4E0B;&#x9762;&#x7684;demo&#x3002;&#x4FEE;&#x6539;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><strong>1&#x3001;&#x53BB;&#x6389;sentinel-datasource-nacos&#x4F9D;&#x8D56;&#x7684;scop</strong></p>
<p>&#x8FD9;&#x4E2A;sentinel-datasource-nacos&#x4F9D;&#x8D56;&#x9ED8;&#x8BA4;&#x662F;<code>&lt;scope&gt;test&lt;/scope&gt;</code>&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x53BB;&#x6389;&#x8FD9;&#x4E2A;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;!-- for Nacos rule publisher sample --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">       &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x5982;&#x679C;&#x4F60;&#x96C6;&#x6210;&#x7684;zookeeper&#x6216;&#x8005;apollo&#xFF0C;&#x5219;&#x628A;&#x76F8;&#x5E94;&#x7684;&#x4F9D;&#x8D56;&#x4E5F;&#x8981;&#x4FEE;&#x6539;&#x3002;</p>
</blockquote>
<p><strong>2&#x3001;&#x590D;&#x5236;test&#x73AF;&#x5883;&#x4E0B;&#x7684;nacos&#x6574;&#x4E2A;&#x5305;&#x5230;main&#x4E0B;</strong></p>
<p>&#x5C06;&#x8FD9;&#x4E2A;nacos&#x5305;&#x590D;&#x5236;&#x5230;<code>com.alibaba.csp.sentinel.dashboard.rule</code>&#x8FD9;&#x4E2A;&#x5305;&#x4E0B;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/b684e92a7557adb6166787730efd2bd1958c6926a92ed49cfa41d780eaba4484" alt></p>
<p><strong>3&#x3001;&#x5C06;FlowControllerV2&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x590D;&#x5236;&#x5230;FlowControllerV1&#x4E2D;</strong></p>
<p><code>com.alibaba.csp.sentinel.dashboard.controller.v2.FlowControllerV2</code>&#x8FD9;&#x4E2A;&#x662F;sentinel&#x63D0;&#x4F9B;&#x7684;demo&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x5176;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x5168;&#x90E8;&#x8986;&#x76D6;&#x5230;<code>com.alibaba.csp.sentinel.dashboard.controller.FlowControllerV1</code>&#x4E2D;&#x3002;</p>
<p><strong>4&#x3001;&#x4FEE;&#x6539;FlowControllerV1&#x4E2D;&#x7684;&#x4EE3;&#x7801;</strong></p>
<p>&#x76F4;&#x63A5;&#x8986;&#x76D6;&#x6389;&#x5F53;&#x7136;&#x4E0D;&#x884C;&#xFF0C;&#x8FD8;&#x8981;&#x505A;&#x4E00;&#x4E9B;&#x4FEE;&#x6539;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x4FEE;&#x6539;RequestMapping&#x4E2D;&#x7684;&#x8BF7;&#x6C42;url&#x4E3A;<code>/v1/flow</code></li>
<li>&#x4FEE;&#x6539;<code>ruleProvider</code>&#x3001;<code>rulePublisher</code>&#x7684;&#x4F9D;&#x8D56;&#xFF0C;&#x4FEE;&#x6539;&#x540E;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@Autowired</span><br><span class="line">//&#x4F7F;&#x7528;nacos&#x7684;&#x4F9D;&#x8D56;</span><br><span class="line">@Qualifier(&quot;flowRuleNacosProvider&quot;)</span><br><span class="line">private DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;</span><br><span class="line">@Autowired</span><br><span class="line">//&#x4F7F;&#x7528;nacos&#x7684;&#x4F9D;&#x8D56;</span><br><span class="line">@Qualifier(&quot;flowRuleNacosPublisher&quot;)</span><br><span class="line">private DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;</span><br></pre></td></tr></table></figure>

<p><strong>5&#x3001;&#x6CE8;&#x610F;nacos&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;</strong></p>
<p><code>com.alibaba.csp.sentinel.dashboard.rule.nacos.NacosConfigUtil</code>&#x8FD9;&#x4E2A;&#x5DE5;&#x5177;&#x7C7B;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x662F;&#x9650;&#x6D41;&#x89C4;&#x5219;&#x5728;nacos&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x9879;&#xFF0C;&#x6709;<code>groupId</code>&#x3001;<code>dataId</code>&#x2026;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/0b073fed1faa90c1bc1c5fb436214076f8dc3463722dce2012b104fbce04bb28" alt></p>
<p><strong>&#x9700;&#x8981;&#x4E24;&#x8FB9;&#x7EDF;&#x4E00;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x4FEE;&#x6539;&#x3002;</strong></p>
<p><code>com.alibaba.csp.sentinel.dashboard.rule.nacos.NacosConfig</code>&#x8FD9;&#x4E2A;&#x7C7B;&#x4E2D;&#x6709;&#x4E2A;&#x65B9;&#x6CD5;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ed0d8d0ee5f47da3b9af650e4eb76bb4c8abd41c23adf0fb85373d0d76ea623d" alt></p>
<p><strong>&#x9ED8;&#x8BA4;&#x6307;&#x5B9A;&#x7684;nacos&#x5730;&#x5740;&#x662F;&#x672C;&#x5730;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x3002;</strong></p>
<p><strong>6&#x3001;&#x5B8C;&#x6210;</strong></p>
<p>&#x4EE5;&#x4E0A;&#x6B65;&#x9AA4;&#x5DF2;&#x7ECF;&#x6539;&#x9020;&#x4E86;sentinel&#x63A7;&#x5236;&#x53F0;&#x7684;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#xFF0C;&#x6253;&#x5305;&#x542F;&#x52A8;&#x63A7;&#x5236;&#x53F0;&#x4EE3;&#x7801;&#xFF0C;&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;mvn clean install -DskipTests=true -pl sentinel-dashboard -am</span><br></pre></td></tr></table></figure>

<p>&#x542F;&#x52A8;&#x540E;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x6DFB;&#x52A0;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E5F;&#x4F1A;&#x540C;&#x6B65;&#x63A8;&#x9001;&#x5230;nacos&#xFF0C;&#x5305;&#x62EC;&#x589E;&#x5220;&#x6539;&#x3002;</p>
<blockquote>
<p>&#x5176;&#x4ED6;&#x89C4;&#x5219;&#x4FEE;&#x6539;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x7167;&#x846B;&#x82A6;&#x753B;&#x74E2;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x8BE6;&#x7EC6;&#x8BF4;&#x4E86;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x51FA;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x8BE6;&#x7EC6;&#x8BF4;&#x4E00;&#x4E0B;&#x3002;</p>
</blockquote>
<h2 id="16&#x3001;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5982;&#x4F55;&#x505A;&#xFF1F;"><a href="#16&#x3001;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5982;&#x4F55;&#x505A;&#xFF1F;" class="headerlink" title="16&#x3001;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5982;&#x4F55;&#x505A;&#xFF1F;"></a>16&#x3001;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5982;&#x4F55;&#x505A;&#xFF1F;</h2><p>&#x9996;&#x5148;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x95EE;&#x9898;&#xFF1A;**&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#xFF1F;**&#x5355;&#x673A;&#x6D41;&#x63A7;&#x4E0D;&#x9999;&#x5417;&#xFF1F;&#x539F;&#x56E0;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x5BF9;&#x4E8E;&#x5FAE;&#x670D;&#x52A1;&#x8981;&#x60F3;&#x4FDD;&#x8BC1;&#x9AD8;&#x53EF;&#x7528;&#xFF0C;&#x5FC5;&#x987B;&#x662F;&#x96C6;&#x7FA4;&#xFF0C;&#x5047;&#x8BBE;&#x6709;100&#x4E2A;&#x96C6;&#x7FA4;&#xFF0C;&#x90A3;&#x4E48;&#x60F3;&#x8981;&#x8BBE;&#x7F6E;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x6BCF;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#x90FD;&#x8981;&#x8BBE;&#x7F6E;&#x4E00;&#x904D;&#xFF1F;&#x7EF4;&#x62A4;&#x6210;&#x672C;&#x592A;&#x9AD8;&#x4E86;</li>
<li>&#x5355;&#x4F53;&#x6D41;&#x63A7;&#x8FD8;&#x4F1A;&#x9020;&#x6210;<strong>&#x6D41;&#x91CF;&#x4E0D;&#x5747;&#x5300;</strong>&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x51FA;&#x73B0;&#x603B;&#x6D41;&#x63A7;&#x9608;&#x503C;&#x6CA1;&#x6709;&#x8FBE;&#x5230;&#x67D0;&#x4E9B;&#x5FAE;&#x670D;&#x52A1;&#x5DF2;&#x7ECF;&#x88AB;&#x9650;&#x6D41;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;&#x975E;&#x5E38;&#x7CDF;&#x7CD5;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x6B64;&#x5B9E;&#x9645;&#x751F;&#x4EA7;&#x4E2D;&#x5BF9;&#x4E8E;&#x96C6;&#x7FA4;&#x4E0D;&#x63A8;&#x8350;&#x5355;&#x4F53;&#x6D41;&#x63A7;&#x3002;</li>
</ul>
<p>&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x4E0A;&#x8FF0;&#x7684;&#x95EE;&#x9898;&#x5462;&#xFF1F;sentinel&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x7684;&#x89C4;&#x5219;&#x3002;&#x601D;&#x60F3;&#x5F88;&#x7B80;&#x5355;&#x5C31;&#x662F;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x4E13;&#x95E8;&#x7684;server&#x6765;&#x7EDF;&#x8BA1;&#x8C03;&#x7528;&#x7684;&#x603B;&#x91CF;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5B9E;&#x4F8B;&#x90FD;&#x4E0E;server&#x4FDD;&#x6301;&#x901A;&#x4FE1;&#x3002;</p>
<p>&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x53EF;&#x4EE5;&#x7CBE;&#x786E;&#x5730;&#x63A7;&#x5236;&#x6574;&#x4E2A;&#x96C6;&#x7FA4;&#x7684;<strong>&#x8C03;&#x7528;&#x603B;&#x91CF;</strong>&#xFF0C;&#x7ED3;&#x5408;<strong>&#x5355;&#x673A;&#x9650;&#x6D41;&#x515C;&#x5E95;</strong>&#xFF0C;&#x53EF;&#x4EE5;&#x66F4;&#x597D;&#x5730;&#x53D1;&#x6325;&#x6D41;&#x91CF;&#x63A7;&#x5236;&#x7684;&#x6548;&#x679C;&#x3002;</p>
<p>&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x4E2D;&#x5171;&#x6709;&#x4E24;&#x79CD;&#x8EAB;&#x4EFD;&#xFF1A;</p>
<ul>
<li><strong>Token Client</strong>&#xFF1A;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x7528;&#x4E8E;&#x5411;&#x6240;&#x5C5E; Token Server &#x901A;&#x4FE1;&#x8BF7;&#x6C42; token&#x3002;&#x96C6;&#x7FA4;&#x9650;&#x6D41;&#x670D;&#x52A1;&#x7AEF;&#x4F1A;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7ED3;&#x679C;&#xFF0C;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x9650;&#x6D41;&#x3002;</li>
<li><strong>Token Server</strong>&#xFF1A;&#x5373;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x5904;&#x7406;&#x6765;&#x81EA; Token Client &#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x7684;&#x96C6;&#x7FA4;&#x89C4;&#x5219;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x53D1;&#x653E; token&#xFF08;&#x662F;&#x5426;&#x5141;&#x8BB8;&#x901A;&#x8FC7;&#xFF09;&#x3002;</li>
</ul>
<p>sentinel&#x7684;&#x96C6;&#x7FA4;&#x9650;&#x6D41;&#x6709;&#x4E24;&#x79CD;&#x6A21;&#x5F0F;&#xFF0C;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li><strong>&#x72EC;&#x7ACB;&#x6A21;&#x5F0F;&#xFF08;Alone&#xFF09;</strong>&#xFF1A;&#x5373;&#x4F5C;&#x4E3A;&#x72EC;&#x7ACB;&#x7684; token server &#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#xFF0C;&#x72EC;&#x7ACB;&#x90E8;&#x7F72;&#xFF0C;&#x9694;&#x79BB;&#x6027;&#x597D;&#xFF0C;&#x4F46;&#x662F;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x90E8;&#x7F72;&#x64CD;&#x4F5C;&#x3002;&#x72EC;&#x7ACB;&#x6A21;&#x5F0F;&#x9002;&#x5408;&#x4F5C;&#x4E3A; Global Rate Limiter &#x7ED9;&#x96C6;&#x7FA4;&#x63D0;&#x4F9B;&#x6D41;&#x63A7;&#x670D;&#x52A1;&#x3002;</li>
<li><strong>&#x5D4C;&#x5165;&#x6A21;&#x5F0F;&#xFF08;Embedded&#xFF09;</strong>&#xFF1A;&#x5373;&#x4F5C;&#x4E3A;&#x5185;&#x7F6E;&#x7684; token server &#x4E0E;&#x670D;&#x52A1;&#x5728;&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E2D;&#x542F;&#x52A8;&#x3002;&#x5728;&#x6B64;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x96C6;&#x7FA4;&#x4E2D;&#x5404;&#x4E2A;&#x5B9E;&#x4F8B;&#x90FD;&#x662F;&#x5BF9;&#x7B49;&#x7684;&#xFF0C;token server &#x548C; client &#x53EF;&#x4EE5;&#x968F;&#x65F6;&#x8FDB;&#x884C;&#x8F6C;&#x53D8;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x9700;&#x5355;&#x72EC;&#x90E8;&#x7F72;&#xFF0C;&#x7075;&#x6D3B;&#x6027;&#x6BD4;&#x8F83;&#x597D;&#x3002;&#x4F46;&#x662F;&#x9694;&#x79BB;&#x6027;&#x4E0D;&#x4F73;&#xFF0C;&#x9700;&#x8981;&#x9650;&#x5236; token server &#x7684;&#x603B; QPS&#xFF0C;&#x9632;&#x6B62;&#x5F71;&#x54CD;&#x5E94;&#x7528;&#x672C;&#x8EAB;&#x3002;&#x5D4C;&#x5165;&#x6A21;&#x5F0F;&#x9002;&#x5408;&#x67D0;&#x4E2A;&#x5E94;&#x7528;&#x96C6;&#x7FA4;&#x5185;&#x90E8;&#x7684;&#x6D41;&#x63A7;&#x3002;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x5C31;&#x4EE5;&#x5D4C;&#x5165;&#x6A21;&#x5F0F;&#x4E3A;&#x4F8B;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x5C31;&#x4EE5;<code>sentinel-openfeign-provider9009</code>&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x4F5C;&#x4E3A;&#x6F14;&#x793A;&#xFF0C;&#x76F4;&#x63A5;&#x542F;&#x52A8;&#x4E09;&#x4E2A;&#x96C6;&#x7FA4;&#xFF0C;&#x7AEF;&#x53E3;&#x5206;&#x522B;&#x4E3A;<code>9009</code>&#x3001;<code>9011</code>&#x3001;<code>9013</code>&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/630ff5d4a84ef3fc5f8be3dd43655ab3accf39fed84919a502ae201a81ab0885" alt></p>
<p>&#x542F;&#x52A8;&#x6210;&#x529F;&#xFF0C;&#x5728;sentinel&#x63A7;&#x5236;&#x53F0;&#x5C06;&#x4F1A;&#x770B;&#x5230;&#x6709;&#x4E09;&#x4E2A;&#x5B9E;&#x4F8B;&#x5DF2;&#x7ECF;&#x88AB;&#x76D1;&#x63A7;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/bbdcc35004e7e656385d7c445a9ee21df15a7a3a63be8fdde4c640900d392da7" alt></p>
<p>&#x6B64;&#x65F6;&#x53EA;&#x9700;&#x8981;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x4E3A;token server&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x4E3A;token client&#xFF0C;<strong>&#x96C6;&#x7FA4;&#x6D41;&#x63A7;-&gt;&#x65B0;&#x589E;token server</strong>&#xFF0C;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/5ecd867d08571eb4d3e3f85e2dd10ff9c72f4ed400e73a2a63f1d530c8ba1e33" alt></p>
<p>&#x9009;&#x53D6;&#x4E00;&#x4E2A;&#x4F5C;&#x4E3A;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x53E6;&#x5916;&#x4E24;&#x4E2A;&#x4F5C;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x5DF2;&#x7ECF;&#x914D;&#x7F6E;&#x597D;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/0ad520094789bf37c67f76111e109e6df735182c34634826c1ad044786191d2e" alt></p>
<p>&#x6B64;&#x65F6;&#x5C31;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;sentinel&#x63A7;&#x5236;&#x53F0;&#x76F4;&#x63A5;&#x6DFB;&#x52A0;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Nacos&#x76F4;&#x63A5;&#x914D;&#x7F6E;&#xFF0C;&#x4E0B;&#x56FE;&#x662F;&#x901A;&#x8FC7;Nacos&#x914D;&#x7F6E;&#x7684;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ec8cac0b91d3ea29e1d10d2b3222ff18f6d2af3220165485ef8555e02d6a4a9e" alt></p>
<p>Nacos&#x63A8;&#x9001;&#x6210;&#x529F;&#x540E;&#x5C06;&#x4F1A;&#x5728;sentinel&#x63A7;&#x5236;&#x53F0;&#x770B;&#x5230;&#x8FD9;&#x6761;&#x6D41;&#x63A7;&#x89C4;&#x5219;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/b47ffcf39d87f33eddbbd544ab5ffa017f592d9f702bdeba1e2e20446393a415" alt></p>
<p>OK&#xFF0C;&#x81F3;&#x6B64;&#x96C6;&#x7FA4;&#x6D41;&#x63A7;&#x5230;&#x8FD9;&#x513F;&#x5C31;&#x4ECB;&#x7ECD;&#x5B8C;&#x4E86;&#xFF0C;&#x914D;&#x7F6E;&#x597D;&#x4E4B;&#x540E;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x8BD5;&#x4E00;&#x4E0B;&#x6548;&#x679C;&#xFF0C;&#x9648;&#x67D0;&#x5C31;&#x4E0D;&#x518D;&#x6F14;&#x793A;&#x4E86;&#x3002;</p>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<h2 id="17&#x3001;&#x7F51;&#x5173;&#x9650;&#x6D41;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"><a href="#17&#x3001;&#x7F51;&#x5173;&#x9650;&#x6D41;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;" class="headerlink" title="17&#x3001;&#x7F51;&#x5173;&#x9650;&#x6D41;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;"></a>17&#x3001;&#x7F51;&#x5173;&#x9650;&#x6D41;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#xFF1F;</h2><p>&#x8FD9;&#x4E00;&#x5757;&#x5185;&#x5BB9;&#x5728;&#x540E;&#x7EED;&#x4ECB;&#x7ECD;&#x5230;&#x7F51;&#x5173;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BB2;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x7EC6;&#x8BF4;&#x4E86;&#xFF0C;&#x6709;&#x60F3;&#x8981;&#x4E86;&#x89E3;&#x7684;&#x53EF;&#x4EE5;&#x770B;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x3002;</p>
<blockquote>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;<a href="/external_links/5b7ba974ebfc3c9d89e53d1b9323af4a.html" target="blank" rel="noopener">github.com/alibaba/Sen&#x2026;</a></p>
</blockquote>
<h2 id="18&#x3001;&#x6574;&#x5408;openFeign&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF1F;"><a href="#18&#x3001;&#x6574;&#x5408;openFeign&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF1F;" class="headerlink" title="18&#x3001;&#x6574;&#x5408;openFeign&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF1F;"></a>18&#x3001;&#x6574;&#x5408;openFeign&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7194;&#x65AD;&#x964D;&#x7EA7;&#xFF1F;</h2><p>&#x8FD9;&#x4E2A;&#x5728;&#x4E0A;&#x7BC7;openFeign&#x7684;&#x6587;&#x7AE0;&#x4E2D;&#x6709;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#xFF1A;<a href="/external_links/5c7d44ecfa56a6bc90f44052e3ba4201.html" target="blank" rel="noopener">openFeign&#x593A;&#x547D;&#x8FDE;&#x73AF;9&#x95EE;&#xFF0C;&#x8FD9;&#x8C01;&#x53D7;&#x5F97;&#x4E86;&#xFF1F;</a>&#x9648;&#x67D0;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x91CD;&#x590D;&#x4ECB;&#x7ECD;&#x4E86;&#xFF0C;&#x6709;&#x4E0D;&#x77E5;&#x9053;&#x7684;&#x53EF;&#x4EE5;&#x770B;&#x4E0A;&#x9762;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/bbdb9c793d7bf71af960422b9e159795.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016871607847092232.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016871607847092232.html" itemprop="url">还在用http工具类?一行代码解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-09T09:28:06+08:00">
                2021-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</p>
<h2 id="&#x4EE5;&#x524D;&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;"><a href="#&#x4EE5;&#x524D;&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;" class="headerlink" title="&#x4EE5;&#x524D;&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;"></a>&#x4EE5;&#x524D;&#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;</h2><p>&#x6700;&#x8FD1;&#x9879;&#x76EE;&#x4E0A;&#x6709;&#x4E2A;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x7684;&#x9700;&#x6C42;.&#x5C31;&#x5F00;&#x59CB;&#x627E;&#x9879;&#x76EE;&#x91CC;&#x7684;&#x5DE5;&#x5177;&#x7C7B;.<br>&#x53D1;&#x73B0;&#x9879;&#x76EE;&#x91CC;&#x7684;http&#x5DE5;&#x5177;&#x7C7B;&#x4E94;&#x82B1;&#x516B;&#x95E8; &#x8BF7;&#x6C42;&#x4EE3;&#x7801;&#x8FC7;&#x957F;&#x4E0D;&#x591F;&#x4F18;&#x96C5;. &#x5177;&#x4F53;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x4E0D;&#x8D34;&#x4E86; &#x592A;&#x5360;&#x5730;&#x65B9;.<br>`</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;private static HttpsURLConnection initHttps(String url, String method,</span><br><span class="line">        Map&lt;String, String&gt; headers) throws Exception {</span><br><span class="line">    TrustManager[] tm = { new MyX509TrustManager() };</span><br><span class="line">    System.setProperty(&quot;https.protocols&quot;, &quot;TLSv1&quot;);</span><br><span class="line">    SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);</span><br><span class="line">    sslContext.init(null, tm, new java.security.SecureRandom());</span><br><span class="line">    // &#x4ECE;&#x4E0A;&#x8FF0;SSLContext&#x5BF9;&#x8C61;&#x4E2D;&#x5F97;&#x5230;SSLSocketFactory&#x5BF9;&#x8C61;</span><br><span class="line">    SSLSocketFactory ssf = sslContext.getSocketFactory();</span><br><span class="line">    URL _url = new URL(url);</span><br><span class="line">    HttpsURLConnection http = (HttpsURLConnection) _url.openConnection();</span><br><span class="line">    // &#x8BBE;&#x7F6E;&#x57DF;&#x540D;&#x6821;&#x9A8C;</span><br><span class="line">    http.setHostnameVerifier(new HttpUtil().new TrustAnyHostnameVerifier());</span><br><span class="line">    // &#x8FDE;&#x63A5;&#x8D85;&#x65F6;</span><br><span class="line">    http.setConnectTimeout(DEF_CONN_TIMEOUT);</span><br><span class="line">    // &#x8BFB;&#x53D6;&#x8D85;&#x65F6; --&#x670D;&#x52A1;&#x5668;&#x54CD;&#x5E94;&#x6BD4;&#x8F83;&#x6162;&#xFF0C;&#x589E;&#x5927;&#x65F6;&#x95F4;</span><br><span class="line">    http.setReadTimeout(DEF_READ_TIMEOUT);</span><br><span class="line">    http.setUseCaches(false);</span><br><span class="line">    http.setRequestMethod(method);</span><br><span class="line">    http.setRequestProperty(&quot;Content-Type&quot;,</span><br><span class="line">            &quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">    http.setRequestProperty(</span><br><span class="line">            &quot;User-Agent&quot;,</span><br><span class="line">            &quot;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.146 Safari/537.36&quot;);</span><br><span class="line">    if (null != headers &amp;&amp; !headers.isEmpty()) {</span><br><span class="line">        for (Entry&lt;String, String&gt; entry : headers.entrySet()) {</span><br><span class="line">            http.setRequestProperty(entry.getKey(), entry.getValue());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    http.setSSLSocketFactory(ssf);</span><br><span class="line">    http.setDoOutput(true);</span><br><span class="line">    http.setDoInput(true);</span><br><span class="line">    http.connect();</span><br><span class="line">    return http;</span><br><span class="line">}</span><br><span class="line">public static String get(String url, Map&lt;String, String&gt; params,</span><br><span class="line">        Map&lt;String, String&gt; headers) throws Exception {</span><br><span class="line">    HttpURLConnection http = null;</span><br><span class="line">    if (isHttps(url)) {</span><br><span class="line">        http = initHttps(initParams(url, params), _GET, headers);</span><br><span class="line">    } else {</span><br><span class="line">        http = initHttp(initParams(url, params), _GET, headers);</span><br><span class="line">    }</span><br><span class="line">    InputStream in = http.getInputStream();</span><br><span class="line">    BufferedReader read = new BufferedReader(new InputStreamReader(in,</span><br><span class="line">            DEFAULT_CHARSET));</span><br><span class="line">    String valueString = null;</span><br><span class="line">    StringBuffer bufferRes = new StringBuffer();</span><br><span class="line">    while ((valueString = read.readLine()) != null) {</span><br><span class="line">        bufferRes.append(valueString);</span><br><span class="line">    }</span><br><span class="line">    in.close();</span><br><span class="line">    if (http != null) {</span><br><span class="line">        http.disconnect();// &#x5173;&#x95ED;&#x8FDE;&#x63A5;</span><br><span class="line">    }</span><br><span class="line">    return bufferRes.toString();</span><br><span class="line">}</span><br><span class="line">public static String post(String url, String params)</span><br><span class="line">        throws Exception {</span><br><span class="line">    HttpURLConnection http = null;</span><br><span class="line">    if (isHttps(url)) {</span><br><span class="line">        http = initHttps(url, _POST, null);</span><br><span class="line">    } else {</span><br><span class="line">        http = initHttp(url, _POST, null);</span><br><span class="line">    }</span><br><span class="line">    OutputStream out = http.getOutputStream();</span><br><span class="line">    out.write(params.getBytes(DEFAULT_CHARSET));</span><br><span class="line">    out.flush();</span><br><span class="line">    out.close();</span><br><span class="line"></span><br><span class="line">    InputStream in = http.getInputStream();</span><br><span class="line">    BufferedReader read = new BufferedReader(new InputStreamReader(in,</span><br><span class="line">            DEFAULT_CHARSET));</span><br><span class="line">    String valueString = null;</span><br><span class="line">    StringBuffer bufferRes = new StringBuffer();</span><br><span class="line">    while ((valueString = read.readLine()) != null) {</span><br><span class="line">        bufferRes.append(valueString);</span><br><span class="line">    }</span><br><span class="line">    in.close();</span><br><span class="line">    if (http != null) {</span><br><span class="line">        http.disconnect();// &#x5173;&#x95ED;&#x8FDE;&#x63A5;</span><br><span class="line">    }</span><br><span class="line">    return bufferRes.toString();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x94FE;&#x5F0F;&#x8C03;&#x7528;"><a href="#&#x94FE;&#x5F0F;&#x8C03;&#x7528;" class="headerlink" title="&#x94FE;&#x5F0F;&#x8C03;&#x7528;"></a>&#x94FE;&#x5F0F;&#x8C03;&#x7528;</h2><p>&#x5C31;&#x60F3;&#x7740;&#x6709;&#x6CA1;&#x6709;&#x65B9;&#x4FBF;&#x5F00;&#x7BB1;&#x5C31;&#x7528;&#x7684;&#x8BF7;&#x6C42;&#x6846;&#x67B6;&#x2026;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x6B3E;&#x53EF;&#x4EE5;&#x94FE;&#x5F0F;&#x8C03;&#x7528;&#x7684;OkHttps&#x6846;&#x67B6;&#x5F88;&#x597D;&#x7528;.</p>
<h3 id="&#x8C03;&#x7528;&#x793A;&#x4F8B;"><a href="#&#x8C03;&#x7528;&#x793A;&#x4F8B;" class="headerlink" title="&#x8C03;&#x7528;&#x793A;&#x4F8B;"></a>&#x8C03;&#x7528;&#x793A;&#x4F8B;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;List&lt;User&gt; users = http.sync(&quot;/users&quot;) // &#x8BF7;&#x6C42;&#x6570;&#x636E;&#x7684;&#x94FE;&#x63A5;&#x1F517;</span><br><span class="line">        .get()                         // GET&#x8BF7;&#x6C42;</span><br><span class="line">        .getBody()                     // &#x83B7;&#x53D6;&#x54CD;&#x5E94;&#x62A5;&#x6587;&#x4F53;</span><br><span class="line">        .toList(User.class);           // &#x5F97;&#x5230;&#x76EE;&#x6807;&#x6570;&#x636E;</span><br></pre></td></tr></table></figure>

<h3 id="&#x5FEB;&#x901F;&#x4E0A;&#x624B;"><a href="#&#x5FEB;&#x901F;&#x4E0A;&#x624B;" class="headerlink" title="&#x5FEB;&#x901F;&#x4E0A;&#x624B;"></a>&#x5FEB;&#x901F;&#x4E0A;&#x624B;</h3><p>&#x5F15;&#x5165;maven&#x5305;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;com.ejlchina&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;okhttps&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;3.1.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>&#x6CE8;&#x610F;:&#x5355;&#x72EC;&#x4F7F;&#x7528; OkHttps &#x9700;&#x8981;&#x81EA;&#x5B9A;&#x4E49;MsgConvertor&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x4F7F;&#x7528; <strong>&#x81EA;&#x52A8;&#x6B63;&#x53CD;&#x5E8F;&#x5217;&#x5316;</strong> &#x76F8;&#x5173;&#x529F;&#x80FD;.</p>
<h4 id="&#x4F7F;&#x7528;"><a href="#&#x4F7F;&#x7528;" class="headerlink" title="&#x4F7F;&#x7528;"></a>&#x4F7F;&#x7528;</h4><ol>
<li>&#x6784;&#x5EFA; HTTP</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;HTTP http = HTTP.builder().build();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x540C;&#x6B65;&#x8BF7;&#x6C42;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;List&lt;User&gt; users = http.sync(&quot;/users&quot;) </span><br><span class="line">        .get()                         </span><br><span class="line">        .getBody()                     </span><br><span class="line">        .toList(User.class);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>&#x5F02;&#x6B65;&#x8BF7;&#x6C42;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;http.async(&quot;/users&quot;)               </span><br><span class="line">        .setOnResponse((HttpResult res) -&gt; {</span><br><span class="line">            // &#x5F97;&#x5230;&#x76EE;&#x6807;&#x6570;&#x636E;</span><br><span class="line">            User user = res.getBody().toBean(User.class);</span><br><span class="line">        })</span><br><span class="line">        .get();</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>WebSocket</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;http.webSocket(&quot;/chat&quot;) </span><br><span class="line">        .setOnOpen((WebSocket ws, HttpResult res) -&gt; {</span><br><span class="line">            ws.send(&quot;hello world&quot;);</span><br><span class="line">        })</span><br><span class="line">        .setOnMessage((WebSocket ws&#xFF0C;Message msg) -&gt; {</span><br><span class="line">            // &#x4ECE;&#x670D;&#x52A1;&#x5668;&#x63A5;&#x6536;&#x6D88;&#x606F;&#xFF08;&#x81EA;&#x52A8;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF09;</span><br><span class="line">            Chat chat = msg.toBean(Chat.class);</span><br><span class="line">            // &#x76F8;&#x540C;&#x7684;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#xFF08;&#x81EA;&#x52A8;&#x5E8F;&#x5217;&#x5316; Chat &#x5BF9;&#x8C61;&#xFF09;</span><br><span class="line">            ws.send(chat); </span><br><span class="line">        })</span><br><span class="line">        .listen();</span><br></pre></td></tr></table></figure>

<p>&#x4E00;&#x822C;&#x8BF7;&#x6C42;&#x5206;&#x4E09;&#x6B65;:</p>
<p>&#x7B2C;&#x4E00;&#x6B65;&#x3001;&#x786E;&#x5B9A;&#x8BF7;&#x6C42;&#x65B9;&#x5F0F;</p>
<p>&#x540C;&#x6B65; HTTP&#xFF08;<code>sync</code>&#xFF09;&#x3001;&#x5F02;&#x6B65; HTTP&#xFF08;<code>async</code>&#xFF09;&#x6216; WebSocket&#xFF08;<code>webSocket</code>&#xFF09;</p>
<p>&#x7B2C;&#x4E8C;&#x6B65;&#x3001;&#x6784;&#x5EFA;&#x8BF7;&#x6C42;&#x4EFB;&#x52A1;</p>
<ul>
<li><code>addXxxPara</code> - &#x6DFB;&#x52A0;&#x8BF7;&#x6C42;&#x53C2;&#x6570;</li>
<li><code>setOnXxxx</code> - &#x8BBE;&#x7F6E;&#x56DE;&#x8C03;&#x51FD;&#x6570;</li>
<li><code>tag</code> - &#x6DFB;&#x52A0;&#x6807;&#x7B7E;</li>
<li>&#x2026;</li>
</ul>
<p>&#x7B2C;&#x4E09;&#x6B65;&#x3001;&#x8C03;&#x7528;&#x8BF7;&#x6C42;&#x65B9;&#x6CD5;</p>
<p>HTTP &#x8BF7;&#x6C42;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>get()</code> - GET &#x8BF7;&#x6C42;</li>
<li><code>post()</code> - POST &#x8BF7;&#x6C42;</li>
<li><code>put()</code> - PUT &#x8BF7;&#x6C42;</li>
<li><code>delete()</code> - DELETE &#x8BF7;&#x6C42;</li>
<li>&#x2026;</li>
</ul>
<p>Websocket &#x65B9;&#x6CD5;&#xFF1A;</p>
<ul>
<li><code>listen()</code> - &#x542F;&#x52A8;&#x76D1;&#x542C;<br>&#x5177;&#x4F53;&#x7684;&#x4ECB;&#x7ECD;&#x5C31;&#x5230;&#x8FD9;&#x91CC;&#x4E86;..&#x6709;&#x60F3;&#x6CD5;&#x7684;&#x5C0F;&#x670B;&#x53CB;&#x53EF;&#x4EE5;&#x53BB;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x67E5;&#x770B;:<br><a href="/external_links/8112aa8a3e0217f1460b91b7ff1d6674.html" target="blank" rel="noopener">okhttps.ejlchina-app.com/v3/</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/44615269d8eef466ed092d4ca5404c39.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016160419093938207.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016160419093938207.html" itemprop="url">Spring 实操   PostProcessor 流程及能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-07T11:34:55+08:00">
                2021-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>BeanPostProcessor &#x662F; Spring &#x7684;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x4E4B;&#x4E00; , Bean &#x5B9E;&#x73B0; BeanPostProcessor &#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5F88;&#x591A;&#x590D;&#x6742;&#x7684;&#x529F;&#x80FD;</p>
<h2 id="&#x4E8C;-PostProcessor-&#x7684;&#x7ED3;&#x6784;"><a href="#&#x4E8C;-PostProcessor-&#x7684;&#x7ED3;&#x6784;" class="headerlink" title="&#x4E8C; . PostProcessor &#x7684;&#x7ED3;&#x6784;"></a>&#x4E8C; . PostProcessor &#x7684;&#x7ED3;&#x6784;</h2><h3 id="2-1-&#x63A5;&#x53E3;&#x65B9;&#x6CD5;"><a href="#2-1-&#x63A5;&#x53E3;&#x65B9;&#x6CD5;" class="headerlink" title="2.1 &#x63A5;&#x53E3;&#x65B9;&#x6CD5;"></a>2.1 &#x63A5;&#x53E3;&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x63A5;&#x53E3;&#x4E2D;&#x4E3B;&#x8981;&#x63D0;&#x4F9B;&#x4E86;2&#x79CD; , &#x5176;&#x4E2D;&#x63D0;&#x4F9B;&#x4E86;&#x524D;&#x7F6E;&#x8C03;&#x7528;&#x548C;&#x540E;&#x7F6E;&#x8C03;&#x7528; . &#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230; , &#x8FD9;&#x91CC;&#x901A;&#x8FC7; default &#x4FEE;&#x9970; , &#x6240;&#x4EE5;&#x5E76;&#x4E0D;&#x662F;&#x5F3A;&#x5236;&#x91CD;&#x5199;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public interface BeanPostProcessor {</span><br><span class="line"></span><br><span class="line">   default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-2-&#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;"><a href="#2-2-&#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;" class="headerlink" title="2.2 &#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;"></a>2.2 &#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;</h3><p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230; , AOP , &#x5B9A;&#x65F6; , &#x914D;&#x7F6E;&#x7B49;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#x76F8;&#x5173;&#x7684;&#x96C6;&#x6210;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9fd9bc2322e39b45e1415c863324821a1bb0a3518773240fa848c2acddd38531" alt="system-BeanPostProcessor.png"></p>
<h2 id="&#x4E09;-Spring-&#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;"><a href="#&#x4E09;-Spring-&#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;" class="headerlink" title="&#x4E09; . Spring &#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;"></a>&#x4E09; . Spring &#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;</h2><h3 id="3-1-&#x4F7F;&#x7528;&#x6848;&#x4F8B;"><a href="#3-1-&#x4F7F;&#x7528;&#x6848;&#x4F8B;" class="headerlink" title="3.1 &#x4F7F;&#x7528;&#x6848;&#x4F8B;"></a>3.1 &#x4F7F;&#x7528;&#x6848;&#x4F8B;</h3><p>&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x6765;&#x770B;&#x4E00;&#x4E0B; Spring &#x5185;&#x90E8;&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528; PostProcessor &#x7279;&#x6027;&#x7684; , &#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x4EE5; ScheduledAnnotationBeanPostProcessor &#x4E3A;&#x4F8B;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName) {</span><br><span class="line">   // &#x53EF;&#x4EE5;&#x770B;&#x5230; , &#x524D;&#x7F6E;&#x5904;&#x7406;&#x5E76;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x5904;&#x7406; , &#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">   return bean;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) {</span><br><span class="line"></span><br><span class="line">   if (bean instanceof AopInfrastructureBean || bean instanceof TaskScheduler ||</span><br><span class="line">         bean instanceof ScheduledExecutorService) {</span><br><span class="line">      // Ignore AOP infrastructure such as scoped proxies.</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 1 : &#x5F00;&#x59CB;&#x7279;&#x6B8A;&#x5904;&#x7406; </span><br><span class="line">   Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(bean);</span><br><span class="line">   if (!this.nonAnnotatedClasses.contains(targetClass) &amp;&amp;</span><br><span class="line">         AnnotationUtils.isCandidateClass(targetClass, Arrays.asList(Scheduled.class, Schedules.class))) {</span><br><span class="line">      // Step 2 : &#x83B7;&#x53D6; Method &#x5BF9;&#x5E94; Scheduled &#x7684;&#x96C6;&#x5408;   </span><br><span class="line">      Map&lt;Method, Set&lt;Scheduled&gt;&gt; annotatedMethods = MethodIntrospector.selectMethods(targetClass,</span><br><span class="line">            (MethodIntrospector.MetadataLookup&lt;Set&lt;Scheduled&gt;&gt;) method -&gt; {</span><br><span class="line">               Set&lt;Scheduled&gt; scheduledAnnotations = AnnotatedElementUtils.getMergedRepeatableAnnotations(</span><br><span class="line">                     method, Scheduled.class, Schedules.class);</span><br><span class="line">               return (!scheduledAnnotations.isEmpty() ? scheduledAnnotations : null);</span><br><span class="line">            });</span><br><span class="line">      if (annotatedMethods.isEmpty()) {</span><br><span class="line">         this.nonAnnotatedClasses.add(targetClass);</span><br><span class="line">      }</span><br><span class="line">      else {</span><br><span class="line">         // Step 3 : &#x65B9;&#x6CD5;&#x4E0D;&#x4E3A;&#x7A7A; , &#x6267;&#x884C; Process</span><br><span class="line">         annotatedMethods.forEach((method, scheduledAnnotations) -&gt;</span><br><span class="line">               scheduledAnnotations.forEach(scheduled -&gt; processScheduled(scheduled, method, bean)));</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return bean;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>PS : &#x540E;&#x9762;&#x5C31;&#x4E0D;&#x770B;&#x4E86; , &#x4E3B;&#x8981;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A; ScheduledTask &#x8FD0;&#x884C; Runable &#x5BF9;&#x8C61;</strong></p>
<p>&#x4ECE;&#x5177;&#x4F53;&#x7684;&#x4F7F;&#x7528;&#x4E0A; , &#x4E0D;&#x96BE;&#x770B;&#x51FA; , &#x4ED6;&#x662F;&#x5728;&#x521B;&#x5EFA;Bean&#x7684;&#x65F6;&#x5019;&#x53BB;&#x505A;&#x8865;&#x5145;&#x7684;&#x64CD;&#x4F5C; , &#x90A3;&#x4E48;&#x4E0B;&#x9762;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;</p>
<p>&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x5728;<a href="https://dev.newban.cn/6964019910645121038">Bean &#x521D;&#x59CB;&#x5316;&#x6D41;&#x7A0B;</a> &#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x5168;&#x9762;&#x7684;&#x8DDF;&#x8E2A; , &#x8FD9;&#x91CC;&#x66F4;&#x5173;&#x6CE8;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;</p>
<h3 id="3-2-Before-After-&#x8C03;&#x7528;&#x6D41;&#x7A0B;"><a href="#3-2-Before-After-&#x8C03;&#x7528;&#x6D41;&#x7A0B;" class="headerlink" title="3.2 Before/After &#x8C03;&#x7528;&#x6D41;&#x7A0B;"></a>3.2 Before/After &#x8C03;&#x7528;&#x6D41;&#x7A0B;</h3><blockquote>
<p>&#x5165;&#x53E3;&#x4E00; : AbstractAutowireCapableBeanFactory # <strong>initializeBean</strong> &#x8C03;&#x7528;</p>
</blockquote>
<ul>
<li><strong>applyBeanPostProcessorsBeforeInitialization</strong></li>
<li><strong>applyBeanPostProcessorsAfterInitialization</strong><br>&#x5176;&#x4E2D;&#x6D41;&#x7A0B;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355; , for &#x5FAA;&#x73AF;&#x6240;&#x6709;&#x7684; BeanPostProcessors &#x8FDB;&#x884C;&#x5904;&#x7406;</li>
</ul>
<h3 id="3-3-BeanPostProcessors-&#x7684;&#x7BA1;&#x7406;"><a href="#3-3-BeanPostProcessors-&#x7684;&#x7BA1;&#x7406;" class="headerlink" title="3.3 BeanPostProcessors &#x7684;&#x7BA1;&#x7406;"></a>3.3 BeanPostProcessors &#x7684;&#x7BA1;&#x7406;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x5728; AbstractBeanFactory &#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x7528;&#x4E8E;&#x7BA1;&#x7406; BeanPostProcessor</span><br><span class="line">private final List&lt;BeanPostProcessor&gt; beanPostProcessors = new BeanPostProcessorCacheAwareList();</span><br><span class="line"></span><br><span class="line">// &#x4E0D;&#x8BBA;&#x662F;&#x54EA;&#x79CD;&#x7C7B;&#x578B; ,&#x90FD;&#x4F1A;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;2&#x79CD;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x8C03;&#x7528; , &#x5148;&#x5220;&#x9664;, &#x540E;&#x6DFB;&#x52A0;</span><br><span class="line">public void addBeanPostProcessors(Collection&lt;? extends BeanPostProcessor&gt; beanPostProcessors) {</span><br><span class="line">   this.beanPostProcessors.removeAll(beanPostProcessors);</span><br><span class="line">   this.beanPostProcessors.addAll(beanPostProcessors);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void addBeanPostProcessor(BeanPostProcessor beanPostProcessor) {</span><br><span class="line">   this.beanPostProcessors.remove(beanPostProcessor);</span><br><span class="line">   this.beanPostProcessors.add(beanPostProcessor);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x7C7B;&#x578B;&#x4E00; : &#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x7684;&#x6D41;&#x7A0B;</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x7684;&#x65B9;&#x5F0F; ,&#x5B9E;&#x73B0; BeanPostProcessor &#x7684;&#x6DFB;&#x52A0; , &#x53C2;&#x8003;&#x5BF9;&#x8C61; AbstractApplicationContext</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {</span><br><span class="line">   // .............</span><br><span class="line">   // Configure the bean factory with context callbacks.</span><br><span class="line">   beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));</span><br><span class="line">   // .............</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x7C7B;&#x578B;&#x4E8C; : Refresh &#x73AF;&#x8282;&#x6DFB;&#x52A0;</p>
</blockquote>
<p>&#x54C8;&#x54C8; , &#x53C8;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x5730;&#x65B9; , &#x4E4B;&#x524D;&#x770B; Refresh &#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x6CE8;&#x610F;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x5730;&#x65B9; , &#x4F1A;&#x6CE8;&#x518C;&#x76F8;&#x5173;&#x7684; BeanPostProcessors</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) {</span><br><span class="line">   // Step 1 : &#x8C03;&#x7528;  PostProcessorRegistrationDelegate &#x8FDB;&#x884C;&#x6CE8;&#x518C;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x6E90;&#x7801;&#x6CE8;&#x91CA;&#x975E;&#x5E38;&#x6E05;&#x6670; ,&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x7B80;&#x5355;&#x7FFB;&#x8BD1;&#x4E86;&#x4E00;&#x4E0B;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public static void registerBeanPostProcessors(</span><br><span class="line">      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {</span><br><span class="line"></span><br><span class="line">   // postProcessor &#x6570;&#x7EC4;&#x5217;&#x8868; </span><br><span class="line">   String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">   // processor &#x8BA1;&#x6570; </span><br><span class="line">   int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;</span><br><span class="line">   //&#x6CE8;&#x518C;BeanPostProcessorChecker&#xFF0C;&#x5F53;bean&#x5728;BeanPostProcessor&#x5B9E;&#x4F8B;&#x5316;&#x671F;&#x95F4;&#x521B;&#x5EFA;&#x65F6;&#xFF0C;&#x5373;&#x5F53;bean&#x4E0D;&#x7B26;&#x5408;&#x6240;&#x6709;BeanPostProcessors&#x5904;&#x7406;&#x7684;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x8BE5;checker&#x4F1A;&#x8BB0;&#x5F55;&#x4FE1;&#x606F;&#x6D88;&#x606F; </span><br><span class="line">   beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">   // &#x533A;&#x522B; PriorityOrdered, internalPostProcessor</span><br><span class="line">   List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   // &#x6709;&#x5E8F;&#x5316;</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   for (String ppName : postProcessorNames) {</span><br><span class="line">      if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {</span><br><span class="line">         BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">         priorityOrderedPostProcessors.add(pp);</span><br><span class="line">         // &#x8FD0;&#x884C;&#x65F6;&#x7528;&#x4E8E;&#x5408;&#x5E76;bean&#x5B9A;&#x4E49;&#x7684;&#x540E;&#x5904;&#x7406;&#x5668;&#x56DE;&#x8C03;&#x63A5;&#x53E3;</span><br><span class="line">         if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      // &#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86; Ordered &#x63A5;&#x53E3; , &#x5219;&#x9700;&#x8981;&#x6709;&#x5E8F;&#x5904;&#x7406;</span><br><span class="line">      else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      }</span><br><span class="line">      else {</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // &#x9996;&#x5148;&#xFF0C;&#x6CE8;&#x518C;&#x5B9E;&#x73B0;prioritordered&#x7684;BeanPostProcessors</span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6CE8;&#x518C;&#x5B9E;&#x73B0;Ordered&#x7684;BeanPostProcessors</span><br><span class="line">   List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   for (String ppName : orderedPostProcessorNames) {</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      orderedPostProcessors.add(pp);</span><br><span class="line">      if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x73B0;&#x5728;&#xFF0C;&#x6CE8;&#x518C;&#x6240;&#x6709;&#x5E38;&#x89C4;&#x7684;BeanPostProcessors</span><br><span class="line">   List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   for (String ppName : nonOrderedPostProcessorNames) {</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      nonOrderedPostProcessors.add(pp);</span><br><span class="line">      if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x6700;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x6240;&#x6709;&#x5185;&#x90E8;BeanPostProcessors</span><br><span class="line">   sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x5C06;&#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x5185;&#x90E8;bean&#x7684;&#x540E;&#x5904;&#x7406;&#x5668;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x4E3A;ApplicationListeners&#xFF0C;&#x5C06;&#x5176;&#x79FB;&#x52A8;&#x5230;&#x5904;&#x7406;&#x5668;&#x94FE;&#x7684;&#x672B;&#x7AEF;</span><br><span class="line">   beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;-&#x6DF1;&#x5165;&#x5B9A;&#x5236;"><a href="#&#x56DB;-&#x6DF1;&#x5165;&#x5B9A;&#x5236;" class="headerlink" title="&#x56DB; . &#x6DF1;&#x5165;&#x5B9A;&#x5236;"></a>&#x56DB; . &#x6DF1;&#x5165;&#x5B9A;&#x5236;</h2><h3 id="4-1-&#x6DFB;&#x52A0;-BeanPostProcessor"><a href="#4-1-&#x6DFB;&#x52A0;-BeanPostProcessor" class="headerlink" title="4.1 &#x6DFB;&#x52A0; BeanPostProcessor"></a>4.1 &#x6DFB;&#x52A0; BeanPostProcessor</h3><blockquote>
<p>&#x65B9;&#x6CD5;&#x4E00; : &#x624B;&#x52A8;&#x6DFB;&#x52A0;<br><strong>PS : &#x5F53;&#x7136; , &#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x8FC7;&#x4E8E;&#x590D;&#x6742; , &#x9002;&#x7528;&#x573A;&#x666F;&#x4E0D;&#x591A;</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Autowired</span><br><span class="line">private DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">@Bean(initMethod = &quot;initMethod&quot;)</span><br><span class="line">public CommonService getCommonService() {</span><br><span class="line">    // &#x901A;&#x8FC7; BeanFactory &#x8FDB;&#x884C;&#x6DFB;&#x52A0;</span><br><span class="line">    beanFactory.addBeanPostProcessor(new CustomizePostProcessor());</span><br><span class="line">    return new CommonService();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x65B9;&#x6CD5;&#x4E8C; : &#x76F4;&#x63A5;&#x7EE7;&#x627F;&#x63A5;&#x53E3;</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x5206;&#x6790;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x770B;&#x5230; , &#x5B9E;&#x73B0;&#x4E86;&#x63A5;&#x53E3;&#x5C31;&#x81EA;&#x52A8;&#x6DFB;&#x52A0;&#x4E86;</p>
<h2 id="&#x4E94;-&#x95EE;&#x9898;&#x8865;&#x5145;"><a href="#&#x4E94;-&#x95EE;&#x9898;&#x8865;&#x5145;" class="headerlink" title="&#x4E94; .&#x95EE;&#x9898;&#x8865;&#x5145;"></a>&#x4E94; .&#x95EE;&#x9898;&#x8865;&#x5145;</h2><h3 id="5-1-&#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;"><a href="#5-1-&#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;" class="headerlink" title="5.1 &#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B; ?"></a>5.1 &#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B; ?</h3><p><strong>&#x56DE;&#x987E;&#x4E00;&#x4E0B;&#x56DB;&#x79CD;&#x521D;&#x59CB;&#x5316;&#x8FD0;&#x884C;&#x7684;&#x65B9;&#x5F0F; :</strong></p>
<ul>
<li>&#x5B9E;&#x73B0; InitializingBean &#x63A5;&#x53E3;&#x65B9;&#x6CD5; afterPropertiesSet</li>
<li>&#x5B9E;&#x73B0; ApplicationRunner &#x63A5;&#x53E3;&#x65B9;&#x6CD5; run(ApplicationArguments args)</li>
<li>&#x65B9;&#x6CD5;&#x6807;&#x6CE8;&#x6CE8;&#x89E3; @PostConstruct</li>
<li>@Bean(initMethod = &#x201C;initMethod&#x201D;) &#x901A;&#x8FC7;&#x6CE8;&#x89E3;&#x6307;&#x5B9A;</li>
</ul>
<blockquote>
<p>&#x8C03;&#x7528;&#x7684;&#x533A;&#x522B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;: ------&gt; this is @PostConstruct &lt;-------</span><br><span class="line">: ------&gt; this is InitializingBean  &lt;-------</span><br><span class="line">: ------&gt; this is in @Bean(initMethod = &quot;initMethod&quot;)  &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: Started DemoApplication in 0.822 seconds (JVM running for 2.597)</span><br><span class="line">: ------&gt; this is ApplicationRunner :getCommonService &lt;-------</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>&#x8C03;&#x7528;&#x6B21;&#x6570;</strong> : &#x56DB;&#x79CD;&#x65B9;&#x6CD5;&#x53EA;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x6B21; ,&#x800C; postProcessBeforeInitialization &#x548C; postProcessAfterInitialization <strong>&#x4F1A;&#x5728;&#x6BCF;&#x4E2A;Bean&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;</strong></li>
<li><strong>&#x8C03;&#x7528;&#x65F6;&#x673A;</strong> : &#x96C6;&#x4E2D;&#x5728;&#x6BCF;&#x4E2A; Bean <strong>initializeBean</strong> &#x73AF;&#x8282;&#x8C03;&#x7528;</li>
</ul>
<h2 id="&#x516D;-&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48;"><a href="#&#x516D;-&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48;" class="headerlink" title="&#x516D;. &#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48; ?"></a>&#x516D;. &#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48; ?</h2><p>&#x8FD9;&#x91CC;&#x4E0D;&#x8BA8;&#x8BBA;&#x662F;&#x5426;&#x771F;&#x7684;&#x6709;&#x573A;&#x666F;&#x4F1A;&#x4F7F;&#x7528; ,&#x53EA;&#x662F;&#x53D1;&#x6563;&#x601D;&#x7EF4; , &#x53BB;&#x601D;&#x8003;&#x5982;&#x4F55;&#x5229;&#x7528;&#x4ED6;&#x7684;&#x7279;&#x70B9;&#x53BB;&#x505A;&#x70B9;&#x4EC0;&#x4E48;</p>
<h3 id="6-1-&#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;"><a href="#6-1-&#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;" class="headerlink" title="6.1 &#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;"></a>6.1 &#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;</h3><p>&#x4EE3;&#x7406;&#x662F; postProcess &#x6700;&#x5408;&#x9002;&#x7684;&#x4F7F;&#x7528;&#x4E4B;&#x4E00; , AOP &#x5373;&#x4F7F;&#x7528;&#x4E86;&#x4ED6;&#x7684;&#x7279;&#x6027;&#x8FDB;&#x884C;&#x7684;&#x4EE3;&#x7406; , &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6A21;&#x62DF; AOP , &#x53BB;&#x505A;&#x4E00;&#x4E2A;&#x66F4;&#x504F;&#x5411;&#x4E8E;&#x4E1A;&#x52A1;&#x7684;&#x9759;&#x6001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F; .</p>
<p><strong>&#x540C;&#x65F6;&#x4E5F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F; , &#x5BF9; Bean &#x7684;&#x5904;&#x7406;&#x8FDB;&#x884C;&#x52A0;&#x5F3A; .</strong></p>
<blockquote>
<p>Step 1 : &#x51C6;&#x5907;&#x63A5;&#x53E3;&#x548C;&#x5B9E;&#x73B0;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x7EDF;&#x4E00;&#x63A5;&#x53E3;</span><br><span class="line">public interface Sourceable {</span><br><span class="line">    void method();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5BF9;&#x5E94;&#x5B9E;&#x73B0;&#x7C7B; (&#x5B9E;&#x9645;&#x4E1A;&#x52A1;&#x7C7B;)</span><br><span class="line">@Service</span><br><span class="line">public class Source implements Sourceable {</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void method() {</span><br><span class="line">        System.out.println(&quot;the original method!&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 2 : &#x51C6;&#x5907;&#x4E2D;&#x95F4;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class AopProxyImpl implements Sourceable {</span><br><span class="line"></span><br><span class="line">    private Sourceable source;</span><br><span class="line"></span><br><span class="line">    public AopProxyImpl(Sourceable source) {</span><br><span class="line">        super();</span><br><span class="line">        // &#x6CE8;&#x610F; ,&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x662F;&#x5728;&#x4EE3;&#x7406;&#x7C7B;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</span><br><span class="line">        // this.source = new Source();</span><br><span class="line"></span><br><span class="line">        // &#x4FEE;&#x9970;&#x6A21;&#x5F0F;&#x662F;&#x4F20;&#x5165;&#x5BF9;&#x5E94;&#x7684;&#x5BF9;&#x8C61;</span><br><span class="line">        this.source = source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void method() {</span><br><span class="line">        before();</span><br><span class="line">        source.method();</span><br><span class="line">        atfer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void atfer() {</span><br><span class="line">        System.out.println(&quot;after proxy!&quot;);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void before() {</span><br><span class="line">        System.out.println(&quot;before proxy!&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 3 : BeanPostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Service</span><br><span class="line">public class AopPostProcessor implements BeanPostProcessor {</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor postProcessBeforeInitialization &lt;-------&quot;);</span><br><span class="line">        return bean;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor postProcessAfterInitialization &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">        if (bean instanceof Sourceable) {</span><br><span class="line">            logger.info(&quot;------&gt; AopPostProcessor build Aop &lt;-------&quot;);</span><br><span class="line">            AopProxyImpl proxy = new AopProxyImpl((Sourceable)bean);</span><br><span class="line">            return proxy;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return bean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; &#xFF1A;</p>
</blockquote>
<ul>
<li>&#x8FD9;&#x91CC;&#x5982;&#x679C;&#x6CA1;&#x6709; , &#x5219;&#x4E00;&#x5B9A;&#x4F1A;&#x629B;&#x51FA; BeanNotOfRequiredTypeException , &#x56E0;&#x4E3A; Spring &#x4F1A;&#x53BB;&#x575A;&#x6301;&#x7C7B;&#x662F;&#x5426;&#x5339;&#x914D;</li>
<li>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C5E;&#x4E8E;&#x9759;&#x6001;&#x4EE3;&#x7406; , &#x5176;&#x5B9E;&#x8FD8;&#x53EF;&#x4EE5;&#x66F4;&#x6D3B;&#x7528;&#x7684;&#x4F7F;&#x7528; <strong>cglib &#x52A8;&#x6001;&#x4EE3;&#x7406;</strong></li>
<li>&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x6574;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x7075;&#x6D3B;&#x4F7F;&#x7528;</li>
</ul>
<h3 id="6-2-Manager-&#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;"><a href="#6-2-Manager-&#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;" class="headerlink" title="6.2 Manager &#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;"></a>6.2 Manager &#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;</h3><p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x662F;&#x5728; postProcessor &#x4E2D;&#x5BF9;&#x6307;&#x5B9A;&#x7684;Bean &#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x7BA1;&#x7406;&#x8BB0;&#x5F55;</p>
<p>&#x5927;&#x6982;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x662F;&#x51C6;&#x5907;&#x4E00;&#x4E2A;BeanManager , &#x7136;&#x540E;&#x5728; postProcessor &#x4E2D;&#x8FDB;&#x884C;&#x7BA1;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Component</span><br><span class="line">public class BeanManager {</span><br><span class="line">    </span><br><span class="line">    // &#x5BF9;&#x7279;&#x6B8A;&#x7684;Bean &#x8FDB;&#x884C;&#x5206;&#x7EC4;</span><br><span class="line">    private static Map&lt;String, TypeBean&gt; typeOne = new ConcurrentHashMap();</span><br><span class="line">    private static Map&lt;String, TypeBean&gt; typeTwo = new ConcurrentHashMap();</span><br><span class="line">    </span><br><span class="line">    // PS : &#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x9002;&#x5408;&#x5904;&#x7406;&#x66F4;&#x590D;&#x6742;&#x7684;&#x573A;&#x666F; , &#x7B80;&#x5355;&#x573A;&#x666F;&#x53EF;&#x4EE5;&#x8003;&#x8651;&#x901A;&#x8FC7; ApplicationContext.getBean &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">    logger.info(&quot;------&gt; ManagerPostProcessor postProcessAfterInitialization &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">    if (bean instanceof TypeBean) {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor build Aop &lt;-------&quot;);</span><br><span class="line">        beanManager.getTypeOne().put(beanName, (TypeBean) bean);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return bean;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// PS : &#x5B9E;&#x9645;&#x4E0A;&#x548C;&#x6CE8;&#x5165;&#x7684;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</span><br><span class="line">------&gt; typeOne.get(&quot;typeBeanImpl&quot;) == (typeBean) :true &lt;-------</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; :</p>
</blockquote>
<p><strong>&#x8FD9;&#x662F;&#x6700;&#x7B80;&#x5355;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F; , &#x76F8;&#x5BF9;&#x66F4;&#x590D;&#x6742;&#x7684;&#x8FD8;&#x53EF;&#x4EE5;&#x6574;&#x5408;&#x6CE8;&#x89E3; , &#x6574;&#x5408;&#x63A5;&#x53E3;&#x6216;&#x8005;&#x7236;&#x7C7B; , &#x6216;&#x8005;&#x4EC5;&#x8BB0;&#x5F55;class&#x4FE1;&#x606F;&#x7B49;&#x65B9;&#x5F0F; ,&#x8FBE;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x4E1A;&#x52A1;&#x6548;&#x679C;</strong></p>
<h3 id="6-3-&#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;"><a href="#6-3-&#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;" class="headerlink" title="6.3 &#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;"></a>6.3 &#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;</h3><p>&#x4ECE;&#x56FE;&#x7247;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230; , BeanPostProcessor &#x662F;&#x5728; PopulateBean &#x73AF;&#x8282;&#x4E4B;&#x540E;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684; , &#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x73AF;&#x8282; , &#x5BF9; Bean &#x4E2D;&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x4FEE;&#x9970; , &#x5E38;&#x89C1;&#x7684;&#x4F7F;&#x7528;&#x60F3;&#x6CD5;&#x5305;&#x62EC; :</p>
<ul>
<li>&#x4E3A;&#x7279;&#x5B9A;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x52A8;&#x6001;&#x4EE3;&#x7406;</li>
<li>&#x4ECE; Remote &#x7AEF;&#x83B7;&#x53D6;&#x5C5E;&#x6027; , &#x5E76;&#x4E14;&#x8BBE;&#x7F6E;</li>
</ul>
<p><strong>&#x8FD9;&#x4E2A;&#x5C31;&#x6BD4;&#x8F83;&#x597D;&#x7406;&#x89E3;&#x4E86; , &#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5305;&#x62EC;RestTemplate &#x90FD;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x5B8C;&#x6210; , JDBC &#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; , &#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5B8C;&#x5168;&#x53EF;&#x4EE5;&#x4ECE;&#x8FDC;&#x7AEF;&#x83B7;&#x53D6;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F5C;&#x7528;&#x4E00; : </span><br><span class="line">&#x4F7F;&#x7528; JDBC (JPA &#x5E94;&#x8BE5;&#x4E5F;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x53EF;&#x7528;) , &#x4ECE;&#x6570;&#x636E;&#x5E93;&#x83B7;&#x53D6;&#x914D;&#x7F6E; , &#x5224;&#x65AD;&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x5426;&#x6709;&#x7279;&#x5B9A;&#x6CE8;&#x89E3; , &#x5237;&#x65B0;&#x6CE8;&#x89E3;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line"></span><br><span class="line">// &#x4F5C;&#x7528;&#x4E8C; : </span><br><span class="line">&#x8C03;&#x7528;&#x8FDC;&#x7AEF;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3; , &#x81EA;&#x5B9A;&#x4E49;&#x5237;&#x65B0;&#x914D;&#x7F6E;</span><br><span class="line"></span><br><span class="line">// &#x4F5C;&#x7528;&#x4E09; : </span><br><span class="line">&#x5237;&#x65B0;&#x7279;&#x6B8A;&#x7684;&#x5C5E;&#x6027;&#x6216;&#x8005;&#x5BF9;&#x8C61;&#x7B49;&#x7B49;</span><br></pre></td></tr></table></figure>

<p>**&#x7279;&#x6B8A;&#x5BF9;&#x8C61;&#x7684;&#x5237;&#x65B0;&#x6709;&#x591A;&#x79CD;&#x4EFB;&#x610F;&#x7684;&#x4F7F;&#x7528; , &#x53EF;&#x4EE5;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x4E1A;&#x52A1;&#x7075;&#x6D3B;&#x8FD0;&#x7528; **</p>
<h3 id="6-4-&#x5176;&#x4ED6;&#x601D;&#x8DEF;"><a href="#6-4-&#x5176;&#x4ED6;&#x601D;&#x8DEF;" class="headerlink" title="6.4 &#x5176;&#x4ED6;&#x601D;&#x8DEF;"></a>6.4 &#x5176;&#x4ED6;&#x601D;&#x8DEF;</h3><p><strong>&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x629B;&#x7816;&#x5F15;&#x7389; , &#x6B22;&#x8FCE;&#x5927;&#x4F6C;&#x4EEC;&#x63D0;&#x51FA;&#x81EA;&#x5DF1;&#x7684;&#x60F3;&#x6CD5;</strong></p>
<ul>
<li>&#x91CD;&#x6784;&#x5C5E;&#x6027;</li>
<li>&#x5B9A;&#x5236;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x5BF9;&#x7C7B;&#x8FDB;&#x884C;&#x8986;&#x76D6;</li>
</ul>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/135734618c2fcac3cd0f45cacf4c5e370d9e3e76adc45bc76d17284d638107b6" alt="image.png"></p>
<blockquote>
<p>&#x6CE8;&#x610F;&#x70B9; :</p>
</blockquote>
<ul>
<li>applyBeanPostProcessorsBeforeInitialization &#x4E3B;&#x8981;&#x5728; initializeBean &#x73AF;&#x8282;&#x8C03;&#x7528;</li>
<li>applyBeanPostProcessorsAfterInitialization &#x9664;&#x4E86;initializeBean&#x5916;<strong>&#x8FD8;&#x5728;&#x591A;&#x4E2A;&#x73AF;&#x8282;&#x88AB;&#x8C03;&#x7528;</strong> , &#x5305;&#x62EC; getSingletonFactoryBeanForTypeCheck &#x7B49;&#x7B49;&#x51E0;&#x4E2A; Factory &#x53BB;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;</li>
<li>&#x907F;&#x514D;&#x5FAA;&#x73AF; , ManagerPostProcessor &#x4E0D;&#x4F1A;&#x5904;&#x7406;&#x81EA;&#x5DF1;</li>
<li>BeanPostProcessor &#x5728;&#x6BCF;&#x4E2A; bean &#x521B;&#x5EFA;&#x65F6;&#x90FD;&#x4F1A;&#x8C03;&#x7528; , <strong>&#x8FC7;&#x591A;&#x4F1A;&#x5F71;&#x54CD;&#x542F;&#x52A8;&#x6548;&#x7387;</strong></li>
<li>BeanPostProcessor &#x4E3B;&#x8981;&#x5728;populateBean &#x4E4B;&#x540E; , &#x6CE8;&#x610F;&#x524D;&#x540E;&#x987A;&#x5E8F;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/1250d20bb17615c072ff4f090fb35c81.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016147287889936397.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016147287889936397.html" itemprop="url">现在准备好告别Transform了吗？   拥抱AGP70</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-07T10:35:34+08:00">
                2021-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x524D;&#x6587;&#x63D0;&#x8981;"><a href="#&#x524D;&#x6587;&#x63D0;&#x8981;" class="headerlink" title="&#x524D;&#x6587;&#x63D0;&#x8981;"></a>&#x524D;&#x6587;&#x63D0;&#x8981;</h1><p>&#x4E4B;&#x524D;&#x5C31;&#x548C;&#x5927;&#x5BB6;&#x4ECB;&#x7ECD;&#x8FC7;<code>AGP(Android Gradle Plugin) 7.0.0</code>&#x7248;&#x672C;&#x4E4B;&#x540E;<code>Transform</code> &#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#x5373;&#x5C06;&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x800C;&#x4E14;&#x4E5F;&#x7B80;&#x5355;&#x7684;&#x4ECB;&#x7ECD;&#x4E86;&#x66FF;&#x6362;&#x7684;&#x65B9;&#x5F0F;&#x662F;<code>Transform Action</code>&#xFF0C;&#x7ECF;&#x8FC7;&#x6211;&#x8FD9;&#x4E00;&#x9635;&#x5B50;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x8C03;&#x7814;&#xFF0C;&#x53D1;&#x73B0;&#x53EA;&#x80FD;&#x8BF4;&#x7B54;&#x5BF9;&#x4E86;&#x4E00;&#x534A;&#x5427;&#x3002;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x4E2A;&#x65B0;&#x4E1C;&#x897F;<code>AsmClassVisitorFactory</code>&#x3002;</p>
<blockquote>
<p>com.android.build.api.instrumentation.AsmClassVisitorFactory</p>
</blockquote>
<blockquote>
<p>A factory to create class visitor objects to instrument classes.</p>
</blockquote>
<blockquote>
<p>The implementation of this interface must be an abstract class where the parameters and instrumentationContext are left unimplemented. The class must have an empty constructor which will be used to construct the factory object.</p>
</blockquote>
<p>&#x5F53;&#x524D;&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x7684;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x5C31;&#x662F;&#x57FA;&#x4E8E;<code>gradle</code>&#x539F;&#x751F;&#x7684;<code>Transform Action</code>&#xFF0C;&#x8FD9;&#x6B21;&#x7684;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x8D70;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5F2F;&#x8DEF;&#xFF0C;&#x4E00;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x4F46;&#x662F;&#x8C8C;&#x4F3C;&#x5F2F;&#x5F2F;&#x7ED5;&#x7ED5;&#x7684;&#xFF0C;&#x6700;&#x540E;&#x4E5F;&#x6CA1;&#x6709;&#x6210;&#x529F;&#xFF0C;&#x800C;&#x4E14;<code>Transform Action</code>&#x7684;&#x8F93;&#x5165;&#x4EA7;&#x7269;&#x90FD;&#x662F;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#xFF0C;&#x4FEE;&#x6539;&#x4E5F;&#x662F;&#x9488;&#x5BF9;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8C8C;&#x4F3C;&#x4E5F;&#x4E0D;&#x5B8C;&#x5168;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x66FF;&#x6362;&#x65B9;&#x6848;&#xFF0C;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#x90A3;&#x79CD;&#x590D;&#x6742;&#x7684;asm&#x64CD;&#x4F5C;&#x5219;&#x65E0;&#x6CD5;&#x8D1F;&#x8377;&#x4E86;&#x3002;</p>
<p><code>AsmClassVisitorFactory</code>&#x6839;&#x636E;&#x5B98;&#x65B9;&#x8BF4;&#x6CD5;&#xFF0C;&#x7F16;&#x8BD1;&#x901F;&#x5EA6;&#x4F1A;&#x6709;&#x63D0;&#x5347;&#xFF0C;&#x5927;&#x6982;18%&#x5DE6;&#x53F3;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x4F7F;&#x7528;&#x9636;&#x6BB5;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/eb512df978086ed6171d07aa640131c11ea20be09dd96307e7c6d6b5ba9cf2ff" alt="image.png"></p>
<h1 id="&#x5B66;&#x5E9F;&#x4E86;"><a href="#&#x5B66;&#x5E9F;&#x4E86;" class="headerlink" title="&#x5B66;&#x5E9F;&#x4E86;"></a>&#x5B66;&#x5E9F;&#x4E86;</h1><p>&#x6211;&#x4EEC;&#x5148;&#x4ECE;<code>AsmClassVisitorFactory</code>&#x8FD9;&#x4E2A;&#x62BD;&#x8C61;&#x63A5;&#x53E3;&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#x8D77;&#x5427;&#x3002;</p>
<h2 id="AsmClassVisitorFactory"><a href="#AsmClassVisitorFactory" class="headerlink" title="AsmClassVisitorFactory"></a>AsmClassVisitorFactory</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface AsmClassVisitorFactory&lt;ParametersT : InstrumentationParameters&gt; : Serializable {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The parameters that will be instantiated, configured using the given config when registering</span><br><span class="line">     * the visitor, and injected on instantiation.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val parameters: Property&lt;ParametersT&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Contains parameters to help instantiate the visitor objects.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val instrumentationContext: InstrumentationContext</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a class visitor object that will visit a class with the given [classContext]. The</span><br><span class="line">     * returned class visitor must delegate its calls to [nextClassVisitor].</span><br><span class="line">     *</span><br><span class="line">     * The given [classContext] contains static information about the classes before starting the</span><br><span class="line">     * instrumentation process. Any changes in interfaces or superclasses for the class with the</span><br><span class="line">     * given [classContext] or for any other class in its classpath by a previous visitor will</span><br><span class="line">     * not be reflected in the [classContext] object.</span><br><span class="line">     *</span><br><span class="line">     * [classContext] can also be used to get the data for classes that are in the runtime classpath</span><br><span class="line">     * of the class being visited.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     *</span><br><span class="line">     * @param classContext contains information about the class that will be instrumented by the</span><br><span class="line">     *                     returned class visitor.</span><br><span class="line">     * @param nextClassVisitor the [ClassVisitor] to which the created [ClassVisitor] must delegate</span><br><span class="line">     *                         method calls.</span><br><span class="line">     */</span><br><span class="line">    fun createClassVisitor(</span><br><span class="line">        classContext: ClassContext,</span><br><span class="line">        nextClassVisitor: ClassVisitor</span><br><span class="line">    ): ClassVisitor</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Whether or not the factory wants to instrument the class with the given [classData].</span><br><span class="line">     *</span><br><span class="line">     * If returned true, [createClassVisitor] will be called and the returned class visitor will</span><br><span class="line">     * visit the class.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     */</span><br><span class="line">    fun isInstrumentable(classData: ClassData): Boolean</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;&#x4E0B;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x5728;<code>createClassVisitor</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#xFF0C;&#x6B63;&#x5E38;&#x6211;&#x4EEC;&#x5728;&#x6784;&#x9020;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#x65F6;&#x5019;&#x662F;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4E4B;&#x540E;&#x5728;new&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;nextClassVisitor&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;<code>isInstrumentable</code>,&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x5426;&#x8981;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x6240;&#x6709;&#x7C7B;&#x90FD;&#x8981;&#x901A;&#x8FC7;ClassVisitor&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x8FD8;&#x662F;&#x592A;&#x8017;&#x65F6;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FC7;&#x6EE4;&#x6389;&#x5F88;&#x591A;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x7C7B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface ClassData {</span><br><span class="line">    /**</span><br><span class="line">     * Fully qualified name of the class.</span><br><span class="line">     */</span><br><span class="line">    val className: String</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of the annotations the class has.</span><br><span class="line">     */</span><br><span class="line">    val classAnnotations: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the interfaces that this class or a superclass of this class implements.</span><br><span class="line">     */</span><br><span class="line">    val interfaces: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the super classes that this class or a super class of this class extends.</span><br><span class="line">     */</span><br><span class="line">    val superClasses: List&lt;String&gt;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><code>ClassData</code>&#x5E76;&#x4E0D;&#x662F;asm&#x7684;api&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x5185;&#x5BB9;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x6BD4;&#x8F83;&#x5C11;&#xFF0C;&#x4F46;&#x662F;&#x5E94;&#x8BE5;&#x4E5F;&#x52C9;&#x5F3A;&#x591F;&#x7528;&#x4E86;&#x3002;&#x8FD9;&#x90E8;&#x5206;&#x5927;&#x5BB6;&#x7B80;&#x5355;&#x770B;&#x770B;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x5C31;&#x4E0D;&#x591A;&#x505A;&#x4ECB;&#x7ECD;&#x4E86;&#x5462;&#x3002;</p>
<h2 id="&#x65B0;&#x7684;Extension"><a href="#&#x65B0;&#x7684;Extension" class="headerlink" title="&#x65B0;&#x7684;Extension"></a>&#x65B0;&#x7684;Extension</h2><p>AGP&#x7248;&#x672C;&#x5347;&#x7EA7;&#x4E4B;&#x540E;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x4E3A;&#x4E86;&#x533A;&#x5206;&#x65B0;&#x65E7;&#x7248;&#x7684;<code>Extension</code>,&#x6240;&#x4EE5;&#x5728;<code>AppExtension</code>&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x65B0;&#x589E;&#x4E86;&#x4E00;&#x4E2A;<code>AndroidComponentsExtension</code>&#x51FA;&#x6765;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x7684;<code>transformClassesWith</code>&#x5C31;&#x9700;&#x8981;&#x6CE8;&#x518C;&#x5728;&#x8FD9;&#x4E2A;&#x4E0A;&#x9762;&#x3002;&#x8FD9;&#x4E2A;&#x9700;&#x8981;&#x8003;&#x8651;&#x5230;&#x53D8;&#x79CD;&#xFF0C;&#x548C;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x8FD8;&#x662F;&#x6709;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x533A;&#x522B;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x53D8;&#x79CD;&#x589E;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x9002;&#x914D;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;        val androidComponents = project.extensions.getByType(AndroidComponentsExtension::class.java)</span><br><span class="line">        androidComponents.onVariants { variant -&gt;</span><br><span class="line">            variant.transformClassesWith(PrivacyClassVisitorFactory::class.java,</span><br><span class="line">                    InstrumentationScope.ALL) {}</span><br><span class="line">            variant.setAsmFramesComputationMode(FramesComputationMode.COPY_FRAMES)</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<h2 id="&#x5B9E;&#x6218;"><a href="#&#x5B9E;&#x6218;" class="headerlink" title="&#x5B9E;&#x6218;"></a>&#x5B9E;&#x6218;</h2><p>&#x8FD9;&#x6B21;&#x8FD8;&#x662F;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x654F;&#x611F;&#x6743;&#x9650;api&#x66FF;&#x6362;&#x7684;&#x5B57;&#x8282;&#x7801;&#x66FF;&#x6362;&#x5DE5;&#x5177;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x5F00;&#x53D1;&#x3002;</p>
<h3 id="ClassVisitor"><a href="#ClassVisitor" class="headerlink" title="ClassVisitor"></a>ClassVisitor</h3><p>&#x770B;&#x770B;&#x6211;&#x4EEC;&#x6B63;&#x5E38;&#x662F;&#x5982;&#x4F55;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;ClassVisitor&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">ClassVisitor methodFilterCV = new ClassFilterVisitor(classWriter);</span><br><span class="line">ClassReader cr = new ClassReader(srcClass);</span><br><span class="line">cr.accept(methodFilterCV, ClassReader.SKIP_DEBUG);</span><br><span class="line">return classWriter.toByteArray();</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4F1A;&#x6784;&#x9020;&#x597D;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;<code>ClassWriter</code>&#xFF0C;&#x63A5;&#x7740;&#x4F1A;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x5165;&#x8FD9;&#x4E2A;<code>ClassWriter</code>&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassReader</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x5C06;byte&#x6570;&#x7EC4;&#x4F20;&#x5165;&#xFF0C;&#x4E4B;&#x540E;&#x8C03;&#x7528;classReader.accept&#x65B9;&#x6CD5;&#xFF0C;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x5728;visitor&#x4E2D;&#x9010;&#x4E2A;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x7C7B;&#x4FE1;&#x606F;&#xFF0C;&#x65B9;&#x6CD5;&#x5565;&#x7684;&#x90FD;&#x662F;&#x901A;&#x8FC7;ClassReader&#x8BFB;&#x5165;&#x7684;&#xFF0C;&#x7136;&#x540E;&#x7531;&#x5F53;&#x524D;&#x7684;<code>ClassVisitor</code>&#x8BBF;&#x95EE;&#x5B8C;&#x4E4B;&#x540E;&#x4EA4;&#x7ED9;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x4E00;&#x4E2A;<code>ClassWriter</code>&#x3002;</p>
<p>&#x5176;&#x4E2D;<code>ClassWriter</code>&#x4E5F;&#x662F;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5BF9;&#x8C61;&#xFF0C;&#x4ED6;&#x590D;&#x6742;&#x91CD;&#x65B0;&#x5C06;&#x4FEE;&#x6539;&#x8FC7;&#x7684;&#x7C7B;&#x8F6C;&#x5316;&#x6210;byte&#x6570;&#x636E;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5F97;&#x51FA;&#x6765;<code>ClassVisitor</code>&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x4E4B;&#x540E;&#x9010;&#x5C42;&#x5411;&#x4E0B;&#x8BBF;&#x95EE;&#x3002;</p>
<p>&#x4ECB;&#x7ECD;&#x5B8C;&#x4E86;&#x8FD9;&#x4E2A;&#x54E6;&#xFF0C;&#x6211;&#x4EEC;&#x505A;&#x4E2A;&#x5927;&#x80C6;&#x7684;&#x5047;&#x8BBE;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;<code>ClassVisitor</code>&#x94FE;&#x8868;&#x524D;&#x63D2;&#x5165;&#x51E0;&#x4E2A;&#x4E0D;&#x540C;&#x7684;<code>ClassVisitor</code>&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x5C31;&#x53EF;&#x4EE5;&#x8BA9;asm&#x4FEE;&#x6539;&#x9010;&#x4E2A;&#x751F;&#x6548;&#xFF0C;&#x7136;&#x540E;&#x4E5F;&#x4E0D;&#x9700;&#x8981;&#x591A;&#x4F59;&#x7684;io&#x64CD;&#x4F5C;&#x4E86;&#x5462;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x65B0;&#x7684;asm api &#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E86;&#xFF0C;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x8FB9;&#x5927;&#x4F6C;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6846;&#x67B6;&#x5927;&#x4F6C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;&#x53E6;&#x5916;bytex&#x5185;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002;</p>
<blockquote>
<p>tips ClassNode &#x56E0;&#x4E3A;&#x662F;&#x5148;&#x751F;&#x6210;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#xFF0C;&#x6240;&#x4EE5;&#x548C;&#x4E00;&#x822C;&#x7684;ClassVisitor&#x6709;&#x70B9;&#x5C0F;&#x533A;&#x522B;&#xFF0C;&#x9700;&#x8981;&#x5728;visitEnd&#x65B9;&#x6CD5;&#x5185;&#x8C03;&#x7528;accept(next)</p>
</blockquote>
<h3 id="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"><a href="#&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"></a>&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x4E0A;&#x5B9E;&#x6218;&#x54AF;&#x3002;&#x6211;&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7801;&#x5957;&#x7528;&#x5230;&#x8FD9;&#x6B21;&#x7684;&#x903B;&#x8F91;&#x4E0A;&#x6765;&#x3002;</p>
<blockquote>
<p><a href="/external_links/c45b99434aac9aa2e2a217e90ec1e916.html" target="blank" rel="noopener">demo&#x5730;&#x5740;</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;abstract class PrivacyClassVisitorFactory : AsmClassVisitorFactory&lt;InstrumentationParameters.None&gt; {</span><br><span class="line"></span><br><span class="line">    override fun createClassVisitor(classContext: ClassContext, nextClassVisitor: ClassVisitor): ClassVisitor {</span><br><span class="line">        return PrivacyClassNode(nextClassVisitor)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    override fun isInstrumentable(classData: ClassData): Boolean {</span><br><span class="line">        return true</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;isInstrumentable&#x90FD;&#x8FD4;&#x56DE;&#x7684;&#x662F;true&#xFF0C;&#x5176;&#x5B9E;&#x6211;&#x53EF;&#x4EE5;&#x5C06;&#x626B;&#x63CF;&#x89C4;&#x5219;&#x9650;&#x5B9A;&#x5728;&#x7279;&#x5B9A;&#x5305;&#x540D;&#x5185;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x52A0;&#x5FEB;&#x6784;&#x5EFA;&#x901F;&#x5EA6;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;class PrivacyClassNode(private val nextVisitor: ClassVisitor) : ClassNode(Opcodes.ASM5) {</span><br><span class="line">    override fun visitEnd() {</span><br><span class="line">        super.visitEnd()</span><br><span class="line">        PrivacyHelper.whiteList.let {</span><br><span class="line">            val result = it.firstOrNull { whiteName -&gt;</span><br><span class="line">                name.contains(whiteName, true)</span><br><span class="line">            }</span><br><span class="line">            result</span><br><span class="line">        }.apply {</span><br><span class="line">            if (this == null) {</span><br><span class="line">                //   println(&quot;filter: $name&quot;)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        PrivacyHelper.whiteList.firstOrNull {</span><br><span class="line">            name.contains(it, true)</span><br><span class="line">        }?.apply {</span><br><span class="line">            val iterator: Iterator&lt;MethodNode&gt; = methods.iterator()</span><br><span class="line">            while (iterator.hasNext()) {</span><br><span class="line">                val method = iterator.next()</span><br><span class="line">                method.instructions?.iterator()?.forEach {</span><br><span class="line">                    if (it is MethodInsnNode) {</span><br><span class="line">                        it.isPrivacy()?.apply {</span><br><span class="line">                            println(&quot;privacy transform classNodeName: ${name@this}&quot;)</span><br><span class="line">                            it.opcode = code</span><br><span class="line">                            it.owner = owner</span><br><span class="line">                            it.name = name</span><br><span class="line">                            it.desc = desc</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        accept(nextVisitor)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private fun MethodInsnNode.isPrivacy(): PrivacyAsmEntity? {</span><br><span class="line">    val pair = PrivacyHelper.privacyList.firstOrNull {</span><br><span class="line">        val first = it.first</span><br><span class="line">        first.owner == owner &amp;&amp; first.code == opcode &amp;&amp; first.name == name &amp;&amp; first.desc == desc</span><br><span class="line">    }</span><br><span class="line">    return pair?.second</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x628A;&#x903B;&#x8F91;&#x62BD;&#x8C61;&#x5B9A;&#x4E49;&#x5728;&#x7C7B;<code>ClassNode</code>&#x5185;&#xFF0C;&#x7136;&#x540E;&#x5728;<code>visitEnd</code>&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x6211;&#x4E4B;&#x524D;&#x8BF4;&#x7684;<code>accept(nextVisitor)</code>&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;&#x6CE8;&#x518C;&#x903B;&#x8F91;&#x4E86;&#xFF0C;&#x548C;&#x6211;&#x524D;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x5185;&#x5BB9;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h1 id="&#x6211;&#x7684;&#x89C2;&#x70B9;"><a href="#&#x6211;&#x7684;&#x89C2;&#x70B9;" class="headerlink" title="&#x6211;&#x7684;&#x89C2;&#x70B9;"></a>&#x6211;&#x7684;&#x89C2;&#x70B9;</h1><p><code>AsmClassVisitorFactory</code>&#x76F8;&#x6BD4;&#x8F83;&#x4E8E;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x786E;&#x5B9E;&#x7B80;&#x5316;&#x4E86;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x5FC3;&#x4E4B;&#x524D;&#x7684;&#x589E;&#x91CF;&#x66F4;&#x65B0;&#x7B49;&#x7B49;&#x903B;&#x8F91;&#xFF0C;&#x53EA;&#x8981;&#x4E13;&#x6CE8;&#x4E8E;asm api&#x7684;&#x64CD;&#x4F5C;&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x5176;&#x6B21;&#x5C31;&#x662F;&#x56E0;&#x4E3A;&#x51CF;&#x5C11;&#x4E86;io&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x901F;&#x5EA6;&#x81EA;&#x7136;&#x4E5F;&#x5C31;&#x6BD4;&#x4E4B;&#x524D;&#x6709;&#x6240;&#x63D0;&#x5347;&#x3002;&#x540C;&#x65F6;&#x56E0;&#x4E3A;&#x57FA;&#x4E8E;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x4F53;&#x6027;&#x80FD;&#x8FD8;&#x662F;&#x975E;&#x5E38;ok&#x7684;&#xFF0C;&#x90A3;&#x90E8;&#x5206;&#x589E;&#x91CF;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x66F4;&#x7B80;&#x5355;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x6211;&#x4E5F;&#x548C;&#x6211;&#x7684;&#x540C;&#x4E8B;&#x5927;&#x4F6C;&#x4EA4;&#x6D41;&#x8FC7;&#x54E6;&#xFF0C;&#x590D;&#x6742;&#x7684;&#x8FD9;&#x79CD;&#x7C7B;&#x4F3C;&#x4E0A;&#x7BC7;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#xFF0C;&#x6700;&#x597D;&#x8FD8;&#x662F;&#x4F7F;&#x7528;<code>Gradle Task</code>&#x7684;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x611F;&#x8C22; <a href="/external_links/bf5bb51389a5b3f64585ab7cb0ea718d.html" target="blank" rel="noopener">2BAB</a> &#x548C; <a href="/external_links/805a04201367bbabc8e0521f2b5c695d.html" target="blank" rel="noopener">&#x68EE;&#x54E5;</a>&#xFF0C;&#x6587;&#x7AE0;&#x5F88;&#x591A;&#x5185;&#x5BB9;&#x90FD;&#x53C2;&#x8003;&#x4E86;&#x51E0;&#x4F4D;&#x5927;&#x4F6C;&#x7684;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6211;&#x6253;&#x7B97;&#x653E;&#x98DE;&#x81EA;&#x5DF1;&#x4E86;&#xFF0C;&#x6587;&#x7AE0;&#x5B57;&#x6570;&#x5C31;&#x968F;&#x4FBF;&#x4E86;&#x5427;&#xFF0C;&#x4E0D;&#x8981;&#x8001;&#x76EF;&#x7740;&#x6587;&#x7AE0;&#x957F;&#x77ED;&#x95EE;&#x9898;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2deba0e41a9fb9d23a891b44798282dd.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015911062771859463.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015911062771859463.html" itemprop="url">pip 常用命令与国内源配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T19:22:04+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</li>
</ul>
<blockquote>
<p>pip&#x9ED8;&#x8BA4;&#x6E90;&#x5B58;&#x5728;&#x901F;&#x5EA6;&#x6162;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x672C;&#x6587;&#x4ECB;&#x7ECD;pip&#x547D;&#x4EE4;&#x6DFB;&#x52A0;&#x56FD;&#x5185;&#x6E90;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
</blockquote>
<h3 id="pip&#x5E38;&#x7528;&#x547D;&#x4EE4;"><a href="#pip&#x5E38;&#x7528;&#x547D;&#x4EE4;" class="headerlink" title="pip&#x5E38;&#x7528;&#x547D;&#x4EE4;"></a>pip&#x5E38;&#x7528;&#x547D;&#x4EE4;</h3><h4 id="&#x5B89;&#x88C5;&#x5305;"><a href="#&#x5B89;&#x88C5;&#x5305;" class="headerlink" title="&#x5B89;&#x88C5;&#x5305;"></a>&#x5B89;&#x88C5;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip install Package</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<h4 id="&#x66F4;&#x65B0;&#x5305;"><a href="#&#x66F4;&#x65B0;&#x5305;" class="headerlink" title="&#x66F4;&#x65B0;&#x5305;"></a>&#x66F4;&#x65B0;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip install -U Package</span><br></pre></td></tr></table></figure>

<h4 id="&#x5378;&#x8F7D;&#x5305;"><a href="#&#x5378;&#x8F7D;&#x5305;" class="headerlink" title="&#x5378;&#x8F7D;&#x5305;"></a>&#x5378;&#x8F7D;&#x5305;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip uninstall Package</span><br></pre></td></tr></table></figure>

<h4 id="&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;"><a href="#&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;" class="headerlink" title="&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;"></a>&#x5217;&#x51FA;&#x5DF2;&#x5B89;&#x88C5;&#x8F6F;&#x4EF6;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;pip list</span><br><span class="line">pip freeze</span><br><span class="line">pip freeze -r requirements.txt</span><br></pre></td></tr></table></figure>

<h4 id="&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;"><a href="#&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;" class="headerlink" title="&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;"></a>&#x67D0;&#x4E2A;&#x5305;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&#x590D;&#x5236;&#x4EE3;&#x7801;pip show -f Package</span><br></pre></td></tr></table></figure>

<h3 id="&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;"><a href="#&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;" class="headerlink" title="&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;"></a>&#x56FD;&#x5185;&#x6E90;&#x914D;&#x7F6E;</h3><h4 id="&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;"><a href="#&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;" class="headerlink" title="&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;"></a>&#x5E38;&#x7528;&#x7684;&#x56FD;&#x5185;&#x955C;&#x50CF;</h4><ul>
<li>&#x963F;&#x91CC;&#x4E91; <a href="/external_links/28c536c1beb72880df307115634edfc5.html" target="blank" rel="noopener">mirrors.aliyun.com/pypi/simple&#x2026;</a></li>
<li>&#x8C46;&#x74E3;<a href="/external_links/460f72cfa998c24c9a67d3979508d16f.html" target="blank" rel="noopener">pypi.douban.com/simple/</a></li>
<li>&#x6E05;&#x534E;&#x5927;&#x5B66; <a href="/external_links/e96bd21ec01a5aba9ba254af4815a81a.html" target="blank" rel="noopener">pypi.tuna.tsinghua.edu.cn/simple/</a></li>
<li>&#x4E2D;&#x56FD;&#x79D1;&#x5B66;&#x6280;&#x672F;&#x5927;&#x5B66; <a href="/external_links/e160b3c6e9d5addbe0d900554bc36e1a.html" target="blank" rel="noopener">pypi.mirrors.ustc.edu.cn/simple/</a></li>
<li>&#x534E;&#x4E2D;&#x79D1;&#x6280;&#x5927;&#x5B66;<a href="/external_links/4e3547260ce2d6ea94486d555504dd02.html" target="blank" rel="noopener">pypi.hustunique.com/</a></li>
</ul>
<p><strong>&#x65B0;&#x7248;ubuntu&#x8981;&#x6C42;&#x4F7F;&#x7528;https&#x6E90;&#xFF0C;&#x8981;&#x6CE8;&#x610F;&#x3002;</strong></p>
<blockquote>
<p>&#x5C31;&#x6211;&#x7684;&#x7ECF;&#x9A8C;&#x6765;&#x8BF4;&#x963F;&#x91CC;&#x4E91;&#x662F;&#x76EE;&#x524D;&#x7528;&#x4E0B;&#x6765;&#x6700;&#x7A33;&#x5B9A;&#x53EF;&#x9760;&#x7684;&#x3002;</p>
</blockquote>
<h4 id="&#x4E34;&#x65F6;&#x4F7F;&#x7528;"><a href="#&#x4E34;&#x65F6;&#x4F7F;&#x7528;" class="headerlink" title="&#x4E34;&#x65F6;&#x4F7F;&#x7528;"></a>&#x4E34;&#x65F6;&#x4F7F;&#x7528;</h4><blockquote>
<p>&#x5728;&#x4F7F;&#x7528;pip&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x4E0A;&#x53C2;&#x6570; <code>-i</code> &#x548C;&#x955C;&#x50CF;&#x5730;&#x5740;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;pip install -i https://mirrors.aliyun.com/pypi/simple/ tensorboard</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4ECE;&#x6E05;&#x534E;&#x6E90;&#x5B89;&#x88C5; tensorboard</p>
</blockquote>
<h4 id="&#x547D;&#x4EE4;&#x914D;&#x7F6E;"><a href="#&#x547D;&#x4EE4;&#x914D;&#x7F6E;" class="headerlink" title="&#x547D;&#x4EE4;&#x914D;&#x7F6E;"></a>&#x547D;&#x4EE4;&#x914D;&#x7F6E;</h4><blockquote>
<p>&#x5728;&#x7EC8;&#x7AEF;&#x8F93;&#x5165;&#x547D;&#x4EE4;&#xFF1A;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;pip install pip -U    # &#x5347;&#x7EA7;pip&#x5230;&#x6700;&#x65B0;&#x7248;&#x672C;</span><br><span class="line">pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x6B64;&#x65B9;&#x6CD5;&#x914D;&#x7F6E;&#x540E;&#x5B89;&#x88C5;&#x5305;&#x65F6;&#x53EF;&#x80FD;&#x4F1A;&#x63D0;&#x793A;&#x4E0B;&#x8F7D;&#x6E90;&#x4E0D;&#x53EF;&#x4FE1;&#xFF0C;&#x9700;&#x8981;&#x624B;&#x52A8;&#x52A0;&#x4E0A;<code>--trusted-host mirrors.aliyun.com</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;The repository located at mirrors.aliyun.com is not a trusted or secure host and is being ignored. If this repository is available via HTTPS we recommend you use HTTPS instead, otherwise you may silence this warning and allow it anyway with &apos;--trusted-host mirrors.aliyun.com&apos;.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x90A3;&#x4E48;&#x9999;&#x4E86;&#xFF0C;&#x4E00;&#x52B3;&#x6C38;&#x9038;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x4FEE;&#x6539;pip&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
</blockquote>
<h4 id="&#x4FEE;&#x6539;&#x914D;&#x7F6E;"><a href="#&#x4FEE;&#x6539;&#x914D;&#x7F6E;" class="headerlink" title="&#x4FEE;&#x6539;&#x914D;&#x7F6E;"></a>&#x4FEE;&#x6539;&#x914D;&#x7F6E;</h4><h5 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h5><blockquote>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&#xFF1A;</p>
</blockquote>
<ul>
<li><code>~/.pip/pip.conf</code></li>
<li><code>~/.config/pip/pip.conf</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<h5 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h5><blockquote>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&#xFF1A;</p>
</blockquote>
<ul>
<li><code>%HOMEPATH%\pip\pip.ini</code>&#xFF0C;&#x5373; <code>C:\Users\pip\pip.ini</code></li>
<li><code>%APPDATA%\pip\pip.ini</code>&#xFF0C;&#x5373;<code>C:\Users\AppData\Roaming\pip\pip.ini</code></li>
</ul>
<blockquote>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;cmd&#x4E2D;&#x8F93;&#x5165; <code>echo %APPDATA%</code> &#x6216; <code>echo %HOMEPATH%</code> &#x67E5;&#x770B;&#x81EA;&#x5DF1;&#x7684;&#x76F8;&#x5173;&#x8DEF;&#x5F84;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yml&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<h4 id="&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;"><a href="#&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;" class="headerlink" title="&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;"></a>&#x8C03;&#x6574;&#x6E90;&#x5730;&#x5740;</h4><ul>
<li><code>http</code>&#x4E0D;&#x53EF;&#x4FE1;&#xFF0C;&#x5C06;&#x6E90;&#x5730;&#x5740;&#x4FEE;&#x6539;&#x4E3A; <code>https</code> &#x4E5F;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x4FE1;&#x4EFB;&#x5371;&#x673A;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[global]</span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>

<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2734c44683c0155f02a214eab84ccb72.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015855422049353741.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015855422049353741.html" itemprop="url">随手记   AOP 如何避开 BeanNotOfRequir</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T15:48:35+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x4ECA;&#x5929;&#x5BF9; Spring &#x8FDB;&#x884C;&#x6DF1;&#x5EA6;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019; , &#x60F3;&#x4EFF;&#x7167; AOP &#x53BB;&#x5B9E;&#x73B0;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7406; , &#x4F46;&#x662F;&#x5374;&#x89E6;&#x53D1;&#x4E86; <strong>BeanNotOfRequiredTypeException</strong> &#x5F02;&#x5E38; , &#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; Spring &#x4F1A;&#x8FDB;&#x884C;&#x7C7B;&#x7684;&#x6821;&#x9A8C;</p>
<p>&#x4E8E;&#x662F;&#x7A81;&#x7136;&#x4EA7;&#x751F;&#x4E86;&#x597D;&#x5947; , &#x51B3;&#x5B9A;&#x7814;&#x7A76;&#x4E00;&#x4E0B; , AOP &#x662F;&#x901A;&#x8FC7;&#x4EC0;&#x4E48;&#x65B9;&#x5F0F;&#x907F;&#x5F00;&#x8FD9;&#x4E2A;&#x6821;&#x9A8C;&#x8FC7;&#x7A0B;</p>
<h2 id="&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;"><a href="#&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;" class="headerlink" title="&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;"></a>&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;</h2><ul>
<li>AOP &#x901A;&#x8FC7; AopProxy &#x8FDB;&#x884C;&#x4EE3;&#x7406;</li>
<li>SpringBoot 1.5 &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; JDK Proxy , SpringBoot 2.0 &#x57FA;&#x4E8E;&#x81EA;&#x52A8;&#x88C5;&#x914D;(AopAutoConfiguration)&#x7684;&#x914D;&#x7F6E; , &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; CGlib</li>
</ul>
<blockquote>
<p>JDK Proxy &#x548C; CGLib &#x7684;&#x533A;&#x522B;</p>
</blockquote>
<p><strong>&#x8001;&#x751F;&#x5E38;&#x8C08;&#x7684;&#x95EE;&#x9898; , &#x95EE;&#x4E86;&#x5B8C;&#x6574;&#x6027;(&#x51D1;&#x5B57;&#x6570;) , &#x8FD8;&#x662F;&#x7B80;&#x5355;&#x5217;&#x4E00;&#x4E0B; :</strong></p>
<ul>
<li>JDK Proxy : &#x5229;&#x7528;&#x62E6;&#x622A;&#x5668;(&#x62E6;&#x622A;&#x5668;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;InvocationHanlder)&#x52A0;&#x4E0A;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;&#x4EE3;&#x7406;&#x63A5;&#x53E3;&#x7684;&#x533F;&#x540D;&#x7C7B;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x65B9;&#x6CD5;&#x524D;&#x8C03;&#x7528;InvokeHandler&#x6765;&#x5904;&#x7406;&#x3002;</li>
<li>CGLIB&#x52A8;&#x6001;&#x4EE3;&#x7406;:&#x5229;&#x7528;ASM&#x5F00;&#x6E90;&#x5305;&#xFF0C;&#x5BF9;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7C7B;&#x7684;class&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x8FDB;&#x6765;&#xFF0C;&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5176;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x5B50;&#x7C7B;&#x6765;&#x5904;&#x7406;&#x3002;</li>
</ul>
<p><strong>PS : &#x901A;&#x8FC7; proxy-target-class &#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</strong></p>
<h2 id="&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;"><a href="#&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;" class="headerlink" title="&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;"></a>&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;</h2><p>&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x662F; CGLIB , &#x6240;&#x4EE5;&#x4E3B;&#x6D41;&#x7A0B;&#x8FD8;&#x662F;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5206;&#x6790; , &#x6709;&#x4E86;&#x524D;&#x7F6E;&#x77E5;&#x8BC6;&#x7684;&#x8865;&#x5145; , &#x5B9E;&#x73B0;&#x731C;&#x6D4B;&#x662F;&#x7531;&#x4E8E; CGLIB &#x7684;&#x7279;&#x6027; , &#x5B9E;&#x9645;&#x4E0A;&#x88AB;&#x6821;&#x9A8C;&#x51FA;&#x6765;.</p>
<ul>
<li><strong>&#x6E90;&#x5934;</strong> :autowired &#x5BFC;&#x5165;&#x5F97;&#x65F6;&#x5019;&#x4F1A;&#x6821;&#x9A8C;&#x6CE8;&#x5165;&#x7684;&#x7C7B;&#x662F;&#x5426;&#x6B63;&#x786E;</li>
</ul>
<h3 id="3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"><a href="#3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;" class="headerlink" title="3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"></a>3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;</h3><ul>
<li>Step 1 : AbstractAutowireCapableBeanFactory # populateBean</li>
<li>Step 2 : AutowiredAnnotationBeanPostProcessor # postProcessProperties</li>
<li>Step 3 : InjectionMetadata # inject</li>
<li>Step 4 : AutowiredAnnotationBeanPostProcessor # inject</li>
<li>Step 5 : DefaultListableBeanFactory # doResolveDependency</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,</span><br><span class="line">      @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {</span><br><span class="line"></span><br><span class="line">      //............ &#x4EE5;&#x4E0B;&#x662F;&#x4E3B;&#x8981;&#x903B;&#x8F91; </span><br><span class="line"></span><br><span class="line">      if (autowiredBeanNames != null) {</span><br><span class="line">         autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x83B7;&#x53D6; Autowired &#x7684;&#x5B9E;&#x9645;&#x5BF9;&#x8C61;&#x6216;&#x8005;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span><br><span class="line">      if (instanceCandidate instanceof Class) {</span><br><span class="line">         instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5224;&#x65AD;&#x8BE5;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x4E3A;null</span><br><span class="line">      Object result = instanceCandidate;</span><br><span class="line">      if (result instanceof NullBean) {</span><br><span class="line">         if (isRequired(descriptor)) {</span><br><span class="line">            raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">         }</span><br><span class="line">         result = null;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x6838;&#x5FC3;&#x62E6;&#x622A;&#x903B;&#x8F91;</span><br><span class="line">      if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">         throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"><a href="#3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;" class="headerlink" title="3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"></a>3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">    </span><br><span class="line">    // &#x7C7B;&#x578B;&#x5224;&#x65AD;</span><br><span class="line">    if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">        return true;</span><br><span class="line">    } else {</span><br><span class="line">        Class resolvedWrapper;</span><br><span class="line">        </span><br><span class="line">        // &#x57FA;&#x672C;&#x7C7B;&#x578B;&#x7279;&#x6B8A;&#x5904;&#x7406;</span><br><span class="line">        if (lhsType.isPrimitive()) {</span><br><span class="line">            resolvedWrapper = (Class)primitiveWrapperTypeMap.get(rhsType);</span><br><span class="line">            return lhsType == resolvedWrapper;</span><br><span class="line">        } else {</span><br><span class="line">            resolvedWrapper = (Class)primitiveTypeToWrapperMap.get(rhsType);</span><br><span class="line">            return resolvedWrapper != null &amp;&amp; lhsType.isAssignableFrom(resolvedWrapper);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-AOP-&#x7684;&#x4F7F;&#x7528;"><a href="#3-3-AOP-&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="3.3 AOP &#x7684;&#x4F7F;&#x7528;"></a>3.3 AOP &#x7684;&#x4F7F;&#x7528;</h3><p>&#x770B;&#x5230;&#x4E86;&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3; , &#x90A3;&#x5C31;&#x5F97;&#x770B;&#x770B; AOP &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x901A;&#x8FC7; PostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684;&#x4E86; , &#x9996;&#x5148;&#x770B;&#x4E00;&#x4E0B; PostProcessor &#x94FE;&#x8868;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a6a7be386790c1ba8cbc3fb0b837cbdbb912e9cfce5e52e9a47315e988a971a9" alt="image.png"></p>
<blockquote>
<p>Step 1 : &#x5F53;&#x5BF9;&#x8C61; A &#x4E2D;&#x5B57;&#x6BB5;&#x662F; @Autowired &#x6CE8;&#x5165;&#x7684; AOP &#x4EE3;&#x7406;&#x7C7B;&#x65F6;</p>
</blockquote>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0; , &#x5728; DefaultListableBeanFactory # doResolveDependency &#x73AF;&#x8282;&#x4F1A;&#x53BB;&#x83B7;&#x53D6;&#x8BE5;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x5BF9;&#x8C61; ,<br>&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x83B7;&#x53D6;&#x5BF9;&#x8C61;&#x73AF;&#x8282;</span><br><span class="line">if (instanceCandidate instanceof Class) { </span><br><span class="line">   // &#x6B64;&#x65F6;&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x4E00;&#x4E2A; cglib &#x4EE3;&#x7406;&#x7C7B;</span><br><span class="line">   instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/aef7575ca1ddc94558c71bc7de00e268839f779e598d150effe56d2df5c550af" alt="image.png"></p>
<blockquote>
<p>Step 2 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x5165;&#x53E3;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB; -&gt; true</span><br><span class="line">if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">   throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// result.getClass()</span><br><span class="line">- name=com.gang.aop.demo.service.StartService$$EnhancerBySpringCGLIB$$d673b902</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 3 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x903B;&#x8F91;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;C- ClassUtils</span><br><span class="line">public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">   </span><br><span class="line">   // &#x6838;&#x5FC3;&#x8BED;&#x53E5; , native &#x65B9;&#x6CD5; -&gt; public native boolean isAssignableFrom(Class&lt;?&gt; cls);</span><br><span class="line">   if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">      return true;</span><br><span class="line">   }</span><br><span class="line">   //.........</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x7EE7;&#x627F;&#x7C7B; , ChildService extends ChildService</span><br><span class="line">: ------&gt; ChildService By ParentService :false &lt;-------</span><br><span class="line">: ------&gt; ParentService By ChildService:true &lt;-------</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x6B64;&#x53EF;&#x89C1; cglib &#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x6EE1;&#x8DB3;&#x8BE5;&#x6761;&#x4EF6; : <strong>&#x76F8;&#x540C; , &#x6216;&#x8005;&#x662F;&#x8D85;&#x7C7B;&#x6216;&#x8005;&#x8D85;&#x63A5;&#x53E3;</strong></p>
<p><strong>&#x8FD9;&#x91CC;&#x56DE;&#x8FC7;&#x5934;&#x770B;&#x4E4B;&#x524D;&#x7684;&#x95EE;&#x9898; , &#x5C31;&#x5F88;&#x7B80;&#x5355;&#x4E86; :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x95EE;&#x9898;&#x539F;&#x56E0; : </span><br><span class="line">&#x6211;&#x901A;&#x8FC7;&#x5B9E;&#x73B0; postProcessor &#x53BB;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x4EE3;&#x7406; </span><br><span class="line">public class AopProxyImpl extends Sourceable {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line">// &#x4FEE;&#x6539;&#x540E; : </span><br><span class="line">public class AopProxyImpl extends Source {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x5373;&#x53EF;&#x89E3;&#x51B3; BeanNotOfRequiredTypeException ,&#x5F04;&#x61C2;&#x4E86;&#x5C31;&#x6CA1;&#x4EC0;&#x4E48;&#x96BE;&#x5EA6;&#x4E86;</span><br><span class="line">//</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;"><a href="#&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;" class="headerlink" title="&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;"></a>&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;</h2><p>&#x90A3;&#x4E48;&#x7EE7;&#x7EED;&#x56DE;&#x987E;&#x4E0B; CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B; , &#x5B9E;&#x9645;&#x4E0A;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x7ED3;&#x679C;&#x4E0A;&#x662F;&#x53EF;&#x4EE5;&#x5F88;&#x76F4;&#x89C2;&#x7684;&#x770B;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x5BF9;&#x8C61;&#x7684; :</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ab4b2dc66710c0288633a3f2a7a34cf5930c8d5263cd85cdf8ee62dc25213235" alt="image.png"></p>
<p>&#x5173;&#x4E8E; CGLIB &#x7684;&#x57FA;&#x7840; , &#x53EF;&#x4EE5;&#x770B;&#x770B;&#x83DC;&#x9E1F;&#x7684;&#x6587;&#x6863; <a href="/external_links/fe1ac05d25dbc344520f0c285b601cf1.html" target="blank" rel="noopener">CGLIB(Code Generation Library) &#x4ECB;&#x7ECD;&#x4E0E;&#x539F;&#x7406;</a> , &#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;</p>
<h3 id="4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"><a href="#4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;" class="headerlink" title="4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"></a>4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;</h3><blockquote>
<p>FastClass &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>FastClass &#x5C31;&#x662F;&#x7ED9;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x7F16;&#x53F7;&#xFF0C;&#x901A;&#x8FC7;&#x7F16;&#x53F7;&#x627E;&#x5230;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x9891;&#x7E41;&#x4F7F;&#x7528;&#x53CD;&#x5C04;&#x5BFC;&#x81F4;&#x6548;&#x7387;&#x6BD4;&#x8F83;&#x4F4E;</p>
<p>CGLIB &#x4F1A;&#x751F;&#x6210;2&#x4E2A; fastClass :</p>
<ul>
<li>xxxx$$FastClassByCGLIB$$xxxx :<strong>&#x4E3A;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
<li>xxxx$$EnhancerByCGLIB$$xxxx$$FastClassByCGLIB$$xxxx : <strong>&#x4E3A;&#x6211;&#x4EEC;&#x88AB;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x5305;&#x542B;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
</ul>
<p><strong>&#x539F;&#x56E0; :</strong> cglib&#x4EE3;&#x7406;&#x57FA;&#x4E8E;&#x7EE7;&#x627F;&#x5B9E;&#x73B0;&#xFF0C;&#x7236;&#x7C7B;&#x4E2D;&#x975E;public&#x3001;final&#x7684;&#x65B9;&#x6CD5;&#x65E0;&#x6CD5;&#x88AB;&#x7EE7;&#x627F;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#x7684;fastclass&#x6765;&#x8C03;&#x7528;&#x4EE3;&#x7406;&#x4E0D;&#x5230;&#x7684;&#x65B9;&#x6CD5;</p>
<p>FastClass &#x4E2D;&#x6709;2&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x65B9;&#x6CD5; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4EE3;&#x7406;&#x65B9;&#x6CD5;</span><br><span class="line">public Object invoke(final int n, final Object o, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    final CglibService cglibService = (CglibService)o;</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x4EE3;&#x7406;&#x5BF9;&#x5E94;&#x7684;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;</span><br><span class="line">            cglibService.run();</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        case 1: {</span><br><span class="line">            // &#x4EE3;&#x7406; equeals &#x65B9;&#x6CD5;</span><br><span class="line">            return new Boolean(cglibService.equals(array[0]));</span><br><span class="line">        }</span><br><span class="line">        case 2: {</span><br><span class="line">            // &#x4EE3;&#x7406; toString &#x65B9;&#x6CD5;</span><br><span class="line">            return cglibService.toString();</span><br><span class="line">        }</span><br><span class="line">        case 3: {</span><br><span class="line">            // &#x4EE3;&#x7406; hashCode &#x65B9;&#x6CD5; </span><br><span class="line">            return new Integer(cglibService.hashCode());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61; </span><br><span class="line">public Object newInstance(final int n, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x6B64;&#x5904;&#x603B;&#x7ED3;&#x901A;&#x8FC7; new &#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;</span><br><span class="line">            return new CglibService();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>enchance &#x5BF9;&#x8C61;</p>
</blockquote>
<p>&#x4E4B;&#x524D;&#x4E86;&#x89E3;&#x5230; , cglib &#x901A;&#x8FC7;&#x91CD;&#x5199;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x4E3B;&#x7C7B;&#x8FBE;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x76EE;&#x7684; , &#x8FD9;&#x91CC;&#x6765;&#x770B;&#x4E00;&#x4E0B; , &#x539F;&#x65B9;&#x6CD5;&#x88AB;&#x6539;&#x5199;&#x6210;&#x4EC0;&#x4E48;&#x6837;&#x4E86;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;final void CGLIB$run$0() {</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">public final void run() {</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_2;</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_0;</span><br><span class="line">    if ((cglib$CALLBACK_0 = (cglib$CALLBACK_2 = this.CGLIB$CALLBACK_0)) == null) {</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        cglib$CALLBACK_2 = (cglib$CALLBACK_0 = this.CGLIB$CALLBACK_0);</span><br><span class="line">    }</span><br><span class="line">    if (cglib$CALLBACK_0 != null) {</span><br><span class="line">        // &#x8C03;&#x7528;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61;</span><br><span class="line">        cglib$CALLBACK_2.intercept((Object)this, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Method, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$emptyArgs, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Proxy);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    // &#x6CA1;&#x6709;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61; , &#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5B9E;&#x9645;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x62E6;&#x622A;&#x5668;</span><br><span class="line">public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {</span><br><span class="line">    </span><br><span class="line">    // &#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x5173;&#x8054;&#x7C7B;</span><br><span class="line">    // &#x6700;&#x7EC8;&#x901A;&#x8FC7; super.run &#x8C03;&#x7528;</span><br><span class="line">    Object result = proxy.invokeSuper(obj, args);     </span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x5904;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6620;&#x5C04;&#x5173;&#x7CFB;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/68c60d7f3d943afcfdb02123ea31bbe49c87333a130cc1385f495f0498978ab3" alt="image.png"></p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9fbe35eb4f090ddb29e2860952eb6fc2ed40f1c0e1f72c114be21c20faf96b2" alt="cglib.jpg"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/627bf1768683d8531a3aa9aa1e9574f6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015539581927833636.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015539581927833636.html" itemprop="url">盘点 Spring   Conditional</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-05T19:25:02+08:00">
                2021-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x6765;&#x770B;&#x4E00;&#x4E0B;Conditional&#x7684;&#x4F7F;&#x7528;&#x548C;&#x539F;&#x7406; , &#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f5da8494fdc3dbfb82db38462ff9127df6675d9aac36f2e1f449b7501281945a" alt="System-SpringBootCondition.png"></p>
<h2 id="&#x4E8C;-&#x4F7F;&#x7528;"><a href="#&#x4E8C;-&#x4F7F;&#x7528;" class="headerlink" title="&#x4E8C; . &#x4F7F;&#x7528;"></a>&#x4E8C; . &#x4F7F;&#x7528;</h2><ul>
<li>@ConditionalOnBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6CA1;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnSingleCandidate&#xFF1A;&#x5F53;&#x6307;&#x5B9A; Bean &#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#xFF0C;&#x6216;&#x8005;&#x867D;&#x7136;&#x6709;&#x591A;&#x4E2A;&#x4F46;&#x662F;&#x6307;&#x5B9A;&#x9996;&#x9009; Bean</li>
<li>@ConditionalOnClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnProperty&#xFF1A;&#x6307;&#x5B9A;&#x7684;&#x5C5E;&#x6027;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnResource&#xFF1A;&#x7C7B;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnExpression&#xFF1A;&#x57FA;&#x4E8E; SpEL &#x8868;&#x8FBE;&#x5F0F;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x3002;</li>
<li>@ConditionalOnJava&#xFF1A;&#x57FA;&#x4E8E; Java &#x7248;&#x672C;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;</li>
<li>@ConditionalOnJndi&#xFF1A;&#x5728; JNDI &#x5B58;&#x5728;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x5DEE;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x4F4D;&#x7F6E;</li>
<li>@ConditionalOnNotWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x4E0D;&#x662F; Web &#x9879;&#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
<li>@ConditionalOnWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x662F; Web&#x9879; &#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
</ul>
<h3 id="2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><h3 id="2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional"><a href="#2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional" class="headerlink" title="2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional"></a>2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DefaultConditional implements Condition {</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">        logger.info(&quot;------&gt; &#x8FDB;&#x884C; Conditional &#x5224;&#x65AD; &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Bean</span><br><span class="line">@ConditionalOnBean(TestService.class)</span><br><span class="line">public ConfigBean getConfigBean() {</span><br><span class="line">    logger.info(&quot;------&gt; &#x5F00;&#x59CB;&#x52A0;&#x8F7D; ConditionalOnBean &lt;-------&quot;);</span><br><span class="line">    return new ConfigBean();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"><a href="#&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;" class="headerlink" title="&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"></a>&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;</h2><h3 id="3-1-Conditional-&#x5165;&#x53E3;"><a href="#3-1-Conditional-&#x5165;&#x53E3;" class="headerlink" title="3.1 Conditional &#x5165;&#x53E3;"></a>3.1 Conditional &#x5165;&#x53E3;</h3><p>&#x5BF9;&#x4E8E; Configuration.@Bean &#x7684;&#x521B;&#x5EFA;&#x65B9;&#x5F0F; , Conditinal &#x7684;&#x8D77;&#x70B9;&#x662F; <strong>refush# invokeBeanFactoryPostProcessors</strong> , &#x5728;&#x5176;&#x4E2D;&#x4F1A;&#x8C03;&#x7528; <strong>ConfigurationClassPostProcessor</strong> &#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) {</span><br><span class="line"></span><br><span class="line">  // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D; Configuration &#x4E2D; @Bean &#x7684;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;</span><br><span class="line">  ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line">  MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line">  String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line">  // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x8DF3;&#x8FC7;&#x5F53;&#x524D; Bean</span><br><span class="line">  if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) {</span><br><span class="line">     configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">  if (configClass.skippedBeanMethods.contains(methodName)) {</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"><a href="#3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;" class="headerlink" title="3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"></a>3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;</h3><p>ConditionEvaluator &#x662F;&#x6838;&#x5FC3;&#x5904;&#x7406;&#x7C7B; , &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x8DF3;&#x8FC7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConditionEvaluator</span><br><span class="line">public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5982;&#x679C;&#x5F53;&#x524D; Bean &#x4E0D;&#x5305;&#x542B; @Conditional , &#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">   if (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) {</span><br><span class="line">      return false;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">    // Step 2 : &#x6709;2&#x79CD; ConfigurationPhase &#x7684;&#x7C7B;&#x578B; , &#x8868;&#x793A;2&#x79CD;&#x914D;&#x7F6E;&#x7684;&#x9636;&#x6BB5;</span><br><span class="line">    // PARSE_CONFIGURATION :Condition&#x5E94;&#x8BE5;&#x5728;&#x89E3;&#x6790;@Configuration&#x7C7B;&#x65F6;&#x8FDB;&#x884C;&#x8BA1;&#x7B97; , &#x5982;&#x679C;&#x6B64;&#x65F6;&#x6761;&#x4EF6;&#x4E0D;&#x5339;&#x914D;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x6DFB;&#x52A0;@Configuration&#x7C7B;</span><br><span class="line">    // REGISTER_BEAN : &#x6761;&#x4EF6;&#x4E0D;&#x4F1A;&#x963B;&#x6B62;@Configuration&#x7C7B;&#x88AB;&#x6DFB;&#x52A0; , &#x5728;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x6240;&#x6709;@Configuration&#x7C7B;&#x90FD;&#x5C06;&#x88AB;&#x89E3;&#x6790;</span><br><span class="line">   if (phase == null) {</span><br><span class="line">      if (metadata instanceof AnnotationMetadata &amp;&amp;</span><br><span class="line">            ConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) {</span><br><span class="line">         return shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">      }</span><br><span class="line">      return shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 3 : &#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684; Condition &#x5BF9;&#x8C61;</span><br><span class="line">   List&lt;Condition&gt; conditions = new ArrayList&lt;&gt;();</span><br><span class="line">   for (String[] conditionClasses : getConditionClasses(metadata)) {</span><br><span class="line">      for (String conditionClass : conditionClasses) {</span><br><span class="line">         Condition condition = getCondition(conditionClass, this.context.getClassLoader());</span><br><span class="line">         conditions.add(condition);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 4 : &#x6392;&#x5E8F; </span><br><span class="line">   AnnotationAwareOrderComparator.sort(conditions);</span><br><span class="line"></span><br><span class="line">   for (Condition condition : conditions) {</span><br><span class="line">      ConfigurationPhase requiredPhase = null;</span><br><span class="line">      if (condition instanceof ConfigurationCondition) {</span><br><span class="line">         requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();</span><br><span class="line">      }</span><br><span class="line">      // Step 5 : &#x6700;&#x7EC8;&#x7684; Condition &#x5339;&#x914D;&#x8FC7;&#x7A0B;</span><br><span class="line">      if ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) {</span><br><span class="line">         return true;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   return false;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x76F4;&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x5F00;&#x59CB;&#x5339;&#x914D;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;</p>
<h2 id="&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"><a href="#&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;" class="headerlink" title="&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"></a>&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;</h2><blockquote>
<p>&#x89E3;&#x6790;</p>
</blockquote>
<p>&#x5DF2;&#x77E5;&#x7684;Conditional &#x662F;&#x57FA;&#x4E8E; SpringBootCondition &#x5B9E;&#x73B0;&#x7684; , &#x5176;&#x5177;&#x4F53;&#x62BD;&#x8C61;&#x7C7B;&#x4E3A; FilteringSpringBootCondition , &#x770B;&#x4E00;&#x4E0B;&#x4E3B;&#x8981;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f710068f336807b5d041b0adc38d217037016de24f896e2bbfc3ab0679890651" alt="System_FilteringSpringBootCondition.png"></p>
<blockquote>
<p>&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x7684;&#x7C7B;</p>
</blockquote>
<p>&#x7B2C;&#x4E00;&#x6B65;&#x662F;&#x5FEB;&#x901F;&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7C7B; , &#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#x5982;&#x4E0B; :</p>
<ul>
<li><strong>&#x8D77;&#x70B9;</strong> : AbstractApplicationContext # refresh # invokeBeanFactoryPostProcessors</li>
<li><strong>&#x5904;&#x7406;</strong> : ConfigurationClassPostProcessor # postProcessBeanDefinitionRegistry &#x5904;&#x7406;&#x4E3B;&#x8981;&#x903B;&#x8F91;</li>
<li><strong>&#x62E6;&#x622A;</strong> : ConfigurationClassFilter # filter</li>
<li><strong>&#x5339;&#x914D;</strong> : FilteringSpringBootCondition # match</li>
</ul>
<p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x662F;&#x8FDB;&#x884C; match &#x5339;&#x914D; ,&#x76EE;&#x7684;&#x662F;&#x83B7;&#x53D6;&#x57FA;&#x4E8E;&#x6B63;&#x5728;&#x5BFC;&#x5165;&#x7684;Configuration&#x7C7B;&#x7684;AnnotationMetadata&#x7684;AutoConfigurationEntry</strong></p>
<h3 id="4-1-Filter-&#x62E6;&#x622A;"><a href="#4-1-Filter-&#x62E6;&#x622A;" class="headerlink" title="4.1 Filter &#x62E6;&#x622A;"></a>4.1 Filter &#x62E6;&#x622A;</h3><p>Filter &#x62E6;&#x622A;&#x662F;&#x5728; ConfigurationClassFilter ,&#x5176;&#x4E2D;&#x4F1A;&#x5BF9;&#x6240;&#x6709;&#x7684; Conditional &#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private static class ConfigurationClassFilter {</span><br><span class="line"></span><br><span class="line">   // &#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7684;&#x5143;&#x6570;&#x636E;</span><br><span class="line">   private final AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; filter(List&lt;String&gt; configurations) {</span><br><span class="line">      long startTime = System.nanoTime();</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x4E3A;&#x6240;&#x6709;&#x7684; Confiturations &#x7C7B;</span><br><span class="line">      String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">      boolean skipped = false;</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x5305;&#x542B; OnBeanCondition , OnClassCondition  ,OnWebApplicationCondition &#x4E09;&#x79CD;</span><br><span class="line">      for (AutoConfigurationImportFilter filter : this.filters) {</span><br><span class="line">         // &#x83B7;&#x53D6;&#x662F;&#x5426; &#x5B58;&#x5728; match &#x5339;&#x914D;</span><br><span class="line">         boolean[] match = filter.match(candidates, this.autoConfigurationMetadata);</span><br><span class="line">         for (int i = 0; i &lt; match.length; i++) {</span><br><span class="line">            if (!match[i]) {</span><br><span class="line">               candidates[i] = null;</span><br><span class="line">               skipped = true;</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      if (!skipped) {</span><br><span class="line">         return configurations;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5982;&#x679C;&#x4E0D;&#x80FD;&#x8DF3;&#x8FC7; , &#x8BB0;&#x5F55;&#x5F53;&#x524D; Confiturations &#x7C7B;</span><br><span class="line">      List&lt;String&gt; result = new ArrayList&lt;&gt;(candidates.length);</span><br><span class="line">      for (String candidate : candidates) {</span><br><span class="line">         if (candidate != null) {</span><br><span class="line">            result.add(candidate);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;"><a href="#4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;" class="headerlink" title="4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;"></a>4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;</h3><p>&#x6B64;&#x5904;&#x662F;&#x91CD;&#x5199;&#x4E86;&#x5176;&#x7236;&#x7C7B;&#x7684; match &#x65B9;&#x6CD5;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public boolean[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">   // Step 1 :  &#x51C6;&#x5907; Report &#x5BF9;&#x8C61; , &#x7528;&#x4E8E;&#x8BB0;&#x5F55;</span><br><span class="line">   ConditionEvaluationReport report = ConditionEvaluationReport.find(this.beanFactory);</span><br><span class="line">   // Step 2 : &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6240;&#x6709;&#x7684; Condition &#x65B9;&#x6CD5;</span><br><span class="line">   ConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses, autoConfigurationMetadata);</span><br><span class="line">   </span><br><span class="line">   boolean[] match = new boolean[outcomes.length];</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">   </span><br><span class="line">      // &#x5BF9;match&#x4E2D;&#x7684;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x8D4B;&#x503C;,&#x5F53;outcomes&#x5BF9;&#x5E94;&#x4E0B;&#x6807;&#x7684;ConditionOutcome&#x5339;&#x914D;&#x65F6;&#x4E3A;true.&#x5176;&#x4ED6;&#x60C5;&#x51B5;,&#x8FD4;&#x56DE;false</span><br><span class="line">      match[i] = (outcomes[i] == null || outcomes[i].isMatch());</span><br><span class="line">      if (!match[i] &amp;&amp; outcomes[i] != null) {</span><br><span class="line">          // &#x8BB0;&#x5F55;&#x65E5;&#x5FD7;</span><br><span class="line">         logOutcome(autoConfigurationClasses[i], outcomes[i]);</span><br><span class="line">         if (report != null) {</span><br><span class="line">            // &#x50CF; ConditionEvaluationReport # SortedMap &#x5B58;&#x653E;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</span><br><span class="line">            report.recordConditionEvaluation(autoConfigurationClasses[i], this, outcomes[i]);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return match;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ConditionEvaluationReport &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x81EA;&#x52A8;&#x5316;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x4E2D;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x53CA;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public final class ConditionEvaluationReport {</span><br><span class="line"></span><br><span class="line">    //bean&#x540D;&#x79F0;</span><br><span class="line">    private static final String BEAN_NAME = &quot;autoConfigurationReport&quot;;</span><br><span class="line">    </span><br><span class="line">    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7236;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private static final AncestorsMatchedCondition ANCESTOR_CONDITION = new AncestorsMatchedCondition();</span><br><span class="line">    </span><br><span class="line">    //&#x5B58;&#x653E;&#x7C7B;&#x540D;&#x6216;&#x65B9;&#x6CD5;&#x540D;&#xFF08;key&#xFF09;,&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x8F93;&#x51FA;&#x5BF9;&#x8C61;&#xFF08;value&#xFF09;</span><br><span class="line">    private final SortedMap&lt;String, ConditionAndOutcomes&gt; outcomes = new TreeMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    //&#x662F;&#x5426;&#x662F;&#x539F;&#x59CB;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private boolean addedAncestorOutcomes;</span><br><span class="line">    //&#x7236;&#x7684;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x62A5;&#x544A;&#x5BF9;&#x8C61;</span><br><span class="line">    private ConditionEvaluationReport parent;</span><br><span class="line">    </span><br><span class="line">    //&#x8BB0;&#x5F55;&#x5DF2;&#x7ECF;&#x4ECE;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x4E2D;&#x6392;&#x9664;&#x7684;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final List&lt;String&gt; exclusions = new ArrayList&lt;&gt;();</span><br><span class="line">    //&#x8BB0;&#x5F55;&#x4F5C;&#x4E3A;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x7684;&#x5019;&#x9009;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final Set&lt;String&gt; unconditionalClasses = new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-3-getOutcomes-&#x83B7;&#x53D6;"><a href="#4-3-getOutcomes-&#x83B7;&#x53D6;" class="headerlink" title="4.3 getOutcomes &#x83B7;&#x53D6;"></a>4.3 getOutcomes &#x83B7;&#x53D6;</h3><p>&#x6B64;&#x5904;&#x4EE5; OnBean &#x4E3A;&#x4F8B; , &#x6B64;&#x5904;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x5173;&#x8054;&#x5173;&#x7CFB; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected final ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,</span><br><span class="line">      AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">      </span><br><span class="line">   // Step 1 : &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x548C;&#x5904;&#x7406;&#x7C7B;&#x7B49;&#x5BB9;&#x91CF;&#x7684;&#x6570;&#x7EC4;</span><br><span class="line">   ConditionOutcome[] outcomes = new ConditionOutcome[autoConfigurationClasses.length];</span><br><span class="line">   </span><br><span class="line">   // Step 2 : &#x904D;&#x5386;&#x6240;&#x6709;&#x7684; autoConfigurationClasses</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">      String autoConfigurationClass = autoConfigurationClasses[i];</span><br><span class="line">      </span><br><span class="line">      if (autoConfigurationClass != null) {</span><br><span class="line">          </span><br><span class="line">         Set&lt;String&gt; onBeanTypes = autoConfigurationMetadata.getSet(autoConfigurationClass, &quot;ConditionalOnBean&quot;);</span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728; ConditionalOnBean &#x6807;&#x6CE8;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">         outcomes[i] = getOutcome(onBeanTypes, ConditionalOnBean.class);</span><br><span class="line">         </span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8F93;&#x51FA; ConditionOutcome </span><br><span class="line">         if (outcomes[i] == null) {</span><br><span class="line">            Set&lt;String&gt; onSingleCandidateTypes = autoConfigurationMetadata.getSet(autoConfigurationClass,</span><br><span class="line">                  &quot;ConditionalOnSingleCandidate&quot;);</span><br><span class="line">            // &#x6B64;&#x5904;&#x662F;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x8981;&#x5904;&#x7406;</span><br><span class="line">            outcomes[i] = getOutcome(onSingleCandidateTypes, ConditionalOnSingleCandidate.class);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return outcomes;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"><a href="#4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;" class="headerlink" title="4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"></a>4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</h3><p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x7684; matches &#x548C; FilteringSpringBootCondition &#x4E0D;&#x662F;&#x4E00;&#x4E2A;</strong></p>
<ul>
<li>FilteringSpringBootCondition # match : &#x57FA;&#x4E8E; AutoConfigurationImportFilter , &#x5BF9;&#x7ED9;&#x5B9A;&#x7684;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7C7B;&#x5019;&#x9009;&#x5E94;&#x7528;&#x7B5B;&#x9009;&#x5668;</li>
<li>SpringBootCondition # matches : &#x9700;&#x8981;&#x8FD4;&#x56DE;&#x6700;&#x7EC8;&#x7684;&#x5224;&#x65AD;&#x7ED3;&#x679C;</li>
</ul>
<blockquote>
<p>&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
</blockquote>
<ul>
<li>&#x5728; loadBeanDefinitionsForBeanMethod &#x7B49;&#x7C7B;&#x4F3C;&#x6D41;&#x7A0B;&#x79CD;&#x8C03;&#x7528; shouldSkip , &#x4ECE;&#x800C;&#x8DF3;&#x8F6C;&#x5230;&#x8BE5;&#x903B;&#x8F91;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public final boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line"></span><br><span class="line">   // &#x83B7;&#x53D6;&#x6CE8;&#x89E3;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x6216;&#x8005;&#x7C7B;&#x540D;</span><br><span class="line">   String classOrMethodName = getClassOrMethodName(metadata);</span><br><span class="line">   try {</span><br><span class="line">   </span><br><span class="line">      // &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7C7B; , &#x6B64;&#x5904;&#x4F1A;&#x5224;&#x65AD; metadata instanceof , &#x6709;&#x9650;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; ClassMetadata</span><br><span class="line">      ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br><span class="line">      </span><br><span class="line">      // &#x5F88;&#x7B80;&#x5355;&#x7684;&#x6253;&#x5370;&#x65E5;&#x5FD7; , Trace &#x7EA7;&#x522B;</span><br><span class="line">      logOutcome(classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8BB0;&#x5F55;&#x7ED3;&#x679C; , &#x901A;&#x8FC7; ConditionEvaluationReport &#x548C; recordEvaluation &#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</span><br><span class="line">      recordEvaluation(context, classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8FD4;&#x56DE;&#x662F;&#x5426;&#x6210;&#x529F;&#x5339;&#x914D;</span><br><span class="line">      return outcome.isMatch();</span><br><span class="line">   }</span><br><span class="line">   catch (NoClassDefFoundError ex) {</span><br><span class="line">      throw new IllegalStateException(......);</span><br><span class="line">   }</span><br><span class="line">   catch (RuntimeException ex) {</span><br><span class="line">      throw new IllegalStateException(&quot;Error processing condition on &quot; + getName(metadata), ex);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x662F;&#x8C03;&#x7528; getMatchOutcome &#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6216;&#x8005;&#x4E0D;&#x7B26;&#x5408;&#x8981;&#x6C42; , getMatchOutcome &#x9700;&#x8981;&#x5B50;&#x7C7B;&#x91CD;&#x5199;</p>
<h2 id="&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;"><a href="#&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;" class="headerlink" title="&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;"></a>&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;</h2><h3 id="5-1-OnClass"><a href="#5-1-OnClass" class="headerlink" title="5.1 OnClass"></a>5.1 OnClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5BB9;&#x5668; ClassLoader  </span><br><span class="line">   ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   // Step 2 : &#x5224;&#x65AD;&#x662F;&#x5426;&#x6709; ConditionalOnClass &#x7EA6;&#x675F;</span><br><span class="line">   List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br><span class="line">   if (onClasses != null) {</span><br><span class="line">      // Step 2-1 : filter &#x8FC7;&#x6EE4; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x7F3A;&#x5931;&#x7C7B; </span><br><span class="line">      List&lt;String&gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader);</span><br><span class="line">      if (!missing.isEmpty()) {</span><br><span class="line">         return ConditionOutcome.noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br><span class="line">               .didNotFind(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE, missing));</span><br><span class="line">      }</span><br><span class="line">      // Step 2-2 : &#x6784;&#x5EFA; matchMessage</span><br><span class="line">      matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br><span class="line">            .found(&quot;required class&quot;, &quot;required classes&quot;)</span><br><span class="line">            .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader));</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   // Step 3 : &#x540C;&#x7406; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981; MissClasses</span><br><span class="line">   List&lt;String&gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class);</span><br><span class="line">   if (onMissingClasses != null) {</span><br><span class="line">      // .... &#x4E0E; ConditionalOnClass &#x57FA;&#x672C;&#x7C7B;&#x4F3C; ,&#x6B64;&#x5904;&#x7701;&#x7565;</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConditionMessage &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<h3 id="5-2-OnBean"><a href="#5-2-OnBean" class="headerlink" title="5.2 OnBean"></a>5.2 OnBean</h3><p>&#x4E0E; OnBean &#x7C7B;&#x4F3C; , &#x8FD9;&#x91CC;&#x5C31;&#x5C55;&#x793A;&#x4E00;&#x79CD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   MergedAnnotations annotations = metadata.getAnnotations();</span><br><span class="line">   </span><br><span class="line">   if (annotations.isPresent(ConditionalOnBean.class)) {</span><br><span class="line">      // Step 1 :&#x83B7;&#x53D6; ConditionalOnBean &#x6CE8;&#x89E3;&#x4FE1;&#x606F;</span><br><span class="line">      Spec&lt;ConditionalOnBean&gt; spec = new Spec&lt;&gt;(context, metadata, annotations, ConditionalOnBean.class);</span><br><span class="line">      // Step 2 : &#x8FD4;&#x56DE;&#x5339;&#x914D;&#x7ED3;&#x679C;</span><br><span class="line">      // &#x5176;&#x5185;&#x90E8;&#x901A;&#x8FC7; getNamesOfBeansIgnoredByType , getBeanNamesForType &#x7B49;&#x65B9;&#x5F0F;&#x5224;&#x65AD;&#x7C7B;&#x662F;&#x5426;&#x5B58;&#x5728; </span><br><span class="line">      MatchResult matchResult = getMatchingBeans(context, spec);</span><br><span class="line">      if (!matchResult.isAllMatched()) {</span><br><span class="line">         String reason = createOnBeanNoMatchReason(matchResult);</span><br><span class="line">         return ConditionOutcome.noMatch(spec.message().because(reason));</span><br><span class="line">      }</span><br><span class="line">      matchMessage = spec.message(matchMessage).found(&quot;bean&quot;, &quot;beans&quot;).items(Style.QUOTE,</span><br><span class="line">            matchResult.getNamesOfAllMatches());</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnSingleCandidate.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnMissingBean.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>Conditional &#x672C;&#x8EAB;&#x5E76;&#x4E0D;&#x96BE; , &#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x5B8C;&#x5584;&#x56FE;&#x8C31;&#x4EE5;&#x53CA;&#x540E;&#x7EED;&#x7684; starter &#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x65B9;&#x6848; &#x505A;&#x51C6;&#x5907;.</p>
<p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x73AF;&#x8282;&#x7406;&#x89E3;&#x5C31;&#x884C;&#x4E86; :</p>
<ul>
<li>Spring &#x4E2D;&#x7684; Conditional &#x90FD;&#x4F1A;&#x7EE7;&#x627F; SpringBootCondition , &#x4F1A;&#x5B9E;&#x73B0;&#x5176; getOutcomes &#x65B9;&#x6CD5;</li>
<li>getOutcomes &#x662F;&#x7528;&#x4E8E;&#x5FEB;&#x901F;&#x53BB;&#x6389;&#x65E0;&#x9700;&#x52A0;&#x8F7D;&#x7684; Configuration , getMatchOutcome &#x662F;&#x4E3A;&#x4E86;&#x9A8C;&#x8BC1;&#x5339;&#x914D;&#x5173;&#x7CFB;</li>
<li>&#x901A;&#x5E38;&#x90FD;&#x4F1A;&#x901A;&#x8FC7; ConditionEvaluator &#x7684; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8FC7;@Bean &#x6D41;&#x7A0B;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/281031ca9f0e5159d3c1ec1896b59fa3.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014080754040717342.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014080754040717342.html" itemprop="url">Dubbo 30   BootStrap 初始化主流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-01T20:59:40+08:00">
                2021-10-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p><strong>&#x8FD9;&#x4E00;&#x7BC7;&#x53EA;&#x9884;&#x89C8;&#x4E00;&#x4E0B; Bootstrap &#x521D;&#x59CB;&#x5316;&#x7684;&#x4E3B;&#x6D41;&#x7A0B; , &#x90E8;&#x5206;&#x7EC6;&#x8282;&#x70B9;&#x4F1A;&#x53E6;&#x5916;&#x5206;&#x6790;</strong></p>
<p>Dubbo 3.0 &#x901A;&#x8FC7; DubboBootstrap &#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x903B;&#x8F91; , DubboBootstrap &#x7684;&#x542F;&#x52A8;&#x903B;&#x8F91;&#x5982;&#x4E0B; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x6838;&#x5FC3;&#x539F;&#x7406;&#x4E3A; ApplicationContextEvent &#x4E8B;&#x4EF6;&#x7684;&#x89E6;&#x53D1; , &#x5F53; SpringApplication &#x542F;&#x52A8;&#x540E; ,&#x4F1A;&#x53D1;&#x5E03;&#x8BE5;&#x4E8B;&#x4EF6;</span><br><span class="line"></span><br><span class="line">C- AbstractApplicationContext # refresh : &#x53D1;&#x5E03; ApplicationContextEvent &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onApplicationContextEvent : &#x76D1;&#x542C;Application &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onContextRefreshedEvent</span><br><span class="line">C- DubboBootstrap # start : &#x5F00;&#x59CB;&#x52A0;&#x8F7D;&#x64CD;&#x4F5C;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x53C2;&#x8003;&#x7C7B; : </span><br><span class="line">DubboBeanUtils</span><br><span class="line">ServiceAnnotationPostProcessor</span><br><span class="line">DubboClassPathBeanDefinitionScanner</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x76D1;&#x542C;&#x5668; : </span><br><span class="line">DubboBootstrapApplicationListener</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;"><a href="#&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;" class="headerlink" title="&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;"></a>&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;</h2><p>Dubbo &#x7684;&#x521D;&#x59CB;&#x5316;&#x4E3B;&#x8981;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x7C7B; : DubboBootstrap -</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// Step 1 : DubboBootstrapApplicationListener</span><br><span class="line">public void onApplicationContextEvent(ApplicationContextEvent event) {</span><br><span class="line">	if (DubboBootstrapStartStopListenerSpringAdapter.applicationContext == null) {</span><br><span class="line">		DubboBootstrapStartStopListenerSpringAdapter.applicationContext = event.getApplicationContext();</span><br><span class="line">	}</span><br><span class="line">        // Step 2-1 : &#x5BB9;&#x5668;&#x542F;&#x52A8;&#x540E;&#x521D;&#x59CB;&#x5316; Bootstrap , &#x770B;&#x540D;&#x79F0;&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x8FD8;&#x53EF;&#x4EE5;&#x5237;&#x65B0;</span><br><span class="line">	if (event instanceof ContextRefreshedEvent) {</span><br><span class="line">		onContextRefreshedEvent((ContextRefreshedEvent) event);</span><br><span class="line">        // &#x5BB9;&#x5668;&#x5173;&#x95ED;&#x903B;&#x8F91;  </span><br><span class="line">	} else if (event instanceof ContextClosedEvent) {</span><br><span class="line">		onContextClosedEvent((ContextClosedEvent) event);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-1 </span><br><span class="line">private void onContextRefreshedEvent(ContextRefreshedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		dubboBootstrap.start();</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-2 </span><br><span class="line">private void onContextClosedEvent(ContextClosedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		DubboShutdownHook.getDubboShutdownHook().run();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;"><a href="#&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;" class="headerlink" title="&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;"></a>&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;</h2><h3 id="3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="3.1 Start &#x4E3B;&#x6D41;&#x7A0B;"></a>3.1 Start &#x4E3B;&#x6D41;&#x7A0B;</h3><p>start &#x73AF;&#x8282;&#x4E3B;&#x8981;&#x7531;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x73AF;&#x8282; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;Step 1 : &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</span><br><span class="line">Step 2 : initialize &#x521D;&#x59CB;&#x5316;</span><br><span class="line">Step 3 : exportServices &#x8F93;&#x51FA; Services</span><br><span class="line">Step 4 : referServices &#x6CE8;&#x518C; refer Service</span><br><span class="line">Step 5 : onStart() &#x542F;&#x52A8; (&#x5F02;&#x6B65;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x521B;&#x5EFA; Thread &#x540E;&#x542F;&#x52A8;)</span><br><span class="line">    </span><br><span class="line">// &#x542F;&#x52A8; Dubbo &#x5BB9;&#x5668;&#x73AF;&#x5883;</span><br><span class="line">dubboBootstrap.start(); </span><br><span class="line"></span><br><span class="line">// Step 1 &#xFF1A;Start &#x903B;&#x8F91;</span><br><span class="line">public DubboBootstrap start() {</span><br><span class="line">    if (started.compareAndSet(false, true)) {</span><br><span class="line">        startup.set(false);</span><br><span class="line">        initialized.set(false);</span><br><span class="line">        shutdown.set(false);</span><br><span class="line">        awaited.set(false);</span><br><span class="line"></span><br><span class="line">        initialize();</span><br><span class="line">        // 1. export Dubbo Services</span><br><span class="line">        exportServices();</span><br><span class="line"></span><br><span class="line">        // Not only provider register</span><br><span class="line">        if (!isOnlyRegisterProvider() || hasExportedServices()) {</span><br><span class="line">            // 2. export MetadataService</span><br><span class="line">            exportMetadataService();</span><br><span class="line">            // 3. Register the local ServiceInstance if required</span><br><span class="line">            registerServiceInstance();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        referServices();</span><br><span class="line">        if (asyncExportingFutures.size() &gt; 0 || asyncReferringFutures.size() &gt; 0) {</span><br><span class="line">            new Thread(() -&gt; {</span><br><span class="line">                try {</span><br><span class="line">                    this.awaitFinish();</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    logger.warn(NAME + &quot; asynchronous export / refer occurred an exception.&quot;);</span><br><span class="line">                }</span><br><span class="line">                startup.set(true);</span><br><span class="line">                onStart();</span><br><span class="line">            }).start();</span><br><span class="line">        } else {</span><br><span class="line">            startup.set(true);</span><br><span class="line">            onStart();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    return this;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"><a href="#3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;" class="headerlink" title="3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"></a>3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;if (started.compareAndSet(false, true)) </span><br><span class="line">    </span><br><span class="line">startup.set(false);</span><br><span class="line">initialized.set(false);</span><br><span class="line">shutdown.set(false);</span><br><span class="line">awaited.set(false);</span><br><span class="line">    </span><br><span class="line">// &#x6B64;&#x5904;&#x6709;&#x51E0;&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x64CD;&#x4F5C; : </span><br><span class="line">1. &#x539F;&#x5B50;&#x8BBE;&#x7F6E;&#x5DF2;&#x7ECF;&#x542F;&#x52A8;</span><br><span class="line">2. &#x8BBE;&#x7F6E;&#x5C5E;&#x6027;</span><br><span class="line">    </span><br><span class="line">// &#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x8FD9;4&#x4E2A;&#x5C5E;&#x6027;</span><br><span class="line">private AtomicBoolean initialized = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean started = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean startup = new AtomicBoolean(true);</span><br><span class="line">private AtomicBoolean destroyed = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean shutdown = new AtomicBoolean(false)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"><a href="#3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;" class="headerlink" title="3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"></a>3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public void initialize() {</span><br><span class="line">    if (!initialized.compareAndSet(false, true)) {</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ApplicationModel.initFrameworkExts();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316;&#x914D;&#x7F6E;</span><br><span class="line">    startConfigCenter();</span><br><span class="line">    loadConfigsFromProps();</span><br><span class="line">    checkGlobalConfigs();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316; Service</span><br><span class="line">    startMetadataCenter();</span><br><span class="line">    initMetadataService();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="3-3-1-ApplicationModel-initFrameworkExts"><a href="#3-3-1-ApplicationModel-initFrameworkExts" class="headerlink" title="3.3.1 ApplicationModel.initFrameworkExts()"></a>3.3.1 ApplicationModel.initFrameworkExts()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- DubboBootstrap</span><br><span class="line">public static void initFrameworkExts() {</span><br><span class="line">        Set&lt;FrameworkExt&gt; exts = ExtensionLoader.getExtensionLoader(FrameworkExt.class).getSupportedExtensionInstances();</span><br><span class="line">    	// PIC21005</span><br><span class="line">        for (FrameworkExt ext : exts) {</span><br><span class="line">            ext.initialize();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 1 : &#x901A;&#x8FC7; SPI &#x8FDB;&#x884C;&#x63D2;&#x4EF6;&#x5904;&#x7406;</span><br><span class="line">@SPI</span><br><span class="line">public interface FrameworkExt extends Lifecycle {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8865;&#x5145; : Dubbo &#x4E2D;&#x7684;  Lifecycle &#x5BF9;&#x8C61;</span><br><span class="line">- ConfigManager</span><br><span class="line">- Environment</span><br><span class="line">- LifecycleAdapter</span><br><span class="line">- ServiceRepository</span><br><span class="line">- SpringExtensionFactory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-1  : ConfigManager &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        String configModeStr = null;</span><br><span class="line">        try {</span><br><span class="line">            configModeStr = (String) ApplicationModel.getEnvironment().getConfiguration().getProperty(DUBBO_CONFIG_MODE);</span><br><span class="line">            if (StringUtils.hasText(configModeStr)) {</span><br><span class="line">                this.configMode = ConfigMode.valueOf(configModeStr.toUpperCase());</span><br><span class="line">            }</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new IllegalArgumentException(msg, e);</span><br><span class="line">        }</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line">// Step 2-2  : Environment &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        if (initialized.compareAndSet(false, true)) {</span><br><span class="line">            this.propertiesConfiguration = new PropertiesConfiguration();</span><br><span class="line">            this.systemConfiguration = new SystemConfiguration();</span><br><span class="line">            this.environmentConfiguration = new EnvironmentConfiguration();</span><br><span class="line">            this.externalConfiguration = new InmemoryConfiguration(&quot;ExternalConfig&quot;);</span><br><span class="line">            this.appExternalConfiguration = new InmemoryConfiguration(&quot;AppExternalConfig&quot;);</span><br><span class="line">            this.appConfiguration = new InmemoryConfiguration(&quot;AppConfig&quot;);</span><br><span class="line"></span><br><span class="line">            loadMigrationRule();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-3 : ServiceRepository &#x90E8;&#x5206;</span><br></pre></td></tr></table></figure>

<p><strong>PIC21005 : FrameworkExt &#x5BF9;&#x8C61;&#x5217;&#x8868;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/16486906da2ce44c8ffb53ec9d1aba90e245f43280970fe5cd09f5bd03fec7ad" alt="Dubbo-Framaket-module.png"></p>
<h4 id="3-3-2-startConfigCenter-&#x7B80;&#x8FF0;"><a href="#3-3-2-startConfigCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.2 startConfigCenter &#x7B80;&#x8FF0;"></a>3.3.2 startConfigCenter &#x7B80;&#x8FF0;</h4><p>&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x603B;&#x5171;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x6B65; :</p>
<ol>
<li>&#x5206;&#x522B;&#x52A0;&#x8F7D; ApplicationConfig &#x548C; ConfigCenterConfig</li>
<li>&#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E;</li>
<li>&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startConfigCenter() {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5904;&#x7406;&#x5BF9;&#x5E94;&#x7684; Config , &#x6B64;&#x5904;&#x7B80;&#x5355;&#x4E00;&#x70B9;&#x8BF4;&#x5206;&#x4E3A;2&#x4E2A;&#x7C7B;&#x578B; , &#x5F88;&#x597D;&#x7684;&#x601D;&#x8DEF; , &#x540E;&#x9762;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E00; : &#x5B58;&#x5728;class &#x5BF9;&#x5E94;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x901A;&#x8FC7; class &#x7C7B;&#x578B;&#x53BB; newInstance &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x5E94;&#x7C7B;&#x578B;&#x7684; Class &#x5BF9;&#x8C61;</span><br><span class="line">    // 2. &#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684; refush &#x8FDB;&#x884C;&#x5237;&#x65B0;&#x5904;&#x7406; (TODO : &#x540E;&#x7EED;&#x5206;&#x6790; , &#x5C31;&#x662F;&#x914D;&#x7F6E;&#x7684;&#x91CD;&#x5199;&#x6D41;&#x7A0B;)</span><br><span class="line">    // 3. &#x7F13;&#x5B58;&#x5230; configManager &#x4E2D;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E8C; : &#x4E0D;&#x5B58;&#x5728;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x76F4;&#x63A5;&#x4ECE; ApplicationModel &#x4E2D;&#x83B7;&#x53D6; Environment</span><br><span class="line">    // 2. newInstance &#x5B9E;&#x4F8B;&#x5316;&#x540E;&#x653E;&#x5728; configManager &#x4E2D;</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line">    loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    useRegistryAsConfigCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    // check Config Center -&gt; PS:332001</span><br><span class="line">    Collection&lt;ConfigCenterConfig&gt; configCenters = configManager.getConfigCenters();</span><br><span class="line">    if (CollectionUtils.isEmpty(configCenters)) {</span><br><span class="line">        // &#x901A;&#x5E38;&#x914D;&#x7F6E;&#x4E86;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x8FD9;&#x91CC;&#x90FD;&#x4F1A;&#x6709;&#x503C; , &#x5982;&#x679C;&#x4E3A;&#x7A7A; , &#x6B64;&#x5904; new &#x4E86;&#x4E00;&#x4E2A;&#x57FA;&#x7840;&#x5B9E;&#x73B0;</span><br><span class="line">    } else {</span><br><span class="line">        for (ConfigCenterConfig configCenterConfig : configCenters) {</span><br><span class="line">            // Step 2 : &#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E; , &#x540E;&#x7EED;&#x6DF1;&#x5165;</span><br><span class="line">            configCenterConfig.refresh();</span><br><span class="line">            ConfigValidationUtils.validateConfigCenterConfig(configCenterConfig);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isNotEmpty(configCenters)) {</span><br><span class="line">        CompositeDynamicConfiguration compositeDynamicConfiguration = new CompositeDynamicConfiguration();</span><br><span class="line">        </span><br><span class="line">        // &#x8FD9;&#x91CC;&#x8981;&#x5BF9; environment &#x73AF;&#x8282;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</span><br><span class="line">        for (ConfigCenterConfig configCenter : configCenters) {</span><br><span class="line">            // Pass config from ConfigCenterBean to environment</span><br><span class="line">            environment.updateExternalConfigMap(configCenter.getExternalConfiguration());</span><br><span class="line">            environment.updateAppExternalConfigMap(configCenter.getAppExternalConfiguration());</span><br><span class="line"></span><br><span class="line">            // Fetch config from remote config center</span><br><span class="line">            compositeDynamicConfiguration.addConfiguration(prepareEnvironment(configCenter));</span><br><span class="line">        }</span><br><span class="line">        environment.setDynamicConfiguration(compositeDynamicConfiguration);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    // Step 3 : &#x6B64;&#x5904;&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0; TODO</span><br><span class="line">    configManager.refreshAll();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConfigCenterConfig &#x5BF9;&#x8C61;&#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x4E2D;&#x5305;&#x542B;&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x7840;&#x914D;&#x7F6E;&#x4FE1;&#x606F; , &#x4F8B;&#x5982; protocol , address , port , cluster , namespace &#x7B49;</p>
<p><strong>&#x7075;&#x6D3B;&#x5229;&#x7528;&#x8BE5; ConfigCenterConfig &#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x96C6;&#x6210;&#x591A;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</strong></p>
<blockquote>
<p>&#x8865;&#x5145; : PS:332001 &#x7ED3;&#x6784;</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f7c2c606aa34f2832f92ad41f94f1658f66a8d9cde46e515530d6fea91914070" alt="image.png"></p>
<h3 id="3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;"><a href="#3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;"></a>3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;</h3><p><strong>&#x8FD9;&#x91CC;&#x548C;&#x4E0A;&#x9762;&#x5176;&#x5B9E;&#x5DEE;&#x4E0D;&#x591A; , loadConfigs &#x662F;&#x901A;&#x8FC7;&#x7279;&#x6B8A;&#x7684;&#x524D;&#x7F00;&#x5BF9;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;</strong></p>
<p>&#x4E4B;&#x524D;&#x770B;&#x8FC7;&#x591A;&#x4E2A;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x5BF9;&#x4E8E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x52A0;&#x8F7D;&#x601D;&#x8DEF; , <strong>&#x57FA;&#x672C;&#x4E0A;&#x6B8A;&#x9014;&#x540C;&#x5F52; , &#x90FD;&#x662F;&#x4EE5;&#x7C7B;&#x533A;&#x5206; , &#x901A;&#x8FC7;&#x524D;&#x7F00;&#x52A0;&#x8F7D;</strong> , &#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x5206;&#x6790;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadConfigsFromProps() {</span><br><span class="line"></span><br><span class="line">    // application config has load before starting config center</span><br><span class="line">    // load dubbo.applications.xxx</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.modules.xxx</span><br><span class="line">    loadConfigs(ModuleConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.monitors.xxx</span><br><span class="line">    loadConfigs(MonitorConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metricses.xxx</span><br><span class="line">    loadConfigs(MetricsConfig.class);</span><br><span class="line"></span><br><span class="line">    // load multiple config types:</span><br><span class="line">    // load dubbo.protocols.xxx</span><br><span class="line">    loadConfigs(ProtocolConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.registries.xxx</span><br><span class="line">    loadConfigs(RegistryConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.providers.xxx</span><br><span class="line">    loadConfigs(ProviderConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.consumers.xxx</span><br><span class="line">    loadConfigs(ConsumerConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metadata-report.xxx</span><br><span class="line">    loadConfigs(MetadataReportConfig.class);</span><br><span class="line"></span><br><span class="line">    // config centers has bean loaded before starting config center</span><br><span class="line">    //loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;"><a href="#3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;"></a>3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;</h3><p>&#x5728;&#x8FD9;&#x4E2A;&#x73AF;&#x8282;&#x4E2D;&#x4F1A;&#x901A;&#x8FC7; ConfigValidationUtils &#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x6821;&#x9A8C; , &#x4EE5;&#x53CA;&#x7AEF;&#x53E3;&#x5904;&#x7406; , &#x6700;&#x540E;&#x901A;&#x8FC7; refresh &#x5237;&#x65B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void checkGlobalConfigs() {</span><br><span class="line">    // check config types (ignore metadata-center)</span><br><span class="line">    List&lt;Class&lt;? extends AbstractConfig&gt;&gt; multipleConfigTypes = Arrays.asList(</span><br><span class="line">        ApplicationConfig.class,</span><br><span class="line">        ProtocolConfig.class,</span><br><span class="line">        RegistryConfig.class,</span><br><span class="line">        MetadataReportConfig.class,</span><br><span class="line">        ProviderConfig.class,</span><br><span class="line">        ConsumerConfig.class,</span><br><span class="line">        MonitorConfig.class,</span><br><span class="line">        ModuleConfig.class,</span><br><span class="line">        MetricsConfig.class,</span><br><span class="line">        SslConfig.class);</span><br><span class="line"></span><br><span class="line">    for (Class&lt;? extends AbstractConfig&gt; configType : multipleConfigTypes) {</span><br><span class="line">        // &#x901A;&#x8FC7; ConfigValidationUtils &#x5BF9;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x6821;&#x9A8C;</span><br><span class="line">        checkDefaultAndValidateConfigs(configType);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check port conflicts</span><br><span class="line">    // </span><br><span class="line">    Map&lt;Integer, ProtocolConfig&gt; protocolPortMap = new LinkedHashMap&lt;&gt;();</span><br><span class="line">    for (ProtocolConfig protocol : configManager.getProtocols()) {</span><br><span class="line">        Integer port = protocol.getPort();</span><br><span class="line">        if (port == null || port == -1) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x6B64;&#x5904;&#x5982;&#x679C;&#x5B58;&#x5728;&#x7AEF;&#x53E3;&#x51B2;&#x7A81; , &#x8FD9;&#x91CC;&#x4F1A;&#x76F4;&#x63A5;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        ProtocolConfig prevProtocol = protocolPortMap.get(port);</span><br><span class="line">        if (prevProtocol != null) {</span><br><span class="line">            throw new IllegalStateException</span><br><span class="line">        }</span><br><span class="line">        protocolPortMap.put(port, protocol);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check reference and service</span><br><span class="line">    // &#x8FD9;&#x91CC;&#x6B63;&#x5F0F;&#x5F00;&#x59CB;&#x5904;&#x7406; reference &#x548C; DubboService , TODO : &#x540E;&#x9762;&#x5355;&#x7AE0;&#x5206;&#x6790;</span><br><span class="line">    for (ReferenceConfigBase&lt;?&gt; reference : configManager.getReferences()) {</span><br><span class="line">        reference.refresh();</span><br><span class="line">    }</span><br><span class="line">    for (ServiceConfigBase service : configManager.getServices()) {</span><br><span class="line">        service.refresh();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;"><a href="#3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.5 startMetadataCenter &#x7B80;&#x8FF0;"></a>3.3.5 startMetadataCenter &#x7B80;&#x8FF0;</h3><p>&#x6B64;&#x5904;&#x662F;&#x5143;&#x6570;&#x636E;&#x7684;&#x5904;&#x7406;&#x3000;, &#x5143;&#x6570;&#x636E;&#x662F;&#x65B0;&#x7279;&#x6027; , &#x53EF;&#x4EE5;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x524D;&#x7F00;&#x201C;dubbo.metadata-report&#x201D;&#x8BBE;&#x7F6E;MetadataReportConfig&#x7684;&#x5C5E;&#x6027;</p>
<blockquote>
<p>&#x4EC0;&#x4E48;&#x662F;&#x5143;&#x6570;&#x636E; :</p>
</blockquote>
<ul>
<li>&#x5143;&#x6570;&#x636E;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x8F7B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x538B;&#x529B;&#xFF0C;&#x5C06;&#x90E8;&#x5206;&#x5B58;&#x50A8;&#x5728;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x5185;&#x5BB9;&#x653E;&#x5230;&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x3002;</li>
<li>&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x53EA;&#x662F;&#x7ED9;&#x81EA;&#x5DF1;&#x4F7F;&#x7528;&#x7684; , &#x6539;&#x52A8;&#x65E0;&#x9700;&#x5237;&#x65B0;</li>
<li>&#x4E0D;&#x9700;&#x8981;&#x76D1;&#x542C;&#x548C;&#x901A;&#x77E5; , &#x6781;&#x5927;&#x7684;&#x51CF;&#x5C11;&#x4E86;&#x6027;&#x80FD;&#x7684;&#x6D88;&#x8017;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startMetadataCenter() {</span><br><span class="line"></span><br><span class="line">    useRegistryAsMetadataCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    ApplicationConfig applicationConfig = getApplication();</span><br><span class="line"></span><br><span class="line">    String metadataType = applicationConfig.getMetadataType();</span><br><span class="line">    // FIXME, multiple metadata config support.</span><br><span class="line">    Collection&lt;MetadataReportConfig&gt; metadataReportConfigs = configManager.getMetadataConfigs();</span><br><span class="line">    if (CollectionUtils.isEmpty(metadataReportConfigs)) {</span><br><span class="line">        //... &#x8FD9;&#x91CC;&#x914D;&#x7F6E;&#x4E86;&#x8FDC;&#x7A0B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x65F6;&#x9ED8;&#x8BA4;&#x90FD;&#x4F1A;&#x6709;&#x6570;&#x636E; , &#x6CA1;&#x6709;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    for (MetadataReportConfig metadataReportConfig : metadataReportConfigs) {</span><br><span class="line">        // &lt;dubbo:metadata-report address=&quot;zookeeper://127.0.0.1:2181&quot; id=&quot;metadata-center-zookeeper-2181&quot; /&gt;</span><br><span class="line">        ConfigValidationUtils.validateMetadataConfig(metadataReportConfig);</span><br><span class="line">        if (!metadataReportConfig.isValid()) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x901A;&#x8FC7; instance &#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5904;&#x7406;</span><br><span class="line">        MetadataReportInstance.init(metadataReportConfig);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-6-initMetadataService-&#x7B80;&#x8FF0;"><a href="#3-3-6-initMetadataService-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.6 initMetadataService &#x7B80;&#x8FF0;"></a>3.3.6 initMetadataService &#x7B80;&#x8FF0;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    private void initMetadataService() {</span><br><span class="line">//        startMetadataCenter();</span><br><span class="line">        this.metadataService = getDefaultExtension();</span><br><span class="line">        this.metadataServiceExporter = new ConfigurableMetadataServiceExporter(metadataService);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="3-4-exportServices"><a href="#3-4-exportServices" class="headerlink" title="3.4 exportServices"></a>3.4 exportServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4F53;&#x7CFB;</p>
<h3 id="3-5-referServices"><a href="#3-5-referServices" class="headerlink" title="3.5 referServices"></a>3.5 referServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x4F53;&#x7CFB;</p>
<h3 id="3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"><a href="#3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;" class="headerlink" title="3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"></a>3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void onStart() {</span><br><span class="line">	ExtensionLoader&lt;DubboBootstrapStartStopListener&gt; exts = getExtensionLoader(DubboBootstrapStartStopListener.class);</span><br><span class="line">	exts.getSupportedExtensionInstances().forEach(ext -&gt; ext.onStart(this));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x603B;&#x7ED3;, &#x4EE5;&#x53CA;&#x5BF9;&#x5168;&#x90E8;&#x7684;&#x6982;&#x5FF5;&#x6709;&#x4E2A;&#x521D;&#x6B65;&#x7684;&#x7406;&#x89E3; , &#x540E;&#x9762;&#x4F1A;&#x9010;&#x6B65;&#x5B8C;&#x5584;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x7684;&#x7EC6;&#x8282;&#x70B9; , &#x4EE5;&#x53CA;&#x5BF9;&#x5176;&#x4EE3;&#x7801;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x4F7F;&#x7528;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9ba9fb87e288d1434a787b82881e4c0404d73c3eb3e77ee7a247970bc0cbecd9" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/27b9805e4b2f109ec422efdd1f2caab8.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7013595058125406238.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7013595058125406238.html" itemprop="url">Android Native   内存问题的终极武器——MT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-30T13:32:13+08:00">
                2021-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>&#x672C;&#x6587;&#x5206;&#x6790;&#x57FA;&#x4E8E;Android S (12)</code></p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x6C47;&#x7F16;&#x3001;C&#x548C;C++&#x672C;&#x8D28;&#x4E0A;&#x90FD;&#x662F;&#x5185;&#x5B58;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x8BED;&#x8A00;&#xFF0C;&#x56E0;&#x6B64;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x65E0;&#x5FC3;&#x4E4B;&#x8FC7;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x975E;&#x6CD5;&#x8BBF;&#x95EE;&#x3001;&#x5185;&#x5B58;&#x8E29;&#x8E0F;&#x7B49;&#x591A;&#x79CD;&#x95EE;&#x9898;&#x3002;&#x8FD9;&#x4E9B;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x4E00;&#x65B9;&#x9762;&#x4F1A;&#x5F71;&#x54CD;&#x7528;&#x6237;&#x7684;&#x4F7F;&#x7528;&#x4F53;&#x9A8C;&#xFF08;&#x8FDB;&#x7A0B;&#x5D29;&#x6E83;&#x3001;&#x7CFB;&#x7EDF;&#x91CD;&#x542F;&#x7B49;&#xFF09;&#xFF1B;&#x53E6;&#x4E00;&#x65B9;&#x9762;&#x4E5F;&#x4F1A;&#x88AB;&#x9ED1;&#x5BA2;&#x5229;&#x7528;&#xFF0C;&#x589E;&#x52A0;&#x5165;&#x4FB5;&#x7684;&#x673A;&#x4F1A;&#x3002;&#x6240;&#x4EE5;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x4E0D;&#x4EC5;&#x662F;&#x7A33;&#x5B9A;&#x6027;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E5F;&#x662F;&#x5B89;&#x5168;&#x6027;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x5982;&#x679C;&#x8003;&#x8651;&#x5230;&#x540E;&#x671F;&#x5B89;&#x5168;&#x8865;&#x4E01;&#x5E26;&#x6765;&#x7684;&#x5347;&#x7EA7;&#x5F71;&#x54CD;&#xFF0C;&#x5B83;&#x6216;&#x8BB8;&#x4E5F;&#x80FD;&#x7B97;&#x5F97;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x7ECF;&#x6D4E;&#x95EE;&#x9898;&#x3002;</p>
<p>Android&#x7684;native&#x4E16;&#x754C;&#x57FA;&#x672C;&#x7531;C++&#x8BED;&#x8A00;&#x6784;&#x6210;&#xFF08;&#x4E5F;&#x5305;&#x542B;&#x5C11;&#x91CF;&#x7684;C&#x3001;&#x6C47;&#x7F16;&#x548C;S&#x4E0A;&#x5F15;&#x5165;&#x7684;Rust&#xFF09;&#xFF0C;&#x5176;&#x4EE3;&#x7801;&#x91CF;&#x751A;&#x81F3;&#x5360;&#x5230;&#x4E86;&#x5E73;&#x53F0;&#x603B;&#x4EE3;&#x7801;&#x91CF;&#x7684;70%&#x3002;&#x56E0;&#x6B64;&#xFF0C;Google&#x5728;&#x8FD9;&#x4E9B;&#x5E74;&#x91CC;&#x7814;&#x53D1;&#x4E86;&#x5404;&#x79CD;&#x5DE5;&#x5177;&#xFF0C;&#x76EE;&#x7684;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x9AD8;&#x6548;&#x5730;&#x53D1;&#x73B0;&#x548C;&#x89E3;&#x51B3;&#x5404;&#x79CD;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x3002;&#x4ECE;&#x6700;&#x65E9;&#x671F;&#x91C7;&#x7528;&#x5F00;&#x6E90;&#x4E16;&#x754C;&#x91CC;&#x7684;Valgrind&#x5DE5;&#x5177;&#xFF0C;&#x5230;Android N(7)&#x4E0A;&#x81EA;&#x4E3B;&#x7814;&#x53D1;&#x7684;Address Sanitizer(ASan)&#xFF0C;Android Q(10)&#x4E0A;&#x5F15;&#x5165;&#x7684;Hardware Address Sanitizer(HWASan)&#xFF0C;&#x548C;&#x6700;&#x65B0;Android S(12)&#x4E0A;&#x5F15;&#x5165;&#x7684;ARM Memory Tagging Extension(MTE)&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1747db38aa73a3957af3b36416a89bfbd26989c7b843ad4f92ad9873b69a4657" alt="&#x5DE5;&#x5177;&#x7684;&#x6F14;&#x8FDB;&#x8FC7;&#x7A0B;.jpg"></p>
<p>ASan&#x548C;HWASan&#x7531;Google&#x81EA;&#x4E3B;&#x5F00;&#x53D1;&#xFF0C;MTE&#x7531;Google&#x548C;ARM&#x8054;&#x5408;&#x5F00;&#x53D1;&#x3002;&#x5C3D;&#x7BA1;&#x8FD9;&#x4E09;&#x79CD;&#x5DE5;&#x5177;&#x7684;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x5404;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x5B83;&#x4EEC;&#x5E95;&#x5C42;&#x7684;&#x601D;&#x60F3;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x81F4;&#x7684;&#x3002;&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;&#x8FD9;&#x4E9B;&#x5DE5;&#x5177;&#x7684;&#x5DE5;&#x4F5C;&#x8FC7;&#x7A0B;&#x53EA;&#x6709;&#x4E24;&#x6B65;&#xFF1A;</p>
<ol>
<li>&#x5728;&#x5185;&#x5B58;&#x5206;&#x914D;&#x65F6;&#x4E3A;&#x5B83;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x7279;&#x7684;tag(&#x6807;&#x7B7E;)&#x3002;</li>
<li>&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x65F6;&#x53BB;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5408;&#x89C4;&#x3002;</li>
</ol>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x6846;&#x67B6;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x6BCF;&#x4E2A;&#x5DE5;&#x5177;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5176;&#x5B9E;&#x90FD;&#x5728;&#x56DE;&#x7B54;&#x4E0B;&#x8FF0;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>tag&#x5982;&#x4F55;&#x751F;&#x6210;&#xFF1F;</li>
<li>tag&#x5982;&#x4F55;&#x5B58;&#x50A8;&#xFF1F;</li>
<li>tag&#x662F;&#x5426;&#x5408;&#x89C4;&#x7684;&#x5224;&#x636E;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x4EE5;ASan&#x4E3A;&#x4F8B;&#xFF0C;&#x56DE;&#x7B54;&#x4E0A;&#x8FF0;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>
<ol>
<li>tag&#x7531;&#x5355;&#x5B57;&#x8282;&#x8868;&#x793A;&#xFF0C;&#x53EF;&#x4EE5;&#x53CD;&#x6620;8&#x4E2A;&#x771F;&#x5B9E;&#x5185;&#x5B58;&#x5B57;&#x8282;&#x7684;&#x72B6;&#x6001;&#x3002;&#x751F;&#x6210;&#x65F6;&#x6839;&#x636E;&#x8BE5;&#x5757;&#x5185;&#x5B58;&#x7684;&#x5B9E;&#x9645;&#x72B6;&#x6001;&#x9009;&#x53D6;tag&#x503C;&#xFF0C;&#x56E0;&#x6B64;tag&#x503C;&#x5177;&#x6709;&#x4E8B;&#x5148;&#x89C4;&#x5B9A;&#x7684;&#x542B;&#x4E49;&#x3002;0x00&#x8868;&#x793A;8&#x4E2A;&#x5B57;&#x8282;&#x5747;&#x53EF;&#x8BBF;&#x95EE;&#xFF0C;0x01&#x8868;&#x793A;8&#x4E2A;&#x5B57;&#x8282;&#x4E2D;&#x53EA;&#x6709;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#xFF0C;0xFD&#x8868;&#x793A;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x5DF2;&#x7ECF;&#x88AB;&#x91CA;&#x653E;&#x3002;</li>
</ol>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1391517e4a533df420a2785aef7c5600418288eb06255b0b05c953f4ee14362c" alt="ASAN&#x57FA;&#x672C;&#x6982;&#x5FF5;.jpg"></p>
<ol start="2">
<li>tag&#x503C;&#x5B58;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x5757;&#x533A;&#x57DF;&#x79F0;&#x4E3A;shadow memory&#xFF0C;&#x5B83;&#x548C;&#x7528;&#x6237;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5185;&#x5B58;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x56FA;&#x5B9A;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5185;&#x5B58;&#x7684;tag&#x503C;&#x4E3A;0x00&#xFF0C;&#x5219;&#x8BBF;&#x95EE;&#x5408;&#x89C4;&#x3002;&#x5982;&#x679C;&#x662F;0x01&#xFF0C;&#x5219;&#x9700;&#x5224;&#x65AD;&#x6B64;&#x6B21;&#x8BBF;&#x95EE;&#x662F;&#x5426;&#x53EA;&#x8BBF;&#x95EE;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5219;&#x4E0D;&#x5408;&#x89C4;&#xFF08;&#x5C5E;&#x4E8E;&#x8D8A;&#x754C;&#x884C;&#x4E3A;&#xFF09;&#x3002;&#x5982;&#x679C;&#x662F;0x00~0x07&#x4EE5;&#x5916;&#x7684;&#x5176;&#x4ED6;&#x503C;&#xFF0C;&#x5219;&#x4E0D;&#x5408;&#x89C4;&#x3002;</li>
</ol>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x601D;&#x8003;&#x4E00;&#x4E0B;&#xFF0C;&#x6240;&#x8C13;&#x7684;&#x662F;&#x5426;&#x5408;&#x89C4;&#x5230;&#x5E95;&#x5728;&#x5224;&#x65AD;&#x4EC0;&#x4E48;&#xFF1F;&#x5176;&#x5B9E;&#x5B83;&#x771F;&#x6B63;&#x60F3;&#x5224;&#x65AD;&#x7684;&#x662F;&#x5185;&#x5B58;&#x7684;&#x6240;&#x6709;&#x6743;&#x95EE;&#x9898;&#x3002;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x5230;&#x5E95;&#x5C5E;&#x4E8E;&#x8C01;&#xFF1F;&#x6211;&#x4EEC;&#x4EE5;&#x6700;&#x5BB9;&#x6613;&#x53D1;&#x751F;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x7684;&#x5806;&#x4E3A;&#x4F8B;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x8C03;&#x7528;malloc&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x800C;&#x540E;&#x7EED;&#x6240;&#x6709;&#x7684;&#x5185;&#x5B58;&#x64CD;&#x4F5C;&#x90FD;&#x57FA;&#x4E8E;&#x8BE5;&#x5730;&#x5740;&#x3002;&#x90A3;&#x4E48;&#x8FD9;&#x65F6;&#xFF0C;&#x865A;&#x62DF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x201C;&#x5C5E;&#x4E8E;&#x8C01;&#x201D;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#x5B9E;&#x9645;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x201C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x6307;&#x9488;&#x201D;&#x3002;&#x6307;&#x9488;&#x548C;&#x6240;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x4E4B;&#x95F4;&#x5982;&#x4F55;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#xFF1F;&#x6700;&#x76F4;&#x63A5;&#x7684;&#x60F3;&#x6CD5;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x201C;&#x864E;&#x7B26;&#x201D;&#xFF0C;&#x6307;&#x9488;&#x548C;&#x5185;&#x5B58;&#x5404;&#x6301;&#x6709;&#x4E00;&#x4E2A;tag&#xFF0C;&#x6839;&#x636E;&#x4E8C;&#x8005;&#x662F;&#x5426;&#x4E00;&#x81F4;&#x6765;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#x3002;&#x5728;32&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x6307;&#x9488;&#x503C;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x6BD4;&#x7279;&#x90FD;&#x88AB;&#x7528;&#x4E8E;&#x5BFB;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x6CA1;&#x6709;&#x591A;&#x4F59;&#x7684;&#x6BD4;&#x7279;&#x6765;&#x8BB0;&#x5F55;&#x6240;&#x6709;&#x6743;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#xFF08;tag&#xFF09;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x5C31;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x5BF9;&#x6BD4;&#x6765;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#x3002;&#x800C;&#x5728;64&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x5730;&#x5740;&#x53EA;&#x6709;&#x4F4E;48&#x4F4D;&#x7528;&#x4E8E;&#x5BFB;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x9AD8;&#x6BD4;&#x7279;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5B58;&#x50A8;tag&#x3002;HWASan&#x548C;MTE&#x90FD;&#x91C7;&#x7528;&#x4E86;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E5F;&#x9650;&#x5B9A;&#x4E86;&#x5B83;&#x4EEC;&#x53EA;&#x80FD;&#x7528;&#x4E8E;64&#x4F4D;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E0D;&#x8FC7;&#x7531;&#x4E8E;tag&#x7684;&#x53EF;&#x9009;&#x8303;&#x56F4;&#x6709;&#x9650;&#xFF0C;&#x56E0;&#x6B64;&#x68C0;&#x6D4B;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x6F0F;&#x68C0;&#x7387;(false-negatives)&#x3002;32&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#x6CA1;&#x529E;&#x6CD5;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#xFF0C;&#x53EA;&#x80FD;&#x9000;&#x800C;&#x6C42;&#x5176;&#x6B21;&#xFF0C;&#x7ED9;&#x6BCF;&#x5757;&#x5185;&#x5B58;&#x6807;&#x8BB0;&#x72B6;&#x6001;&#xFF0C;&#x53EA;&#x8981;&#x8BBF;&#x95EE;&#x7279;&#x5B9A;&#x72B6;&#x6001;&#x7684;&#x5185;&#x5B58;&#x5C31;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;ASan&#x6240;&#x91C7;&#x7528;&#x7684;&#x7B56;&#x7565;&#x3002;</p>
<p>&#x5173;&#x4E8E;ASan&#x548C;HWASan&#x7684;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#xFF0C;&#x5728;&#x6B64;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x3002;&#x4EC5;&#x8D34;&#x51E0;&#x5F20;&#x65B0;&#x753B;&#x7684;&#x56FE;&#xFF0C;&#x6709;&#x9700;&#x8981;&#x7684;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6211;&#x4E4B;&#x524D;&#x7684;<a href="https://dev.newban.cn/6844904111570157575">&#x6587;&#x7AE0;</a>&#x3002;</p>
<p><strong>[ASan&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ee67e8545557af6a2354b4e918835919bacf41c90f823d26b02026fca09ef109" alt="ASAN&#x56FE;&#x4F8B;.png"></p>
<p><strong>[HWASan&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2e57aa7938d2547d25e1a6cf3dc3e390fe27eddcf219b401b66109551e5bbc11" alt="HWASAN&#x56FE;&#x4F8B;.png"></p>
<p><strong>[HWASan&#x8BBF;&#x95EE;&#x8D8A;&#x754C;&#x7684;&#x60C5;&#x51B5;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/5e0e09747359105bf14902f9c3c2aab5a1a833ba5f1af3aa120ff2810ab3e971" alt="HWASAN&#x9519;&#x8BEF;.png"></p>
<p>&#x4E0D;&#x8FC7;&#x5F53;&#x521D;&#x8FD9;&#x7BC7;<a href="https://dev.newban.cn/6844904111570157575">&#x6587;&#x7AE0;</a>&#x6709;&#x4E9B;&#x6D45;&#x8868;&#xFF0C;&#x901A;&#x7BC7;&#x90FD;&#x5728;&#x8BB2;&#x8FF0;&#x201D;&#x662F;&#x4EC0;&#x4E48;&#x201C;&#xFF0C;&#x800C;&#x5C11;&#x4E86;&#x201D;&#x4E3A;&#x4EC0;&#x4E48;&#x201C;&#x7684;&#x601D;&#x8003;&#x3002;&#x56E0;&#x6B64;&#x4ECA;&#x5E74;&#x5728;&#x7814;&#x7A76;MTE&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4ED4;&#x7EC6;&#x601D;&#x8003;&#x4E86;&#x5DE5;&#x5177;&#x7684;&#x5E95;&#x5C42;&#x903B;&#x8F91;&#xFF0C;&#x603B;&#x7ED3;&#x51FA;&#x4E86;&#x4E0A;&#x8FF0;&#x7684;&#x4E24;&#x4E2A;&#x6B65;&#x9AA4;&#x548C;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x6309;&#x7167;&#x8FD9;&#x6837;&#x4E00;&#x79CD;&#x601D;&#x8003;&#x6A21;&#x5F0F;&#xFF0C;&#x4FBF;&#x53EF;&#x4EE5;&#x5C06;Google&#x5F00;&#x53D1;&#x7684;&#x4E09;&#x4E2A;&#x5DE5;&#x5177;&#x7EB3;&#x4E8E;&#x7EDF;&#x4E00;&#x7684;&#x6846;&#x67B6;&#x4E4B;&#x4E0B;&#xFF0C;&#x4E5F;&#x66F4;&#x5BB9;&#x6613;&#x660E;&#x767D;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x548C;&#x5404;&#x81EA;&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#x3002;</p>
<h2 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h2><p>MTE&#x662F;ARM&#x65B0;&#x67B6;&#x6784;&#xFF08;&#x2265;ARMv8.5&#xFF09;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6027;&#x3002;&#x867D;&#x7136;&#x5B83;&#x9700;&#x8981;ARM&#x67B6;&#x6784;&#x5C42;&#x9762;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x4F46;&#x8FD9;&#x9879;&#x5DE5;&#x4F5C;&#x5176;&#x5B9E;&#x4E00;&#x76F4;&#x5728;&#x7531;Google&#x4E3B;&#x5BFC;&#x3002;2018&#x5E74;&#xFF0C;Google&#x4E13;&#x95E8;&#x5199;&#x4E86;&#x300A;<a href="/external_links/ee77373fbabcebcb80272fcff569783c.html" target="blank" rel="noopener">Memory Tagging and how it improves C/C++ memory safety</a>&#x300B;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x9610;&#x8FF0;&#x4E86;memory tagging&#x5728;&#x8F6F;&#x4EF6;&#x548C;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x4E0D;&#x540C;&#x5B9E;&#x73B0;&#x548C;&#x6027;&#x80FD;&#x6BD4;&#x8F83;&#xFF0C;&#x5E76;&#x5021;&#x8BAE;&#x67B6;&#x6784;&#x5382;&#x5546;&#x4EEC;&#x90FD;&#x96C6;&#x6210;memory tagging&#x7684;&#x529F;&#x80FD;&#x3002;&#x4E4B;&#x540E;Google&#x548C;ARM&#x901A;&#x529B;&#x5408;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x5728;v8.5&#x7684;&#x67B6;&#x6784;&#x4E0A;&#x5B9E;&#x73B0;&#x4E86;MTE&#x7684;&#x529F;&#x80FD;&#x3002;&#x4E0D;&#x8FC7;&#x82AF;&#x7247;&#x7684;&#x751F;&#x4EA7;&#x4E00;&#x822C;&#x90FD;&#x665A;&#x4E8E;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#xFF0C;&#x6240;&#x4EE5;MTE&#x6700;&#x7EC8;&#x9762;&#x5411;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x7B49;&#x4E0A;&#x4E00;&#x4F1A;&#x513F;&#x3002;</p>
<p>MTE&#x7684;&#x539F;&#x7406;&#x548C;HWASan&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#x548C;tag&#x7684;&#x751F;&#x6210;&#x5B58;&#x50A8;&#x4E0A;&#x6709;&#x4E86;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x652F;&#x6301;&#x3002;&#x9996;&#x5148;&#x662F;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#xFF1A;HWASan&#x901A;&#x8FC7;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5728;&#x6240;&#x6709;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x524D;&#x63D2;&#x5165;&#x68C0;&#x6D4B;&#x4EE3;&#x7801;&#xFF0C;&#x5C5E;&#x4E8E;&#x8F6F;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x68C0;&#x6D4B;&#xFF1B;&#x800C;MTE&#x662F;&#x5728;ldr/str&#x7684;&#x6307;&#x4EE4;&#x5185;&#x90E8;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#xFF0C;&#x6362;&#x8A00;&#x4E4B;&#xFF0C;&#x662F;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x68C0;&#x6D4B;&#x3002;&#x5176;&#x6B21;&#x662F;tag&#x7684;&#x751F;&#x6210;&#xFF1A;HWASan&#x901A;&#x8FC7;&#x8F6F;&#x4EF6;&#x968F;&#x673A;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x751F;&#x6210;tag&#xFF1B;&#x800C;MTE&#x662F;&#x901A;&#x8FC7;IRG&#x6307;&#x4EE4;&#xFF08;&#x2265;ARMv8.5&#x7684;&#x67B6;&#x6784;&#x624D;&#x6709;&#x7684;&#x6307;&#x4EE4;&#xFF09;&#x6765;&#x751F;&#x6210;tag&#x3002;&#x6700;&#x540E;&#x662F;tag&#x7684;&#x5B58;&#x50A8;&#xFF1A;HWASan&#x5C06;&#x5185;&#x5B58;&#x7684;tag&#x5B58;&#x5728;shadow memory&#xFF08;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x5177;&#x6709;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF09;&#x4E2D;&#xFF0C;shadow memory&#x548C;normal memory&#x4E4B;&#x95F4;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x7531;&#x5DE5;&#x5177;&#x63D0;&#x524D;&#x8BBE;&#x5B9A;&#xFF1B;MTE&#x5C06;&#x5185;&#x5B58;&#x7684;tag&#x5B58;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7279;&#x5B9A;&#x533A;&#x57DF;&#x4E2D;&#xFF08;&#x6CA1;&#x6709;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x88AB;&#x7528;&#x6237;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF09;&#xFF0C;&#x4E8C;&#x8005;&#x4E4B;&#x95F4;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x7531;&#x786C;&#x4EF6;&#x4FDD;&#x8BC1;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;HWASan&#x662F;&#x6BCF;16bytes&#x7684;&#x5185;&#x5B58;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;tag&#xFF0C;tag&#x81EA;&#x8EAB;&#x4E3A;8bits&#xFF08;&#x6307;&#x9488;&#x4E2D;&#x7684;tag&#x5B58;&#x5728;56<del>63&#x4F4D;&#xFF09;&#x3002;MTE&#x4E5F;&#x662F;&#x6BCF;16bytes&#x7684;&#x5185;&#x5B58;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;tag&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x7684;tag&#x957F;&#x5EA6;&#x53EA;&#x6709;4bits&#xFF08;&#x6307;&#x9488;&#x4E2D;&#x7684;tag&#x5B58;&#x5728;56</del>59&#x4F4D;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x9009;&#x62E9;&#x7684;&#x6570;&#x503C;&#x66F4;&#x5C11;&#x3002;</p>
<p>&#x8FD9;&#x6837;&#x7684;&#x6539;&#x52A8;&#x5E26;&#x6765;&#x4E24;&#x4E2A;&#x9769;&#x547D;&#x6027;&#x7684;&#x4F18;&#x52BF;&#xFF1A;</p>
<ol>
<li>&#x6027;&#x80FD;&#x5927;&#x5927;&#x63D0;&#x5347;&#xFF0C;MTE&#x9996;&#x6B21;&#x5177;&#x5907;&#x4E86;&#x7EBF;&#x4E0A;&#x90E8;&#x7F72;(in production)&#x7684;&#x53EF;&#x80FD;&#x3002;</li>
<li>&#x68C0;&#x6D4B;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4EE3;&#x7801;&#x63D2;&#x6869;&#xFF0C;&#x56E0;&#x6B64;&#x4E5F;&#x65E0;&#x9700;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF0C;&#x5927;&#x5927;&#x65B9;&#x4FBF;&#x4E86;&#x4F7F;&#x7528;&#x3002;</li>
</ol>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x4E09;&#x4E2A;&#x5DE5;&#x5177;&#x7684;&#x5F00;&#x9500;&#x5BF9;&#x6BD4;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x89C2;&#x611F;&#x53D7;&#x5230;MTE&#x7684;&#x63D0;&#x5347;&#x3002;</p>
<table>
<thead>
<tr>
<th><strong>Overhead type</strong></th>
<th><strong>MTE</strong></th>
<th><strong><a href="/external_links/fcac98d79d652a5d6c020c21e6c643ea.html" target="blank" rel="noopener">HWASan</a></strong></th>
<th><strong><a href="/external_links/0ef663ea1e56bc72062d483eccfaac0a.html" target="blank" rel="noopener">ASan</a></strong></th>
</tr>
</thead>
<tbody><tr>
<td>RAM</td>
<td>3%-5%</td>
<td>10%-35%</td>
<td>~2x</td>
</tr>
<tr>
<td>CPU</td>
<td>0%-5%</td>
<td>~2x</td>
<td>~2x</td>
</tr>
<tr>
<td>Code size</td>
<td>2%-4%</td>
<td>40%-50%</td>
<td>50%-2x</td>
</tr>
</tbody></table>
<h2 id="&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;"><a href="#&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;" class="headerlink" title="&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;"></a>&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;</h2><p>MTE&#x5177;&#x6709;&#x4E24;&#x79CD;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#xFF1A;&#x540C;&#x6B65;(Synchronous)&#x548C;&#x5F02;&#x6B65;(Asynchronous)&#x3002;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x6027;&#x80FD;&#x5F00;&#x9500;&#x5927;&#xFF0C;&#x4F46;&#x68C0;&#x6D4B;&#x53CA;&#x65F6;&#xFF0C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6536;&#x96C6;&#x8BE6;&#x5C3D;&#xFF1B;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x867D;&#x7136;&#x68C0;&#x6D4B;&#x4E0D;&#x53CA;&#x65F6;&#xFF0C;&#x4F46;&#x6027;&#x80FD;&#x5F00;&#x9500;&#x5C0F;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;release&#x7248;&#x672C;&#xFF08;&#x4E5F;&#x53EF;&#x4EE5;&#x62B5;&#x5FA1;&#x5185;&#x5B58;&#x653B;&#x51FB;&#xFF09;&#x3002;</p>
<ul>
<li>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;(ldr/str)&#x65F6;&#xFF0C;&#x540C;&#x6B65;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5339;&#x914D;&#x5219;&#x89E6;&#x53D1;&#x5F02;&#x5E38;&#x3002;&#x8FDB;&#x7A0B;&#x6536;&#x5230;SIGSEGV&#x4FE1;&#x53F7;&#xFF0C;&#x5176;&#x4E2D;&#x7684; siginfo.si_code = SEGV_MTESERR &#xFF08;SERR&#x4E2D;&#x7684;S&#x8868;&#x793A;synchronous&#xFF09;&#xFF0C;siginfo.si_addr = <fault-address> &#x3002;</fault-address></li>
<li>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x65F6;&#xFF0C;&#x5F02;&#x6B65;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5339;&#x914D;&#x5219;&#x66F4;&#x65B0;TFSR_EL1&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#x7684;TF0 bit&#x3002;&#x5F53;&#x4E0B;&#x4E00;&#x6B21;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;(&#x8C03;&#x5EA6;)&#x6216;&#x7EBF;&#x7A0B;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x65F6;,&#x7CFB;&#x7EDF;&#x4F1A;&#x53BB;&#x68C0;&#x6D4B;TFSR_EL1&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x8FDB;&#x800C;&#x4EA7;&#x751F;SIGSEGV&#x4FE1;&#x53F7;&#x3002;&#x53EA;&#x4E0D;&#x8FC7;&#x6B64;&#x65F6;&#x7684; siginfo.si_code = SEGV_MTEAERR &#xFF08;AERR&#x4E2D;&#x7684;A&#x8868;&#x793A;asynchronous&#xFF09;&#xFF0C;siginfo.si_addr = 0 &#xFF0C;&#x8868;&#x660E;&#x7CFB;&#x7EDF;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x662F;&#x54EA;&#x4E00;&#x6761;&#x5177;&#x4F53;&#x7684;&#x6307;&#x4EE4;&#x5BFC;&#x81F4;&#x7684;&#x95EE;&#x9898;&#x3002;</li>
</ul>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x540C;&#x6B65;&#x548C;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x6027;&#x80FD;&#x5DEE;&#x5F02;&#x5462;&#xFF1F;&#x8FD9;&#x9700;&#x8981;&#x7275;&#x6D89;&#x5230;&#x6D41;&#x6C34;&#x7EBF;&#x4F18;&#x5316;&#x7684;&#x77E5;&#x8BC6;&#x3002;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x8BFB;&#x548C;&#x5199;&#xFF0C;&#x5199;&#x64CD;&#x4F5C;&#x5728;&#x6D41;&#x6C34;&#x7EBF;&#x4E2D;&#x662F;&#x53EF;&#x4EE5;&#x6709;&#x4E9B;&#x6FC0;&#x8FDB;&#x7684;&#x4F18;&#x5316;&#x7B56;&#x7565;&#x7684;&#x3002;&#x8B6C;&#x5982;&#x5C06;&#x8FDE;&#x7EED;&#x7684;&#x5199;&#x64CD;&#x4F5C;&#x5408;&#x4E3A;&#x4E00;&#x6B21;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x6216;&#x8005;&#x5C06;&#x5199;&#x64CD;&#x4F5C;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#xFF0C;&#x7A0D;&#x540E;&#x518D;&#x53D1;&#x751F;&#x5B9E;&#x9645;&#x7684;&#x5199;&#x52A8;&#x4F5C;&#x3002;&#x5BF9;&#x540C;&#x6B65;&#x68C0;&#x6D4B;&#x800C;&#x8A00;&#xFF0C;&#x5B83;&#x5FC5;&#x987B;&#x8981;&#x8BFB;&#x53D6;&#x5185;&#x5B58;&#x7684;tag&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x5728;&#x5199;&#x64CD;&#x4F5C;&#x7684;&#x540C;&#x65F6;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x8BFB;&#x64CD;&#x4F5C;&#x3002;&#x57FA;&#x4E8E;&#x5185;&#x5B58;&#x4E00;&#x81F4;&#x6027;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x8FD9;&#x5C06;&#x4F7F;&#x5F97;&#x5199;&#x64CD;&#x4F5C;&#x7684;&#x67D0;&#x4E9B;&#x4F18;&#x5316;&#x7B56;&#x7565;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;CPU&#x7684;&#x8FD0;&#x884C;&#x6548;&#x7387;&#x964D;&#x4F4E;&#x3002;&#xFF08;&#x8FD9;&#x4E00;&#x5757;&#x77E5;&#x8BC6;&#x6211;&#x53EA;&#x662F;&#x7C97;&#x6D45;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E86;&#x89E3;&#x7684;&#x670B;&#x53CB;&#x5E0C;&#x671B;&#x4E0D;&#x541D;&#x8D50;&#x6559;&#xFF09;</p>
<h2 id="&#x591A;&#x91CD;&#x542B;&#x4E49;"><a href="#&#x591A;&#x91CD;&#x542B;&#x4E49;" class="headerlink" title="&#x591A;&#x91CD;&#x542B;&#x4E49;"></a>&#x591A;&#x91CD;&#x542B;&#x4E49;</h2><p>MTE&#x6700;&#x539F;&#x59CB;&#x7684;&#x542B;&#x4E49;&#x662F;ARM&#x67B6;&#x6784;&#x91CC;&#x7684;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;ARM&#x63D0;&#x4F9B;&#x4E86;&#x8FD9;&#x79CD;&#x68C0;&#x6D4B;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F46;&#x662F;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x3001;&#x68C0;&#x6D4B;&#x4EC0;&#x4E48;&#x5185;&#x5B58;&#x662F;&#x9700;&#x8981;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x548C;&#x7F16;&#x8BD1;&#x5668;&#x914D;&#x5408;&#x7684;&#x3002;&#x56E0;&#x6B64;LLVM&#x548C;Android&#x91CC;&#x90FD;&#x9700;&#x8981;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x4EE3;&#x7801;&#xFF0C;&#x65B9;&#x80FD;&#x8BA9;MTE&#x771F;&#x6B63;&#x5730;&#x88AB;&#x5F00;&#x53D1;&#x8005;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x9996;&#x5148;&#x4ECB;&#x7ECD;&#x4E0B;LLVM&#x91CC;&#x5173;&#x4E8E;MTE&#x7684;&#x76F8;&#x5173;&#x5DE5;&#x4F5C;&#x3002;</p>
<p>&#x53EF;&#x80FD;&#x6709;&#x4EBA;&#x4F1A;&#x597D;&#x5947;&#xFF0C;&#x4E0A;&#x9762;&#x4E0D;&#x662F;&#x8BF4;&#x4E86;MTE&#x7684;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#x5DF2;&#x7ECF;&#x653E;&#x5230;ldr/str&#x6307;&#x4EE4;&#x7684;&#x5185;&#x90E8;&#x4E86;&#x4E48;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x9700;&#x8981;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x4ECB;&#x5165;&#x5462;&#xFF1F;&#x539F;&#x56E0;&#x662F;&#x4E3A;&#x4E86;&#x8FDB;&#x884C;&#x6808;&#x4E0A;&#x5185;&#x5B58;&#x7684;&#x68C0;&#x6D4B;&#x3002;&#x7531;&#x4E8E;&#x6808;&#x5BF9;&#x8C61;&#x7684;&#x5206;&#x914D;&#x6CA1;&#x6709;&#x663E;&#x793A;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x63D2;&#x6869;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x4E3A;&#x8BE5;&#x5185;&#x5B58;&#x751F;&#x6210;tag&#x3002;&#x901A;&#x8FC7;<code>-fsanitize=memtag -march=armv8.5-a+memtag</code>&#x7684;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#x5373;&#x53EF;&#x6253;&#x5F00;&#x6808;&#x5185;&#x5B58;&#x7684;&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x662F;Android&#x4E2D;&#x5173;&#x4E8E;MTE&#x7684;&#x76F8;&#x5173;&#x5DE5;&#x4F5C;&#x3002;Android&#x4E2D;MTE&#x7684;&#x68C0;&#x6D4B;&#x4E3B;&#x8981;&#x9488;&#x5BF9;&#x7684;&#x662F;&#x5806;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x96C6;&#x6210;&#x5728;&#x5206;&#x914D;&#x5668;Scudo&#x4E2D;&#xFF0C;&#x5728;&#x52A8;&#x6001;&#x5185;&#x5B58;&#x5206;&#x914D;&#x65F6;&#x4E3A;&#x5176;&#x751F;&#x6210;tag&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5F53;&#x6211;&#x4EEC;&#x8BA8;&#x8BBA;MTE&#x65F6;&#xFF0C;&#x4E00;&#x5B9A;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x8BED;&#x5883;&#xFF0C;&#x77E5;&#x9053;&#x5BF9;&#x65B9;&#x8BF4;&#x7684;&#x5230;&#x5E95;&#x662F;ARM MTE&#xFF0C;&#x8FD8;&#x662F;LLVM MTE&#xFF0C;&#x6291;&#x6216;&#x662F;Scudo MTE&#x3002;</p>
<h2 id="&#x6307;&#x4EE4;&#x7B80;&#x4ECB;"><a href="#&#x6307;&#x4EE4;&#x7B80;&#x4ECB;" class="headerlink" title="&#x6307;&#x4EE4;&#x7B80;&#x4ECB;"></a>&#x6307;&#x4EE4;&#x7B80;&#x4ECB;</h2><p>&#x4E0A;&#x9762;&#x591A;&#x6B21;&#x63D0;&#x5230;ARMv8.5&#x4EE5;&#x540E;&#x7684;&#x67B6;&#x6784;&#x4E2D;&#xFF0C;ldr/str&#x6307;&#x4EE4;&#x7684;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x4E2D;&#x96C6;&#x6210;&#x4E86;tag&#x68C0;&#x6D4B;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x786E;&#x8BA4;&#x8FD9;&#x4E00;&#x70B9;&#x5462;&#xFF1F;</p>
<p>&#x9996;&#x5148;&#x4E0B;&#x8F7D;&#x4E00;&#x4EFD;ARMv9&#x6307;&#x4EE4;&#x96C6;&#x7684;<a href="/external_links/5c9f829d3937196292243ea3589522aa.html" target="blank" rel="noopener">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#xFF0C;&#x7136;&#x540E;&#x67E5;&#x770B;ldr&#x6307;&#x4EE4;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/59d55c36741428d9408cf81af8f79a5d17fc5fbcbda01752b2a0bce71ccae652" alt="ARMv9 LDR 1.jpg"></p>
<p>&#x8FD9;&#x4E2A;operation&#x5176;&#x5B9E;&#x5C31;&#x662F;ldr&#x6307;&#x4EE4;&#x5177;&#x4F53;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x63A5;&#x7740;&#x67E5;&#x770B;Mem&#xFF0C;&#x4E00;&#x8DEF;&#x8FFD;&#x8E2A;&#x4E0B;&#x53BB;&#x53D1;&#x73B0;&#xFF1A;&#x5728;MTE enable&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F1A;&#x6700;&#x7EC8;&#x6267;&#x884C;CheckTag&#x7684;&#x52A8;&#x4F5C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2d8b6ef61140efa0cce5a3e02cafd2a3adc88c837f107520bedf01612524b8cb" alt="ARMv9 LDR 2.jpg"></p>
<p>&#x6B64;&#x5916;&#xFF0C;ARM&#x65B0;&#x7684;&#x67B6;&#x6784;&#x4E2D;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x6307;&#x4EE4;&#xFF0C;&#x65B9;&#x4FBF;&#x5FEB;&#x901F;&#x5730;&#x5BF9;tag&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;&#x8B6C;&#x5982;&#x5982;&#x4E0B;&#x4E24;&#x6761;&#x6307;&#x4EE4;&#x3002;</p>
<ul>
<li><code>IRG Xd, Xn</code> &#x5C06;<code>Xn</code> &#x62F7;&#x8D1D;&#x5230; <code>Xd</code>&#xFF0C;&#x5E76;&#x4E14;&#x4E3A;<code>Xd</code>&#x4E2D;&#x7684;&#x503C;&#x968F;&#x673A;&#x751F;&#x6210;&#x4E00;&#x4E2A;tag&#xFF0C;&#x5B58;&#x5728;&#x5B83;&#x7684;[56:59]&#x4F4D;&#x3002;</li>
<li><code>STG Xd, [Xn]</code> &#x5C06;&#x5185;&#x5B58; <code>[Xn, Xn + 16)</code>&#x7684;tag&#x66F4;&#x65B0;&#x4E3A; <code>Xd</code>&#x7684;tag&#x503C;&#x3002;</li>
</ul>
<p>ARM&#x603B;&#x5171;&#x65B0;&#x589E;&#x4E86;10&#x4F59;&#x6761;&#x6307;&#x4EE4;&#x7528;&#x4E8E;&#x652F;&#x6301;MTE&#x3002;&#x4F5C;&#x4E3A;&#x4F7F;&#x7528;&#x8005;&#x5176;&#x5B9E;&#x6CA1;&#x5FC5;&#x8981;&#x4E86;&#x89E3;&#x6BCF;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x542B;&#x4E49;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x660E;&#x767D;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x662F;&#x4E3A;&#x4E86;&#x66F4;&#x5FEB;&#x901F;&#x3001;&#x66F4;&#x65B9;&#x4FBF;&#x5730;&#x64CD;&#x4F5C;tag&#x5373;&#x53EF;&#x3002;</p>
<h2 id="Scudo&#x4E2D;&#x7684;MTE"><a href="#Scudo&#x4E2D;&#x7684;MTE" class="headerlink" title="Scudo&#x4E2D;&#x7684;MTE"></a>Scudo&#x4E2D;&#x7684;MTE</h2><h3 id="1-&#x68C0;&#x6D4B;&#x65B9;&#x5F0F;"><a href="#1-&#x68C0;&#x6D4B;&#x65B9;&#x5F0F;" class="headerlink" title="1. &#x68C0;&#x6D4B;&#x65B9;&#x5F0F;"></a>1. &#x68C0;&#x6D4B;&#x65B9;&#x5F0F;</h3><p>&#xFF08;&#x5173;&#x4E8E;Scudo&#x7684;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6211;&#x4E4B;&#x524D;&#x7684;<a href="https://dev.newban.cn/6914550038140026887">&#x6587;&#x7AE0;</a>&#xFF09;</p>
<p>Scudo&#x4E2D;&#x7684;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x4E00;&#x79CD;&#x662F;Primary allocate&#xFF0C;&#x7528;&#x4E8E;&#x5206;&#x914D;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x4F7F;&#x7528;&#x9891;&#x7E41;&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;Secondary allocate&#xFF0C;&#x7528;&#x4E8E;&#x5206;&#x914D;&#x5927;&#x5185;&#x5B58;(&gt;256K)&#x3002;</p>
<p>&#x6240;&#x6709;&#x5806;&#x5185;&#x5B58;&#x7684;&#x5206;&#x914D;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528;<code>Allocator::allocate</code>&#x51FD;&#x6570;&#x3002;&#x5F53;&#x5185;&#x5B58;&#x5206;&#x914D;&#x51FA;&#x6765;&#x540E;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x8C03;&#x7528;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;//Primary Allocator</span><br><span class="line">  const uptr OddEvenMask =</span><br><span class="line">	  computeOddEvenMaskForPointerMaybe(Options, BlockUptr, ClassId);</span><br><span class="line">  TaggedPtr = prepareTaggedChunk(Ptr, Size, OddEvenMask, BlockEnd);</span><br><span class="line">  storePrimaryAllocationStackMaybe(Options, Ptr);</span><br><span class="line">...</span><br><span class="line">//Secondary Allocator</span><br><span class="line">} else {</span><br><span class="line">  storeTags(reinterpret_cast&lt;uptr&gt;(Block), reinterpret_cast&lt;uptr&gt;(Ptr));</span><br><span class="line">  storeSecondaryAllocationStackMaybe(Options, Ptr, Size);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="1-1-Primary-Allocator"><a href="#1-1-Primary-Allocator" class="headerlink" title="1.1 Primary Allocator"></a>1.1 Primary Allocator</h4><p>Primary Allocator&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5757;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;Block&#x662F;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x4E14;&#x8FDE;&#x7EED;&#x6392;&#x5217;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x5176;&#x4E2D;Header&#x5B58;&#x50A8;&#x4E86;&#x8BE5;&#x5185;&#x5B58;&#x5757;&#x7684;&#x4E00;&#x4E9B;&#x5143;&#x6570;&#x636E;&#x4FBF;&#x4E8E;&#x91CA;&#x653E;&#x65F6;&#x8FDB;&#x884C;&#x72B6;&#x6001;&#x68C0;&#x6D4B;&#xFF0C;&#x800C;&#x771F;&#x5B9E;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x7684;&#x6307;&#x9488;&#x4E3A;Ptr&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1e6378b424f944ee9144edcefdebea22fef7d9fd6e8e96bf15da3078687d2daa" alt="Chunk Tag.png"></p>
<p>&#x5BF9;&#x4E8E;&#x5206;&#x914D;&#x51FA;&#x6765;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;Primary Allocator&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x7ED9;&#x8FD4;&#x56DE;&#x5730;&#x5740;(&#x6307;&#x9488;)Ptr&#x589E;&#x52A0;tag&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;const uptr OddEvenMask =</span><br><span class="line">    computeOddEvenMaskForPointerMaybe(Options, BlockUptr, BlockSize);</span><br><span class="line">TaggedPtr = prepareTaggedChunk(Ptr, Size, OddEvenMask, BlockEnd);</span><br></pre></td></tr></table></figure>

<p><code>OddEvenMask</code>&#x5148;&#x6309;&#x4E0B;&#x4E0D;&#x8868;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EA;&#x5173;&#x5FC3;<code>prepareTaggedChunk</code>&#x3002;&#x5176;&#x5185;&#x90E8;&#x6240;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x6B63;&#x662F;&#x4E3A;&#x521A;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x751F;&#x6210;tag&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;inline void *prepareTaggedChunk(void *Ptr, uptr Size, uptr ExcludeMask,</span><br><span class="line">                                uptr BlockEnd) {</span><br><span class="line">  // Prepare the granule before the chunk to store the chunk header by setting</span><br><span class="line">  // its tag to 0. Normally its tag will already be 0, but in the case where a</span><br><span class="line">  // chunk holding a low alignment allocation is reused for a higher alignment</span><br><span class="line">  // allocation, the chunk may already have a non-zero tag from the previous</span><br><span class="line">  // allocation.</span><br><span class="line">  __asm__ __volatile__(&quot;.arch_extension memtag; stg %0, [%0, #-16]&quot;</span><br><span class="line">                       :</span><br><span class="line">                       : &quot;r&quot;(Ptr)</span><br><span class="line">                       : &quot;memory&quot;);</span><br><span class="line"></span><br><span class="line">  uptr TaggedBegin, TaggedEnd;</span><br><span class="line">  setRandomTag(Ptr, Size, ExcludeMask, &amp;TaggedBegin, &amp;TaggedEnd);</span><br><span class="line"></span><br><span class="line">  // Finally, set the tag of the granule past the end of the allocation to 0,</span><br><span class="line">  // to catch linear overflows even if a previous larger allocation used the</span><br><span class="line">  // same block and tag. Only do this if the granule past the end is in our</span><br><span class="line">  // block, because this would otherwise lead to a SEGV if the allocation</span><br><span class="line">  // covers the entire block and our block is at the end of a mapping. The tag</span><br><span class="line">  // of the next block&apos;s header granule will be set to 0, so it will serve the</span><br><span class="line">  // purpose of catching linear overflows in this case.</span><br><span class="line">  uptr UntaggedEnd = untagPointer(TaggedEnd);</span><br><span class="line">  if (UntaggedEnd != BlockEnd)</span><br><span class="line">    __asm__ __volatile__(&quot;.arch_extension memtag; stg %0, [%0]&quot;</span><br><span class="line">                         :</span><br><span class="line">                         : &quot;r&quot;(UntaggedEnd)</span><br><span class="line">                         : &quot;memory&quot;);</span><br><span class="line">  return reinterpret_cast&lt;void *&gt;(TaggedBegin);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x4E8E;&#x9700;&#x8981;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6C47;&#x7F16;&#x6307;&#x4EE4;<code>stg</code>&#xFF0C;&#x56E0;&#x6B64;<code>prepareTaggedChunk</code>&#x4E2D;&#x5185;&#x5D4C;&#x4E86;&#x4E00;&#x4E9B;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF08;<code>setRandomTag</code>&#x51FD;&#x6570;&#x4E2D;&#x4E5F;&#x6709;&#x4E00;&#x4E9B;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF09;&#x3002;&#x8BE5;&#x51FD;&#x6570;&#x6709;&#x56DB;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x542B;&#x4E49;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>Ptr&#xFF1A;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;tag&#x7684;&#x6307;&#x9488;&#xFF0C;&#x4E5F;&#x5373;&#x5B83;&#x7684;56~59&#x4F4D;&#x5747;&#x4E3A;0&#x3002;&#x8868;&#x660E;chunk&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x3002;</li>
<li>Size&#xFF1A;&#x8981;&#x6C42;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;&#x3002;</li>
<li>ExcludeMask&#xFF1A;MTE&#x7684;tag&#x4E3A;4 bits&#xFF0C;&#x56E0;&#x6B64;&#x6709;0~15&#x5171;16&#x79CD;&#x53EF;&#x80FD;&#x3002;Android&#x9ED8;&#x8BA4;&#x4E0D;&#x9009;&#x7528;0&#xFF0C;&#x56E0;&#x6B64;&#x8FD8;&#x5269;&#x4E0B;15&#x79CD;&#x53EF;&#x80FD;&#x3002;ExcludeMask&#x7528;&#x4E8E;&#x4ECE;15&#x79CD;&#x53EF;&#x80FD;&#x4E2D;&#x518D;&#x5220;&#x53BB;&#x4E00;&#x4E9B;&#x9009;&#x62E9;&#xFF0C;&#x8B6C;&#x5982;&#x8BE5;&#x503C;&#x4E3A;0x6&#xFF0C;&#x5219;tag&#x4E0D;&#x4F1A;&#x9009;&#x62E9;1&#x6216;2&#xFF08;0x6==0b0110&#xFF0C;&#x4ECE;&#x4F4E;&#x5230;&#x9AD8;&#x7684;1&#x3001;2&#x6BD4;&#x7279;&#x5747;&#x4E3A;1&#xFF09;&#x3002;</li>
<li>BlockEnd&#xFF1A;&#x5757;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#xFF0C;&#x7531;&#x4E8E;Scudo&#x4E2D;region&#x5B58;&#x50A8;&#x7684;&#x90FD;&#x662F;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x7684;&#x5757;&#xFF0C;&#x56E0;&#x6B64;&#x5757;&#x5927;&#x5C0F;&#x53EF;&#x80FD;&#x5927;&#x4E8E;&#x8981;&#x6C42;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;&#x3002;</li>
</ul>
<p><code>prepareTaggedChunk</code>&#x4E2D;&#x7684;<code>setRandomTag</code>&#x4F1A;&#x4EE5;16bytes&#x4E3A;&#x5355;&#x4F4D;&#xFF0C;&#x5FAA;&#x73AF;&#x4E3A;chunk&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5185;&#x5B58;&#x5206;&#x914D;tag&#x3002;&#x6700;&#x7EC8;&#x7684;tag&#x60C5;&#x51B5;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/daafbcf037d176073c339ea254c4f5ce84fb1637449e0d2a184077a73094b4ad" alt="Chunk with Tag.png"></p>
<p>Tag&#x751F;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x8D8A;&#x754C;&#x7684;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x5C31;&#x4F1A;&#x56E0;tag&#x4E0D;&#x5339;&#x914D;&#x800C;&#x53D1;&#x751F;SIGSEGV&#x3002;&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x70B9;&#xFF0C;Unused&#x5185;&#x5B58;&#x4E2D;&#x53EA;&#x5BF9;&#x7B2C;&#x4E00;&#x4E2A;16bytes&#x751F;&#x6210;&#x4E86;tag&#xFF0C;&#x8FD9;&#x6837;&#x7EBF;&#x6027;&#x7684;&#x8D8A;&#x754C;&#x5C06;&#x4F1A;100%&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#xFF0C;&#x800C;&#x975E;&#x7EBF;&#x6027;&#x7684;&#x8DE8;&#x8D8A;&#x5F0F;&#x8D8A;&#x754C;&#x5219;&#x662F;&#x6982;&#x7387;&#x6027;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x5C06;Unused&#x5185;&#x5B58;&#x5168;&#x90E8;tag&#x4E3A;0&#xFF0C;Google&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#x8BF4;&#x662F;&#x57FA;&#x4E8E;&#x6027;&#x80FD;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD9;&#x6837;&#x786E;&#x5B9E;&#x53EF;&#x80FD;&#x4F1A;&#x6F0F;&#x68C0;&#x4E00;&#x4E9B;&#x8DE8;&#x8D8A;&#x5F0F;&#x7684;&#x8D8A;&#x754C;&#x3002;&#x636E;&#x7EDF;&#x8BA1;&#xFF0C;Chromium&#x7684;&#x5F00;&#x53D1;&#x5B9E;&#x8DF5;&#x4E2D;&#x7EA6;13%&#x7684;overflow&#x662F;&#x8DE8;&#x8D8A;&#x5F0F;&#x7684;overflow&#x3002;</p>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x4E86;&#x8D8A;&#x754C;&#x7684;&#x68C0;&#x6D4B;&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x4E48;UAF(Use-After-Free)&#x662F;&#x5982;&#x4F55;&#x68C0;&#x6D4B;&#x7684;&#x5462;&#xFF1F;</p>
<p>&#x5F53;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x53BB;&#x8C03;&#x7528;Scudo&#x4E2D;&#x7684;<code>quarantineOrDeallocateChunk</code>&#x65B9;&#x6CD5;&#x3002;&#x91CA;&#x653E;&#x7684;&#x5185;&#x5B58;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;tag&#xFF0C;&#x8BE5;tag&#x6709;&#x522B;&#x4E8E;&#x4E4B;&#x524D;&#x7684;tag&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;immediate UAF&#x88AB;100%&#x5730;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x4E0D;&#x8FC7;&#x957F;&#x65F6;&#x95F4;&#x7684;UAF&#x53EF;&#x80FD;&#x4F1A;&#x56E0;&#x4E3A;&#x8BE5;&#x5185;&#x5B58;&#x7ECF;&#x5386;&#x4E86;&#x591A;&#x6B21;&#x5206;&#x914D;/&#x91CA;&#x653E;&#x800C;&#x53D1;&#x751F;&#x6F0F;&#x68C0;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x518D;&#x4ECB;&#x7ECD;&#x4E0B;<code>OddEvenMask</code>&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x6709;&#x8DA3;&#x7684;&#x77E5;&#x8BC6;&#x70B9;&#x3002;</p>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#xFF0C;&#x8FD9;&#x4E2A;mask&#x4F1A;&#x9650;&#x5236;tag&#x4ECE;&#x54EA;&#x4E9B;&#x6570;&#x4E2D;&#x968F;&#x673A;&#x9009;&#x53D6;&#x3002;&#x5BF9;&#x4E8E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8FDE;&#x7EED;&#x7684;&#x5185;&#x5B58;&#x5757;(Block)&#xFF0C;OddEvenMask&#x5C06;&#x4F1A;&#x95F4;&#x9694;&#x5730;&#x8D4B;&#x503C;&#x4E3A;0xaaaa&#x548C;0x5555&#x3002;0xa=0b1010&#xFF0C;0x5=0b0101&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x8FD9;&#x4E24;&#x4E2A;mask&#x662F;&#x5B8C;&#x5168;&#x4E92;&#x65A5;&#x7684;tag&#x96C6;&#x5408;&#x3002;OddEvenMask&#x4E3A;0xaaaa&#xFF0C;&#x5219;tag&#x53EA;&#x80FD;&#x9009;&#x62E9;&#x5947;&#x6570;&#xFF0C;&#x53CD;&#x4E4B;tag&#x53EA;&#x80FD;&#x9009;&#x62E9;&#x975E;0&#x7684;&#x5076;&#x6570;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;uptr computeOddEvenMaskForPointerMaybe(Options Options, uptr Ptr,</span><br><span class="line">                                       uptr ClassId) {</span><br><span class="line">  if (!Options.get(OptionBit::UseOddEvenTags))</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">  // If a chunk&apos;s tag is odd, we want the tags of the surrounding blocks to be</span><br><span class="line">  // even, and vice versa. Blocks are laid out Size bytes apart, and adding</span><br><span class="line">  // Size to Ptr will flip the least significant set bit of Size in Ptr, so</span><br><span class="line">  // that bit will have the pattern 010101... for consecutive blocks, which we</span><br><span class="line">  // can use to determine which tag mask to use.</span><br><span class="line">  return 0x5555U &lt;&lt; ((Ptr &gt;&gt; SizeClassMap::getSizeLSBByClassId(ClassId)) &amp; 1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x76F8;&#x90BB;&#x7684;&#x4E24;&#x4E2A;&#x5185;&#x5B58;&#x5757;&#x4E00;&#x5B9A;&#x4E0D;&#x4F1A;&#x4F7F;&#x7528;&#x76F8;&#x540C;&#x7684;tag&#xFF0C;&#x4FDD;&#x8BC1;&#x4E86;&#x76F8;&#x90BB;&#x7684;&#x8D8A;&#x754C;&#x53EF;&#x4EE5;100%&#x88AB;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x4E0D;&#x8FC7;&#x51E1;&#x4E8B;&#x6709;&#x5229;&#x6709;&#x5F0A;&#xFF0C;&#x7531;&#x4E8E;&#x6BCF;&#x4E2A;&#x5185;&#x5B58;&#x5757;tag&#x53EF;&#x9009;&#x62E9;&#x7684;&#x8303;&#x56F4;&#x7F29;&#x5C0F;&#x4E00;&#x534A;&#xFF0C;&#x56E0;&#x6B64;UAF&#x7684;&#x6F0F;&#x68C0;&#x7387;(false-negatives)&#x53CD;&#x5012;&#x63D0;&#x9AD8;&#x4E86;&#x3002;&#x8BE5;&#x7279;&#x6027;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>mallopt</code>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;<code>M_MEMTAG_TUNING</code>&#x9009;&#x9879;&#x8FDB;&#x884C;&#x9009;&#x62E9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;int mallopt(M_MEMTAG_TUNING, level)</span><br><span class="line">where level is:</span><br><span class="line">&#x25CF; M_MEMTAG_TUNING_BUFFER_OVERFLOW   &#xFF08;OddEvenMask&#x6253;&#x5F00;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#xFF09;</span><br><span class="line">&#x25CF; M_MEMTAG_TUNING_UAF               &#xFF08;OddEvenMask&#x5173;&#x95ED;&#xFF09;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-Secondary-Allocator"><a href="#1-2-Secondary-Allocator" class="headerlink" title="1.2 Secondary Allocator"></a>1.2 Secondary Allocator</h4><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2879de65a2a25e976ed822bd44cfec6ffc72ef5738ca07d83b7e5e37670d61af" alt="Secondary MTE.png"></p>
<p>Secondary Allocator&#x901A;&#x8FC7;mmap&#x5206;&#x914D;&#x51FA;&#x65B0;&#x7684;vma&#x533A;&#x57DF;&#x3002;&#x4E0A;&#x56FE;&#x4E2D;&#x7684;Content&#x662F;&#x7528;&#x6237;&#x771F;&#x5B9E;&#x6570;&#x636E;&#x5B58;&#x653E;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5B83;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#x662F;&#x6309;&#x9875;&#x5BF9;&#x9F50;&#x7684;&#x3002;&#x8D77;&#x59CB;&#x5730;&#x5740;Ptr&#x524D;&#x9762;&#x5B58;&#x653E;&#x4E24;&#x4E2A;Header&#xFF0C;&#x4E00;&#x4E2A;&#x662F;Chunk Header&#xFF0C;&#x4E0E;Primary Allocator&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;LargeBlock Header&#xFF0C;&#x5C5E;&#x4E8E;Secondary&#x72EC;&#x6709;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x5176;&#x4E2D;&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x524D;&#x540E;vma&#x7684;&#x6307;&#x9488;&#xFF08;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF09;&#x3002;&#x518D;&#x5F80;&#x524D;&#x662F;&#x8865;&#x9F50;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x76F4;&#x8865;&#x9F50;&#x5230;&#x9875;&#x8FB9;&#x754C;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x524D;&#x540E;&#x518D;&#x5404;&#x52A0;&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x4FDD;&#x62A4;&#x9875;&#x3002;</p>
<p>&#x5F53;MTE&#x5F00;&#x542F;&#x540E;&#xFF0C;&#x5206;&#x914D;&#x5668;&#x4E0D;&#x4F1A;&#x4E3A;Content&#x8BBE;&#x7F6E;tag&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x7684;tag&#x4FDD;&#x6301;&#x9ED8;&#x8BA4;&#x503C;0&#x3002;Chunk Header&#x5BF9;&#x5E94;&#x7684;tag&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x503C;2&#xFF0C;LargeBlock Header&#x548C;Padding&#x5BF9;&#x5E94;&#x7684;tag&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x503C;1&#x3002;&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x524D;&#x540E;&#x6EA2;&#x51FA;&#x5747;&#x53EF;&#x88AB;&#x68C0;&#x6D4B;&#xFF1A;</p>
<ul>
<li>&#x7EBF;&#x6027;Overflow&#x4F1A;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7F6E;&#x4E8E;&#x5C3E;&#x90E8;&#x7684;Guard Page&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x76F4;&#x63A5;&#x89E6;&#x53D1;SIGSEGV&#x3002;</li>
<li>&#x7EBF;&#x6027;Underflow&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x5230;Chunk Header/LargeBlock Header/Padding&#xFF0C;&#x7531;&#x4E8E;&#x5176;tag&#x4E0D;&#x4E3A;0&#xFF08;&#x800C;&#x6307;&#x9488;tag&#x4E3A;0&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x4EA7;&#x751F;SIGSEGV&#x7684;&#x9519;&#x8BEF;&#xFF1B;&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x5230;&#x5934;&#x90E8;&#x7684;Guard Page&#xFF0C;&#x5219;&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;SIGSEGV&#x3002;</li>
</ul>
<h4 id="1-3-Short-granules"><a href="#1-3-Short-granules" class="headerlink" title="1.3 Short granules"></a>1.3 Short granules</h4><p>&#x4E0A;&#x9762;&#x7684;&#x8BA8;&#x8BBA;&#x6709;&#x4E2A;&#x524D;&#x63D0;&#xFF0C;&#x5373;&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x662F;16&#x5B57;&#x8282;&#x7684;&#x6574;&#x6570;&#x500D;&#x3002;&#x53EF;&#x662F;&#x5982;&#x679C;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5462;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;char *p = (char *)malloc(88);</span><br><span class="line">*(p + 89) = &apos;n&apos;;</span><br></pre></td></tr></table></figure>

<p>HWASan&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x8FDB;&#x884C;&#x66F4;&#x52A0;&#x7EC6;&#x7C92;&#x5EA6;&#x7684;&#x6EA2;&#x51FA;&#x68C0;&#x6D4B;&#xFF0C;&#x589E;&#x52A0;&#x4E86;short granules&#x7684;&#x7279;&#x6027;&#xFF0C;&#x8BE6;&#x60C5;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href="/external_links/ccdb0c808b75a882fe4b54ff5a8254e3.html" target="blank" rel="noopener">&#x6587;&#x7AE0;</a>&#x3002;&#x56E0;&#x6B64;&#x4E0A;&#x9762;&#x7684;&#x6EA2;&#x51FA;&#x60C5;&#x51B5;&#x53EF;&#x4EE5;&#x88AB;HWASan&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;</p>
<p>&#x4F46;&#x662F;Scudo MTE&#x5374;&#x65E0;&#x6CD5;&#x68C0;&#x6D4B;&#x51FA;&#x8BE5;&#x9519;&#x8BEF;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x5B83;&#x5E76;&#x4E0D;&#x652F;&#x6301;short granules&#x3002;&#x7531;&#x4E8E;tag&#x5728;MTE&#x4E2D;&#x4EC5;&#x7531;4bits&#x6784;&#x6210;&#xFF0C;&#x6240;&#x4EE5;&#x652F;&#x6301;short granules&#x4F1A;&#x6781;&#x5927;&#x7684;&#x538B;&#x7F29;tag&#x9009;&#x53D6;&#x8303;&#x56F4;&#xFF0C;&#x4E5F;&#x4F1A;&#x5927;&#x5927;&#x63D0;&#x5347;&#x6F0F;&#x68C0;&#x7387;&#x3002;&#x4E24;&#x5BB3;&#x76F8;&#x6743;&#x53D6;&#x5176;&#x8F7B;&#xFF0C;Google&#x56E2;&#x961F;&#x6700;&#x7EC8;&#x653E;&#x5F03;&#x4E86;&#x5728;MTE&#x4E2D;&#x5BF9;short granules&#x7684;&#x652F;&#x6301;&#x3002;&#x4E0D;&#x8FC7;&#x597D;&#x5728;Scudo&#x5206;&#x914D;&#x51FA;&#x6765;&#x7684;Block&#x90FD;&#x662F;&#x6309;16&#x5B57;&#x8282;&#x5BF9;&#x9F50;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4FBF;&#x53D1;&#x751F;&#x4E86;&#x8FD9;&#x79CD;&#x6EA2;&#x51FA;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x8E29;&#x8E0F;&#x6709;&#x6548;&#x6570;&#x636E;&#x3002;</p>
<h4 id="1-4-&#x5C0F;&#x7ED3;"><a href="#1-4-&#x5C0F;&#x7ED3;" class="headerlink" title="1.4 &#x5C0F;&#x7ED3;"></a>1.4 &#x5C0F;&#x7ED3;</h4><p>Scudo&#x4E2D;&#x7684;MTE&#x76EE;&#x524D;&#x53EA;&#x68C0;&#x6D4B;native&#x5806;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x68C0;&#x6D4B;&#x7684;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x4E3B;&#x8981;&#x4E3A;OOB(Out-of-Bounds&#xFF0C;&#x5305;&#x542B;Underflow&#x548C;Overflow)&#x548C;UAF(Use-After-Free)&#x3002;&#x53E6;&#x5916;&#xFF0C;Scudo&#x672C;&#x8EAB;&#x4E5F;&#x652F;&#x6301;Double-Free&#x7684;&#x68C0;&#x6D4B;&#x3002;</p>
<h3 id="2-&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;"><a href="#2-&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;" class="headerlink" title="2. &#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;"></a>2. &#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;</h3><p>&#xFF08;&#x4E0D;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#xFF0C;&#x7EC6;&#x8282;&#x8F83;&#x591A;&#xFF09;</p>
<p>&#x5F53;MTE&#x8BBE;&#x7F6E;&#x4E3A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x65F6;&#xFF0C;Scudo&#x4F1A;&#x5728;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;&#x5185;&#x5B58;&#x5757;&#x7684;&#x65F6;&#x5019;&#x53BB;&#x8BB0;&#x5F55;&#x5F53;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x5B83;&#x4EEC;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x7531;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6784;&#x6210;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x5728;ARM64&#x4E0A;&#xFF0C;x29&#x5BC4;&#x5B58;&#x5668;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x5E27;&#x6307;&#x9488;FP&#xFF0C;x30&#x5BC4;&#x5B58;&#x5668;&#x53C8;&#x79F0;&#x4E3A;LR&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;&#x5728;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x65F6;&#x90FD;&#x4F1A;&#x5C06;&#x5BC4;&#x5B58;&#x5668;&#x538B;&#x6808;&#xFF0C;&#x7ED3;&#x675F;&#x65F6;&#x51FA;&#x6808;&#x3002;&#x56E0;&#x6B64;&#x6808;&#x4E2D;&#x5C31;&#x4FDD;&#x5B58;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x5E27;&#x6307;&#x9488;&#x548C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x503C;&#x901A;&#x5E38;&#x662F;&#x8FDE;&#x7EED;&#x5B58;&#x653E;&#x7684;&#xFF0C;&#x800C;&#x4E0D;&#x540C;&#x5E27;&#x7684;FP&#x53C8;&#x5448;&#x73B0;&#x51FA;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x56E0;&#x6B64;&#x904D;&#x5386;&#x94FE;&#x8868;&#x4FBF;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E9B;&#x503C;&#x5168;&#x90E8;&#x53D6;&#x51FA;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x79F0;&#x4E3A;&#x57FA;&#x4E8E;FP&#x7684;&#x6808;&#x5E27;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x4F20;&#x7EDF;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#x8981;&#x5FEB;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x884C;&#x7684;&#x524D;&#x63D0;&#x662F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x65F6;&#x5BF9;FP&#x8FDB;&#x884C;&#x538B;&#x6808;&#xFF0C;&#x8BE5;&#x884C;&#x4E3A;&#x53EF;&#x7531;&#x7F16;&#x8BD1;&#x9009;&#x9879;<code>-fomit-frame-pointer</code>&#x548C;<code>-fno-omit-frame-pointer</code>&#x8FDB;&#x884C;&#x63A7;&#x5236;&#x3002;&#x5728;64&#x4F4D;&#x7684;Android&#x4E0A;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x5BF9;FP&#x8FDB;&#x884C;&#x538B;&#x6808;&#xFF0C;&#x56E0;&#x6B64;&#x8BE5;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#x6709;&#x6548;&#x3002;&#x5982;&#x679C;&#x78B0;&#x5230;&#x6CA1;&#x6709;&#x5F00;&#x542F;FP&#x538B;&#x6808;&#x7684;&#x4E09;&#x65B9;&#x5E93;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x867D;&#x7136;&#x4F1A;&#x5931;&#x6548;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x6B7B;&#x5FAA;&#x73AF;&#x6216;&#x5D29;&#x6E83;&#xFF0C;&#x53EA;&#x662F;&#x7F3A;&#x5C11;&#x4E9B;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x4E0D;&#x540C;&#x5E27;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6784;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x5B83;&#x53CD;&#x6620;&#x7684;&#x5C31;&#x662F;&#x5F53;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x4E3A;&#x4E86;&#x63A7;&#x5236;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x6240;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7EC4;&#x6210;&#x7684;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;64&#xFF0C;&#x4E5F;&#x5373;&#x6700;&#x591A;&#x5B58;&#x50A8;64&#x5E27;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x5BF9;&#x4E8E;&#x8C03;&#x8BD5;&#x800C;&#x8A00;&#xFF0C;64&#x5E27;&#x7684;&#x8C03;&#x7528;&#x6808;&#x5DF2;&#x7ECF;&#x8DB3;&#x591F;&#x770B;&#x51FA;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x6BCF;&#x4E2A;&#x8C03;&#x7528;&#x6808;&#x7684;&#x5927;&#x5C0F;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6CD5;&#x521B;&#x5EFA;&#x7EDF;&#x4E00;&#x7684;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x3002;&#x5982;&#x679C;&#x5C06;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x8BBE;&#x4E3A;64&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x8C03;&#x7528;&#x6808;&#x4E0D;&#x8DB3;64&#x5E27;&#x65F6;&#x4F1A;&#x6D6A;&#x8D39;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;&#x6240;&#x4EE5;&#x4E3A;&#x4E86;&#x66F4;&#x9AD8;&#x6548;&#x5730;&#x4F7F;&#x7528;&#x5185;&#x5B58;&#xFF0C;Scudo&#x4E2D;&#x7528;&#x4E00;&#x4E2A;&#x5927;&#x578B;&#x6570;&#x7EC4;&#x5B58;&#x50A8;&#x4E0B;&#x6240;&#x6709;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;&#x8BE5;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x4E3A;524288(1&lt;&lt;19)&#xFF0C;&#x4E0D;&#x540C;&#x8C03;&#x7528;&#x6808;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x95F4;&#x4F1A;&#x63D2;&#x5165;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x8FDB;&#x884C;&#x5206;&#x9694;&#x3002;&#x8FD9;&#x4E2A;&#x7528;&#x4E8E;&#x5206;&#x9694;&#x7684;&#x5143;&#x7D20;&#x79F0;&#x4E3A;&#x201D;stack trace marker&#x201D;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x533A;&#x5206;&#x4E00;&#x4E2A;marker&#x548C;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5462;&#xFF1F;&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x6295;&#x5411;marker&#x7684;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x3002;&#x7531;&#x4E8E;PC&#x503C;&#x5728;64&#x4F4D;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x90FD;&#x662F;&#x6309;4&#x5B57;&#x8282;&#x5BF9;&#x9F50;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x5FC5;&#x7136;&#x4E3A;0&#x3002;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4EBA;&#x4E3A;&#x5730;&#x5C06;marker&#x7684;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x8BBE;&#x4E3A;1&#xFF0C;&#x4EE5;&#x533A;&#x5206;&#x5B83;&#x548C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;marker&#x7684;&#x5177;&#x4F53;&#x542B;&#x4E49;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/06c38ad2c898dd0fd4f41f3e6a8b8f6fb20bbe7805cf97a0548885f18a06e1d3" alt="Stack trace&#x6570;&#x7EC4;.png"></p>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;marker&#x4E2D;&#x7684;1~32bits&#x7528;&#x6765;&#x5B58;&#x50A8;hash&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x503C;&#x7531;&#x8C03;&#x7528;&#x6808;&#x7684;&#x6240;&#x6709;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7ECF;&#x7531;&#x6563;&#x5217;&#x7B97;&#x6CD5;&#x5171;&#x540C;&#x8BA1;&#x7B97;&#x5F97;&#x51FA;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x8C03;&#x7528;&#x6808;&#x7684;&#x7279;&#x6B8A;ID&#x3002;</p>
<p>Primary&#x5728;&#x5206;&#x914D;&#x65F6;&#x5C06;hash&#x503C;&#x5B58;&#x5728;&#x81EA;&#x5DF1;&#x7684;Block&#x4E2D;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;Header&#x540E;&#x9762;&#x539F;&#x672C;&#x7528;&#x4E8E;&#x5BF9;&#x9F50;&#x7684;padding&#x76EE;&#x524D;&#x7528;&#x6765;&#x5B58;&#x50A8;hash&#x503C;&#x3002;Padding&#x603B;&#x957F;&#x5EA6;&#x4E3A;8&#x5B57;&#x8282;&#xFF0C;&#x5176;&#x4E2D;4&#x5B57;&#x8282;&#x5B58;&#x50A8;hash&#x503C;&#xFF0C;&#x53E6;&#x5916;4&#x5B57;&#x8282;&#x5B58;&#x50A8;&#x5206;&#x914D;&#x65F6;&#x7684;&#x7EBF;&#x7A0B;ID&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/bcae1ce7cc8d4b7366c7febffd6f808262863df25e95455b5e9ca75db30c9fdf" alt="stack trace&#x5B58;&#x50A8;.png"></p>
<p>&#x8FD9;&#x91CC;&#x7684;hash&#x503C;&#x76F8;&#x5F53;&#x4E8E;&#x8C03;&#x7528;&#x6808;&#x7684;&#x7279;&#x6B8A;ID&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5B83;&#x6765;&#x5B9A;&#x4F4D;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x5E8F;&#x53F7;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x662F;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x4E00;&#x5C42;tab&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x4E2D;&#x8F6C;&#x3002;&#x56E0;&#x4E3A;hash&#x503C;&#x672C;&#x8EAB;&#x5177;&#x6709;&#x968F;&#x673A;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x76F4;&#x63A5;&#x5C06;&#x5B83;&#x548C;&#x5177;&#x6709;&#x89C4;&#x5F8B;&#x6027;&#x6392;&#x5217;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5173;&#x8054;&#x8D77;&#x6765;&#x3002;</p>
<p>&#x9996;&#x5148;&#x7528;hash&#x503C;&#x6A21;&#x4E0A;65536&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x4E2A;tab&#x6570;&#x7EC4;&#x7684;&#x5E8F;&#x53F7;&#x3002;&#x63A5;&#x7740;&#x53D6;&#x51FA;tab&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x5143;&#x7D20;&#x7684;&#x503C;&#x5373;&#x4E3A;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x7684;&#x5E8F;&#x53F7;&#x3002;&#x901A;&#x5E38;&#x8FD9;&#x4E2A;&#x5E8F;&#x53F7;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x5143;&#x7D20;&#x662F;&#x201D;stack trace marker&#x201D;&#xFF0C;&#x6839;&#x636E;marker&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x8C03;&#x7528;&#x6808;&#x957F;&#x5EA6;&#x4FBF;&#x53EF;&#x4EE5;&#x4F9D;&#x6B21;&#x53D6;&#x51FA;&#x540E;&#x7EED;&#x6240;&#x6709;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;</p>
<p>&#x5F53;&#x521D;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x8BBE;&#x8BA1;&#x65F6;&#x6211;&#x5C31;&#x95EE;&#x81EA;&#x5DF1;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5C06;marker&#x7684;&#x5E8F;&#x53F7;&#x5B58;&#x5728;Block&#x4E2D;&#xFF0C;&#x800C;&#x4E00;&#x5B9A;&#x8981;&#x5B58;hash&#x503C;&#x5462;&#xFF1F;</p>
<p>&#x540E;&#x6765;&#x624D;&#x60F3;&#x660E;&#x767D;&#x539F;&#x56E0;&#x3002;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x88AB;&#x8BBE;&#x8BA1;&#x6210;Ring Buffer&#xFF0C;&#x56E0;&#x6B64;&#x5176;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x88AB;&#x5FAA;&#x73AF;&#x8986;&#x76D6;&#x3002;&#x5982;&#x679C;&#x5C06;marker&#x7684;&#x5E8F;&#x53F7;&#x5B58;&#x5728;Block&#x4E2D;&#xFF0C;&#x5219;&#x5B83;&#x53EF;&#x80FD;&#x53D6;&#x5230;&#x5B8C;&#x5168;&#x4E0D;&#x5C5E;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;&#x800C;&#x91C7;&#x7528;hash&#x503C;&#x5C31;&#x53EF;&#x4EE5;&#x89C4;&#x907F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x62FF;&#x5230;marker&#x540E;&#x53BB;&#x6BD4;&#x5BF9;&#x4E0B;Block&#x4E2D;&#x7684;hash&#x503C;&#x548C;marker&#x4E2D;&#x7684;hash&#x503C;&#x662F;&#x5426;&#x4E00;&#x81F4;&#xFF0C;&#x4E0D;&#x4E00;&#x81F4;&#x5219;&#x8868;&#x660E;&#x81EA;&#x5DF1;&#x539F;&#x6765;&#x7684;&#x8C03;&#x7528;&#x6808;&#x5DF2;&#x7ECF;&#x88AB;&#x8986;&#x76D6;&#x4E86;&#x3002;</p>
<p>tab&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x4E3A;65536&#xFF0C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x4E3A;524288&#x3002;&#x4E8C;&#x8005;&#x76F8;&#x9664;&#x7684;&#x7ED3;&#x679C;&#x4E3A;8&#xFF0C;&#x8868;&#x660E;&#x5982;&#x679C;&#x5E73;&#x5747;&#x8C03;&#x7528;&#x6808;&#x957F;&#x5EA6;&#x5C0F;&#x4E8E;7&#xFF0C;&#x5219;scudo&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x8BB0;&#x5F55;65536&#x4E2A;&#x8C03;&#x7528;&#x6808;&#xFF1B;&#x5982;&#x679C;&#x957F;&#x5EA6;&#x5927;&#x4E8E;7&#xFF0C;&#x5219;scudo&#x6700;&#x591A;&#x53EF;&#x8BB0;&#x5F55;&#x7684;&#x8C03;&#x7528;&#x6808;&#x6570;&#x5C0F;&#x4E8E;65536&#x3002;&#x5F53;&#x8C03;&#x7528;&#x6808;&#x88AB;&#x8986;&#x76D6;&#x540E;&#xFF0C;&#x867D;&#x7136;&#x95EE;&#x9898;&#x4F9D;&#x7136;&#x53EF;&#x4EE5;&#x62A5;&#x51FA;&#x6765;&#xFF0C;&#x4F46;&#x7F3A;&#x5C11;&#x5173;&#x952E;&#x7684;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x540E;&#xFF0C;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x5B9A;&#x4F4D;&#x3002;</p>
<p>&#x5F53;Primary Block&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x4FBF;&#x53EF;&#x4EE5;&#x5206;&#x914D;&#x7ED9;&#x5176;&#x4ED6;&#x4EBA;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x4E4B;&#x524D;&#x5B58;&#x5728;Block&#x4E2D;&#x7684;hash&#x503C;&#x548C;&#x6B64;&#x6B21;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#x90FD;&#x8981;&#x53E6;&#x5B58;&#x4ED6;&#x5904;&#x3002;</p>
<p>&#x4E3A;&#x6B64;scudo&#x4E2D;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x7684;Entry&#x6570;&#x7EC4;&#xFF0C;&#x957F;&#x5EA6;&#x4E3A;32768&#x3002;Entry&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x7684;AllocationTrace&#x5B58;&#x50A8;&#x7684;&#x662F;&#x5206;&#x914D;&#x65F6;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#xFF0C;DeallocationTrace&#x5B58;&#x50A8;&#x7684;&#x662F;&#x91CA;&#x653E;&#x65F6;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#x3002;&#x5F53;Primary Block&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x5B83;&#x9996;&#x5148;&#x4F1A;&#x53D6;&#x51FA;&#x5B58;&#x5728;Block&#x4E2D;&#x7684;&#x5206;&#x914D;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#xFF0C;&#x5C06;&#x5B83;&#x5B58;&#x5230;Entry&#x7684;AllocationTrace&#x5B57;&#x6BB5;&#x4E2D;&#xFF0C;&#x4E4B;&#x540E;&#x5C06;&#x662F;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;hash&#x503C;&#x5B58;&#x5230;Entry&#x7684;DeallocationTrace&#x4E2D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;  struct AllocationRingBuffer {</span><br><span class="line">    struct Entry {</span><br><span class="line">      atomic_uptr Ptr;</span><br><span class="line">      atomic_uptr AllocationSize;</span><br><span class="line">      atomic_u32 AllocationTrace;</span><br><span class="line">      atomic_u32 AllocationTid;</span><br><span class="line">      atomic_u32 DeallocationTrace;</span><br><span class="line">      atomic_u32 DeallocationTid;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    atomic_uptr Pos;</span><br><span class="line">#ifdef SCUDO_FUZZ</span><br><span class="line">    static const uptr NumEntries = 2;</span><br><span class="line">#else</span><br><span class="line">    static const uptr NumEntries = 32768;</span><br><span class="line">#endif</span><br><span class="line">    Entry Entries[NumEntries];</span><br><span class="line">  };</span><br><span class="line">  AllocationRingBuffer RingBuffer;</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x5916;&#xFF0C;Entry&#x6570;&#x7EC4;&#x4E0D;&#x5355;&#x7528;&#x4E8E;&#x5B58;&#x50A8;Primary Block&#x91CA;&#x653E;&#x540E;&#x7684;hash&#x503C;&#xFF0C;&#x8FD8;&#x7528;&#x4E8E;&#x5B58;&#x50A8;Secondary Block&#x7684;hash&#x503C;&#xFF0C;&#x4E0D;&#x8BBA;&#x5176;&#x662F;&#x5426;&#x91CA;&#x653E;&#x3002;&#x5F53;&#x521D;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x8111;&#x4E2D;&#x53C8;&#x51FA;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;Secondary&#x548C;Primary&#x5728;&#x5904;&#x7406;&#x672A;&#x91CA;&#x653E;Block&#x7684;hash&#x503C;&#x65F6;&#x505A;&#x6CD5;&#x4E0D;&#x4E00;&#x81F4;&#xFF1F;</p>
<p>&#x539F;&#x56E0;&#x662F;Primary Allocator&#x548C;Secondary Allocator&#x5BF9;&#x4E8E;&#x5176;&#x4E2D;Block&#x7684;&#x7BA1;&#x7406;&#x65B9;&#x5F0F;&#x4E0D;&#x540C;&#x3002;Primary&#x4E2D;&#x7684;Block&#x662F;&#x7EBF;&#x6027;&#x6392;&#x5217;&#xFF0C;&#x800C;Secondary&#x91CC;&#x7684;Block&#x662F;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x3002;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x904D;&#x5386;&#x7684;&#x65B9;&#x5F0F;&#x5BFB;&#x627E;&#x5230;Secondary&#x91CC;&#x7684;&#x76EE;&#x6807;Block&#xFF0C;&#x4F46;&#x662F;&#x9700;&#x8981;&#x5728;&#x904D;&#x5386;&#x8FC7;&#x7A0B;&#x4E2D;&#x589E;&#x52A0;&#x5F88;&#x591A;&#x5BF9;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x7684;&#x62F7;&#x8D1D;&#x64CD;&#x4F5C;&#x3002;&#x800C;&#x5982;&#x679C;&#x5C06;Secondary&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x5168;&#x90E8;&#x5B58;&#x5728;Entries&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x5728;&#x6536;&#x96C6;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x524D;&#x5C06;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x62F7;&#x8D1D;&#x4E00;&#x6B21;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x8BA8;&#x8BBA;&#x5B8C;&#x4E86;&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x8C03;&#x7528;&#x6808;&#x7684;&#x6062;&#x590D;&#x662F;&#x600E;&#x4E48;&#x8FDB;&#x884C;&#x7684;&#x5462;&#xFF1F;</p>
<ol>
<li>&#x6839;&#x636E;PC&#x503C;&#x5728;memory maps&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;elf&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x6839;&#x636E;elf&#x6587;&#x4EF6;&#x4E2D;&#x7684;symbols&#x4FE1;&#x606F;&#xFF0C;&#x67E5;&#x8BE2;&#x8BE5;PC&#x503C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x6267;&#x884C;&#x8303;&#x56F4;&#x3002;</li>
<li>Demangle&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x5F97;&#x5230;&#x66F4;&#x5177;&#x53EF;&#x8BFB;&#x6027;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;</li>
</ol>
<p>&#x6839;&#x636E;&#x4E0A;&#x8FF0;&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#x4F1A;&#x4E22;&#x5931;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<ol>
<li>&#x5F53;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x5728;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x524D;&#x88AB;&#x5378;&#x8F7D;&#xFF0C;&#x90A3;&#x4E48;&#x90A3;&#x4E00;&#x5E27;&#x6700;&#x7EC8;&#x5C31;&#x4F1A;&#x663E;&#x793A;<code>&lt;unknown&gt;</code>&#x3002;</li>
<li>&#x5F53;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x901A;&#x8FC7;<code>-fvisibility=hidden</code>&#x7684;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#x6765;&#x5173;&#x95ED;&#x7B26;&#x53F7;&#x8868;&#x7684;&#x8F93;&#x51FA;&#x65F6;(&#x5546;&#x4E1A;APK)&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x65E0;&#x6CD5;&#x5224;&#x65AD;PC&#x503C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x90A3;&#x4E00;&#x5E27;&#x53EA;&#x4F1A;&#x6253;&#x5370;so&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x51FD;&#x6570;&#x540D;&#x3002;</li>
</ol>
<h3 id="3-&#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;"><a href="#3-&#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;" class="headerlink" title="3. &#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;"></a>3. &#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;</h3><p>&#x5F53;MTE&#x8BBE;&#x7F6E;&#x4E3A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x65F6;&#xFF0C;scudo&#x4E0D;&#x4EC5;&#x4F1A;&#x8F93;&#x51FA;&#x76F8;&#x5E94;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x8FD8;&#x4F1A;&#x8F93;&#x51FA;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x8B6C;&#x5982;&#x662F;&#x6EA2;&#x51FA;&#x95EE;&#x9898;&#x8FD8;&#x662F;UAF&#x7684;&#x95EE;&#x9898;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x79CD;&#x5224;&#x65AD;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x53C2;&#x8003;&#xFF08;&#x6709;&#x6982;&#x7387;&#x53D1;&#x751F;&#x8BEF;&#x5224;&#xFF09;&#xFF0C;&#x800C;&#x5E76;&#x975E;&#x91D1;&#x6807;&#x51C6;&#x3002;</p>
<p>&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x91C7;&#x7528;<code>debuggerd_signal_handler</code>&#x4F5C;&#x4E3A;SIGSEGV&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;&#x5904;&#x7406;&#x65F6;&#x4F1A;fork&#x51FA;&#x4E00;&#x4E2A;crash_dump&#x8FDB;&#x7A0B;&#xFF0C;&#x7528;&#x4E8E;&#x6536;&#x96C6;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E0E;&#x6B64;&#x540C;&#x65F6;&#x5B83;&#x4E5F;&#x4F1A;&#x901A;&#x8FC7;<code>__scudo_get_error_info</code>&#x6536;&#x96C6;&#x66F4;&#x591A;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x5728;<code>getErrorInfo</code>&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4F1A;&#x540C;&#x65F6;&#x6536;&#x96C6;&#x8C03;&#x7528;&#x6808;&#x548C;&#x9519;&#x8BEF;&#x539F;&#x56E0;&#x3002;&#x9996;&#x5148;&#x4F1A;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x7684;tag&#x662F;&#x5426;&#x4E3A;0&#x6765;&#x51B3;&#x5B9A;&#x8981;&#x4E0D;&#x8981;&#x505A;<code>getInlineErrorInfo</code>&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;Primary&#x5206;&#x914D;&#x7684;&#x6307;&#x9488;tag&#x975E;0&#xFF0C;&#x800C;Secondary&#x5206;&#x914D;&#x7684;&#x6307;&#x9488;tag&#x4E3A;0&#x3002;<code>getInlineErrorInfo</code>&#x662F;&#x4ECE;Block&#x4E2D;&#x83B7;&#x53D6;hash&#x503C;&#x7684;&#xFF0C;&#x800C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x53EA;&#x5BF9;Primary&#x6709;&#x6548;&#x3002;</p>
<p>&#x6982;&#x62EC;&#x5730;&#x8BF4;&#xFF0C;<code>getInlineErrorInfo</code>&#x7528;&#x4E8E;&#x8F93;&#x51FA;Primary OOB&#x95EE;&#x9898;&#xFF0C;&#x6536;&#x96C6;&#x5F53;&#x521D;&#x5206;&#x914D;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;<code>getRingBufferErrorInfo</code>&#x7528;&#x4E8E;&#x8F93;&#x51FA;Primary UAF&#x3001;Secondary OOB&#x548C;Secondary UAF&#x95EE;&#x9898;&#xFF0C;&#x5176;&#x4E2D;UAF&#x95EE;&#x9898;&#x65E2;&#x6536;&#x96C6;&#x5F53;&#x521D;&#x5206;&#x914D;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E5F;&#x6536;&#x96C6;&#x4E0A;&#x4E00;&#x6B21;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;static void getErrorInfo(struct scudo_error_info *ErrorInfo,</span><br><span class="line">                         uintptr_t FaultAddr, const char *DepotPtr,</span><br><span class="line">                         const char *RegionInfoPtr, const char *RingBufferPtr,</span><br><span class="line">                         const char *Memory, const char *MemoryTags,</span><br><span class="line">                         uintptr_t MemoryAddr, size_t MemorySize) {</span><br><span class="line">  *ErrorInfo = {};</span><br><span class="line">  if (!allocatorSupportsMemoryTagging&lt;Params&gt;() ||</span><br><span class="line">      MemoryAddr + MemorySize &lt; MemoryAddr)</span><br><span class="line">    return;</span><br><span class="line"></span><br><span class="line">  auto *Depot = reinterpret_cast&lt;const StackDepot *&gt;(DepotPtr);</span><br><span class="line">  size_t NextErrorReport = 0;</span><br><span class="line"></span><br><span class="line">  // Check for OOB in the current block and the two surrounding blocks. Beyond</span><br><span class="line">  // that, UAF is more likely.</span><br><span class="line">  if (extractTag(FaultAddr) != 0)</span><br><span class="line">    getInlineErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                       RegionInfoPtr, Memory, MemoryTags, MemoryAddr,</span><br><span class="line">                       MemorySize, 0, 2);</span><br><span class="line"></span><br><span class="line">  // Check the ring buffer. For primary allocations this will only find UAF;</span><br><span class="line">  // for secondary allocations we can find either UAF or OOB.</span><br><span class="line">  getRingBufferErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                         RingBufferPtr);</span><br><span class="line"></span><br><span class="line">  // Check for OOB in the 28 blocks surrounding the 3 we checked earlier.</span><br><span class="line">  // Beyond that we are likely to hit false positives.</span><br><span class="line">  if (extractTag(FaultAddr) != 0)</span><br><span class="line">    getInlineErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                       RegionInfoPtr, Memory, MemoryTags, MemoryAddr,</span><br><span class="line">                       MemorySize, 2, 16);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6536;&#x96C6;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x901A;&#x8FC7;<code>ErrorInfo</code>&#xFF08;&#x7C7B;&#x578B;&#x4E3A;scudo_error_info&#xFF09;&#x5B58;&#x50A8;&#xFF0C;&#x5B83;&#x91CC;&#x9762;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5B9A;&#x957F;&#x4E3A;3&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x8868;&#x660E;&#x53EF;&#x4EE5;&#x4E3A;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x5224;&#x5B9A;&#x6700;&#x591A;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x3002;&#x8FD9;&#x79CD;&#x5224;&#x65AD;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x53C2;&#x8003;&#xFF0C;&#x800C;&#x5E76;&#x975E;&#x91D1;&#x6807;&#x51C6;&#x3002;&#x8B6C;&#x5982;&#x4E00;&#x4E2A;UAF&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x68C0;&#x67E5;&#x5B83;&#x4E24;&#x4FA7;&#x7684;Block&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x73B0;&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;tag&#x4E00;&#x6837;&#x7684;Block&#xFF0C;&#x8FD9;&#x6837;&#x8BE5;&#x95EE;&#x9898;&#x4E5F;&#x53EF;&#x4EE5;&#x88AB;&#x5224;&#x5B9A;&#x4E3A;OOB&#x7684;&#x95EE;&#x9898;&#x3002;&#x81F3;&#x4E8E;&#x5177;&#x4F53;&#x662F;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#xFF0C;&#x8FD8;&#x9700;&#x4F7F;&#x7528;&#x8005;&#x7ED3;&#x5408;&#x8C03;&#x7528;&#x6808;&#x81EA;&#x5DF1;&#x53BB;&#x5224;&#x65AD;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;struct scudo_error_info {</span><br><span class="line">  struct scudo_error_report reports[3];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">struct scudo_error_report {</span><br><span class="line">  enum scudo_error_type error_type;</span><br><span class="line"></span><br><span class="line">  uintptr_t allocation_address;</span><br><span class="line">  uintptr_t allocation_size;</span><br><span class="line"></span><br><span class="line">  uint32_t allocation_tid;</span><br><span class="line">  uintptr_t allocation_trace[64];</span><br><span class="line"></span><br><span class="line">  uint32_t deallocation_tid;</span><br><span class="line">  uintptr_t deallocation_trace[64];</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<h2 id="&#x4F7F;&#x7528;&#x65B9;&#x6CD5;"><a href="#&#x4F7F;&#x7528;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4F7F;&#x7528;&#x65B9;&#x6CD5;"></a>&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</h2><p>Android&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x79CD;&#x65B9;&#x5F0F;&#x6765;&#x5F00;&#x542F;MTE&#x3002;&#x4E4D;&#x4E00;&#x770B;&#x5F88;&#x5BB9;&#x6613;&#x8FF7;&#x7CCA;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x4E86;&#x89E3;&#x6BCF;&#x79CD;&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x7528;&#x8D77;&#x6765;&#x4FBF;&#x4F1A;&#x5F97;&#x5FC3;&#x5E94;&#x624B;&#x7684;&#x591A;&#x3002;</p>
<p>&#x4ECE;&#x5927;&#x7684;&#x65B9;&#x5411;&#x4E0A;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;</p>
<ol>
<li>&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>
<li>&#x7CFB;&#x7EDF;Property</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>
<li>&#x7F16;&#x8BD1;&#x9009;&#x9879;</li>
<li>&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;</li>
<li>&#x8FD0;&#x884C;&#x65F6;API</li>
</ol>
<p>&#x63A5;&#x4E0B;&#x6765;&#x4F9D;&#x6B21;&#x4ECB;&#x7ECD;&#x3002;</p>
<h3 id="1-&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"><a href="#1-&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;" class="headerlink" title="1. &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"></a>1. &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</h3><blockquote>
<p>MEMTAG_OPTIONS=(off|sync|async)</p>
</blockquote>
<p>&#x8BE5;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x68C0;&#x6D4B;&#x8FC7;&#x7A0B;&#x53D1;&#x751F;&#x5728;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x91CD;&#x5B9A;&#x4F4D;&#x4E4B;&#x524D;&#xFF0C;&#x662F;&#x7531;linker&#x53D1;&#x8D77;&#x7684;&#x3002;&#x56E0;&#x6B64;&#x4E00;&#x65E6;&#x8BE5;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8BBE;&#x4E3A;sync&#x6216;async&#xFF0C;&#x90A3;&#x4E48;&#x4E4B;&#x540E;&#x521B;&#x5EFA;&#x7684;&#x4EFB;&#x4F55;native&#x8FDB;&#x7A0B;&#x90FD;&#x5C06;&#x5F00;&#x542F;MTE&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;Android&#x5E94;&#x7528;&#x8FDB;&#x7A0B;(Java&#x8FDB;&#x7A0B;)&#x5E76;&#x4E0D;&#x4F1A;&#x53D7;&#x5230;&#x8FD9;&#x4E2A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x5F71;&#x54CD;&#xFF1A;&#x56E0;&#x4E3A;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7531;zygote fork&#x800C;&#x6765;&#xFF0C;&#x800C;&#x975E;&#x901A;&#x8FC7;<code>exec</code>&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x65B9;&#x5F0F;&#x6253;&#x5F00;&#x3002;</p>
<p>&#x901A;&#x5E38;&#xFF0C;&#x6211;&#x4EEC;&#x5728;/system/core/rootdir/init.environ.rc.in&#x4E2D;&#x53BB;&#x589E;&#x52A0;&#x65B0;&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF08;&#x8FD9;&#x6837;&#x4FBF;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF09;&#xFF0C;&#x8B6C;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x6253;&#x5F00;MTE&#x7684;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# set up the global environment</span><br><span class="line">on early-init</span><br><span class="line">+	export MEMTAG_OPTIONS sync (&#x6253;&#x5F00;MTE&#x7684;&#x540C;&#x6B65;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;)</span><br><span class="line">    export ANDROID_BOOTLOGO 1</span><br><span class="line">    export ANDROID_ROOT /system</span><br><span class="line">    export ANDROID_ASSETS /system/app</span><br><span class="line">    export ANDROID_DATA /data</span><br><span class="line">    export ANDROID_STORAGE /storage</span><br><span class="line">    export ANDROID_ART_ROOT /apex/com.android.art</span><br><span class="line">    export ANDROID_I18N_ROOT /apex/com.android.i18n</span><br><span class="line">    export ANDROID_TZDATA_ROOT /apex/com.android.tzdata</span><br><span class="line">    export EXTERNAL_STORAGE /sdcard</span><br><span class="line">    export ASEC_MOUNTPOINT /mnt/asec</span><br><span class="line">    %EXPORT_GLOBAL_ASAN_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_GCOV_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_CLANG_COVERAGE_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_HWASAN_OPTIONS%</span><br></pre></td></tr></table></figure>

<h3 id="2-&#x7CFB;&#x7EDF;Property"><a href="#2-&#x7CFB;&#x7EDF;Property" class="headerlink" title="2. &#x7CFB;&#x7EDF;Property"></a>2. &#x7CFB;&#x7EDF;Property</h3><blockquote>
<p>arm64.memtag.process.<basename> = (off|sync|async)</basename></p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x7684;basename&#x901A;&#x5E38;&#x6307;&#x7684;&#x662F;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x53EA;&#x4F1A;&#x5F71;&#x54CD;native&#x8FDB;&#x7A0B;&#x3002;&#x4E0D;&#x8FC7;&#x6709;&#x4E2A;&#x4F8B;&#x5916;&#x662F;system_server&#xFF0C;&#x56E0;&#x4E3A;forkSystemServer&#x4E2D;&#x4F1A;&#x4E3B;&#x52A8;&#x8BFB;&#x53D6;&#x201D;arm64.memtag.process.system_server&#x201D;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x7684;&#x503C;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#x4F1A;&#x540C;&#x65F6;&#x6253;&#x5F00;/system/bin/ping&#x548C;/data/local/tmp/ping&#x7684;MTE&#x9009;&#x9879;&#xFF0C;&#x4E4B;&#x540E;&#x542F;&#x52A8;&#x7684;ping&#x8FDB;&#x7A0B;&#x90FD;&#x4F1A;&#x5F00;&#x542F;MTE&#x7684;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;$ setprop arm64.memtag.process.ping sync</span><br></pre></td></tr></table></figure>

<h3 id="3-&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"><a href="#3-&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;" class="headerlink" title="3. &#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"></a>3. &#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</h3><blockquote>
<p>SANITIZE_TARGET &amp; SANITIZE_TARGET_DIAG</p>
</blockquote>
<p>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ export SANITIZE_TARGET=memtag_heap</span><br><span class="line">hangl@ubuntu$ m</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ export SANITIZE_TARGET=memtag_heap SANITIZE_TARGET_DIAG=memtag_heap</span><br><span class="line">hangl@ubuntu$ m</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x901A;&#x8FC7;export&#x58F0;&#x660E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x4E4B;&#x540E;&#x901A;&#x8FC7;Android&#x7F16;&#x8BD1;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x5FEB;&#x6377;&#x64CD;&#x4F5C;<code>m</code>&#x6765;&#x7F16;&#x8BD1;&#x6574;&#x4E2A;system image&#x3002;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x9700;&#x8981;&#x540C;&#x65F6;&#x58F0;&#x660E;&#x4E24;&#x4E2A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x540E;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x7684;DIAG&#x610F;&#x5473;&#x7740;<code>diagnostics mode(&#x8BCA;&#x65AD;&#x6A21;&#x5F0F;)</code>&#xFF0C;&#x8FD9;&#x8868;&#x660E;&#x4E0D;&#x5355;&#x5355;&#x8981;&#x68C0;&#x6D4B;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#xFF0C;&#x8FD8;&#x8981;&#x6536;&#x96C6;&#x5C3D;&#x53EF;&#x80FD;&#x591A;&#x7684;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<h3 id="4-&#x7F16;&#x8BD1;&#x9009;&#x9879;"><a href="#4-&#x7F16;&#x8BD1;&#x9009;&#x9879;" class="headerlink" title="4. &#x7F16;&#x8BD1;&#x9009;&#x9879;"></a>4. &#x7F16;&#x8BD1;&#x9009;&#x9879;</h3><blockquote>
<p>memtag_heap</p>
</blockquote>
<p>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;//Android.bp</span><br><span class="line">sanitize: {</span><br><span class="line">    memtag_heap: true,</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;//Android.bp</span><br><span class="line">sanitize: {</span><br><span class="line">    memtag_heap: true,</span><br><span class="line">    diag: {</span><br><span class="line">        memtag_heap: true,</span><br><span class="line">    },</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0D;&#x8BBA;&#x662F;&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8FD8;&#x662F;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x672C;&#x8D28;&#x90FD;&#x662F;&#x5F80;ELF&#x6587;&#x4EF6;&#x4E2D;&#x589E;&#x6DFB;&#x4E00;&#x4E2A;&#x65B0;&#x7684;note section(&#x6CE8;&#x91CA;&#x8282;)&#x3002;&#x8FD9;&#x4E2A;section&#x91CC;&#x7684;&#x5185;&#x5BB9;&#x8BB0;&#x5F55;&#x4E86;MTE&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x4F1A;&#x7531;linker&#x5728;&#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x65F6;&#x8BFB;&#x53D6;&#x3002;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x5C55;&#x793A;&#x7684;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x5C06;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x7684;MTE&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x5B58;&#x5165;note section&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">assembly&#x590D;&#x5236;&#x4EE3;&#x7801;__bionic_asm_custom_note_gnu_section()</span><br><span class="line">  .section &quot;.note.android.memtag&quot;, &quot;a&quot;, %note</span><br><span class="line">  .p2align 2</span><br><span class="line">  .long 1f - 0f         // int32_t namesz</span><br><span class="line">  .long 3f - 2f         // int32_t descsz</span><br><span class="line">  .long NT_TYPE_MEMTAG  // int32_t type</span><br><span class="line">0:</span><br><span class="line">  .asciz &quot;Android&quot;      // char name[]</span><br><span class="line">1:</span><br><span class="line">  .p2align 2</span><br><span class="line">2:</span><br><span class="line">  .long (NT_MEMTAG_LEVEL_ASYNC | NT_MEMTAG_HEAP) // value</span><br><span class="line">3:</span><br><span class="line">  .p2align 2</span><br></pre></td></tr></table></figure>

<p>&#x5B58;&#x5165;ELF&#x6587;&#x4EF6;&#x7684;note&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;llvm-readelf&#x8BFB;&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x4EE5;&#x4E0B;&#x4E3A;&#x793A;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ llvm-readelf --notes app_process64</span><br><span class="line">...</span><br><span class="line">Displaying notes found in: .note.android.memtag</span><br><span class="line">  Owner                Data size        Description</span><br><span class="line">  Android              0x00000004       Unknown note type: (0x00000004)</span><br><span class="line">  description data: 05 00 00 00</span><br></pre></td></tr></table></figure>

<p>&#x540D;&#x79F0;&#x4E3A;&#x201D;.note.android.memtag&#x201D;&#x7684;section&#x662F;&#x6211;&#x4EEC;&#x5173;&#x6CE8;&#x7684;&#x3002;Owner&#x4E3A;&#x201D;Android&#x201D;&#xFF0C;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;Date Size&#x4E3A;4&#xFF0C;&#x8868;&#x793A;description data&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E3A;4&#x5B57;&#x8282;&#xFF1B;Description&#x4E0B;&#x9762;&#x7684;&#x6570;&#x636E;&#x5B9E;&#x8D28;&#x4E0A;&#x662F;Type&#xFF0C;0x4&#x5373;&#x4E3A;NT_TYPE_MEMTAG&#xFF1B;description data&#x624D;&#x662F;MTE&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;0x5&#x8868;&#x793A;(NT_MEMTAG_LEVEL_ASYNC | NT_MEMTAG_HEAP)&#xFF0C;0x6&#x8868;&#x793A;(NT_MEMTAG_LEVEL_SYNC | NT_MEMTAG_HEAP)&#xFF0C;&#x56E0;&#x4E3A;NT_MEMTAG_LEVEL_ASYNC =1&#xFF0C;NT_MEMTAG_LEVEL_SYNC =2&#xFF0C;NT_MEMTAG_HEAP=4&#x3002;</p>
<h3 id="5-&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;"><a href="#5-&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;" class="headerlink" title="5. &#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;"></a>5. &#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;</h3><blockquote>
<p>android:memtagMode=(off|default|sync|async)</p>
</blockquote>
<p>&#x5982;&#x679C;&#x5728;<application>&#x6807;&#x7B7E;&#x4E0B;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x8BE5;&#x5C5E;&#x6027;&#x5BF9;&#x5E94;&#x7528;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x8FDB;&#x7A0B;&#x90FD;&#x751F;&#x6548;&#xFF1B;&#x5982;&#x679C;&#x5728;<process>&#x6807;&#x7B7E;&#x4E0B;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x8BE5;&#x5C5E;&#x6027;&#x4EC5;&#x5BF9;&#x5355;&#x4E2A;&#x8FDB;&#x7A0B;&#x751F;&#x6548;&#xFF0C;&#x4E14;&#x4F1A;&#x8986;&#x76D6;<application>&#x6807;&#x7B7E;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#x3002;</application></process></application></p>
<p>&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x8BE5;&#x914D;&#x7F6E;&#x751F;&#x6548;&#x6709;&#x4E00;&#x4E2A;&#x524D;&#x63D0;&#xFF0C;&#x5373;zygote&#x8FDB;&#x7A0B;&#x7684;MTE&#x5DF2;&#x7ECF;&#x6253;&#x5F00;&#xFF0C;&#x5426;&#x5219;&#x6240;&#x6709;&#x7ECF;&#x7531;zygote fork&#x51FA;&#x6765;&#x7684;&#x8FDB;&#x7A0B;&#x90FD;&#x65E0;&#x6CD5;&#x5F00;&#x542F;MTE&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;application</span><br><span class="line">    ...</span><br><span class="line">    android:memtagMode=&quot;async&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x5F00;&#x53D1;&#x8005;&#x6A21;&#x5F0F;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5728;&#x8BBE;&#x7F6E;&#x9009;&#x9879;&#x4E2D;&#x4FEE;&#x6539;&#x5355;&#x4E2A;&#x5E94;&#x7528;&#x7684;MTE&#x914D;&#x7F6E;&#x3002;</p>
<p>Settings &gt; System &gt; Developer options &gt; App Compatibility Changes&#xFF0C;&#x5176;&#x4E2D;<code>NATIVE_MEMTAG_ASYNC</code>&#x548C;<code>NATIVE_MEMTAG_SYNC</code>&#x7684;&#x9009;&#x9879;&#x4E0E;MTE&#x76F8;&#x5173;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;am&#x6307;&#x4EE4;&#x4E5F;&#x652F;&#x6301;&#x4FEE;&#x6539;MTE&#x914D;&#x7F6E;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;$ adb shell am compat enable NATIVE_MEMTAG_[A]SYNC my.app.name</span><br></pre></td></tr></table></figure>

<h3 id="6-&#x8FD0;&#x884C;&#x65F6;API"><a href="#6-&#x8FD0;&#x884C;&#x65F6;API" class="headerlink" title="6. &#x8FD0;&#x884C;&#x65F6;API"></a>6. &#x8FD0;&#x884C;&#x65F6;API</h3><blockquote>
<p>int mallopt(M_BIONIC_SET_HEAP_TAGGING_LEVEL, level)</p>
</blockquote>
<p>&#x4EE5;&#x4E0A;5&#x79CD;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x5728;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x524D;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x53EF;&#x662F;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5DF2;&#x7ECF;&#x5728;&#x8FD0;&#x884C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x6709;&#x529E;&#x6CD5;&#x6539;&#x53D8;&#x5B83;&#x7684;MTE&#x914D;&#x7F6E;&#x4E48;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x662F;&#x4F7F;&#x7528;mallopt&#x51FD;&#x6570;&#xFF0C;&#x4E0A;&#x8FF0;&#x51FD;&#x6570;&#x4E2D;&#x7684;level&#x53EF;&#x4EE5;&#x4ECE;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x9009;&#x9879;&#x4E2D;&#x9009;&#x62E9;&#x3002;</p>
<ul>
<li>M_HEAP_TAGGING_LEVEL_NONE</li>
<li>M_HEAP_TAGGING_LEVEL_ASYNC</li>
<li>M_HEAP_TAGGING_LEVEL_SYNC</li>
</ul>
<p>&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;API&#x7684;&#x4F7F;&#x7528;&#x6709;&#x4E9B;&#x9650;&#x5236;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x8FDB;&#x7A0B;&#x7684;MTE&#x6A21;&#x5F0F;&#x53EA;&#x80FD;&#x4ECE;&#x5F00;&#x542F;&#x72B6;&#x6001;&#x5207;&#x6362;&#x5230;&#x5173;&#x95ED;&#x72B6;&#x6001;&#xFF0C;&#x800C;&#x65E0;&#x6CD5;&#x9006;&#x5411;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x4E3A;&#x4E2D;&#x9014;&#x5F00;&#x542F;MTE&#x4F1A;&#x5BFC;&#x81F4;&#x5148;&#x524D;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF08;&#x6CA1;&#x6709;&#x751F;&#x6210;tag&#xFF09;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x3002;&#x5177;&#x4F53;&#x7684;&#x9650;&#x5236;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x8FDB;&#x7A0B;&#x5FC5;&#x987B;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x5C31;&#x5DF2;&#x7ECF;&#x5F00;&#x542F;MTE&#x68C0;&#x6D4B;&#x3002;</li>
<li>M_HEAP_TAGGING_LEVEL_SYNC&#x6216;M_HEAP_TAGGING_LEVEL_ASYNC&#x5207;&#x6362;&#x5230;M_HEAP_TAGGING_LEVEL_NONE&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x5411;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x4E00;&#x65E6;&#x5173;&#x95ED;&#xFF0C;&#x65E0;&#x6CD5;&#x518D;&#x6B21;&#x5F00;&#x542F;&#x3002;</li>
</ol>
<p>&#x8FD9;&#x4E2A;API&#x5BF9;&#x4E8E;&#x7EBF;&#x4E0A;&#x5E94;&#x7528;&#x5176;&#x5B9E;&#x6709;&#x7740;&#x633A;&#x5927;&#x7684;&#x5E2E;&#x52A9;&#x3002;&#x5E73;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5BF9;APP&#x5F00;&#x542F;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x7684;&#x68C0;&#x6D4B;&#xFF08;&#x6027;&#x80FD;&#x4F18;&#x5148;&#xFF09;&#xFF0C;&#x4E00;&#x65E6;&#x68C0;&#x6D4B;&#x5230;&#x95EE;&#x9898;&#xFF0C;&#x4FBF;&#x53EF;&#x4EE5;&#x5728;&#x4E0B;&#x6B21;&#x542F;&#x52A8;&#x65F6;&#x5207;&#x6362;&#x5230;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF08;&#x8C03;&#x8BD5;&#x4F18;&#x5148;&#xFF09;&#x3002;</p>
<h3 id="&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;"><a href="#&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;" class="headerlink" title="&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;"></a>&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;</h3><ul>
<li>&#x6700;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF08;&#x5168;&#x5C40;&#x914D;&#x7F6E;&#xFF0C;&#x5BF9;&#x6240;&#x6709;native&#x8FDB;&#x7A0B;&#x751F;&#x6548;&#xFF09;&#xFF0C;&#x4E00;&#x65E6;&#x8BE5;&#x53D8;&#x91CF;&#x8BBE;&#x5B9A;&#x4EE5;&#x540E;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x90FD;&#x4E0D;&#x4F1A;&#x8D77;&#x4F5C;&#x7528;&#x3002;</li>
<li>&#x4E2D;&#x7B49;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x7CFB;&#x7EDF;property&#xFF0C;&#x8BE5;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x4E3A;&#x7279;&#x5B9A;&#x8FDB;&#x7A0B;&#x914D;&#x7F6E;MTE&#x3002;</li>
<li>&#x6700;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x53CA;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#xFF0C;&#x5B83;&#x4EEC;&#x4F1A;&#x5728;ELF&#x6587;&#x4EF6;&#x4E2D;&#x589E;&#x52A0;note section&#xFF0C;&#x4F46;note section&#x7684;&#x68C0;&#x6D4B;&#x53EA;&#x4F1A;&#x53D1;&#x751F;&#x5728;&#x4E0A;&#x9762;&#x4E24;&#x4E2A;&#x65B9;&#x5F0F;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#x3002;</li>
</ul>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x4E0A;&#x8FF0;&#x65B9;&#x5F0F;&#x53EA;&#x4F5C;&#x7528;&#x4E8E;native&#x8FDB;&#x7A0B;&#xFF0C;&#x4E5F;&#x5373;&#x901A;&#x8FC7;exec&#x52A0;&#x8F7D;ELF&#x6587;&#x4EF6;&#x6765;&#x542F;&#x52A8;&#x7684;&#x8FDB;&#x7A0B;&#xFF08;&#x6709;&#x4E00;&#x4E2A;&#x4F8B;&#x5916;&#x662F;system_server&#xFF0C;&#x901A;&#x8FC7;&#x201D;arm64.memtag.process.system_server&#x201D;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x63A7;&#x5236;&#xFF09;&#x3002;</p>
<p>APP&#x7531;zygote fork&#x51FA;&#x6765;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x8D70;ELF&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5B50;&#x8FDB;&#x7A0B;fork&#x51FA;&#x6765;&#x540E;&#xFF0C;&#x4F1A;&#x6267;&#x884C;<code>SpecializeCommon</code>&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;mallopt&#x5BF9;MTE&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;mallopt(M_BIONIC_SET_HEAP_TAGGING_LEVEL, heap_tagging_level);</span><br></pre></td></tr></table></figure>

<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;heap_tagging_level&#x7684;&#x503C;&#x4E3A;<code>M_HEAP_TAGGING_LEVEL_NONE</code>&#x3002;&#x5F53;Manifest&#x6216;Compatibility Changes&#x4E2D;&#x5F00;&#x542F;&#x4E86;MTE&#x540E;&#xFF0C;heap_tagging_level&#x7684;&#x503C;&#x4FBF;&#x4F1A;&#x53D1;&#x751F;&#x66F4;&#x6539;&#x3002;</p>
<h2 id="&#x6848;&#x4F8B;&#x89E3;&#x6790;"><a href="#&#x6848;&#x4F8B;&#x89E3;&#x6790;" class="headerlink" title="&#x6848;&#x4F8B;&#x89E3;&#x6790;"></a>&#x6848;&#x4F8B;&#x89E3;&#x6790;</h2><p>&#x5F53;MTE&#x68C0;&#x6D4B;&#x5230;&#x95EE;&#x9898;&#x540E;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x8FDB;&#x7A0B;&#x7684;tombstone&#x6587;&#x4EF6;&#xFF0C;&#x4E0B;&#x9762;&#x7ED9;&#x51FA;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">Build fingerprint: xxxx</span><br><span class="line">Revision: &apos;0&apos;</span><br><span class="line">ABI: &apos;arm64&apos;</span><br><span class="line">Timestamp: 1970-01-01 00:36:59.185340333+0000</span><br><span class="line">pid: 3304, tid: 3304, name: main  &gt;&gt;&gt; zygote64 &lt;&lt;&lt;</span><br><span class="line">uid: 0</span><br><span class="line">tagged_addr_ctrl: 000000000007fff3</span><br><span class="line">signal 11 (SIGSEGV), code 9 (SEGV_MTESERR), fault addr 0x800007c6c70f600</span><br><span class="line">    x0  0000000000000025  x1  0800007c6c70f5e9  x2  0000000000084000  x3  0000000000000000</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">backtrace:</span><br><span class="line">      #00 pc 000000000009cc38  /apex/com.android.runtime/lib64/bionic/libc.so (__openat+8)</span><br><span class="line">      #01 pc 000000000005b234  /apex/com.android.runtime/lib64/bionic/libc.so (__open_2+76)</span><br><span class="line">      ...</span><br><span class="line">Note: multiple potential causes for this crash were detected, listing them in decreasing order of probability.</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Underflow, 128 bytes left of a 96-byte allocation at 0x7c6c70f680  // 0x680 -0x600 = 128(0x80) bytes.</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 0000000000044204  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_malloc+36)</span><br><span class="line">      #02 pc 000000000003ec7c  /apex/com.android.runtime/lib64/bionic/libc.so (malloc+36)</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Overflow, 0 bytes right of a 96-byte allocation at 0x7c6c70f5a0  // 0x600 - 0x5a0 = 0x60(96) bytes</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 0000000000044204  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_malloc+36)</span><br><span class="line">      #02 pc 000000000003ec7c  /apex/com.android.runtime/lib64/bionic/libc.so (malloc+36)</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Underflow, 1696 bytes left of a 88-byte allocation at 0x7c6c70fca0  //0xca0 - 0x600 = 1696 bytes</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 00000000000445ac  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::reallocate(void*, unsigned long, unsigned long)+248) </span><br><span class="line">      #02 pc 0000000000044450  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_realloc+36)</span><br><span class="line">      #03 pc 000000000003ef48  /apex/com.android.runtime/lib64/bionic/libc.so (realloc+84)</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x662F;MTE&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x4E0B;&#x8F93;&#x51FA;&#x7684;tombstone&#x4FE1;&#x606F;&#xFF0C;<code>tagged_addr_ctrl</code>&#x4E2D;&#x8BB0;&#x5F55;&#x4E86;&#x4E09;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/20aa4667057e03e040ec707c36ef2273ffb7eccfefc6f153c460c5b01728863b" alt="tag_ctrl.jpg"></p>
<ul>
<li>&#x6700;&#x4F4E;&#x4F4D;&#x4E3A;1&#x8868;&#x793A;MTE&#x68C0;&#x6D4B;&#x529F;&#x80FD;&#x6253;&#x5F00;&#x3002;</li>
<li>1~2bits<code>01</code>&#x610F;&#x5473;&#x7740;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#x4E3A;&#x540C;&#x6B65;&#xFF0C;<code>10</code>&#x610F;&#x5473;&#x7740;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#x4E3A;&#x5F02;&#x6B65;&#x3002;</li>
<li>3~18bits&#x8BB0;&#x5F55;&#x4E86;tag&#x9009;&#x53D6;&#x7684;&#x8303;&#x56F4;&#xFF0C;<code>1111111111111110</code>&#x610F;&#x5473;&#x7740;tag&#x4E0D;&#x9009;&#x62E9;0&#x3002;</li>
</ul>
<p>&#x56E0;&#x6B64;<code>0x7fff3</code>&#x8868;&#x793A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x6253;&#x5F00;&#xFF0C;&#x4E14;tag&#x4E0D;&#x9009;&#x62E9;0&#x3002;</p>
<p>Code <code>SEGV_MTESERR</code>&#x8868;&#x793A;synchronous&#xFF0C;<code>SEGV_MTEAERR</code>&#x8868;&#x793A;asynchronous&#x3002;</p>
<p>Backtrace&#x6807;&#x7B7E;&#x4E0B;&#x8BB0;&#x5F55;&#x4E86;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x4E09;&#x4E2A;Cause&#x5206;&#x522B;&#x8BB0;&#x5F55;&#x4E86;&#x9519;&#x8BEF;&#x7684;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x3002;OOB&#x95EE;&#x9898;&#x7684;&#x68C0;&#x6D4B;&#x7531;&#x8FD1;&#x53CA;&#x8FDC;&#xFF0C;&#x4E14;&#x5148;Underflow&#xFF0C;&#x540E;Overflow&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x6BD4;&#x5BF9;&#xFF0C;&#x4E0B;&#x9762;&#x7701;&#x7565;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x76F4;&#x63A5;&#x5C06;&#x4E09;&#x4E2A;Cause&#x7F57;&#x5217;&#x5728;&#x4E00;&#x8D77;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;Cause: [MTE]: Buffer Underflow, 128 bytes left of a 96-byte allocation at 0x7c6c70f680  // 0x680 -0x600 = 128(0x80) bytes.</span><br><span class="line">Cause: [MTE]: Buffer Overflow, 0 bytes right of a 96-byte allocation at 0x7c6c70f5a0  // 0x600 - 0x5a0 = 0x60(96) bytes</span><br><span class="line">Cause: [MTE]: Buffer Underflow, 1696 bytes left of a 88-byte allocation at 0x7c6c70fca0  //0xca0 - 0x600 = 1696 bytes</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/983590e546e9dce111a96cf075bfc6c3fb72dc2baa734264d93953a2256d3567" alt="&#x6848;&#x4F8B;.png"></p>
<p>&#x9519;&#x8BEF;&#x5730;&#x5740;&#x6307;&#x5411;&#x7684;Block&#x5C5E;&#x4E8E;Class 6&#x7684;region&#xFF0C;&#x5176;&#x4E2D;&#x6BCF;&#x4E2A;Block&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x4E3A;112&#x5B57;&#x8282;(8&#x5B57;&#x8282;Header+8&#x5B57;&#x8282;Padding+96&#x5B57;&#x8282;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;)&#x3002;&#x4E0D;&#x8FC7;96&#x5B57;&#x8282;&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5E76;&#x4E0D;&#x610F;&#x5473;&#x7740;&#x5B8C;&#x5168;&#x4F7F;&#x7528;&#xFF0C;&#x8B6C;&#x5982;&#x53EF;&#x4EE5;&#x53EA;&#x4F7F;&#x7528;88&#x5B57;&#x8282;&#xFF0C;&#x5269;&#x4E0B;8&#x5B57;&#x8282;unused&#x3002;</p>
<p>&#x68C0;&#x6D4B;&#x65F6;&#x5148;&#x53BB;&#x5BFB;&#x627E;&#x9519;&#x8BEF;Block&#x53F3;&#x8FB9;&#x7684;Block&#xFF0C;&#x53D1;&#x73B0;&#x53F3;&#x8FB9;&#x7B2C;&#x4E00;&#x4E2A;Block&#x7684;tag&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x56E0;&#x6B64;&#x5224;&#x5B9A;&#x4E3A;Buffer Underflow&#x3002;&#x201D;128 bytes left of a 96-byte allocation at 0x7c6c70f680&#x201D;&#xFF0C;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x548C;&#x53F3;&#x8FB9;Block&#x7684;&#x5934;&#x90E8;&#x5730;&#x5740;&#x4E4B;&#x95F4;&#x76F8;&#x5DEE;128bytes&#xFF0C;&#x800C;&#x53F3;&#x8FB9;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E3A;96bytes&#x3002;</p>
<p>&#x63A5;&#x7740;&#x67E5;&#x770B;&#x5DE6;&#x8FB9;&#x7B2C;&#x4E00;&#x4E2A;Block&#xFF0C;&#x53D1;&#x73B0;tag&#x4E5F;&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x56E0;&#x6B64;&#x5224;&#x5B9A;&#x4E3A;Buffer Overflow&#x3002;&#x201D;0 bytes right of a 96-byte allocation at 0x7c6c70f5a0&#x201D;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x521A;&#x597D;&#x7B49;&#x4E8E;&#x5DE6;&#x8FB9;Block&#x7684;&#x5C3E;&#x90E8;&#x5730;&#x5740;&#xFF0C;&#x4E14;&#x5DE6;&#x8FB9;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E5F;&#x4E3A;96bytes&#x3002;</p>
<p>&#x5DE6;&#x53F3;&#x5404;&#x5224;&#x5B9A;&#x6700;&#x591A;15&#x4E2A;Block&#xFF0C;&#x5224;&#x65AD;&#x5230;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x65F6;&#xFF0C;&#x53D1;&#x73B0;&#x5B83;&#x7684;tag&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x7684;tag&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x7B2C;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x5224;&#x65AD;&#x4E3A;Underflow&#x3002;&#x201D;1696 bytes left of a 88-byte allocation at 0x7c6c70fca0&#x201D;&#xFF0C;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x8DDD;&#x79BB;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x7684;&#x5934;&#x90E8;&#x6709;1696bytes&#x7684;&#x8DDD;&#x79BB;&#xFF0C;&#x4E14;&#x8BE5;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E3A;88bytes&#x3002;(1696+88)/112=16&#xFF0C;&#x7531;&#x4E8E;&#x672C;&#x8EAB;Block&#x5360;&#x636E;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#xFF0C;&#x56E0;&#x6B64;&#x521A;&#x597D;&#x662F;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x3002;</p>
<p>&#x63A5;&#x7740;&#x7ED3;&#x5408;&#x6BCF;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x5224;&#x5B9A;Overflow&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6B21;&#x9519;&#x8BEF;&#x7684;&#x771F;&#x5B9E;&#x539F;&#x56E0;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x6808;&#x548C;&#x9519;&#x8BEF;&#x8C03;&#x7528;&#x6808;&#x90FD;&#x548C;<code>Gralloc2Mapper</code>&#x7684;<code>preload</code>&#x6709;&#x5173;&#x3002;</p>
<h2 id="&#x540E;&#x8BB0;"><a href="#&#x540E;&#x8BB0;" class="headerlink" title="&#x540E;&#x8BB0;"></a>&#x540E;&#x8BB0;</h2><p>&#x968F;&#x7740;Android S(12)&#x7684;&#x6B63;&#x5F0F;&#x53D1;&#x5E03;&#xFF0C;&#x4F30;&#x8BA1;&#x4F1A;&#x6709;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#x7684;&#x4EBA;&#x542C;&#x5230;MTE&#x3002;&#x6240;&#x4EE5;&#x6211;&#x5C31;&#x60F3;&#x7740;&#x5199;&#x4E00;&#x7BC7;&#x5C3D;&#x53EF;&#x80FD;&#x8BE6;&#x7EC6;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x66F4;&#x6DF1;&#x5165;&#x5730;&#x4E86;&#x89E3;&#x5B83;&#x3001;&#x4F7F;&#x7528;&#x5B83;&#x3002;&#x53E6;&#x5916;&#x5728;&#x7814;&#x7A76;&#x6E90;&#x7801;&#x65F6;&#xFF0C;&#x6211;&#x4E5F;&#x53D1;&#x73B0;&#x4E86;scudo MTE&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x5C0F;&#x7455;&#x75B5;&#xFF0C;&#x7ED9;Google&#x63D0;&#x4E86;3&#x4E2A;bug&#x548C;2&#x4E2A;&#x5EFA;&#x8BAE;&#xFF0C;&#x5E78;&#x8FD0;&#x7684;&#x662F;&#x90FD;&#x88AB;&#x91C7;&#x7EB3;&#x4E86;&#xFF0C;&#x4E5F;&#x7B97;&#x4E3A;&#x5F00;&#x6E90;&#x793E;&#x533A;&#x505A;&#x4E9B;&#x8D21;&#x732E;&#x3002;</p>
<p>&#x4E0D;&#x77E5;&#x4E0D;&#x89C9;&#xFF0C;&#x672C;&#x6587;&#x5DF2;&#x8FC7;&#x4E07;&#x5B57;&#xFF0C;&#x4F46;&#x5176;&#x4E2D;&#x80AF;&#x5B9A;&#x8FD8;&#x6709;&#x4E0D;&#x5C11;&#x7EC6;&#x8282;&#x6CA1;&#x6709;&#x63A8;&#x6572;&#x5230;&#x4F4D;&#xFF0C;&#x5E0C;&#x671B;&#x5404;&#x4F4D;&#x670B;&#x53CB;&#x53D1;&#x73B0;&#x4E4B;&#x540E;&#x5E2E;&#x5FD9;&#x6307;&#x6B63;&#xFF0C;&#x591A;&#x8C22;&#x591A;&#x8C22;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/4e3064d15534abc3317644d4f375d6d2.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7013253613971570718.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7013253613971570718.html" itemprop="url">Elastic Stack (二)   核心概念-倒排索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-29T15:27:32+08:00">
                2021-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><h1 id="&#x5012;&#x6392;&#x7D22;&#x5F15;&#x539F;&#x7406;"><a href="#&#x5012;&#x6392;&#x7D22;&#x5F15;&#x539F;&#x7406;" class="headerlink" title="&#x5012;&#x6392;&#x7D22;&#x5F15;&#x539F;&#x7406;"></a>&#x5012;&#x6392;&#x7D22;&#x5F15;&#x539F;&#x7406;</h1></li>
</ol>
<p>&#x5047;&#x8BBE;&#x4E00;&#x4E2A;&#x7535;&#x5546;&#x7F51;&#x7AD9;,&#x5173;&#x4E8E;&#x624B;&#x673A;&#x6709;&#x5982;&#x4E0B;&#x6570;&#x636E;(&#x6570;&#x636E;&#x91CF;&#x4E3A;10&#x4EBF;&#x6761;):</p>
<table>
<thead>
<tr>
<th>id</th>
<th>product</th>
<th>describe</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>&#x65B0;&#x6B3E;&#x5C0F;&#x7C73;&#x81F3;&#x5C0A;-&#x7EAA;&#x5FF5;&#x7248;&#x624B;&#x673A;</td>
<td>&#x624B;&#x673A;&#x4E2D;&#x7684;&#x6218;&#x6597;&#x673A;</td>
</tr>
<tr>
<td>2</td>
<td>&#x65B0;&#x6B3E;&#x5C0F;&#x7C73;&#x5168;&#x529F;&#x80FD;NFC&#x624B;&#x673A;</td>
<td>&#x5C0F;&#x7C73;&#x624B;&#x673A;,&#x652F;&#x6301;&#x5168;&#x529F;&#x80FD;NFC,&#x624B;&#x673A;&#x4E2D;&#x7684;&#x6218;&#x6597;&#x673A;</td>
</tr>
<tr>
<td>3</td>
<td>&#x7EA2;&#x7C73;&#x624B;&#x673A;</td>
<td>&#x72C2;&#x62FD;&#x9177;&#x70AB;&#x540A;&#x70B8;&#x5929;</td>
</tr>
<tr>
<td>&#x2026;</td>
<td>&#x2026;</td>
<td>&#x2026;</td>
</tr>
<tr>
<td>100000000</td>
<td>&#x2026;</td>
<td>&#x2026;</td>
</tr>
</tbody></table>
<p>&#x5F53;&#x7528;&#x6237;&#x8D2D;&#x4E70;&#x624B;&#x673A;&#x65F6;,&#x4F1A;&#x6839;&#x636E;&#x9700;&#x6C42;&#x5173;&#x952E;&#x5B57;&#x8FDB;&#x884C;&#x641C;&#x7D22;. &#x5982;&#x7528;&#x6237;&#x5E0C;&#x671B;&#x8D2D;&#x4E70;&#x4E00;&#x53F0;: <strong>&#x5C0F;&#x7C73;&#x6709;NFC&#x529F;&#x80FD;&#x7684;&#x624B;&#x673A;</strong><br>&#x90A3;&#x4E48;&#x5728;&#x641C;&#x7D22;&#x662F;&#x7528;&#x6237;&#x641C;&#x7D22;&#x5173;&#x952E;&#x5B57;: <strong>&#x5C0F;&#x7C73;NFC&#x624B;&#x673A;</strong></p>
<p><strong>&#x8BE5;&#x5982;&#x600E;&#x4E48;&#x505A;&#x624D;&#x80FD;&#x591F;&#x51C6;&#x786E;&#x5FEB;&#x901F;&#x7684;&#x5C06;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x5462;?</strong></p>
<p>&#x5047;&#x8BBE;&#x4E0A;&#x9762;&#x624B;&#x673A;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x65F6;&#x5B58;&#x50A8;&#x5728;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x4E2D;(&#x4EE5;Mysql&#x4E3A;&#x4F8B;), &#x90A3;&#x4E48;SQL&#x8BED;&#x53E5;&#x4E3A;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&#x590D;&#x5236;&#x4EE3;&#x7801;select * from table where product like &quot;%&#x5C0F;&#x7C73;NFC&#x624B;&#x673A;%&quot;</span><br></pre></td></tr></table></figure>

<p>&#x8BE5;&#x65B9;&#x6848;&#x5982;&#x4E0B;&#x5B58;&#x5728;&#x95EE;&#x9898;:</p>
<ol>
<li>&#x8868;&#x4E2D;&#x6709;10&#x4EBF;&#x6761;&#x6570;&#x636E;, &#x5982;&#x679C;&#x4E0D;&#x5BF9; product &#x5217;&#x521B;&#x5EFA;&#x7D22;&#x5F15;,&#x4F1A;&#x9020;&#x6210;SQL&#x5168;&#x8868;&#x626B;&#x63CF;, &#x8BE5;SQL&#x7684;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x4F1A;&#x975E;&#x5E38;&#x957F;;</li>
<li>&#x5982;&#x679C;&#x5BF9; product &#x5217;&#x521B;&#x5EFA;&#x7D22;&#x5F15;, &#x90A3;&#x4E48;&#x56E0;&#x4E3A; product &#x5217;&#x6570;&#x636E;&#x6BD4;&#x8F83;&#x957F;, &#x5BFC;&#x81F4;&#x6570;&#x636E;&#x5E93;&#x7D22;&#x5F15; B+ &#x6811;&#x7684;&#x6DF1;&#x5EA6;&#x4F1A;&#x975E;&#x5E38;&#x6DF1;, &#x67E5;&#x8BE2;&#x65F6;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;&#x8282;&#x70B9;&#x589E;&#x591A;, &#x968F;&#x673A; I/O &#x53D8;&#x591A;, &#x67E5;&#x8BE2;&#x65F6;&#x95F4;&#x4E5F;&#x975E;&#x5E38;&#x957F;.</li>
<li>&#x800C;&#x4E14;&#x5373;&#x4F7F; produc t&#x5217;&#x521B;&#x5EFA;&#x4E86;&#x7D22;&#x5F15;, &#x4E0A;&#x9762;&#x7684; SQL &#x6761;&#x4EF6;&#x4E3A; &#x201C;%&#x5C0F;&#x7C73;NFC&#x624B;&#x673A;%&#x201D;, &#x5750;&#x4FA7;&#x7684; &#x201C;%&#x201D; &#x4E5F;&#x4F1A;&#x5BFC;&#x81F4;&#x7D22;&#x5F15;&#x5931;&#x6548;,&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x7D22;&#x5F15;,&#x8FD8;&#x662F;&#x5168;&#x8868;&#x626B;&#x63CF;</li>
<li>&#x6839;&#x636E;&#x8868;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x53EF;&#x77E5;, &#x6CA1;&#x6709;&#x5339;&#x914D; &#x201C;%&#x5C0F;&#x7C73;NFC&#x624B;&#x673A;%&#x201D; &#x7684;&#x6570;&#x636E;, &#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x4E3A;&#x7A7A;. &#x5B58;&#x5728;&#x67E5;&#x8BE2;&#x7CBE;&#x5EA6;&#x5DEE;&#x7684;&#x95EE;&#x9898;.</li>
</ol>
<p>&#x7EFC;&#x5408;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#x53EF;&#x77E5;,&#x4F7F;&#x7528; RDB &#x4F5C;&#x4E3A;&#x8BE5;&#x573A;&#x666F;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;,&#x5B58;&#x5728;: <strong>&#x65F6;&#x95F4;&#x957F;,&#x7CBE;&#x5EA6;&#x5DEE;</strong> &#x7684;&#x95EE;&#x9898;</p>
<p><strong>&#x2014;&#x2014;&#x2014;-Elasticsearch(Lucene) &#x5E26;&#x7740;&#x5012;&#x6392;&#x7D22;&#x5F15;&#x6765;&#x62EF;&#x6551;&#x4E16;&#x754C;&#x4E86;!!!&#x2014;&#x2014;&#x2014;&#x2014;-</strong></p>
<p>elasticsearch &#x5982;&#x679C;&#x7EC4;&#x7EC7;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x5462;?<br>&#x9996;&#x5148; elasticsearch &#x4F1A;&#x5C06;&#x5185;&#x5BB9;&#x8FDB;&#x884C;&#x5206;&#x8BCD;, &#x540C;&#x65F6;&#x8BB0;&#x5F55;&#x8BE5;&#x8BCD;&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;ID.&#x5206;&#x8BCD;&#x540E;&#x7ED3;&#x679C;&#x5982;&#x4E0B;</p>
<table>
<thead>
<tr>
<th>&#x5173;&#x952E;&#x8BCD;</th>
<th>&#x5305;&#x542B;&#x8BE5;&#x5173;&#x952E;&#x8BCD;&#x7684;&#x6570;&#x636E;ID</th>
</tr>
</thead>
<tbody><tr>
<td>&#x65B0;&#x6B3E;</td>
<td>1, 2</td>
</tr>
<tr>
<td>&#x5C0F;&#x7C73;</td>
<td>1, 2</td>
</tr>
<tr>
<td>&#x81F3;&#x5C0A;</td>
<td>1</td>
</tr>
<tr>
<td>&#x7EAA;&#x5FF5;&#x7248;</td>
<td>1</td>
</tr>
<tr>
<td>&#x624B;&#x673A;</td>
<td>1, 2, 3</td>
</tr>
<tr>
<td>&#x5168;&#x529F;&#x80FD;</td>
<td>2</td>
</tr>
<tr>
<td>NFC</td>
<td>2</td>
</tr>
<tr>
<td>&#x7EA2;&#x7C73;</td>
<td>3</td>
</tr>
</tbody></table>
<p>&#x5F53;&#x7528;&#x6237;&#x641C;&#x7D22;&#x641C;&#x7D22; &#x201C;&#x5C0F;&#x7C73;NFC&#x624B;&#x673A;&#x201D; &#x65F6;, &#x6267;&#x884C;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;:</p>
<ol>
<li>&#x5BF9;&#x641C;&#x7D22;&#x8BED;&#x53E5;&#x8FDB;&#x884C;&#x5206;&#x8BCD;: &#x201C;&#x5C0F;&#x7C73;&#x201D;, &#x201C;NFC&#x201D;, &#x201C;&#x624B;&#x673A;&#x201D;.</li>
<li>&#x4F9D;&#x6B21;&#x67E5;&#x8BE2;&#x6BCF;&#x4E2A;&#x5206;&#x8BCD;, &#x67E5;&#x8BE2;&#x7684;&#x7ED3;&#x679C;&#x4E3A;<ul>
<li><strong>&#x5C0F;&#x7C73;</strong> &#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;ID&#x4E3A; <strong>[ 1, 2 ]</strong></li>
<li><strong>NFC</strong> &#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;ID&#x4E3A; <strong>[ 2 ]</strong></li>
<li><strong>&#x624B;&#x673A;</strong> &#x5BF9;&#x7528;&#x7684;&#x6570;&#x636E;ID&#x4E3A; <strong>[1, 2, 3]</strong></li>
</ul>
</li>
<li>&#x5BF9;&#x6839;&#x636E;&#x7B2C;2&#x6B65;&#x7684;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x6C47;&#x603B;: &#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;ID &#x4E3A; 1, 2, 3</li>
<li>&#x6839;&#x636E;&#x7B2C;2&#x6B65;&#x7684;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;,&#x5BF9;&#x7ED3;&#x679C;&#x6392;&#x5E8F;:<ul>
<li>ID &#x4E3A; 2 &#x7684;&#x6570;&#x636E;&#x51FA;&#x73B0;3&#x6B21;(&#x5339;&#x914D;: &#x5C0F;&#x7C73;, NFC, &#x624B;&#x673A;), &#x5339;&#x914D;&#x5EA6;&#x6700;&#x9AD8;, &#x6392;&#x5728;&#x7B2C;&#x4E00;&#x4F4D;</li>
<li>ID &#x4E3A; 1 &#x7684;&#x6570;&#x636E;&#x51FA;&#x73B0;2&#x6B21;(&#x5339;&#x914D;: &#x5C0F;&#x7C73;, NFC), &#x6392;&#x5728;&#x7B2C;&#x4E8C;&#x4F4D;</li>
<li>ID &#x4E3A; 3 &#x7684;&#x6570;&#x636E;&#x51FA;&#x73B0;1&#x6B21;(&#x5339;&#x914D;: &#x624B;&#x673A;), &#x6392;&#x5728;&#x7B2C;&#x4E09;&#x4F4D;</li>
</ul>
</li>
<li>&#x8FD4;&#x56DE;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;</li>
</ol>
<p><strong>&#x6570;&#x636E;&#x7684;&#x8FD9;&#x79CD;&#x7EC4;&#x7EC7;&#x5F62;&#x5F0F;&#x65E2;&#x4E3A;&#x5012;&#x6392;&#x7D22;&#x5F15;.</strong></p>
<ol start="2">
<li><h1 id="&#x5012;&#x6392;&#x7D22;&#x5F15;&#x7ED3;&#x6784;"><a href="#&#x5012;&#x6392;&#x7D22;&#x5F15;&#x7ED3;&#x6784;" class="headerlink" title="&#x5012;&#x6392;&#x7D22;&#x5F15;&#x7ED3;&#x6784;"></a>&#x5012;&#x6392;&#x7D22;&#x5F15;&#x7ED3;&#x6784;</h1></li>
</ol>
<p>&#x5728;elasticsearch&#x4E2D;,&#x5012;&#x6392;&#x7D22;&#x5F15;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x5982;&#x4E0B;:</p>
<table>
<thead>
<tr>
<th>term index(&#x8BCD;&#x9879;&#x7D22;&#x5F15;)</th>
<th>term dictionary(&#x8BCD;&#x9879;&#x5B57;&#x5178;)</th>
<th>&#x5012;&#x6392;&#x8868;(posting list)</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>&#x65B0;&#x6B3E;</td>
<td>1, 2</td>
</tr>
<tr>
<td></td>
<td>&#x5C0F;&#x7C73;</td>
<td>1, 2</td>
</tr>
<tr>
<td></td>
<td>&#x81F3;&#x5C0A;</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td>&#x7EAA;&#x5FF5;&#x7248;</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td>&#x624B;&#x673A;</td>
<td>1, 2, 3</td>
</tr>
<tr>
<td></td>
<td>&#x5168;&#x529F;&#x80FD;</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>NFC</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>&#x7EA2;&#x7C73;</td>
<td>3</td>
</tr>
</tbody></table>
<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/a7b70115746b008cd9284e93968723a2e3c2a5b2aa89afd7d77341da089910fa" alt="image.png"></p>
<h1 id="3-&#x5012;&#x6392;&#x7D22;&#x5F15;&#x6838;&#x5FC3;&#x7B97;&#x6CD5;"><a href="#3-&#x5012;&#x6392;&#x7D22;&#x5F15;&#x6838;&#x5FC3;&#x7B97;&#x6CD5;" class="headerlink" title="3 &#x5012;&#x6392;&#x7D22;&#x5F15;&#x6838;&#x5FC3;&#x7B97;&#x6CD5;"></a>3 &#x5012;&#x6392;&#x7D22;&#x5F15;&#x6838;&#x5FC3;&#x7B97;&#x6CD5;</h1><h2 id="3-1-&#x5012;&#x6392;&#x8868;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;"><a href="#3-1-&#x5012;&#x6392;&#x8868;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;" class="headerlink" title="3.1 &#x5012;&#x6392;&#x8868;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;"></a>3.1 &#x5012;&#x6392;&#x8868;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;</h2><p>&#x5012;&#x6392;&#x8868;(posting list)&#x5B58;&#x50A8;&#x7684;&#x4E3A;&#x5305;&#x542B;&#x8BE5;&#x5173;&#x952E;&#x5B57;&#x7684;&#x6240;&#x6709;&#x6570;&#x636E;&#x7684;ID,&#x4E14;&#x6709;&#x5E8F;&#x6392;&#x5217;. &#x8BD5;&#x60F3;&#x4E0B;&#x5982;&#x679C;&#x5305;&#x542B;&#x8BE5;&#x5173;&#x952E;&#x5B57;&#x7684;&#x6570;&#x636E;&#x975E;&#x5E38;&#x591A;,&#x5047;&#x8BBE;&#x8FBE;&#x5230;100&#x4E07;&#x6761;, &#x7531;&#x4E8E; posting list &#x4E3A; int &#x6570;&#x7EC4;, &#x90A3;&#x4E48;&#x8FD9;100&#x4E07;&#x7684;&#x6570;&#x636E;&#x6240;&#x9700;&#x8981;&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E3A;:</p>
<blockquote>
<p>100W * 4 Byte = 400W (Byte) &#x2248; 4 (MB)<br>elasticsearch &#x652F;&#x6301; PB &#x7EA7;&#x6570;&#x636E;, &#x90A3;&#x4E48; posting list &#x6240;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x5C06;&#x975E;&#x5E38;&#x7684;&#x5927;, &#x90A3;&#x4E48;&#x5BF9;&#x8BE5;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x538B;&#x7F29;&#x5B58;&#x50A8;&#x5C31;&#x53D8;&#x7684;&#x975E;&#x5E38;&#x5FC5;&#x8981;.<br>&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x597D;&#x7684;&#x538B;&#x7F29;&#x7B97;&#x6CD5;, &#x505A;&#x5230;&#x538B;&#x7F29;&#x6548;&#x7387;&#x9AD8;&#x4EE5;&#x53CA;&#x5FEB;&#x901F;&#x7684;&#x7F16;&#x7801;&#x548C;&#x89E3;&#x7801;&#x901F;&#x5EA6;. elasticsearch &#x652F;&#x6301;&#x4E24;&#x79CD;&#x538B;&#x7F29;&#x7B97;&#x6CD5;: <strong>FOR</strong> &#x548C; <strong>RBM</strong></p>
</blockquote>
<h3 id="3-1-1-FOR&#xFF1A;Frame-Of-Reference"><a href="#3-1-1-FOR&#xFF1A;Frame-Of-Reference" class="headerlink" title="3.1.1 FOR&#xFF1A;Frame Of Reference"></a>3.1.1 FOR&#xFF1A;Frame Of Reference</h3><p>&#x5047;&#x8BBE;posting list &#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x90FD;&#x662F;&#x8FDE;&#x7EED;&#x7684;&#x503C;, &#x65E2;: <strong>[1,2,3,4,5&#x2026;100w]</strong>, &#x90A3;&#x4E48;&#x5982;&#x679C;&#x6BCF;&#x4E2A;&#x90FD;&#x4EE5; int (4 Byte)&#x5B58;&#x50A8;, &#x90A3;&#x4E48;100W&#x7684;&#x6570;&#x636E;&#x6240;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A;:</p>
<blockquote>
<p>100W * 4 Byte = 400W (Byte) &#x2248; 4 (MB)</p>
</blockquote>
<p><strong>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x8FDB;&#x5165; FOR &#x7B97;&#x6CD5;&#x539F;&#x7406;&#x88C5;&#x903C;&#x65F6;&#x95F4;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</strong></p>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6BCF;&#x9879;&#x53EA;&#x5B58;&#x50A8;&#x5176;&#x4E0E;&#x524D;&#x4E00;&#x9879;&#x7684;&#x5DEE;&#x503C;, &#x65E2;:</p>
<blockquote>
<p>posting list[n] = value(n) - value(n-1)</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x8FD9; 100W &#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5F62;&#x5F0F;&#x5C31;&#x6210;&#x4E86;: <strong>[1,1,1,1,1&#x2026;&#x2026;1]</strong>, &#x65E2; 100W &#x4E2A; 1, &#x800C; <strong>1 &#x53EA;&#x9700;&#x8981; 1&#x4E2A;bit&#x5C31;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;, &#x4E4B;&#x524D;&#x4E00;&#x4E2A;ID&#x9700;&#x8981;4 Byte(32 bit)&#x5B58;&#x50A8;,&#x73B0;&#x5728; 1 bit &#x5C31;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;, &#x7A7A;&#x95F4;&#x8282;&#x7701; 32 &#x500D;</strong>.<br>100W &#x6240;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x5C31;&#x662F;:</p>
<blockquote>
<p>100W * 1 bit = 100W bit = 125000 Byte &#x2248; 0.125M</p>
</blockquote>
<p><strong>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x8FDB;&#x5165; FOR &#x7B97;&#x6CD5;&#x5B9E;&#x9645;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#x5206;&#x6790;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</strong></p>
<p>&#x4E0A;&#x9762;&#x6240;&#x5047;&#x8BBE;&#x7684;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x7406;&#x60F3;&#x60C5;&#x51B5;,&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#x90FD;&#x8FDE;&#x7EED;. &#x4E0B;&#x9762;&#x4EE5;&#x4E00;&#x7EC4;&#x4E0D;&#x8FDE;&#x7EED;&#x7684;&#x6570;&#x636E;&#x5206;&#x6790; FOR&#x7B97;&#x6CD5;&#x7684;&#x5B58;&#x50A8;&#x5F62;&#x5F0F;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;posting list:</span><br><span class="line">[73, 300, 302, 332, 343, 372]  =&gt; &#x7A7A;&#x95F4;&#x4E3A; 6 * 4(Byte) = 24(Byte)</span><br><span class="line"></span><br><span class="line">&#x5DEE;&#x503C;&#x6570;&#x7EC4;&#x4E3A;:</span><br><span class="line">[73, 227, 2, 30, 11, 29]  =&gt; &#x5DEE;&#x503C;&#x7684;&#x6700;&#x5927;&#x6570;&#x636E;&#x4E3A;227, &#x9700;&#x8981;8&#x4E2A;bit(2^8=256 &gt; 227)&#x5B58;&#x50A8;,&#x90A3;&#x4E48;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#x90FD;&#x4F7F;&#x7528;8bit&#x5B58;&#x50A8;, &#x9700;&#x8981;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A; 8 * 6(bit) =  48(bit) = 6(Byte)</span><br><span class="line"></span><br><span class="line">&#x4E0A;&#x9762;&#x7684;&#x6570;&#x636E;&#x8FD8;&#x53EF;&#x4EE5;&#x4F18;&#x5316;: &#x6570;&#x7EC4;&#x4E2D;227 &#x9700;&#x8981; 8bit&#x5B58;&#x50A8;, &#x4F46;&#x662F; 2 &#x53EA;&#x9700;&#x8981; 2bit &#x5B58;&#x50A8;,&#x5982;&#x679C;2&#x4E5F;&#x7528;8bit&#x5B58;&#x50A8;,&#x4E25;&#x91CD;&#x6D6A;&#x8D39;&#x7A7A;&#x95F4;, SO &#x4E0D;&#x8981;&#x61C8;&#x6020;,&#x7EE7;&#x7EED;&#x4F18;&#x5316;...</span><br><span class="line"></span><br><span class="line">&#x5C06;&#x4E0A;&#x9762;&#x7684;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x62C6;&#x5206;:</span><br><span class="line">[73, 227] =&gt; &#x6700;&#x5927;&#x503C;227, &#x9700;&#x8981;8bit&#x5B58;&#x50A8;, &#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A; 2*8bit = 16 bit</span><br><span class="line">[2, 30, 11, 29] =&gt; &#x6700;&#x5927;&#x503C;30, &#x9700;&#x8981;5bit&#x5B58;&#x50A8;, &#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A; 4*5bit = 20 bit.</span><br><span class="line"></span><br><span class="line">&#x5C06;&#x6570;&#x7EC4;&#x62C6;&#x5206;&#x4E3A;&#x4E24;&#x7EC4;, &#x7B2C;&#x4E00;&#x7EC4;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x53EA;&#x7528; 8bit&#x5B58;&#x50A8;, &#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x7EC4;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5360;&#x7528; 5bit &#x5B58;&#x50A8;, &#x90A3;&#x4E48;&#x89E3;&#x538B;&#x7684;&#x65F6;&#x5019;&#x5982;&#x4F55;&#x77E5;&#x9053;&#x5462;? </span><br><span class="line">FOR&#x7B97;&#x6CD5;&#x91C7;&#x7528;&#x7684;&#x65B9;&#x5F0F;&#x4E3A;&#x5728;&#x6BCF;&#x4E2A;&#x6570;&#x7EC4;&#x5934;&#x53E6;&#x5916;&#x7528; 1Byte(8bit)&#x5B58;&#x50A8;&#x672C;&#x6570;&#x7EC4;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;. &#x90A3;&#x4E48;&#x7EFC;&#x4E0A;&#x6240;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A;:</span><br><span class="line"></span><br><span class="line">  1 Byte(&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x5934;) + 16bit(2Byte)(&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x6570;&#x636E;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;) + 1 Byte(&#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x7EC4;&#x5934;) + 20bit(3Byte, &#x5728;&#x8BA1;&#x7B97;&#x673A;&#x4E2D;&#x6570;&#x636E;&#x4EE5; Byte&#x4E3A;&#x6700;&#x5C0F;&#x5355;&#x4F4D;, 20bit &#x5B9E;&#x9645;&#x5360;&#x7528;&#x4E86; 3Byte&#x7684;&#x7A7A;&#x95F4;)</span><br><span class="line">= [1Byte + 2Byte](&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x5360;&#x7528;&#x7A7A;&#x95F4;) + [1Byte + 3Byte](&#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x7EC4;&#x5360;&#x7528;&#x7A7A;&#x95F4;)</span><br><span class="line">= 7Byte(&#x8FD8;&#x4E0D;&#x5982;&#x4E0D;&#x4F18;&#x5316;-_-, &#x4E0D;&#x4F18;&#x5316;&#x53EA;&#x5360;&#x7528;6Byte)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/ebf2cbead570d4b0257567d504ec3f9aea880f9db7b06b0529dc71fd3a6ad187" alt="image.png"></p>
<h3 id="3-1-2-RBM&#xFF1A;RoaringBitmap"><a href="#3-1-2-RBM&#xFF1A;RoaringBitmap" class="headerlink" title="3.1.2 RBM&#xFF1A;RoaringBitmap"></a>3.1.2 RBM&#xFF1A;RoaringBitmap</h3><p>FOR&#x7B97;&#x6CD5;&#x7684;&#x601D;&#x60F3;&#x662F;&#x524D;&#x540E;&#x4E24;&#x4E2A;&#x6570;&#x636E;&#x7684;&#x5DEE;&#x503C;&#x6BD4;&#x8F83;&#x5C0F;(&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x6BD4;&#x8F83;&#x5C0F;),&#x6765;&#x8FBE;&#x5230;&#x8282;&#x7701;&#x7A7A;&#x95F4;&#x7684;&#x76EE;&#x7684;,&#x4F46;&#x662F;&#x5982;&#x679C;&#x6570;&#x7EC4;&#x7684;&#x76F8;&#x90BB;&#x9879;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x503C;&#x4E5F;&#x975E;&#x5E38;&#x5927;&#x65F6;, &#x6240;&#x8FBE;&#x5230;&#x7684;&#x4F18;&#x5316;&#x6548;&#x679C;&#x5C31;&#x4E0D;&#x592A;&#x660E;&#x663E;.&#x6B64;&#x65F6;&#x5C31;&#x9700;&#x8981; RBM &#x51FA;&#x6765;&#x6551;&#x573A;&#x2026;</p>
<p><strong>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x8FDB;&#x5165; RBM &#x7B97;&#x6CD5;&#x539F;&#x7406;&#x88C5;&#x903C;&#x65F6;&#x95F4;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</strong></p>
<p>&#x5047;&#x8BBE;&#x5982;&#x4E0B;&#x6570;&#x7EC4;:</p>
<p>[1000, 62101, 131385, 132052, 191173, 196658]</p>
<p>&#x7531;&#x4E8E;postlist&#x4E3A;int&#x7C7B;&#x578B;&#x7684;&#x6709;&#x5E8F;&#x6570;&#x7EC4;, int&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A; 4Byte(32bit). &#x90A3;&#x4E48;&#x5C06;&#x4E0A;&#x9762;&#x7684;<strong>&#x6570;&#x636E;&#x62C6;&#x5206;&#x4E3A;&#x9AD8;16bit&#x548C;&#x5E95;16bit</strong>, &#x4EE5;&#x4E0A;&#x9762;&#x6570;&#x7EC4;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x6570;&#x5B57;196658&#x4E3A;&#x4F8B;:</p>
<blockquote>
<p>196658 =&gt; &#x4E8C;&#x8FDB;&#x5236;&#x4E3A;: 0000 0000 0000 0011 0000 0000 0011 0010</p>
<p>&#x9AD8;16&#x4E3A;&#x4E3A;: 0000 0000 0000 0011 =&gt; &#x8F6C;&#x6362;&#x4E3A;&#x5341;&#x8FDB;&#x5236;&#x4E3A; 3</p>
<p>&#x5E95;16&#x4F4D;&#x4E3A;: 0000 0000 0011 0010 =&gt; &#x8F6C;&#x6362;&#x4E3A;&#x5341;&#x8FDB;&#x5236;&#x4E3A; 50</p>
<p>&#x7D22;&#x5F15;196658 &#x53EF;&#x4EE5;&#x7528; (3, 50) &#x8868;&#x793A;</p>
</blockquote>
<p>&#x62C6;&#x5206;&#x7ED3;&#x679C;&#x4E3A;:</p>
<p>[(0, 1000), (0, 62101), (2, 313), (2, 980), (2, 60101), (3, 50)]</p>
<p>&#x90A3;&#x4E48;<strong>&#x5C06;&#x8BE5;&#x6570;&#x7EC4;&#x8F6C;&#x6362;&#x4E3A; map&#x7C7B;&#x578B;, key&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x5B57;(&#x9AD8;16&#x4F4D;), value&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x5B57;(&#x5E95;16&#x4F4D;)</strong>, &#x8F6C;&#x6362;&#x7ED3;&#x679C;&#x4E3A;:</p>
<blockquote>
<p>key = 0 -&gt; value = [1000, 62101]</p>
<p>key = 2 -&gt; value = [313, 980, 60101]</p>
<p>key = 3 -&gt; value = [50]</p>
</blockquote>
<p>value&#x4E3A;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x6570;&#x636E;&#x7684;&#x4F4E;16&#x4F4D;&#x7684;&#x6570;&#x7EC4;, &#x65E2;&#x4E00;&#x4E2A;short&#x6570;&#x7EC4;(short&#x7C7B;&#x578B;&#x4E3A; 2 Byte = 16 bit). value&#x5728; elasticsearch&#x4E2D;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#x6709;&#x4E09;&#x79CD;:</p>
<ul>
<li>ArrayContainer</li>
<li>BitmapContainer</li>
<li>RunContainer</li>
</ul>
<h4 id="3-1-2-1-ArrayContainer"><a href="#3-1-2-1-ArrayContainer" class="headerlink" title="3.1.2.1 ArrayContainer"></a>3.1.2.1 ArrayContainer</h4><p>&#x89C1;&#x540D;&#x77E5;&#x610F;, value&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x91C7;&#x7528;&#x4E00;&#x4E2A; short &#x5B58;&#x50A8;, &#x65E2;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5360;&#x7528; 16bit(2Byte). value&#x4E3A;&#x4E00;&#x4E2A;short&#x6570;&#x7EC4;:</p>
<p>&#x65E2; value = short[n]</p>
<blockquote>
<p>&#x5047;&#x8BBE;value&#x4E2D;&#x6570;&#x636E;&#x603B;&#x6570;&#x4E3A; n, &#x90A3;&#x4E48;&#x6240;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4E3A;:</p>
<p>f(n) = 2 * n (Byte)</p>
</blockquote>
<h4 id="3-1-2-2-BitMapContainer"><a href="#3-1-2-2-BitMapContainer" class="headerlink" title="3.1.2.2 BitMapContainer"></a>3.1.2.2 BitMapContainer</h4><p>BitMap&#x539F;&#x7406;: <a href="/external_links/030263f2170d9da0bb5f3e178c792b30.html" target="blank" rel="noopener">www.cnblogs.com/cjsblog/p/1&#x2026;</a></p>
<p>BitMap&#x7684;&#x539F;&#x7406;&#x4E3A;&#x5C06;&#x6240;&#x6709;&#x7684;&#x7A7A;&#x95F4;&#x89C6;&#x4E3A;&#x4E00;&#x4E2A; bit &#x6570;&#x7EC4;, &#x5728;&#x8FD9;&#x4E2A; bit&#x6570;&#x7EC4;&#x4E2D;, &#x7B2C;&#x4E00;&#x4F4D;&#x4EE3;&#x8868; 1, &#x7B2C;&#x4E8C;&#x4F4D;&#x4EE3;&#x8868;2 &#x2026; &#x7B2C; N &#x4F4D;&#x4EE3;&#x8868; N.</p>
<p>&#x56E0;&#x4E3A;value&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x4E3A;&#x6570;&#x636E;&#x7684;&#x4F4E;16&#x4F4D;, 16&#x4F4D;&#x6240;&#x80FD;&#x8868;&#x8FBE;&#x7684;&#x6700;&#x5927;&#x6570;&#x5B57;&#x4E3A;: 2^16 = 65535, &#x65E2;value&#x4E2D;&#x53EF;&#x80FD;&#x51FA;&#x73B0; 0 ~ 65535. &#x90A3;&#x4E48;&#x4F7F;&#x7528; BitMap&#x5B58;&#x50A8;&#x53EA;&#x9700;&#x8981;: <strong>65536 &#x4E2A; bit&#x5373;&#x53EF;&#x5B58;&#x50A8;(0~65535&#x5171; 65536&#x4E2A;&#x6570;&#x5B57;, &#x56E0;&#x4E3A;0&#x4E5F;&#x7B97;)</strong>.</p>
<blockquote>
<p>65536 bit = 8192 Byte = 8 KB</p>
</blockquote>
<h4 id="3-1-2-3-RunContainer"><a href="#3-1-2-3-RunContainer" class="headerlink" title="3.1.2.3 RunContainer"></a>3.1.2.3 RunContainer</h4><p>RunContainer&#x7528;&#x4E8E;&#x5904;&#x7406;&#x4E00;&#x7EC4;&#x7279;&#x6B8A;&#x60C5;&#x51B5;&#x7684;&#x6570;&#x636E;, &#x5047;&#x8BBE;&#x6570;&#x7EC4;&#x4E2D;&#x7684;<strong>&#x6570;&#x636E;&#x8FDE;&#x7EED;</strong>: 1, 2, 3, 4 &#x2026; 100W.<br>&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; 2Byte &#x5B58;&#x50A8;:</p>
<ul>
<li><strong>&#x7B2C;&#x4E00;&#x4E2A;Byte&#x5B58;&#x50A8;&#x8FDE;&#x7EED;&#x6570;&#x636E;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x5B57;</strong>, &#x5728;&#x672C;&#x4F8B;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;Byte&#x5B58;&#x50A8; 1</li>
<li><strong>&#x7B2C;&#x4E8C;&#x4E2A;Byte&#x5B58;&#x50A8;&#x8FDE;&#x7EED;&#x6570;&#x636E;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x6570;&#x5B57;</strong>, &#x5728;&#x672C;&#x4F8B;&#x4E2D;&#x7B2C;&#x4E8C;&#x4E2A;Byte&#x5B58;&#x50A8; 100W</li>
</ul>
<p>&#x90A3;&#x4E48;&#x8FD9;100W&#x4E2A;&#x6570;&#x636E;&#x53EA;&#x9700;&#x8981; 2 Byte&#x5C31;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;.<br>RunContainer &#x5728; Lucene 5&#x4E2D;&#x65B0;&#x589E;.</p>
<h4 id="3-1-2-4-RBM-&#x603B;&#x7ED3;"><a href="#3-1-2-4-RBM-&#x603B;&#x7ED3;" class="headerlink" title="3.1.2.4 RBM &#x603B;&#x7ED3;"></a>3.1.2.4 RBM &#x603B;&#x7ED3;</h4><p><img src="https://gitee.com/songjianzaina/juejin_p6/raw/master/img/c7e51891b9e0fc772ed2f729028d3e499cebe061f72ff1a07b09655859379fac" alt="image.png"></p>
<p>&#x672A;&#x5B8C;&#x5F85;&#x7EED;&#x2026;</p>
<h2 id="3-2-&#x8BCD;&#x9879;&#x7D22;&#x5F15;&#x7684;&#x68C0;&#x7D22;&#x539F;&#x7406;"><a href="#3-2-&#x8BCD;&#x9879;&#x7D22;&#x5F15;&#x7684;&#x68C0;&#x7D22;&#x539F;&#x7406;" class="headerlink" title="3.2 &#x8BCD;&#x9879;&#x7D22;&#x5F15;&#x7684;&#x68C0;&#x7D22;&#x539F;&#x7406;"></a>3.2 &#x8BCD;&#x9879;&#x7D22;&#x5F15;&#x7684;&#x68C0;&#x7D22;&#x539F;&#x7406;</h2><h3 id="3-2-1-FST&#xFF1A;Finit-State-Transducers"><a href="#3-2-1-FST&#xFF1A;Finit-State-Transducers" class="headerlink" title="3.2.1 FST&#xFF1A;Finit State Transducers"></a>3.2.1 FST&#xFF1A;Finit State Transducers</h3><p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/928a23b1bcdbdb6e554776ca27b69f23.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../177/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../177/">177</a><span class="page-number current">178</span><a class="page-number" href="../179/">179</a><span class="space">&hellip;</span><a class="page-number" href="../298/">298</a><a class="extend next" rel="next" href="../179/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">2975</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1162</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
