<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/131/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/131/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7017435837679796260.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7017435837679796260.html" itemprop="url">盘点 Cloud   SpringConfig 原理 Git</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-10T21:55:26+08:00">
                2021-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x4F5C;&#x4E3A;&#x5F00;&#x6E90;&#x6846;&#x67B6; , springConfig &#x6709;&#x5F88;&#x591A;&#x529F;&#x80FD;&#x662F;&#x4E0D;&#x9002;&#x5408;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x7684; , &#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5B9A;&#x5236;&#x91CD;&#x5199;&#x6765;&#x8FBE;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x4E1A;&#x52A1;&#x9700;&#x6C42;&#x7684; , &#x8FD9;&#x4E00;&#x7BC7;&#x5C31;&#x6765;&#x770B;&#x770B; , &#x5982;&#x679C;&#x5B9A;&#x5236; SpringCloud Config &#x6A21;&#x5757;</p>
<h2 id="&#x4E8C;-&#x539F;&#x7406;&#x5206;&#x6790;"><a href="#&#x4E8C;-&#x539F;&#x7406;&#x5206;&#x6790;" class="headerlink" title="&#x4E8C;. &#x539F;&#x7406;&#x5206;&#x6790;"></a>&#x4E8C;. &#x539F;&#x7406;&#x5206;&#x6790;</h2><h3 id="2-1-&#x5904;&#x7406;&#x5165;&#x53E3;"><a href="#2-1-&#x5904;&#x7406;&#x5165;&#x53E3;" class="headerlink" title="2.1 &#x5904;&#x7406;&#x5165;&#x53E3;"></a>2.1 &#x5904;&#x7406;&#x5165;&#x53E3;</h3><p>SpringCloudConfig &#x7684;&#x5165;&#x53E3;&#x662F; EnvironmentController , &#x5F53;&#x6211;&#x4EEC;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x5730;&#x5740;&#x65F6; , &#x4F1A;&#x8FDB;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x5904;&#x7406; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;/{application}/{profile}[/{label}]</span><br><span class="line">/{application}-{profile}.yml</span><br><span class="line">/{label}/{application}-{profile}.yml</span><br><span class="line">/{application}-{profile}.properties</span><br><span class="line">/{label}/{application}-{profile}.properties</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x5BF9;&#x5E94;&#x5904;&#x7406;&#x63A5;&#x53E3; -&gt; EnvironmentController</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4EE5;&#x4E0A;&#x65B9;&#x5F0F;&#x5206;&#x522B;&#x5BF9;&#x5E94;&#x5982;&#x4E0B;&#x63A5;&#x53E3; : </span><br><span class="line">@RequestMapping(path = &quot;/{name}/{profiles:.*[^-].*}&quot;, produces = MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">public Environment defaultLabel(@PathVariable String name, @PathVariable String profiles) </span><br><span class="line"></span><br><span class="line">@RequestMapping(path = &quot;/{name}/{profiles:.*[^-].*}&quot;, produces = EnvironmentMediaType.V2_JSON)</span><br><span class="line">public Environment defaultLabelIncludeOrigin(@PathVariable String name, @PathVariable String profiles) </span><br><span class="line"></span><br><span class="line">@RequestMapping(path = &quot;/{name}/{profiles}/{label:.*}&quot;, produces = MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">public Environment labelled(@PathVariable String name, @PathVariable String profiles, @PathVariable String label) </span><br><span class="line"></span><br><span class="line">@RequestMapping(path = &quot;/{name}/{profiles}/{label:.*}&quot;, produces = EnvironmentMediaType.V2_JSON)</span><br><span class="line">public Environment labelledIncludeOrigin(@PathVariable String name, @PathVariable String profiles,@PathVariable String label)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E3B;&#x5165;&#x53E3;&#x903B;&#x8F91; : getEnvironment</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public Environment getEnvironment(String name, String profiles, String label, boolean includeOrigin) {</span><br><span class="line">      </span><br><span class="line">      // &#x5C31;&#x5982;&#x65B9;&#x6CD5;&#x540D; ,&#x6B64;&#x5904;&#x662F;&#x5BF9;&#x53C2;&#x6570;&#x683C;&#x5F0F;&#x5316;/&#x89C4;&#x8303;&#x5316;</span><br><span class="line">      name = normalize(name);</span><br><span class="line">      label = normalize(label);</span><br><span class="line">      </span><br><span class="line">      // &#x6838;&#x5FC3;&#x903B;&#x8F91; , &#x67E5;&#x627E;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line">      Environment environment = this.repository.findOne(name, profiles, label, includeOrigin);</span><br><span class="line"></span><br><span class="line">      // &#x4E3A;&#x7A7A;&#x6821;&#x9A8C;  </span><br><span class="line">      if (!this.acceptEmpty &amp;&amp; (environment == null || environment.getPropertySources().isEmpty())) {</span><br><span class="line">         throw new EnvironmentNotFoundException(&quot;Profile Not found&quot;);</span><br><span class="line">      }</span><br><span class="line">      return environment;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-2-&#x5904;&#x7406;&#x903B;&#x8F91;"><a href="#2-2-&#x5904;&#x7406;&#x903B;&#x8F91;" class="headerlink" title="2.2 &#x5904;&#x7406;&#x903B;&#x8F91;"></a>2.2 &#x5904;&#x7406;&#x903B;&#x8F91;</h3><p>&#x5904;&#x7406;&#x903B;&#x8F91;&#x4E3B;&#x8981;&#x5728; <strong>EnvironmentEncryptorEnvironmentRepository</strong> &#x4E2D;&#x8FDB;&#x884C; , &#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x6838;&#x5FC3;&#x5B9A;&#x5236;&#x7C7B;</p>
<p><strong>&#x8FD9;&#x91CC;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x67E5;&#x8BE2;&#x4F53;&#x7CFB; :</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/27e57343cd25aaba21b0edaf8ab1ba7b2ea8042a5fbb1e2a479ed840b82793b5" alt="Config-EnvironmentRepository.png"></p>
<h4 id="2-2-1-delegate-&#x67E5;&#x627E;&#x914D;&#x7F6E;"><a href="#2-2-1-delegate-&#x67E5;&#x627E;&#x914D;&#x7F6E;" class="headerlink" title="2.2.1 delegate &#x67E5;&#x627E;&#x914D;&#x7F6E;"></a>2.2.1 delegate &#x67E5;&#x627E;&#x914D;&#x7F6E;</h4><p><strong>&#x6CE8;&#x610F; ,&#x6B64;&#x5904;&#x7684;delegate&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x6539;&#x5199;&#x7684; ,&#x8FD9;&#x4E5F;&#x610F;&#x5473;&#x7740;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53BB;&#x5B9E;&#x73B0;&#x4E0D;&#x540C;&#x7684;&#x914D;&#x7F6E;&#x65B9;&#x5F0F;!</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- </span><br><span class="line">public Environment findOne(String name, String profiles, String label, boolean includeOrigin) {</span><br><span class="line">    </span><br><span class="line">    // &#x6838;&#x5FC3;&#x67E5;&#x8BE2;&#x70B9; , &#x4E5F;&#x662F;&#x5B9A;&#x5236;&#x70B9;</span><br><span class="line">   Environment environment = this.delegate.findOne(name, profiles, label, includeOrigin);</span><br><span class="line">   if (this.environmentEncryptors != null) {</span><br><span class="line">   </span><br><span class="line">      for (EnvironmentEncryptor environmentEncryptor : environmentEncryptors) {</span><br><span class="line">         // &#x5BF9;&#x914D;&#x7F6E;&#x89E3;&#x7801; </span><br><span class="line">         environment = environmentEncryptor.decrypt(environment);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return environment;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-Git-&#x5904;&#x7406;&#x6D41;&#x7A0B;"><a href="#2-2-2-Git-&#x5904;&#x7406;&#x6D41;&#x7A0B;" class="headerlink" title="2.2.2 Git &#x5904;&#x7406;&#x6D41;&#x7A0B;"></a>2.2.2 Git &#x5904;&#x7406;&#x6D41;&#x7A0B;</h4><p>&#x5BF9;&#x5E94; Git &#x67E5;&#x8BE2;&#x4F7F;&#x7528;&#x7684;&#x662F; <strong>MultipleJGitEnvironmentRepository</strong> , &#x5F53;&#x7136;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x5176;&#x4ED6;&#x7684; , &#x8FD9;&#x91CC;&#x5148;&#x4E0D;&#x6DF1;&#x5165; :</p>
<p><strong>PS : &#x6B64;&#x5904;&#x4F9D;&#x6B21;&#x8C03;&#x7528;&#x4E86;&#x591A;&#x4E2A; Repository , &#x6700;&#x7EC8;&#x662F;&#x8C03;&#x7528;&#x7236;&#x7C7B; AbstractScmEnvironmentRepository &#x83B7;&#x53D6; Locations</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;//C- AbstractScmEnvironmentRepository</span><br><span class="line">public synchronized Environment findOne(String application, String profile, String label, boolean includeOrigin) {</span><br><span class="line"></span><br><span class="line">   NativeEnvironmentRepository delegate = new NativeEnvironmentRepository(getEnvironment(),</span><br><span class="line">         new NativeEnvironmentProperties());</span><br><span class="line">         </span><br><span class="line">   // &#x83B7;&#x53D6; Location , &#x5728;&#x6B64;&#x73AF;&#x8282;&#x62C9;&#x53D6; Git &#x5230;&#x672C;&#x5730; -&gt; &#x8BE6;&#x89C1; 2.3</span><br><span class="line">   Locations locations = getLocations(application, profile, label);</span><br><span class="line">   delegate.setSearchLocations(locations.getLocations());</span><br><span class="line">   </span><br><span class="line">   // &#x8C03;&#x7528;&#x4E0A;&#x9762;&#x7684; native &#x7EE7;&#x7EED;&#x5904;&#x7406; -&gt; NativeEnvironmentRepository -&gt; 2.2.3 </span><br><span class="line">   Environment result = delegate.findOne(application, profile, &quot;&quot;, includeOrigin);</span><br><span class="line">   </span><br><span class="line">   result.setVersion(locations.getVersion());</span><br><span class="line">   result.setLabel(label);</span><br><span class="line">   </span><br><span class="line">   return this.cleaner.clean(result, getWorkingDirectory().toURI().toString(), getUri());</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Git-&#x6587;&#x4EF6;&#x7684;&#x4E0B;&#x8F7D;"><a href="#2-3-Git-&#x6587;&#x4EF6;&#x7684;&#x4E0B;&#x8F7D;" class="headerlink" title="2.3 Git &#x6587;&#x4EF6;&#x7684;&#x4E0B;&#x8F7D;"></a>2.3 Git &#x6587;&#x4EF6;&#x7684;&#x4E0B;&#x8F7D;</h3><p>Git &#x6587;&#x4EF6;&#x7684;&#x4E0B;&#x8F7D;&#x5176;&#x5B9E;&#x4E0D;&#x9EBB;&#x70E6; , &#x5176;&#x4E3B;&#x8981;&#x4E5F;&#x662F;&#x4F7F;&#x7528;&#x5DE5;&#x5177;&#x7C7B; , &#x4EE5;&#x4E0B;&#x6709;&#x76F8;&#x5173;&#x7684;&#x4F7F;&#x7528; : <a href="/external_links/1fe21333197ddd2ac0b7c9cd53f9e987.html" target="blank" rel="noopener">Git Plugin</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.eclipse.jgit&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;org.eclipse.jgit&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.1.3.201810200350-r&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>&#x5728; <strong>JGitEnvironmentRepository # getLocation</strong> &#x73AF;&#x8282;&#x4E2D; , &#x5B58;&#x5728;&#x4E00;&#x4E2A; <strong>refresh</strong> &#x64CD;&#x4F5C;</p>
<h4 id="2-3-1-refresh-git-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-3-1-refresh-git-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.3.1 refresh git &#x4E3B;&#x6D41;&#x7A0B;"></a>2.3.1 refresh git &#x4E3B;&#x6D41;&#x7A0B;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public String refresh(String label) {</span><br><span class="line">   Git git = null;</span><br><span class="line">   </span><br><span class="line">   // &#x62C9;&#x53D6; Git &#x6587;&#x4EF6;</span><br><span class="line">   git = createGitClient();</span><br><span class="line">   </span><br><span class="line">   // &#x65AD;&#x662F;&#x5426;&#x9700;&#x8981; pull &#x62C9;&#x53D6;</span><br><span class="line">   if (shouldPull(git)) {</span><br><span class="line">       FetchResult fetchStatus = fetch(git, label);</span><br><span class="line">       if (this.deleteUntrackedBranches &amp;&amp; fetchStatus != null) {</span><br><span class="line">           deleteUntrackedLocalBranches(fetchStatus.getTrackingRefUpdates(), git);</span><br><span class="line">       }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   checkout(git, label);</span><br><span class="line">   tryMerge(git, label);</span><br><span class="line">   </span><br><span class="line">   return git.getRepository().findRef(&quot;HEAD&quot;).getObjectId().getName();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-&#x62C9;&#x53D6;-Git-&#x6587;&#x4EF6;"><a href="#2-3-2-&#x62C9;&#x53D6;-Git-&#x6587;&#x4EF6;" class="headerlink" title="2.3.2 &#x62C9;&#x53D6; Git &#x6587;&#x4EF6;"></a>2.3.2 &#x62C9;&#x53D6; Git &#x6587;&#x4EF6;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;</span><br><span class="line">// Step 1 : createGitClient &#x6D41;&#x7A0B;</span><br><span class="line">&#x5728;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x4E3B;&#x8981;2&#x4E2A;&#x903B;&#x8F91; , &#x5224;&#x65AD;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x5B58;&#x5728; .git , &#x5206;&#x522B;&#x8C03;&#x7528; : </span><br><span class="line">- openGitRepository :</span><br><span class="line">- copyRepository : </span><br><span class="line"></span><br><span class="line">// Step 2 : Git &#x6838;&#x5FC3;&#x62C9;&#x53D6;&#x6D41;&#x7A0B;</span><br><span class="line">- copyRepository -&gt; cloneToBasedir : &#x4ECE;&#x8FDC;&#x7AEF; clone &#x9879;&#x76EE;</span><br><span class="line">- cloneToBasedir -&gt; getCloneCommandByCloneRepository : &#x83B7;&#x53D6; clone &#x547D;&#x4EE4;</span><br><span class="line">- cloneToBasedir -&gt; clone.call() : &#x5B8C;&#x6210; clone &#x6D41;&#x7A0B;</span><br></pre></td></tr></table></figure>

<p><strong>&#x5230;&#x4E86;&#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x5728;&#x672C;&#x5730;&#x4E0B;&#x8F7D;&#x5230;&#x4E86;&#x672C;&#x5730; , &#x540E;&#x9762;&#x5C31;&#x662F;&#x8BFB;&#x53D6;&#x4E86;</strong></p>
<h4 id="2-2-3-NativeEnvironmentRepository-&#x7684;&#x5904;&#x7406;"><a href="#2-2-3-NativeEnvironmentRepository-&#x7684;&#x5904;&#x7406;" class="headerlink" title="2.2.3 NativeEnvironmentRepository &#x7684;&#x5904;&#x7406;"></a>2.2.3 NativeEnvironmentRepository &#x7684;&#x5904;&#x7406;</h4><p>&#x5728;&#x4E0A;&#x6587;&#x83B7;&#x53D6;&#x5B8C; Location &#x540E; , &#x4F1A;&#x7EE7;&#x7EED;&#x8FDB;&#x884C; delegate.findOne &#x8FDB;&#x884C;&#x94FE;&#x5F0F;&#x8C03;&#x7528; , &#x8FD9;&#x91CC;&#x4F1A;&#x8FDB;&#x884C;&#x5982;&#x4E0B;&#x8C03;&#x7528; :</p>
<ul>
<li>C- NativeEnvironmentRepository # findOne</li>
<li>C- ConfigDataEnvironmentPostProcessor # applyTo : <strong>&#x8C03;&#x7528; EnvironmentPostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;</strong></li>
<li>C- ConfigDataEnvironmentPostProcessor # postProcessEnvironment</li>
<li>C- ConfigDataEnvironmentPostProcessor # getConfigDataEnvironment : <strong>&#x6784;&#x5EFA; ConfigDataEnvironment</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;ConfigDataEnvironment getConfigDataEnvironment(ConfigurableEnvironment environment, ResourceLoader resourceLoader,</span><br><span class="line">      Collection&lt;String&gt; additionalProfiles) {</span><br><span class="line">   return new ConfigDataEnvironment(this.logFactory, this.bootstrapContext, environment, resourceLoader,</span><br><span class="line">         additionalProfiles, this.environmentUpdateListener);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// PS : &#x6838;&#x5FC3; , &#x5728;&#x6784;&#x9020;&#x5668;&#x4E2D;&#x6784;&#x5EFA;&#x4E86;ConfigDataLocationResolvers</span><br><span class="line">this.resolvers = createConfigDataLocationResolvers(logFactory, bootstrapContext, binder, resourceLoader);</span><br></pre></td></tr></table></figure>

<h3 id="2-4-&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;"><a href="#2-4-&#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;" class="headerlink" title="2.4 &#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;"></a>2.4 &#x6587;&#x4EF6;&#x7684;&#x626B;&#x63CF;</h3><p>Git &#x83B7;&#x53D6;&#x6570;&#x636E;&#x5206;&#x4E3A;2&#x6B65; :</p>
<ul>
<li>Step 1 : &#x4ECE;&#x8FDC;&#x7A0B;&#x62C9;&#x53D6;&#x914D;&#x7F6E;&#x5230;&#x672C;&#x5730;</li>
<li>Step 2 : &#x4ECE;&#x672C;&#x5730;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;</li>
</ul>
<h4 id="2-4-1-&#x626B;&#x63CF;&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-4-1-&#x626B;&#x63CF;&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.4.1 &#x626B;&#x63CF;&#x4E3B;&#x6D41;&#x7A0B;"></a>2.4.1 &#x626B;&#x63CF;&#x4E3B;&#x6D41;&#x7A0B;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConfigDataEnvironmentContributors</span><br><span class="line">ConfigDataEnvironmentContributors withProcessedImports(ConfigDataImporter importer,</span><br><span class="line">      ConfigDataActivationContext activationContext) {</span><br><span class="line">   </span><br><span class="line">   // ImportPhase &#x662F;&#x4E00;&#x4E2A;&#x679A;&#x4E3E; , &#x5305;&#x542B; BEFORE_PROFILE_ACTIVATION &#x548C; AFTER_PROFILE_ACTIVATION 2 &#x4E2A;&#x5C5E;&#x6027;</span><br><span class="line">   // BEFORE_PROFILE_ACTIVATION : &#x542F;&#x52A8;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E4B;&#x524D;&#x7684;&#x9636;&#x6BB5;</span><br><span class="line">   ImportPhase importPhase = ImportPhase.get(activationContext);</span><br><span class="line">  </span><br><span class="line">   ConfigDataEnvironmentContributors result = this;</span><br><span class="line">   int processed = 0;</span><br><span class="line">   </span><br><span class="line">   // &#x6B7B;&#x5FAA;&#x73AF;&#x5904;&#x7406; , &#x76F4;&#x5230;&#x8DEF;&#x5F84;&#x6587;&#x4EF6;&#x5176;&#x5168;&#x90E8;&#x5904;&#x7406;&#x5B8C;&#x6210;</span><br><span class="line">   while (true) {</span><br><span class="line">      // ConfigDataProperties &#x4E2D;&#x5305;&#x542B;&#x4E00;&#x4E2A; Location &#x5BF9;&#x8C61;</span><br><span class="line">      ConfigDataEnvironmentContributor contributor = getNextToProcess(result, activationContext, importPhase);</span><br><span class="line">      if (contributor == null) {</span><br><span class="line">         return result;</span><br><span class="line">      }</span><br><span class="line">      if (contributor.getKind() == Kind.UNBOUND_IMPORT) {</span><br><span class="line">         Iterable&lt;ConfigurationPropertySource&gt; sources = Collections</span><br><span class="line">               .singleton(contributor.getConfigurationPropertySource());</span><br><span class="line">         PlaceholdersResolver placeholdersResolver = new ConfigDataEnvironmentContributorPlaceholdersResolver(</span><br><span class="line">               result, activationContext, true);</span><br><span class="line">         Binder binder = new Binder(sources, placeholdersResolver, null, null, null);</span><br><span class="line">         ConfigDataEnvironmentContributor bound = contributor.withBoundProperties(binder);</span><br><span class="line">         result = new ConfigDataEnvironmentContributors(this.logger, this.bootstrapContext,</span><br><span class="line">               result.getRoot().withReplacement(contributor, bound));</span><br><span class="line">         continue;</span><br><span class="line">      }</span><br><span class="line">      ConfigDataLocationResolverContext locationResolverContext = new ContributorConfigDataLocationResolverContext(</span><br><span class="line">            result, contributor, activationContext);</span><br><span class="line">            </span><br><span class="line">      // &#x51C6;&#x5907; Loader &#x5BB9;&#x5668;  </span><br><span class="line">      ConfigDataLoaderContext loaderContext = new ContributorDataLoaderContext(this);</span><br><span class="line">      </span><br><span class="line">      // &#x83B7;&#x53D6;&#x5168;&#x90E8; Location &#x5217;&#x8868;</span><br><span class="line">      List&lt;ConfigDataLocation&gt; imports = contributor.getImports();</span><br><span class="line">      </span><br><span class="line">      // &#x6838;&#x5FC3;&#x903B;&#x8F91; &gt;&gt;&gt; &#x8FDB;&#x884C; resolver &#x5904;&#x7406; , &#x6700;&#x7EC8;&#x8C03;&#x7528; 2.3.2 resolve</span><br><span class="line">      Map&lt;ConfigDataResolutionResult, ConfigData&gt; imported = importer.resolveAndLoad(activationContext,</span><br><span class="line">            locationResolverContext, loaderContext, imports);</span><br><span class="line">        </span><br><span class="line">      ConfigDataEnvironmentContributor contributorAndChildren = contributor.withChildren(importPhase,</span><br><span class="line">            asContributors(imported));</span><br><span class="line">      result = new ConfigDataEnvironmentContributors(this.logger, this.bootstrapContext,</span><br><span class="line">            result.getRoot().withReplacement(contributor, contributorAndChildren));</span><br><span class="line">      processed++;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-resolve-&#x89E3;&#x6790;&#x8DEF;&#x5F84;"><a href="#2-4-2-resolve-&#x89E3;&#x6790;&#x8DEF;&#x5F84;" class="headerlink" title="2.4.2 resolve &#x89E3;&#x6790;&#x8DEF;&#x5F84;"></a>2.4.2 resolve &#x89E3;&#x6790;&#x8DEF;&#x5F84;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConfigDataImporter # resolveAndLoad : &#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x6838;&#x5FC3;&#x7684;&#x4E09;&#x4E2A;&#x6B65;&#x9AA4; </span><br><span class="line"></span><br><span class="line">// Step 1 : &#x83B7;&#x53D6; Profiles &#x4FE1;&#x606F;</span><br><span class="line">Profiles profiles = (activationContext != null) ? activationContext.getProfiles() : null;</span><br><span class="line"></span><br><span class="line">// Step 2 : resolved &#x89E3;&#x6790;&#x8DEF;&#x5F84;</span><br><span class="line">List&lt;ConfigDataResolutionResult&gt; resolved = resolve(locationResolverContext, profiles, locations);</span><br><span class="line"></span><br><span class="line">// Step 3 : load &#x52A0;&#x8F7D;&#x4E3A; Map&lt;ConfigDataResolutionResult, ConfigData&gt;</span><br><span class="line">return load(loaderContext, resolved);</span><br></pre></td></tr></table></figure>

<p>resolved &#x7684;&#x8FC7;&#x7A0B;&#x4E5F;&#x6709;&#x70B9;&#x7ED5; ,&#x63A8;&#x8350;&#x770B;&#x56FE; , &#x8FD9;&#x91CC;&#x5217;&#x51FA;&#x4E3B;&#x8981;&#x903B;&#x8F91; :</p>
<blockquote>
<p>Step 2-1 : resolved &#x5FAA;&#x73AF; location</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private List&lt;ConfigDataResolutionResult&gt; resolve(ConfigDataLocationResolverContext locationResolverContext,</span><br><span class="line">      Profiles profiles, List&lt;ConfigDataLocation&gt; locations) {</span><br><span class="line">   List&lt;ConfigDataResolutionResult&gt; resolved = new ArrayList&lt;&gt;(locations.size());</span><br><span class="line">   // &#x904D;&#x5386;&#x6240;&#x6709;&#x7684; location</span><br><span class="line">   for (ConfigDataLocation location : locations) {</span><br><span class="line">      resolved.addAll(resolve(locationResolverContext, profiles, location));</span><br><span class="line">   }</span><br><span class="line">   return Collections.unmodifiableList(resolved);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 2-2 : &#x5FAA;&#x73AF;&#x5176;&#x4ED6; resolve</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x662F;&#x5BF9;&#x591A;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x8D44;&#x6E90;&#x89E3;&#x6790;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;List&lt;ConfigDataResolutionResult&gt; resolve(ConfigDataLocationResolverContext context, ConfigDataLocation location,</span><br><span class="line">      Profiles profiles) {</span><br><span class="line">   // &#x5FAA;&#x73AF;&#x4E14;&#x5224;&#x65AD;&#x80FD;&#x5904;&#x7406; </span><br><span class="line">   for (ConfigDataLocationResolver&lt;?&gt; resolver : getResolvers()) {</span><br><span class="line">      if (resolver.isResolvable(context, location)) {</span><br><span class="line">         return resolve(resolver, context, location, profiles);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 2-3 : getReference &#x540E; &#x5FAA;&#x73AF;&#x6240;&#x6709;&#x8D44;&#x6E90;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- StandardConfigDataLocationResolver</span><br><span class="line">private List&lt;StandardConfigDataResource&gt; resolve(Set&lt;StandardConfigDataReference&gt; references) {</span><br><span class="line">   List&lt;StandardConfigDataResource&gt; resolved = new ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   // reference &#x5BF9; reference &#x8FDB;&#x884C;&#x5FAA;&#x73AF;</span><br><span class="line">   for (StandardConfigDataReference reference : references) {</span><br><span class="line">      resolved.addAll(resolve(reference));</span><br><span class="line">   }</span><br><span class="line">   return resolved;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/8dfff65ad5516d7871a339f588fdaba1f7e0ad773d5ba35d5ddee5b59f5b32bb" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c03f090c1e2514f4e871931963270d85be55dd9170272f64b2cb4fd54842f55e" alt="image.png"></p>
<blockquote>
<p>Step 2-4 : &#x5FAA;&#x73AF;&#x6240;&#x6709;&#x7684; ConfigDataResource</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private List&lt;ConfigDataResolutionResult&gt; resolve(ConfigDataLocation location, boolean profileSpecific,</span><br><span class="line">      Supplier&lt;List&lt;? extends ConfigDataResource&gt;&gt; resolveAction) {</span><br><span class="line">   // &#x6CE8;&#x610F; , 2-3 &#x5728;&#x8FD9;&#x73AF;&#x8282;&#x53D1;&#x751F; , &#x6B64;&#x65F6;&#x5DF2;&#x7ECF;&#x62FF;&#x5230;&#x4E86;&#x6700;&#x7EC8;&#x7684;&#x8D44;&#x6E90;   </span><br><span class="line">   List&lt;ConfigDataResource&gt; resources = nonNullList(resolveAction.get());</span><br><span class="line">   List&lt;ConfigDataResolutionResult&gt; resolved = new ArrayList&lt;&gt;(resources.size());</span><br><span class="line">   </span><br><span class="line">   for (ConfigDataResource resource : resources) {</span><br><span class="line">      resolved.add(new ConfigDataResolutionResult(location, resource, profileSpecific));</span><br><span class="line">   }</span><br><span class="line">   return resolved;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/7616c3935d857334042c9459cc41385bd15b740c49630ed4d7ea6d073cb5883f" alt="image.png"></p>
<h3 id="2-5-load-&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;"><a href="#2-5-load-&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;" class="headerlink" title="2.5 load &#x52A0;&#x8F7D;&#x6D41;&#x7A0B;"></a>2.5 load &#x52A0;&#x8F7D;&#x6D41;&#x7A0B;</h3><h4 id="2-5-1-load-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#2-5-1-load-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="2.5.1 load &#x4E3B;&#x6D41;&#x7A0B;"></a>2.5.1 load &#x4E3B;&#x6D41;&#x7A0B;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConfigDataImporter</span><br><span class="line">private Map&lt;ConfigDataResolutionResult, ConfigData&gt; load(ConfigDataLoaderContext loaderContext,</span><br><span class="line">      List&lt;ConfigDataResolutionResult&gt; candidates) throws IOException {</span><br><span class="line">   Map&lt;ConfigDataResolutionResult, ConfigData&gt; result = new LinkedHashMap&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   // &#x5BF9;&#x6240;&#x6709;&#x7684; candidates &#x89E3;&#x6790;&#x5FAA;&#x73AF;</span><br><span class="line">   for (int i = candidates.size() - 1; i &gt;= 0; i--) {</span><br><span class="line">      ConfigDataResolutionResult candidate = candidates.get(i);</span><br><span class="line">      </span><br><span class="line">      // &#x83B7;&#x53D6; location</span><br><span class="line">      ConfigDataLocation location = candidate.getLocation();</span><br><span class="line">      // &#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684; Resource &#x8D44;&#x6E90;</span><br><span class="line">      ConfigDataResource resource = candidate.getResource();</span><br><span class="line">      if (this.loaded.add(resource)) {</span><br><span class="line">         try {</span><br><span class="line">            //  &#x8C03;&#x7528; loaders &#x5BF9; resource &#x8FDB;&#x884C;&#x52A0;&#x8F7D;</span><br><span class="line">            ConfigData loaded = this.loaders.load(loaderContext, resource);</span><br><span class="line">            if (loaded != null) {</span><br><span class="line">               // &#x8FD9;&#x91CC;&#x4F1A;&#x7EDF;&#x4E00;&#x653E;&#x5728;&#x4E00;&#x4E2A; map &#x4E2D; </span><br><span class="line">               result.put(candidate, loaded);</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">         catch (ConfigDataNotFoundException ex) {</span><br><span class="line">            handle(ex, location);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return Collections.unmodifiableMap(result);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>!!!!!! &#x6211;&#x8FD9;&#x91CC;&#x88AB;&#x5751;&#x7684;&#x5F88;&#x60E8; , &#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x6848;&#x4F8B;&#x600E;&#x4E48;&#x90FD;&#x52A0;&#x8F7D;&#x4E0D;&#x51FA;&#x6765; , &#x6709;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x770B;&#x6211;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x731C;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;,&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x70B9;!!!</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ad7ce75b3fbdd10785e2c5049a168257e5f73007324c5a293b891bd53f7b17de" alt="image.png"></p>
<h4 id="2-5-2-loaders-&#x52A0;&#x8F7D;"><a href="#2-5-2-loaders-&#x52A0;&#x8F7D;" class="headerlink" title="2.5.2 loaders &#x52A0;&#x8F7D;"></a>2.5.2 loaders &#x52A0;&#x8F7D;</h4><p>&#x6B64;&#x5904;&#x7684;&#x5BB6;&#x957F;&#x5BF9;&#x8C61;&#x4E3B;&#x8981;&#x4E3A; ConfigDataLoaders , &#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x4E3A; <strong>StandardConfigDataLoader</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c7e87786eff29b8f964a31f8453c8da99f30eeea174b20883002bd8a08b429d2" alt="image.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConfigData load(ConfigDataLoaderContext context, StandardConfigDataResource resource)</span><br><span class="line">      throws IOException, ConfigDataNotFoundException {</span><br><span class="line">   </span><br><span class="line">   // &#x7701;&#x7565;&#x4E3A;&#x7A7A;&#x53CA;&#x4E0D;&#x5B58;&#x5728; Reource &#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">   StandardConfigDataReference reference = resource.getReference();</span><br><span class="line">   Resource originTrackedResource = OriginTrackedResource.of(resource.getResource(),</span><br><span class="line">         Origin.from(reference.getConfigDataLocation()));</span><br><span class="line">   String name = String.format(&quot;Config resource &apos;%s&apos; via location &apos;%s&apos;&quot;, resource,</span><br><span class="line">         reference.getConfigDataLocation());</span><br><span class="line">         </span><br><span class="line">   // &#x6700;&#x7EC8;&#x901A;&#x8FC7; YamlPropertySourceLoader &#x5BF9; YAML &#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x52A0;&#x8F7D;      </span><br><span class="line">   List&lt;PropertySource&lt;?&gt;&gt; propertySources = reference.getPropertySourceLoader().load(name, originTrackedResource);</span><br><span class="line">   return new ConfigData(propertySources);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x6700;&#x7EC8;&#x52A0;&#x8F7D;&#x51FA;&#x6765;&#x7684; PropertySources</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/7c03a2bb60a0c1d45a96bda62c7d9e89e5f99ee3782c3709a38738a732f254fa" alt="image.png"></p>
<p>&#x5230;&#x4E86;&#x8FD9;&#x91CC;&#x5C5E;&#x6027;&#x5C31;&#x6B63;&#x5F0F;&#x88AB;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><strong>&#x8FD9;&#x4E00;&#x7BC7;&#x5DF2;&#x7ECF;&#x5199;&#x7684;&#x5F88;&#x957F;&#x4E86; , &#x5355;&#x7EAF;&#x70B9;&#x597D; , &#x6240;&#x4EE5; Native &#x548C;&#x5C5E;&#x6027;&#x7684;&#x4F7F;&#x7528;&#x5728;&#x540E;&#x9762;&#x518D;&#x770B;&#x770B; , &#x8D21;&#x732E;&#x4E00;&#x4E2A;&#x6D41;&#x7A0B;&#x56FE;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/d0b480bc4ae8cf8a44814c39fdafb8cf59c258600cef5b9ba148b5e58fe510cd" alt="Config-git.jpg"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/5f93e5132a7fb7e1ca973100b68d9983.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016160419093938207.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016160419093938207.html" itemprop="url">Spring 实操   PostProcessor 流程及能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-07T11:34:55+08:00">
                2021-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>BeanPostProcessor &#x662F; Spring &#x7684;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x4E4B;&#x4E00; , Bean &#x5B9E;&#x73B0; BeanPostProcessor &#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5F88;&#x591A;&#x590D;&#x6742;&#x7684;&#x529F;&#x80FD;</p>
<h2 id="&#x4E8C;-PostProcessor-&#x7684;&#x7ED3;&#x6784;"><a href="#&#x4E8C;-PostProcessor-&#x7684;&#x7ED3;&#x6784;" class="headerlink" title="&#x4E8C; . PostProcessor &#x7684;&#x7ED3;&#x6784;"></a>&#x4E8C; . PostProcessor &#x7684;&#x7ED3;&#x6784;</h2><h3 id="2-1-&#x63A5;&#x53E3;&#x65B9;&#x6CD5;"><a href="#2-1-&#x63A5;&#x53E3;&#x65B9;&#x6CD5;" class="headerlink" title="2.1 &#x63A5;&#x53E3;&#x65B9;&#x6CD5;"></a>2.1 &#x63A5;&#x53E3;&#x65B9;&#x6CD5;</h3><p>&#x8BE5;&#x63A5;&#x53E3;&#x4E2D;&#x4E3B;&#x8981;&#x63D0;&#x4F9B;&#x4E86;2&#x79CD; , &#x5176;&#x4E2D;&#x63D0;&#x4F9B;&#x4E86;&#x524D;&#x7F6E;&#x8C03;&#x7528;&#x548C;&#x540E;&#x7F6E;&#x8C03;&#x7528; . &#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230; , &#x8FD9;&#x91CC;&#x901A;&#x8FC7; default &#x4FEE;&#x9970; , &#x6240;&#x4EE5;&#x5E76;&#x4E0D;&#x662F;&#x5F3A;&#x5236;&#x91CD;&#x5199;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public interface BeanPostProcessor {</span><br><span class="line"></span><br><span class="line">   default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-2-&#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;"><a href="#2-2-&#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;" class="headerlink" title="2.2 &#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;"></a>2.2 &#x5E38;&#x89C1;&#x5B9E;&#x73B0;&#x7C7B;</h3><p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230; , AOP , &#x5B9A;&#x65F6; , &#x914D;&#x7F6E;&#x7B49;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#x76F8;&#x5173;&#x7684;&#x96C6;&#x6210;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9fd9bc2322e39b45e1415c863324821a1bb0a3518773240fa848c2acddd38531" alt="system-BeanPostProcessor.png"></p>
<h2 id="&#x4E09;-Spring-&#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;"><a href="#&#x4E09;-Spring-&#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;" class="headerlink" title="&#x4E09; . Spring &#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;"></a>&#x4E09; . Spring &#x6E90;&#x7801;&#x6DF1;&#x5165;&#x5206;&#x6790;</h2><h3 id="3-1-&#x4F7F;&#x7528;&#x6848;&#x4F8B;"><a href="#3-1-&#x4F7F;&#x7528;&#x6848;&#x4F8B;" class="headerlink" title="3.1 &#x4F7F;&#x7528;&#x6848;&#x4F8B;"></a>3.1 &#x4F7F;&#x7528;&#x6848;&#x4F8B;</h3><p>&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x6765;&#x770B;&#x4E00;&#x4E0B; Spring &#x5185;&#x90E8;&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528; PostProcessor &#x7279;&#x6027;&#x7684; , &#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x4EE5; ScheduledAnnotationBeanPostProcessor &#x4E3A;&#x4F8B;.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName) {</span><br><span class="line">   // &#x53EF;&#x4EE5;&#x770B;&#x5230; , &#x524D;&#x7F6E;&#x5904;&#x7406;&#x5E76;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x5904;&#x7406; , &#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">   return bean;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) {</span><br><span class="line"></span><br><span class="line">   if (bean instanceof AopInfrastructureBean || bean instanceof TaskScheduler ||</span><br><span class="line">         bean instanceof ScheduledExecutorService) {</span><br><span class="line">      // Ignore AOP infrastructure such as scoped proxies.</span><br><span class="line">      return bean;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 1 : &#x5F00;&#x59CB;&#x7279;&#x6B8A;&#x5904;&#x7406; </span><br><span class="line">   Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(bean);</span><br><span class="line">   if (!this.nonAnnotatedClasses.contains(targetClass) &amp;&amp;</span><br><span class="line">         AnnotationUtils.isCandidateClass(targetClass, Arrays.asList(Scheduled.class, Schedules.class))) {</span><br><span class="line">      // Step 2 : &#x83B7;&#x53D6; Method &#x5BF9;&#x5E94; Scheduled &#x7684;&#x96C6;&#x5408;   </span><br><span class="line">      Map&lt;Method, Set&lt;Scheduled&gt;&gt; annotatedMethods = MethodIntrospector.selectMethods(targetClass,</span><br><span class="line">            (MethodIntrospector.MetadataLookup&lt;Set&lt;Scheduled&gt;&gt;) method -&gt; {</span><br><span class="line">               Set&lt;Scheduled&gt; scheduledAnnotations = AnnotatedElementUtils.getMergedRepeatableAnnotations(</span><br><span class="line">                     method, Scheduled.class, Schedules.class);</span><br><span class="line">               return (!scheduledAnnotations.isEmpty() ? scheduledAnnotations : null);</span><br><span class="line">            });</span><br><span class="line">      if (annotatedMethods.isEmpty()) {</span><br><span class="line">         this.nonAnnotatedClasses.add(targetClass);</span><br><span class="line">      }</span><br><span class="line">      else {</span><br><span class="line">         // Step 3 : &#x65B9;&#x6CD5;&#x4E0D;&#x4E3A;&#x7A7A; , &#x6267;&#x884C; Process</span><br><span class="line">         annotatedMethods.forEach((method, scheduledAnnotations) -&gt;</span><br><span class="line">               scheduledAnnotations.forEach(scheduled -&gt; processScheduled(scheduled, method, bean)));</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return bean;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>PS : &#x540E;&#x9762;&#x5C31;&#x4E0D;&#x770B;&#x4E86; , &#x4E3B;&#x8981;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A; ScheduledTask &#x8FD0;&#x884C; Runable &#x5BF9;&#x8C61;</strong></p>
<p>&#x4ECE;&#x5177;&#x4F53;&#x7684;&#x4F7F;&#x7528;&#x4E0A; , &#x4E0D;&#x96BE;&#x770B;&#x51FA; , &#x4ED6;&#x662F;&#x5728;&#x521B;&#x5EFA;Bean&#x7684;&#x65F6;&#x5019;&#x53BB;&#x505A;&#x8865;&#x5145;&#x7684;&#x64CD;&#x4F5C; , &#x90A3;&#x4E48;&#x4E0B;&#x9762;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;</p>
<p>&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x5728;<a href="https://dev.newban.cn/6964019910645121038">Bean &#x521D;&#x59CB;&#x5316;&#x6D41;&#x7A0B;</a> &#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x5168;&#x9762;&#x7684;&#x8DDF;&#x8E2A; , &#x8FD9;&#x91CC;&#x66F4;&#x5173;&#x6CE8;&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;</p>
<h3 id="3-2-Before-After-&#x8C03;&#x7528;&#x6D41;&#x7A0B;"><a href="#3-2-Before-After-&#x8C03;&#x7528;&#x6D41;&#x7A0B;" class="headerlink" title="3.2 Before/After &#x8C03;&#x7528;&#x6D41;&#x7A0B;"></a>3.2 Before/After &#x8C03;&#x7528;&#x6D41;&#x7A0B;</h3><blockquote>
<p>&#x5165;&#x53E3;&#x4E00; : AbstractAutowireCapableBeanFactory # <strong>initializeBean</strong> &#x8C03;&#x7528;</p>
</blockquote>
<ul>
<li><strong>applyBeanPostProcessorsBeforeInitialization</strong></li>
<li><strong>applyBeanPostProcessorsAfterInitialization</strong><br>&#x5176;&#x4E2D;&#x6D41;&#x7A0B;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355; , for &#x5FAA;&#x73AF;&#x6240;&#x6709;&#x7684; BeanPostProcessors &#x8FDB;&#x884C;&#x5904;&#x7406;</li>
</ul>
<h3 id="3-3-BeanPostProcessors-&#x7684;&#x7BA1;&#x7406;"><a href="#3-3-BeanPostProcessors-&#x7684;&#x7BA1;&#x7406;" class="headerlink" title="3.3 BeanPostProcessors &#x7684;&#x7BA1;&#x7406;"></a>3.3 BeanPostProcessors &#x7684;&#x7BA1;&#x7406;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x5728; AbstractBeanFactory &#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x7528;&#x4E8E;&#x7BA1;&#x7406; BeanPostProcessor</span><br><span class="line">private final List&lt;BeanPostProcessor&gt; beanPostProcessors = new BeanPostProcessorCacheAwareList();</span><br><span class="line"></span><br><span class="line">// &#x4E0D;&#x8BBA;&#x662F;&#x54EA;&#x79CD;&#x7C7B;&#x578B; ,&#x90FD;&#x4F1A;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;2&#x79CD;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x8C03;&#x7528; , &#x5148;&#x5220;&#x9664;, &#x540E;&#x6DFB;&#x52A0;</span><br><span class="line">public void addBeanPostProcessors(Collection&lt;? extends BeanPostProcessor&gt; beanPostProcessors) {</span><br><span class="line">   this.beanPostProcessors.removeAll(beanPostProcessors);</span><br><span class="line">   this.beanPostProcessors.addAll(beanPostProcessors);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public void addBeanPostProcessor(BeanPostProcessor beanPostProcessor) {</span><br><span class="line">   this.beanPostProcessors.remove(beanPostProcessor);</span><br><span class="line">   this.beanPostProcessors.add(beanPostProcessor);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x7C7B;&#x578B;&#x4E00; : &#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x7684;&#x6D41;&#x7A0B;</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x7684;&#x65B9;&#x5F0F; ,&#x5B9E;&#x73B0; BeanPostProcessor &#x7684;&#x6DFB;&#x52A0; , &#x53C2;&#x8003;&#x5BF9;&#x8C61; AbstractApplicationContext</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {</span><br><span class="line">   // .............</span><br><span class="line">   // Configure the bean factory with context callbacks.</span><br><span class="line">   beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));</span><br><span class="line">   // .............</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x7C7B;&#x578B;&#x4E8C; : Refresh &#x73AF;&#x8282;&#x6DFB;&#x52A0;</p>
</blockquote>
<p>&#x54C8;&#x54C8; , &#x53C8;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x5730;&#x65B9; , &#x4E4B;&#x524D;&#x770B; Refresh &#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x6CE8;&#x610F;&#x5230;&#x4E86;&#x8FD9;&#x4E2A;&#x5730;&#x65B9; , &#x4F1A;&#x6CE8;&#x518C;&#x76F8;&#x5173;&#x7684; BeanPostProcessors</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) {</span><br><span class="line">   // Step 1 : &#x8C03;&#x7528;  PostProcessorRegistrationDelegate &#x8FDB;&#x884C;&#x6CE8;&#x518C;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x6E90;&#x7801;&#x6CE8;&#x91CA;&#x975E;&#x5E38;&#x6E05;&#x6670; ,&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x7B80;&#x5355;&#x7FFB;&#x8BD1;&#x4E86;&#x4E00;&#x4E0B;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public static void registerBeanPostProcessors(</span><br><span class="line">      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {</span><br><span class="line"></span><br><span class="line">   // postProcessor &#x6570;&#x7EC4;&#x5217;&#x8868; </span><br><span class="line">   String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">   // processor &#x8BA1;&#x6570; </span><br><span class="line">   int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;</span><br><span class="line">   //&#x6CE8;&#x518C;BeanPostProcessorChecker&#xFF0C;&#x5F53;bean&#x5728;BeanPostProcessor&#x5B9E;&#x4F8B;&#x5316;&#x671F;&#x95F4;&#x521B;&#x5EFA;&#x65F6;&#xFF0C;&#x5373;&#x5F53;bean&#x4E0D;&#x7B26;&#x5408;&#x6240;&#x6709;BeanPostProcessors&#x5904;&#x7406;&#x7684;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x8BE5;checker&#x4F1A;&#x8BB0;&#x5F55;&#x4FE1;&#x606F;&#x6D88;&#x606F; </span><br><span class="line">   beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">   // &#x533A;&#x522B; PriorityOrdered, internalPostProcessor</span><br><span class="line">   List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   // &#x6709;&#x5E8F;&#x5316;</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   for (String ppName : postProcessorNames) {</span><br><span class="line">      if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {</span><br><span class="line">         BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">         priorityOrderedPostProcessors.add(pp);</span><br><span class="line">         // &#x8FD0;&#x884C;&#x65F6;&#x7528;&#x4E8E;&#x5408;&#x5E76;bean&#x5B9A;&#x4E49;&#x7684;&#x540E;&#x5904;&#x7406;&#x5668;&#x56DE;&#x8C03;&#x63A5;&#x53E3;</span><br><span class="line">         if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      // &#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86; Ordered &#x63A5;&#x53E3; , &#x5219;&#x9700;&#x8981;&#x6709;&#x5E8F;&#x5904;&#x7406;</span><br><span class="line">      else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      }</span><br><span class="line">      else {</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // &#x9996;&#x5148;&#xFF0C;&#x6CE8;&#x518C;&#x5B9E;&#x73B0;prioritordered&#x7684;BeanPostProcessors</span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6CE8;&#x518C;&#x5B9E;&#x73B0;Ordered&#x7684;BeanPostProcessors</span><br><span class="line">   List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   for (String ppName : orderedPostProcessorNames) {</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      orderedPostProcessors.add(pp);</span><br><span class="line">      if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x73B0;&#x5728;&#xFF0C;&#x6CE8;&#x518C;&#x6240;&#x6709;&#x5E38;&#x89C4;&#x7684;BeanPostProcessors</span><br><span class="line">   List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   for (String ppName : nonOrderedPostProcessorNames) {</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      nonOrderedPostProcessors.add(pp);</span><br><span class="line">      if (pp instanceof MergedBeanDefinitionPostProcessor) {</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x6700;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x6240;&#x6709;&#x5185;&#x90E8;BeanPostProcessors</span><br><span class="line">   sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">   // &#x5C06;&#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x5185;&#x90E8;bean&#x7684;&#x540E;&#x5904;&#x7406;&#x5668;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x4E3A;ApplicationListeners&#xFF0C;&#x5C06;&#x5176;&#x79FB;&#x52A8;&#x5230;&#x5904;&#x7406;&#x5668;&#x94FE;&#x7684;&#x672B;&#x7AEF;</span><br><span class="line">   beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;-&#x6DF1;&#x5165;&#x5B9A;&#x5236;"><a href="#&#x56DB;-&#x6DF1;&#x5165;&#x5B9A;&#x5236;" class="headerlink" title="&#x56DB; . &#x6DF1;&#x5165;&#x5B9A;&#x5236;"></a>&#x56DB; . &#x6DF1;&#x5165;&#x5B9A;&#x5236;</h2><h3 id="4-1-&#x6DFB;&#x52A0;-BeanPostProcessor"><a href="#4-1-&#x6DFB;&#x52A0;-BeanPostProcessor" class="headerlink" title="4.1 &#x6DFB;&#x52A0; BeanPostProcessor"></a>4.1 &#x6DFB;&#x52A0; BeanPostProcessor</h3><blockquote>
<p>&#x65B9;&#x6CD5;&#x4E00; : &#x624B;&#x52A8;&#x6DFB;&#x52A0;<br><strong>PS : &#x5F53;&#x7136; , &#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x8FC7;&#x4E8E;&#x590D;&#x6742; , &#x9002;&#x7528;&#x573A;&#x666F;&#x4E0D;&#x591A;</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Autowired</span><br><span class="line">private DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">@Bean(initMethod = &quot;initMethod&quot;)</span><br><span class="line">public CommonService getCommonService() {</span><br><span class="line">    // &#x901A;&#x8FC7; BeanFactory &#x8FDB;&#x884C;&#x6DFB;&#x52A0;</span><br><span class="line">    beanFactory.addBeanPostProcessor(new CustomizePostProcessor());</span><br><span class="line">    return new CommonService();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x65B9;&#x6CD5;&#x4E8C; : &#x76F4;&#x63A5;&#x7EE7;&#x627F;&#x63A5;&#x53E3;</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x5206;&#x6790;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x770B;&#x5230; , &#x5B9E;&#x73B0;&#x4E86;&#x63A5;&#x53E3;&#x5C31;&#x81EA;&#x52A8;&#x6DFB;&#x52A0;&#x4E86;</p>
<h2 id="&#x4E94;-&#x95EE;&#x9898;&#x8865;&#x5145;"><a href="#&#x4E94;-&#x95EE;&#x9898;&#x8865;&#x5145;" class="headerlink" title="&#x4E94; .&#x95EE;&#x9898;&#x8865;&#x5145;"></a>&#x4E94; .&#x95EE;&#x9898;&#x8865;&#x5145;</h2><h3 id="5-1-&#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;"><a href="#5-1-&#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;" class="headerlink" title="5.1 &#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B; ?"></a>5.1 &#x4E0E;&#x56DB;&#x79CD;&#x5E38;&#x89C1;&#x7684;&#x521D;&#x59CB;&#x5316;&#x65B9;&#x5F0F;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B; ?</h3><p><strong>&#x56DE;&#x987E;&#x4E00;&#x4E0B;&#x56DB;&#x79CD;&#x521D;&#x59CB;&#x5316;&#x8FD0;&#x884C;&#x7684;&#x65B9;&#x5F0F; :</strong></p>
<ul>
<li>&#x5B9E;&#x73B0; InitializingBean &#x63A5;&#x53E3;&#x65B9;&#x6CD5; afterPropertiesSet</li>
<li>&#x5B9E;&#x73B0; ApplicationRunner &#x63A5;&#x53E3;&#x65B9;&#x6CD5; run(ApplicationArguments args)</li>
<li>&#x65B9;&#x6CD5;&#x6807;&#x6CE8;&#x6CE8;&#x89E3; @PostConstruct</li>
<li>@Bean(initMethod = &#x201C;initMethod&#x201D;) &#x901A;&#x8FC7;&#x6CE8;&#x89E3;&#x6307;&#x5B9A;</li>
</ul>
<blockquote>
<p>&#x8C03;&#x7528;&#x7684;&#x533A;&#x522B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;: ------&gt; this is @PostConstruct &lt;-------</span><br><span class="line">: ------&gt; this is InitializingBean  &lt;-------</span><br><span class="line">: ------&gt; this is in @Bean(initMethod = &quot;initMethod&quot;)  &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessBeforeInitialization &lt;-------</span><br><span class="line">: ------&gt; this is postProcessAfterInitialization &lt;-------</span><br><span class="line">: Started DemoApplication in 0.822 seconds (JVM running for 2.597)</span><br><span class="line">: ------&gt; this is ApplicationRunner :getCommonService &lt;-------</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>&#x8C03;&#x7528;&#x6B21;&#x6570;</strong> : &#x56DB;&#x79CD;&#x65B9;&#x6CD5;&#x53EA;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x6B21; ,&#x800C; postProcessBeforeInitialization &#x548C; postProcessAfterInitialization <strong>&#x4F1A;&#x5728;&#x6BCF;&#x4E2A;Bean&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;</strong></li>
<li><strong>&#x8C03;&#x7528;&#x65F6;&#x673A;</strong> : &#x96C6;&#x4E2D;&#x5728;&#x6BCF;&#x4E2A; Bean <strong>initializeBean</strong> &#x73AF;&#x8282;&#x8C03;&#x7528;</li>
</ul>
<h2 id="&#x516D;-&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48;"><a href="#&#x516D;-&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48;" class="headerlink" title="&#x516D;. &#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48; ?"></a>&#x516D;. &#x6211;&#x4EEC;&#x80FD;&#x7528;&#x5B83;&#x5E72;&#x4EC0;&#x4E48; ?</h2><p>&#x8FD9;&#x91CC;&#x4E0D;&#x8BA8;&#x8BBA;&#x662F;&#x5426;&#x771F;&#x7684;&#x6709;&#x573A;&#x666F;&#x4F1A;&#x4F7F;&#x7528; ,&#x53EA;&#x662F;&#x53D1;&#x6563;&#x601D;&#x7EF4; , &#x53BB;&#x601D;&#x8003;&#x5982;&#x4F55;&#x5229;&#x7528;&#x4ED6;&#x7684;&#x7279;&#x70B9;&#x53BB;&#x505A;&#x70B9;&#x4EC0;&#x4E48;</p>
<h3 id="6-1-&#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;"><a href="#6-1-&#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;" class="headerlink" title="6.1 &#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;"></a>6.1 &#x7ED3;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;</h3><p>&#x4EE3;&#x7406;&#x662F; postProcess &#x6700;&#x5408;&#x9002;&#x7684;&#x4F7F;&#x7528;&#x4E4B;&#x4E00; , AOP &#x5373;&#x4F7F;&#x7528;&#x4E86;&#x4ED6;&#x7684;&#x7279;&#x6027;&#x8FDB;&#x884C;&#x7684;&#x4EE3;&#x7406; , &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6A21;&#x62DF; AOP , &#x53BB;&#x505A;&#x4E00;&#x4E2A;&#x66F4;&#x504F;&#x5411;&#x4E8E;&#x4E1A;&#x52A1;&#x7684;&#x9759;&#x6001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F; .</p>
<p><strong>&#x540C;&#x65F6;&#x4E5F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F; , &#x5BF9; Bean &#x7684;&#x5904;&#x7406;&#x8FDB;&#x884C;&#x52A0;&#x5F3A; .</strong></p>
<blockquote>
<p>Step 1 : &#x51C6;&#x5907;&#x63A5;&#x53E3;&#x548C;&#x5B9E;&#x73B0;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x7EDF;&#x4E00;&#x63A5;&#x53E3;</span><br><span class="line">public interface Sourceable {</span><br><span class="line">    void method();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5BF9;&#x5E94;&#x5B9E;&#x73B0;&#x7C7B; (&#x5B9E;&#x9645;&#x4E1A;&#x52A1;&#x7C7B;)</span><br><span class="line">@Service</span><br><span class="line">public class Source implements Sourceable {</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void method() {</span><br><span class="line">        System.out.println(&quot;the original method!&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 2 : &#x51C6;&#x5907;&#x4E2D;&#x95F4;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class AopProxyImpl implements Sourceable {</span><br><span class="line"></span><br><span class="line">    private Sourceable source;</span><br><span class="line"></span><br><span class="line">    public AopProxyImpl(Sourceable source) {</span><br><span class="line">        super();</span><br><span class="line">        // &#x6CE8;&#x610F; ,&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x662F;&#x5728;&#x4EE3;&#x7406;&#x7C7B;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</span><br><span class="line">        // this.source = new Source();</span><br><span class="line"></span><br><span class="line">        // &#x4FEE;&#x9970;&#x6A21;&#x5F0F;&#x662F;&#x4F20;&#x5165;&#x5BF9;&#x5E94;&#x7684;&#x5BF9;&#x8C61;</span><br><span class="line">        this.source = source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void method() {</span><br><span class="line">        before();</span><br><span class="line">        source.method();</span><br><span class="line">        atfer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void atfer() {</span><br><span class="line">        System.out.println(&quot;after proxy!&quot;);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private void before() {</span><br><span class="line">        System.out.println(&quot;before proxy!&quot;);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 3 : BeanPostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Service</span><br><span class="line">public class AopPostProcessor implements BeanPostProcessor {</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor postProcessBeforeInitialization &lt;-------&quot;);</span><br><span class="line">        return bean;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor postProcessAfterInitialization &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">        if (bean instanceof Sourceable) {</span><br><span class="line">            logger.info(&quot;------&gt; AopPostProcessor build Aop &lt;-------&quot;);</span><br><span class="line">            AopProxyImpl proxy = new AopProxyImpl((Sourceable)bean);</span><br><span class="line">            return proxy;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return bean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; &#xFF1A;</p>
</blockquote>
<ul>
<li>&#x8FD9;&#x91CC;&#x5982;&#x679C;&#x6CA1;&#x6709; , &#x5219;&#x4E00;&#x5B9A;&#x4F1A;&#x629B;&#x51FA; BeanNotOfRequiredTypeException , &#x56E0;&#x4E3A; Spring &#x4F1A;&#x53BB;&#x575A;&#x6301;&#x7C7B;&#x662F;&#x5426;&#x5339;&#x914D;</li>
<li>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C5E;&#x4E8E;&#x9759;&#x6001;&#x4EE3;&#x7406; , &#x5176;&#x5B9E;&#x8FD8;&#x53EF;&#x4EE5;&#x66F4;&#x6D3B;&#x7528;&#x7684;&#x4F7F;&#x7528; <strong>cglib &#x52A8;&#x6001;&#x4EE3;&#x7406;</strong></li>
<li>&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x6574;&#x5408;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x7075;&#x6D3B;&#x4F7F;&#x7528;</li>
</ul>
<h3 id="6-2-Manager-&#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;"><a href="#6-2-Manager-&#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;" class="headerlink" title="6.2 Manager &#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;"></a>6.2 Manager &#x7BA1;&#x7406;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x5BF9;&#x8C61;</h3><p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x662F;&#x5728; postProcessor &#x4E2D;&#x5BF9;&#x6307;&#x5B9A;&#x7684;Bean &#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x7BA1;&#x7406;&#x8BB0;&#x5F55;</p>
<p>&#x5927;&#x6982;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x662F;&#x51C6;&#x5907;&#x4E00;&#x4E2A;BeanManager , &#x7136;&#x540E;&#x5728; postProcessor &#x4E2D;&#x8FDB;&#x884C;&#x7BA1;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Component</span><br><span class="line">public class BeanManager {</span><br><span class="line">    </span><br><span class="line">    // &#x5BF9;&#x7279;&#x6B8A;&#x7684;Bean &#x8FDB;&#x884C;&#x5206;&#x7EC4;</span><br><span class="line">    private static Map&lt;String, TypeBean&gt; typeOne = new ConcurrentHashMap();</span><br><span class="line">    private static Map&lt;String, TypeBean&gt; typeTwo = new ConcurrentHashMap();</span><br><span class="line">    </span><br><span class="line">    // PS : &#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x9002;&#x5408;&#x5904;&#x7406;&#x66F4;&#x590D;&#x6742;&#x7684;&#x573A;&#x666F; , &#x7B80;&#x5355;&#x573A;&#x666F;&#x53EF;&#x4EE5;&#x8003;&#x8651;&#x901A;&#x8FC7; ApplicationContext.getBean &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br><span class="line">    logger.info(&quot;------&gt; ManagerPostProcessor postProcessAfterInitialization &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">    if (bean instanceof TypeBean) {</span><br><span class="line">        logger.info(&quot;------&gt; AopPostProcessor build Aop &lt;-------&quot;);</span><br><span class="line">        beanManager.getTypeOne().put(beanName, (TypeBean) bean);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return bean;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// PS : &#x5B9E;&#x9645;&#x4E0A;&#x548C;&#x6CE8;&#x5165;&#x7684;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</span><br><span class="line">------&gt; typeOne.get(&quot;typeBeanImpl&quot;) == (typeBean) :true &lt;-------</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; :</p>
</blockquote>
<p><strong>&#x8FD9;&#x662F;&#x6700;&#x7B80;&#x5355;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x5F0F; , &#x76F8;&#x5BF9;&#x66F4;&#x590D;&#x6742;&#x7684;&#x8FD8;&#x53EF;&#x4EE5;&#x6574;&#x5408;&#x6CE8;&#x89E3; , &#x6574;&#x5408;&#x63A5;&#x53E3;&#x6216;&#x8005;&#x7236;&#x7C7B; , &#x6216;&#x8005;&#x4EC5;&#x8BB0;&#x5F55;class&#x4FE1;&#x606F;&#x7B49;&#x65B9;&#x5F0F; ,&#x8FBE;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x4E1A;&#x52A1;&#x6548;&#x679C;</strong></p>
<h3 id="6-3-&#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;"><a href="#6-3-&#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;" class="headerlink" title="6.3 &#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;"></a>6.3 &#x6CE8;&#x5165;&#x7279;&#x6B8A;&#x5C5E;&#x6027;</h3><p>&#x4ECE;&#x56FE;&#x7247;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230; , BeanPostProcessor &#x662F;&#x5728; PopulateBean &#x73AF;&#x8282;&#x4E4B;&#x540E;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684; , &#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x73AF;&#x8282; , &#x5BF9; Bean &#x4E2D;&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x4FEE;&#x9970; , &#x5E38;&#x89C1;&#x7684;&#x4F7F;&#x7528;&#x60F3;&#x6CD5;&#x5305;&#x62EC; :</p>
<ul>
<li>&#x4E3A;&#x7279;&#x5B9A;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x52A8;&#x6001;&#x4EE3;&#x7406;</li>
<li>&#x4ECE; Remote &#x7AEF;&#x83B7;&#x53D6;&#x5C5E;&#x6027; , &#x5E76;&#x4E14;&#x8BBE;&#x7F6E;</li>
</ul>
<p><strong>&#x8FD9;&#x4E2A;&#x5C31;&#x6BD4;&#x8F83;&#x597D;&#x7406;&#x89E3;&#x4E86; , &#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5305;&#x62EC;RestTemplate &#x90FD;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x5B8C;&#x6210; , JDBC &#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; , &#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5B8C;&#x5168;&#x53EF;&#x4EE5;&#x4ECE;&#x8FDC;&#x7AEF;&#x83B7;&#x53D6;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F5C;&#x7528;&#x4E00; : </span><br><span class="line">&#x4F7F;&#x7528; JDBC (JPA &#x5E94;&#x8BE5;&#x4E5F;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x53EF;&#x7528;) , &#x4ECE;&#x6570;&#x636E;&#x5E93;&#x83B7;&#x53D6;&#x914D;&#x7F6E; , &#x5224;&#x65AD;&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x5426;&#x6709;&#x7279;&#x5B9A;&#x6CE8;&#x89E3; , &#x5237;&#x65B0;&#x6CE8;&#x89E3;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line"></span><br><span class="line">// &#x4F5C;&#x7528;&#x4E8C; : </span><br><span class="line">&#x8C03;&#x7528;&#x8FDC;&#x7AEF;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3; , &#x81EA;&#x5B9A;&#x4E49;&#x5237;&#x65B0;&#x914D;&#x7F6E;</span><br><span class="line"></span><br><span class="line">// &#x4F5C;&#x7528;&#x4E09; : </span><br><span class="line">&#x5237;&#x65B0;&#x7279;&#x6B8A;&#x7684;&#x5C5E;&#x6027;&#x6216;&#x8005;&#x5BF9;&#x8C61;&#x7B49;&#x7B49;</span><br></pre></td></tr></table></figure>

<p>**&#x7279;&#x6B8A;&#x5BF9;&#x8C61;&#x7684;&#x5237;&#x65B0;&#x6709;&#x591A;&#x79CD;&#x4EFB;&#x610F;&#x7684;&#x4F7F;&#x7528; , &#x53EF;&#x4EE5;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x4E1A;&#x52A1;&#x7075;&#x6D3B;&#x8FD0;&#x7528; **</p>
<h3 id="6-4-&#x5176;&#x4ED6;&#x601D;&#x8DEF;"><a href="#6-4-&#x5176;&#x4ED6;&#x601D;&#x8DEF;" class="headerlink" title="6.4 &#x5176;&#x4ED6;&#x601D;&#x8DEF;"></a>6.4 &#x5176;&#x4ED6;&#x601D;&#x8DEF;</h3><p><strong>&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x629B;&#x7816;&#x5F15;&#x7389; , &#x6B22;&#x8FCE;&#x5927;&#x4F6C;&#x4EEC;&#x63D0;&#x51FA;&#x81EA;&#x5DF1;&#x7684;&#x60F3;&#x6CD5;</strong></p>
<ul>
<li>&#x91CD;&#x6784;&#x5C5E;&#x6027;</li>
<li>&#x5B9A;&#x5236;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x5BF9;&#x7C7B;&#x8FDB;&#x884C;&#x8986;&#x76D6;</li>
</ul>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/135734618c2fcac3cd0f45cacf4c5e370d9e3e76adc45bc76d17284d638107b6" alt="image.png"></p>
<blockquote>
<p>&#x6CE8;&#x610F;&#x70B9; :</p>
</blockquote>
<ul>
<li>applyBeanPostProcessorsBeforeInitialization &#x4E3B;&#x8981;&#x5728; initializeBean &#x73AF;&#x8282;&#x8C03;&#x7528;</li>
<li>applyBeanPostProcessorsAfterInitialization &#x9664;&#x4E86;initializeBean&#x5916;<strong>&#x8FD8;&#x5728;&#x591A;&#x4E2A;&#x73AF;&#x8282;&#x88AB;&#x8C03;&#x7528;</strong> , &#x5305;&#x62EC; getSingletonFactoryBeanForTypeCheck &#x7B49;&#x7B49;&#x51E0;&#x4E2A; Factory &#x53BB;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;</li>
<li>&#x907F;&#x514D;&#x5FAA;&#x73AF; , ManagerPostProcessor &#x4E0D;&#x4F1A;&#x5904;&#x7406;&#x81EA;&#x5DF1;</li>
<li>BeanPostProcessor &#x5728;&#x6BCF;&#x4E2A; bean &#x521B;&#x5EFA;&#x65F6;&#x90FD;&#x4F1A;&#x8C03;&#x7528; , <strong>&#x8FC7;&#x591A;&#x4F1A;&#x5F71;&#x54CD;&#x542F;&#x52A8;&#x6548;&#x7387;</strong></li>
<li>BeanPostProcessor &#x4E3B;&#x8981;&#x5728;populateBean &#x4E4B;&#x540E; , &#x6CE8;&#x610F;&#x524D;&#x540E;&#x987A;&#x5E8F;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/1250d20bb17615c072ff4f090fb35c81.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7016147287889936397.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7016147287889936397.html" itemprop="url">现在准备好告别Transform了吗？   拥抱AGP70</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-07T10:35:34+08:00">
                2021-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x524D;&#x6587;&#x63D0;&#x8981;"><a href="#&#x524D;&#x6587;&#x63D0;&#x8981;" class="headerlink" title="&#x524D;&#x6587;&#x63D0;&#x8981;"></a>&#x524D;&#x6587;&#x63D0;&#x8981;</h1><p>&#x4E4B;&#x524D;&#x5C31;&#x548C;&#x5927;&#x5BB6;&#x4ECB;&#x7ECD;&#x8FC7;<code>AGP(Android Gradle Plugin) 7.0.0</code>&#x7248;&#x672C;&#x4E4B;&#x540E;<code>Transform</code> &#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#x5373;&#x5C06;&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x800C;&#x4E14;&#x4E5F;&#x7B80;&#x5355;&#x7684;&#x4ECB;&#x7ECD;&#x4E86;&#x66FF;&#x6362;&#x7684;&#x65B9;&#x5F0F;&#x662F;<code>Transform Action</code>&#xFF0C;&#x7ECF;&#x8FC7;&#x6211;&#x8FD9;&#x4E00;&#x9635;&#x5B50;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x8C03;&#x7814;&#xFF0C;&#x53D1;&#x73B0;&#x53EA;&#x80FD;&#x8BF4;&#x7B54;&#x5BF9;&#x4E86;&#x4E00;&#x534A;&#x5427;&#x3002;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x4E2A;&#x65B0;&#x4E1C;&#x897F;<code>AsmClassVisitorFactory</code>&#x3002;</p>
<blockquote>
<p>com.android.build.api.instrumentation.AsmClassVisitorFactory</p>
</blockquote>
<blockquote>
<p>A factory to create class visitor objects to instrument classes.</p>
</blockquote>
<blockquote>
<p>The implementation of this interface must be an abstract class where the parameters and instrumentationContext are left unimplemented. The class must have an empty constructor which will be used to construct the factory object.</p>
</blockquote>
<p>&#x5F53;&#x524D;&#x5B98;&#x65B9;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x7684;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x5C31;&#x662F;&#x57FA;&#x4E8E;<code>gradle</code>&#x539F;&#x751F;&#x7684;<code>Transform Action</code>&#xFF0C;&#x8FD9;&#x6B21;&#x7684;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x8D70;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5F2F;&#x8DEF;&#xFF0C;&#x4E00;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x4F46;&#x662F;&#x8C8C;&#x4F3C;&#x5F2F;&#x5F2F;&#x7ED5;&#x7ED5;&#x7684;&#xFF0C;&#x6700;&#x540E;&#x4E5F;&#x6CA1;&#x6709;&#x6210;&#x529F;&#xFF0C;&#x800C;&#x4E14;<code>Transform Action</code>&#x7684;&#x8F93;&#x5165;&#x4EA7;&#x7269;&#x90FD;&#x662F;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#xFF0C;&#x4FEE;&#x6539;&#x4E5F;&#x662F;&#x9488;&#x5BF9;&#x5355;&#x4E00;&#x6587;&#x4EF6;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8C8C;&#x4F3C;&#x4E5F;&#x4E0D;&#x5B8C;&#x5168;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x66FF;&#x6362;&#x65B9;&#x6848;&#xFF0C;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#x90A3;&#x79CD;&#x590D;&#x6742;&#x7684;asm&#x64CD;&#x4F5C;&#x5219;&#x65E0;&#x6CD5;&#x8D1F;&#x8377;&#x4E86;&#x3002;</p>
<p><code>AsmClassVisitorFactory</code>&#x6839;&#x636E;&#x5B98;&#x65B9;&#x8BF4;&#x6CD5;&#xFF0C;&#x7F16;&#x8BD1;&#x901F;&#x5EA6;&#x4F1A;&#x6709;&#x63D0;&#x5347;&#xFF0C;&#x5927;&#x6982;18%&#x5DE6;&#x53F3;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x4F7F;&#x7528;&#x9636;&#x6BB5;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/eb512df978086ed6171d07aa640131c11ea20be09dd96307e7c6d6b5ba9cf2ff" alt="image.png"></p>
<h1 id="&#x5B66;&#x5E9F;&#x4E86;"><a href="#&#x5B66;&#x5E9F;&#x4E86;" class="headerlink" title="&#x5B66;&#x5E9F;&#x4E86;"></a>&#x5B66;&#x5E9F;&#x4E86;</h1><p>&#x6211;&#x4EEC;&#x5148;&#x4ECE;<code>AsmClassVisitorFactory</code>&#x8FD9;&#x4E2A;&#x62BD;&#x8C61;&#x63A5;&#x53E3;&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#x8D77;&#x5427;&#x3002;</p>
<h2 id="AsmClassVisitorFactory"><a href="#AsmClassVisitorFactory" class="headerlink" title="AsmClassVisitorFactory"></a>AsmClassVisitorFactory</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface AsmClassVisitorFactory&lt;ParametersT : InstrumentationParameters&gt; : Serializable {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The parameters that will be instantiated, configured using the given config when registering</span><br><span class="line">     * the visitor, and injected on instantiation.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val parameters: Property&lt;ParametersT&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Contains parameters to help instantiate the visitor objects.</span><br><span class="line">     *</span><br><span class="line">     * This field must be left unimplemented.</span><br><span class="line">     */</span><br><span class="line">    @get:Nested</span><br><span class="line">    val instrumentationContext: InstrumentationContext</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a class visitor object that will visit a class with the given [classContext]. The</span><br><span class="line">     * returned class visitor must delegate its calls to [nextClassVisitor].</span><br><span class="line">     *</span><br><span class="line">     * The given [classContext] contains static information about the classes before starting the</span><br><span class="line">     * instrumentation process. Any changes in interfaces or superclasses for the class with the</span><br><span class="line">     * given [classContext] or for any other class in its classpath by a previous visitor will</span><br><span class="line">     * not be reflected in the [classContext] object.</span><br><span class="line">     *</span><br><span class="line">     * [classContext] can also be used to get the data for classes that are in the runtime classpath</span><br><span class="line">     * of the class being visited.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     *</span><br><span class="line">     * @param classContext contains information about the class that will be instrumented by the</span><br><span class="line">     *                     returned class visitor.</span><br><span class="line">     * @param nextClassVisitor the [ClassVisitor] to which the created [ClassVisitor] must delegate</span><br><span class="line">     *                         method calls.</span><br><span class="line">     */</span><br><span class="line">    fun createClassVisitor(</span><br><span class="line">        classContext: ClassContext,</span><br><span class="line">        nextClassVisitor: ClassVisitor</span><br><span class="line">    ): ClassVisitor</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Whether or not the factory wants to instrument the class with the given [classData].</span><br><span class="line">     *</span><br><span class="line">     * If returned true, [createClassVisitor] will be called and the returned class visitor will</span><br><span class="line">     * visit the class.</span><br><span class="line">     *</span><br><span class="line">     * This method must handle asynchronous calls.</span><br><span class="line">     */</span><br><span class="line">    fun isInstrumentable(classData: ClassData): Boolean</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;&#x4E0B;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x5728;<code>createClassVisitor</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#xFF0C;&#x6B63;&#x5E38;&#x6211;&#x4EEC;&#x5728;&#x6784;&#x9020;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#x65F6;&#x5019;&#x662F;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4E4B;&#x540E;&#x5728;new&#x7684;&#x65F6;&#x5019;&#x4F20;&#x5165;nextClassVisitor&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;<code>isInstrumentable</code>,&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x5426;&#x8981;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x6240;&#x6709;&#x7C7B;&#x90FD;&#x8981;&#x901A;&#x8FC7;ClassVisitor&#x8FDB;&#x884C;&#x626B;&#x63CF;&#x8FD8;&#x662F;&#x592A;&#x8017;&#x65F6;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FC7;&#x6EE4;&#x6389;&#x5F88;&#x591A;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x7C7B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;@Incubating</span><br><span class="line">interface ClassData {</span><br><span class="line">    /**</span><br><span class="line">     * Fully qualified name of the class.</span><br><span class="line">     */</span><br><span class="line">    val className: String</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of the annotations the class has.</span><br><span class="line">     */</span><br><span class="line">    val classAnnotations: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the interfaces that this class or a superclass of this class implements.</span><br><span class="line">     */</span><br><span class="line">    val interfaces: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of all the super classes that this class or a super class of this class extends.</span><br><span class="line">     */</span><br><span class="line">    val superClasses: List&lt;String&gt;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><code>ClassData</code>&#x5E76;&#x4E0D;&#x662F;asm&#x7684;api&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x5185;&#x5BB9;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x6BD4;&#x8F83;&#x5C11;&#xFF0C;&#x4F46;&#x662F;&#x5E94;&#x8BE5;&#x4E5F;&#x52C9;&#x5F3A;&#x591F;&#x7528;&#x4E86;&#x3002;&#x8FD9;&#x90E8;&#x5206;&#x5927;&#x5BB6;&#x7B80;&#x5355;&#x770B;&#x770B;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x5C31;&#x4E0D;&#x591A;&#x505A;&#x4ECB;&#x7ECD;&#x4E86;&#x5462;&#x3002;</p>
<h2 id="&#x65B0;&#x7684;Extension"><a href="#&#x65B0;&#x7684;Extension" class="headerlink" title="&#x65B0;&#x7684;Extension"></a>&#x65B0;&#x7684;Extension</h2><p>AGP&#x7248;&#x672C;&#x5347;&#x7EA7;&#x4E4B;&#x540E;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x4E3A;&#x4E86;&#x533A;&#x5206;&#x65B0;&#x65E7;&#x7248;&#x7684;<code>Extension</code>,&#x6240;&#x4EE5;&#x5728;<code>AppExtension</code>&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x65B0;&#x589E;&#x4E86;&#x4E00;&#x4E2A;<code>AndroidComponentsExtension</code>&#x51FA;&#x6765;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x7684;<code>transformClassesWith</code>&#x5C31;&#x9700;&#x8981;&#x6CE8;&#x518C;&#x5728;&#x8FD9;&#x4E2A;&#x4E0A;&#x9762;&#x3002;&#x8FD9;&#x4E2A;&#x9700;&#x8981;&#x8003;&#x8651;&#x5230;&#x53D8;&#x79CD;&#xFF0C;&#x548C;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x8FD8;&#x662F;&#x6709;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x533A;&#x522B;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x53D8;&#x79CD;&#x589E;&#x52A0;&#x5BF9;&#x5E94;&#x7684;&#x9002;&#x914D;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;        val androidComponents = project.extensions.getByType(AndroidComponentsExtension::class.java)</span><br><span class="line">        androidComponents.onVariants { variant -&gt;</span><br><span class="line">            variant.transformClassesWith(PrivacyClassVisitorFactory::class.java,</span><br><span class="line">                    InstrumentationScope.ALL) {}</span><br><span class="line">            variant.setAsmFramesComputationMode(FramesComputationMode.COPY_FRAMES)</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>

<h2 id="&#x5B9E;&#x6218;"><a href="#&#x5B9E;&#x6218;" class="headerlink" title="&#x5B9E;&#x6218;"></a>&#x5B9E;&#x6218;</h2><p>&#x8FD9;&#x6B21;&#x8FD8;&#x662F;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x654F;&#x611F;&#x6743;&#x9650;api&#x66FF;&#x6362;&#x7684;&#x5B57;&#x8282;&#x7801;&#x66FF;&#x6362;&#x5DE5;&#x5177;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x5F00;&#x53D1;&#x3002;</p>
<h3 id="ClassVisitor"><a href="#ClassVisitor" class="headerlink" title="ClassVisitor"></a>ClassVisitor</h3><p>&#x770B;&#x770B;&#x6211;&#x4EEC;&#x6B63;&#x5E38;&#x662F;&#x5982;&#x4F55;&#x5199;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;ClassVisitor&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">ClassVisitor methodFilterCV = new ClassFilterVisitor(classWriter);</span><br><span class="line">ClassReader cr = new ClassReader(srcClass);</span><br><span class="line">cr.accept(methodFilterCV, ClassReader.SKIP_DEBUG);</span><br><span class="line">return classWriter.toByteArray();</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4F1A;&#x6784;&#x9020;&#x597D;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;<code>ClassWriter</code>&#xFF0C;&#x63A5;&#x7740;&#x4F1A;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x5165;&#x8FD9;&#x4E2A;<code>ClassWriter</code>&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>ClassReader</code>&#x5B9E;&#x4F8B;&#xFF0C;&#x7136;&#x540E;&#x5C06;byte&#x6570;&#x7EC4;&#x4F20;&#x5165;&#xFF0C;&#x4E4B;&#x540E;&#x8C03;&#x7528;classReader.accept&#x65B9;&#x6CD5;&#xFF0C;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x5728;visitor&#x4E2D;&#x9010;&#x4E2A;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x7C7B;&#x4FE1;&#x606F;&#xFF0C;&#x65B9;&#x6CD5;&#x5565;&#x7684;&#x90FD;&#x662F;&#x901A;&#x8FC7;ClassReader&#x8BFB;&#x5165;&#x7684;&#xFF0C;&#x7136;&#x540E;&#x7531;&#x5F53;&#x524D;&#x7684;<code>ClassVisitor</code>&#x8BBF;&#x95EE;&#x5B8C;&#x4E4B;&#x540E;&#x4EA4;&#x7ED9;&#x6211;&#x4EEC;&#x6700;&#x540E;&#x4E00;&#x4E2A;<code>ClassWriter</code>&#x3002;</p>
<p>&#x5176;&#x4E2D;<code>ClassWriter</code>&#x4E5F;&#x662F;&#x4E00;&#x4E2A;<code>ClassVisitor</code>&#x5BF9;&#x8C61;&#xFF0C;&#x4ED6;&#x590D;&#x6742;&#x91CD;&#x65B0;&#x5C06;&#x4FEE;&#x6539;&#x8FC7;&#x7684;&#x7C7B;&#x8F6C;&#x5316;&#x6210;byte&#x6570;&#x636E;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5F97;&#x51FA;&#x6765;<code>ClassVisitor</code>&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x4E4B;&#x540E;&#x9010;&#x5C42;&#x5411;&#x4E0B;&#x8BBF;&#x95EE;&#x3002;</p>
<p>&#x4ECB;&#x7ECD;&#x5B8C;&#x4E86;&#x8FD9;&#x4E2A;&#x54E6;&#xFF0C;&#x6211;&#x4EEC;&#x505A;&#x4E2A;&#x5927;&#x80C6;&#x7684;&#x5047;&#x8BBE;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;<code>ClassVisitor</code>&#x94FE;&#x8868;&#x524D;&#x63D2;&#x5165;&#x51E0;&#x4E2A;&#x4E0D;&#x540C;&#x7684;<code>ClassVisitor</code>&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x5C31;&#x53EF;&#x4EE5;&#x8BA9;asm&#x4FEE;&#x6539;&#x9010;&#x4E2A;&#x751F;&#x6548;&#xFF0C;&#x7136;&#x540E;&#x4E5F;&#x4E0D;&#x9700;&#x8981;&#x591A;&#x4F59;&#x7684;io&#x64CD;&#x4F5C;&#x4E86;&#x5462;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x65B0;&#x7684;asm api &#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E86;&#xFF0C;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x8FB9;&#x5927;&#x4F6C;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6846;&#x67B6;&#x5927;&#x4F6C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;&#x53E6;&#x5916;bytex&#x5185;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002;</p>
<blockquote>
<p>tips ClassNode &#x56E0;&#x4E3A;&#x662F;&#x5148;&#x751F;&#x6210;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#xFF0C;&#x6240;&#x4EE5;&#x548C;&#x4E00;&#x822C;&#x7684;ClassVisitor&#x6709;&#x70B9;&#x5C0F;&#x533A;&#x522B;&#xFF0C;&#x9700;&#x8981;&#x5728;visitEnd&#x65B9;&#x6CD5;&#x5185;&#x8C03;&#x7528;accept(next)</p>
</blockquote>
<h3 id="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"><a href="#&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;" class="headerlink" title="&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;"></a>&#x5B9E;&#x9645;&#x4EE3;&#x7801;&#x5206;&#x6790;</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x4E0A;&#x5B9E;&#x6218;&#x54AF;&#x3002;&#x6211;&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7801;&#x5957;&#x7528;&#x5230;&#x8FD9;&#x6B21;&#x7684;&#x903B;&#x8F91;&#x4E0A;&#x6765;&#x3002;</p>
<blockquote>
<p><a href="/external_links/c45b99434aac9aa2e2a217e90ec1e916.html" target="blank" rel="noopener">demo&#x5730;&#x5740;</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;abstract class PrivacyClassVisitorFactory : AsmClassVisitorFactory&lt;InstrumentationParameters.None&gt; {</span><br><span class="line"></span><br><span class="line">    override fun createClassVisitor(classContext: ClassContext, nextClassVisitor: ClassVisitor): ClassVisitor {</span><br><span class="line">        return PrivacyClassNode(nextClassVisitor)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    override fun isInstrumentable(classData: ClassData): Boolean {</span><br><span class="line">        return true</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;isInstrumentable&#x90FD;&#x8FD4;&#x56DE;&#x7684;&#x662F;true&#xFF0C;&#x5176;&#x5B9E;&#x6211;&#x53EF;&#x4EE5;&#x5C06;&#x626B;&#x63CF;&#x89C4;&#x5219;&#x9650;&#x5B9A;&#x5728;&#x7279;&#x5B9A;&#x5305;&#x540D;&#x5185;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x52A0;&#x5FEB;&#x6784;&#x5EFA;&#x901F;&#x5EA6;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;class PrivacyClassNode(private val nextVisitor: ClassVisitor) : ClassNode(Opcodes.ASM5) {</span><br><span class="line">    override fun visitEnd() {</span><br><span class="line">        super.visitEnd()</span><br><span class="line">        PrivacyHelper.whiteList.let {</span><br><span class="line">            val result = it.firstOrNull { whiteName -&gt;</span><br><span class="line">                name.contains(whiteName, true)</span><br><span class="line">            }</span><br><span class="line">            result</span><br><span class="line">        }.apply {</span><br><span class="line">            if (this == null) {</span><br><span class="line">                //   println(&quot;filter: $name&quot;)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        PrivacyHelper.whiteList.firstOrNull {</span><br><span class="line">            name.contains(it, true)</span><br><span class="line">        }?.apply {</span><br><span class="line">            val iterator: Iterator&lt;MethodNode&gt; = methods.iterator()</span><br><span class="line">            while (iterator.hasNext()) {</span><br><span class="line">                val method = iterator.next()</span><br><span class="line">                method.instructions?.iterator()?.forEach {</span><br><span class="line">                    if (it is MethodInsnNode) {</span><br><span class="line">                        it.isPrivacy()?.apply {</span><br><span class="line">                            println(&quot;privacy transform classNodeName: ${name@this}&quot;)</span><br><span class="line">                            it.opcode = code</span><br><span class="line">                            it.owner = owner</span><br><span class="line">                            it.name = name</span><br><span class="line">                            it.desc = desc</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        accept(nextVisitor)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private fun MethodInsnNode.isPrivacy(): PrivacyAsmEntity? {</span><br><span class="line">    val pair = PrivacyHelper.privacyList.firstOrNull {</span><br><span class="line">        val first = it.first</span><br><span class="line">        first.owner == owner &amp;&amp; first.code == opcode &amp;&amp; first.name == name &amp;&amp; first.desc == desc</span><br><span class="line">    }</span><br><span class="line">    return pair?.second</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x628A;&#x903B;&#x8F91;&#x62BD;&#x8C61;&#x5B9A;&#x4E49;&#x5728;&#x7C7B;<code>ClassNode</code>&#x5185;&#xFF0C;&#x7136;&#x540E;&#x5728;<code>visitEnd</code>&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x6211;&#x4E4B;&#x524D;&#x8BF4;&#x7684;<code>accept(nextVisitor)</code>&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5C31;&#x662F;&#x6CE8;&#x518C;&#x903B;&#x8F91;&#x4E86;&#xFF0C;&#x548C;&#x6211;&#x524D;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x5185;&#x5BB9;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<h1 id="&#x6211;&#x7684;&#x89C2;&#x70B9;"><a href="#&#x6211;&#x7684;&#x89C2;&#x70B9;" class="headerlink" title="&#x6211;&#x7684;&#x89C2;&#x70B9;"></a>&#x6211;&#x7684;&#x89C2;&#x70B9;</h1><p><code>AsmClassVisitorFactory</code>&#x76F8;&#x6BD4;&#x8F83;&#x4E8E;&#x4E4B;&#x524D;&#x7684;<code>Transform</code>&#x786E;&#x5B9E;&#x7B80;&#x5316;&#x4E86;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x5FC3;&#x4E4B;&#x524D;&#x7684;&#x589E;&#x91CF;&#x66F4;&#x65B0;&#x7B49;&#x7B49;&#x903B;&#x8F91;&#xFF0C;&#x53EA;&#x8981;&#x4E13;&#x6CE8;&#x4E8E;asm api&#x7684;&#x64CD;&#x4F5C;&#x5C31;&#x884C;&#x4E86;&#x3002;</p>
<p>&#x5176;&#x6B21;&#x5C31;&#x662F;&#x56E0;&#x4E3A;&#x51CF;&#x5C11;&#x4E86;io&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x901F;&#x5EA6;&#x81EA;&#x7136;&#x4E5F;&#x5C31;&#x6BD4;&#x4E4B;&#x524D;&#x6709;&#x6240;&#x63D0;&#x5347;&#x3002;&#x540C;&#x65F6;&#x56E0;&#x4E3A;&#x57FA;&#x4E8E;&#x7684;&#x662F;<code>Transform Action</code>&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x4F53;&#x6027;&#x80FD;&#x8FD8;&#x662F;&#x975E;&#x5E38;ok&#x7684;&#xFF0C;&#x90A3;&#x90E8;&#x5206;&#x589E;&#x91CF;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x66F4;&#x7B80;&#x5355;&#x4E86;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x6211;&#x4E5F;&#x548C;&#x6211;&#x7684;&#x540C;&#x4E8B;&#x5927;&#x4F6C;&#x4EA4;&#x6D41;&#x8FC7;&#x54E6;&#xFF0C;&#x590D;&#x6742;&#x7684;&#x8FD9;&#x79CD;&#x7C7B;&#x4F3C;&#x4E0A;&#x7BC7;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x7684;&#xFF0C;&#x6700;&#x597D;&#x8FD8;&#x662F;&#x4F7F;&#x7528;<code>Gradle Task</code>&#x7684;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x611F;&#x8C22; <a href="/external_links/bf5bb51389a5b3f64585ab7cb0ea718d.html" target="blank" rel="noopener">2BAB</a> &#x548C; <a href="/external_links/805a04201367bbabc8e0521f2b5c695d.html" target="blank" rel="noopener">&#x68EE;&#x54E5;</a>&#xFF0C;&#x6587;&#x7AE0;&#x5F88;&#x591A;&#x5185;&#x5BB9;&#x90FD;&#x53C2;&#x8003;&#x4E86;&#x51E0;&#x4F4D;&#x5927;&#x4F6C;&#x7684;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x6700;&#x540E;&#x6211;&#x6253;&#x7B97;&#x653E;&#x98DE;&#x81EA;&#x5DF1;&#x4E86;&#xFF0C;&#x6587;&#x7AE0;&#x5B57;&#x6570;&#x5C31;&#x968F;&#x4FBF;&#x4E86;&#x5427;&#xFF0C;&#x4E0D;&#x8981;&#x8001;&#x76EF;&#x7740;&#x6587;&#x7AE0;&#x957F;&#x77ED;&#x95EE;&#x9898;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/2deba0e41a9fb9d23a891b44798282dd.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015855422049353741.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015855422049353741.html" itemprop="url">随手记   AOP 如何避开 BeanNotOfRequir</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-06T15:48:35+08:00">
                2021-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x4ECA;&#x5929;&#x5BF9; Spring &#x8FDB;&#x884C;&#x6DF1;&#x5EA6;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019; , &#x60F3;&#x4EFF;&#x7167; AOP &#x53BB;&#x5B9E;&#x73B0;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7406; , &#x4F46;&#x662F;&#x5374;&#x89E6;&#x53D1;&#x4E86; <strong>BeanNotOfRequiredTypeException</strong> &#x5F02;&#x5E38; , &#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; Spring &#x4F1A;&#x8FDB;&#x884C;&#x7C7B;&#x7684;&#x6821;&#x9A8C;</p>
<p>&#x4E8E;&#x662F;&#x7A81;&#x7136;&#x4EA7;&#x751F;&#x4E86;&#x597D;&#x5947; , &#x51B3;&#x5B9A;&#x7814;&#x7A76;&#x4E00;&#x4E0B; , AOP &#x662F;&#x901A;&#x8FC7;&#x4EC0;&#x4E48;&#x65B9;&#x5F0F;&#x907F;&#x5F00;&#x8FD9;&#x4E2A;&#x6821;&#x9A8C;&#x8FC7;&#x7A0B;</p>
<h2 id="&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;"><a href="#&#x4E8C;-&#x524D;&#x7F6E;&#x77E5;&#x8BC6;" class="headerlink" title="&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;"></a>&#x4E8C; . &#x524D;&#x7F6E;&#x77E5;&#x8BC6;</h2><ul>
<li>AOP &#x901A;&#x8FC7; AopProxy &#x8FDB;&#x884C;&#x4EE3;&#x7406;</li>
<li>SpringBoot 1.5 &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; JDK Proxy , SpringBoot 2.0 &#x57FA;&#x4E8E;&#x81EA;&#x52A8;&#x88C5;&#x914D;(AopAutoConfiguration)&#x7684;&#x914D;&#x7F6E; , &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; CGlib</li>
</ul>
<blockquote>
<p>JDK Proxy &#x548C; CGLib &#x7684;&#x533A;&#x522B;</p>
</blockquote>
<p><strong>&#x8001;&#x751F;&#x5E38;&#x8C08;&#x7684;&#x95EE;&#x9898; , &#x95EE;&#x4E86;&#x5B8C;&#x6574;&#x6027;(&#x51D1;&#x5B57;&#x6570;) , &#x8FD8;&#x662F;&#x7B80;&#x5355;&#x5217;&#x4E00;&#x4E0B; :</strong></p>
<ul>
<li>JDK Proxy : &#x5229;&#x7528;&#x62E6;&#x622A;&#x5668;(&#x62E6;&#x622A;&#x5668;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;InvocationHanlder)&#x52A0;&#x4E0A;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;&#x4EE3;&#x7406;&#x63A5;&#x53E3;&#x7684;&#x533F;&#x540D;&#x7C7B;&#xFF0C;&#x5728;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x65B9;&#x6CD5;&#x524D;&#x8C03;&#x7528;InvokeHandler&#x6765;&#x5904;&#x7406;&#x3002;</li>
<li>CGLIB&#x52A8;&#x6001;&#x4EE3;&#x7406;:&#x5229;&#x7528;ASM&#x5F00;&#x6E90;&#x5305;&#xFF0C;&#x5BF9;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7C7B;&#x7684;class&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x8FDB;&#x6765;&#xFF0C;&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5176;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x5B50;&#x7C7B;&#x6765;&#x5904;&#x7406;&#x3002;</li>
</ul>
<p><strong>PS : &#x901A;&#x8FC7; proxy-target-class &#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</strong></p>
<h2 id="&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;"><a href="#&#x4E09;-&#x539F;&#x7406;&#x63A2;&#x7D22;" class="headerlink" title="&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;"></a>&#x4E09; . &#x539F;&#x7406;&#x63A2;&#x7D22;</h2><p>&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x662F; CGLIB , &#x6240;&#x4EE5;&#x4E3B;&#x6D41;&#x7A0B;&#x8FD8;&#x662F;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5206;&#x6790; , &#x6709;&#x4E86;&#x524D;&#x7F6E;&#x77E5;&#x8BC6;&#x7684;&#x8865;&#x5145; , &#x5B9E;&#x73B0;&#x731C;&#x6D4B;&#x662F;&#x7531;&#x4E8E; CGLIB &#x7684;&#x7279;&#x6027; , &#x5B9E;&#x9645;&#x4E0A;&#x88AB;&#x6821;&#x9A8C;&#x51FA;&#x6765;.</p>
<ul>
<li><strong>&#x6E90;&#x5934;</strong> :autowired &#x5BFC;&#x5165;&#x5F97;&#x65F6;&#x5019;&#x4F1A;&#x6821;&#x9A8C;&#x6CE8;&#x5165;&#x7684;&#x7C7B;&#x662F;&#x5426;&#x6B63;&#x786E;</li>
</ul>
<h3 id="3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"><a href="#3-1-&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;" class="headerlink" title="3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;"></a>3.1 &#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3;</h3><ul>
<li>Step 1 : AbstractAutowireCapableBeanFactory # populateBean</li>
<li>Step 2 : AutowiredAnnotationBeanPostProcessor # postProcessProperties</li>
<li>Step 3 : InjectionMetadata # inject</li>
<li>Step 4 : AutowiredAnnotationBeanPostProcessor # inject</li>
<li>Step 5 : DefaultListableBeanFactory # doResolveDependency</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,</span><br><span class="line">      @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {</span><br><span class="line"></span><br><span class="line">      //............ &#x4EE5;&#x4E0B;&#x662F;&#x4E3B;&#x8981;&#x903B;&#x8F91; </span><br><span class="line"></span><br><span class="line">      if (autowiredBeanNames != null) {</span><br><span class="line">         autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x83B7;&#x53D6; Autowired &#x7684;&#x5B9E;&#x9645;&#x5BF9;&#x8C61;&#x6216;&#x8005;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span><br><span class="line">      if (instanceCandidate instanceof Class) {</span><br><span class="line">         instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5224;&#x65AD;&#x8BE5;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x4E3A;null</span><br><span class="line">      Object result = instanceCandidate;</span><br><span class="line">      if (result instanceof NullBean) {</span><br><span class="line">         if (isRequired(descriptor)) {</span><br><span class="line">            raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">         }</span><br><span class="line">         result = null;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x6838;&#x5FC3;&#x62E6;&#x622A;&#x903B;&#x8F91;</span><br><span class="line">      if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">         throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"><a href="#3-2-&#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;" class="headerlink" title="3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;"></a>3.2 &#x62E6;&#x622A;&#x7684;&#x5224;&#x65AD;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">    </span><br><span class="line">    // &#x7C7B;&#x578B;&#x5224;&#x65AD;</span><br><span class="line">    if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">        return true;</span><br><span class="line">    } else {</span><br><span class="line">        Class resolvedWrapper;</span><br><span class="line">        </span><br><span class="line">        // &#x57FA;&#x672C;&#x7C7B;&#x578B;&#x7279;&#x6B8A;&#x5904;&#x7406;</span><br><span class="line">        if (lhsType.isPrimitive()) {</span><br><span class="line">            resolvedWrapper = (Class)primitiveWrapperTypeMap.get(rhsType);</span><br><span class="line">            return lhsType == resolvedWrapper;</span><br><span class="line">        } else {</span><br><span class="line">            resolvedWrapper = (Class)primitiveTypeToWrapperMap.get(rhsType);</span><br><span class="line">            return resolvedWrapper != null &amp;&amp; lhsType.isAssignableFrom(resolvedWrapper);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-AOP-&#x7684;&#x4F7F;&#x7528;"><a href="#3-3-AOP-&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="3.3 AOP &#x7684;&#x4F7F;&#x7528;"></a>3.3 AOP &#x7684;&#x4F7F;&#x7528;</h3><p>&#x770B;&#x5230;&#x4E86;&#x62E6;&#x622A;&#x7684;&#x5165;&#x53E3; , &#x90A3;&#x5C31;&#x5F97;&#x770B;&#x770B; AOP &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x901A;&#x8FC7; PostProcessor &#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684;&#x4E86; , &#x9996;&#x5148;&#x770B;&#x4E00;&#x4E0B; PostProcessor &#x94FE;&#x8868;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a6a7be386790c1ba8cbc3fb0b837cbdbb912e9cfce5e52e9a47315e988a971a9" alt="image.png"></p>
<blockquote>
<p>Step 1 : &#x5F53;&#x5BF9;&#x8C61; A &#x4E2D;&#x5B57;&#x6BB5;&#x662F; @Autowired &#x6CE8;&#x5165;&#x7684; AOP &#x4EE3;&#x7406;&#x7C7B;&#x65F6;</p>
</blockquote>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0; , &#x5728; DefaultListableBeanFactory # doResolveDependency &#x73AF;&#x8282;&#x4F1A;&#x53BB;&#x83B7;&#x53D6;&#x8BE5;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x5BF9;&#x8C61; ,<br>&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x83B7;&#x53D6;&#x5BF9;&#x8C61;&#x73AF;&#x8282;</span><br><span class="line">if (instanceCandidate instanceof Class) { </span><br><span class="line">   // &#x6B64;&#x65F6;&#x62FF;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x4E00;&#x4E2A; cglib &#x4EE3;&#x7406;&#x7C7B;</span><br><span class="line">   instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/aef7575ca1ddc94558c71bc7de00e268839f779e598d150effe56d2df5c550af" alt="image.png"></p>
<blockquote>
<p>Step 2 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x5165;&#x53E3;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// doResolveDependency &#x4E2D;&#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB; -&gt; true</span><br><span class="line">if (!ClassUtils.isAssignableValue(type, result)) {</span><br><span class="line">   throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// result.getClass()</span><br><span class="line">- name=com.gang.aop.demo.service.StartService$$EnhancerBySpringCGLIB$$d673b902</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Step 3 : &#x5224;&#x65AD;&#x7C7B;&#x7684;&#x5173;&#x7CFB;&#x903B;&#x8F91;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;C- ClassUtils</span><br><span class="line">public static boolean isAssignable(Class&lt;?&gt; lhsType, Class&lt;?&gt; rhsType) {</span><br><span class="line">   </span><br><span class="line">   // &#x6838;&#x5FC3;&#x8BED;&#x53E5; , native &#x65B9;&#x6CD5; -&gt; public native boolean isAssignableFrom(Class&lt;?&gt; cls);</span><br><span class="line">   if (lhsType.isAssignableFrom(rhsType)) {</span><br><span class="line">      return true;</span><br><span class="line">   }</span><br><span class="line">   //.........</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x7EE7;&#x627F;&#x7C7B; , ChildService extends ChildService</span><br><span class="line">: ------&gt; ChildService By ParentService :false &lt;-------</span><br><span class="line">: ------&gt; ParentService By ChildService:true &lt;-------</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x6B64;&#x53EF;&#x89C1; cglib &#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x6EE1;&#x8DB3;&#x8BE5;&#x6761;&#x4EF6; : <strong>&#x76F8;&#x540C; , &#x6216;&#x8005;&#x662F;&#x8D85;&#x7C7B;&#x6216;&#x8005;&#x8D85;&#x63A5;&#x53E3;</strong></p>
<p><strong>&#x8FD9;&#x91CC;&#x56DE;&#x8FC7;&#x5934;&#x770B;&#x4E4B;&#x524D;&#x7684;&#x95EE;&#x9898; , &#x5C31;&#x5F88;&#x7B80;&#x5355;&#x4E86; :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x95EE;&#x9898;&#x539F;&#x56E0; : </span><br><span class="line">&#x6211;&#x901A;&#x8FC7;&#x5B9E;&#x73B0; postProcessor &#x53BB;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x4EE3;&#x7406; </span><br><span class="line">public class AopProxyImpl extends Sourceable {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line">// &#x4FEE;&#x6539;&#x540E; : </span><br><span class="line">public class AopProxyImpl extends Source {</span><br><span class="line">    private Sourceable source;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x901A;&#x8FC7;&#x7EE7;&#x627F;&#x5373;&#x53EF;&#x89E3;&#x51B3; BeanNotOfRequiredTypeException ,&#x5F04;&#x61C2;&#x4E86;&#x5C31;&#x6CA1;&#x4EC0;&#x4E48;&#x96BE;&#x5EA6;&#x4E86;</span><br><span class="line">//</span><br></pre></td></tr></table></figure>

<h2 id="&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;"><a href="#&#x56DB;-&#x6DF1;&#x5165;&#x539F;&#x7406;" class="headerlink" title="&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;"></a>&#x56DB; . &#x6DF1;&#x5165;&#x539F;&#x7406;</h2><p>&#x90A3;&#x4E48;&#x7EE7;&#x7EED;&#x56DE;&#x987E;&#x4E0B; CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B; , &#x5B9E;&#x9645;&#x4E0A;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x7ED3;&#x679C;&#x4E0A;&#x662F;&#x53EF;&#x4EE5;&#x5F88;&#x76F4;&#x89C2;&#x7684;&#x770B;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x5BF9;&#x8C61;&#x7684; :</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/ab4b2dc66710c0288633a3f2a7a34cf5930c8d5263cd85cdf8ee62dc25213235" alt="image.png"></p>
<p>&#x5173;&#x4E8E; CGLIB &#x7684;&#x57FA;&#x7840; , &#x53EF;&#x4EE5;&#x770B;&#x770B;&#x83DC;&#x9E1F;&#x7684;&#x6587;&#x6863; <a href="/external_links/fe1ac05d25dbc344520f0c285b601cf1.html" target="blank" rel="noopener">CGLIB(Code Generation Library) &#x4ECB;&#x7ECD;&#x4E0E;&#x539F;&#x7406;</a> , &#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;</p>
<h3 id="4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"><a href="#4-1-CGLIB-&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;" class="headerlink" title="4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;"></a>4.1 CGLIB &#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;</h3><blockquote>
<p>FastClass &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>FastClass &#x5C31;&#x662F;&#x7ED9;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x7F16;&#x53F7;&#xFF0C;&#x901A;&#x8FC7;&#x7F16;&#x53F7;&#x627E;&#x5230;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x9891;&#x7E41;&#x4F7F;&#x7528;&#x53CD;&#x5C04;&#x5BFC;&#x81F4;&#x6548;&#x7387;&#x6BD4;&#x8F83;&#x4F4E;</p>
<p>CGLIB &#x4F1A;&#x751F;&#x6210;2&#x4E2A; fastClass :</p>
<ul>
<li>xxxx$$FastClassByCGLIB$$xxxx :<strong>&#x4E3A;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
<li>xxxx$$EnhancerByCGLIB$$xxxx$$FastClassByCGLIB$$xxxx : <strong>&#x4E3A;&#x6211;&#x4EEC;&#x88AB;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x5305;&#x542B;&#x5176;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x5EFA;&#x7ACB;&#x4E86;&#x7D22;&#x5F15;</strong></li>
</ul>
<p><strong>&#x539F;&#x56E0; :</strong> cglib&#x4EE3;&#x7406;&#x57FA;&#x4E8E;&#x7EE7;&#x627F;&#x5B9E;&#x73B0;&#xFF0C;&#x7236;&#x7C7B;&#x4E2D;&#x975E;public&#x3001;final&#x7684;&#x65B9;&#x6CD5;&#x65E0;&#x6CD5;&#x88AB;&#x7EE7;&#x627F;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7236;&#x7C7B;&#x7684;fastclass&#x6765;&#x8C03;&#x7528;&#x4EE3;&#x7406;&#x4E0D;&#x5230;&#x7684;&#x65B9;&#x6CD5;</p>
<p>FastClass &#x4E2D;&#x6709;2&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x65B9;&#x6CD5; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4EE3;&#x7406;&#x65B9;&#x6CD5;</span><br><span class="line">public Object invoke(final int n, final Object o, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    final CglibService cglibService = (CglibService)o;</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x4EE3;&#x7406;&#x5BF9;&#x5E94;&#x7684;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;</span><br><span class="line">            cglibService.run();</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        case 1: {</span><br><span class="line">            // &#x4EE3;&#x7406; equeals &#x65B9;&#x6CD5;</span><br><span class="line">            return new Boolean(cglibService.equals(array[0]));</span><br><span class="line">        }</span><br><span class="line">        case 2: {</span><br><span class="line">            // &#x4EE3;&#x7406; toString &#x65B9;&#x6CD5;</span><br><span class="line">            return cglibService.toString();</span><br><span class="line">        }</span><br><span class="line">        case 3: {</span><br><span class="line">            // &#x4EE3;&#x7406; hashCode &#x65B9;&#x6CD5; </span><br><span class="line">            return new Integer(cglibService.hashCode());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61; </span><br><span class="line">public Object newInstance(final int n, final Object[] array) throws InvocationTargetException {</span><br><span class="line">    switch (n) {</span><br><span class="line">        case 0: {</span><br><span class="line">            // &#x6B64;&#x5904;&#x603B;&#x7ED3;&#x901A;&#x8FC7; new &#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;</span><br><span class="line">            return new CglibService();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    throw new IllegalArgumentException(&quot;Cannot find matching method/constructor&quot;);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>enchance &#x5BF9;&#x8C61;</p>
</blockquote>
<p>&#x4E4B;&#x524D;&#x4E86;&#x89E3;&#x5230; , cglib &#x901A;&#x8FC7;&#x91CD;&#x5199;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x4E3B;&#x7C7B;&#x8FBE;&#x5230;&#x4EE3;&#x7406;&#x7684;&#x76EE;&#x7684; , &#x8FD9;&#x91CC;&#x6765;&#x770B;&#x4E00;&#x4E0B; , &#x539F;&#x65B9;&#x6CD5;&#x88AB;&#x6539;&#x5199;&#x6210;&#x4EC0;&#x4E48;&#x6837;&#x4E86;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;final void CGLIB$run$0() {</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line">public final void run() {</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_2;</span><br><span class="line">    MethodInterceptor cglib$CALLBACK_0;</span><br><span class="line">    if ((cglib$CALLBACK_0 = (cglib$CALLBACK_2 = this.CGLIB$CALLBACK_0)) == null) {</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        cglib$CALLBACK_2 = (cglib$CALLBACK_0 = this.CGLIB$CALLBACK_0);</span><br><span class="line">    }</span><br><span class="line">    if (cglib$CALLBACK_0 != null) {</span><br><span class="line">        // &#x8C03;&#x7528;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61;</span><br><span class="line">        cglib$CALLBACK_2.intercept((Object)this, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Method, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$emptyArgs, CglibService$$EnhancerByCGLIB$$7aba7860.CGLIB$run$0$Proxy);</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line">    // &#x6CA1;&#x6709;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x8C61; , &#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">    super.run();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5B9E;&#x9645;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x62E6;&#x622A;&#x5668;</span><br><span class="line">public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {</span><br><span class="line">    </span><br><span class="line">    // &#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x5173;&#x8054;&#x7C7B;</span><br><span class="line">    // &#x6700;&#x7EC8;&#x901A;&#x8FC7; super.run &#x8C03;&#x7528;</span><br><span class="line">    Object result = proxy.invokeSuper(obj, args);     </span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x5904;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6620;&#x5C04;&#x5173;&#x7CFB;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/68c60d7f3d943afcfdb02123ea31bbe49c87333a130cc1385f495f0498978ab3" alt="image.png"></p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b9fbe35eb4f090ddb29e2860952eb6fc2ed40f1c0e1f72c114be21c20faf96b2" alt="cglib.jpg"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/627bf1768683d8531a3aa9aa1e9574f6.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7015539581927833636.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7015539581927833636.html" itemprop="url">盘点 Spring   Conditional</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-05T19:25:02+08:00">
                2021-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x6765;&#x770B;&#x4E00;&#x4E0B;Conditional&#x7684;&#x4F7F;&#x7528;&#x548C;&#x539F;&#x7406; , &#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x4F53;&#x7CFB;&#x7ED3;&#x6784;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f5da8494fdc3dbfb82db38462ff9127df6675d9aac36f2e1f449b7501281945a" alt="System-SpringBootCondition.png"></p>
<h2 id="&#x4E8C;-&#x4F7F;&#x7528;"><a href="#&#x4E8C;-&#x4F7F;&#x7528;" class="headerlink" title="&#x4E8C; . &#x4F7F;&#x7528;"></a>&#x4E8C; . &#x4F7F;&#x7528;</h2><ul>
<li>@ConditionalOnBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingBean&#xFF1A;&#x5F53;&#x5BB9;&#x5668;&#x91CC;&#x6CA1;&#x6709;&#x6307;&#x5B9A; Bean &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnSingleCandidate&#xFF1A;&#x5F53;&#x6307;&#x5B9A; Bean &#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#xFF0C;&#x6216;&#x8005;&#x867D;&#x7136;&#x6709;&#x591A;&#x4E2A;&#x4F46;&#x662F;&#x6307;&#x5B9A;&#x9996;&#x9009; Bean</li>
<li>@ConditionalOnClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnMissingClass&#xFF1A;&#x5F53;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x7C7B;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x3002;</li>
<li>@ConditionalOnProperty&#xFF1A;&#x6307;&#x5B9A;&#x7684;&#x5C5E;&#x6027;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnResource&#xFF1A;&#x7C7B;&#x8DEF;&#x5F84;&#x662F;&#x5426;&#x6709;&#x6307;&#x5B9A;&#x7684;&#x503C;</li>
<li>@ConditionalOnExpression&#xFF1A;&#x57FA;&#x4E8E; SpEL &#x8868;&#x8FBE;&#x5F0F;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x3002;</li>
<li>@ConditionalOnJava&#xFF1A;&#x57FA;&#x4E8E; Java &#x7248;&#x672C;&#x4F5C;&#x4E3A;&#x5224;&#x65AD;&#x6761;&#x4EF6;</li>
<li>@ConditionalOnJndi&#xFF1A;&#x5728; JNDI &#x5B58;&#x5728;&#x7684;&#x6761;&#x4EF6;&#x4E0B;&#x5DEE;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x4F4D;&#x7F6E;</li>
<li>@ConditionalOnNotWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x4E0D;&#x662F; Web &#x9879;&#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
<li>@ConditionalOnWebApplication&#xFF1A;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x662F; Web&#x9879; &#x76EE;&#x7684;&#x6761;&#x4EF6;&#x4E0B;</li>
</ul>
<h3 id="2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-1-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.1 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><h3 id="2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional"><a href="#2-2-&#x81EA;&#x5B9A;&#x4E49;-Conditional" class="headerlink" title="2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional"></a>2.2 &#x81EA;&#x5B9A;&#x4E49; Conditional</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class DefaultConditional implements Condition {</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">        logger.info(&quot;------&gt; &#x8FDB;&#x884C; Conditional &#x5224;&#x65AD; &lt;-------&quot;);</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;"><a href="#2-3-&#x57FA;&#x7840;&#x4F7F;&#x7528;" class="headerlink" title="2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;"></a>2.3 &#x57FA;&#x7840;&#x4F7F;&#x7528;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Bean</span><br><span class="line">@ConditionalOnBean(TestService.class)</span><br><span class="line">public ConfigBean getConfigBean() {</span><br><span class="line">    logger.info(&quot;------&gt; &#x5F00;&#x59CB;&#x52A0;&#x8F7D; ConditionalOnBean &lt;-------&quot;);</span><br><span class="line">    return new ConfigBean();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"><a href="#&#x4E09;-&#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;" class="headerlink" title="&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;"></a>&#x4E09; . &#x81EA;&#x5B9A;&#x4E49;&#x539F;&#x7406;&#x5206;&#x6790;</h2><h3 id="3-1-Conditional-&#x5165;&#x53E3;"><a href="#3-1-Conditional-&#x5165;&#x53E3;" class="headerlink" title="3.1 Conditional &#x5165;&#x53E3;"></a>3.1 Conditional &#x5165;&#x53E3;</h3><p>&#x5BF9;&#x4E8E; Configuration.@Bean &#x7684;&#x521B;&#x5EFA;&#x65B9;&#x5F0F; , Conditinal &#x7684;&#x8D77;&#x70B9;&#x662F; <strong>refush# invokeBeanFactoryPostProcessors</strong> , &#x5728;&#x5176;&#x4E2D;&#x4F1A;&#x8C03;&#x7528; <strong>ConfigurationClassPostProcessor</strong> &#x8FDB;&#x884C;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) {</span><br><span class="line"></span><br><span class="line">  // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D; Configuration &#x4E2D; @Bean &#x7684;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;</span><br><span class="line">  ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line">  MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line">  String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line">  // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x8DF3;&#x8FC7;&#x5F53;&#x524D; Bean</span><br><span class="line">  if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) {</span><br><span class="line">     configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">  if (configClass.skippedBeanMethods.contains(methodName)) {</span><br><span class="line">     return;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"><a href="#3-2-Conditional-&#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;" class="headerlink" title="3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;"></a>3.2 Conditional &#x5224;&#x65AD;&#x7684;&#x6D41;&#x7A0B;</h3><p>ConditionEvaluator &#x662F;&#x6838;&#x5FC3;&#x5904;&#x7406;&#x7C7B; , &#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x8DF3;&#x8FC7;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- ConditionEvaluator</span><br><span class="line">public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5982;&#x679C;&#x5F53;&#x524D; Bean &#x4E0D;&#x5305;&#x542B; @Conditional , &#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span><br><span class="line">   if (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) {</span><br><span class="line">      return false;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">    // Step 2 : &#x6709;2&#x79CD; ConfigurationPhase &#x7684;&#x7C7B;&#x578B; , &#x8868;&#x793A;2&#x79CD;&#x914D;&#x7F6E;&#x7684;&#x9636;&#x6BB5;</span><br><span class="line">    // PARSE_CONFIGURATION :Condition&#x5E94;&#x8BE5;&#x5728;&#x89E3;&#x6790;@Configuration&#x7C7B;&#x65F6;&#x8FDB;&#x884C;&#x8BA1;&#x7B97; , &#x5982;&#x679C;&#x6B64;&#x65F6;&#x6761;&#x4EF6;&#x4E0D;&#x5339;&#x914D;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x6DFB;&#x52A0;@Configuration&#x7C7B;</span><br><span class="line">    // REGISTER_BEAN : &#x6761;&#x4EF6;&#x4E0D;&#x4F1A;&#x963B;&#x6B62;@Configuration&#x7C7B;&#x88AB;&#x6DFB;&#x52A0; , &#x5728;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;&#x65F6;&#xFF0C;&#x6240;&#x6709;@Configuration&#x7C7B;&#x90FD;&#x5C06;&#x88AB;&#x89E3;&#x6790;</span><br><span class="line">   if (phase == null) {</span><br><span class="line">      if (metadata instanceof AnnotationMetadata &amp;&amp;</span><br><span class="line">            ConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) {</span><br><span class="line">         return shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);</span><br><span class="line">      }</span><br><span class="line">      return shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 3 : &#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684; Condition &#x5BF9;&#x8C61;</span><br><span class="line">   List&lt;Condition&gt; conditions = new ArrayList&lt;&gt;();</span><br><span class="line">   for (String[] conditionClasses : getConditionClasses(metadata)) {</span><br><span class="line">      for (String conditionClass : conditionClasses) {</span><br><span class="line">         Condition condition = getCondition(conditionClass, this.context.getClassLoader());</span><br><span class="line">         conditions.add(condition);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   // Step 4 : &#x6392;&#x5E8F; </span><br><span class="line">   AnnotationAwareOrderComparator.sort(conditions);</span><br><span class="line"></span><br><span class="line">   for (Condition condition : conditions) {</span><br><span class="line">      ConfigurationPhase requiredPhase = null;</span><br><span class="line">      if (condition instanceof ConfigurationCondition) {</span><br><span class="line">         requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();</span><br><span class="line">      }</span><br><span class="line">      // Step 5 : &#x6700;&#x7EC8;&#x7684; Condition &#x5339;&#x914D;&#x8FC7;&#x7A0B;</span><br><span class="line">      if ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) {</span><br><span class="line">         return true;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   return false;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x76F4;&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x5F00;&#x59CB;&#x5339;&#x914D;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;</p>
<h2 id="&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"><a href="#&#x56DB;-&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;" class="headerlink" title="&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;"></a>&#x56DB; .&#x5E38;&#x89C4;&#x52A0;&#x8F7D;&#x65B9;&#x5F0F;</h2><blockquote>
<p>&#x89E3;&#x6790;</p>
</blockquote>
<p>&#x5DF2;&#x77E5;&#x7684;Conditional &#x662F;&#x57FA;&#x4E8E; SpringBootCondition &#x5B9E;&#x73B0;&#x7684; , &#x5176;&#x5177;&#x4F53;&#x62BD;&#x8C61;&#x7C7B;&#x4E3A; FilteringSpringBootCondition , &#x770B;&#x4E00;&#x4E0B;&#x4E3B;&#x8981;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f710068f336807b5d041b0adc38d217037016de24f896e2bbfc3ab0679890651" alt="System_FilteringSpringBootCondition.png"></p>
<blockquote>
<p>&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x7684;&#x7C7B;</p>
</blockquote>
<p>&#x7B2C;&#x4E00;&#x6B65;&#x662F;&#x5FEB;&#x901F;&#x53BB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7C7B; , &#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#x5982;&#x4E0B; :</p>
<ul>
<li><strong>&#x8D77;&#x70B9;</strong> : AbstractApplicationContext # refresh # invokeBeanFactoryPostProcessors</li>
<li><strong>&#x5904;&#x7406;</strong> : ConfigurationClassPostProcessor # postProcessBeanDefinitionRegistry &#x5904;&#x7406;&#x4E3B;&#x8981;&#x903B;&#x8F91;</li>
<li><strong>&#x62E6;&#x622A;</strong> : ConfigurationClassFilter # filter</li>
<li><strong>&#x5339;&#x914D;</strong> : FilteringSpringBootCondition # match</li>
</ul>
<p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x662F;&#x8FDB;&#x884C; match &#x5339;&#x914D; ,&#x76EE;&#x7684;&#x662F;&#x83B7;&#x53D6;&#x57FA;&#x4E8E;&#x6B63;&#x5728;&#x5BFC;&#x5165;&#x7684;Configuration&#x7C7B;&#x7684;AnnotationMetadata&#x7684;AutoConfigurationEntry</strong></p>
<h3 id="4-1-Filter-&#x62E6;&#x622A;"><a href="#4-1-Filter-&#x62E6;&#x622A;" class="headerlink" title="4.1 Filter &#x62E6;&#x622A;"></a>4.1 Filter &#x62E6;&#x622A;</h3><p>Filter &#x62E6;&#x622A;&#x662F;&#x5728; ConfigurationClassFilter ,&#x5176;&#x4E2D;&#x4F1A;&#x5BF9;&#x6240;&#x6709;&#x7684; Conditional &#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5904;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private static class ConfigurationClassFilter {</span><br><span class="line"></span><br><span class="line">   // &#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7684;&#x5143;&#x6570;&#x636E;</span><br><span class="line">   private final AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; filter(List&lt;String&gt; configurations) {</span><br><span class="line">      long startTime = System.nanoTime();</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x4E3A;&#x6240;&#x6709;&#x7684; Confiturations &#x7C7B;</span><br><span class="line">      String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">      boolean skipped = false;</span><br><span class="line">      </span><br><span class="line">      // &#x6B64;&#x5904;&#x5305;&#x542B; OnBeanCondition , OnClassCondition  ,OnWebApplicationCondition &#x4E09;&#x79CD;</span><br><span class="line">      for (AutoConfigurationImportFilter filter : this.filters) {</span><br><span class="line">         // &#x83B7;&#x53D6;&#x662F;&#x5426; &#x5B58;&#x5728; match &#x5339;&#x914D;</span><br><span class="line">         boolean[] match = filter.match(candidates, this.autoConfigurationMetadata);</span><br><span class="line">         for (int i = 0; i &lt; match.length; i++) {</span><br><span class="line">            if (!match[i]) {</span><br><span class="line">               candidates[i] = null;</span><br><span class="line">               skipped = true;</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      if (!skipped) {</span><br><span class="line">         return configurations;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      // &#x5982;&#x679C;&#x4E0D;&#x80FD;&#x8DF3;&#x8FC7; , &#x8BB0;&#x5F55;&#x5F53;&#x524D; Confiturations &#x7C7B;</span><br><span class="line">      List&lt;String&gt; result = new ArrayList&lt;&gt;(candidates.length);</span><br><span class="line">      for (String candidate : candidates) {</span><br><span class="line">         if (candidate != null) {</span><br><span class="line">            result.add(candidate);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      return result;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;"><a href="#4-2-FilteringSpringBootCondition-&#x4E2D;-match-&#x5339;&#x914D;" class="headerlink" title="4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;"></a>4.2 FilteringSpringBootCondition &#x4E2D; match &#x5339;&#x914D;</h3><p>&#x6B64;&#x5904;&#x662F;&#x91CD;&#x5199;&#x4E86;&#x5176;&#x7236;&#x7C7B;&#x7684; match &#x65B9;&#x6CD5;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public boolean[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">   // Step 1 :  &#x51C6;&#x5907; Report &#x5BF9;&#x8C61; , &#x7528;&#x4E8E;&#x8BB0;&#x5F55;</span><br><span class="line">   ConditionEvaluationReport report = ConditionEvaluationReport.find(this.beanFactory);</span><br><span class="line">   // Step 2 : &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6240;&#x6709;&#x7684; Condition &#x65B9;&#x6CD5;</span><br><span class="line">   ConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses, autoConfigurationMetadata);</span><br><span class="line">   </span><br><span class="line">   boolean[] match = new boolean[outcomes.length];</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">   </span><br><span class="line">      // &#x5BF9;match&#x4E2D;&#x7684;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x8D4B;&#x503C;,&#x5F53;outcomes&#x5BF9;&#x5E94;&#x4E0B;&#x6807;&#x7684;ConditionOutcome&#x5339;&#x914D;&#x65F6;&#x4E3A;true.&#x5176;&#x4ED6;&#x60C5;&#x51B5;,&#x8FD4;&#x56DE;false</span><br><span class="line">      match[i] = (outcomes[i] == null || outcomes[i].isMatch());</span><br><span class="line">      if (!match[i] &amp;&amp; outcomes[i] != null) {</span><br><span class="line">          // &#x8BB0;&#x5F55;&#x65E5;&#x5FD7;</span><br><span class="line">         logOutcome(autoConfigurationClasses[i], outcomes[i]);</span><br><span class="line">         if (report != null) {</span><br><span class="line">            // &#x50CF; ConditionEvaluationReport # SortedMap &#x5B58;&#x653E;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</span><br><span class="line">            report.recordConditionEvaluation(autoConfigurationClasses[i], this, outcomes[i]);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return match;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ConditionEvaluationReport &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x81EA;&#x52A8;&#x5316;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x4E2D;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x53CA;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public final class ConditionEvaluationReport {</span><br><span class="line"></span><br><span class="line">    //bean&#x540D;&#x79F0;</span><br><span class="line">    private static final String BEAN_NAME = &quot;autoConfigurationReport&quot;;</span><br><span class="line">    </span><br><span class="line">    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7236;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private static final AncestorsMatchedCondition ANCESTOR_CONDITION = new AncestorsMatchedCondition();</span><br><span class="line">    </span><br><span class="line">    //&#x5B58;&#x653E;&#x7C7B;&#x540D;&#x6216;&#x65B9;&#x6CD5;&#x540D;&#xFF08;key&#xFF09;,&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x8F93;&#x51FA;&#x5BF9;&#x8C61;&#xFF08;value&#xFF09;</span><br><span class="line">    private final SortedMap&lt;String, ConditionAndOutcomes&gt; outcomes = new TreeMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    //&#x662F;&#x5426;&#x662F;&#x539F;&#x59CB;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x5BF9;&#x8C61;</span><br><span class="line">    private boolean addedAncestorOutcomes;</span><br><span class="line">    //&#x7236;&#x7684;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x62A5;&#x544A;&#x5BF9;&#x8C61;</span><br><span class="line">    private ConditionEvaluationReport parent;</span><br><span class="line">    </span><br><span class="line">    //&#x8BB0;&#x5F55;&#x5DF2;&#x7ECF;&#x4ECE;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x4E2D;&#x6392;&#x9664;&#x7684;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final List&lt;String&gt; exclusions = new ArrayList&lt;&gt;();</span><br><span class="line">    //&#x8BB0;&#x5F55;&#x4F5C;&#x4E3A;&#x6761;&#x4EF6;&#x8BC4;&#x4F30;&#x7684;&#x5019;&#x9009;&#x7C7B;&#x540D;&#x79F0;</span><br><span class="line">    private final Set&lt;String&gt; unconditionalClasses = new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-3-getOutcomes-&#x83B7;&#x53D6;"><a href="#4-3-getOutcomes-&#x83B7;&#x53D6;" class="headerlink" title="4.3 getOutcomes &#x83B7;&#x53D6;"></a>4.3 getOutcomes &#x83B7;&#x53D6;</h3><p>&#x6B64;&#x5904;&#x4EE5; OnBean &#x4E3A;&#x4F8B; , &#x6B64;&#x5904;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x5173;&#x8054;&#x5173;&#x7CFB; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;protected final ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,</span><br><span class="line">      AutoConfigurationMetadata autoConfigurationMetadata) {</span><br><span class="line">      </span><br><span class="line">   // Step 1 : &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x548C;&#x5904;&#x7406;&#x7C7B;&#x7B49;&#x5BB9;&#x91CF;&#x7684;&#x6570;&#x7EC4;</span><br><span class="line">   ConditionOutcome[] outcomes = new ConditionOutcome[autoConfigurationClasses.length];</span><br><span class="line">   </span><br><span class="line">   // Step 2 : &#x904D;&#x5386;&#x6240;&#x6709;&#x7684; autoConfigurationClasses</span><br><span class="line">   for (int i = 0; i &lt; outcomes.length; i++) {</span><br><span class="line">      String autoConfigurationClass = autoConfigurationClasses[i];</span><br><span class="line">      </span><br><span class="line">      if (autoConfigurationClass != null) {</span><br><span class="line">          </span><br><span class="line">         Set&lt;String&gt; onBeanTypes = autoConfigurationMetadata.getSet(autoConfigurationClass, &quot;ConditionalOnBean&quot;);</span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728; ConditionalOnBean &#x6807;&#x6CE8;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">         outcomes[i] = getOutcome(onBeanTypes, ConditionalOnBean.class);</span><br><span class="line">         </span><br><span class="line">         // &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8F93;&#x51FA; ConditionOutcome </span><br><span class="line">         if (outcomes[i] == null) {</span><br><span class="line">            Set&lt;String&gt; onSingleCandidateTypes = autoConfigurationMetadata.getSet(autoConfigurationClass,</span><br><span class="line">                  &quot;ConditionalOnSingleCandidate&quot;);</span><br><span class="line">            // &#x6B64;&#x5904;&#x662F;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x8981;&#x5904;&#x7406;</span><br><span class="line">            outcomes[i] = getOutcome(onSingleCandidateTypes, ConditionalOnSingleCandidate.class);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   return outcomes;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"><a href="#4-4-&#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;" class="headerlink" title="4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;"></a>4.4 &#x5982;&#x4F55;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8BC4;&#x4F30;&#x6761;&#x4EF6;</h3><p><strong>&#x6CE8;&#x610F; , &#x8FD9;&#x91CC;&#x7684; matches &#x548C; FilteringSpringBootCondition &#x4E0D;&#x662F;&#x4E00;&#x4E2A;</strong></p>
<ul>
<li>FilteringSpringBootCondition # match : &#x57FA;&#x4E8E; AutoConfigurationImportFilter , &#x5BF9;&#x7ED9;&#x5B9A;&#x7684;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7C7B;&#x5019;&#x9009;&#x5E94;&#x7528;&#x7B5B;&#x9009;&#x5668;</li>
<li>SpringBootCondition # matches : &#x9700;&#x8981;&#x8FD4;&#x56DE;&#x6700;&#x7EC8;&#x7684;&#x5224;&#x65AD;&#x7ED3;&#x679C;</li>
</ul>
<blockquote>
<p>&#x8C03;&#x7528;&#x6D41;&#x7A0B;</p>
</blockquote>
<ul>
<li>&#x5728; loadBeanDefinitionsForBeanMethod &#x7B49;&#x7C7B;&#x4F3C;&#x6D41;&#x7A0B;&#x79CD;&#x8C03;&#x7528; shouldSkip , &#x4ECE;&#x800C;&#x8DF3;&#x8F6C;&#x5230;&#x8BE5;&#x903B;&#x8F91;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;@Override</span><br><span class="line">public final boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line"></span><br><span class="line">   // &#x83B7;&#x53D6;&#x6CE8;&#x89E3;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x6216;&#x8005;&#x7C7B;&#x540D;</span><br><span class="line">   String classOrMethodName = getClassOrMethodName(metadata);</span><br><span class="line">   try {</span><br><span class="line">   </span><br><span class="line">      // &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x7C7B; , &#x6B64;&#x5904;&#x4F1A;&#x5224;&#x65AD; metadata instanceof , &#x6709;&#x9650;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; ClassMetadata</span><br><span class="line">      ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br><span class="line">      </span><br><span class="line">      // &#x5F88;&#x7B80;&#x5355;&#x7684;&#x6253;&#x5370;&#x65E5;&#x5FD7; , Trace &#x7EA7;&#x522B;</span><br><span class="line">      logOutcome(classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8BB0;&#x5F55;&#x7ED3;&#x679C; , &#x901A;&#x8FC7; ConditionEvaluationReport &#x548C; recordEvaluation &#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</span><br><span class="line">      recordEvaluation(context, classOrMethodName, outcome);</span><br><span class="line">      </span><br><span class="line">      // &#x8FD4;&#x56DE;&#x662F;&#x5426;&#x6210;&#x529F;&#x5339;&#x914D;</span><br><span class="line">      return outcome.isMatch();</span><br><span class="line">   }</span><br><span class="line">   catch (NoClassDefFoundError ex) {</span><br><span class="line">      throw new IllegalStateException(......);</span><br><span class="line">   }</span><br><span class="line">   catch (RuntimeException ex) {</span><br><span class="line">      throw new IllegalStateException(&quot;Error processing condition on &quot; + getName(metadata), ex);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x662F;&#x8C03;&#x7528; getMatchOutcome &#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6216;&#x8005;&#x4E0D;&#x7B26;&#x5408;&#x8981;&#x6C42; , getMatchOutcome &#x9700;&#x8981;&#x5B50;&#x7C7B;&#x91CD;&#x5199;</p>
<h2 id="&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;"><a href="#&#x4E94;-getMatchOutcome-&#x8BE6;&#x60C5;" class="headerlink" title="&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;"></a>&#x4E94; . getMatchOutcome &#x8BE6;&#x60C5;</h2><h3 id="5-1-OnClass"><a href="#5-1-OnClass" class="headerlink" title="5.1 OnClass"></a>5.1 OnClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   // Step 1 : &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5BB9;&#x5668; ClassLoader  </span><br><span class="line">   ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   // Step 2 : &#x5224;&#x65AD;&#x662F;&#x5426;&#x6709; ConditionalOnClass &#x7EA6;&#x675F;</span><br><span class="line">   List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br><span class="line">   if (onClasses != null) {</span><br><span class="line">      // Step 2-1 : filter &#x8FC7;&#x6EE4; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x7F3A;&#x5931;&#x7C7B; </span><br><span class="line">      List&lt;String&gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader);</span><br><span class="line">      if (!missing.isEmpty()) {</span><br><span class="line">         return ConditionOutcome.noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br><span class="line">               .didNotFind(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE, missing));</span><br><span class="line">      }</span><br><span class="line">      // Step 2-2 : &#x6784;&#x5EFA; matchMessage</span><br><span class="line">      matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br><span class="line">            .found(&quot;required class&quot;, &quot;required classes&quot;)</span><br><span class="line">            .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader));</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   // Step 3 : &#x540C;&#x7406; , &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981; MissClasses</span><br><span class="line">   List&lt;String&gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class);</span><br><span class="line">   if (onMissingClasses != null) {</span><br><span class="line">      // .... &#x4E0E; ConditionalOnClass &#x57FA;&#x672C;&#x7C7B;&#x4F3C; ,&#x6B64;&#x5904;&#x7701;&#x7565;</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConditionMessage &#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<h3 id="5-2-OnBean"><a href="#5-2-OnBean" class="headerlink" title="5.2 OnBean"></a>5.2 OnBean</h3><p>&#x4E0E; OnBean &#x7C7B;&#x4F3C; , &#x8FD9;&#x91CC;&#x5C31;&#x5C55;&#x793A;&#x4E00;&#x79CD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br><span class="line">   ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   MergedAnnotations annotations = metadata.getAnnotations();</span><br><span class="line">   </span><br><span class="line">   if (annotations.isPresent(ConditionalOnBean.class)) {</span><br><span class="line">      // Step 1 :&#x83B7;&#x53D6; ConditionalOnBean &#x6CE8;&#x89E3;&#x4FE1;&#x606F;</span><br><span class="line">      Spec&lt;ConditionalOnBean&gt; spec = new Spec&lt;&gt;(context, metadata, annotations, ConditionalOnBean.class);</span><br><span class="line">      // Step 2 : &#x8FD4;&#x56DE;&#x5339;&#x914D;&#x7ED3;&#x679C;</span><br><span class="line">      // &#x5176;&#x5185;&#x90E8;&#x901A;&#x8FC7; getNamesOfBeansIgnoredByType , getBeanNamesForType &#x7B49;&#x65B9;&#x5F0F;&#x5224;&#x65AD;&#x7C7B;&#x662F;&#x5426;&#x5B58;&#x5728; </span><br><span class="line">      MatchResult matchResult = getMatchingBeans(context, spec);</span><br><span class="line">      if (!matchResult.isAllMatched()) {</span><br><span class="line">         String reason = createOnBeanNoMatchReason(matchResult);</span><br><span class="line">         return ConditionOutcome.noMatch(spec.message().because(reason));</span><br><span class="line">      }</span><br><span class="line">      matchMessage = spec.message(matchMessage).found(&quot;bean&quot;, &quot;beans&quot;).items(Style.QUOTE,</span><br><span class="line">            matchResult.getNamesOfAllMatches());</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnSingleCandidate.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   if (metadata.isAnnotated(ConditionalOnMissingBean.class.getName())) {</span><br><span class="line">        //.....</span><br><span class="line">   }</span><br><span class="line">   return ConditionOutcome.match(matchMessage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>Conditional &#x672C;&#x8EAB;&#x5E76;&#x4E0D;&#x96BE; , &#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x5B8C;&#x5584;&#x56FE;&#x8C31;&#x4EE5;&#x53CA;&#x540E;&#x7EED;&#x7684; starter &#x542F;&#x52A8;&#x6D41;&#x7A0B;&#x65B9;&#x6848; &#x505A;&#x51C6;&#x5907;.</p>
<p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x73AF;&#x8282;&#x7406;&#x89E3;&#x5C31;&#x884C;&#x4E86; :</p>
<ul>
<li>Spring &#x4E2D;&#x7684; Conditional &#x90FD;&#x4F1A;&#x7EE7;&#x627F; SpringBootCondition , &#x4F1A;&#x5B9E;&#x73B0;&#x5176; getOutcomes &#x65B9;&#x6CD5;</li>
<li>getOutcomes &#x662F;&#x7528;&#x4E8E;&#x5FEB;&#x901F;&#x53BB;&#x6389;&#x65E0;&#x9700;&#x52A0;&#x8F7D;&#x7684; Configuration , getMatchOutcome &#x662F;&#x4E3A;&#x4E86;&#x9A8C;&#x8BC1;&#x5339;&#x914D;&#x5173;&#x7CFB;</li>
<li>&#x901A;&#x5E38;&#x90FD;&#x4F1A;&#x901A;&#x8FC7; ConditionEvaluator &#x7684; shouldSkip &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8FC7;@Bean &#x6D41;&#x7A0B;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/281031ca9f0e5159d3c1ec1896b59fa3.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7014080754040717342.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7014080754040717342.html" itemprop="url">Dubbo 30   BootStrap 初始化主流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-10-01T20:59:40+08:00">
                2021-10-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>&#x9996;&#x5148;&#x5206;&#x4EAB;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0; , &#x6B22;&#x8FCE;&#x70B9;&#x8D5E;&#x6536;&#x85CF;&#x8F6C;&#x53D1;&#x4E09;&#x8FDE;&#x4E0B;&#x6B21;&#x4E00;&#x5B9A; &gt;&gt;&gt;&gt;</strong> &#x1F61C;&#x1F61C;&#x1F61C;   </p>
<p><strong>&#x6587;&#x7AE0;&#x5408;&#x96C6; :</strong> &#x1F381; <a href="https://dev.newban.cn/6941642435189538824">juejin.cn/post/694164&#x2026;</a>   </p>
<p><strong>Github :</strong> &#x1F449; <a href="/external_links/f4c0695dd8cd8371c2f2fc9edde11029.html" target="blank" rel="noopener">github.com/black-ant</a>  </p>
<p><strong>CASE &#x5907;&#x4EFD; :</strong> &#x1F449; <a href="/external_links/907cd6419accaedf9bfa60f559823d4b.html" target="blank" rel="noopener">gitee.com/antblack/ca&#x2026;</a></p>
</blockquote>
<h2 id="&#x4E00;-&#x524D;&#x8A00;"><a href="#&#x4E00;-&#x524D;&#x8A00;" class="headerlink" title="&#x4E00; . &#x524D;&#x8A00;"></a>&#x4E00; . &#x524D;&#x8A00;</h2><p><strong>&#x8FD9;&#x4E00;&#x7BC7;&#x53EA;&#x9884;&#x89C8;&#x4E00;&#x4E0B; Bootstrap &#x521D;&#x59CB;&#x5316;&#x7684;&#x4E3B;&#x6D41;&#x7A0B; , &#x90E8;&#x5206;&#x7EC6;&#x8282;&#x70B9;&#x4F1A;&#x53E6;&#x5916;&#x5206;&#x6790;</strong></p>
<p>Dubbo 3.0 &#x901A;&#x8FC7; DubboBootstrap &#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x903B;&#x8F91; , DubboBootstrap &#x7684;&#x542F;&#x52A8;&#x903B;&#x8F91;&#x5982;&#x4E0B; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x6838;&#x5FC3;&#x539F;&#x7406;&#x4E3A; ApplicationContextEvent &#x4E8B;&#x4EF6;&#x7684;&#x89E6;&#x53D1; , &#x5F53; SpringApplication &#x542F;&#x52A8;&#x540E; ,&#x4F1A;&#x53D1;&#x5E03;&#x8BE5;&#x4E8B;&#x4EF6;</span><br><span class="line"></span><br><span class="line">C- AbstractApplicationContext # refresh : &#x53D1;&#x5E03; ApplicationContextEvent &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onApplicationContextEvent : &#x76D1;&#x542C;Application &#x4E8B;&#x4EF6;</span><br><span class="line">C- DubboBootstrapApplicationListener # onContextRefreshedEvent</span><br><span class="line">C- DubboBootstrap # start : &#x5F00;&#x59CB;&#x52A0;&#x8F7D;&#x64CD;&#x4F5C;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x7C7B;</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x53C2;&#x8003;&#x7C7B; : </span><br><span class="line">DubboBeanUtils</span><br><span class="line">ServiceAnnotationPostProcessor</span><br><span class="line">DubboClassPathBeanDefinitionScanner</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">// &#x76D1;&#x542C;&#x5668; : </span><br><span class="line">DubboBootstrapApplicationListener</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;"><a href="#&#x4E8C;-&#x5165;&#x53E3;&#x8BE6;&#x89E3;" class="headerlink" title="&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;"></a>&#x4E8C; . &#x5165;&#x53E3;&#x8BE6;&#x89E3;</h2><p>Dubbo &#x7684;&#x521D;&#x59CB;&#x5316;&#x4E3B;&#x8981;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x7C7B; : DubboBootstrap -</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// Step 1 : DubboBootstrapApplicationListener</span><br><span class="line">public void onApplicationContextEvent(ApplicationContextEvent event) {</span><br><span class="line">	if (DubboBootstrapStartStopListenerSpringAdapter.applicationContext == null) {</span><br><span class="line">		DubboBootstrapStartStopListenerSpringAdapter.applicationContext = event.getApplicationContext();</span><br><span class="line">	}</span><br><span class="line">        // Step 2-1 : &#x5BB9;&#x5668;&#x542F;&#x52A8;&#x540E;&#x521D;&#x59CB;&#x5316; Bootstrap , &#x770B;&#x540D;&#x79F0;&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x8FD8;&#x53EF;&#x4EE5;&#x5237;&#x65B0;</span><br><span class="line">	if (event instanceof ContextRefreshedEvent) {</span><br><span class="line">		onContextRefreshedEvent((ContextRefreshedEvent) event);</span><br><span class="line">        // &#x5BB9;&#x5668;&#x5173;&#x95ED;&#x903B;&#x8F91;  </span><br><span class="line">	} else if (event instanceof ContextClosedEvent) {</span><br><span class="line">		onContextClosedEvent((ContextClosedEvent) event);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-1 </span><br><span class="line">private void onContextRefreshedEvent(ContextRefreshedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		dubboBootstrap.start();</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// Step 2-2 </span><br><span class="line">private void onContextClosedEvent(ContextClosedEvent event) {</span><br><span class="line">	if (dubboBootstrap.getTakeoverMode() == BootstrapTakeoverMode.SPRING) {</span><br><span class="line">		DubboShutdownHook.getDubboShutdownHook().run();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;"><a href="#&#x4E09;-DubboBootstrap-&#x542F;&#x52A8;&#x6D41;&#x7A0B;" class="headerlink" title="&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;"></a>&#x4E09; . DubboBootstrap &#x542F;&#x52A8;&#x6D41;&#x7A0B;</h2><h3 id="3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;"><a href="#3-1-Start-&#x4E3B;&#x6D41;&#x7A0B;" class="headerlink" title="3.1 Start &#x4E3B;&#x6D41;&#x7A0B;"></a>3.1 Start &#x4E3B;&#x6D41;&#x7A0B;</h3><p>start &#x73AF;&#x8282;&#x4E3B;&#x8981;&#x7531;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x73AF;&#x8282; :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;Step 1 : &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</span><br><span class="line">Step 2 : initialize &#x521D;&#x59CB;&#x5316;</span><br><span class="line">Step 3 : exportServices &#x8F93;&#x51FA; Services</span><br><span class="line">Step 4 : referServices &#x6CE8;&#x518C; refer Service</span><br><span class="line">Step 5 : onStart() &#x542F;&#x52A8; (&#x5F02;&#x6B65;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x521B;&#x5EFA; Thread &#x540E;&#x542F;&#x52A8;)</span><br><span class="line">    </span><br><span class="line">// &#x542F;&#x52A8; Dubbo &#x5BB9;&#x5668;&#x73AF;&#x5883;</span><br><span class="line">dubboBootstrap.start(); </span><br><span class="line"></span><br><span class="line">// Step 1 &#xFF1A;Start &#x903B;&#x8F91;</span><br><span class="line">public DubboBootstrap start() {</span><br><span class="line">    if (started.compareAndSet(false, true)) {</span><br><span class="line">        startup.set(false);</span><br><span class="line">        initialized.set(false);</span><br><span class="line">        shutdown.set(false);</span><br><span class="line">        awaited.set(false);</span><br><span class="line"></span><br><span class="line">        initialize();</span><br><span class="line">        // 1. export Dubbo Services</span><br><span class="line">        exportServices();</span><br><span class="line"></span><br><span class="line">        // Not only provider register</span><br><span class="line">        if (!isOnlyRegisterProvider() || hasExportedServices()) {</span><br><span class="line">            // 2. export MetadataService</span><br><span class="line">            exportMetadataService();</span><br><span class="line">            // 3. Register the local ServiceInstance if required</span><br><span class="line">            registerServiceInstance();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        referServices();</span><br><span class="line">        if (asyncExportingFutures.size() &gt; 0 || asyncReferringFutures.size() &gt; 0) {</span><br><span class="line">            new Thread(() -&gt; {</span><br><span class="line">                try {</span><br><span class="line">                    this.awaitFinish();</span><br><span class="line">                } catch (Exception e) {</span><br><span class="line">                    logger.warn(NAME + &quot; asynchronous export / refer occurred an exception.&quot;);</span><br><span class="line">                }</span><br><span class="line">                startup.set(true);</span><br><span class="line">                onStart();</span><br><span class="line">            }).start();</span><br><span class="line">        } else {</span><br><span class="line">            startup.set(true);</span><br><span class="line">            onStart();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    return this;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"><a href="#3-2-&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;" class="headerlink" title="3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;"></a>3.2 &#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;if (started.compareAndSet(false, true)) </span><br><span class="line">    </span><br><span class="line">startup.set(false);</span><br><span class="line">initialized.set(false);</span><br><span class="line">shutdown.set(false);</span><br><span class="line">awaited.set(false);</span><br><span class="line">    </span><br><span class="line">// &#x6B64;&#x5904;&#x6709;&#x51E0;&#x4E2A;&#x4E3B;&#x8981;&#x7684;&#x64CD;&#x4F5C; : </span><br><span class="line">1. &#x539F;&#x5B50;&#x8BBE;&#x7F6E;&#x5DF2;&#x7ECF;&#x542F;&#x52A8;</span><br><span class="line">2. &#x8BBE;&#x7F6E;&#x5C5E;&#x6027;</span><br><span class="line">    </span><br><span class="line">// &#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x8FD9;4&#x4E2A;&#x5C5E;&#x6027;</span><br><span class="line">private AtomicBoolean initialized = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean started = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean startup = new AtomicBoolean(true);</span><br><span class="line">private AtomicBoolean destroyed = new AtomicBoolean(false);</span><br><span class="line">private AtomicBoolean shutdown = new AtomicBoolean(false)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"><a href="#3-3-initialize-&#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;" class="headerlink" title="3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;"></a>3.3 initialize &#x521D;&#x59CB;&#x5316;&#x5185;&#x5BB9;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public void initialize() {</span><br><span class="line">    if (!initialized.compareAndSet(false, true)) {</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ApplicationModel.initFrameworkExts();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316;&#x914D;&#x7F6E;</span><br><span class="line">    startConfigCenter();</span><br><span class="line">    loadConfigsFromProps();</span><br><span class="line">    checkGlobalConfigs();</span><br><span class="line"></span><br><span class="line">    // &#x521D;&#x59CB;&#x5316; Service</span><br><span class="line">    startMetadataCenter();</span><br><span class="line">    initMetadataService();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="3-3-1-ApplicationModel-initFrameworkExts"><a href="#3-3-1-ApplicationModel-initFrameworkExts" class="headerlink" title="3.3.1 ApplicationModel.initFrameworkExts()"></a>3.3.1 ApplicationModel.initFrameworkExts()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;// C- DubboBootstrap</span><br><span class="line">public static void initFrameworkExts() {</span><br><span class="line">        Set&lt;FrameworkExt&gt; exts = ExtensionLoader.getExtensionLoader(FrameworkExt.class).getSupportedExtensionInstances();</span><br><span class="line">    	// PIC21005</span><br><span class="line">        for (FrameworkExt ext : exts) {</span><br><span class="line">            ext.initialize();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 1 : &#x901A;&#x8FC7; SPI &#x8FDB;&#x884C;&#x63D2;&#x4EF6;&#x5904;&#x7406;</span><br><span class="line">@SPI</span><br><span class="line">public interface FrameworkExt extends Lifecycle {</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x8865;&#x5145; : Dubbo &#x4E2D;&#x7684;  Lifecycle &#x5BF9;&#x8C61;</span><br><span class="line">- ConfigManager</span><br><span class="line">- Environment</span><br><span class="line">- LifecycleAdapter</span><br><span class="line">- ServiceRepository</span><br><span class="line">- SpringExtensionFactory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-1  : ConfigManager &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        String configModeStr = null;</span><br><span class="line">        try {</span><br><span class="line">            configModeStr = (String) ApplicationModel.getEnvironment().getConfiguration().getProperty(DUBBO_CONFIG_MODE);</span><br><span class="line">            if (StringUtils.hasText(configModeStr)) {</span><br><span class="line">                this.configMode = ConfigMode.valueOf(configModeStr.toUpperCase());</span><br><span class="line">            }</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new IllegalArgumentException(msg, e);</span><br><span class="line">        }</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line">// Step 2-2  : Environment &#x90E8;&#x5206;</span><br><span class="line">public void initialize() throws IllegalStateException {</span><br><span class="line">        if (initialized.compareAndSet(false, true)) {</span><br><span class="line">            this.propertiesConfiguration = new PropertiesConfiguration();</span><br><span class="line">            this.systemConfiguration = new SystemConfiguration();</span><br><span class="line">            this.environmentConfiguration = new EnvironmentConfiguration();</span><br><span class="line">            this.externalConfiguration = new InmemoryConfiguration(&quot;ExternalConfig&quot;);</span><br><span class="line">            this.appExternalConfiguration = new InmemoryConfiguration(&quot;AppExternalConfig&quot;);</span><br><span class="line">            this.appConfiguration = new InmemoryConfiguration(&quot;AppConfig&quot;);</span><br><span class="line"></span><br><span class="line">            loadMigrationRule();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Step 2-3 : ServiceRepository &#x90E8;&#x5206;</span><br></pre></td></tr></table></figure>

<p><strong>PIC21005 : FrameworkExt &#x5BF9;&#x8C61;&#x5217;&#x8868;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/16486906da2ce44c8ffb53ec9d1aba90e245f43280970fe5cd09f5bd03fec7ad" alt="Dubbo-Framaket-module.png"></p>
<h4 id="3-3-2-startConfigCenter-&#x7B80;&#x8FF0;"><a href="#3-3-2-startConfigCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.2 startConfigCenter &#x7B80;&#x8FF0;"></a>3.3.2 startConfigCenter &#x7B80;&#x8FF0;</h4><p>&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x603B;&#x5171;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;3&#x6B65; :</p>
<ol>
<li>&#x5206;&#x522B;&#x52A0;&#x8F7D; ApplicationConfig &#x548C; ConfigCenterConfig</li>
<li>&#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E;</li>
<li>&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startConfigCenter() {</span><br><span class="line"></span><br><span class="line">    // Step 1 : &#x5904;&#x7406;&#x5BF9;&#x5E94;&#x7684; Config , &#x6B64;&#x5904;&#x7B80;&#x5355;&#x4E00;&#x70B9;&#x8BF4;&#x5206;&#x4E3A;2&#x4E2A;&#x7C7B;&#x578B; , &#x5F88;&#x597D;&#x7684;&#x601D;&#x8DEF; , &#x540E;&#x9762;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E00; : &#x5B58;&#x5728;class &#x5BF9;&#x5E94;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x901A;&#x8FC7; class &#x7C7B;&#x578B;&#x53BB; newInstance &#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x5E94;&#x7C7B;&#x578B;&#x7684; Class &#x5BF9;&#x8C61;</span><br><span class="line">    // 2. &#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684; refush &#x8FDB;&#x884C;&#x5237;&#x65B0;&#x5904;&#x7406; (TODO : &#x540E;&#x7EED;&#x5206;&#x6790; , &#x5C31;&#x662F;&#x914D;&#x7F6E;&#x7684;&#x91CD;&#x5199;&#x6D41;&#x7A0B;)</span><br><span class="line">    // 3. &#x7F13;&#x5B58;&#x5230; configManager &#x4E2D;</span><br><span class="line">    </span><br><span class="line">    // &gt; &#x7C7B;&#x578B;&#x4E8C; : &#x4E0D;&#x5B58;&#x5728;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;</span><br><span class="line">    // 1. &#x76F4;&#x63A5;&#x4ECE; ApplicationModel &#x4E2D;&#x83B7;&#x53D6; Environment</span><br><span class="line">    // 2. newInstance &#x5B9E;&#x4F8B;&#x5316;&#x540E;&#x653E;&#x5728; configManager &#x4E2D;</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line">    loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    useRegistryAsConfigCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    // check Config Center -&gt; PS:332001</span><br><span class="line">    Collection&lt;ConfigCenterConfig&gt; configCenters = configManager.getConfigCenters();</span><br><span class="line">    if (CollectionUtils.isEmpty(configCenters)) {</span><br><span class="line">        // &#x901A;&#x5E38;&#x914D;&#x7F6E;&#x4E86;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x8FD9;&#x91CC;&#x90FD;&#x4F1A;&#x6709;&#x503C; , &#x5982;&#x679C;&#x4E3A;&#x7A7A; , &#x6B64;&#x5904; new &#x4E86;&#x4E00;&#x4E2A;&#x57FA;&#x7840;&#x5B9E;&#x73B0;</span><br><span class="line">    } else {</span><br><span class="line">        for (ConfigCenterConfig configCenterConfig : configCenters) {</span><br><span class="line">            // Step 2 : &#x5BF9; configCenterConfig &#x8FDB;&#x884C;&#x914D;&#x7F6E; , &#x540E;&#x7EED;&#x6DF1;&#x5165;</span><br><span class="line">            configCenterConfig.refresh();</span><br><span class="line">            ConfigValidationUtils.validateConfigCenterConfig(configCenterConfig);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isNotEmpty(configCenters)) {</span><br><span class="line">        CompositeDynamicConfiguration compositeDynamicConfiguration = new CompositeDynamicConfiguration();</span><br><span class="line">        </span><br><span class="line">        // &#x8FD9;&#x91CC;&#x8981;&#x5BF9; environment &#x73AF;&#x8282;&#x8FDB;&#x884C;&#x914D;&#x7F6E;</span><br><span class="line">        for (ConfigCenterConfig configCenter : configCenters) {</span><br><span class="line">            // Pass config from ConfigCenterBean to environment</span><br><span class="line">            environment.updateExternalConfigMap(configCenter.getExternalConfiguration());</span><br><span class="line">            environment.updateAppExternalConfigMap(configCenter.getAppExternalConfiguration());</span><br><span class="line"></span><br><span class="line">            // Fetch config from remote config center</span><br><span class="line">            compositeDynamicConfiguration.addConfiguration(prepareEnvironment(configCenter));</span><br><span class="line">        }</span><br><span class="line">        environment.setDynamicConfiguration(compositeDynamicConfiguration);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    // Step 3 : &#x6B64;&#x5904;&#x5BF9; Application , Monitor , Modules &#x7B49;&#x591A;&#x4E2A;&#x7EC4;&#x4EF6;&#x8FDB;&#x884C;&#x6700;&#x540E;&#x7684;&#x5237;&#x65B0; TODO</span><br><span class="line">    configManager.refreshAll();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x8865;&#x5145; : ConfigCenterConfig &#x5BF9;&#x8C61;&#x7684;&#x4F5C;&#x7528;</p>
</blockquote>
<p>&#x8BE5;&#x5BF9;&#x8C61;&#x4E2D;&#x5305;&#x542B;&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x7840;&#x914D;&#x7F6E;&#x4FE1;&#x606F; , &#x4F8B;&#x5982; protocol , address , port , cluster , namespace &#x7B49;</p>
<p><strong>&#x7075;&#x6D3B;&#x5229;&#x7528;&#x8BE5; ConfigCenterConfig &#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x96C6;&#x6210;&#x591A;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;</strong></p>
<blockquote>
<p>&#x8865;&#x5145; : PS:332001 &#x7ED3;&#x6784;</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f7c2c606aa34f2832f92ad41f94f1658f66a8d9cde46e515530d6fea91914070" alt="image.png"></p>
<h3 id="3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;"><a href="#3-3-3-loadConfigsFromProps-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;"></a>3.3.3 loadConfigsFromProps &#x7B80;&#x8FF0;</h3><p><strong>&#x8FD9;&#x91CC;&#x548C;&#x4E0A;&#x9762;&#x5176;&#x5B9E;&#x5DEE;&#x4E0D;&#x591A; , loadConfigs &#x662F;&#x901A;&#x8FC7;&#x7279;&#x6B8A;&#x7684;&#x524D;&#x7F00;&#x5BF9;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;</strong></p>
<p>&#x4E4B;&#x524D;&#x770B;&#x8FC7;&#x591A;&#x4E2A;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x5BF9;&#x4E8E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x52A0;&#x8F7D;&#x601D;&#x8DEF; , <strong>&#x57FA;&#x672C;&#x4E0A;&#x6B8A;&#x9014;&#x540C;&#x5F52; , &#x90FD;&#x662F;&#x4EE5;&#x7C7B;&#x533A;&#x5206; , &#x901A;&#x8FC7;&#x524D;&#x7F00;&#x52A0;&#x8F7D;</strong> , &#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x5206;&#x6790;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void loadConfigsFromProps() {</span><br><span class="line"></span><br><span class="line">    // application config has load before starting config center</span><br><span class="line">    // load dubbo.applications.xxx</span><br><span class="line">    loadConfigs(ApplicationConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.modules.xxx</span><br><span class="line">    loadConfigs(ModuleConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.monitors.xxx</span><br><span class="line">    loadConfigs(MonitorConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metricses.xxx</span><br><span class="line">    loadConfigs(MetricsConfig.class);</span><br><span class="line"></span><br><span class="line">    // load multiple config types:</span><br><span class="line">    // load dubbo.protocols.xxx</span><br><span class="line">    loadConfigs(ProtocolConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.registries.xxx</span><br><span class="line">    loadConfigs(RegistryConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.providers.xxx</span><br><span class="line">    loadConfigs(ProviderConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.consumers.xxx</span><br><span class="line">    loadConfigs(ConsumerConfig.class);</span><br><span class="line"></span><br><span class="line">    // load dubbo.metadata-report.xxx</span><br><span class="line">    loadConfigs(MetadataReportConfig.class);</span><br><span class="line"></span><br><span class="line">    // config centers has bean loaded before starting config center</span><br><span class="line">    //loadConfigs(ConfigCenterConfig.class);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;"><a href="#3-3-4-checkGlobalConfigs-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;"></a>3.3.4 checkGlobalConfigs &#x7B80;&#x8FF0;</h3><p>&#x5728;&#x8FD9;&#x4E2A;&#x73AF;&#x8282;&#x4E2D;&#x4F1A;&#x901A;&#x8FC7; ConfigValidationUtils &#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x6821;&#x9A8C; , &#x4EE5;&#x53CA;&#x7AEF;&#x53E3;&#x5904;&#x7406; , &#x6700;&#x540E;&#x901A;&#x8FC7; refresh &#x5237;&#x65B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void checkGlobalConfigs() {</span><br><span class="line">    // check config types (ignore metadata-center)</span><br><span class="line">    List&lt;Class&lt;? extends AbstractConfig&gt;&gt; multipleConfigTypes = Arrays.asList(</span><br><span class="line">        ApplicationConfig.class,</span><br><span class="line">        ProtocolConfig.class,</span><br><span class="line">        RegistryConfig.class,</span><br><span class="line">        MetadataReportConfig.class,</span><br><span class="line">        ProviderConfig.class,</span><br><span class="line">        ConsumerConfig.class,</span><br><span class="line">        MonitorConfig.class,</span><br><span class="line">        ModuleConfig.class,</span><br><span class="line">        MetricsConfig.class,</span><br><span class="line">        SslConfig.class);</span><br><span class="line"></span><br><span class="line">    for (Class&lt;? extends AbstractConfig&gt; configType : multipleConfigTypes) {</span><br><span class="line">        // &#x901A;&#x8FC7; ConfigValidationUtils &#x5BF9;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x6821;&#x9A8C;</span><br><span class="line">        checkDefaultAndValidateConfigs(configType);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check port conflicts</span><br><span class="line">    // </span><br><span class="line">    Map&lt;Integer, ProtocolConfig&gt; protocolPortMap = new LinkedHashMap&lt;&gt;();</span><br><span class="line">    for (ProtocolConfig protocol : configManager.getProtocols()) {</span><br><span class="line">        Integer port = protocol.getPort();</span><br><span class="line">        if (port == null || port == -1) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x6B64;&#x5904;&#x5982;&#x679C;&#x5B58;&#x5728;&#x7AEF;&#x53E3;&#x51B2;&#x7A81; , &#x8FD9;&#x91CC;&#x4F1A;&#x76F4;&#x63A5;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">        ProtocolConfig prevProtocol = protocolPortMap.get(port);</span><br><span class="line">        if (prevProtocol != null) {</span><br><span class="line">            throw new IllegalStateException</span><br><span class="line">        }</span><br><span class="line">        protocolPortMap.put(port, protocol);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // check reference and service</span><br><span class="line">    // &#x8FD9;&#x91CC;&#x6B63;&#x5F0F;&#x5F00;&#x59CB;&#x5904;&#x7406; reference &#x548C; DubboService , TODO : &#x540E;&#x9762;&#x5355;&#x7AE0;&#x5206;&#x6790;</span><br><span class="line">    for (ReferenceConfigBase&lt;?&gt; reference : configManager.getReferences()) {</span><br><span class="line">        reference.refresh();</span><br><span class="line">    }</span><br><span class="line">    for (ServiceConfigBase service : configManager.getServices()) {</span><br><span class="line">        service.refresh();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;"><a href="#3-3-5-startMetadataCenter-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.5 startMetadataCenter &#x7B80;&#x8FF0;"></a>3.3.5 startMetadataCenter &#x7B80;&#x8FF0;</h3><p>&#x6B64;&#x5904;&#x662F;&#x5143;&#x6570;&#x636E;&#x7684;&#x5904;&#x7406;&#x3000;, &#x5143;&#x6570;&#x636E;&#x662F;&#x65B0;&#x7279;&#x6027; , &#x53EF;&#x4EE5;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x524D;&#x7F00;&#x201C;dubbo.metadata-report&#x201D;&#x8BBE;&#x7F6E;MetadataReportConfig&#x7684;&#x5C5E;&#x6027;</p>
<blockquote>
<p>&#x4EC0;&#x4E48;&#x662F;&#x5143;&#x6570;&#x636E; :</p>
</blockquote>
<ul>
<li>&#x5143;&#x6570;&#x636E;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x8F7B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x538B;&#x529B;&#xFF0C;&#x5C06;&#x90E8;&#x5206;&#x5B58;&#x50A8;&#x5728;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x7684;&#x5185;&#x5BB9;&#x653E;&#x5230;&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x3002;</li>
<li>&#x5143;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x7684;&#x6570;&#x636E;&#x53EA;&#x662F;&#x7ED9;&#x81EA;&#x5DF1;&#x4F7F;&#x7528;&#x7684; , &#x6539;&#x52A8;&#x65E0;&#x9700;&#x5237;&#x65B0;</li>
<li>&#x4E0D;&#x9700;&#x8981;&#x76D1;&#x542C;&#x548C;&#x901A;&#x77E5; , &#x6781;&#x5927;&#x7684;&#x51CF;&#x5C11;&#x4E86;&#x6027;&#x80FD;&#x7684;&#x6D88;&#x8017;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void startMetadataCenter() {</span><br><span class="line"></span><br><span class="line">    useRegistryAsMetadataCenterIfNecessary();</span><br><span class="line"></span><br><span class="line">    ApplicationConfig applicationConfig = getApplication();</span><br><span class="line"></span><br><span class="line">    String metadataType = applicationConfig.getMetadataType();</span><br><span class="line">    // FIXME, multiple metadata config support.</span><br><span class="line">    Collection&lt;MetadataReportConfig&gt; metadataReportConfigs = configManager.getMetadataConfigs();</span><br><span class="line">    if (CollectionUtils.isEmpty(metadataReportConfigs)) {</span><br><span class="line">        //... &#x8FD9;&#x91CC;&#x914D;&#x7F6E;&#x4E86;&#x8FDC;&#x7A0B;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x65F6;&#x9ED8;&#x8BA4;&#x90FD;&#x4F1A;&#x6709;&#x6570;&#x636E; , &#x6CA1;&#x6709;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    for (MetadataReportConfig metadataReportConfig : metadataReportConfigs) {</span><br><span class="line">        // &lt;dubbo:metadata-report address=&quot;zookeeper://127.0.0.1:2181&quot; id=&quot;metadata-center-zookeeper-2181&quot; /&gt;</span><br><span class="line">        ConfigValidationUtils.validateMetadataConfig(metadataReportConfig);</span><br><span class="line">        if (!metadataReportConfig.isValid()) {</span><br><span class="line">            continue;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        // &#x901A;&#x8FC7; instance &#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x5904;&#x7406;</span><br><span class="line">        MetadataReportInstance.init(metadataReportConfig);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="3-3-6-initMetadataService-&#x7B80;&#x8FF0;"><a href="#3-3-6-initMetadataService-&#x7B80;&#x8FF0;" class="headerlink" title="3.3.6 initMetadataService &#x7B80;&#x8FF0;"></a>3.3.6 initMetadataService &#x7B80;&#x8FF0;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;    private void initMetadataService() {</span><br><span class="line">//        startMetadataCenter();</span><br><span class="line">        this.metadataService = getDefaultExtension();</span><br><span class="line">        this.metadataServiceExporter = new ConfigurableMetadataServiceExporter(metadataService);</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<h3 id="3-4-exportServices"><a href="#3-4-exportServices" class="headerlink" title="3.4 exportServices"></a>3.4 exportServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x4F53;&#x7CFB;</p>
<h3 id="3-5-referServices"><a href="#3-5-referServices" class="headerlink" title="3.5 referServices"></a>3.5 referServices</h3><p>&#x8BE6;&#x89C1;&#x670D;&#x52A1;&#x53D1;&#x73B0;&#x4F53;&#x7CFB;</p>
<h3 id="3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"><a href="#3-6-onStart-&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;" class="headerlink" title="3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;"></a>3.6 onStart &#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;&#x6269;&#x5C55;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;private void onStart() {</span><br><span class="line">	ExtensionLoader&lt;DubboBootstrapStartStopListener&gt; exts = getExtensionLoader(DubboBootstrapStartStopListener.class);</span><br><span class="line">	exts.getSupportedExtensionInstances().forEach(ext -&gt; ext.onStart(this));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x8FD9;&#x4E00;&#x7BC7;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x603B;&#x7ED3;, &#x4EE5;&#x53CA;&#x5BF9;&#x5168;&#x90E8;&#x7684;&#x6982;&#x5FF5;&#x6709;&#x4E2A;&#x521D;&#x6B65;&#x7684;&#x7406;&#x89E3; , &#x540E;&#x9762;&#x4F1A;&#x9010;&#x6B65;&#x5B8C;&#x5584;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x7684;&#x7EC6;&#x8282;&#x70B9; , &#x4EE5;&#x53CA;&#x5BF9;&#x5176;&#x4EE3;&#x7801;&#x7684;&#x5B66;&#x4E60;&#x548C;&#x4F7F;&#x7528;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9ba9fb87e288d1434a787b82881e4c0404d73c3eb3e77ee7a247970bc0cbecd9" alt="image.png"></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/27b9805e4b2f109ec422efdd1f2caab8.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7013595058125406238.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7013595058125406238.html" itemprop="url">Android Native   内存问题的终极武器——MT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-30T13:32:13+08:00">
                2021-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>&#x672C;&#x6587;&#x5206;&#x6790;&#x57FA;&#x4E8E;Android S (12)</code></p>
<h2 id="&#x524D;&#x8A00;"><a href="#&#x524D;&#x8A00;" class="headerlink" title="&#x524D;&#x8A00;"></a>&#x524D;&#x8A00;</h2><p>&#x6C47;&#x7F16;&#x3001;C&#x548C;C++&#x672C;&#x8D28;&#x4E0A;&#x90FD;&#x662F;&#x5185;&#x5B58;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x8BED;&#x8A00;&#xFF0C;&#x56E0;&#x6B64;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x65E0;&#x5FC3;&#x4E4B;&#x8FC7;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x975E;&#x6CD5;&#x8BBF;&#x95EE;&#x3001;&#x5185;&#x5B58;&#x8E29;&#x8E0F;&#x7B49;&#x591A;&#x79CD;&#x95EE;&#x9898;&#x3002;&#x8FD9;&#x4E9B;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x4E00;&#x65B9;&#x9762;&#x4F1A;&#x5F71;&#x54CD;&#x7528;&#x6237;&#x7684;&#x4F7F;&#x7528;&#x4F53;&#x9A8C;&#xFF08;&#x8FDB;&#x7A0B;&#x5D29;&#x6E83;&#x3001;&#x7CFB;&#x7EDF;&#x91CD;&#x542F;&#x7B49;&#xFF09;&#xFF1B;&#x53E6;&#x4E00;&#x65B9;&#x9762;&#x4E5F;&#x4F1A;&#x88AB;&#x9ED1;&#x5BA2;&#x5229;&#x7528;&#xFF0C;&#x589E;&#x52A0;&#x5165;&#x4FB5;&#x7684;&#x673A;&#x4F1A;&#x3002;&#x6240;&#x4EE5;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x4E0D;&#x4EC5;&#x662F;&#x7A33;&#x5B9A;&#x6027;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E5F;&#x662F;&#x5B89;&#x5168;&#x6027;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x5982;&#x679C;&#x8003;&#x8651;&#x5230;&#x540E;&#x671F;&#x5B89;&#x5168;&#x8865;&#x4E01;&#x5E26;&#x6765;&#x7684;&#x5347;&#x7EA7;&#x5F71;&#x54CD;&#xFF0C;&#x5B83;&#x6216;&#x8BB8;&#x4E5F;&#x80FD;&#x7B97;&#x5F97;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x7ECF;&#x6D4E;&#x95EE;&#x9898;&#x3002;</p>
<p>Android&#x7684;native&#x4E16;&#x754C;&#x57FA;&#x672C;&#x7531;C++&#x8BED;&#x8A00;&#x6784;&#x6210;&#xFF08;&#x4E5F;&#x5305;&#x542B;&#x5C11;&#x91CF;&#x7684;C&#x3001;&#x6C47;&#x7F16;&#x548C;S&#x4E0A;&#x5F15;&#x5165;&#x7684;Rust&#xFF09;&#xFF0C;&#x5176;&#x4EE3;&#x7801;&#x91CF;&#x751A;&#x81F3;&#x5360;&#x5230;&#x4E86;&#x5E73;&#x53F0;&#x603B;&#x4EE3;&#x7801;&#x91CF;&#x7684;70%&#x3002;&#x56E0;&#x6B64;&#xFF0C;Google&#x5728;&#x8FD9;&#x4E9B;&#x5E74;&#x91CC;&#x7814;&#x53D1;&#x4E86;&#x5404;&#x79CD;&#x5DE5;&#x5177;&#xFF0C;&#x76EE;&#x7684;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x9AD8;&#x6548;&#x5730;&#x53D1;&#x73B0;&#x548C;&#x89E3;&#x51B3;&#x5404;&#x79CD;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x3002;&#x4ECE;&#x6700;&#x65E9;&#x671F;&#x91C7;&#x7528;&#x5F00;&#x6E90;&#x4E16;&#x754C;&#x91CC;&#x7684;Valgrind&#x5DE5;&#x5177;&#xFF0C;&#x5230;Android N(7)&#x4E0A;&#x81EA;&#x4E3B;&#x7814;&#x53D1;&#x7684;Address Sanitizer(ASan)&#xFF0C;Android Q(10)&#x4E0A;&#x5F15;&#x5165;&#x7684;Hardware Address Sanitizer(HWASan)&#xFF0C;&#x548C;&#x6700;&#x65B0;Android S(12)&#x4E0A;&#x5F15;&#x5165;&#x7684;ARM Memory Tagging Extension(MTE)&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1747db38aa73a3957af3b36416a89bfbd26989c7b843ad4f92ad9873b69a4657" alt="&#x5DE5;&#x5177;&#x7684;&#x6F14;&#x8FDB;&#x8FC7;&#x7A0B;.jpg"></p>
<p>ASan&#x548C;HWASan&#x7531;Google&#x81EA;&#x4E3B;&#x5F00;&#x53D1;&#xFF0C;MTE&#x7531;Google&#x548C;ARM&#x8054;&#x5408;&#x5F00;&#x53D1;&#x3002;&#x5C3D;&#x7BA1;&#x8FD9;&#x4E09;&#x79CD;&#x5DE5;&#x5177;&#x7684;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x5404;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x5B83;&#x4EEC;&#x5E95;&#x5C42;&#x7684;&#x601D;&#x60F3;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x81F4;&#x7684;&#x3002;&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;&#x8FD9;&#x4E9B;&#x5DE5;&#x5177;&#x7684;&#x5DE5;&#x4F5C;&#x8FC7;&#x7A0B;&#x53EA;&#x6709;&#x4E24;&#x6B65;&#xFF1A;</p>
<ol>
<li>&#x5728;&#x5185;&#x5B58;&#x5206;&#x914D;&#x65F6;&#x4E3A;&#x5B83;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x7279;&#x7684;tag(&#x6807;&#x7B7E;)&#x3002;</li>
<li>&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x65F6;&#x53BB;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5408;&#x89C4;&#x3002;</li>
</ol>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x6846;&#x67B6;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x6BCF;&#x4E2A;&#x5DE5;&#x5177;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5176;&#x5B9E;&#x90FD;&#x5728;&#x56DE;&#x7B54;&#x4E0B;&#x8FF0;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>tag&#x5982;&#x4F55;&#x751F;&#x6210;&#xFF1F;</li>
<li>tag&#x5982;&#x4F55;&#x5B58;&#x50A8;&#xFF1F;</li>
<li>tag&#x662F;&#x5426;&#x5408;&#x89C4;&#x7684;&#x5224;&#x636E;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x4EE5;ASan&#x4E3A;&#x4F8B;&#xFF0C;&#x56DE;&#x7B54;&#x4E0A;&#x8FF0;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>
<ol>
<li>tag&#x7531;&#x5355;&#x5B57;&#x8282;&#x8868;&#x793A;&#xFF0C;&#x53EF;&#x4EE5;&#x53CD;&#x6620;8&#x4E2A;&#x771F;&#x5B9E;&#x5185;&#x5B58;&#x5B57;&#x8282;&#x7684;&#x72B6;&#x6001;&#x3002;&#x751F;&#x6210;&#x65F6;&#x6839;&#x636E;&#x8BE5;&#x5757;&#x5185;&#x5B58;&#x7684;&#x5B9E;&#x9645;&#x72B6;&#x6001;&#x9009;&#x53D6;tag&#x503C;&#xFF0C;&#x56E0;&#x6B64;tag&#x503C;&#x5177;&#x6709;&#x4E8B;&#x5148;&#x89C4;&#x5B9A;&#x7684;&#x542B;&#x4E49;&#x3002;0x00&#x8868;&#x793A;8&#x4E2A;&#x5B57;&#x8282;&#x5747;&#x53EF;&#x8BBF;&#x95EE;&#xFF0C;0x01&#x8868;&#x793A;8&#x4E2A;&#x5B57;&#x8282;&#x4E2D;&#x53EA;&#x6709;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#xFF0C;0xFD&#x8868;&#x793A;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x5DF2;&#x7ECF;&#x88AB;&#x91CA;&#x653E;&#x3002;</li>
</ol>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1391517e4a533df420a2785aef7c5600418288eb06255b0b05c953f4ee14362c" alt="ASAN&#x57FA;&#x672C;&#x6982;&#x5FF5;.jpg"></p>
<ol start="2">
<li>tag&#x503C;&#x5B58;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x5757;&#x533A;&#x57DF;&#x79F0;&#x4E3A;shadow memory&#xFF0C;&#x5B83;&#x548C;&#x7528;&#x6237;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5185;&#x5B58;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x56FA;&#x5B9A;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5185;&#x5B58;&#x7684;tag&#x503C;&#x4E3A;0x00&#xFF0C;&#x5219;&#x8BBF;&#x95EE;&#x5408;&#x89C4;&#x3002;&#x5982;&#x679C;&#x662F;0x01&#xFF0C;&#x5219;&#x9700;&#x5224;&#x65AD;&#x6B64;&#x6B21;&#x8BBF;&#x95EE;&#x662F;&#x5426;&#x53EA;&#x8BBF;&#x95EE;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5219;&#x4E0D;&#x5408;&#x89C4;&#xFF08;&#x5C5E;&#x4E8E;&#x8D8A;&#x754C;&#x884C;&#x4E3A;&#xFF09;&#x3002;&#x5982;&#x679C;&#x662F;0x00~0x07&#x4EE5;&#x5916;&#x7684;&#x5176;&#x4ED6;&#x503C;&#xFF0C;&#x5219;&#x4E0D;&#x5408;&#x89C4;&#x3002;</li>
</ol>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x601D;&#x8003;&#x4E00;&#x4E0B;&#xFF0C;&#x6240;&#x8C13;&#x7684;&#x662F;&#x5426;&#x5408;&#x89C4;&#x5230;&#x5E95;&#x5728;&#x5224;&#x65AD;&#x4EC0;&#x4E48;&#xFF1F;&#x5176;&#x5B9E;&#x5B83;&#x771F;&#x6B63;&#x60F3;&#x5224;&#x65AD;&#x7684;&#x662F;&#x5185;&#x5B58;&#x7684;&#x6240;&#x6709;&#x6743;&#x95EE;&#x9898;&#x3002;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x5230;&#x5E95;&#x5C5E;&#x4E8E;&#x8C01;&#xFF1F;&#x6211;&#x4EEC;&#x4EE5;&#x6700;&#x5BB9;&#x6613;&#x53D1;&#x751F;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x7684;&#x5806;&#x4E3A;&#x4F8B;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x8C03;&#x7528;malloc&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x800C;&#x540E;&#x7EED;&#x6240;&#x6709;&#x7684;&#x5185;&#x5B58;&#x64CD;&#x4F5C;&#x90FD;&#x57FA;&#x4E8E;&#x8BE5;&#x5730;&#x5740;&#x3002;&#x90A3;&#x4E48;&#x8FD9;&#x65F6;&#xFF0C;&#x865A;&#x62DF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x201C;&#x5C5E;&#x4E8E;&#x8C01;&#x201D;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#x5B9E;&#x9645;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x201C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x6307;&#x9488;&#x201D;&#x3002;&#x6307;&#x9488;&#x548C;&#x6240;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x4E4B;&#x95F4;&#x5982;&#x4F55;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#xFF1F;&#x6700;&#x76F4;&#x63A5;&#x7684;&#x60F3;&#x6CD5;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x201C;&#x864E;&#x7B26;&#x201D;&#xFF0C;&#x6307;&#x9488;&#x548C;&#x5185;&#x5B58;&#x5404;&#x6301;&#x6709;&#x4E00;&#x4E2A;tag&#xFF0C;&#x6839;&#x636E;&#x4E8C;&#x8005;&#x662F;&#x5426;&#x4E00;&#x81F4;&#x6765;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#x3002;&#x5728;32&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x6307;&#x9488;&#x503C;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x6BD4;&#x7279;&#x90FD;&#x88AB;&#x7528;&#x4E8E;&#x5BFB;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x6CA1;&#x6709;&#x591A;&#x4F59;&#x7684;&#x6BD4;&#x7279;&#x6765;&#x8BB0;&#x5F55;&#x6240;&#x6709;&#x6743;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#xFF08;tag&#xFF09;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x5C31;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x5BF9;&#x6BD4;&#x6765;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#x3002;&#x800C;&#x5728;64&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x5730;&#x5740;&#x53EA;&#x6709;&#x4F4E;48&#x4F4D;&#x7528;&#x4E8E;&#x5BFB;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x9AD8;&#x6BD4;&#x7279;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5B58;&#x50A8;tag&#x3002;HWASan&#x548C;MTE&#x90FD;&#x91C7;&#x7528;&#x4E86;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E5F;&#x9650;&#x5B9A;&#x4E86;&#x5B83;&#x4EEC;&#x53EA;&#x80FD;&#x7528;&#x4E8E;64&#x4F4D;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E0D;&#x8FC7;&#x7531;&#x4E8E;tag&#x7684;&#x53EF;&#x9009;&#x8303;&#x56F4;&#x6709;&#x9650;&#xFF0C;&#x56E0;&#x6B64;&#x68C0;&#x6D4B;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x6F0F;&#x68C0;&#x7387;(false-negatives)&#x3002;32&#x4F4D;&#x8FDB;&#x7A0B;&#x4E2D;&#x6CA1;&#x529E;&#x6CD5;&#x5224;&#x65AD;&#x6240;&#x6709;&#x6743;&#xFF0C;&#x53EA;&#x80FD;&#x9000;&#x800C;&#x6C42;&#x5176;&#x6B21;&#xFF0C;&#x7ED9;&#x6BCF;&#x5757;&#x5185;&#x5B58;&#x6807;&#x8BB0;&#x72B6;&#x6001;&#xFF0C;&#x53EA;&#x8981;&#x8BBF;&#x95EE;&#x7279;&#x5B9A;&#x72B6;&#x6001;&#x7684;&#x5185;&#x5B58;&#x5C31;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;ASan&#x6240;&#x91C7;&#x7528;&#x7684;&#x7B56;&#x7565;&#x3002;</p>
<p>&#x5173;&#x4E8E;ASan&#x548C;HWASan&#x7684;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#xFF0C;&#x5728;&#x6B64;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x3002;&#x4EC5;&#x8D34;&#x51E0;&#x5F20;&#x65B0;&#x753B;&#x7684;&#x56FE;&#xFF0C;&#x6709;&#x9700;&#x8981;&#x7684;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6211;&#x4E4B;&#x524D;&#x7684;<a href="https://dev.newban.cn/6844904111570157575">&#x6587;&#x7AE0;</a>&#x3002;</p>
<p><strong>[ASan&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ee67e8545557af6a2354b4e918835919bacf41c90f823d26b02026fca09ef109" alt="ASAN&#x56FE;&#x4F8B;.png"></p>
<p><strong>[HWASan&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2e57aa7938d2547d25e1a6cf3dc3e390fe27eddcf219b401b66109551e5bbc11" alt="HWASAN&#x56FE;&#x4F8B;.png"></p>
<p><strong>[HWASan&#x8BBF;&#x95EE;&#x8D8A;&#x754C;&#x7684;&#x60C5;&#x51B5;]</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/5e0e09747359105bf14902f9c3c2aab5a1a833ba5f1af3aa120ff2810ab3e971" alt="HWASAN&#x9519;&#x8BEF;.png"></p>
<p>&#x4E0D;&#x8FC7;&#x5F53;&#x521D;&#x8FD9;&#x7BC7;<a href="https://dev.newban.cn/6844904111570157575">&#x6587;&#x7AE0;</a>&#x6709;&#x4E9B;&#x6D45;&#x8868;&#xFF0C;&#x901A;&#x7BC7;&#x90FD;&#x5728;&#x8BB2;&#x8FF0;&#x201D;&#x662F;&#x4EC0;&#x4E48;&#x201C;&#xFF0C;&#x800C;&#x5C11;&#x4E86;&#x201D;&#x4E3A;&#x4EC0;&#x4E48;&#x201C;&#x7684;&#x601D;&#x8003;&#x3002;&#x56E0;&#x6B64;&#x4ECA;&#x5E74;&#x5728;&#x7814;&#x7A76;MTE&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4ED4;&#x7EC6;&#x601D;&#x8003;&#x4E86;&#x5DE5;&#x5177;&#x7684;&#x5E95;&#x5C42;&#x903B;&#x8F91;&#xFF0C;&#x603B;&#x7ED3;&#x51FA;&#x4E86;&#x4E0A;&#x8FF0;&#x7684;&#x4E24;&#x4E2A;&#x6B65;&#x9AA4;&#x548C;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x6309;&#x7167;&#x8FD9;&#x6837;&#x4E00;&#x79CD;&#x601D;&#x8003;&#x6A21;&#x5F0F;&#xFF0C;&#x4FBF;&#x53EF;&#x4EE5;&#x5C06;Google&#x5F00;&#x53D1;&#x7684;&#x4E09;&#x4E2A;&#x5DE5;&#x5177;&#x7EB3;&#x4E8E;&#x7EDF;&#x4E00;&#x7684;&#x6846;&#x67B6;&#x4E4B;&#x4E0B;&#xFF0C;&#x4E5F;&#x66F4;&#x5BB9;&#x6613;&#x660E;&#x767D;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x548C;&#x5404;&#x81EA;&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#x3002;</p>
<h2 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h2><p>MTE&#x662F;ARM&#x65B0;&#x67B6;&#x6784;&#xFF08;&#x2265;ARMv8.5&#xFF09;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6027;&#x3002;&#x867D;&#x7136;&#x5B83;&#x9700;&#x8981;ARM&#x67B6;&#x6784;&#x5C42;&#x9762;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x4F46;&#x8FD9;&#x9879;&#x5DE5;&#x4F5C;&#x5176;&#x5B9E;&#x4E00;&#x76F4;&#x5728;&#x7531;Google&#x4E3B;&#x5BFC;&#x3002;2018&#x5E74;&#xFF0C;Google&#x4E13;&#x95E8;&#x5199;&#x4E86;&#x300A;<a href="/external_links/ee77373fbabcebcb80272fcff569783c.html" target="blank" rel="noopener">Memory Tagging and how it improves C/C++ memory safety</a>&#x300B;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x9610;&#x8FF0;&#x4E86;memory tagging&#x5728;&#x8F6F;&#x4EF6;&#x548C;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x4E0D;&#x540C;&#x5B9E;&#x73B0;&#x548C;&#x6027;&#x80FD;&#x6BD4;&#x8F83;&#xFF0C;&#x5E76;&#x5021;&#x8BAE;&#x67B6;&#x6784;&#x5382;&#x5546;&#x4EEC;&#x90FD;&#x96C6;&#x6210;memory tagging&#x7684;&#x529F;&#x80FD;&#x3002;&#x4E4B;&#x540E;Google&#x548C;ARM&#x901A;&#x529B;&#x5408;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x5728;v8.5&#x7684;&#x67B6;&#x6784;&#x4E0A;&#x5B9E;&#x73B0;&#x4E86;MTE&#x7684;&#x529F;&#x80FD;&#x3002;&#x4E0D;&#x8FC7;&#x82AF;&#x7247;&#x7684;&#x751F;&#x4EA7;&#x4E00;&#x822C;&#x90FD;&#x665A;&#x4E8E;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#xFF0C;&#x6240;&#x4EE5;MTE&#x6700;&#x7EC8;&#x9762;&#x5411;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x7B49;&#x4E0A;&#x4E00;&#x4F1A;&#x513F;&#x3002;</p>
<p>MTE&#x7684;&#x539F;&#x7406;&#x548C;HWASan&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#x548C;tag&#x7684;&#x751F;&#x6210;&#x5B58;&#x50A8;&#x4E0A;&#x6709;&#x4E86;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x652F;&#x6301;&#x3002;&#x9996;&#x5148;&#x662F;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#xFF1A;HWASan&#x901A;&#x8FC7;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5728;&#x6240;&#x6709;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x524D;&#x63D2;&#x5165;&#x68C0;&#x6D4B;&#x4EE3;&#x7801;&#xFF0C;&#x5C5E;&#x4E8E;&#x8F6F;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x68C0;&#x6D4B;&#xFF1B;&#x800C;MTE&#x662F;&#x5728;ldr/str&#x7684;&#x6307;&#x4EE4;&#x5185;&#x90E8;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#xFF0C;&#x6362;&#x8A00;&#x4E4B;&#xFF0C;&#x662F;&#x786C;&#x4EF6;&#x5C42;&#x9762;&#x7684;&#x68C0;&#x6D4B;&#x3002;&#x5176;&#x6B21;&#x662F;tag&#x7684;&#x751F;&#x6210;&#xFF1A;HWASan&#x901A;&#x8FC7;&#x8F6F;&#x4EF6;&#x968F;&#x673A;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x751F;&#x6210;tag&#xFF1B;&#x800C;MTE&#x662F;&#x901A;&#x8FC7;IRG&#x6307;&#x4EE4;&#xFF08;&#x2265;ARMv8.5&#x7684;&#x67B6;&#x6784;&#x624D;&#x6709;&#x7684;&#x6307;&#x4EE4;&#xFF09;&#x6765;&#x751F;&#x6210;tag&#x3002;&#x6700;&#x540E;&#x662F;tag&#x7684;&#x5B58;&#x50A8;&#xFF1A;HWASan&#x5C06;&#x5185;&#x5B58;&#x7684;tag&#x5B58;&#x5728;shadow memory&#xFF08;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x5177;&#x6709;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF09;&#x4E2D;&#xFF0C;shadow memory&#x548C;normal memory&#x4E4B;&#x95F4;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x7531;&#x5DE5;&#x5177;&#x63D0;&#x524D;&#x8BBE;&#x5B9A;&#xFF1B;MTE&#x5C06;&#x5185;&#x5B58;&#x7684;tag&#x5B58;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x7684;&#x7279;&#x5B9A;&#x533A;&#x57DF;&#x4E2D;&#xFF08;&#x6CA1;&#x6709;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x88AB;&#x7528;&#x6237;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF09;&#xFF0C;&#x4E8C;&#x8005;&#x4E4B;&#x95F4;&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x7531;&#x786C;&#x4EF6;&#x4FDD;&#x8BC1;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;HWASan&#x662F;&#x6BCF;16bytes&#x7684;&#x5185;&#x5B58;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;tag&#xFF0C;tag&#x81EA;&#x8EAB;&#x4E3A;8bits&#xFF08;&#x6307;&#x9488;&#x4E2D;&#x7684;tag&#x5B58;&#x5728;56<del>63&#x4F4D;&#xFF09;&#x3002;MTE&#x4E5F;&#x662F;&#x6BCF;16bytes&#x7684;&#x5185;&#x5B58;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;tag&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x7684;tag&#x957F;&#x5EA6;&#x53EA;&#x6709;4bits&#xFF08;&#x6307;&#x9488;&#x4E2D;&#x7684;tag&#x5B58;&#x5728;56</del>59&#x4F4D;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x9009;&#x62E9;&#x7684;&#x6570;&#x503C;&#x66F4;&#x5C11;&#x3002;</p>
<p>&#x8FD9;&#x6837;&#x7684;&#x6539;&#x52A8;&#x5E26;&#x6765;&#x4E24;&#x4E2A;&#x9769;&#x547D;&#x6027;&#x7684;&#x4F18;&#x52BF;&#xFF1A;</p>
<ol>
<li>&#x6027;&#x80FD;&#x5927;&#x5927;&#x63D0;&#x5347;&#xFF0C;MTE&#x9996;&#x6B21;&#x5177;&#x5907;&#x4E86;&#x7EBF;&#x4E0A;&#x90E8;&#x7F72;(in production)&#x7684;&#x53EF;&#x80FD;&#x3002;</li>
<li>&#x68C0;&#x6D4B;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4EE3;&#x7801;&#x63D2;&#x6869;&#xFF0C;&#x56E0;&#x6B64;&#x4E5F;&#x65E0;&#x9700;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF0C;&#x5927;&#x5927;&#x65B9;&#x4FBF;&#x4E86;&#x4F7F;&#x7528;&#x3002;</li>
</ol>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x4E09;&#x4E2A;&#x5DE5;&#x5177;&#x7684;&#x5F00;&#x9500;&#x5BF9;&#x6BD4;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x89C2;&#x611F;&#x53D7;&#x5230;MTE&#x7684;&#x63D0;&#x5347;&#x3002;</p>
<table>
<thead>
<tr>
<th><strong>Overhead type</strong></th>
<th><strong>MTE</strong></th>
<th><strong><a href="/external_links/fcac98d79d652a5d6c020c21e6c643ea.html" target="blank" rel="noopener">HWASan</a></strong></th>
<th><strong><a href="/external_links/0ef663ea1e56bc72062d483eccfaac0a.html" target="blank" rel="noopener">ASan</a></strong></th>
</tr>
</thead>
<tbody><tr>
<td>RAM</td>
<td>3%-5%</td>
<td>10%-35%</td>
<td>~2x</td>
</tr>
<tr>
<td>CPU</td>
<td>0%-5%</td>
<td>~2x</td>
<td>~2x</td>
</tr>
<tr>
<td>Code size</td>
<td>2%-4%</td>
<td>40%-50%</td>
<td>50%-2x</td>
</tr>
</tbody></table>
<h2 id="&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;"><a href="#&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;" class="headerlink" title="&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;"></a>&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;</h2><p>MTE&#x5177;&#x6709;&#x4E24;&#x79CD;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#xFF1A;&#x540C;&#x6B65;(Synchronous)&#x548C;&#x5F02;&#x6B65;(Asynchronous)&#x3002;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x6027;&#x80FD;&#x5F00;&#x9500;&#x5927;&#xFF0C;&#x4F46;&#x68C0;&#x6D4B;&#x53CA;&#x65F6;&#xFF0C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6536;&#x96C6;&#x8BE6;&#x5C3D;&#xFF1B;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x867D;&#x7136;&#x68C0;&#x6D4B;&#x4E0D;&#x53CA;&#x65F6;&#xFF0C;&#x4F46;&#x6027;&#x80FD;&#x5F00;&#x9500;&#x5C0F;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;release&#x7248;&#x672C;&#xFF08;&#x4E5F;&#x53EF;&#x4EE5;&#x62B5;&#x5FA1;&#x5185;&#x5B58;&#x653B;&#x51FB;&#xFF09;&#x3002;</p>
<ul>
<li>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;(ldr/str)&#x65F6;&#xFF0C;&#x540C;&#x6B65;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5339;&#x914D;&#x5219;&#x89E6;&#x53D1;&#x5F02;&#x5E38;&#x3002;&#x8FDB;&#x7A0B;&#x6536;&#x5230;SIGSEGV&#x4FE1;&#x53F7;&#xFF0C;&#x5176;&#x4E2D;&#x7684; siginfo.si_code = SEGV_MTESERR &#xFF08;SERR&#x4E2D;&#x7684;S&#x8868;&#x793A;synchronous&#xFF09;&#xFF0C;siginfo.si_addr = <fault-address> &#x3002;</fault-address></li>
<li>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;&#x5728;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x65F6;&#xFF0C;&#x5F02;&#x6B65;&#x68C0;&#x6D4B;tag&#x662F;&#x5426;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5339;&#x914D;&#x5219;&#x66F4;&#x65B0;TFSR_EL1&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#x7684;TF0 bit&#x3002;&#x5F53;&#x4E0B;&#x4E00;&#x6B21;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;(&#x8C03;&#x5EA6;)&#x6216;&#x7EBF;&#x7A0B;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x65F6;,&#x7CFB;&#x7EDF;&#x4F1A;&#x53BB;&#x68C0;&#x6D4B;TFSR_EL1&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x8FDB;&#x800C;&#x4EA7;&#x751F;SIGSEGV&#x4FE1;&#x53F7;&#x3002;&#x53EA;&#x4E0D;&#x8FC7;&#x6B64;&#x65F6;&#x7684; siginfo.si_code = SEGV_MTEAERR &#xFF08;AERR&#x4E2D;&#x7684;A&#x8868;&#x793A;asynchronous&#xFF09;&#xFF0C;siginfo.si_addr = 0 &#xFF0C;&#x8868;&#x660E;&#x7CFB;&#x7EDF;&#x5E76;&#x4E0D;&#x77E5;&#x9053;&#x662F;&#x54EA;&#x4E00;&#x6761;&#x5177;&#x4F53;&#x7684;&#x6307;&#x4EE4;&#x5BFC;&#x81F4;&#x7684;&#x95EE;&#x9898;&#x3002;</li>
</ul>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x540C;&#x6B65;&#x548C;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x6027;&#x80FD;&#x5DEE;&#x5F02;&#x5462;&#xFF1F;&#x8FD9;&#x9700;&#x8981;&#x7275;&#x6D89;&#x5230;&#x6D41;&#x6C34;&#x7EBF;&#x4F18;&#x5316;&#x7684;&#x77E5;&#x8BC6;&#x3002;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x8BFB;&#x548C;&#x5199;&#xFF0C;&#x5199;&#x64CD;&#x4F5C;&#x5728;&#x6D41;&#x6C34;&#x7EBF;&#x4E2D;&#x662F;&#x53EF;&#x4EE5;&#x6709;&#x4E9B;&#x6FC0;&#x8FDB;&#x7684;&#x4F18;&#x5316;&#x7B56;&#x7565;&#x7684;&#x3002;&#x8B6C;&#x5982;&#x5C06;&#x8FDE;&#x7EED;&#x7684;&#x5199;&#x64CD;&#x4F5C;&#x5408;&#x4E3A;&#x4E00;&#x6B21;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x6216;&#x8005;&#x5C06;&#x5199;&#x64CD;&#x4F5C;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#xFF0C;&#x7A0D;&#x540E;&#x518D;&#x53D1;&#x751F;&#x5B9E;&#x9645;&#x7684;&#x5199;&#x52A8;&#x4F5C;&#x3002;&#x5BF9;&#x540C;&#x6B65;&#x68C0;&#x6D4B;&#x800C;&#x8A00;&#xFF0C;&#x5B83;&#x5FC5;&#x987B;&#x8981;&#x8BFB;&#x53D6;&#x5185;&#x5B58;&#x7684;tag&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x5728;&#x5199;&#x64CD;&#x4F5C;&#x7684;&#x540C;&#x65F6;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x8BFB;&#x64CD;&#x4F5C;&#x3002;&#x57FA;&#x4E8E;&#x5185;&#x5B58;&#x4E00;&#x81F4;&#x6027;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x8FD9;&#x5C06;&#x4F7F;&#x5F97;&#x5199;&#x64CD;&#x4F5C;&#x7684;&#x67D0;&#x4E9B;&#x4F18;&#x5316;&#x7B56;&#x7565;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;CPU&#x7684;&#x8FD0;&#x884C;&#x6548;&#x7387;&#x964D;&#x4F4E;&#x3002;&#xFF08;&#x8FD9;&#x4E00;&#x5757;&#x77E5;&#x8BC6;&#x6211;&#x53EA;&#x662F;&#x7C97;&#x6D45;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E86;&#x89E3;&#x7684;&#x670B;&#x53CB;&#x5E0C;&#x671B;&#x4E0D;&#x541D;&#x8D50;&#x6559;&#xFF09;</p>
<h2 id="&#x591A;&#x91CD;&#x542B;&#x4E49;"><a href="#&#x591A;&#x91CD;&#x542B;&#x4E49;" class="headerlink" title="&#x591A;&#x91CD;&#x542B;&#x4E49;"></a>&#x591A;&#x91CD;&#x542B;&#x4E49;</h2><p>MTE&#x6700;&#x539F;&#x59CB;&#x7684;&#x542B;&#x4E49;&#x662F;ARM&#x67B6;&#x6784;&#x91CC;&#x7684;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;ARM&#x63D0;&#x4F9B;&#x4E86;&#x8FD9;&#x79CD;&#x68C0;&#x6D4B;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F46;&#x662F;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x3001;&#x68C0;&#x6D4B;&#x4EC0;&#x4E48;&#x5185;&#x5B58;&#x662F;&#x9700;&#x8981;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x548C;&#x7F16;&#x8BD1;&#x5668;&#x914D;&#x5408;&#x7684;&#x3002;&#x56E0;&#x6B64;LLVM&#x548C;Android&#x91CC;&#x90FD;&#x9700;&#x8981;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x4EE3;&#x7801;&#xFF0C;&#x65B9;&#x80FD;&#x8BA9;MTE&#x771F;&#x6B63;&#x5730;&#x88AB;&#x5F00;&#x53D1;&#x8005;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x9996;&#x5148;&#x4ECB;&#x7ECD;&#x4E0B;LLVM&#x91CC;&#x5173;&#x4E8E;MTE&#x7684;&#x76F8;&#x5173;&#x5DE5;&#x4F5C;&#x3002;</p>
<p>&#x53EF;&#x80FD;&#x6709;&#x4EBA;&#x4F1A;&#x597D;&#x5947;&#xFF0C;&#x4E0A;&#x9762;&#x4E0D;&#x662F;&#x8BF4;&#x4E86;MTE&#x7684;&#x68C0;&#x6D4B;&#x65F6;&#x673A;&#x5DF2;&#x7ECF;&#x653E;&#x5230;ldr/str&#x6307;&#x4EE4;&#x7684;&#x5185;&#x90E8;&#x4E86;&#x4E48;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x9700;&#x8981;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x4ECB;&#x5165;&#x5462;&#xFF1F;&#x539F;&#x56E0;&#x662F;&#x4E3A;&#x4E86;&#x8FDB;&#x884C;&#x6808;&#x4E0A;&#x5185;&#x5B58;&#x7684;&#x68C0;&#x6D4B;&#x3002;&#x7531;&#x4E8E;&#x6808;&#x5BF9;&#x8C61;&#x7684;&#x5206;&#x914D;&#x6CA1;&#x6709;&#x663E;&#x793A;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x63D2;&#x6869;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x4E3A;&#x8BE5;&#x5185;&#x5B58;&#x751F;&#x6210;tag&#x3002;&#x901A;&#x8FC7;<code>-fsanitize=memtag -march=armv8.5-a+memtag</code>&#x7684;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#x5373;&#x53EF;&#x6253;&#x5F00;&#x6808;&#x5185;&#x5B58;&#x7684;&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x662F;Android&#x4E2D;&#x5173;&#x4E8E;MTE&#x7684;&#x76F8;&#x5173;&#x5DE5;&#x4F5C;&#x3002;Android&#x4E2D;MTE&#x7684;&#x68C0;&#x6D4B;&#x4E3B;&#x8981;&#x9488;&#x5BF9;&#x7684;&#x662F;&#x5806;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x96C6;&#x6210;&#x5728;&#x5206;&#x914D;&#x5668;Scudo&#x4E2D;&#xFF0C;&#x5728;&#x52A8;&#x6001;&#x5185;&#x5B58;&#x5206;&#x914D;&#x65F6;&#x4E3A;&#x5176;&#x751F;&#x6210;tag&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5F53;&#x6211;&#x4EEC;&#x8BA8;&#x8BBA;MTE&#x65F6;&#xFF0C;&#x4E00;&#x5B9A;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x8BED;&#x5883;&#xFF0C;&#x77E5;&#x9053;&#x5BF9;&#x65B9;&#x8BF4;&#x7684;&#x5230;&#x5E95;&#x662F;ARM MTE&#xFF0C;&#x8FD8;&#x662F;LLVM MTE&#xFF0C;&#x6291;&#x6216;&#x662F;Scudo MTE&#x3002;</p>
<h2 id="&#x6307;&#x4EE4;&#x7B80;&#x4ECB;"><a href="#&#x6307;&#x4EE4;&#x7B80;&#x4ECB;" class="headerlink" title="&#x6307;&#x4EE4;&#x7B80;&#x4ECB;"></a>&#x6307;&#x4EE4;&#x7B80;&#x4ECB;</h2><p>&#x4E0A;&#x9762;&#x591A;&#x6B21;&#x63D0;&#x5230;ARMv8.5&#x4EE5;&#x540E;&#x7684;&#x67B6;&#x6784;&#x4E2D;&#xFF0C;ldr/str&#x6307;&#x4EE4;&#x7684;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x4E2D;&#x96C6;&#x6210;&#x4E86;tag&#x68C0;&#x6D4B;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x786E;&#x8BA4;&#x8FD9;&#x4E00;&#x70B9;&#x5462;&#xFF1F;</p>
<p>&#x9996;&#x5148;&#x4E0B;&#x8F7D;&#x4E00;&#x4EFD;ARMv9&#x6307;&#x4EE4;&#x96C6;&#x7684;<a href="/external_links/5c9f829d3937196292243ea3589522aa.html" target="blank" rel="noopener">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#xFF0C;&#x7136;&#x540E;&#x67E5;&#x770B;ldr&#x6307;&#x4EE4;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/59d55c36741428d9408cf81af8f79a5d17fc5fbcbda01752b2a0bce71ccae652" alt="ARMv9 LDR 1.jpg"></p>
<p>&#x8FD9;&#x4E2A;operation&#x5176;&#x5B9E;&#x5C31;&#x662F;ldr&#x6307;&#x4EE4;&#x5177;&#x4F53;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x63A5;&#x7740;&#x67E5;&#x770B;Mem&#xFF0C;&#x4E00;&#x8DEF;&#x8FFD;&#x8E2A;&#x4E0B;&#x53BB;&#x53D1;&#x73B0;&#xFF1A;&#x5728;MTE enable&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F1A;&#x6700;&#x7EC8;&#x6267;&#x884C;CheckTag&#x7684;&#x52A8;&#x4F5C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2d8b6ef61140efa0cce5a3e02cafd2a3adc88c837f107520bedf01612524b8cb" alt="ARMv9 LDR 2.jpg"></p>
<p>&#x6B64;&#x5916;&#xFF0C;ARM&#x65B0;&#x7684;&#x67B6;&#x6784;&#x4E2D;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x6307;&#x4EE4;&#xFF0C;&#x65B9;&#x4FBF;&#x5FEB;&#x901F;&#x5730;&#x5BF9;tag&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;&#x8B6C;&#x5982;&#x5982;&#x4E0B;&#x4E24;&#x6761;&#x6307;&#x4EE4;&#x3002;</p>
<ul>
<li><code>IRG Xd, Xn</code> &#x5C06;<code>Xn</code> &#x62F7;&#x8D1D;&#x5230; <code>Xd</code>&#xFF0C;&#x5E76;&#x4E14;&#x4E3A;<code>Xd</code>&#x4E2D;&#x7684;&#x503C;&#x968F;&#x673A;&#x751F;&#x6210;&#x4E00;&#x4E2A;tag&#xFF0C;&#x5B58;&#x5728;&#x5B83;&#x7684;[56:59]&#x4F4D;&#x3002;</li>
<li><code>STG Xd, [Xn]</code> &#x5C06;&#x5185;&#x5B58; <code>[Xn, Xn + 16)</code>&#x7684;tag&#x66F4;&#x65B0;&#x4E3A; <code>Xd</code>&#x7684;tag&#x503C;&#x3002;</li>
</ul>
<p>ARM&#x603B;&#x5171;&#x65B0;&#x589E;&#x4E86;10&#x4F59;&#x6761;&#x6307;&#x4EE4;&#x7528;&#x4E8E;&#x652F;&#x6301;MTE&#x3002;&#x4F5C;&#x4E3A;&#x4F7F;&#x7528;&#x8005;&#x5176;&#x5B9E;&#x6CA1;&#x5FC5;&#x8981;&#x4E86;&#x89E3;&#x6BCF;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x542B;&#x4E49;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x660E;&#x767D;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x662F;&#x4E3A;&#x4E86;&#x66F4;&#x5FEB;&#x901F;&#x3001;&#x66F4;&#x65B9;&#x4FBF;&#x5730;&#x64CD;&#x4F5C;tag&#x5373;&#x53EF;&#x3002;</p>
<h2 id="Scudo&#x4E2D;&#x7684;MTE"><a href="#Scudo&#x4E2D;&#x7684;MTE" class="headerlink" title="Scudo&#x4E2D;&#x7684;MTE"></a>Scudo&#x4E2D;&#x7684;MTE</h2><h3 id="1-&#x68C0;&#x6D4B;&#x65B9;&#x5F0F;"><a href="#1-&#x68C0;&#x6D4B;&#x65B9;&#x5F0F;" class="headerlink" title="1. &#x68C0;&#x6D4B;&#x65B9;&#x5F0F;"></a>1. &#x68C0;&#x6D4B;&#x65B9;&#x5F0F;</h3><p>&#xFF08;&#x5173;&#x4E8E;Scudo&#x7684;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6211;&#x4E4B;&#x524D;&#x7684;<a href="https://dev.newban.cn/6914550038140026887">&#x6587;&#x7AE0;</a>&#xFF09;</p>
<p>Scudo&#x4E2D;&#x7684;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x4E00;&#x79CD;&#x662F;Primary allocate&#xFF0C;&#x7528;&#x4E8E;&#x5206;&#x914D;&#x5C0F;&#x5185;&#x5B58;&#xFF0C;&#x4F7F;&#x7528;&#x9891;&#x7E41;&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;Secondary allocate&#xFF0C;&#x7528;&#x4E8E;&#x5206;&#x914D;&#x5927;&#x5185;&#x5B58;(&gt;256K)&#x3002;</p>
<p>&#x6240;&#x6709;&#x5806;&#x5185;&#x5B58;&#x7684;&#x5206;&#x914D;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528;<code>Allocator::allocate</code>&#x51FD;&#x6570;&#x3002;&#x5F53;&#x5185;&#x5B58;&#x5206;&#x914D;&#x51FA;&#x6765;&#x540E;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x8C03;&#x7528;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;//Primary Allocator</span><br><span class="line">  const uptr OddEvenMask =</span><br><span class="line">	  computeOddEvenMaskForPointerMaybe(Options, BlockUptr, ClassId);</span><br><span class="line">  TaggedPtr = prepareTaggedChunk(Ptr, Size, OddEvenMask, BlockEnd);</span><br><span class="line">  storePrimaryAllocationStackMaybe(Options, Ptr);</span><br><span class="line">...</span><br><span class="line">//Secondary Allocator</span><br><span class="line">} else {</span><br><span class="line">  storeTags(reinterpret_cast&lt;uptr&gt;(Block), reinterpret_cast&lt;uptr&gt;(Ptr));</span><br><span class="line">  storeSecondaryAllocationStackMaybe(Options, Ptr, Size);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="1-1-Primary-Allocator"><a href="#1-1-Primary-Allocator" class="headerlink" title="1.1 Primary Allocator"></a>1.1 Primary Allocator</h4><p>Primary Allocator&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5757;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;Block&#x662F;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x4E14;&#x8FDE;&#x7EED;&#x6392;&#x5217;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x5176;&#x4E2D;Header&#x5B58;&#x50A8;&#x4E86;&#x8BE5;&#x5185;&#x5B58;&#x5757;&#x7684;&#x4E00;&#x4E9B;&#x5143;&#x6570;&#x636E;&#x4FBF;&#x4E8E;&#x91CA;&#x653E;&#x65F6;&#x8FDB;&#x884C;&#x72B6;&#x6001;&#x68C0;&#x6D4B;&#xFF0C;&#x800C;&#x771F;&#x5B9E;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x7684;&#x6307;&#x9488;&#x4E3A;Ptr&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1e6378b424f944ee9144edcefdebea22fef7d9fd6e8e96bf15da3078687d2daa" alt="Chunk Tag.png"></p>
<p>&#x5BF9;&#x4E8E;&#x5206;&#x914D;&#x51FA;&#x6765;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;Primary Allocator&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x7ED9;&#x8FD4;&#x56DE;&#x5730;&#x5740;(&#x6307;&#x9488;)Ptr&#x589E;&#x52A0;tag&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;const uptr OddEvenMask =</span><br><span class="line">    computeOddEvenMaskForPointerMaybe(Options, BlockUptr, BlockSize);</span><br><span class="line">TaggedPtr = prepareTaggedChunk(Ptr, Size, OddEvenMask, BlockEnd);</span><br></pre></td></tr></table></figure>

<p><code>OddEvenMask</code>&#x5148;&#x6309;&#x4E0B;&#x4E0D;&#x8868;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EA;&#x5173;&#x5FC3;<code>prepareTaggedChunk</code>&#x3002;&#x5176;&#x5185;&#x90E8;&#x6240;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x6B63;&#x662F;&#x4E3A;&#x521A;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x751F;&#x6210;tag&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;inline void *prepareTaggedChunk(void *Ptr, uptr Size, uptr ExcludeMask,</span><br><span class="line">                                uptr BlockEnd) {</span><br><span class="line">  // Prepare the granule before the chunk to store the chunk header by setting</span><br><span class="line">  // its tag to 0. Normally its tag will already be 0, but in the case where a</span><br><span class="line">  // chunk holding a low alignment allocation is reused for a higher alignment</span><br><span class="line">  // allocation, the chunk may already have a non-zero tag from the previous</span><br><span class="line">  // allocation.</span><br><span class="line">  __asm__ __volatile__(&quot;.arch_extension memtag; stg %0, [%0, #-16]&quot;</span><br><span class="line">                       :</span><br><span class="line">                       : &quot;r&quot;(Ptr)</span><br><span class="line">                       : &quot;memory&quot;);</span><br><span class="line"></span><br><span class="line">  uptr TaggedBegin, TaggedEnd;</span><br><span class="line">  setRandomTag(Ptr, Size, ExcludeMask, &amp;TaggedBegin, &amp;TaggedEnd);</span><br><span class="line"></span><br><span class="line">  // Finally, set the tag of the granule past the end of the allocation to 0,</span><br><span class="line">  // to catch linear overflows even if a previous larger allocation used the</span><br><span class="line">  // same block and tag. Only do this if the granule past the end is in our</span><br><span class="line">  // block, because this would otherwise lead to a SEGV if the allocation</span><br><span class="line">  // covers the entire block and our block is at the end of a mapping. The tag</span><br><span class="line">  // of the next block&apos;s header granule will be set to 0, so it will serve the</span><br><span class="line">  // purpose of catching linear overflows in this case.</span><br><span class="line">  uptr UntaggedEnd = untagPointer(TaggedEnd);</span><br><span class="line">  if (UntaggedEnd != BlockEnd)</span><br><span class="line">    __asm__ __volatile__(&quot;.arch_extension memtag; stg %0, [%0]&quot;</span><br><span class="line">                         :</span><br><span class="line">                         : &quot;r&quot;(UntaggedEnd)</span><br><span class="line">                         : &quot;memory&quot;);</span><br><span class="line">  return reinterpret_cast&lt;void *&gt;(TaggedBegin);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7531;&#x4E8E;&#x9700;&#x8981;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6C47;&#x7F16;&#x6307;&#x4EE4;<code>stg</code>&#xFF0C;&#x56E0;&#x6B64;<code>prepareTaggedChunk</code>&#x4E2D;&#x5185;&#x5D4C;&#x4E86;&#x4E00;&#x4E9B;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF08;<code>setRandomTag</code>&#x51FD;&#x6570;&#x4E2D;&#x4E5F;&#x6709;&#x4E00;&#x4E9B;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF09;&#x3002;&#x8BE5;&#x51FD;&#x6570;&#x6709;&#x56DB;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x542B;&#x4E49;&#x5206;&#x522B;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>Ptr&#xFF1A;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;tag&#x7684;&#x6307;&#x9488;&#xFF0C;&#x4E5F;&#x5373;&#x5B83;&#x7684;56~59&#x4F4D;&#x5747;&#x4E3A;0&#x3002;&#x8868;&#x660E;chunk&#x7684;&#x8D77;&#x59CB;&#x5730;&#x5740;&#x3002;</li>
<li>Size&#xFF1A;&#x8981;&#x6C42;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;&#x3002;</li>
<li>ExcludeMask&#xFF1A;MTE&#x7684;tag&#x4E3A;4 bits&#xFF0C;&#x56E0;&#x6B64;&#x6709;0~15&#x5171;16&#x79CD;&#x53EF;&#x80FD;&#x3002;Android&#x9ED8;&#x8BA4;&#x4E0D;&#x9009;&#x7528;0&#xFF0C;&#x56E0;&#x6B64;&#x8FD8;&#x5269;&#x4E0B;15&#x79CD;&#x53EF;&#x80FD;&#x3002;ExcludeMask&#x7528;&#x4E8E;&#x4ECE;15&#x79CD;&#x53EF;&#x80FD;&#x4E2D;&#x518D;&#x5220;&#x53BB;&#x4E00;&#x4E9B;&#x9009;&#x62E9;&#xFF0C;&#x8B6C;&#x5982;&#x8BE5;&#x503C;&#x4E3A;0x6&#xFF0C;&#x5219;tag&#x4E0D;&#x4F1A;&#x9009;&#x62E9;1&#x6216;2&#xFF08;0x6==0b0110&#xFF0C;&#x4ECE;&#x4F4E;&#x5230;&#x9AD8;&#x7684;1&#x3001;2&#x6BD4;&#x7279;&#x5747;&#x4E3A;1&#xFF09;&#x3002;</li>
<li>BlockEnd&#xFF1A;&#x5757;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#xFF0C;&#x7531;&#x4E8E;Scudo&#x4E2D;region&#x5B58;&#x50A8;&#x7684;&#x90FD;&#x662F;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x7684;&#x5757;&#xFF0C;&#x56E0;&#x6B64;&#x5757;&#x5927;&#x5C0F;&#x53EF;&#x80FD;&#x5927;&#x4E8E;&#x8981;&#x6C42;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;&#x3002;</li>
</ul>
<p><code>prepareTaggedChunk</code>&#x4E2D;&#x7684;<code>setRandomTag</code>&#x4F1A;&#x4EE5;16bytes&#x4E3A;&#x5355;&#x4F4D;&#xFF0C;&#x5FAA;&#x73AF;&#x4E3A;chunk&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5185;&#x5B58;&#x5206;&#x914D;tag&#x3002;&#x6700;&#x7EC8;&#x7684;tag&#x60C5;&#x51B5;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/daafbcf037d176073c339ea254c4f5ce84fb1637449e0d2a184077a73094b4ad" alt="Chunk with Tag.png"></p>
<p>Tag&#x751F;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x8D8A;&#x754C;&#x7684;&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x5C31;&#x4F1A;&#x56E0;tag&#x4E0D;&#x5339;&#x914D;&#x800C;&#x53D1;&#x751F;SIGSEGV&#x3002;&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x70B9;&#xFF0C;Unused&#x5185;&#x5B58;&#x4E2D;&#x53EA;&#x5BF9;&#x7B2C;&#x4E00;&#x4E2A;16bytes&#x751F;&#x6210;&#x4E86;tag&#xFF0C;&#x8FD9;&#x6837;&#x7EBF;&#x6027;&#x7684;&#x8D8A;&#x754C;&#x5C06;&#x4F1A;100%&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#xFF0C;&#x800C;&#x975E;&#x7EBF;&#x6027;&#x7684;&#x8DE8;&#x8D8A;&#x5F0F;&#x8D8A;&#x754C;&#x5219;&#x662F;&#x6982;&#x7387;&#x6027;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x5C06;Unused&#x5185;&#x5B58;&#x5168;&#x90E8;tag&#x4E3A;0&#xFF0C;Google&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#x8BF4;&#x662F;&#x57FA;&#x4E8E;&#x6027;&#x80FD;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD9;&#x6837;&#x786E;&#x5B9E;&#x53EF;&#x80FD;&#x4F1A;&#x6F0F;&#x68C0;&#x4E00;&#x4E9B;&#x8DE8;&#x8D8A;&#x5F0F;&#x7684;&#x8D8A;&#x754C;&#x3002;&#x636E;&#x7EDF;&#x8BA1;&#xFF0C;Chromium&#x7684;&#x5F00;&#x53D1;&#x5B9E;&#x8DF5;&#x4E2D;&#x7EA6;13%&#x7684;overflow&#x662F;&#x8DE8;&#x8D8A;&#x5F0F;&#x7684;overflow&#x3002;</p>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x4E86;&#x8D8A;&#x754C;&#x7684;&#x68C0;&#x6D4B;&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x4E48;UAF(Use-After-Free)&#x662F;&#x5982;&#x4F55;&#x68C0;&#x6D4B;&#x7684;&#x5462;&#xFF1F;</p>
<p>&#x5F53;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x53BB;&#x8C03;&#x7528;Scudo&#x4E2D;&#x7684;<code>quarantineOrDeallocateChunk</code>&#x65B9;&#x6CD5;&#x3002;&#x91CA;&#x653E;&#x7684;&#x5185;&#x5B58;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;tag&#xFF0C;&#x8BE5;tag&#x6709;&#x522B;&#x4E8E;&#x4E4B;&#x524D;&#x7684;tag&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;immediate UAF&#x88AB;100%&#x5730;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x4E0D;&#x8FC7;&#x957F;&#x65F6;&#x95F4;&#x7684;UAF&#x53EF;&#x80FD;&#x4F1A;&#x56E0;&#x4E3A;&#x8BE5;&#x5185;&#x5B58;&#x7ECF;&#x5386;&#x4E86;&#x591A;&#x6B21;&#x5206;&#x914D;/&#x91CA;&#x653E;&#x800C;&#x53D1;&#x751F;&#x6F0F;&#x68C0;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x518D;&#x4ECB;&#x7ECD;&#x4E0B;<code>OddEvenMask</code>&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x6709;&#x8DA3;&#x7684;&#x77E5;&#x8BC6;&#x70B9;&#x3002;</p>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#xFF0C;&#x8FD9;&#x4E2A;mask&#x4F1A;&#x9650;&#x5236;tag&#x4ECE;&#x54EA;&#x4E9B;&#x6570;&#x4E2D;&#x968F;&#x673A;&#x9009;&#x53D6;&#x3002;&#x5BF9;&#x4E8E;&#x865A;&#x62DF;&#x5730;&#x5740;&#x8FDE;&#x7EED;&#x7684;&#x5185;&#x5B58;&#x5757;(Block)&#xFF0C;OddEvenMask&#x5C06;&#x4F1A;&#x95F4;&#x9694;&#x5730;&#x8D4B;&#x503C;&#x4E3A;0xaaaa&#x548C;0x5555&#x3002;0xa=0b1010&#xFF0C;0x5=0b0101&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x8FD9;&#x4E24;&#x4E2A;mask&#x662F;&#x5B8C;&#x5168;&#x4E92;&#x65A5;&#x7684;tag&#x96C6;&#x5408;&#x3002;OddEvenMask&#x4E3A;0xaaaa&#xFF0C;&#x5219;tag&#x53EA;&#x80FD;&#x9009;&#x62E9;&#x5947;&#x6570;&#xFF0C;&#x53CD;&#x4E4B;tag&#x53EA;&#x80FD;&#x9009;&#x62E9;&#x975E;0&#x7684;&#x5076;&#x6570;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;uptr computeOddEvenMaskForPointerMaybe(Options Options, uptr Ptr,</span><br><span class="line">                                       uptr ClassId) {</span><br><span class="line">  if (!Options.get(OptionBit::UseOddEvenTags))</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">  // If a chunk&apos;s tag is odd, we want the tags of the surrounding blocks to be</span><br><span class="line">  // even, and vice versa. Blocks are laid out Size bytes apart, and adding</span><br><span class="line">  // Size to Ptr will flip the least significant set bit of Size in Ptr, so</span><br><span class="line">  // that bit will have the pattern 010101... for consecutive blocks, which we</span><br><span class="line">  // can use to determine which tag mask to use.</span><br><span class="line">  return 0x5555U &lt;&lt; ((Ptr &gt;&gt; SizeClassMap::getSizeLSBByClassId(ClassId)) &amp; 1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x76F8;&#x90BB;&#x7684;&#x4E24;&#x4E2A;&#x5185;&#x5B58;&#x5757;&#x4E00;&#x5B9A;&#x4E0D;&#x4F1A;&#x4F7F;&#x7528;&#x76F8;&#x540C;&#x7684;tag&#xFF0C;&#x4FDD;&#x8BC1;&#x4E86;&#x76F8;&#x90BB;&#x7684;&#x8D8A;&#x754C;&#x53EF;&#x4EE5;100%&#x88AB;&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;&#x4E0D;&#x8FC7;&#x51E1;&#x4E8B;&#x6709;&#x5229;&#x6709;&#x5F0A;&#xFF0C;&#x7531;&#x4E8E;&#x6BCF;&#x4E2A;&#x5185;&#x5B58;&#x5757;tag&#x53EF;&#x9009;&#x62E9;&#x7684;&#x8303;&#x56F4;&#x7F29;&#x5C0F;&#x4E00;&#x534A;&#xFF0C;&#x56E0;&#x6B64;UAF&#x7684;&#x6F0F;&#x68C0;&#x7387;(false-negatives)&#x53CD;&#x5012;&#x63D0;&#x9AD8;&#x4E86;&#x3002;&#x8BE5;&#x7279;&#x6027;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>mallopt</code>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;<code>M_MEMTAG_TUNING</code>&#x9009;&#x9879;&#x8FDB;&#x884C;&#x9009;&#x62E9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;int mallopt(M_MEMTAG_TUNING, level)</span><br><span class="line">where level is:</span><br><span class="line">&#x25CF; M_MEMTAG_TUNING_BUFFER_OVERFLOW   &#xFF08;OddEvenMask&#x6253;&#x5F00;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#xFF09;</span><br><span class="line">&#x25CF; M_MEMTAG_TUNING_UAF               &#xFF08;OddEvenMask&#x5173;&#x95ED;&#xFF09;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-Secondary-Allocator"><a href="#1-2-Secondary-Allocator" class="headerlink" title="1.2 Secondary Allocator"></a>1.2 Secondary Allocator</h4><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2879de65a2a25e976ed822bd44cfec6ffc72ef5738ca07d83b7e5e37670d61af" alt="Secondary MTE.png"></p>
<p>Secondary Allocator&#x901A;&#x8FC7;mmap&#x5206;&#x914D;&#x51FA;&#x65B0;&#x7684;vma&#x533A;&#x57DF;&#x3002;&#x4E0A;&#x56FE;&#x4E2D;&#x7684;Content&#x662F;&#x7528;&#x6237;&#x771F;&#x5B9E;&#x6570;&#x636E;&#x5B58;&#x653E;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5B83;&#x7684;&#x7ED3;&#x675F;&#x5730;&#x5740;&#x662F;&#x6309;&#x9875;&#x5BF9;&#x9F50;&#x7684;&#x3002;&#x8D77;&#x59CB;&#x5730;&#x5740;Ptr&#x524D;&#x9762;&#x5B58;&#x653E;&#x4E24;&#x4E2A;Header&#xFF0C;&#x4E00;&#x4E2A;&#x662F;Chunk Header&#xFF0C;&#x4E0E;Primary Allocator&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF1B;&#x53E6;&#x4E00;&#x4E2A;&#x662F;LargeBlock Header&#xFF0C;&#x5C5E;&#x4E8E;Secondary&#x72EC;&#x6709;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x5176;&#x4E2D;&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x524D;&#x540E;vma&#x7684;&#x6307;&#x9488;&#xFF08;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF09;&#x3002;&#x518D;&#x5F80;&#x524D;&#x662F;&#x8865;&#x9F50;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x76F4;&#x8865;&#x9F50;&#x5230;&#x9875;&#x8FB9;&#x754C;&#x3002;&#x6B64;&#x5916;&#xFF0C;&#x524D;&#x540E;&#x518D;&#x5404;&#x52A0;&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x4FDD;&#x62A4;&#x9875;&#x3002;</p>
<p>&#x5F53;MTE&#x5F00;&#x542F;&#x540E;&#xFF0C;&#x5206;&#x914D;&#x5668;&#x4E0D;&#x4F1A;&#x4E3A;Content&#x8BBE;&#x7F6E;tag&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x7684;tag&#x4FDD;&#x6301;&#x9ED8;&#x8BA4;&#x503C;0&#x3002;Chunk Header&#x5BF9;&#x5E94;&#x7684;tag&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x503C;2&#xFF0C;LargeBlock Header&#x548C;Padding&#x5BF9;&#x5E94;&#x7684;tag&#x8BBE;&#x7F6E;&#x4E3A;&#x56FA;&#x5B9A;&#x503C;1&#x3002;&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x524D;&#x540E;&#x6EA2;&#x51FA;&#x5747;&#x53EF;&#x88AB;&#x68C0;&#x6D4B;&#xFF1A;</p>
<ul>
<li>&#x7EBF;&#x6027;Overflow&#x4F1A;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7F6E;&#x4E8E;&#x5C3E;&#x90E8;&#x7684;Guard Page&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x76F4;&#x63A5;&#x89E6;&#x53D1;SIGSEGV&#x3002;</li>
<li>&#x7EBF;&#x6027;Underflow&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x5230;Chunk Header/LargeBlock Header/Padding&#xFF0C;&#x7531;&#x4E8E;&#x5176;tag&#x4E0D;&#x4E3A;0&#xFF08;&#x800C;&#x6307;&#x9488;tag&#x4E3A;0&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x4EA7;&#x751F;SIGSEGV&#x7684;&#x9519;&#x8BEF;&#xFF1B;&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x5230;&#x5934;&#x90E8;&#x7684;Guard Page&#xFF0C;&#x5219;&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;SIGSEGV&#x3002;</li>
</ul>
<h4 id="1-3-Short-granules"><a href="#1-3-Short-granules" class="headerlink" title="1.3 Short granules"></a>1.3 Short granules</h4><p>&#x4E0A;&#x9762;&#x7684;&#x8BA8;&#x8BBA;&#x6709;&#x4E2A;&#x524D;&#x63D0;&#xFF0C;&#x5373;&#x52A8;&#x6001;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x662F;16&#x5B57;&#x8282;&#x7684;&#x6574;&#x6570;&#x500D;&#x3002;&#x53EF;&#x662F;&#x5982;&#x679C;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5462;&#xFF1F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;char *p = (char *)malloc(88);</span><br><span class="line">*(p + 89) = &apos;n&apos;;</span><br></pre></td></tr></table></figure>

<p>HWASan&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x8FDB;&#x884C;&#x66F4;&#x52A0;&#x7EC6;&#x7C92;&#x5EA6;&#x7684;&#x6EA2;&#x51FA;&#x68C0;&#x6D4B;&#xFF0C;&#x589E;&#x52A0;&#x4E86;short granules&#x7684;&#x7279;&#x6027;&#xFF0C;&#x8BE6;&#x60C5;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href="/external_links/ccdb0c808b75a882fe4b54ff5a8254e3.html" target="blank" rel="noopener">&#x6587;&#x7AE0;</a>&#x3002;&#x56E0;&#x6B64;&#x4E0A;&#x9762;&#x7684;&#x6EA2;&#x51FA;&#x60C5;&#x51B5;&#x53EF;&#x4EE5;&#x88AB;HWASan&#x68C0;&#x6D4B;&#x51FA;&#x6765;&#x3002;</p>
<p>&#x4F46;&#x662F;Scudo MTE&#x5374;&#x65E0;&#x6CD5;&#x68C0;&#x6D4B;&#x51FA;&#x8BE5;&#x9519;&#x8BEF;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x5B83;&#x5E76;&#x4E0D;&#x652F;&#x6301;short granules&#x3002;&#x7531;&#x4E8E;tag&#x5728;MTE&#x4E2D;&#x4EC5;&#x7531;4bits&#x6784;&#x6210;&#xFF0C;&#x6240;&#x4EE5;&#x652F;&#x6301;short granules&#x4F1A;&#x6781;&#x5927;&#x7684;&#x538B;&#x7F29;tag&#x9009;&#x53D6;&#x8303;&#x56F4;&#xFF0C;&#x4E5F;&#x4F1A;&#x5927;&#x5927;&#x63D0;&#x5347;&#x6F0F;&#x68C0;&#x7387;&#x3002;&#x4E24;&#x5BB3;&#x76F8;&#x6743;&#x53D6;&#x5176;&#x8F7B;&#xFF0C;Google&#x56E2;&#x961F;&#x6700;&#x7EC8;&#x653E;&#x5F03;&#x4E86;&#x5728;MTE&#x4E2D;&#x5BF9;short granules&#x7684;&#x652F;&#x6301;&#x3002;&#x4E0D;&#x8FC7;&#x597D;&#x5728;Scudo&#x5206;&#x914D;&#x51FA;&#x6765;&#x7684;Block&#x90FD;&#x662F;&#x6309;16&#x5B57;&#x8282;&#x5BF9;&#x9F50;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4FBF;&#x53D1;&#x751F;&#x4E86;&#x8FD9;&#x79CD;&#x6EA2;&#x51FA;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x8E29;&#x8E0F;&#x6709;&#x6548;&#x6570;&#x636E;&#x3002;</p>
<h4 id="1-4-&#x5C0F;&#x7ED3;"><a href="#1-4-&#x5C0F;&#x7ED3;" class="headerlink" title="1.4 &#x5C0F;&#x7ED3;"></a>1.4 &#x5C0F;&#x7ED3;</h4><p>Scudo&#x4E2D;&#x7684;MTE&#x76EE;&#x524D;&#x53EA;&#x68C0;&#x6D4B;native&#x5806;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x68C0;&#x6D4B;&#x7684;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x4E3B;&#x8981;&#x4E3A;OOB(Out-of-Bounds&#xFF0C;&#x5305;&#x542B;Underflow&#x548C;Overflow)&#x548C;UAF(Use-After-Free)&#x3002;&#x53E6;&#x5916;&#xFF0C;Scudo&#x672C;&#x8EAB;&#x4E5F;&#x652F;&#x6301;Double-Free&#x7684;&#x68C0;&#x6D4B;&#x3002;</p>
<h3 id="2-&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;"><a href="#2-&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;" class="headerlink" title="2. &#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;"></a>2. &#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#x548C;&#x6062;&#x590D;</h3><p>&#xFF08;&#x4E0D;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#xFF0C;&#x7EC6;&#x8282;&#x8F83;&#x591A;&#xFF09;</p>
<p>&#x5F53;MTE&#x8BBE;&#x7F6E;&#x4E3A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x65F6;&#xFF0C;Scudo&#x4F1A;&#x5728;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;&#x5185;&#x5B58;&#x5757;&#x7684;&#x65F6;&#x5019;&#x53BB;&#x8BB0;&#x5F55;&#x5F53;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x5B83;&#x4EEC;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x7531;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6784;&#x6210;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x5728;ARM64&#x4E0A;&#xFF0C;x29&#x5BC4;&#x5B58;&#x5668;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x5E27;&#x6307;&#x9488;FP&#xFF0C;x30&#x5BC4;&#x5B58;&#x5668;&#x53C8;&#x79F0;&#x4E3A;LR&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;&#x5728;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x65F6;&#x90FD;&#x4F1A;&#x5C06;&#x5BC4;&#x5B58;&#x5668;&#x538B;&#x6808;&#xFF0C;&#x7ED3;&#x675F;&#x65F6;&#x51FA;&#x6808;&#x3002;&#x56E0;&#x6B64;&#x6808;&#x4E2D;&#x5C31;&#x4FDD;&#x5B58;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x5E27;&#x6307;&#x9488;&#x548C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x503C;&#x901A;&#x5E38;&#x662F;&#x8FDE;&#x7EED;&#x5B58;&#x653E;&#x7684;&#xFF0C;&#x800C;&#x4E0D;&#x540C;&#x5E27;&#x7684;FP&#x53C8;&#x5448;&#x73B0;&#x51FA;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#xFF0C;&#x56E0;&#x6B64;&#x904D;&#x5386;&#x94FE;&#x8868;&#x4FBF;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E9B;&#x503C;&#x5168;&#x90E8;&#x53D6;&#x51FA;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x79F0;&#x4E3A;&#x57FA;&#x4E8E;FP&#x7684;&#x6808;&#x5E27;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x4F20;&#x7EDF;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#x8981;&#x5FEB;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x884C;&#x7684;&#x524D;&#x63D0;&#x662F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x65F6;&#x5BF9;FP&#x8FDB;&#x884C;&#x538B;&#x6808;&#xFF0C;&#x8BE5;&#x884C;&#x4E3A;&#x53EF;&#x7531;&#x7F16;&#x8BD1;&#x9009;&#x9879;<code>-fomit-frame-pointer</code>&#x548C;<code>-fno-omit-frame-pointer</code>&#x8FDB;&#x884C;&#x63A7;&#x5236;&#x3002;&#x5728;64&#x4F4D;&#x7684;Android&#x4E0A;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x5BF9;FP&#x8FDB;&#x884C;&#x538B;&#x6808;&#xFF0C;&#x56E0;&#x6B64;&#x8BE5;&#x56DE;&#x6EAF;&#x65B9;&#x6CD5;&#x6709;&#x6548;&#x3002;&#x5982;&#x679C;&#x78B0;&#x5230;&#x6CA1;&#x6709;&#x5F00;&#x542F;FP&#x538B;&#x6808;&#x7684;&#x4E09;&#x65B9;&#x5E93;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x867D;&#x7136;&#x4F1A;&#x5931;&#x6548;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x6B7B;&#x5FAA;&#x73AF;&#x6216;&#x5D29;&#x6E83;&#xFF0C;&#x53EA;&#x662F;&#x7F3A;&#x5C11;&#x4E9B;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x4E0D;&#x540C;&#x5E27;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6784;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x5B83;&#x53CD;&#x6620;&#x7684;&#x5C31;&#x662F;&#x5F53;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x4E3A;&#x4E86;&#x63A7;&#x5236;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x6240;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7EC4;&#x6210;&#x7684;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;64&#xFF0C;&#x4E5F;&#x5373;&#x6700;&#x591A;&#x5B58;&#x50A8;64&#x5E27;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x3002;&#x5BF9;&#x4E8E;&#x8C03;&#x8BD5;&#x800C;&#x8A00;&#xFF0C;64&#x5E27;&#x7684;&#x8C03;&#x7528;&#x6808;&#x5DF2;&#x7ECF;&#x8DB3;&#x591F;&#x770B;&#x51FA;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x6BCF;&#x4E2A;&#x8C03;&#x7528;&#x6808;&#x7684;&#x5927;&#x5C0F;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6CD5;&#x521B;&#x5EFA;&#x7EDF;&#x4E00;&#x7684;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x3002;&#x5982;&#x679C;&#x5C06;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x8BBE;&#x4E3A;64&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x8C03;&#x7528;&#x6808;&#x4E0D;&#x8DB3;64&#x5E27;&#x65F6;&#x4F1A;&#x6D6A;&#x8D39;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;&#x6240;&#x4EE5;&#x4E3A;&#x4E86;&#x66F4;&#x9AD8;&#x6548;&#x5730;&#x4F7F;&#x7528;&#x5185;&#x5B58;&#xFF0C;Scudo&#x4E2D;&#x7528;&#x4E00;&#x4E2A;&#x5927;&#x578B;&#x6570;&#x7EC4;&#x5B58;&#x50A8;&#x4E0B;&#x6240;&#x6709;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;&#x8BE5;&#x6570;&#x7EC4;&#x957F;&#x5EA6;&#x4E3A;524288(1&lt;&lt;19)&#xFF0C;&#x4E0D;&#x540C;&#x8C03;&#x7528;&#x6808;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x95F4;&#x4F1A;&#x63D2;&#x5165;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x8FDB;&#x884C;&#x5206;&#x9694;&#x3002;&#x8FD9;&#x4E2A;&#x7528;&#x4E8E;&#x5206;&#x9694;&#x7684;&#x5143;&#x7D20;&#x79F0;&#x4E3A;&#x201D;stack trace marker&#x201D;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x533A;&#x5206;&#x4E00;&#x4E2A;marker&#x548C;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5462;&#xFF1F;&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x6295;&#x5411;marker&#x7684;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x3002;&#x7531;&#x4E8E;PC&#x503C;&#x5728;64&#x4F4D;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x90FD;&#x662F;&#x6309;4&#x5B57;&#x8282;&#x5BF9;&#x9F50;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5176;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x5FC5;&#x7136;&#x4E3A;0&#x3002;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4EBA;&#x4E3A;&#x5730;&#x5C06;marker&#x7684;&#x6700;&#x540E;&#x4E00;&#x4F4D;&#x8BBE;&#x4E3A;1&#xFF0C;&#x4EE5;&#x533A;&#x5206;&#x5B83;&#x548C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;marker&#x7684;&#x5177;&#x4F53;&#x542B;&#x4E49;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/06c38ad2c898dd0fd4f41f3e6a8b8f6fb20bbe7805cf97a0548885f18a06e1d3" alt="Stack trace&#x6570;&#x7EC4;.png"></p>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;marker&#x4E2D;&#x7684;1~32bits&#x7528;&#x6765;&#x5B58;&#x50A8;hash&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x503C;&#x7531;&#x8C03;&#x7528;&#x6808;&#x7684;&#x6240;&#x6709;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x7ECF;&#x7531;&#x6563;&#x5217;&#x7B97;&#x6CD5;&#x5171;&#x540C;&#x8BA1;&#x7B97;&#x5F97;&#x51FA;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x8C03;&#x7528;&#x6808;&#x7684;&#x7279;&#x6B8A;ID&#x3002;</p>
<p>Primary&#x5728;&#x5206;&#x914D;&#x65F6;&#x5C06;hash&#x503C;&#x5B58;&#x5728;&#x81EA;&#x5DF1;&#x7684;Block&#x4E2D;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;Header&#x540E;&#x9762;&#x539F;&#x672C;&#x7528;&#x4E8E;&#x5BF9;&#x9F50;&#x7684;padding&#x76EE;&#x524D;&#x7528;&#x6765;&#x5B58;&#x50A8;hash&#x503C;&#x3002;Padding&#x603B;&#x957F;&#x5EA6;&#x4E3A;8&#x5B57;&#x8282;&#xFF0C;&#x5176;&#x4E2D;4&#x5B57;&#x8282;&#x5B58;&#x50A8;hash&#x503C;&#xFF0C;&#x53E6;&#x5916;4&#x5B57;&#x8282;&#x5B58;&#x50A8;&#x5206;&#x914D;&#x65F6;&#x7684;&#x7EBF;&#x7A0B;ID&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/bcae1ce7cc8d4b7366c7febffd6f808262863df25e95455b5e9ca75db30c9fdf" alt="stack trace&#x5B58;&#x50A8;.png"></p>
<p>&#x8FD9;&#x91CC;&#x7684;hash&#x503C;&#x76F8;&#x5F53;&#x4E8E;&#x8C03;&#x7528;&#x6808;&#x7684;&#x7279;&#x6B8A;ID&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5B83;&#x6765;&#x5B9A;&#x4F4D;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x5E8F;&#x53F7;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x662F;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x4E00;&#x5C42;tab&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x4E2D;&#x8F6C;&#x3002;&#x56E0;&#x4E3A;hash&#x503C;&#x672C;&#x8EAB;&#x5177;&#x6709;&#x968F;&#x673A;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x76F4;&#x63A5;&#x5C06;&#x5B83;&#x548C;&#x5177;&#x6709;&#x89C4;&#x5F8B;&#x6027;&#x6392;&#x5217;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x5173;&#x8054;&#x8D77;&#x6765;&#x3002;</p>
<p>&#x9996;&#x5148;&#x7528;hash&#x503C;&#x6A21;&#x4E0A;65536&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x4E2A;tab&#x6570;&#x7EC4;&#x7684;&#x5E8F;&#x53F7;&#x3002;&#x63A5;&#x7740;&#x53D6;&#x51FA;tab&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x5143;&#x7D20;&#x7684;&#x503C;&#x5373;&#x4E3A;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x7684;&#x5E8F;&#x53F7;&#x3002;&#x901A;&#x5E38;&#x8FD9;&#x4E2A;&#x5E8F;&#x53F7;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x5143;&#x7D20;&#x662F;&#x201D;stack trace marker&#x201D;&#xFF0C;&#x6839;&#x636E;marker&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x8C03;&#x7528;&#x6808;&#x957F;&#x5EA6;&#x4FBF;&#x53EF;&#x4EE5;&#x4F9D;&#x6B21;&#x53D6;&#x51FA;&#x540E;&#x7EED;&#x6240;&#x6709;&#x7684;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x3002;</p>
<p>&#x5F53;&#x521D;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x8BBE;&#x8BA1;&#x65F6;&#x6211;&#x5C31;&#x95EE;&#x81EA;&#x5DF1;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5C06;marker&#x7684;&#x5E8F;&#x53F7;&#x5B58;&#x5728;Block&#x4E2D;&#xFF0C;&#x800C;&#x4E00;&#x5B9A;&#x8981;&#x5B58;hash&#x503C;&#x5462;&#xFF1F;</p>
<p>&#x540E;&#x6765;&#x624D;&#x60F3;&#x660E;&#x767D;&#x539F;&#x56E0;&#x3002;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x88AB;&#x8BBE;&#x8BA1;&#x6210;Ring Buffer&#xFF0C;&#x56E0;&#x6B64;&#x5176;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x88AB;&#x5FAA;&#x73AF;&#x8986;&#x76D6;&#x3002;&#x5982;&#x679C;&#x5C06;marker&#x7684;&#x5E8F;&#x53F7;&#x5B58;&#x5728;Block&#x4E2D;&#xFF0C;&#x5219;&#x5B83;&#x53EF;&#x80FD;&#x53D6;&#x5230;&#x5B8C;&#x5168;&#x4E0D;&#x5C5E;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;&#x800C;&#x91C7;&#x7528;hash&#x503C;&#x5C31;&#x53EF;&#x4EE5;&#x89C4;&#x907F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x62FF;&#x5230;marker&#x540E;&#x53BB;&#x6BD4;&#x5BF9;&#x4E0B;Block&#x4E2D;&#x7684;hash&#x503C;&#x548C;marker&#x4E2D;&#x7684;hash&#x503C;&#x662F;&#x5426;&#x4E00;&#x81F4;&#xFF0C;&#x4E0D;&#x4E00;&#x81F4;&#x5219;&#x8868;&#x660E;&#x81EA;&#x5DF1;&#x539F;&#x6765;&#x7684;&#x8C03;&#x7528;&#x6808;&#x5DF2;&#x7ECF;&#x88AB;&#x8986;&#x76D6;&#x4E86;&#x3002;</p>
<p>tab&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x4E3A;65536&#xFF0C;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x4E3A;524288&#x3002;&#x4E8C;&#x8005;&#x76F8;&#x9664;&#x7684;&#x7ED3;&#x679C;&#x4E3A;8&#xFF0C;&#x8868;&#x660E;&#x5982;&#x679C;&#x5E73;&#x5747;&#x8C03;&#x7528;&#x6808;&#x957F;&#x5EA6;&#x5C0F;&#x4E8E;7&#xFF0C;&#x5219;scudo&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x8BB0;&#x5F55;65536&#x4E2A;&#x8C03;&#x7528;&#x6808;&#xFF1B;&#x5982;&#x679C;&#x957F;&#x5EA6;&#x5927;&#x4E8E;7&#xFF0C;&#x5219;scudo&#x6700;&#x591A;&#x53EF;&#x8BB0;&#x5F55;&#x7684;&#x8C03;&#x7528;&#x6808;&#x6570;&#x5C0F;&#x4E8E;65536&#x3002;&#x5F53;&#x8C03;&#x7528;&#x6808;&#x88AB;&#x8986;&#x76D6;&#x540E;&#xFF0C;&#x867D;&#x7136;&#x95EE;&#x9898;&#x4F9D;&#x7136;&#x53EF;&#x4EE5;&#x62A5;&#x51FA;&#x6765;&#xFF0C;&#x4F46;&#x7F3A;&#x5C11;&#x5173;&#x952E;&#x7684;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x540E;&#xFF0C;&#x5185;&#x5B58;&#x95EE;&#x9898;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x5B9A;&#x4F4D;&#x3002;</p>
<p>&#x5F53;Primary Block&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x4FBF;&#x53EF;&#x4EE5;&#x5206;&#x914D;&#x7ED9;&#x5176;&#x4ED6;&#x4EBA;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x4E4B;&#x524D;&#x5B58;&#x5728;Block&#x4E2D;&#x7684;hash&#x503C;&#x548C;&#x6B64;&#x6B21;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#x90FD;&#x8981;&#x53E6;&#x5B58;&#x4ED6;&#x5904;&#x3002;</p>
<p>&#x4E3A;&#x6B64;scudo&#x4E2D;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x7684;Entry&#x6570;&#x7EC4;&#xFF0C;&#x957F;&#x5EA6;&#x4E3A;32768&#x3002;Entry&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x7684;AllocationTrace&#x5B58;&#x50A8;&#x7684;&#x662F;&#x5206;&#x914D;&#x65F6;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#xFF0C;DeallocationTrace&#x5B58;&#x50A8;&#x7684;&#x662F;&#x91CA;&#x653E;&#x65F6;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#x3002;&#x5F53;Primary Block&#x91CA;&#x653E;&#x65F6;&#xFF0C;&#x5B83;&#x9996;&#x5148;&#x4F1A;&#x53D6;&#x51FA;&#x5B58;&#x5728;Block&#x4E2D;&#x7684;&#x5206;&#x914D;&#x8C03;&#x7528;&#x6808;&#x7684;hash&#x503C;&#xFF0C;&#x5C06;&#x5B83;&#x5B58;&#x5230;Entry&#x7684;AllocationTrace&#x5B57;&#x6BB5;&#x4E2D;&#xFF0C;&#x4E4B;&#x540E;&#x5C06;&#x662F;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;hash&#x503C;&#x5B58;&#x5230;Entry&#x7684;DeallocationTrace&#x4E2D;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;  struct AllocationRingBuffer {</span><br><span class="line">    struct Entry {</span><br><span class="line">      atomic_uptr Ptr;</span><br><span class="line">      atomic_uptr AllocationSize;</span><br><span class="line">      atomic_u32 AllocationTrace;</span><br><span class="line">      atomic_u32 AllocationTid;</span><br><span class="line">      atomic_u32 DeallocationTrace;</span><br><span class="line">      atomic_u32 DeallocationTid;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    atomic_uptr Pos;</span><br><span class="line">#ifdef SCUDO_FUZZ</span><br><span class="line">    static const uptr NumEntries = 2;</span><br><span class="line">#else</span><br><span class="line">    static const uptr NumEntries = 32768;</span><br><span class="line">#endif</span><br><span class="line">    Entry Entries[NumEntries];</span><br><span class="line">  };</span><br><span class="line">  AllocationRingBuffer RingBuffer;</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x5916;&#xFF0C;Entry&#x6570;&#x7EC4;&#x4E0D;&#x5355;&#x7528;&#x4E8E;&#x5B58;&#x50A8;Primary Block&#x91CA;&#x653E;&#x540E;&#x7684;hash&#x503C;&#xFF0C;&#x8FD8;&#x7528;&#x4E8E;&#x5B58;&#x50A8;Secondary Block&#x7684;hash&#x503C;&#xFF0C;&#x4E0D;&#x8BBA;&#x5176;&#x662F;&#x5426;&#x91CA;&#x653E;&#x3002;&#x5F53;&#x521D;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x8111;&#x4E2D;&#x53C8;&#x51FA;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;Secondary&#x548C;Primary&#x5728;&#x5904;&#x7406;&#x672A;&#x91CA;&#x653E;Block&#x7684;hash&#x503C;&#x65F6;&#x505A;&#x6CD5;&#x4E0D;&#x4E00;&#x81F4;&#xFF1F;</p>
<p>&#x539F;&#x56E0;&#x662F;Primary Allocator&#x548C;Secondary Allocator&#x5BF9;&#x4E8E;&#x5176;&#x4E2D;Block&#x7684;&#x7BA1;&#x7406;&#x65B9;&#x5F0F;&#x4E0D;&#x540C;&#x3002;Primary&#x4E2D;&#x7684;Block&#x662F;&#x7EBF;&#x6027;&#x6392;&#x5217;&#xFF0C;&#x800C;Secondary&#x91CC;&#x7684;Block&#x662F;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x3002;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x904D;&#x5386;&#x7684;&#x65B9;&#x5F0F;&#x5BFB;&#x627E;&#x5230;Secondary&#x91CC;&#x7684;&#x76EE;&#x6807;Block&#xFF0C;&#x4F46;&#x662F;&#x9700;&#x8981;&#x5728;&#x904D;&#x5386;&#x8FC7;&#x7A0B;&#x4E2D;&#x589E;&#x52A0;&#x5F88;&#x591A;&#x5BF9;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x7684;&#x62F7;&#x8D1D;&#x64CD;&#x4F5C;&#x3002;&#x800C;&#x5982;&#x679C;&#x5C06;Secondary&#x7684;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x5168;&#x90E8;&#x5B58;&#x5728;Entries&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x5728;&#x6536;&#x96C6;&#x8C03;&#x7528;&#x6808;&#x4FE1;&#x606F;&#x524D;&#x5C06;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x62F7;&#x8D1D;&#x4E00;&#x6B21;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x8BA8;&#x8BBA;&#x5B8C;&#x4E86;&#x8C03;&#x7528;&#x6808;&#x7684;&#x4FDD;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x8C03;&#x7528;&#x6808;&#x7684;&#x6062;&#x590D;&#x662F;&#x600E;&#x4E48;&#x8FDB;&#x884C;&#x7684;&#x5462;&#xFF1F;</p>
<ol>
<li>&#x6839;&#x636E;PC&#x503C;&#x5728;memory maps&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;elf&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x6839;&#x636E;elf&#x6587;&#x4EF6;&#x4E2D;&#x7684;symbols&#x4FE1;&#x606F;&#xFF0C;&#x67E5;&#x8BE2;&#x8BE5;PC&#x503C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x6267;&#x884C;&#x8303;&#x56F4;&#x3002;</li>
<li>Demangle&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x5F97;&#x5230;&#x66F4;&#x5177;&#x53EF;&#x8BFB;&#x6027;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;</li>
</ol>
<p>&#x6839;&#x636E;&#x4E0A;&#x8FF0;&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#x4F1A;&#x4E22;&#x5931;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<ol>
<li>&#x5F53;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x5728;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x524D;&#x88AB;&#x5378;&#x8F7D;&#xFF0C;&#x90A3;&#x4E48;&#x90A3;&#x4E00;&#x5E27;&#x6700;&#x7EC8;&#x5C31;&#x4F1A;&#x663E;&#x793A;<code>&lt;unknown&gt;</code>&#x3002;</li>
<li>&#x5F53;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x901A;&#x8FC7;<code>-fvisibility=hidden</code>&#x7684;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#x6765;&#x5173;&#x95ED;&#x7B26;&#x53F7;&#x8868;&#x7684;&#x8F93;&#x51FA;&#x65F6;(&#x5546;&#x4E1A;APK)&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x65E0;&#x6CD5;&#x5224;&#x65AD;PC&#x503C;&#x5C5E;&#x4E8E;&#x54EA;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x90A3;&#x4E00;&#x5E27;&#x53EA;&#x4F1A;&#x6253;&#x5370;so&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x51FD;&#x6570;&#x540D;&#x3002;</li>
</ol>
<h3 id="3-&#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;"><a href="#3-&#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;" class="headerlink" title="3. &#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;"></a>3. &#x5224;&#x65AD;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x7684;&#x539F;&#x56E0;</h3><p>&#x5F53;MTE&#x8BBE;&#x7F6E;&#x4E3A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x65F6;&#xFF0C;scudo&#x4E0D;&#x4EC5;&#x4F1A;&#x8F93;&#x51FA;&#x76F8;&#x5E94;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x8FD8;&#x4F1A;&#x8F93;&#x51FA;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x8B6C;&#x5982;&#x662F;&#x6EA2;&#x51FA;&#x95EE;&#x9898;&#x8FD8;&#x662F;UAF&#x7684;&#x95EE;&#x9898;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x79CD;&#x5224;&#x65AD;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x53C2;&#x8003;&#xFF08;&#x6709;&#x6982;&#x7387;&#x53D1;&#x751F;&#x8BEF;&#x5224;&#xFF09;&#xFF0C;&#x800C;&#x5E76;&#x975E;&#x91D1;&#x6807;&#x51C6;&#x3002;</p>
<p>&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x91C7;&#x7528;<code>debuggerd_signal_handler</code>&#x4F5C;&#x4E3A;SIGSEGV&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;&#x5904;&#x7406;&#x65F6;&#x4F1A;fork&#x51FA;&#x4E00;&#x4E2A;crash_dump&#x8FDB;&#x7A0B;&#xFF0C;&#x7528;&#x4E8E;&#x6536;&#x96C6;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E0E;&#x6B64;&#x540C;&#x65F6;&#x5B83;&#x4E5F;&#x4F1A;&#x901A;&#x8FC7;<code>__scudo_get_error_info</code>&#x6536;&#x96C6;&#x66F4;&#x591A;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x5728;<code>getErrorInfo</code>&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4F1A;&#x540C;&#x65F6;&#x6536;&#x96C6;&#x8C03;&#x7528;&#x6808;&#x548C;&#x9519;&#x8BEF;&#x539F;&#x56E0;&#x3002;&#x9996;&#x5148;&#x4F1A;&#x6839;&#x636E;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x7684;tag&#x662F;&#x5426;&#x4E3A;0&#x6765;&#x51B3;&#x5B9A;&#x8981;&#x4E0D;&#x8981;&#x505A;<code>getInlineErrorInfo</code>&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;Primary&#x5206;&#x914D;&#x7684;&#x6307;&#x9488;tag&#x975E;0&#xFF0C;&#x800C;Secondary&#x5206;&#x914D;&#x7684;&#x6307;&#x9488;tag&#x4E3A;0&#x3002;<code>getInlineErrorInfo</code>&#x662F;&#x4ECE;Block&#x4E2D;&#x83B7;&#x53D6;hash&#x503C;&#x7684;&#xFF0C;&#x800C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x53EA;&#x5BF9;Primary&#x6709;&#x6548;&#x3002;</p>
<p>&#x6982;&#x62EC;&#x5730;&#x8BF4;&#xFF0C;<code>getInlineErrorInfo</code>&#x7528;&#x4E8E;&#x8F93;&#x51FA;Primary OOB&#x95EE;&#x9898;&#xFF0C;&#x6536;&#x96C6;&#x5F53;&#x521D;&#x5206;&#x914D;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;<code>getRingBufferErrorInfo</code>&#x7528;&#x4E8E;&#x8F93;&#x51FA;Primary UAF&#x3001;Secondary OOB&#x548C;Secondary UAF&#x95EE;&#x9898;&#xFF0C;&#x5176;&#x4E2D;UAF&#x95EE;&#x9898;&#x65E2;&#x6536;&#x96C6;&#x5F53;&#x521D;&#x5206;&#x914D;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E5F;&#x6536;&#x96C6;&#x4E0A;&#x4E00;&#x6B21;&#x91CA;&#x653E;&#x7684;&#x8C03;&#x7528;&#x6808;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;static void getErrorInfo(struct scudo_error_info *ErrorInfo,</span><br><span class="line">                         uintptr_t FaultAddr, const char *DepotPtr,</span><br><span class="line">                         const char *RegionInfoPtr, const char *RingBufferPtr,</span><br><span class="line">                         const char *Memory, const char *MemoryTags,</span><br><span class="line">                         uintptr_t MemoryAddr, size_t MemorySize) {</span><br><span class="line">  *ErrorInfo = {};</span><br><span class="line">  if (!allocatorSupportsMemoryTagging&lt;Params&gt;() ||</span><br><span class="line">      MemoryAddr + MemorySize &lt; MemoryAddr)</span><br><span class="line">    return;</span><br><span class="line"></span><br><span class="line">  auto *Depot = reinterpret_cast&lt;const StackDepot *&gt;(DepotPtr);</span><br><span class="line">  size_t NextErrorReport = 0;</span><br><span class="line"></span><br><span class="line">  // Check for OOB in the current block and the two surrounding blocks. Beyond</span><br><span class="line">  // that, UAF is more likely.</span><br><span class="line">  if (extractTag(FaultAddr) != 0)</span><br><span class="line">    getInlineErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                       RegionInfoPtr, Memory, MemoryTags, MemoryAddr,</span><br><span class="line">                       MemorySize, 0, 2);</span><br><span class="line"></span><br><span class="line">  // Check the ring buffer. For primary allocations this will only find UAF;</span><br><span class="line">  // for secondary allocations we can find either UAF or OOB.</span><br><span class="line">  getRingBufferErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                         RingBufferPtr);</span><br><span class="line"></span><br><span class="line">  // Check for OOB in the 28 blocks surrounding the 3 we checked earlier.</span><br><span class="line">  // Beyond that we are likely to hit false positives.</span><br><span class="line">  if (extractTag(FaultAddr) != 0)</span><br><span class="line">    getInlineErrorInfo(ErrorInfo, NextErrorReport, FaultAddr, Depot,</span><br><span class="line">                       RegionInfoPtr, Memory, MemoryTags, MemoryAddr,</span><br><span class="line">                       MemorySize, 2, 16);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6536;&#x96C6;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x901A;&#x8FC7;<code>ErrorInfo</code>&#xFF08;&#x7C7B;&#x578B;&#x4E3A;scudo_error_info&#xFF09;&#x5B58;&#x50A8;&#xFF0C;&#x5B83;&#x91CC;&#x9762;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5B9A;&#x957F;&#x4E3A;3&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x8868;&#x660E;&#x53EF;&#x4EE5;&#x4E3A;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#x5224;&#x5B9A;&#x6700;&#x591A;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x3002;&#x8FD9;&#x79CD;&#x5224;&#x65AD;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x53C2;&#x8003;&#xFF0C;&#x800C;&#x5E76;&#x975E;&#x91D1;&#x6807;&#x51C6;&#x3002;&#x8B6C;&#x5982;&#x4E00;&#x4E2A;UAF&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x68C0;&#x67E5;&#x5B83;&#x4E24;&#x4FA7;&#x7684;Block&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x73B0;&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;tag&#x4E00;&#x6837;&#x7684;Block&#xFF0C;&#x8FD9;&#x6837;&#x8BE5;&#x95EE;&#x9898;&#x4E5F;&#x53EF;&#x4EE5;&#x88AB;&#x5224;&#x5B9A;&#x4E3A;OOB&#x7684;&#x95EE;&#x9898;&#x3002;&#x81F3;&#x4E8E;&#x5177;&#x4F53;&#x662F;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#xFF0C;&#x8FD8;&#x9700;&#x4F7F;&#x7528;&#x8005;&#x7ED3;&#x5408;&#x8C03;&#x7528;&#x6808;&#x81EA;&#x5DF1;&#x53BB;&#x5224;&#x65AD;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;struct scudo_error_info {</span><br><span class="line">  struct scudo_error_report reports[3];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">struct scudo_error_report {</span><br><span class="line">  enum scudo_error_type error_type;</span><br><span class="line"></span><br><span class="line">  uintptr_t allocation_address;</span><br><span class="line">  uintptr_t allocation_size;</span><br><span class="line"></span><br><span class="line">  uint32_t allocation_tid;</span><br><span class="line">  uintptr_t allocation_trace[64];</span><br><span class="line"></span><br><span class="line">  uint32_t deallocation_tid;</span><br><span class="line">  uintptr_t deallocation_trace[64];</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<h2 id="&#x4F7F;&#x7528;&#x65B9;&#x6CD5;"><a href="#&#x4F7F;&#x7528;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4F7F;&#x7528;&#x65B9;&#x6CD5;"></a>&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</h2><p>Android&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x79CD;&#x65B9;&#x5F0F;&#x6765;&#x5F00;&#x542F;MTE&#x3002;&#x4E4D;&#x4E00;&#x770B;&#x5F88;&#x5BB9;&#x6613;&#x8FF7;&#x7CCA;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x4E86;&#x89E3;&#x6BCF;&#x79CD;&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x7528;&#x8D77;&#x6765;&#x4FBF;&#x4F1A;&#x5F97;&#x5FC3;&#x5E94;&#x624B;&#x7684;&#x591A;&#x3002;</p>
<p>&#x4ECE;&#x5927;&#x7684;&#x65B9;&#x5411;&#x4E0A;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;</p>
<ol>
<li>&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>
<li>&#x7CFB;&#x7EDF;Property</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>
<li>&#x7F16;&#x8BD1;&#x9009;&#x9879;</li>
<li>&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;</li>
<li>&#x8FD0;&#x884C;&#x65F6;API</li>
</ol>
<p>&#x63A5;&#x4E0B;&#x6765;&#x4F9D;&#x6B21;&#x4ECB;&#x7ECD;&#x3002;</p>
<h3 id="1-&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"><a href="#1-&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;" class="headerlink" title="1. &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"></a>1. &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</h3><blockquote>
<p>MEMTAG_OPTIONS=(off|sync|async)</p>
</blockquote>
<p>&#x8BE5;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x68C0;&#x6D4B;&#x8FC7;&#x7A0B;&#x53D1;&#x751F;&#x5728;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x91CD;&#x5B9A;&#x4F4D;&#x4E4B;&#x524D;&#xFF0C;&#x662F;&#x7531;linker&#x53D1;&#x8D77;&#x7684;&#x3002;&#x56E0;&#x6B64;&#x4E00;&#x65E6;&#x8BE5;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8BBE;&#x4E3A;sync&#x6216;async&#xFF0C;&#x90A3;&#x4E48;&#x4E4B;&#x540E;&#x521B;&#x5EFA;&#x7684;&#x4EFB;&#x4F55;native&#x8FDB;&#x7A0B;&#x90FD;&#x5C06;&#x5F00;&#x542F;MTE&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;Android&#x5E94;&#x7528;&#x8FDB;&#x7A0B;(Java&#x8FDB;&#x7A0B;)&#x5E76;&#x4E0D;&#x4F1A;&#x53D7;&#x5230;&#x8FD9;&#x4E2A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x5F71;&#x54CD;&#xFF1A;&#x56E0;&#x4E3A;&#x5E94;&#x7528;&#x8FDB;&#x7A0B;&#x7531;zygote fork&#x800C;&#x6765;&#xFF0C;&#x800C;&#x975E;&#x901A;&#x8FC7;<code>exec</code>&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x65B9;&#x5F0F;&#x6253;&#x5F00;&#x3002;</p>
<p>&#x901A;&#x5E38;&#xFF0C;&#x6211;&#x4EEC;&#x5728;/system/core/rootdir/init.environ.rc.in&#x4E2D;&#x53BB;&#x589E;&#x52A0;&#x65B0;&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF08;&#x8FD9;&#x6837;&#x4FBF;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF09;&#xFF0C;&#x8B6C;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x6253;&#x5F00;MTE&#x7684;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;# set up the global environment</span><br><span class="line">on early-init</span><br><span class="line">+	export MEMTAG_OPTIONS sync (&#x6253;&#x5F00;MTE&#x7684;&#x540C;&#x6B65;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;)</span><br><span class="line">    export ANDROID_BOOTLOGO 1</span><br><span class="line">    export ANDROID_ROOT /system</span><br><span class="line">    export ANDROID_ASSETS /system/app</span><br><span class="line">    export ANDROID_DATA /data</span><br><span class="line">    export ANDROID_STORAGE /storage</span><br><span class="line">    export ANDROID_ART_ROOT /apex/com.android.art</span><br><span class="line">    export ANDROID_I18N_ROOT /apex/com.android.i18n</span><br><span class="line">    export ANDROID_TZDATA_ROOT /apex/com.android.tzdata</span><br><span class="line">    export EXTERNAL_STORAGE /sdcard</span><br><span class="line">    export ASEC_MOUNTPOINT /mnt/asec</span><br><span class="line">    %EXPORT_GLOBAL_ASAN_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_GCOV_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_CLANG_COVERAGE_OPTIONS%</span><br><span class="line">    %EXPORT_GLOBAL_HWASAN_OPTIONS%</span><br></pre></td></tr></table></figure>

<h3 id="2-&#x7CFB;&#x7EDF;Property"><a href="#2-&#x7CFB;&#x7EDF;Property" class="headerlink" title="2. &#x7CFB;&#x7EDF;Property"></a>2. &#x7CFB;&#x7EDF;Property</h3><blockquote>
<p>arm64.memtag.process.<basename> = (off|sync|async)</basename></p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x7684;basename&#x901A;&#x5E38;&#x6307;&#x7684;&#x662F;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x53EA;&#x4F1A;&#x5F71;&#x54CD;native&#x8FDB;&#x7A0B;&#x3002;&#x4E0D;&#x8FC7;&#x6709;&#x4E2A;&#x4F8B;&#x5916;&#x662F;system_server&#xFF0C;&#x56E0;&#x4E3A;forkSystemServer&#x4E2D;&#x4F1A;&#x4E3B;&#x52A8;&#x8BFB;&#x53D6;&#x201D;arm64.memtag.process.system_server&#x201D;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x7684;&#x503C;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#x4F1A;&#x540C;&#x65F6;&#x6253;&#x5F00;/system/bin/ping&#x548C;/data/local/tmp/ping&#x7684;MTE&#x9009;&#x9879;&#xFF0C;&#x4E4B;&#x540E;&#x542F;&#x52A8;&#x7684;ping&#x8FDB;&#x7A0B;&#x90FD;&#x4F1A;&#x5F00;&#x542F;MTE&#x7684;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;$ setprop arm64.memtag.process.ping sync</span><br></pre></td></tr></table></figure>

<h3 id="3-&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"><a href="#3-&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;" class="headerlink" title="3. &#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;"></a>3. &#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;</h3><blockquote>
<p>SANITIZE_TARGET &amp; SANITIZE_TARGET_DIAG</p>
</blockquote>
<p>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ export SANITIZE_TARGET=memtag_heap</span><br><span class="line">hangl@ubuntu$ m</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ export SANITIZE_TARGET=memtag_heap SANITIZE_TARGET_DIAG=memtag_heap</span><br><span class="line">hangl@ubuntu$ m</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x901A;&#x8FC7;export&#x58F0;&#x660E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x4E4B;&#x540E;&#x901A;&#x8FC7;Android&#x7F16;&#x8BD1;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x5FEB;&#x6377;&#x64CD;&#x4F5C;<code>m</code>&#x6765;&#x7F16;&#x8BD1;&#x6574;&#x4E2A;system image&#x3002;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x9700;&#x8981;&#x540C;&#x65F6;&#x58F0;&#x660E;&#x4E24;&#x4E2A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF0C;&#x540E;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x7684;DIAG&#x610F;&#x5473;&#x7740;<code>diagnostics mode(&#x8BCA;&#x65AD;&#x6A21;&#x5F0F;)</code>&#xFF0C;&#x8FD9;&#x8868;&#x660E;&#x4E0D;&#x5355;&#x5355;&#x8981;&#x68C0;&#x6D4B;&#x5185;&#x5B58;&#x9519;&#x8BEF;&#xFF0C;&#x8FD8;&#x8981;&#x6536;&#x96C6;&#x5C3D;&#x53EF;&#x80FD;&#x591A;&#x7684;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x3002;</p>
<h3 id="4-&#x7F16;&#x8BD1;&#x9009;&#x9879;"><a href="#4-&#x7F16;&#x8BD1;&#x9009;&#x9879;" class="headerlink" title="4. &#x7F16;&#x8BD1;&#x9009;&#x9879;"></a>4. &#x7F16;&#x8BD1;&#x9009;&#x9879;</h3><blockquote>
<p>memtag_heap</p>
</blockquote>
<p>&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;//Android.bp</span><br><span class="line">sanitize: {</span><br><span class="line">    memtag_heap: true,</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;//Android.bp</span><br><span class="line">sanitize: {</span><br><span class="line">    memtag_heap: true,</span><br><span class="line">    diag: {</span><br><span class="line">        memtag_heap: true,</span><br><span class="line">    },</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0D;&#x8BBA;&#x662F;&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8FD8;&#x662F;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x672C;&#x8D28;&#x90FD;&#x662F;&#x5F80;ELF&#x6587;&#x4EF6;&#x4E2D;&#x589E;&#x6DFB;&#x4E00;&#x4E2A;&#x65B0;&#x7684;note section(&#x6CE8;&#x91CA;&#x8282;)&#x3002;&#x8FD9;&#x4E2A;section&#x91CC;&#x7684;&#x5185;&#x5BB9;&#x8BB0;&#x5F55;&#x4E86;MTE&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x4F1A;&#x7531;linker&#x5728;&#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x65F6;&#x8BFB;&#x53D6;&#x3002;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x5C55;&#x793A;&#x7684;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x5C06;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x7684;MTE&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x5B58;&#x5165;note section&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">assembly&#x590D;&#x5236;&#x4EE3;&#x7801;__bionic_asm_custom_note_gnu_section()</span><br><span class="line">  .section &quot;.note.android.memtag&quot;, &quot;a&quot;, %note</span><br><span class="line">  .p2align 2</span><br><span class="line">  .long 1f - 0f         // int32_t namesz</span><br><span class="line">  .long 3f - 2f         // int32_t descsz</span><br><span class="line">  .long NT_TYPE_MEMTAG  // int32_t type</span><br><span class="line">0:</span><br><span class="line">  .asciz &quot;Android&quot;      // char name[]</span><br><span class="line">1:</span><br><span class="line">  .p2align 2</span><br><span class="line">2:</span><br><span class="line">  .long (NT_MEMTAG_LEVEL_ASYNC | NT_MEMTAG_HEAP) // value</span><br><span class="line">3:</span><br><span class="line">  .p2align 2</span><br></pre></td></tr></table></figure>

<p>&#x5B58;&#x5165;ELF&#x6587;&#x4EF6;&#x7684;note&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;llvm-readelf&#x8BFB;&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x4EE5;&#x4E0B;&#x4E3A;&#x793A;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;hangl@ubuntu$ llvm-readelf --notes app_process64</span><br><span class="line">...</span><br><span class="line">Displaying notes found in: .note.android.memtag</span><br><span class="line">  Owner                Data size        Description</span><br><span class="line">  Android              0x00000004       Unknown note type: (0x00000004)</span><br><span class="line">  description data: 05 00 00 00</span><br></pre></td></tr></table></figure>

<p>&#x540D;&#x79F0;&#x4E3A;&#x201D;.note.android.memtag&#x201D;&#x7684;section&#x662F;&#x6211;&#x4EEC;&#x5173;&#x6CE8;&#x7684;&#x3002;Owner&#x4E3A;&#x201D;Android&#x201D;&#xFF0C;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;Date Size&#x4E3A;4&#xFF0C;&#x8868;&#x793A;description data&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E3A;4&#x5B57;&#x8282;&#xFF1B;Description&#x4E0B;&#x9762;&#x7684;&#x6570;&#x636E;&#x5B9E;&#x8D28;&#x4E0A;&#x662F;Type&#xFF0C;0x4&#x5373;&#x4E3A;NT_TYPE_MEMTAG&#xFF1B;description data&#x624D;&#x662F;MTE&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;0x5&#x8868;&#x793A;(NT_MEMTAG_LEVEL_ASYNC | NT_MEMTAG_HEAP)&#xFF0C;0x6&#x8868;&#x793A;(NT_MEMTAG_LEVEL_SYNC | NT_MEMTAG_HEAP)&#xFF0C;&#x56E0;&#x4E3A;NT_MEMTAG_LEVEL_ASYNC =1&#xFF0C;NT_MEMTAG_LEVEL_SYNC =2&#xFF0C;NT_MEMTAG_HEAP=4&#x3002;</p>
<h3 id="5-&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;"><a href="#5-&#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;" class="headerlink" title="5. &#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;"></a>5. &#x5E94;&#x7528;Manifest&#x914D;&#x7F6E;</h3><blockquote>
<p>android:memtagMode=(off|default|sync|async)</p>
</blockquote>
<p>&#x5982;&#x679C;&#x5728;<application>&#x6807;&#x7B7E;&#x4E0B;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x8BE5;&#x5C5E;&#x6027;&#x5BF9;&#x5E94;&#x7528;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x8FDB;&#x7A0B;&#x90FD;&#x751F;&#x6548;&#xFF1B;&#x5982;&#x679C;&#x5728;<process>&#x6807;&#x7B7E;&#x4E0B;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x8BE5;&#x5C5E;&#x6027;&#x4EC5;&#x5BF9;&#x5355;&#x4E2A;&#x8FDB;&#x7A0B;&#x751F;&#x6548;&#xFF0C;&#x4E14;&#x4F1A;&#x8986;&#x76D6;<application>&#x6807;&#x7B7E;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#x3002;</application></process></application></p>
<p>&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x8BE5;&#x914D;&#x7F6E;&#x751F;&#x6548;&#x6709;&#x4E00;&#x4E2A;&#x524D;&#x63D0;&#xFF0C;&#x5373;zygote&#x8FDB;&#x7A0B;&#x7684;MTE&#x5DF2;&#x7ECF;&#x6253;&#x5F00;&#xFF0C;&#x5426;&#x5219;&#x6240;&#x6709;&#x7ECF;&#x7531;zygote fork&#x51FA;&#x6765;&#x7684;&#x8FDB;&#x7A0B;&#x90FD;&#x65E0;&#x6CD5;&#x5F00;&#x542F;MTE&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;application</span><br><span class="line">    ...</span><br><span class="line">    android:memtagMode=&quot;async&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x5F00;&#x53D1;&#x8005;&#x6A21;&#x5F0F;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5728;&#x8BBE;&#x7F6E;&#x9009;&#x9879;&#x4E2D;&#x4FEE;&#x6539;&#x5355;&#x4E2A;&#x5E94;&#x7528;&#x7684;MTE&#x914D;&#x7F6E;&#x3002;</p>
<p>Settings &gt; System &gt; Developer options &gt; App Compatibility Changes&#xFF0C;&#x5176;&#x4E2D;<code>NATIVE_MEMTAG_ASYNC</code>&#x548C;<code>NATIVE_MEMTAG_SYNC</code>&#x7684;&#x9009;&#x9879;&#x4E0E;MTE&#x76F8;&#x5173;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;am&#x6307;&#x4EE4;&#x4E5F;&#x652F;&#x6301;&#x4FEE;&#x6539;MTE&#x914D;&#x7F6E;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;$ adb shell am compat enable NATIVE_MEMTAG_[A]SYNC my.app.name</span><br></pre></td></tr></table></figure>

<h3 id="6-&#x8FD0;&#x884C;&#x65F6;API"><a href="#6-&#x8FD0;&#x884C;&#x65F6;API" class="headerlink" title="6. &#x8FD0;&#x884C;&#x65F6;API"></a>6. &#x8FD0;&#x884C;&#x65F6;API</h3><blockquote>
<p>int mallopt(M_BIONIC_SET_HEAP_TAGGING_LEVEL, level)</p>
</blockquote>
<p>&#x4EE5;&#x4E0A;5&#x79CD;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x5728;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x524D;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x53EF;&#x662F;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5DF2;&#x7ECF;&#x5728;&#x8FD0;&#x884C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x6709;&#x529E;&#x6CD5;&#x6539;&#x53D8;&#x5B83;&#x7684;MTE&#x914D;&#x7F6E;&#x4E48;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x662F;&#x4F7F;&#x7528;mallopt&#x51FD;&#x6570;&#xFF0C;&#x4E0A;&#x8FF0;&#x51FD;&#x6570;&#x4E2D;&#x7684;level&#x53EF;&#x4EE5;&#x4ECE;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x9009;&#x9879;&#x4E2D;&#x9009;&#x62E9;&#x3002;</p>
<ul>
<li>M_HEAP_TAGGING_LEVEL_NONE</li>
<li>M_HEAP_TAGGING_LEVEL_ASYNC</li>
<li>M_HEAP_TAGGING_LEVEL_SYNC</li>
</ul>
<p>&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;API&#x7684;&#x4F7F;&#x7528;&#x6709;&#x4E9B;&#x9650;&#x5236;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x8FDB;&#x7A0B;&#x7684;MTE&#x6A21;&#x5F0F;&#x53EA;&#x80FD;&#x4ECE;&#x5F00;&#x542F;&#x72B6;&#x6001;&#x5207;&#x6362;&#x5230;&#x5173;&#x95ED;&#x72B6;&#x6001;&#xFF0C;&#x800C;&#x65E0;&#x6CD5;&#x9006;&#x5411;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x4E3A;&#x4E2D;&#x9014;&#x5F00;&#x542F;MTE&#x4F1A;&#x5BFC;&#x81F4;&#x5148;&#x524D;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF08;&#x6CA1;&#x6709;&#x751F;&#x6210;tag&#xFF09;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x3002;&#x5177;&#x4F53;&#x7684;&#x9650;&#x5236;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x8FDB;&#x7A0B;&#x5FC5;&#x987B;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x5C31;&#x5DF2;&#x7ECF;&#x5F00;&#x542F;MTE&#x68C0;&#x6D4B;&#x3002;</li>
<li>M_HEAP_TAGGING_LEVEL_SYNC&#x6216;M_HEAP_TAGGING_LEVEL_ASYNC&#x5207;&#x6362;&#x5230;M_HEAP_TAGGING_LEVEL_NONE&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x5411;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x4E00;&#x65E6;&#x5173;&#x95ED;&#xFF0C;&#x65E0;&#x6CD5;&#x518D;&#x6B21;&#x5F00;&#x542F;&#x3002;</li>
</ol>
<p>&#x8FD9;&#x4E2A;API&#x5BF9;&#x4E8E;&#x7EBF;&#x4E0A;&#x5E94;&#x7528;&#x5176;&#x5B9E;&#x6709;&#x7740;&#x633A;&#x5927;&#x7684;&#x5E2E;&#x52A9;&#x3002;&#x5E73;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5BF9;APP&#x5F00;&#x542F;&#x5F02;&#x6B65;&#x6A21;&#x5F0F;&#x7684;&#x68C0;&#x6D4B;&#xFF08;&#x6027;&#x80FD;&#x4F18;&#x5148;&#xFF09;&#xFF0C;&#x4E00;&#x65E6;&#x68C0;&#x6D4B;&#x5230;&#x95EE;&#x9898;&#xFF0C;&#x4FBF;&#x53EF;&#x4EE5;&#x5728;&#x4E0B;&#x6B21;&#x542F;&#x52A8;&#x65F6;&#x5207;&#x6362;&#x5230;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#xFF08;&#x8C03;&#x8BD5;&#x4F18;&#x5148;&#xFF09;&#x3002;</p>
<h3 id="&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;"><a href="#&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;" class="headerlink" title="&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;"></a>&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x7684;&#x4F18;&#x5148;&#x7EA7;</h3><ul>
<li>&#x6700;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF08;&#x5168;&#x5C40;&#x914D;&#x7F6E;&#xFF0C;&#x5BF9;&#x6240;&#x6709;native&#x8FDB;&#x7A0B;&#x751F;&#x6548;&#xFF09;&#xFF0C;&#x4E00;&#x65E6;&#x8BE5;&#x53D8;&#x91CF;&#x8BBE;&#x5B9A;&#x4EE5;&#x540E;&#xFF0C;&#x4E0B;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x90FD;&#x4E0D;&#x4F1A;&#x8D77;&#x4F5C;&#x7528;&#x3002;</li>
<li>&#x4E2D;&#x7B49;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x7CFB;&#x7EDF;property&#xFF0C;&#x8BE5;&#x53D8;&#x91CF;&#x53EF;&#x4EE5;&#x4E3A;&#x7279;&#x5B9A;&#x8FDB;&#x7A0B;&#x914D;&#x7F6E;MTE&#x3002;</li>
<li>&#x6700;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;&#x7F16;&#x8BD1;&#x65F6;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x53CA;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#xFF0C;&#x5B83;&#x4EEC;&#x4F1A;&#x5728;ELF&#x6587;&#x4EF6;&#x4E2D;&#x589E;&#x52A0;note section&#xFF0C;&#x4F46;note section&#x7684;&#x68C0;&#x6D4B;&#x53EA;&#x4F1A;&#x53D1;&#x751F;&#x5728;&#x4E0A;&#x9762;&#x4E24;&#x4E2A;&#x65B9;&#x5F0F;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#x3002;</li>
</ul>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x4E0A;&#x8FF0;&#x65B9;&#x5F0F;&#x53EA;&#x4F5C;&#x7528;&#x4E8E;native&#x8FDB;&#x7A0B;&#xFF0C;&#x4E5F;&#x5373;&#x901A;&#x8FC7;exec&#x52A0;&#x8F7D;ELF&#x6587;&#x4EF6;&#x6765;&#x542F;&#x52A8;&#x7684;&#x8FDB;&#x7A0B;&#xFF08;&#x6709;&#x4E00;&#x4E2A;&#x4F8B;&#x5916;&#x662F;system_server&#xFF0C;&#x901A;&#x8FC7;&#x201D;arm64.memtag.process.system_server&#x201D;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x63A7;&#x5236;&#xFF09;&#x3002;</p>
<p>APP&#x7531;zygote fork&#x51FA;&#x6765;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x8D70;ELF&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x5B50;&#x8FDB;&#x7A0B;fork&#x51FA;&#x6765;&#x540E;&#xFF0C;&#x4F1A;&#x6267;&#x884C;<code>SpecializeCommon</code>&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;mallopt&#x5BF9;MTE&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c++&#x590D;&#x5236;&#x4EE3;&#x7801;mallopt(M_BIONIC_SET_HEAP_TAGGING_LEVEL, heap_tagging_level);</span><br></pre></td></tr></table></figure>

<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;heap_tagging_level&#x7684;&#x503C;&#x4E3A;<code>M_HEAP_TAGGING_LEVEL_NONE</code>&#x3002;&#x5F53;Manifest&#x6216;Compatibility Changes&#x4E2D;&#x5F00;&#x542F;&#x4E86;MTE&#x540E;&#xFF0C;heap_tagging_level&#x7684;&#x503C;&#x4FBF;&#x4F1A;&#x53D1;&#x751F;&#x66F4;&#x6539;&#x3002;</p>
<h2 id="&#x6848;&#x4F8B;&#x89E3;&#x6790;"><a href="#&#x6848;&#x4F8B;&#x89E3;&#x6790;" class="headerlink" title="&#x6848;&#x4F8B;&#x89E3;&#x6790;"></a>&#x6848;&#x4F8B;&#x89E3;&#x6790;</h2><p>&#x5F53;MTE&#x68C0;&#x6D4B;&#x5230;&#x95EE;&#x9898;&#x540E;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x8FDB;&#x7A0B;&#x7684;tombstone&#x6587;&#x4EF6;&#xFF0C;&#x4E0B;&#x9762;&#x7ED9;&#x51FA;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">Build fingerprint: xxxx</span><br><span class="line">Revision: &apos;0&apos;</span><br><span class="line">ABI: &apos;arm64&apos;</span><br><span class="line">Timestamp: 1970-01-01 00:36:59.185340333+0000</span><br><span class="line">pid: 3304, tid: 3304, name: main  &gt;&gt;&gt; zygote64 &lt;&lt;&lt;</span><br><span class="line">uid: 0</span><br><span class="line">tagged_addr_ctrl: 000000000007fff3</span><br><span class="line">signal 11 (SIGSEGV), code 9 (SEGV_MTESERR), fault addr 0x800007c6c70f600</span><br><span class="line">    x0  0000000000000025  x1  0800007c6c70f5e9  x2  0000000000084000  x3  0000000000000000</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">backtrace:</span><br><span class="line">      #00 pc 000000000009cc38  /apex/com.android.runtime/lib64/bionic/libc.so (__openat+8)</span><br><span class="line">      #01 pc 000000000005b234  /apex/com.android.runtime/lib64/bionic/libc.so (__open_2+76)</span><br><span class="line">      ...</span><br><span class="line">Note: multiple potential causes for this crash were detected, listing them in decreasing order of probability.</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Underflow, 128 bytes left of a 96-byte allocation at 0x7c6c70f680  // 0x680 -0x600 = 128(0x80) bytes.</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 0000000000044204  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_malloc+36)</span><br><span class="line">      #02 pc 000000000003ec7c  /apex/com.android.runtime/lib64/bionic/libc.so (malloc+36)</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Overflow, 0 bytes right of a 96-byte allocation at 0x7c6c70f5a0  // 0x600 - 0x5a0 = 0x60(96) bytes</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 0000000000044204  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_malloc+36)</span><br><span class="line">      #02 pc 000000000003ec7c  /apex/com.android.runtime/lib64/bionic/libc.so (malloc+36)</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">Cause: [MTE]: Buffer Underflow, 1696 bytes left of a 88-byte allocation at 0x7c6c70fca0  //0xca0 - 0x600 = 1696 bytes</span><br><span class="line"></span><br><span class="line">allocated by thread 3304:</span><br><span class="line">      #00 pc 0000000000043f34  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::allocate(unsigned long, scudo::Chunk::Origin, unsigned long, bool)+1260)</span><br><span class="line">      #01 pc 00000000000445ac  /apex/com.android.runtime/lib64/bionic/libc.so (scudo::Allocator&lt;scudo::AndroidConfig, &amp;(scudo_malloc_postinit)&gt;::reallocate(void*, unsigned long, unsigned long)+248) </span><br><span class="line">      #02 pc 0000000000044450  /apex/com.android.runtime/lib64/bionic/libc.so (scudo_realloc+36)</span><br><span class="line">      #03 pc 000000000003ef48  /apex/com.android.runtime/lib64/bionic/libc.so (realloc+84)</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x662F;MTE&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x4E0B;&#x8F93;&#x51FA;&#x7684;tombstone&#x4FE1;&#x606F;&#xFF0C;<code>tagged_addr_ctrl</code>&#x4E2D;&#x8BB0;&#x5F55;&#x4E86;&#x4E09;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/20aa4667057e03e040ec707c36ef2273ffb7eccfefc6f153c460c5b01728863b" alt="tag_ctrl.jpg"></p>
<ul>
<li>&#x6700;&#x4F4E;&#x4F4D;&#x4E3A;1&#x8868;&#x793A;MTE&#x68C0;&#x6D4B;&#x529F;&#x80FD;&#x6253;&#x5F00;&#x3002;</li>
<li>1~2bits<code>01</code>&#x610F;&#x5473;&#x7740;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#x4E3A;&#x540C;&#x6B65;&#xFF0C;<code>10</code>&#x610F;&#x5473;&#x7740;&#x68C0;&#x6D4B;&#x6A21;&#x5F0F;&#x4E3A;&#x5F02;&#x6B65;&#x3002;</li>
<li>3~18bits&#x8BB0;&#x5F55;&#x4E86;tag&#x9009;&#x53D6;&#x7684;&#x8303;&#x56F4;&#xFF0C;<code>1111111111111110</code>&#x610F;&#x5473;&#x7740;tag&#x4E0D;&#x9009;&#x62E9;0&#x3002;</li>
</ul>
<p>&#x56E0;&#x6B64;<code>0x7fff3</code>&#x8868;&#x793A;&#x540C;&#x6B65;&#x6A21;&#x5F0F;&#x6253;&#x5F00;&#xFF0C;&#x4E14;tag&#x4E0D;&#x9009;&#x62E9;0&#x3002;</p>
<p>Code <code>SEGV_MTESERR</code>&#x8868;&#x793A;synchronous&#xFF0C;<code>SEGV_MTEAERR</code>&#x8868;&#x793A;asynchronous&#x3002;</p>
<p>Backtrace&#x6807;&#x7B7E;&#x4E0B;&#x8BB0;&#x5F55;&#x4E86;&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x4E09;&#x4E2A;Cause&#x5206;&#x522B;&#x8BB0;&#x5F55;&#x4E86;&#x9519;&#x8BEF;&#x7684;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x3002;OOB&#x95EE;&#x9898;&#x7684;&#x68C0;&#x6D4B;&#x7531;&#x8FD1;&#x53CA;&#x8FDC;&#xFF0C;&#x4E14;&#x5148;Underflow&#xFF0C;&#x540E;Overflow&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x6BD4;&#x5BF9;&#xFF0C;&#x4E0B;&#x9762;&#x7701;&#x7565;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x76F4;&#x63A5;&#x5C06;&#x4E09;&#x4E2A;Cause&#x7F57;&#x5217;&#x5728;&#x4E00;&#x8D77;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;Cause: [MTE]: Buffer Underflow, 128 bytes left of a 96-byte allocation at 0x7c6c70f680  // 0x680 -0x600 = 128(0x80) bytes.</span><br><span class="line">Cause: [MTE]: Buffer Overflow, 0 bytes right of a 96-byte allocation at 0x7c6c70f5a0  // 0x600 - 0x5a0 = 0x60(96) bytes</span><br><span class="line">Cause: [MTE]: Buffer Underflow, 1696 bytes left of a 88-byte allocation at 0x7c6c70fca0  //0xca0 - 0x600 = 1696 bytes</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/983590e546e9dce111a96cf075bfc6c3fb72dc2baa734264d93953a2256d3567" alt="&#x6848;&#x4F8B;.png"></p>
<p>&#x9519;&#x8BEF;&#x5730;&#x5740;&#x6307;&#x5411;&#x7684;Block&#x5C5E;&#x4E8E;Class 6&#x7684;region&#xFF0C;&#x5176;&#x4E2D;&#x6BCF;&#x4E2A;Block&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x4E3A;112&#x5B57;&#x8282;(8&#x5B57;&#x8282;Header+8&#x5B57;&#x8282;Padding+96&#x5B57;&#x8282;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;)&#x3002;&#x4E0D;&#x8FC7;96&#x5B57;&#x8282;&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5E76;&#x4E0D;&#x610F;&#x5473;&#x7740;&#x5B8C;&#x5168;&#x4F7F;&#x7528;&#xFF0C;&#x8B6C;&#x5982;&#x53EF;&#x4EE5;&#x53EA;&#x4F7F;&#x7528;88&#x5B57;&#x8282;&#xFF0C;&#x5269;&#x4E0B;8&#x5B57;&#x8282;unused&#x3002;</p>
<p>&#x68C0;&#x6D4B;&#x65F6;&#x5148;&#x53BB;&#x5BFB;&#x627E;&#x9519;&#x8BEF;Block&#x53F3;&#x8FB9;&#x7684;Block&#xFF0C;&#x53D1;&#x73B0;&#x53F3;&#x8FB9;&#x7B2C;&#x4E00;&#x4E2A;Block&#x7684;tag&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x56E0;&#x6B64;&#x5224;&#x5B9A;&#x4E3A;Buffer Underflow&#x3002;&#x201D;128 bytes left of a 96-byte allocation at 0x7c6c70f680&#x201D;&#xFF0C;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x548C;&#x53F3;&#x8FB9;Block&#x7684;&#x5934;&#x90E8;&#x5730;&#x5740;&#x4E4B;&#x95F4;&#x76F8;&#x5DEE;128bytes&#xFF0C;&#x800C;&#x53F3;&#x8FB9;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E3A;96bytes&#x3002;</p>
<p>&#x63A5;&#x7740;&#x67E5;&#x770B;&#x5DE6;&#x8FB9;&#x7B2C;&#x4E00;&#x4E2A;Block&#xFF0C;&#x53D1;&#x73B0;tag&#x4E5F;&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x4E00;&#x6837;&#xFF0C;&#x56E0;&#x6B64;&#x5224;&#x5B9A;&#x4E3A;Buffer Overflow&#x3002;&#x201D;0 bytes right of a 96-byte allocation at 0x7c6c70f5a0&#x201D;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x521A;&#x597D;&#x7B49;&#x4E8E;&#x5DE6;&#x8FB9;Block&#x7684;&#x5C3E;&#x90E8;&#x5730;&#x5740;&#xFF0C;&#x4E14;&#x5DE6;&#x8FB9;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E5F;&#x4E3A;96bytes&#x3002;</p>
<p>&#x5DE6;&#x53F3;&#x5404;&#x5224;&#x5B9A;&#x6700;&#x591A;15&#x4E2A;Block&#xFF0C;&#x5224;&#x65AD;&#x5230;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x65F6;&#xFF0C;&#x53D1;&#x73B0;&#x5B83;&#x7684;tag&#x548C;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x7684;tag&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x7B2C;&#x4E09;&#x79CD;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x5224;&#x65AD;&#x4E3A;Underflow&#x3002;&#x201D;1696 bytes left of a 88-byte allocation at 0x7c6c70fca0&#x201D;&#xFF0C;&#x8868;&#x793A;&#x9519;&#x8BEF;&#x5730;&#x5740;&#x8DDD;&#x79BB;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x7684;&#x5934;&#x90E8;&#x6709;1696bytes&#x7684;&#x8DDD;&#x79BB;&#xFF0C;&#x4E14;&#x8BE5;Block&#x7684;&#x771F;&#x5B9E;content&#x5927;&#x5C0F;&#x4E3A;88bytes&#x3002;(1696+88)/112=16&#xFF0C;&#x7531;&#x4E8E;&#x672C;&#x8EAB;Block&#x5360;&#x636E;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#xFF0C;&#x56E0;&#x6B64;&#x521A;&#x597D;&#x662F;&#x53F3;&#x8FB9;&#x7B2C;15&#x4E2A;Block&#x3002;</p>
<p>&#x63A5;&#x7740;&#x7ED3;&#x5408;&#x6BCF;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x5224;&#x5B9A;Overflow&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6B21;&#x9519;&#x8BEF;&#x7684;&#x771F;&#x5B9E;&#x539F;&#x56E0;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x6808;&#x548C;&#x9519;&#x8BEF;&#x8C03;&#x7528;&#x6808;&#x90FD;&#x548C;<code>Gralloc2Mapper</code>&#x7684;<code>preload</code>&#x6709;&#x5173;&#x3002;</p>
<h2 id="&#x540E;&#x8BB0;"><a href="#&#x540E;&#x8BB0;" class="headerlink" title="&#x540E;&#x8BB0;"></a>&#x540E;&#x8BB0;</h2><p>&#x968F;&#x7740;Android S(12)&#x7684;&#x6B63;&#x5F0F;&#x53D1;&#x5E03;&#xFF0C;&#x4F30;&#x8BA1;&#x4F1A;&#x6709;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#x7684;&#x4EBA;&#x542C;&#x5230;MTE&#x3002;&#x6240;&#x4EE5;&#x6211;&#x5C31;&#x60F3;&#x7740;&#x5199;&#x4E00;&#x7BC7;&#x5C3D;&#x53EF;&#x80FD;&#x8BE6;&#x7EC6;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x66F4;&#x6DF1;&#x5165;&#x5730;&#x4E86;&#x89E3;&#x5B83;&#x3001;&#x4F7F;&#x7528;&#x5B83;&#x3002;&#x53E6;&#x5916;&#x5728;&#x7814;&#x7A76;&#x6E90;&#x7801;&#x65F6;&#xFF0C;&#x6211;&#x4E5F;&#x53D1;&#x73B0;&#x4E86;scudo MTE&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x5C0F;&#x7455;&#x75B5;&#xFF0C;&#x7ED9;Google&#x63D0;&#x4E86;3&#x4E2A;bug&#x548C;2&#x4E2A;&#x5EFA;&#x8BAE;&#xFF0C;&#x5E78;&#x8FD0;&#x7684;&#x662F;&#x90FD;&#x88AB;&#x91C7;&#x7EB3;&#x4E86;&#xFF0C;&#x4E5F;&#x7B97;&#x4E3A;&#x5F00;&#x6E90;&#x793E;&#x533A;&#x505A;&#x4E9B;&#x8D21;&#x732E;&#x3002;</p>
<p>&#x4E0D;&#x77E5;&#x4E0D;&#x89C9;&#xFF0C;&#x672C;&#x6587;&#x5DF2;&#x8FC7;&#x4E07;&#x5B57;&#xFF0C;&#x4F46;&#x5176;&#x4E2D;&#x80AF;&#x5B9A;&#x8FD8;&#x6709;&#x4E0D;&#x5C11;&#x7EC6;&#x8282;&#x6CA1;&#x6709;&#x63A8;&#x6572;&#x5230;&#x4F4D;&#xFF0C;&#x5E0C;&#x671B;&#x5404;&#x4F4D;&#x670B;&#x53CB;&#x53D1;&#x73B0;&#x4E4B;&#x540E;&#x5E2E;&#x5FD9;&#x6307;&#x6B63;&#xFF0C;&#x591A;&#x8C22;&#x591A;&#x8C22;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/4e3064d15534abc3317644d4f375d6d2.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7012996721693163528.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7012996721693163528.html" itemprop="url">使用threejs实现炫酷的酸性风格3D页面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-28T22:52:10+08:00">
                2021-09-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x201C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;</a>&#x201D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;&#x3002;</p>
<h2 id="&#x80CC;&#x666F;"><a href="#&#x80CC;&#x666F;" class="headerlink" title="&#x80CC;&#x666F;"></a>&#x80CC;&#x666F;</h2><p>&#x8FD1;&#x671F;&#x5B66;&#x4E60;&#x4E86; <code>WebGL</code> &#x548C; <code>Three.js</code> &#x7684;&#x4E00;&#x4E9B;&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#xFF0C;&#x4E8E;&#x662F;&#x60F3;&#x7ED3;&#x5408;&#x6700;&#x8FD1;&#x6D41;&#x884C;&#x7684;&#x9178;&#x6027;&#x8BBE;&#x8BA1;&#x98CE;&#x683C;&#xFF0C;&#x88C5;&#x9970;&#x4E00;&#x4E0B;&#x4E2A;&#x4EBA;&#x4E3B;&#x9875;&#xFF0C;&#x540C;&#x65F6;&#x603B;&#x7ED3;&#x4E00;&#x4E9B;&#x5B66;&#x5230;&#x7684;&#x77E5;&#x8BC6;&#x3002;&#x672C;&#x6587;&#x5185;&#x5BB9;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;&#xFF0C;&#x901A;&#x8FC7;&#x4F7F;&#x7528; <code>React + three.js</code> &#x6280;&#x672F;&#x6808;&#xFF0C;&#x52A0;&#x8F7D; <code>3D&#x6A21;&#x578B;</code>&#x3001;&#x6DFB;&#x52A0; <code>3D&#x6587;&#x5B57;</code>&#x3001;&#x589E;&#x52A0;&#x52A8;&#x753B;&#x3001;&#x70B9;&#x51FB;&#x4EA4;&#x4E92;&#x7B49;&#xFF0C;&#x914D;&#x5408;&#x6837;&#x5F0F;&#x8BBE;&#x8BA1;&#xFF0C;&#x5B9E;&#x73B0;&#x5145;&#x6EE1;&#x8BBE;&#x8BA1;&#x611F;&#x7684; <code>&#x1F922;</code> &#x9178;&#x6027;&#x98CE;&#x683C;&#x9875;&#x9762;&#x3002;</p>
<h2 id="&#x57FA;&#x7840;&#x77E5;&#x8BC6;"><a href="#&#x57FA;&#x7840;&#x77E5;&#x8BC6;" class="headerlink" title="&#x57FA;&#x7840;&#x77E5;&#x8BC6;"></a>&#x57FA;&#x7840;&#x77E5;&#x8BC6;</h2><h3 id="Three-js"><a href="#Three-js" class="headerlink" title="Three.js"></a><code>Three.js</code></h3><p><code>Three.js</code> &#x662F;&#x4E00;&#x6B3E;&#x57FA;&#x4E8E;&#x539F;&#x751F; <code>WebGL</code>&#x5C01;&#x88C5;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684; <code>3D&#x5F15;&#x64CE;</code>&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5B83;&#x521B;&#x5EFA;&#x5404;&#x79CD;&#x4E09;&#x7EF4;&#x573A;&#x666F;&#xFF0C;&#x5305;&#x62EC;&#x4E86;&#x6444;&#x5F71;&#x673A;&#x3001;&#x5149;&#x5F71;&#x3001;&#x6750;&#x8D28;&#x7B49;&#x5404;&#x79CD;&#x5BF9;&#x8C61;&#x3002;&#x662F;&#x4E00;&#x6B3E;&#x4F7F;&#x7528;&#x975E;&#x5E38;&#x5E7F;&#x6CDB;&#x7684;&#x4E09;&#x7EF4;&#x5F15;&#x64CE;&#x3002;&#x53EF;&#x4EE5;&#x5728; <a href="/external_links/4d7b7b99240afce9a5c0800258c77c4d.html" target="blank" rel="noopener">three.js&#x5B98;&#x65B9;&#x4E2D;&#x6587;&#x6587;&#x6863;</a> &#x8FDB;&#x4E00;&#x6B65;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x3002;</p>
<h3 id="&#x9178;&#x6027;&#x8BBE;&#x8BA1;"><a href="#&#x9178;&#x6027;&#x8BBE;&#x8BA1;" class="headerlink" title="&#x9178;&#x6027;&#x8BBE;&#x8BA1;"></a>&#x9178;&#x6027;&#x8BBE;&#x8BA1;</h3><p><code>&#x9178;&#x6027;&#x8BBE;&#x8BA1;</code> &#x4E00;&#x8BCD;&#x7FFB;&#x8BD1;&#x81EA; <code>Acid Graphics</code>&#xFF0C;&#x8D77;&#x6E90;&#x4E8E; <code>&#x4E0A;&#x4E16;&#x7EAA;90&#x5E74;&#x4EE3;</code> &#x7684;&#x9178;&#x6D69;&#x5BA4;&#x97F3;&#x4E50;&#x3001;&#x7535;&#x5B50;&#x821E;&#x66F2;&#x4EE5;&#x53CA;&#x5B09;&#x76AE;&#x58EB;&#x6587;&#x5316;&#x3002;&#x5728;&#x8BBE;&#x8BA1;&#x9886;&#x57DF;&#xFF0C;&#x8FD9;&#x79CD;&#x9178;&#x6027;&#x7F8E;&#x5B66;&#x627F;&#x8F7D;&#x4E00;&#x79CD; <code>&#x81EA;&#x7531;&#x7684;&#x4E3B;&#x5F20;</code>&#xFF0C;&#x602A;&#x8BDE;&#x7684;&#x56FE;&#x5F62;&#xFF0C;&#x5927;&#x80C6;&#x9C9C;&#x660E;&#x7684;&#x914D;&#x8272;&#xFF0C;&#x7279;&#x6B8A;&#x7684;&#x6750;&#x6599;&#x8D28;&#x611F;&#xFF0C;&#x642D;&#x914D;&#x591A;&#x79CD;&#x5B57;&#x4F53;&#xFF0C;&#x7EC4;&#x6210;&#x4E86;&#x72EC;&#x7279;&#x7684;&#x9178;&#x6027;&#x8BBE;&#x8BA1;&#x98CE;&#x683C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/8c50280f56d882045e31fac37125243519534aab0d9ab585274bbac823ab3a67" alt></p>
<p>&#x603B;&#x4E4B;&#xFF0C;<code>&#x9C9C;&#x8273;&#x9AD8;&#x9971;&#x548C;&#x5EA6;</code> &#x7684;&#x8272;&#x5F69;&#x7EC4;&#x5408;&#xFF1B;&#x9ED1;&#x7070;&#x8272;&#x6253;&#x5E95;&#x9AD8;&#x9971;&#x548C; <code>&#x8367;&#x5149;&#x8272;</code> &#x70B9;&#x7F00;&#x753B;&#x9762;&#x7684; <code>&#x4E94;&#x5F69;&#x6591;&#x6593;&#x7684;&#x9ED1;</code>&#xFF1B;&#x5145;&#x6EE1;&#x672A;&#x6765;&#x611F;&#x3001;&#x70AB;&#x9177;&#x3001;&#x5145;&#x6EE1;&#x79D1;&#x6280;&#x611F;&#x7684;<code>&#x6DB2;&#x6001;&#x91D1;&#x5C5E;</code>&#x3001;<code>&#x73BB;&#x7483;</code>&#x3001;<code>&#x94DD;&#x7B94;&#x5851;&#x6599;</code>&#x7B49;&#x6750;&#x8D28;&#xFF1B;<code>&#x968F;&#x673A;</code> &#x7684;&#x5143;&#x7D20;&#x3001;&#x56FE;&#x5F62;&#x7684;&#x5E03;&#x5C40;&#xFF1B;&#x4E0D;&#x65AD; <code>&#x91CD;&#x590D;</code>&#x3001;&#x88C1;&#x5207;&#x3001;&#x7EC4;&#x5408; <code>&#x51E0;&#x4F55;&#x56FE;&#x5F62;</code> &#x7B49;&#x90FD;&#x662F;&#x9178;&#x6027;&#x8BBE;&#x8BA1;&#x98CE;&#x683C;&#x3002;&#x9178;&#x6027;&#x98CE;&#x683C;&#x5728;&#x97F3;&#x4E50;&#x4E13;&#x8F91;&#x5C01;&#x9762;&#x3001;&#x89C6;&#x89C9;&#x6D77;&#x62A5;&#x3001;&#x4E66;&#x7C4D;&#x7535;&#x5F71;&#x5C01;&#x9762;&#x3001;&#x7F51;&#x9875;&#x8BBE;&#x8BA1;&#x4E2D;&#x4E5F;&#x9010;&#x6E10;&#x5F00;&#x59CB;&#x6D41;&#x884C;&#x3002;</p>
<h2 id="&#x5B9E;&#x73B0;&#x6548;&#x679C;"><a href="#&#x5B9E;&#x73B0;&#x6548;&#x679C;" class="headerlink" title="&#x5B9E;&#x73B0;&#x6548;&#x679C;"></a>&#x5B9E;&#x73B0;&#x6548;&#x679C;</h2><p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/91f9ebdc603234e02afb8e0dd7e9b55a5708f3c8b531695da0f25fc462ed9173" alt></p>
<blockquote>
<p>&#x5728;&#x7EBF;&#x9884;&#x89C8;&#xFF1A;<a href="/external_links/09c2eedb8a1e4db7a102f63495e7e1e6.html" target="blank" rel="noopener">tricell.fun</a></p>
</blockquote>
<h2 id="&#x5B9E;&#x73B0;"><a href="#&#x5B9E;&#x73B0;" class="headerlink" title="&#x5B9E;&#x73B0;"></a>&#x5B9E;&#x73B0;</h2><h3 id="3D&#x6A21;&#x578B;"><a href="#3D&#x6A21;&#x578B;" class="headerlink" title="3D&#x6A21;&#x578B;"></a>3D&#x6A21;&#x578B;</h3><h4 id="&#x573A;&#x666F;&#x521D;&#x59CB;&#x5316;"><a href="#&#x573A;&#x666F;&#x521D;&#x59CB;&#x5316;" class="headerlink" title="&#x573A;&#x666F;&#x521D;&#x59CB;&#x5316;"></a>&#x573A;&#x666F;&#x521D;&#x59CB;&#x5316;</h4><h5 id="&#x1F30F;-&#x521B;&#x5EFA;&#x573A;&#x666F;"><a href="#&#x1F30F;-&#x521B;&#x5EFA;&#x573A;&#x666F;" class="headerlink" title="&#x1F30F; &#x521B;&#x5EFA;&#x573A;&#x666F;"></a><code>&#x1F30F;</code> &#x521B;&#x5EFA;&#x573A;&#x666F;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;scene = new THREE.Scene();</span><br></pre></td></tr></table></figure>

<h5 id="&#x1F4F7;-&#x521D;&#x59CB;&#x5316;&#x76F8;&#x673A;"><a href="#&#x1F4F7;-&#x521D;&#x59CB;&#x5316;&#x76F8;&#x673A;" class="headerlink" title="&#x1F4F7; &#x521D;&#x59CB;&#x5316;&#x76F8;&#x673A;"></a><code>&#x1F4F7;</code> &#x521D;&#x59CB;&#x5316;&#x76F8;&#x673A;</h5><p><code>&#x900F;&#x89C6;&#x76F8;&#x673A; PerspectiveCamera</code> &#x7684; <code>4&#x4E2A;</code> &#x53C2;&#x6570;&#x5206;&#x522B;&#x662F;&#x6307;&#xFF1A;&#x89C6;&#x573A;&#x3001;&#x957F;&#x5BBD;&#x6BD4;&#x3001;&#x8FD1;&#x9762;&#x3001;&#x8FDC;&#x9762;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);</span><br><span class="line">// &#x8BBE;&#x7F6E;&#x76F8;&#x673A;&#x4F4D;&#x7F6E;</span><br><span class="line">camera.position.set(600, 20, -200);</span><br><span class="line">// &#x76F8;&#x673A;&#x805A;&#x7126;&#x5230;&#x5C4F;&#x5E55;&#x4E2D;&#x592E;</span><br><span class="line">camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br></pre></td></tr></table></figure>

<h5 id="&#x1F4A1;-&#x521D;&#x59CB;&#x5316;&#x5149;&#x6E90;"><a href="#&#x1F4A1;-&#x521D;&#x59CB;&#x5316;&#x5149;&#x6E90;" class="headerlink" title="&#x1F4A1; &#x521D;&#x59CB;&#x5316;&#x5149;&#x6E90;"></a><code>&#x1F4A1;</code> &#x521D;&#x59CB;&#x5316;&#x5149;&#x6E90;</h5><p>&#x6DFB;&#x52A0; <code>&#x534A;&#x7403;&#x5149;&#x6E90; HemisphereLight</code>&#xFF1A;&#x521B;&#x5EFA;&#x5BA4;&#x5916;&#x6548;&#x679C;&#x66F4;&#x52A0;&#x81EA;&#x7136;&#x7684;&#x5149;&#x6E90;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;light = new THREE.HemisphereLight(0xffffff, 0x444444);</span><br><span class="line">light.position.set(0, 20, 0);</span><br><span class="line">scene.add(light);</span><br><span class="line">light = new THREE.DirectionalLight(0xffffff);</span><br><span class="line">light.position.set(0, 20, 10);</span><br><span class="line">light.castShadow = true;</span><br><span class="line">scene.add(light);</span><br></pre></td></tr></table></figure>

<p>&#x6DFB;&#x52A0; <code>&#x73AF;&#x5883;&#x5149; AmbientLight</code>&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;var ambiColor = &apos;#0C0C0C&apos;;</span><br><span class="line">var ambientLight = new THREE.AmbientLight(ambiColor);</span><br><span class="line">scene.add(ambientLight);</span><br></pre></td></tr></table></figure>

<h4 id="&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x5DE5;&#x5177;&#xFF08;&#x53EF;&#x9009;&#xFF09;"><a href="#&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x5DE5;&#x5177;&#xFF08;&#x53EF;&#x9009;&#xFF09;" class="headerlink" title="&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x5DE5;&#x5177;&#xFF08;&#x53EF;&#x9009;&#xFF09;"></a>&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x5DE5;&#x5177;&#xFF08;&#x53EF;&#x9009;&#xFF09;</h4><h5 id="&#x1F4E6;-&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x7F51;&#x683C;"><a href="#&#x1F4E6;-&#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x7F51;&#x683C;" class="headerlink" title="&#x1F4E6; &#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x7F51;&#x683C;"></a><code>&#x1F4E6;</code> &#x6DFB;&#x52A0;&#x8F85;&#x52A9;&#x7F51;&#x683C;</h5><p><code>GridHelper</code> &#x53EF;&#x7528;&#x4E8E;&#x6DFB;&#x52A0;&#x7F51;&#x683C;&#x8F85;&#x52A9;&#x7EBF;&#xFF0C;&#x4E5F;&#x53EF;&#x7528;&#x4E8E;&#x88C5;&#x9970;&#xFF0C;&#x901A;&#x8FC7; <code>GridHelper(size, divisions, colorCenterLine, colorGrid)</code> &#x5B9E;&#x73B0;&#x3002;</p>
<ul>
<li><code>size</code>&#xFF1A;&#x7F51;&#x683C;&#x5BBD;&#x5EA6;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>10</code>&#x3002;</li>
<li><code>divisions</code>&#xFF1A;&#x7B49;&#x5206;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>10</code>&#x3002;</li>
<li><code>colorCenterLine</code>&#xFF1A;&#x4E2D;&#x5FC3;&#x7EBF;&#x989C;&#x8272;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>0x444444</code>&#x3002;</li>
<li><code>colorGrid</code>&#xFF1A; &#x7F51;&#x683C;&#x7EBF;&#x989C;&#x8272;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>0x888888</code>&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;var grid = new THREE.GridHelper(1000, 100, 0x000000, 0x000000);</span><br><span class="line">grid.material.opacity = 0.1;</span><br><span class="line">grid.material.transparent = true;</span><br><span class="line">grid.position.set(0, -240, 0);</span><br><span class="line">scene.add(grid);</span><br></pre></td></tr></table></figure>

<h5 id="&#x1F4E6;-&#x6DFB;&#x52A0;&#x76F8;&#x673A;&#x63A7;&#x4EF6;"><a href="#&#x1F4E6;-&#x6DFB;&#x52A0;&#x76F8;&#x673A;&#x63A7;&#x4EF6;" class="headerlink" title="&#x1F4E6; &#x6DFB;&#x52A0;&#x76F8;&#x673A;&#x63A7;&#x4EF6;"></a><code>&#x1F4E6;</code> &#x6DFB;&#x52A0;&#x76F8;&#x673A;&#x63A7;&#x4EF6;</h5><p>&#x901A;&#x8FC7;&#x76F8;&#x673A;&#x63A7;&#x4EF6; <code>OrbitControls</code> &#x53EF;&#x4EE5;&#x5BF9;&#x4E09;&#x7EF4;&#x573A;&#x666F;&#x8FDB;&#x884C;&#x7F29;&#x653E;&#x3001;&#x5E73;&#x79FB;&#x3001;&#x65CB;&#x8F6C;&#x64CD;&#x4F5C;&#xFF0C;&#x672C;&#x8D28;&#x4E0A;&#x6539;&#x53D8;&#x7684;&#x5E76;&#x4E0D;&#x662F;&#x573A;&#x666F;&#xFF0C;&#x800C;&#x662F;&#x76F8;&#x673A;&#x7684;&#x53C2;&#x6570;&#x3002;&#x5F00;&#x53D1;&#x65F6; <code>OrbitControls.js</code> &#x9700;&#x8981;&#x5355;&#x72EC;&#x5F15;&#x5165;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;controls = new THREE.OrbitControls(camera, renderer.domElement);</span><br><span class="line">controls.target.set(0, 0, 0);</span><br><span class="line">controls.update();</span><br></pre></td></tr></table></figure>

<h5 id="&#x1F4E6;-&#x6DFB;&#x52A0;&#x6027;&#x80FD;&#x67E5;&#x770B;&#x63D2;&#x4EF6;"><a href="#&#x1F4E6;-&#x6DFB;&#x52A0;&#x6027;&#x80FD;&#x67E5;&#x770B;&#x63D2;&#x4EF6;" class="headerlink" title="&#x1F4E6; &#x6DFB;&#x52A0;&#x6027;&#x80FD;&#x67E5;&#x770B;&#x63D2;&#x4EF6;"></a><code>&#x1F4E6;</code> &#x6DFB;&#x52A0;&#x6027;&#x80FD;&#x67E5;&#x770B;&#x63D2;&#x4EF6;</h5><p><code>stats</code> &#x662F;&#x4E00;&#x4E2A; <code>Three.js</code> &#x5F00;&#x53D1;&#x7684;&#x8F85;&#x52A9;&#x5E93;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x52A8;&#x753B;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x5E27;&#x6570;&#x3002;<code>stats.js</code> &#x4E5F;&#x9700;&#x8981;&#x5355;&#x72EC;&#x5F15;&#x5165;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;stats = new Stats();</span><br><span class="line">container.appendChild(stats.dom);</span><br></pre></td></tr></table></figure>

<h4 id="&#x52A0;&#x8F7D;&#x6A21;&#x578B;"><a href="#&#x52A0;&#x8F7D;&#x6A21;&#x578B;" class="headerlink" title="&#x52A0;&#x8F7D;&#x6A21;&#x578B;"></a>&#x52A0;&#x8F7D;&#x6A21;&#x578B;</h4><p>&#x672C;&#x6587;&#x793A;&#x4F8B;&#x7528;&#x5230;&#x7684; <code>&#x6254;&#x94C1;&#x997C;&#x7684;&#x4EBA;</code> &#x96D5;&#x50CF; <code>3D</code> &#x6A21;&#x578B;&#x6765;&#x6E90;&#x4E8E; <code>threedscans.com</code>&#xFF0C;&#x53EF; <code>&#x514D;&#x8D39;&#x1F604;</code> &#x4E0B;&#x8F7D;&#x4F7F;&#x7528;&#xFF0C;&#x672C;&#x6587;&#x672B;&#x5C3E;&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x4E2A;&#x514D;&#x8D39;&#x6A21;&#x578B;&#x4E0B;&#x8F7D;&#x7F51;&#x7AD9;&#xFF0C;&#x6709; <code>200&#x591A;&#x9875;</code> &#x514D;&#x8D39;&#x6A21;&#x578B;&#xFF0C;&#x5927;&#x5BB6;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x8BDD;&#x53EF;&#x4EE5;&#x6311;&#x9009;&#x81EA;&#x5DF1;&#x559C;&#x6B22;&#x7684;&#x6A21;&#x578B;&#x4E0B;&#x8F7D;&#x4F7F;&#x7528;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x6709;&#x5EFA;&#x6A21;&#x80FD;&#x529B;&#x7684;&#x540C;&#x5B66;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>blender</code>&#x3001;<code>3dmax</code> &#x7B49;&#x4E13;&#x4E1A;&#x5EFA;&#x6A21;&#x8F6F;&#x4EF6;&#x751F;&#x6210;&#x81EA;&#x5DF1;&#x559C;&#x6B22;&#x7684;&#x6A21;&#x578B;&#x3002;</p>
<h5 id="&#x52A0;&#x8F7D;-obj-&#x6216;-fbx-&#x6A21;&#x578B;"><a href="#&#x52A0;&#x8F7D;-obj-&#x6216;-fbx-&#x6A21;&#x578B;" class="headerlink" title="&#x52A0;&#x8F7D; obj &#x6216; fbx &#x6A21;&#x578B;"></a>&#x52A0;&#x8F7D; <code>obj</code> &#x6216; <code>fbx</code> &#x6A21;&#x578B;</h5><p>&#x9700;&#x8981;&#x5355;&#x72EC;&#x5F15;&#x5165; <code>FBXLoader.js</code> &#x6216; <code>OBJLoader.js</code>&#xFF0C;<code>.fbx</code> &#x548C; <code>.obj</code> &#x683C;&#x5F0F;&#x7684;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// var loader = new THREE.FBXLoader();</span><br><span class="line">var loader = new THREE.OBJLoader();</span><br><span class="line">loader.load(model, function (object) {</span><br><span class="line">  object.traverse(function (child) {</span><br><span class="line">    if (child.isMesh) {</span><br><span class="line">      child.castShadow = true;</span><br><span class="line">      child.receiveShadow = true;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  object.rotation.y = Math.PI / 2;</span><br><span class="line">  object.position.set(0, -200, 0);</span><br><span class="line">  object.scale.set(0.32, 0.32, 0.32);</span><br><span class="line">  model = object;</span><br><span class="line">  scene.add(object);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<h5 id="&#x52A0;&#x8F7D;-gltf-&#x6A21;&#x578B;"><a href="#&#x52A0;&#x8F7D;-gltf-&#x6A21;&#x578B;" class="headerlink" title="&#x52A0;&#x8F7D; gltf &#x6A21;&#x578B;"></a>&#x52A0;&#x8F7D; <code>gltf</code> &#x6A21;&#x578B;</h5><p>&#x9700;&#x8981;&#x5355;&#x72EC;&#x5F15;&#x5165; <code>GLTFLoader.js</code>&#xFF0C;&#x52A0;&#x8F7D; <code>.gltf</code> &#x683C;&#x5F0F;&#x6A21;&#x578B;&#x65B9;&#x6CD5;&#x7A0D;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x6A21;&#x578B;&#x7684;&#x904D;&#x5386;&#x5BF9;&#x8C61;&#x548C;&#x6700;&#x7EC8;&#x6DFB;&#x52A0;&#x5230;&#x573A;&#x666F;&#x4E2D;&#x7684;&#x662F; <code>object.scene</code> &#x800C;&#x4E0D;&#x662F; <code>object</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;var loader = new THREE.GLTFLoader();</span><br><span class="line">loader.load(model, function (object) {</span><br><span class="line">  object.scene.traverse(function (child) {</span><br><span class="line">    if (child.isMesh) {</span><br><span class="line">      child.castShadow = true;</span><br><span class="line">      child.receiveShadow = true;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  object.scene.rotation.y = Math.PI / 2;</span><br><span class="line">  object.scene.position.set(0, -240, 0);</span><br><span class="line">  object.scene.scale.set(0.33, 0.33, 0.33);</span><br><span class="line">  model = object.scene;</span><br><span class="line">  scene.add(object.scene);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x6DFB;&#x52A0;&#x7F51;&#x683C;&#x3001;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;&#x6A21;&#x578B;&#x4E4B;&#x540E;&#x7684;&#x6548;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/4e71eefbb176f720ab2f0ab2b7947433a547c34bb2131a8783e06a29b33393d2" alt></p>
<h4 id="&#x6DFB;&#x52A0;&#x8F6C;&#x76D8;&#x52A8;&#x753B;"><a href="#&#x6DFB;&#x52A0;&#x8F6C;&#x76D8;&#x52A8;&#x753B;" class="headerlink" title="&#x6DFB;&#x52A0;&#x8F6C;&#x76D8;&#x52A8;&#x753B;"></a>&#x6DFB;&#x52A0;&#x8F6C;&#x76D8;&#x52A8;&#x753B;</h4><p>&#x901A;&#x8FC7; <code>requestAnimationFrame</code> &#x5237;&#x65B0;&#x9875;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x6DFB;&#x52A0;&#x8F6C;&#x76D8;&#x52A8;&#x753B;&#x6548;&#x679C;&#x3002;<code>window.requestAnimationFrame()</code> &#x544A;&#x8BC9;&#x6D4F;&#x89C8;&#x5668;&#x5E0C;&#x671B;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#x52A8;&#x753B;&#xFF0C;&#x5E76;&#x4E14;&#x8981;&#x6C42;&#x6D4F;&#x89C8;&#x5668;&#x5728;&#x4E0B;&#x6B21;&#x91CD;&#x7ED8;&#x4E4B;&#x524D;&#x8C03;&#x7528;&#x6307;&#x5B9A;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x66F4;&#x65B0;&#x52A8;&#x753B;&#x3002;&#x8BE5;&#x65B9;&#x6CD5;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x8BE5;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4F1A;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E0B;&#x4E00;&#x6B21;&#x91CD;&#x7ED8;&#x4E4B;&#x524D;&#x6267;&#x884C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;function animate () {</span><br><span class="line">  requestAnimationFrame(animate);</span><br><span class="line">  // &#x968F;&#x7740;&#x9875;&#x9762;&#x91CD;&#x7ED8;&#x4E0D;&#x65AD;&#x6539;&#x53D8;&#x573A;&#x666F;&#x7684;rotation.y&#x6765;&#x5B9E;&#x73B0;&#x65CB;&#x8F6C;</span><br><span class="line">  scene.rotation.y -= 0.015;</span><br><span class="line">  renderer.render(scene, camera);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="&#x6DFB;&#x52A0;&#x70B9;&#x51FB;&#x4EA4;&#x4E92;"><a href="#&#x6DFB;&#x52A0;&#x70B9;&#x51FB;&#x4EA4;&#x4E92;" class="headerlink" title="&#x6DFB;&#x52A0;&#x70B9;&#x51FB;&#x4EA4;&#x4E92;"></a>&#x6DFB;&#x52A0;&#x70B9;&#x51FB;&#x4EA4;&#x4E92;</h4><p>&#x5728; <code>Three.js</code> &#x573A;&#x666F;&#x4E2D;&#x6211;&#x4EEC;&#x8981;&#x70B9;&#x51FB;&#x67D0;&#x4E2A;&#x6A21;&#x578B;&#x83B7;&#x53D6;&#x5B83;&#x7684;&#x4FE1;&#x606F;&#x3001;&#x6216;&#x8005;&#x505A;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#xFF0C;&#x8981;&#x7528;&#x5230; <code>Raycaster&#xFF08;&#x5149;&#x7EBF;&#x6295;&#x5C04;&#xFF09;</code>&#xFF0C;&#x539F;&#x7406;&#x5C31;&#x662F;&#x5728;&#x4F60;&#x9F20;&#x6807;&#x70B9;&#x51FB;&#x7684;&#x4F4D;&#x7F6E;&#x53D1;&#x5C04;&#x4E00;&#x675F;&#x5C04;&#x7EBF;&#xFF0C;&#x88AB;&#x5C04;&#x7EBF;&#x4E2D;&#x7684;&#x7269;&#x4F53;&#x90FD;&#x88AB;&#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#x3002;&#x57FA;&#x672C;&#x8BED;&#x6CD5;&#x662F; <code>Raycaster(origin, direction, near, far)</code>&#xFF0C;&#x5176;&#x4E2D;&#xFF1A;</p>
<ul>
<li><code>origin</code>&#xFF1A;&#x5C04;&#x7EBF;&#x7684;&#x8D77;&#x70B9;&#x5411;&#x91CF;&#x3002;</li>
<li><code>direction</code>&#xFF1A;&#x5C04;&#x7EBF;&#x7684;&#x65B9;&#x5411;&#x5411;&#x91CF;&#x3002;</li>
<li><code>near</code>&#xFF1A;&#x6240;&#x6709;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x5E94;&#x8BE5;&#x6BD4; <code>near</code> &#x8FDC;&#x3002;&#x503C;&#x4E0D;&#x80FD;&#x4E3A;&#x8D1F;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>0</code>&#x3002;</li>
<li><code>far</code>&#xFF1A;&#x6240;&#x6709;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x5E94;&#x8BE5;&#x6BD4; <code>far</code> &#x8FD1;&#x3002;&#x4E0D;&#x80FD;&#x5C0F;&#x4E8E; <code>near</code>&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; <code>&#x65E0;&#x7A77;&#x5927;</code>&#x3002;</li>
</ul>
<p>&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x7684;&#x57FA;&#x672C;&#x6B65;&#x9AA4;&#x662F;&#xFF1A;&#x83B7;&#x53D6;&#x9F20;&#x6807;&#x5728;&#x5C4F;&#x5E55;&#x7684;&#x5750;&#x6807; <code>&#x2192;</code> &#x5C4F;&#x5E55;&#x5750;&#x6807;&#x8F6C;&#x6807;&#x51C6;&#x8BBE;&#x5907;&#x5750;&#x6807; <code>&#x2192;</code> &#x6807;&#x51C6;&#x8BBE;&#x5907;&#x5750;&#x6807;&#x8F6C;&#x4E16;&#x754C;&#x5750;&#x6807; <code>&#x2192;</code> &#x62FF;&#x5230;&#x9F20;&#x6807;&#x5728;&#x573A;&#x666F;&#x7684;&#x4E16;&#x754C;&#x5750;&#x6807; <code>&#x2192;</code> &#x6839;&#x636E;&#x4E16;&#x754C;&#x5750;&#x6807;&#x548C;&#x76F8;&#x673A;&#x751F;&#x6210;&#x5C04;&#x7EBF;&#x6295;&#x5C04;&#x65B9;&#x5411;&#x5355;&#x4F4D;&#x5411;&#x91CF; <code>&#x2192;</code> &#x6839;&#x636E;&#x5C04;&#x7EBF;&#x6295;&#x5C04;&#x65B9;&#x5411;&#x5355;&#x4F4D;&#x5411;&#x91CF;&#x521B;&#x5EFA;&#x5C04;&#x7EBF;&#x6295;&#x5C04;&#x5668;&#x5BF9;&#x8C61;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;//&#x58F0;&#x660E;raycaster&#x548C;mouse&#x53D8;&#x91CF;</span><br><span class="line">var raycaster = new THREE.Raycaster();</span><br><span class="line">var mouse = new THREE.Vector2();</span><br><span class="line">onMouseClick = event =&gt; {</span><br><span class="line">  // &#x5C06;&#x9F20;&#x6807;&#x70B9;&#x51FB;&#x4F4D;&#x7F6E;&#x7684;&#x5C4F;&#x5E55;&#x5750;&#x6807;&#x8F6C;&#x6210;threejs&#x4E2D;&#x7684;&#x6807;&#x51C6;&#x5750;&#x6807;&#xFF0C;&#x4EE5;&#x5C4F;&#x5E55;&#x4E2D;&#x5FC3;&#x4E3A;&#x539F;&#x70B9;&#xFF0C;&#x503C;&#x7684;&#x8303;&#x56F4;&#x4E3A;-1&#x5230;1.</span><br><span class="line">  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;</span><br><span class="line">  mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;</span><br><span class="line">  // &#x901A;&#x8FC7;&#x9F20;&#x6807;&#x70B9;&#x7684;&#x4F4D;&#x7F6E;&#x548C;&#x5F53;&#x524D;&#x76F8;&#x673A;&#x7684;&#x77E9;&#x9635;&#x8BA1;&#x7B97;&#x51FA;raycaster</span><br><span class="line">  raycaster.setFromCamera(mouse, camera);</span><br><span class="line">  // &#x83B7;&#x53D6;raycaster&#x76F4;&#x7EBF;&#x548C;&#x6240;&#x6709;&#x6A21;&#x578B;&#x76F8;&#x4EA4;&#x7684;&#x6570;&#x7EC4;&#x96C6;&#x5408;</span><br><span class="line">  let intersects = raycaster.intersectObjects(scene.children);</span><br><span class="line">  if (intersects.length &gt; 0) {</span><br><span class="line">    alert(&apos;HELLO WORLD&apos;)</span><br><span class="line">    // &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x904D;&#x5386;&#x5B9E;&#x73B0;&#x70B9;&#x51FB;&#x4E0D;&#x540C;mesh&#x89E6;&#x53D1;&#x4E0D;&#x540C;&#x4EA4;&#x4E92;&#xFF0C;&#x5982;&#xFF1A;</span><br><span class="line">    let selectedObj = intersects[0].object;</span><br><span class="line">    if (selectedObj.name === &apos;car&apos;) {</span><br><span class="line">      alert(&apos;&#x6C7D;&#x8F66;&#x1F697;&apos;)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">window.addEventListener(&apos;click&apos;, onMouseClick, false);</span><br></pre></td></tr></table></figure>

<h4 id="&#x6DFB;&#x52A0;3D&#x6587;&#x5B57;"><a href="#&#x6DFB;&#x52A0;3D&#x6587;&#x5B57;" class="headerlink" title="&#x6DFB;&#x52A0;3D&#x6587;&#x5B57;"></a>&#x6DFB;&#x52A0;3D&#x6587;&#x5B57;</h4><p>&#x4F7F;&#x7528; <code>TextGeometry(text : String, parameters : Object)</code> &#x6DFB;&#x52A0; <code>3D&#x6587;&#x5B57;</code>&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x53EF;&#x8BBE;&#x7F6E;&#x5C5E;&#x6027;&#x7684;&#x8BF4;&#x660E;&#xFF1A;</p>
<ul>
<li><code>size</code>&#xFF1A;&#x5B57;&#x53F7;&#x5927;&#x5C0F;&#xFF0C;&#x4E00;&#x822C;&#x4E3A;&#x5927;&#x5199;&#x5B57;&#x6BCD;&#x7684;&#x9AD8;&#x5EA6;&#x3002;</li>
<li><code>height</code>&#xFF1A;&#x6587;&#x5B57;&#x7684;&#x539A;&#x5EA6;&#x3002;</li>
<li><code>weight</code>&#xFF1A;&#x503C;&#x4E3A; <code>normal</code> &#x6216; <code>bold</code>&#xFF0C;&#x8868;&#x793A;&#x662F;&#x5426;&#x52A0;&#x7C97;&#x3002;</li>
<li><code>font</code>&#xFF1A;&#x5B57;&#x4F53;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F; <code>helvetiker</code>&#xFF0C;&#x9700;&#x5BF9;&#x5E94;&#x5F15;&#x7528;&#x7684;&#x5B57;&#x4F53;&#x6587;&#x4EF6;&#x3002;</li>
<li><code>style</code>&#xFF1A;&#x503C;&#x4E3A; <code>normal</code> &#x6216; <code>italics</code>&#xFF0C;&#x8868;&#x793A;&#x662F;&#x5426;&#x659C;&#x4F53;</li>
<li><code>bevelThickness</code>&#xFF1A;&#x5012;&#x89D2;&#x539A;&#x5EA6;&#x3002;</li>
<li><code>bevelSize</code>&#xFF1A;&#x5012;&#x89D2;&#x5BBD;&#x5EA6;&#x3002;</li>
<li><code>curveSegments</code>&#xFF1A;&#x5F27;&#x7EBF;&#x5206;&#x6BB5;&#x6570;&#xFF0C;&#x4F7F;&#x5F97;&#x6587;&#x5B57;&#x7684;&#x66F2;&#x7EBF;&#x66F4;&#x52A0;&#x5149;&#x6ED1;&#x3002;</li>
<li><code>bevelEnabled</code>&#xFF1A;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x662F;&#x5426;&#x4F7F;&#x7528;&#x5012;&#x89D2;&#xFF0C;&#x610F;&#x4E3A;&#x5728;&#x8FB9;&#x7F18;&#x5904;&#x659C;&#x5207;&#x3002;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;var loader = new THREE.FontLoader();</span><br><span class="line">loader.load(&apos;gentilis_regular.typeface.json&apos;, function (font) {</span><br><span class="line">  var textGeo = new THREE.TextGeometry(&apos;HELLO WORLD&apos;, {</span><br><span class="line">    font: font,</span><br><span class="line">    size: .8,</span><br><span class="line">    height: .8,</span><br><span class="line">    curveSegments: .05,</span><br><span class="line">    bevelThickness: .05,</span><br><span class="line">    bevelSize: .05,</span><br><span class="line">    bevelEnabled: true</span><br><span class="line">  });</span><br><span class="line">  var textMaterial = new THREE.MeshPhongMaterial({ color: 0x03c03c });</span><br><span class="line">  var mesh = new THREE.Mesh(textGeo, textMaterial);</span><br><span class="line">  mesh.position.set(0, 3.8, 0);</span><br><span class="line">  scene.add(mesh);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/c227c886ac27b71b78589d2de078f9f725a5cee554afbc9a22ac14f98cfc7c98" alt></p>
<h4 id="&#x4F18;&#x5316;"><a href="#&#x4F18;&#x5316;" class="headerlink" title="&#x4F18;&#x5316;"></a>&#x4F18;&#x5316;</h4><p>&#x73B0;&#x5728;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x5DF2;&#x7ECF;&#x57FA;&#x672C;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x4F46;&#x662F; <code>3D</code> &#x6A21;&#x578B;&#x7684;&#x4F53;&#x79EF;&#x4E00;&#x822C;&#x6BD4;&#x8F83;&#x5927;&#xFF0C;&#x90E8;&#x7F72;&#x4E4B;&#x540E;&#x6211;&#x53D1;&#x73B0;&#x7F51;&#x9875;&#x52A0;&#x8F7D;&#x975E;&#x5E38;&#x6162;&#xFF0C;&#x5F71;&#x54CD;&#x7528;&#x6237;&#x4F53;&#x9A8C;&#xFF0C;&#x51CF;&#x5C0F;&#x6A21;&#x578B;&#x4F53;&#x79EF;&#x662F;&#x5341;&#x5206;&#x5FC5;&#x8981;&#x7684;&#xFF0C;&#x5728;&#x7F51;&#x4E0A;&#x627E;&#x4E86;&#x5F88;&#x4E45;&#x538B;&#x7F29;&#x5DE5;&#x5177;&#xFF0C;&#x53D1;&#x73B0;&#x5728;&#x4E0D;&#x9700;&#x8981;&#x5B89;&#x88C5;&#x5927;&#x578B; <code>3D&#x5EFA;&#x6A21;&#x8F6F;&#x4EF6;</code> &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F7F;&#x7528; <code>obj2gltf</code> &#x53EF;&#x4EE5;&#x5C06;&#x4F53;&#x79EF;&#x8F83;&#x5927;&#x7684; <code>OBJ</code> &#x683C;&#x5F0F;&#x6A21;&#x578B;&#x8F6C;&#x5316;&#x4E3A; <code>gltf</code> &#x6A21;&#x578B;&#xFF0C;&#x6709;&#x6548;&#x4F18;&#x5316;&#x6A21;&#x578B;&#x4F53;&#x79EF;&#xFF0C;&#x63D0;&#x5347;&#x7F51;&#x9875;&#x52A0;&#x8F7D;&#x901F;&#x5EA6;&#x3002;</p>
<h5 id="&#x5B89;&#x88C5;"><a href="#&#x5B89;&#x88C5;" class="headerlink" title="&#x5B89;&#x88C5;"></a>&#x5B89;&#x88C5;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;npm install obj2gltf --save</span><br></pre></td></tr></table></figure>

<h5 id="&#x5C06;obj&#x6A21;&#x578B;&#x590D;&#x5236;&#x5230;&#x4EE5;&#x4E0B;&#x76EE;&#x5F55;&#x4E2D;"><a href="#&#x5C06;obj&#x6A21;&#x578B;&#x590D;&#x5236;&#x5230;&#x4EE5;&#x4E0B;&#x76EE;&#x5F55;&#x4E2D;" class="headerlink" title="&#x5C06;obj&#x6A21;&#x578B;&#x590D;&#x5236;&#x5230;&#x4EE5;&#x4E0B;&#x76EE;&#x5F55;&#x4E2D;"></a>&#x5C06;obj&#x6A21;&#x578B;&#x590D;&#x5236;&#x5230;&#x4EE5;&#x4E0B;&#x76EE;&#x5F55;&#x4E2D;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;node_modules\obj2gltf\bin</span><br></pre></td></tr></table></figure>

<h5 id="&#x6267;&#x884C;&#x8F6C;&#x7801;&#x6307;&#x4EE4;"><a href="#&#x6267;&#x884C;&#x8F6C;&#x7801;&#x6307;&#x4EE4;" class="headerlink" title="&#x6267;&#x884C;&#x8F6C;&#x7801;&#x6307;&#x4EE4;"></a>&#x6267;&#x884C;&#x8F6C;&#x7801;&#x6307;&#x4EE4;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;node obj2gltf.js -i demo.obj -o demo.gltf</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x56FE;&#x51FA;&#x73B0;&#x7C7B;&#x4F3C;&#x4E0A;&#x8FF0;&#x5185;&#x5BB9;&#xFF0C;&#x8F6C;&#x7801;&#x5B8C;&#x6210;&#xFF0C;&#x5BF9;&#x6BD4;&#x8F6C;&#x5316;&#x524D;&#x540E;&#x7684;&#x6587;&#x4EF6;&#x4F53;&#x79EF;&#xFF0C;&#x672C;&#x4F8B;&#x4E2D; <code>kas.obj</code> &#x521D;&#x59CB;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#x4E3A; <code>9.7M</code> &#x8F6C;&#x5316;&#x540E;&#x7684;&#x6587;&#x4EF6; <code>kas.gltf</code> &#x53EA;&#x6709; <code>4.6M</code>&#xFF0C;&#x4F53;&#x79EF;&#x7F29;&#x5C0F;&#x4E00;&#x534A;&#xFF0C;&#x6B64;&#x65F6;&#x5C06;&#x8F6C;&#x5316;&#x540E;&#x7684;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x5230;&#x9875;&#x9762;&#x4E0A;&#xFF0C;&#x8089;&#x773C;&#x51E0;&#x4E4E;&#x770B;&#x4E0D;&#x51FA;&#x6A21;&#x578B;&#x6548;&#x679C;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x540C;&#x65F6;&#x9875;&#x9762;&#x52A0;&#x8F7D;&#x901F;&#x5EA6;&#x5F97;&#x5230;&#x660E;&#x663E;&#x63D0;&#x5347;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/90cf0b43b47a7f77ff86aca75109876138f071cbe6095af4363c1ef1d7a661d4" alt></p>
<blockquote>
<p><code>obj2gltf</code> &#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x5E93;&#x4F7F;&#x7528;&#xFF0C;&#x901A;&#x8FC7; <code>node&#x670D;&#x52A1;</code> &#x5B9E;&#x65F6;&#x8F6C;&#x5316;&#x6A21;&#x578B;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6587;&#x7AE0;&#x672B;&#x5C3E;&#x94FE;&#x63A5;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x3002;<br>&#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x4F7F;&#x7528; <code>3D</code> &#x5EFA;&#x6A21;&#x8F6F;&#x4EF6;&#x5982; <code>blender</code> &#x7B49;&#x624B;&#x52A8;&#x901A;&#x8FC7;&#x51CF;&#x5C11;&#x6A21;&#x578B; <code>&#x9762;&#x6570;</code> &#x548C; <code>&#x7F29;&#x5C0F;&#x4F53;&#x79EF;</code> &#x7B49;&#x9014;&#x5F84;&#x5BF9;&#x6A21;&#x578B;&#x538B;&#x7F29;&#x4F18;&#x5316;&#xFF0C;&#x8FD9;&#x79CD;&#x4F18;&#x5316;&#x6548;&#x679C;&#x66F4;&#x660E;&#x663E;&#x3002;</p>
</blockquote>
<h4 id="&#x5B8C;&#x6574;&#x4EE3;&#x7801;"><a href="#&#x5B8C;&#x6574;&#x4EE3;&#x7801;" class="headerlink" title="&#x5B8C;&#x6574;&#x4EE3;&#x7801;"></a>&#x5B8C;&#x6574;&#x4EE3;&#x7801;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;var model = require(&apos;@/assets/models/kas.gltf&apos;);</span><br><span class="line">var container, stats, controls;</span><br><span class="line">var camera, scene, renderer, light, model;</span><br><span class="line">class Kas extends React.Component {</span><br><span class="line">  render () {</span><br><span class="line">    return (</span><br><span class="line">      &lt;div id=&quot;kas&quot;&gt;&lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  }</span><br><span class="line">  componentDidMount () {</span><br><span class="line">    this.initThree();</span><br><span class="line">  }</span><br><span class="line">  initThree () {</span><br><span class="line">    init();</span><br><span class="line">    animate();</span><br><span class="line">    function init () {</span><br><span class="line">      container = document.getElementById(&apos;kas&apos;);</span><br><span class="line">      scene = new THREE.Scene();</span><br><span class="line">      scene.fog = new THREE.Fog(0xa0a0a0, 200, 1000);</span><br><span class="line">      // &#x900F;&#x89C6;&#x76F8;&#x673A;&#xFF1A;&#x89C6;&#x573A;&#x3001;&#x957F;&#x5BBD;&#x6BD4;&#x3001;&#x8FD1;&#x9762;&#x3001;&#x8FDC;&#x9762;</span><br><span class="line">      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);</span><br><span class="line">      camera.position.set(600, 20, -200);</span><br><span class="line">      camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br><span class="line">      // &#x534A;&#x7403;&#x5149;&#x6E90;&#xFF1A;&#x521B;&#x5EFA;&#x5BA4;&#x5916;&#x6548;&#x679C;&#x66F4;&#x52A0;&#x81EA;&#x7136;&#x7684;&#x5149;&#x6E90;</span><br><span class="line">      light = new THREE.HemisphereLight(0xffffff, 0x444444);</span><br><span class="line">      light.position.set(0, 20, 0);</span><br><span class="line">      scene.add(light);</span><br><span class="line">      light = new THREE.DirectionalLight(0xffffff);</span><br><span class="line">      light.position.set(0, 20, 10);</span><br><span class="line">      light.castShadow = true;</span><br><span class="line">      scene.add(light);</span><br><span class="line">      // &#x73AF;&#x5883;&#x5149;</span><br><span class="line">      var ambiColor = &apos;#0C0C0C&apos;;</span><br><span class="line">      var ambientLight = new THREE.AmbientLight(ambiColor);</span><br><span class="line">      scene.add(ambientLight);</span><br><span class="line">      // &#x7F51;&#x683C;</span><br><span class="line">      var grid = new THREE.GridHelper(1000, 100, 0x000000, 0x000000);</span><br><span class="line">      grid.material.opacity = 0.1;</span><br><span class="line">      grid.material.transparent = true;</span><br><span class="line">      grid.position.set(0, -240, 0);</span><br><span class="line">      scene.add(grid);</span><br><span class="line">      // &#x52A0;&#x8F7D;gltf&#x6A21;&#x578B;</span><br><span class="line">      var loader = new THREE.GLTFLoader();</span><br><span class="line">      loader.load(model, function (object) {</span><br><span class="line">        object.scene.traverse(function (child) {</span><br><span class="line">          if (child.isMesh) {</span><br><span class="line">            child.castShadow = true;</span><br><span class="line">            child.receiveShadow = true;</span><br><span class="line">          }</span><br><span class="line">        });</span><br><span class="line">        object.scene.rotation.y = Math.PI / 2;</span><br><span class="line">        object.scene.position.set(0, -240, 0);</span><br><span class="line">        object.scene.scale.set(0.33, 0.33, 0.33);</span><br><span class="line">        model = object.scene;</span><br><span class="line">        scene.add(object.scene);</span><br><span class="line">      });</span><br><span class="line">      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });</span><br><span class="line">      renderer.setPixelRatio(window.devicePixelRatio);</span><br><span class="line">      renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">      renderer.setClearAlpha(0);</span><br><span class="line">      renderer.shadowMap.enabled = true;</span><br><span class="line">      container.appendChild(renderer.domElement);</span><br><span class="line">      window.addEventListener(&apos;resize&apos;, () =&gt; {</span><br><span class="line">        camera.aspect = window.innerWidth / window.innerHeight;</span><br><span class="line">        camera.updateProjectionMatrix();</span><br><span class="line">        renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">      }, false);</span><br><span class="line">      stats = new Stats();</span><br><span class="line">      container.appendChild(stats.dom);</span><br><span class="line">    }</span><br><span class="line">    function animate () {</span><br><span class="line">      var clock = new THREE.Clock()</span><br><span class="line">      requestAnimationFrame(animate);</span><br><span class="line">      var delta = clock.getDelta();</span><br><span class="line">      scene.rotation.y -= 0.015;</span><br><span class="line">      renderer.render(scene, camera);</span><br><span class="line">      stats.update();</span><br><span class="line">    }</span><br><span class="line">    // &#x589E;&#x52A0;&#x70B9;&#x51FB;&#x4E8B;&#x4EF6;</span><br><span class="line">    //&#x58F0;&#x660E;raycaster&#x548C;mouse&#x53D8;&#x91CF;</span><br><span class="line">    var raycaster = new THREE.Raycaster();</span><br><span class="line">    var mouse = new THREE.Vector2();</span><br><span class="line">    function onMouseClick(event) {</span><br><span class="line">      // &#x901A;&#x8FC7;&#x9F20;&#x6807;&#x70B9;&#x51FB;&#x4F4D;&#x7F6E;&#x8BA1;&#x7B97;&#x51FA;raycaster&#x6240;&#x9700;&#x8981;&#x70B9;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4EE5;&#x5C4F;&#x5E55;&#x4E2D;&#x5FC3;&#x4E3A;&#x539F;&#x70B9;&#xFF0C;&#x503C;&#x7684;&#x8303;&#x56F4;&#x4E3A;-1&#x5230;1.</span><br><span class="line">      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;</span><br><span class="line">      mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;</span><br><span class="line">      // &#x901A;&#x8FC7;&#x9F20;&#x6807;&#x70B9;&#x7684;&#x4F4D;&#x7F6E;&#x548C;&#x5F53;&#x524D;&#x76F8;&#x673A;&#x7684;&#x77E9;&#x9635;&#x8BA1;&#x7B97;&#x51FA;raycaster</span><br><span class="line">      raycaster.setFromCamera(mouse, camera);</span><br><span class="line">      // &#x83B7;&#x53D6;raycaster&#x76F4;&#x7EBF;&#x548C;&#x6240;&#x6709;&#x6A21;&#x578B;&#x76F8;&#x4EA4;&#x7684;&#x6570;&#x7EC4;&#x96C6;&#x5408;</span><br><span class="line">      var intersects = raycaster.intersectObjects(scene.children);</span><br><span class="line">      if (intersects.length &gt; 0) {</span><br><span class="line">        alert(&apos;HELLO WORLD&apos;)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    window.addEventListener(&apos;click&apos;, onMouseClick, false);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="&#x5176;&#x4ED6;&#x8BBE;&#x8BA1;&#x5143;&#x7D20;"><a href="#&#x5176;&#x4ED6;&#x8BBE;&#x8BA1;&#x5143;&#x7D20;" class="headerlink" title="&#x5176;&#x4ED6;&#x8BBE;&#x8BA1;&#x5143;&#x7D20;"></a>&#x5176;&#x4ED6;&#x8BBE;&#x8BA1;&#x5143;&#x7D20;</h3><p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD; <code>3D&#x5143;&#x7D20;</code> &#x7684;&#x52A0;&#x8F7D;&#xFF0C;&#x7531;&#x4E8E;&#x6587;&#x7AE0;&#x7BC7;&#x5E45;&#x4EE5;&#x53CA;&#x65F6;&#x95F4;&#x6709;&#x9650;&#xFF08;<code>&#x535A;&#x4E3B;&#x592A;&#x61D2;&#x1F602;</code>&#xFF09;&#x5176;&#x4ED6;&#x5143;&#x7D20;&#x7684;&#x5B9E;&#x73B0;&#x4E0D;&#x505A;&#x8BE6;&#x7EC6;&#x8BB2;&#x89E3;&#xFF08;&#x53EF;&#x80FD;&#x540E;&#x7EED;&#x6709;&#x65F6;&#x95F4;&#x4F1A;&#x603B;&#x7ED3;&#x6574;&#x7406; <code>maybe</code>&#xFF09;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x6269;&#x5C55;&#x9605;&#x8BFB;&#x4EE5;&#x4E0B;&#x5176;&#x4ED6;&#x5927;&#x795E;&#x4F18;&#x79C0;&#x7684;&#x6587;&#x7AE0;&#x3002;</p>
<h4 id="&#x6D41;&#x4F53;&#x80CC;&#x666F;"><a href="#&#x6D41;&#x4F53;&#x80CC;&#x666F;" class="headerlink" title="&#x6D41;&#x4F53;&#x80CC;&#x666F;"></a>&#x6D41;&#x4F53;&#x80CC;&#x666F;</h4><p><code>&#x9759;&#x6001;</code> &#x6DB2;&#x6001;&#x80CC;&#x666F;&#x56FE;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>SVG filter</code> &#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x9605;&#x8BFB;<a href="/external_links/f6266796e455fa73aed5bfe3178354da.html" target="blank" rel="noopener">&#x300A;Creating Patterns With SVG Filters&#x300B;</a>&#xFF0C;&#x5B9E;&#x73B0; <code>&#x52A8;&#x6001;</code> &#x6D41;&#x4F53;&#x80CC;&#x666F;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Three.js &#x7ED3;&#x5408;&#x539F;&#x751F;GLSL&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x53C2;&#x8003;<a href="/external_links/0a1f6cc7554e5c37449d7e82be438353.html" target="blank" rel="noopener">&#x300A;CodePen Shader Template&#x300B;</a>&#x793A;&#x4F8B;&#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/a33771cd01ad45666fc2fb7cf13ba293dba5f492ce1188795d136cbd0f7c88e2" alt></p>
<p>&#x91D1;&#x5C5E;&#x3001;&#x9713;&#x8679;&#x3001;&#x6545;&#x969C;&#x6548;&#x679C;&#x7B49;&#x9178;&#x6027;&#x6548;&#x679C;&#x5B57;&#x4F53;&#x53EF;&#x4EE5;&#x9605;&#x8BFB;&#x6211;&#x7684;&#x53E6;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;<a href="https://dev.newban.cn/6972759988632551460">&#x300A;&#x4EC5;&#x7528;CSS&#x51E0;&#x6B65;&#x5B9E;&#x73B0;&#x8D5B;&#x535A;&#x670B;&#x514B;2077&#x98CE;&#x683C;&#x89C6;&#x89C9;&#x6548;&#x679C;&#x300B;</a>&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BBE;&#x8BA1;&#x751F;&#x6210;&#xFF0C;&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x5173;&#x7CFB;&#xFF0C;&#x672C;&#x6587;&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x91D1;&#x5C5E;&#x6548;&#x679C;&#x6587;&#x5B57;&#x4EE5;&#x53CA;&#x672C;&#x6587;banner&#x5934;&#x56FE;&#x4E2D;&#x7684;&#x6587;&#x5B57;&#x90FD;&#x662F;&#x4F7F;&#x7528;<a href="/external_links/14cb6ce480ae69367b4fceef0414b259.html" target="blank" rel="noopener">&#x5728;&#x7EBF;&#x827A;&#x672F;&#x5B57;&#x4F53;&#x751F;&#x6210;&#x7F51;&#x7AD9;</a>&#x751F;&#x6210;&#x7684;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x5C1D;&#x8BD5;&#x8BBE;&#x8BA1;&#x3002;</p>
<h3 id="&#x672A;&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x4F18;&#x5316;"><a href="#&#x672A;&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x4F18;&#x5316;" class="headerlink" title="&#x672A;&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x4F18;&#x5316;"></a>&#x672A;&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x4F18;&#x5316;</h3><ul>
<li><code>#todo</code> &#x9178;&#x6027;&#x98CE;&#x683C;&#x6DB2;&#x6001;&#x80CC;&#x666F;&#x5B9E;&#x73B0;&#x3002;</li>
<li><code>#todo</code> <code>3D&#x6A21;&#x578B;</code>&#x6DB2;&#x6001;&#x91D1;&#x5C5E;&#x6548;&#x679C;&#x3002;</li>
</ul>
<h2 id="three-js-&#x4F18;&#x79C0;&#x6848;&#x4F8B;&#x63A8;&#x8350;"><a href="#three-js-&#x4F18;&#x79C0;&#x6848;&#x4F8B;&#x63A8;&#x8350;" class="headerlink" title="three.js &#x4F18;&#x79C0;&#x6848;&#x4F8B;&#x63A8;&#x8350;"></a><code>three.js</code> &#x4F18;&#x79C0;&#x6848;&#x4F8B;&#x63A8;&#x8350;</h2><p>&#x6700;&#x540E;&#x7ED9;&#x5927;&#x5BB6;&#x63A8;&#x8350;&#x51E0;&#x4E2A;&#x975E;&#x5E38;&#x60CA;&#x8273;&#x7684; <code>three.js</code> &#x9879;&#x76EE;&#x6765;&#x4E00;&#x8D77;&#x4F53;&#x9A8C;&#x548C;&#x5B66;&#x4E60;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x9875;&#x9762;&#x4EA4;&#x4E92;&#x3001;&#x89C6;&#x89C9;&#x8BBE;&#x8BA1;&#x8FD8;&#x662F;&#x6027;&#x80FD;&#x4F18;&#x5316;&#x90FD;&#x505A;&#x5230;&#x4E86;&#x6781;&#x81F4;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;&#x4E2D;&#x5B66;&#x5230;&#x5F88;&#x591A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/d0180981fa731ca4d367db04b102dd313476e60bc18da9fb37ce3d05466f088e" alt></p>
<ul>
<li><a href="/external_links/5b9a62ca049a3b691429d8120b654bde.html" target="blank" rel="noopener">github&#x9996;&#x9875;</a>&#xFF1A;<code>3D&#x5730;&#x7403;</code> &#x5B9E;&#x65F6;&#x663E;&#x793A;&#x5168;&#x7403;&#x70ED;&#x95E8;&#x4ED3;&#x5E93;&#x3002;</li>
<li><a href="/external_links/d0ad353b202fc9e76b5f6076c0c004da.html" target="blank" rel="noopener">kodeclubs</a>&#xFF1A;&#x4F4E;&#x9762;&#x6570; <code>3D&#x57CE;&#x5E02;</code> &#x7B2C;&#x4E09;&#x4EBA;&#x79F0;&#x5C0F;&#x6E38;&#x620F;&#x3002;</li>
<li><a href="/external_links/623b365d3027ef08d5bd36c30bb22902.html" target="blank" rel="noopener">&#x7403;&#x978B;&#x5C55;&#x793A;</a>&#xFF1A;<code>720&#x5EA6;</code> &#x7403;&#x978B;&#x52A8;&#x6001;&#x5C55;&#x793A;&#x3002;</li>
<li><a href="/external_links/52e45faddb6a12424277e3f5236d9f2e.html" target="blank" rel="noopener">&#x6C99;&#x96D5;dance</a>&#xFF1A;&#x6C99;&#x96D5;&#x52A8;&#x7269;&#x821E;&#x8005;&#x3002;</li>
<li><a href="/external_links/5974d598d49c4649ac3c7c23a72a161c.html" target="blank" rel="noopener">Zenly&#x8F6F;&#x4EF6;</a>&#xFF1A;<code>Zenly App</code> &#x4E2D;&#x6587;&#x4E3B;&#x9875;&#x3002;</li>
</ul>
<h2 id="&#x53C2;&#x8003;&#x8D44;&#x6599;"><a href="#&#x53C2;&#x8003;&#x8D44;&#x6599;" class="headerlink" title="&#x53C2;&#x8003;&#x8D44;&#x6599;"></a>&#x53C2;&#x8003;&#x8D44;&#x6599;</h2><ul>
<li>three.js: <a href="/external_links/c09cedab2e34afe35bfb191ca0a66c7c.html" target="blank" rel="noopener">threejs.org</a></li>
<li>obj2gltf: <a href="/external_links/3e095a6ebe60e3e14d30780413f7a5c6.html" target="blank" rel="noopener">github.com/CesiumGS/ob&#x2026;</a></li>
<li>200&#x591A;&#x9875;&#x514D;&#x8D39;3d&#x6A21;&#x578B; <a href="/external_links/cc3d342013fe6e8da56a989e56bb8b10.html" target="blank" rel="noopener">www.turbosquid.com</a></li>
<li>&#x514D;&#x8D39;3D&#x96D5;&#x50CF;: <a href="/external_links/0206ea24c43921a1771c9d56e1346ed1.html" target="blank" rel="noopener">threedscans.com</a></li>
<li>&#x514D;&#x8D39;3D&#x6A21;&#x578B;&#xFF1A;<a href="/external_links/0869d1dd6f4677c7cd7b623fe0fe6592.html" target="blank" rel="noopener">free3d.com</a></li>
<li>&#x827A;&#x672F;&#x5B57;&#x4F53;&#x5728;&#x7EBF;&#x751F;&#x6210;&#xFF1A;<a href="/external_links/14cb6ce480ae69367b4fceef0414b259.html" target="blank" rel="noopener">cooltext.com</a></li>
<li>&#x4EC0;&#x4E48;&#x662F;&#x9178;&#x6027;&#x8BBE;&#x8BA1;&#xFF1A;<a href="/external_links/75f61a46a77b8a49728f8b4fe2ba269c.html" target="blank" rel="noopener">www.shejipi.com/361258.html</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/9eb788ef5a6af724e7382b9c3b84ad90.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7012210233804079141.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7012210233804079141.html" itemprop="url">掘力星计划开启，赢取创作大礼包，挑战创作激励金</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-26T20:01:42+08:00">
                2021-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hi &#x6398;&#x53CB;&#x4EEC;&#xFF0C;</p>
<p>&#x7A00;&#x571F;&#x6398;&#x91D1;&#x4E3A;&#x9F13;&#x52B1;&#x6240;&#x6709;&#x80FD;&#x521B;&#x4F5C;&#x4F18;&#x8D28;&#x5185;&#x5BB9;&#x7684;&#x6398;&#x53CB;&#xFF0C;&#x7528;&#x5FC3;&#x5206;&#x4EAB;&#xFF0C;&#x6301;&#x7EED;&#x8F93;&#x51FA;&#xFF0C;&#x63A8;&#x51FA;&#x9996;&#x671F;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF01;&#x4E0D;&#x9650;&#x6398;&#x529B;&#x503C;&#x3001;&#x4E0D;&#x9650;&#x7B49;&#x7EA7;&#x3001;&#x4E0D;&#x9650;&#x5165;&#x9A7B;&#x65F6;&#x957F;&#xFF0C;&#x53EA;&#x8981;&#x4F60;&#x6709;&#x4F18;&#x79C0;&#x7684;&#x8F93;&#x51FA;&#x80FD;&#x529B;&#xFF0C;&#x5C31;&#x6709;&#x673A;&#x4F1A;&#x52A0;&#x5165;&#x9996;&#x6279;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF0C;&#x62FF;&#x5927;&#x793C;&#x5305;&#xFF0C;&#x8D62;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#xFF0C;&#x89E3;&#x9501;&#x8D85;&#x591A;&#x6276;&#x6301;&#x6743;&#x76CA;&#xFF01;&#x6587;&#x672B;&#x626B;&#x7801;&#x5165;&#x8FDB;&#x6D3B;&#x52A8;&#x7FA4;&#xFF0C;&#x6D3B;&#x52A8;&#x671F;&#x95F4;&#x968F;&#x65F6;&#x83B7;&#x53D6;&#x4E00;&#x624B;&#x5B98;&#x65B9;&#x6D88;&#x606F;&#xFF01;</p>
<h3 id="&#x9996;&#x671F;&#x65F6;&#x95F4;"><a href="#&#x9996;&#x671F;&#x65F6;&#x95F4;" class="headerlink" title="&#x9996;&#x671F;&#x65F6;&#x95F4;"></a>&#x9996;&#x671F;&#x65F6;&#x95F4;</h3><blockquote>
<p>2021&#x5E74;10&#x6708;1&#x65E5;&#x2013;10&#x6708;31&#x65E5;</p>
</blockquote>
<h3 id="&#x53C2;&#x4E0E;&#x6761;&#x4EF6;"><a href="#&#x53C2;&#x4E0E;&#x6761;&#x4EF6;" class="headerlink" title="&#x53C2;&#x4E0E;&#x6761;&#x4EF6;"></a>&#x53C2;&#x4E0E;&#x6761;&#x4EF6;</h3><blockquote>
<p>&#x4E0D;&#x9650;&#x5165;&#x9A7B;&#x65F6;&#x957F;&#x3001;&#x4E0D;&#x9650;&#x6398;&#x529B;&#x503C;&#x3001;&#x4E0D;&#x9650;&#x7B49;&#x7EA7;&#xFF0C;&#x65B0;&#x8001;&#x6398;&#x53CB;&#x5747;&#x53EF;&#x53C2;&#x52A0;</p>
</blockquote>
<h3 id="&#x6295;&#x7A3F;&#x8981;&#x6C42;"><a href="#&#x6295;&#x7A3F;&#x8981;&#x6C42;" class="headerlink" title="&#x6295;&#x7A3F;&#x8981;&#x6C42;"></a>&#x6295;&#x7A3F;&#x8981;&#x6C42;</h3><blockquote>
<ul>
<li>&#x3010;&#x6587;&#x7AE0;&#x7B2C;&#x4E00;&#x53E5;&#x3011;&#x672C;&#x6587;&#x5DF2;&#x53C2;&#x4E0E;&#x300C;<a href="https://dev.newban.cn/7012210233804079141/">&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;</a>&#x300D;&#xFF0C;&#x8D62;&#x53D6;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;&#xFF0C;&#x6311;&#x6218;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x3002;</li>
<li>&#x3010;&#x6295;&#x7A3F;&#x6570;&#x91CF;&#x3011;&#x6295;&#x7A3F; &#x2267;4 &#x7BC7;&#xFF0C;&#x6BCF;&#x7BC7;&#x5B57;&#x6570; &#x2267; 800&#xFF0C;&#x5373;&#x53C2;&#x4E0E;&#x6210;&#x529F;&#xFF0C;&#x53EF;&#x8FDB;&#x5165;&#x5956;&#x9879;&#x8BC4;&#x9009;</li>
<li>&#x3010;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x3011;&#x975E;&#x6807;&#x9898;&#x515A;&#xFF1B;&#x975E;&#x9762;&#x8BD5;&#x9898;&#x3001;&#x6574;&#x5408;&#x7C7B;&#x6587;&#x7AE0;&#xFF1B;&#x6280;&#x672F;&#x7C7B;&#x6587;&#x7AE0;&#x4E3A;&#x4F73;</li>
<li>&#x3010;&#x6587;&#x7AE0;&#x5206;&#x7C7B;&#x3011;&#x524D;&#x7AEF;&#x3001;&#x540E;&#x7AEF;&#x3001;iOS&#x3001;android&#xFF0C;&#x9009;&#x62E9;&#x5176;&#x4ED6;&#x5206;&#x7C7B;&#x65E0;&#x6548;</li>
<li>&#x3010;&#x8BC4;&#x8BBA;&#x62BD;&#x5956;&#x3011;&#x6240;&#x6709;&#x53EA;&#x53C2;&#x4E0E;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;&#x6D3B;&#x52A8;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x6587;&#x7AE0;&#x8BC4;&#x8BBA;&#x533A;&#x7684;&#x7528;&#x6237;&#x5747;&#x53EF;&#x53C2;&#x4E0E;&#x8BC4;&#x8BBA;&#x62BD;&#x5956;&#x3002;&#x6587;&#x7AE0;&#x4F5C;&#x8005;&#x53EF;&#x4EE5;&#x5728;&#x6587;&#x4E2D;&#x5F15;&#x5BFC;&#x7528;&#x6237;&#x5728;&#x8BC4;&#x8BBA;&#x533A;&#x8FDB;&#x884C;&#x6709;&#x8D28;&#x91CF;&#x7684;&#x4E92;&#x52A8;&#x3002;<ul>
<li>&#x5F15;&#x5BFC;&#x65B9;&#x5F0F;&#xFF1A;&#x6BD4;&#x5982;&#x5728;&#x6295;&#x7A3F;&#x6587;&#x7AE0;&#x7684;&#x672B;&#x5C3E;&#x5199;&#x300C;&#x6B22;&#x8FCE;&#x5728;&#x8BC4;&#x8BBA;&#x533A;&#x8BA8;&#x8BBA;&#xFF0C;&#x6398;&#x91D1;&#x5B98;&#x65B9;&#x5C06;&#x5728;<a href="https://dev.newban.cn/7012210233804079141">&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;</a>&#x6D3B;&#x52A8;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x5728;&#x8BC4;&#x8BBA;&#x533A;&#x62BD;&#x9001;100&#x4EFD;&#x6398;&#x91D1;&#x5468;&#x8FB9;&#xFF0C;&#x62BD;&#x5956;&#x8BE6;&#x60C5;&#x89C1;&#x6D3B;&#x52A8;&#x6587;&#x7AE0;&#x300D;&#x3002;</li>
<li>&#x62BD;&#x5956;&#x793C;&#x7269;&#xFF1A;100&#x4EFD;&#xFF0C;&#x6398;&#x91D1;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#xFF0C;&#x5305;&#x62EC;&#x6398;&#x91D1;&#x5FBD;&#x7AE0;&#x3001;&#x62D6;&#x978B;&#x3001;&#x9A6C;&#x514B;&#x676F;&#x3001;&#x5E06;&#x5E03;&#x888B;&#x7B49;&#xFF0C;&#x968F;&#x673A;&#x53D1;&#x653E;</li>
<li>&#x62BD;&#x5956;&#x65F6;&#x95F4;&#xFF1A;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;&#x6D3B;&#x52A8;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x9884;&#x8BA1;3&#x4E2A;&#x5DE5;&#x4F5C;&#x65E5;&#x5185;&#xFF0C;&#x5B98;&#x65B9;&#x5C06;&#x5728;&#x6240;&#x6709;&#x7B26;&#x5408;&#x89C4;&#x5219;&#x7684;&#x6D3B;&#x52A8;&#x6587;&#x7AE0;&#x8BC4;&#x8BBA;&#x533A;&#x62BD;&#x51FA;</li>
<li>&#x62BD;&#x5956;&#x65B9;&#x5F0F;&#xFF1A;&#x6398;&#x91D1;&#x5B98;&#x65B9;&#x968F;&#x673A;&#x62BD;&#x5956;+&#x4EBA;&#x5DE5;&#x6838;&#x5B9E;</li>
<li>&#x8BC4;&#x8BBA;&#x5185;&#x5BB9;&#xFF1A;&#x4E0E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x76F8;&#x5173;&#x7684;&#x8BC4;&#x8BBA;&#x3001;&#x5EFA;&#x8BAE;&#x3001;&#x8BA8;&#x8BBA;&#x7B49;&#xFF0C;&#x300C;&#x8E29;&#x8E29;&#x300D;&#x300C;&#x5B66;&#x4E60;&#x4E86;&#x300D;&#x7B49;&#x6CDB;&#x6CDB;&#x7C7B;&#x7684;&#x8BC4;&#x8BBA;&#x65E0;&#x6CD5;&#x83B7;&#x5956;</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="&#x8BC4;&#x9009;&#x6761;&#x4EF6;"><a href="#&#x8BC4;&#x9009;&#x6761;&#x4EF6;" class="headerlink" title="&#x8BC4;&#x9009;&#x6761;&#x4EF6;"></a>&#x8BC4;&#x9009;&#x6761;&#x4EF6;</h3><blockquote>
<ul>
<li>&#x4EE5;&#x4E0B;&#x5956;&#x9879;&#x8BC4;&#x9009;&#x9879;&#xFF1A;&#x6587;&#x7AE0;&#x8D28;&#x91CF;&#x3001;&#x6587;&#x7AE0;&#x5B57;&#x6570;&#x3001;&#x6295;&#x7A3F;&#x6570;&#x91CF;&#x3001;&#x6587;&#x7AE0;&#x9605;&#x8BFB;&#x91CF;&#x3001;&#x4E92;&#x52A8;&#x6570;&#x636E;&#xFF08;&#x70B9;&#x8D5E;&#x3001;&#x8BC4;&#x8BBA;&#x3001;&#x6536;&#x85CF;&#xFF09;&#x3001;&#x4E92;&#x52A8;&#x8D28;&#x91CF;&#xFF08;&#x8BC4;&#x8BBA;&#x662F;&#x5426;&#x662F;&#x4E0E;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x76F8;&#x5173;&#x7684;&#x8BA8;&#x8BBA;/&#x5EFA;&#x8BAE;&#x7B49;&#xFF09;</li>
<li><strong>&#x8BC4;&#x5956;&#x65F6;&#xFF0C;&#x8FD0;&#x8425;&#x540C;&#x5B66;&#x5C06;&#x6838;&#x5BF9;&#x6BCF;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x67E5;&#x770B;&#x662F;&#x5426;&#x6709;&#x5237;&#x91CF;&#x7B49;&#x8FDD;&#x89C4;&#x884C;&#x4E3A;&#xFF0C;&#x5982;&#x5B58;&#x5728;&#x8FDD;&#x89C4;&#x884C;&#x4E3A;&#x53D6;&#x6D88;&#x5DF2;&#x7ECF;&#x53C2;&#x4E0E;&#x7684;&#x6240;&#x6709;&#x6D3B;&#x52A8;&#x7684;&#x83B7;&#x5956;&#x8D44;&#x683C;</strong></li>
</ul>
</blockquote>
<h3 id="&#x52A0;&#x5165;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF0C;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x7B49;&#x4F60;&#x62FF;"><a href="#&#x52A0;&#x5165;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF0C;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x7B49;&#x4F60;&#x62FF;" class="headerlink" title="&#x52A0;&#x5165;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF0C;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x7B49;&#x4F60;&#x62FF;"></a>&#x52A0;&#x5165;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#xFF0C;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x7B49;&#x4F60;&#x62FF;</h3><h4 id="&#x2605;-&#x521B;&#x4F5C;&#x74DC;&#x5206;&#x5956;"><a href="#&#x2605;-&#x521B;&#x4F5C;&#x74DC;&#x5206;&#x5956;" class="headerlink" title="&#x2605; &#x521B;&#x4F5C;&#x74DC;&#x5206;&#x5956;"></a>&#x2605; &#x521B;&#x4F5C;&#x74DC;&#x5206;&#x5956;</h4><table>
<thead>
<tr>
<th>&#x74DC;&#x5206;&#x5956;&#x6761;&#x4EF6;</th>
<th>&#x5956;&#x54C1;</th>
</tr>
</thead>
<tbody><tr>
<td>&#x9605;&#x8BFB; &#x2267; 100 &#x7684;&#x6587;&#x7AE0; &#x2267; 2 &#x7BC7;&#xFF0C;&#x6BCF;&#x7BC7;&#x6587;&#x7AE0;&#x70B9;&#x8D5E; &#x2267; 6 &#xFF0C;&#x8BC4;&#x8BBA;&#x4E92;&#x52A8; &#x2267; 3 &#x6761;</td>
<td>&#x74DC;&#x5206;&#x4E07;&#x5143;&#x5956;&#x6C60;</td>
</tr>
<tr>
<td>&#x9605;&#x8BFB; &#x2267; 100 &#x7684;&#x6587;&#x7AE0; &#x2267; 4 &#x7BC7;&#xFF0C;&#x6BCF;&#x7BC7;&#x6587;&#x7AE0;&#x70B9;&#x8D5E; &#x2267; 6 &#xFF0C;&#x8BC4;&#x8BBA;&#x4E92;&#x52A8; &#x2267; 3 &#x6761;</td>
<td>&#x74DC;&#x5206;&#x5956;&#x54C1;&#x52A0;&#x500D;</td>
</tr>
</tbody></table>
<h4 id="&#x2605;&#x2605;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;"><a href="#&#x2605;&#x2605;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;" class="headerlink" title="&#x2605;&#x2605;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;"></a>&#x2605;&#x2605;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;</h4><blockquote>
<p>&#x6BCF;&#x4EFD;&#x5927;&#x793C;&#x5305;&#x4E0D;&#x5C11;&#x4E8E; 3 &#x4EF6;&#x5956;&#x54C1;&#xFF08;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#x6398;&#x91D1;&#x5468;&#x8FB9;&#xFF09;<br>| &#x5927;&#x793C;&#x5305;&#x6761;&#x4EF6; | &#x5956;&#x54C1; |<br>| &#x2014; | &#x2014; |<br>| &#x9605;&#x8BFB; &#x2267; 100 &#x7684;&#x6587;&#x7AE0; &#x2267; 4 &#x7BC7;&#xFF0C;&#x6240;&#x6709;&#x6295;&#x7A3F;&#x6587;&#x7AE0;&#x7D2F;&#x8BA1;&#x9605;&#x8BFB; &#x2267; 2000&#xFF0C;&#x70B9;&#x8D5E; &#x2267; 40&#xFF0C;&#x8BC4;&#x8BBA;&#x2267; 10 | &#x5927;&#x793C;&#x5305;&#x4E00;&#x4EFD;&#x4E0D;&#x9650;&#x540D;&#x989D;|</p>
</blockquote>
<h4 id="&#x2605;&#x2605;&#x2605;-&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;"><a href="#&#x2605;&#x2605;&#x2605;-&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;" class="headerlink" title="&#x2605;&#x2605;&#x2605; &#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;"></a>&#x2605;&#x2605;&#x2605; &#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;</h4><blockquote>
<p>&#x7EFC;&#x5408;&#x8BC4;&#x4F30;&#x4EE5;&#x4E0A;&#x83B7;&#x5956;&#x4F5C;&#x8005;&#xFF0C;&#x9996;&#x6279;&#x7B5B;&#x9009; 50&#x4EBA;&#x5165;&#x9009;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x8BA1;&#x5212;&#xFF0C;&#x5982;&#x6210;&#x529F;&#x52A0;&#x5165;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x8BA1;&#x5212;&#xFF0C;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#xFF08;<strong>&#x53D1;&#x653E;&#x7B49;&#x503C;&#x81EA;&#x9009;&#x5B9E;&#x7269;&#x5956;&#x54C1;</strong>&#xFF09;&#x3002;</p>
<p>&#x7B5B;&#x9009;&#x540D;&#x989D;&#xFF1A;&#x6839;&#x636E;&#x6295;&#x7A3F;&#x6587;&#x7AE0;&#x5206;&#x7C7B;&#xFF0C;&#x7B5B;&#x9009;&#x524D;&#x7AEF;&#x5206;&#x7C7B; 20 &#x4EBA;&#x3001; &#x540E;&#x7AEF;&#x5206;&#x7C7B; 20 &#x4EBA;&#x3001;&#x79FB;&#x52A8;&#x7AEF;&#x5206;&#x7C7B; 10 &#x4EBA;&#x3002;</p>
</blockquote>
<table>
<thead>
<tr>
<th>&#x6FC0;&#x52B1;&#x91D1;&#x6761;&#x4EF6;</th>
<th>&#x6FC0;&#x52B1;&#x91D1;</th>
</tr>
</thead>
<tbody><tr>
<td>&#x6587;&#x7AE0;&#x6570;&#x91CF; &#x2267;4 &#x7BC7;&#xFF0C;&#x5355;&#x7BC7;&#x6587;&#x7AE0;&#x9605;&#x8BFB; &#x2267; 3000&#xFF0C;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x9605;&#x8BFB;&#x91CF;&#x7D2F;&#x8BA1; &#x2267; 10000&#xFF0C;&#x70B9;&#x8D5E; &#x2267; 200&#xFF0C;&#x8BC4;&#x8BBA; &#x2267; 50</td>
<td>800&#x5143;&#x81EA;&#x9009;&#x5B9E;&#x7269;&#x5956;&#x54C1;</td>
</tr>
<tr>
<td>&#x6587;&#x7AE0;&#x6570;&#x91CF; &#x2267;4 &#x7BC7;&#xFF0C;&#x5355;&#x7BC7;&#x6587;&#x7AE0;&#x9605;&#x8BFB; &#x2267; 1500&#xFF0C;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x9605;&#x8BFB;&#x91CF;&#x7D2F;&#x8BA1; &#x2267; 5000&#xFF0C;&#x70B9;&#x8D5E; &#x2267; 100&#xFF0C;&#x8BC4;&#x8BBA; &#x2267; 25</td>
<td>500&#x5143;&#x81EA;&#x9009;&#x5B9E;&#x7269;&#x5956;&#x54C1;</td>
</tr>
<tr>
<td>&#x6587;&#x7AE0;&#x6570;&#x91CF; &#x2267;4 &#x7BC7;&#xFF0C;&#x5355;&#x7BC7;&#x6587;&#x7AE0;&#x9605;&#x8BFB; &#x2267; 500&#xFF0C;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x9605;&#x8BFB;&#x91CF;&#x7D2F;&#x8BA1; &#x2267; 3000&#xFF0C;&#x70B9;&#x8D5E; &#x2267; 60&#xFF0C;&#x8BC4;&#x8BBA; &#x2267; 15</td>
<td>300&#x5143;&#x81EA;&#x9009;&#x5B9E;&#x7269;&#x5956;&#x54C1;</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>&#x89E3;&#x9501;&#x6276;&#x6301;&#x6743;&#x76CA;</th>
<th>&#x6743;&#x76CA;</th>
</tr>
</thead>
<tbody><tr>
<td>&#x89E3;&#x9501;&#x4E13;&#x5C5E;&#x8BC1;&#x4E66;</td>
<td>&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x4E13;&#x5C5E;&#x8BC1;&#x4E66;</td>
</tr>
<tr>
<td>&#x89E3;&#x9501;&#x6D41;&#x91CF;&#x6276;&#x6301;&#x6743;&#x76CA;</td>
<td>&#x7AD9;&#x5185;&#x8D44;&#x6E90;&#x4F4D;&#x66DD;&#x5149;&#x3001;&#x6398;&#x91D1;&#x9171;&#x670B;&#x53CB;&#x5708;&#x3001;&#x5FAE;&#x4FE1;&#x7FA4;&#x63A8;&#x5E7F;&#x7B49;</td>
</tr>
<tr>
<td>&#x89E3;&#x9501;&#x8BC4;&#x8BBA;&#x533A;&#x62BD;&#x5956;&#x6743;&#x76CA;</td>
<td>&#x989D;&#x5916;&#x83B7;&#x5F97;&#x6398;&#x91D1;&#x5468;&#x8FB9;&#x7528;&#x4E8E;&#x540E;&#x7EED;&#x53D1;&#x5E03;&#x65B0;&#x6587;&#x7AE0;&#x65F6;&#x8BC4;&#x8BBA;&#x533A;&#x62BD;&#x5956;</td>
</tr>
<tr>
<td>&#x89E3;&#x9501;&#x5199;&#x4F5C;&#x53D8;&#x73B0;&#x6743;&#x76CA;</td>
<td>&#x8FDB;&#x5165;&#x5C0F;&#x518C;&#x4F5C;&#x8005;&#x5019;&#x9009;&#x6C60;&#xFF0C;&#x6700;&#x7EC8;&#x80FD;&#x5426;&#x6210;&#x529F;&#x5199;&#x4F5C;&#x9700;&#x8981;&#x7ECF;&#x8FC7;&#x8BC4;&#x5BA1;&#x59D4;&#x5458;&#x4F1A;&#x7684;&#x6700;&#x7EC8;&#x8BC4;&#x5BA1;</td>
</tr>
</tbody></table>
<h3 id="&#x5956;&#x54C1;&#x53D1;&#x653E;"><a href="#&#x5956;&#x54C1;&#x53D1;&#x653E;" class="headerlink" title="&#x5956;&#x54C1;&#x53D1;&#x653E;"></a>&#x5956;&#x54C1;&#x53D1;&#x653E;</h3><blockquote>
<ul>
<li>&#x4E09;&#x9879;&#x5956;&#x52B1;&#x53EF;&#x7D2F;&#x8BA1;&#x83B7;&#x5F97;</li>
<li>&#x300C;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x300D;&#x6700;&#x7EC8;&#x4EE5;&#x5B9E;&#x7269;&#x5956;&#x54C1;&#x5F62;&#x5F0F;&#x53D1;&#x653E;&#xFF0C;&#x5B98;&#x65B9;&#x5C06;&#x6839;&#x636E;&#x83B7;&#x5956;&#x6398;&#x53CB;&#x7684;&#x610F;&#x613F;&#xFF0C;&#x4E3A;&#x83B7;&#x5956;&#x6398;&#x53CB;&#x91C7;&#x8D2D;&#x5956;&#x54C1;&#xFF0C;&#x5956;&#x54C1;&#x4EF7;&#x683C;&#x4E0A;&#x9650;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x6FC0;&#x52B1;&#x91D1;&#xFF1B;&#x5982;&#x83B7;&#x5956;&#x6398;&#x53CB;&#x81EA;&#x9009;&#x7684;&#x5B9E;&#x7269;&#x5956;&#x54C1;&#x8D85;&#x8FC7;&#x6FC0;&#x52B1;&#x91D1;&#x4E0A;&#x9650;&#xFF0C;&#x8FD0;&#x8425;&#x540C;&#x5B66;&#x5C06;&#x4E0E;&#x83B7;&#x5956;&#x6398;&#x53CB;&#x6C9F;&#x901A;&#x8C03;&#x6574;&#x4E3A;&#x5176;&#x4ED6;&#x5956;&#x54C1;&#xFF1B;&#x5956;&#x54C1;&#x91C7;&#x8D2D;&#x4EF7;&#x683C;&#x662F;&#x5426;&#x8D85;&#x989D;&#xFF0C;&#x4EE5;&#x6398;&#x91D1;&#x91C7;&#x8D2D;&#x6E20;&#x9053;&#x663E;&#x793A;&#x7684;&#x4EF7;&#x683C;&#x4E3A;&#x51C6;&#x3002;</li>
</ul>
</blockquote>
<h3 id="&#x5956;&#x54C1;&#x5C55;&#x793A;"><a href="#&#x5956;&#x54C1;&#x5C55;&#x793A;" class="headerlink" title="&#x5956;&#x54C1;&#x5C55;&#x793A;"></a>&#x5956;&#x54C1;&#x5C55;&#x793A;</h3><blockquote>
<ul>
<li>&#x4EE5;&#x4E0B;&#x4E3A;&#x90E8;&#x5206;&#x5019;&#x9009;&#x5956;&#x54C1;</li>
<li>&#x6700;&#x7EC8;&#x5956;&#x54C1;&#x4F1A;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x83B7;&#x5956;&#x4EBA;&#x6570;&#x548C;&#x5E93;&#x5B58;&#x8FDB;&#x884C;&#x8C03;&#x6574;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/7fbe737556b38d6f60fb34390fe13ffe5ea81b5abc43691ac7bb859397ac4e3a" alt="&#x7A3F;&#x5B9A;&#x8BBE;&#x8BA1;&#x5BFC;&#x51FA;-20210926-193621.jpg"></li>
</ul>
</blockquote>
<h3 id="&#x6D3B;&#x52A8;&#x987B;&#x77E5;"><a href="#&#x6D3B;&#x52A8;&#x987B;&#x77E5;" class="headerlink" title="&#x6D3B;&#x52A8;&#x987B;&#x77E5;"></a>&#x6D3B;&#x52A8;&#x987B;&#x77E5;</h3><blockquote>
<ul>
<li>&#x4EE5;&#x4E0B;&#x884C;&#x4E3A;&#x88AB;&#x9F13;&#x52B1;</li>
</ul>
<pre><code>+ &#x5199;&#x51FA;&#x4E3B;&#x9898;&#x660E;&#x786E;&#x3001;&#x7ED3;&#x6784;&#x5408;&#x7406;&#x3001;&#x5BF9;&#x8BFB;&#x8005;&#x6709;&#x5E2E;&#x52A9;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x5B98;&#x65B9;&#x63A8;&#x8350;
+ &#x628A;&#x6587;&#x7AE0;&#x7684;&#x6838;&#x5FC3;&#x5356;&#x70B9;&#x5199;&#x6210;&#x7B80;&#x660E;&#x627C;&#x8981;&#x7684;&#x63A8;&#x8350;&#x8BED;&#xFF0C;&#x8F6C;&#x53D1;&#x5230;&#x670B;&#x53CB;&#x5708;&#x3001;&#x6280;&#x672F;&#x4EA4;&#x6D41;&#x7FA4;&#x7B49;&#xFF0C;&#x83B7;&#x5F97;&#x66F4;&#x591A;&#x9605;&#x8BFB;&#x548C;&#x4E92;&#x52A8;
+ &#x5728;&#x6398;&#x91D1;&#x6CB8;&#x70B9;&#x5185;&#x81EA;&#x8350;&#x6587;&#x7AE0;
+ &#x5176;&#x4ED6;&#x4E0D;&#x8FDD;&#x53CD;&#x793E;&#x533A;&#x89C4;&#x8303;&#x7684;&#x884C;&#x4E3A;</code></pre><ul>
<li>&#x4EE5;&#x4E0B;&#x884C;&#x4E3A;&#x88AB;&#x7981;&#x6B62;</li>
</ul>
<pre><code>+ &#x7981;&#x6B62;&#x5237;&#x91CF;&#x6216;&#x7ED9;&#x5176;&#x4ED6;&#x6398;&#x53CB;&#x6076;&#x610F;&#x5237;&#x91CF;&#x3001;&#x7EC4;&#x56E2;&#x5237;&#x8D5E;&#x5237;&#x8BC4;&#x8BBA;&#xFF0C;&#x6216;&#x5176;&#x4ED6;&#x8FDD;&#x53CD;&#x793E;&#x533A;&#x521B;&#x4F5C;&#x89C4;&#x8303;&#x7684;&#x884C;&#x4E3A;
+ &#x5982;&#x679C;&#x88AB;&#x53D1;&#x73B0;&#x6216;&#x88AB;&#x6295;&#x8BC9;&#x5E76;&#x6838;&#x5B9E;&#xFF0C;&#x53D6;&#x6D88;&#x8BC4;&#x5956;&#x8D44;&#x683C;</code></pre><ul>
<li>&#x6587;&#x7AE0;&#x6570;&#x636E;&#x4EE5;&#x5B98;&#x65B9;&#x7EDF;&#x8BA1;&#x4E3A;&#x51C6;</li>
<li>&#x6D41;&#x91CF;&#x6276;&#x6301;&#x6743;&#x76CA;&#xFF0C;&#x4EE5;&#x8FD0;&#x8425;&#x540C;&#x5B66;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x7684;&#x6700;&#x7EC8;&#x6392;&#x671F;&#x4E3A;&#x51C6;</li>
<li>&#x90E8;&#x5206;&#x5956;&#x54C1;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x5E93;&#x5B58;&#x4E0D;&#x8DB3;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6700;&#x7EC8;&#x5956;&#x54C1;&#x4EE5;&#x6D3B;&#x52A8;&#x7ED3;&#x675F;&#x540E;&#x5B98;&#x65B9;&#x6700;&#x7EC8;&#x516C;&#x5E03;&#x7684;&#x5956;&#x54C1;&#x540D;&#x5355;&#x4E3A;&#x51C6;</li>
<li>&#x672C;&#x6B21;&#x6D3B;&#x52A8;&#x89E3;&#x91CA;&#x6743;&#x5F52;&#x6398;&#x91D1;&#x793E;&#x533A;&#x6240;&#x6709;</li>
</ul>
</blockquote>
<h3 id="&#x6D3B;&#x52A8;-Q-amp-A"><a href="#&#x6D3B;&#x52A8;-Q-amp-A" class="headerlink" title="&#x6D3B;&#x52A8; Q&amp;A"></a>&#x6D3B;&#x52A8; Q&amp;A</h3><blockquote>
<ul>
<li>&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x53C2;&#x52A0;&#x7A00;&#x571F;&#x6398;&#x91D1;&#x793E;&#x533A;&#x5185;&#x5176;&#x4ED6;&#x6D3B;&#x52A8;&#x5417;&#xFF1F;</li>
</ul>
<pre><code>+ &#x4E00;&#x4F4D;&#x4F5C;&#x8005;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x53C2;&#x4E0E;&#x591A;&#x4E2A;&#x6D3B;&#x52A8;&#xFF0C;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x53EA;&#x80FD;&#x53C2;&#x4E0E;&#x4E00;&#x4E2A;&#x6D3B;&#x52A8;&#x3002;&#x552F;&#x4E00;&#x7279;&#x6B8A;&#x60C5;&#x51B5;&#xFF1A;10&#x6708;1&#x65E5;-10&#x6708;31&#x65E5;&#xFF0C;&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#x7684;&#x6D3B;&#x52A8;&#x6587;&#x7AE0;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x53C2;&#x4E0E;&#x8BC4;&#x9009;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;-&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x5956;&#x9879;&#x300D;&#xFF08;&#x8BE5;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0D;&#x80FD;&#x8BC4;&#x9009;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;-&#x74DC;&#x5206;&#x5956;/&#x5927;&#x793C;&#x5305;&#x300D;&#xFF09;&#xFF0C;&#x6587;&#x7AE0;&#x8981;&#x6C42;&#x89C1;&#x4E0B;&#x65B9;&#x4E3E;&#x4F8B;&#x3002;
+ &#x552F;&#x4E00;&#x7279;&#x6B8A;&#x60C5;&#x51B5;&#x4E3E;&#x4F8B;&#xFF1A;
    - &#x5C0F;A&#x60F3;&#x8981;&#x53C2;&#x52A0;&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#xFF0C;&#x540C;&#x65F6;&#x5E0C;&#x671B;&#x53C2;&#x4E0E;&#x8BC4;&#x9009;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;-&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x300D;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x9700;&#x8981;&#x5728;&#x53D1;&#x5E03;&#x6587;&#x7AE0;&#x65F6;&#xFF1A;
    1. &#x6B63;&#x6587;&#x7B2C;&#x4E00;&#x53E5;&#xFF1A;&#x5C0F;&#x77E5;&#x8BC6;&#xFF0C;&#x5927;&#x6311;&#x6218;&#xFF01;&#x672C;&#x6587;&#x6B63;&#x5728;&#x53C2;&#x4E0E;&#x300C;[&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;](https://dev.newban.cn/7008476801634680869)&#x300D;&#x521B;&#x4F5C;&#x6D3B;&#x52A8;
    2. &#x6B63;&#x6587;&#x7B2C;&#x4E8C;&#x53E5;&#xFF1A;&#x672C;&#x6587;&#x5DF2;&#x53C2;&#x4E0E; [&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;](https://dev.newban.cn/7012210233804079141) &#xFF0C;&#x8D62;&#x53D6;&#x521B;&#x4F5C;&#x5927;&#x793C;&#x5305;&#xFF0C;&#x6311;&#x6218;&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x3002;
    3. &#x6587;&#x7AE0;&#x5206;&#x7C7B;&#x53EA;&#x80FD;&#x9009;&#x62E9;&#xFF1A;&#x524D;&#x7AEF;&#x3001;&#x540E;&#x7AEF;&#x3001;iOS&#x3001;Android
    4. &#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x8981;&#x6C42;&#xFF1A;&#x539F;&#x521B;&#x6280;&#x672F;&#x6587;&#x7AE0;&#x3002;&#x4E14;&#x975E;&#x6807;&#x9898;&#x515A;&#x3001;&#x975E;&#x9762;&#x8BD5;&#x9898;&#x6574;&#x5408;&#x7C7B;&#x6587;&#x7AE0;&#x3002;
    5. &#x5E76;&#x4E14;&#x9700;&#x8981;&#x53D1;&#x5E03; 4 &#x7BC7;&#xFF0C;&#x4E14;&#x6BCF;&#x7BC7;&#x5B57;&#x6570; &#x2267; 800&#xFF0C;&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212; - &#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x300D;&#x7684;&#x8BC4;&#x9009;&#x54E6;&#x3002;</code></pre><ul>
<li>&#x6240;&#x6709;&#x53C2;&#x4E0E;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;&#x6D3B;&#x52A8;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x8BC4;&#x8BBA;&#x533A;&#x7528;&#x6237;&#x90FD;&#x53EF;&#x4EE5;&#x53C2;&#x4E0E;&#x8BC4;&#x8BBA;&#x62BD;&#x5956;&#x5417;&#xFF1F;</li>
</ul>
<pre><code>+ &#x3010;&#x53EA;&#x3011;&#x53C2;&#x4E0E;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;&#x6D3B;&#x52A8;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x6587;&#x7AE0;&#x8BC4;&#x8BBA;&#x533A;&#x7684;&#x7528;&#x6237;&#x624D;&#x80FD;&#x53C2;&#x4E0E;&#x8BC4;&#x8BBA;&#x62BD;&#x5956;&#x3002;&#x5982;&#x679C;&#x6295;&#x7A3F;&#x6587;&#x7AE0;&#x5C5E;&#x4E8E;&#x4E0A;&#x8FF0;&#x7279;&#x6B8A;&#x60C5;&#x51B5;&#xFF0C;&#x8BC4;&#x8BBA;&#x533A;&#x7528;&#x6237;&#x4E0D;&#x80FD;&#x53C2;&#x4E0E;&#x8BC4;&#x8BBA;&#x62BD;&#x5956;&#x3002;</code></pre><ul>
<li>&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x516C;&#x5E03;&#x83B7;&#x5956;&#x540D;&#x5355;&#xFF1F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x53D1;&#x5956;&#xFF1F;</li>
</ul>
<pre><code>+ &#x6587;&#x672B;&#x626B;&#x7801;&#x52A0;&#x5165;&#x6D3B;&#x52A8;&#x7FA4;&#xFF0C;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x83B7;&#x53D6;&#x5B98;&#x65B9;&#x6D88;&#x606F;&#x3002;</code></pre><ul>
<li>&#x9047;&#x5230;&#x7279;&#x6B8A;&#x95EE;&#x9898;&#xFF0C;&#x5982;&#x4F55;&#x4E0E;&#x8FD0;&#x8425;&#x540C;&#x5B66;&#x6C9F;&#x901A;&#xFF1F;</li>
</ul>
<pre><code>+ &#x6587;&#x672B;&#x626B;&#x7801;&#x52A0;&#x5165;&#x6D3B;&#x52A8;&#x7FA4;&#xFF0C;&#x53EF;&#x8054;&#x7CFB;&#x8FD0;&#x8425;&#x540C;&#x5B66;&#x3002;</code></pre></blockquote>
<h3 id="&#x6D3B;&#x52A8;&#x4EA4;&#x6D41;&#x7FA4;"><a href="#&#x6D3B;&#x52A8;&#x4EA4;&#x6D41;&#x7FA4;" class="headerlink" title="&#x6D3B;&#x52A8;&#x4EA4;&#x6D41;&#x7FA4;"></a>&#x6D3B;&#x52A8;&#x4EA4;&#x6D41;&#x7FA4;</h3><blockquote>
<p>&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x5DF2;&#x8FDB;&#x5165;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;&#x300D;&#x6D3B;&#x52A8;&#x7FA4;01/02/03&#xFF0C;&#x65E0;&#x9700;&#x626B;&#x7801;&#x91CD;&#x590D;&#x8FDB;&#x7FA4;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/677f1c3911500e06ed368922213bc66502fce8d33c16a217f5359d32fb48ebb1" alt="&#x81EA;&#x5B9A;&#x4E49;&#x6A21;&#x677F;.jpg"></p>
</blockquote>
<h3 id="&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#x6D3B;&#x52A8;&#x540C;&#x671F;&#x8FDB;&#x884C;&#x4E2D;-&#x2196;-&#x3C9;-&#x2197;"><a href="#&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#x6D3B;&#x52A8;&#x540C;&#x671F;&#x8FDB;&#x884C;&#x4E2D;-&#x2196;-&#x3C9;-&#x2197;" class="headerlink" title="&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#x6D3B;&#x52A8;&#x540C;&#x671F;&#x8FDB;&#x884C;&#x4E2D; &#x2196;(^&#x3C9;^)&#x2197;"></a>&#x300C;&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x300D;&#x6D3B;&#x52A8;&#x540C;&#x671F;&#x8FDB;&#x884C;&#x4E2D; &#x2196;(^&#x3C9;^)&#x2197;</h3><blockquote>
<p>&#x300C;<a href="https://dev.newban.cn/7008476801634680869">&#x7A0B;&#x5E8F;&#x5458;&#x5FC5;&#x5907;&#x5C0F;&#x77E5;&#x8BC6;&#x4E3B;&#x9898;&#x5F81;&#x6587;&#x6D3B;&#x52A8;</a>&#x300D;&#x540C;&#x671F;&#x8FDB;&#x884C;&#x4E2D;&#xFF0C;&#x5F81;&#x6587;&#x6295;&#x7A3F;&#x65F6;&#x95F4; 9 &#x6708; 24 &#x65E5; - 10 &#x6708; 31 &#x65E5;&#xFF01;&#x6D3B;&#x52A8;&#x5956;&#x54C1;&#x4E30;&#x5BCC;&#xFF0C;&#x4E14;&#x53C2;&#x8D5B;&#x6587;&#x7AE0;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x53C2;&#x4E0E;&#x300C;&#x6398;&#x529B;&#x661F;&#x8BA1;&#x5212;-&#x521B;&#x4F5C;&#x6FC0;&#x52B1;&#x91D1;&#x5956;&#x9879;&#x300D;&#x8BC4;&#x9009;&#xFF08;&#x4E0D;&#x80FD;&#x53C2;&#x4E0E;&#x74DC;&#x5206;&#x5956;&#x548C;&#x5927;&#x793C;&#x5305;&#x5956;&#x8BC4;&#x9009;&#xFF09;&#xFF0C;&#x8BE6;&#x89C1;&#x6D3B;&#x52A8;&#x6587;&#x7AE0;&#x4E2D;&#x300C;Buff &#x52A0;&#x6301;&#x5956;&#x300D;&#x7684;&#x76F8;&#x5173;&#x4ECB;&#x7ECD;&#x3002;</p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/159e40b99f0fbf695d85fa42c2817254.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7012047954995314701.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7012047954995314701.html" itemprop="url">validate-npm-package-name 源码阅读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-26T09:27:57+08:00">
                2021-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>&#x524D;&#x8A00;</li>
</ol>
<hr>
<blockquote>
<p>&#x9996;&#x5148;&#xFF0C; &#x5F88;&#x611F;&#x8C22;<a href="/external_links/9057a3e4102a5ae04b611dde9b990ce8.html" target="blank" rel="noopener">&#x300C; &#x82E5;&#x5DDD; &#x300D;</a> &#x5927;&#x4F6C; &#x63D0;&#x4F9B;&#x7684; &#x4E00;&#x4E2A;<a href="/external_links/fd812ae4a0d5cb85c84e2d495cff812d.html" target="blank" rel="noopener">&#x300C; &#x6E90;&#x7801;&#x5171;&#x8BFB; &#x300D;</a> &#x5E73;&#x53F0;&#xFF0C; &#x5176;&#x5B9E;&#x6211;&#x5F88;&#x65E9;&#x5C31;&#x8FDB;&#x5165;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x505A;&#x4E3A;&#x4E00;&#x4E2A;&#x5976;&#x7238;&#xFF0C; &#x4E0B;&#x73ED;&#x540E;&#x9A6C;&#x4E0D;&#x505C;&#x8E44;&#x5730;&#x56DE;&#x5BB6;&#x5E26;&#x5A03;&#xFF0C; &#x6240;&#x4EE5;&#x5F88;&#x5C11;&#x6709;&#x65F6;&#x95F4;&#x53C2;&#x4E0E; &#x6E90;&#x7801;&#x5171;&#x8BFB; &#x7684;&#x6D3B;&#x52A8;&#x6765;&#x3002;</p>
</blockquote>
<blockquote>
<p>&#x4ECA;&#x5929;&#x6B63;&#x597D;&#x62BD;&#x51FA;&#x65F6;&#x95F4;&#xFF0C;&#x53C2;&#x4E0E;&#x4E00;&#x4E0B;&#x5927;&#x4F6C;&#x7684;&#x65B0;&#x4E00;&#x671F;&#x7684;&#x6D3B;&#x52A8;&#xFF0C; &#x8FD9;&#x4E00;&#x671F;&#x9879;&#x76EE;&#x662F; <a href="/external_links/9ae035a403f96dfae8e39f560a9b155b.html" target="blank" rel="noopener">validate-npm-package-name</a>, &#x5B83;&#x662F;&#x68C0;&#x9A8C;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x662F;&#x5426;&#x662F;&#x4E00;&#x4E2A; &#x6709;&#x6548;&#x7684; &#x5305;&#x547D;&#x540D;</p>
</blockquote>
<ol start="2">
<li>&#x5B66;&#x4E60;&#x76EE;&#x6807;</li>
</ol>
<hr>
<ul>
<li>&#x4E86;&#x89E3; validate-npm-package-name &#x7684;&#x4F5C;&#x7528;&#x548C;&#x4F7F;&#x7528;&#x573A;&#x666F;</li>
</ul>
<ol start="3">
<li>&#x5DE5;&#x5177;&#x4ECB;&#x7ECD;</li>
</ol>
<hr>
<blockquote>
<p>Give me a string and I&#x2019;ll tell you if it&#x2019;s a valid <code>npm</code> package name.<br>This package exports a single synchronous function that takes a <code>string</code> as input and returns an object with two properties:<br><code>validForNewPackages</code> :: <code>Boolean</code><br> <code>validForOldPackages</code> :: <code>Boolean</code></p>
</blockquote>
<blockquote>
<p>&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x53C2;&#x6570;&#xFF0C; &#x68C0;&#x9A8C;&#x8BE5;&#x5B57;&#x7B26;&#x4E32;&#x662F;&#x5426;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x6548;&#x7684;&#x5305;&#x547D;&#x540D;&#xFF0C;<br> &#x8BE5;&#x5DE5;&#x5177; &#x63D0;&#x4F9B;&#x4E00;&#x4E2A; &#x63A5;&#x53D7;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x51FD;&#x6570;&#xFF0C; &#x5E76;&#x4E14;&#x8FD4;&#x56DE; &#x4E00;&#x4E2A;&#x62E5;&#x6709;2&#x4E2A;&#x5C5E;&#x6027;&#x7684;&#x5BF9;&#x8C61;<br><code>validForNewPackages</code> :: <code>Boolean</code><br> <code>validForOldPackages</code> :: <code>Boolean</code></p>
</blockquote>
<ol start="4">
<li>&#x5305;&#x547D;&#x540D;&#x89C4;&#x5219;</li>
</ol>
<hr>
<ol>
<li>&#x5305;&#x540D;&#x4E0D;&#x80FD;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;</li>
<li>&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5FC5;&#x987B;&#x5C0F;&#x5199;&#xFF1B;</li>
<li>&#x53EF;&#x4EE5;&#x5305;&#x542B; &#x8FDE;&#x5B57;&#x7B26; - &#xFF1B;</li>
<li>&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x975E; url &#x5B89;&#x5168;&#x5B57;&#x7B26;&#xFF1B;</li>
<li>&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4EE5; . &#x6216;&#x8005; _ &#x5F00;&#x5934;;</li>
<li>&#x5305;&#x540D;&#x9996;&#x5C3E;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x7A7A;&#x683C;&#xFF1B;</li>
<li>&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B; <strong>~)(&#x2018;!*</strong> &#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;;</li>
<li>&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4E0E;node.js/io.js &#x7684;&#x6838;&#x5FC3;&#x6A21;&#x5757; &#x6216;&#x8005; &#x4FDD;&#x7559;&#x540D; &#x4EE5;&#x53CA; &#x9ED1;&#x540D;&#x5355;&#x76F8;&#x540C;&#xFF1B;</li>
<li>&#x5305;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7; 214&#xFF1B;</li>
</ol>
<ol start="5">
<li>&#x793A;&#x4F8B;</li>
</ol>
<hr>
<h3 id="5-1-&#x6709;&#x6548;&#x7684;&#x5305;&#x540D;"><a href="#5-1-&#x6709;&#x6548;&#x7684;&#x5305;&#x540D;" class="headerlink" title="5.1 &#x6709;&#x6548;&#x7684;&#x5305;&#x540D;"></a>5.1 &#x6709;&#x6548;&#x7684;&#x5305;&#x540D;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var validate = require(&quot;validate-npm-package-name&quot;)</span><br><span class="line">validate(&quot;some-package&quot;)</span><br><span class="line">validate(&quot;example.com&quot;)</span><br><span class="line">validate(&quot;under_score&quot;)</span><br><span class="line">validate(&quot;123numeric&quot;)</span><br><span class="line">validate(&quot;@npm/thingy&quot;)</span><br><span class="line">validate(&quot;@jane/foo.js&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-&#x65E0;&#x6548;&#x7684;&#x5305;&#x540D;"><a href="#5-2-&#x65E0;&#x6548;&#x7684;&#x5305;&#x540D;" class="headerlink" title="5.2 &#x65E0;&#x6548;&#x7684;&#x5305;&#x540D;"></a>5.2 &#x65E0;&#x6548;&#x7684;&#x5305;&#x540D;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x5305;&#x542B; &#x4E0D;&#x7B26;&#x5408; &#x7B2C;6&#x6761; &#x89C4;&#x5219;</span><br><span class="line">validate(&quot;excited!&quot;) </span><br><span class="line">validate(&quot; leading-space:and:weirdchars&quot;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>&#x6E90;&#x7801;&#x9605;&#x8BFB;</li>
</ol>
<hr>
<h3 id="6-1-&#x4EE3;&#x7801;&#x7ED3;&#x6784;"><a href="#6-1-&#x4EE3;&#x7801;&#x7ED3;&#x6784;" class="headerlink" title="6.1 &#x4EE3;&#x7801;&#x7ED3;&#x6784;"></a>6.1 &#x4EE3;&#x7801;&#x7ED3;&#x6784;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var scopedPackagePattern = new RegExp(&apos;^(?:@([^/]+?)[/])?([^/]+?)$&apos;) </span><br><span class="line">var builtins = require(&apos;builtins&apos;)</span><br><span class="line">var blacklist = [&apos;node_modules&apos;,&apos;favicon.ico&apos;]</span><br><span class="line">var validate = module.exports = function(name) {</span><br><span class="line">    // .... &#x68C0;&#x9A8C; &#x53C2;&#x6570; name &#x662F;&#x5426; &#x89C4;&#x8303;</span><br><span class="line">}</span><br><span class="line">validate.scopedPackagePattern = scopedPackagePattern</span><br><span class="line">var done = function (warning, erros) {</span><br><span class="line">    // ....  &#x8FD4;&#x56DE; &#x5904;&#x7406;&#x7ED3;&#x679C;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h4 id="6-1-1-scopedPackagePattern-&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;"><a href="#6-1-1-scopedPackagePattern-&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;" class="headerlink" title="6.1.1 scopedPackagePattern &#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;"></a>6.1.1 scopedPackagePattern &#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;</h4><p><code>var scopedPackagePattern = new RegExp(&apos;^(?:@([^/]+?)[/])?([^/]+?)$&apos;</code></p>
<p><strong>&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x53EF;&#x89C6;&#x5316;</strong>&#xFF0C; &#x94FE;&#x63A5;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/1cd744d3ac669e8e4d010cf609998210.html" target="blank" rel="noopener">jex.im/regulex/</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2ba94dbc92044542f4ed07038f578a680e8a24acf722280f0415ab65da240223" alt="&#x4E0B;&#x8F7D;.png"><br><strong>&#x5339;&#x914D;&#x4EE5;&#x4E0B;&#x5B57;&#x7B26;&#x4E32;</strong></p>
<ul>
<li>@user &#x4EE5;@&#x5F00;&#x5934;</li>
<li>@user/test</li>
<li>&#x975E;&#x2018;/&#x2019;&#x7684;&#x5B57;&#x7B26;&#x4E32;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c9e998a6d8e95707fe1b50cc6dbac34129383d76b50d899e1bbeb53158e67e88" alt="image.png"></p>
<blockquote>
<p><a href="/external_links/cd7e16f034233beaa9fcf3753f6bdf3c.html" target="blank" rel="noopener">builtins</a>&#xFF1A;&#x5217;&#x51FA;&#x4E86; node &#x6240;&#x6709;&#x7684;&#x5185;&#x7F6E;&#x6A21;&#x5757;</p>
</blockquote>
<h4 id="6-1-2-validate&#x51FD;&#x6570;-&#x7ED3;&#x5408;-&#x5305;&#x547D;&#x540D;&#x89C4;&#x5219;"><a href="#6-1-2-validate&#x51FD;&#x6570;-&#x7ED3;&#x5408;-&#x5305;&#x547D;&#x540D;&#x89C4;&#x5219;" class="headerlink" title="6.1.2 validate&#x51FD;&#x6570;, &#x7ED3;&#x5408; [&#x5305;&#x547D;&#x540D;&#x89C4;&#x5219;]"></a>6.1.2 validate&#x51FD;&#x6570;, &#x7ED3;&#x5408; [&#x5305;&#x547D;&#x540D;&#x89C4;&#x5219;]</h4><h5 id="&#xFF08;1&#xFF09;&#x68C0;&#x6D4B;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x5426;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;"><a href="#&#xFF08;1&#xFF09;&#x68C0;&#x6D4B;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x5426;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;" class="headerlink" title="&#xFF08;1&#xFF09;&#x68C0;&#x6D4B;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x5426;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;"></a>&#xFF08;1&#xFF09;&#x68C0;&#x6D4B;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x5426;&#x662F;&#x5B57;&#x7B26;&#x4E32;&#xFF1B;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;if (name === null) {</span><br><span class="line">    errors.push(&apos;name cannot be null&apos;)</span><br><span class="line">    return done(warnings, errors)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">if (name === undefined) {</span><br><span class="line">    errors.push(&apos;name cannot be undefined&apos;)</span><br><span class="line">    return done(warnings, errors)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">if (typeof name !== &apos;string&apos;) {</span><br><span class="line">    errors.push(&apos;name must be a string&apos;)</span><br><span class="line">    return done(warnings, errors)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;2&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x80FD;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;"><a href="#&#xFF08;2&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x80FD;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;" class="headerlink" title="&#xFF08;2&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x80FD;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;"></a>&#xFF08;2&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x80FD;&#x662F;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;if (!name.length) {</span><br><span class="line">    errors.push(&apos;name length must be greater than zero&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;3&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4EE5;-&#x6216;&#x8005;-&#x5F00;&#x5934;"><a href="#&#xFF08;3&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4EE5;-&#x6216;&#x8005;-&#x5F00;&#x5934;" class="headerlink" title="&#xFF08;3&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4EE5; . &#x6216;&#x8005; _ &#x5F00;&#x5934;"></a>&#xFF08;3&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4EE5; . &#x6216;&#x8005; _ &#x5F00;&#x5934;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;if (name.match(/^\./)) {</span><br><span class="line">    errors.push(&apos;name cannot start with a period&apos;)</span><br><span class="line">}</span><br><span class="line">if (name.match(/^_/)) {</span><br><span class="line">    errors.push(&apos;name cannot start with an underscore&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="4-&#x5305;&#x540D;&#x9996;&#x5C3E;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x7A7A;&#x683C;"><a href="#4-&#x5305;&#x540D;&#x9996;&#x5C3E;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x7A7A;&#x683C;" class="headerlink" title="(4) &#x5305;&#x540D;&#x9996;&#x5C3E;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x7A7A;&#x683C;"></a>(4) &#x5305;&#x540D;&#x9996;&#x5C3E;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x7A7A;&#x683C;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// trim &#x65B9;&#x6CD5; &#x53EF;&#x4EE5;&#x53BB;&#x6389; &#x5B57;&#x7B26;&#x4E32; &#x4E24;&#x8FB9;&#x7684; &#x7A7A;&#x767D;</span><br><span class="line">if (name.trim() !== name) {</span><br><span class="line">    errors.push(&apos;name cannot contain leading or trailing spaces&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;5&#xFF09;-&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4E0E;node-js-io-js-&#x7684;&#x6838;&#x5FC3;&#x6A21;&#x5757;-&#x6216;&#x8005;-&#x4FDD;&#x7559;&#x540D;-&#x4EE5;&#x53CA;-&#x9ED1;&#x540D;&#x5355;&#x76F8;&#x540C;"><a href="#&#xFF08;5&#xFF09;-&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4E0E;node-js-io-js-&#x7684;&#x6838;&#x5FC3;&#x6A21;&#x5757;-&#x6216;&#x8005;-&#x4FDD;&#x7559;&#x540D;-&#x4EE5;&#x53CA;-&#x9ED1;&#x540D;&#x5355;&#x76F8;&#x540C;" class="headerlink" title="&#xFF08;5&#xFF09; &#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4E0E;node.js/io.js &#x7684;&#x6838;&#x5FC3;&#x6A21;&#x5757; &#x6216;&#x8005; &#x4FDD;&#x7559;&#x540D; &#x4EE5;&#x53CA; &#x9ED1;&#x540D;&#x5355;&#x76F8;&#x540C;"></a>&#xFF08;5&#xFF09; &#x5305;&#x540D;&#x4E0D;&#x5F97;&#x4E0E;node.js/io.js &#x7684;&#x6838;&#x5FC3;&#x6A21;&#x5757; &#x6216;&#x8005; &#x4FDD;&#x7559;&#x540D; &#x4EE5;&#x53CA; &#x9ED1;&#x540D;&#x5355;&#x76F8;&#x540C;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// No funny business</span><br><span class="line">blacklist.forEach(function (blacklistedName) {</span><br><span class="line">    if (name.toLowerCase() === blacklistedName) {</span><br><span class="line">          errors.push(blacklistedName + &apos; is a blacklisted name&apos;)</span><br><span class="line">    }</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">// core module names like http, events, util, etc</span><br><span class="line">builtins.forEach(function (builtin) {</span><br><span class="line">    if (name.toLowerCase() === builtin) {</span><br><span class="line">      warnings.push(builtin + &apos; is a core module name&apos;)</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;6&#xFF09;&#x5305;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;-214"><a href="#&#xFF08;6&#xFF09;&#x5305;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;-214" class="headerlink" title="&#xFF08;6&#xFF09;&#x5305;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7; 214"></a>&#xFF08;6&#xFF09;&#x5305;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7; 214</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// really-long-package-names-------------------------------such--length-----many---wow</span><br><span class="line">// the thisisareallyreallylongpackagenameitshouldpublishdowenowhavealimittothelengthofpackagenames-poch.</span><br><span class="line">if (name.length &gt; 214) {</span><br><span class="line">    warnings.push(&apos;name can no longer contain more than 214 characters&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;7&#xFF09;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5FC5;&#x987B;&#x5C0F;&#x5199;"><a href="#&#xFF08;7&#xFF09;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5FC5;&#x987B;&#x5C0F;&#x5199;" class="headerlink" title="&#xFF08;7&#xFF09;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5FC5;&#x987B;&#x5C0F;&#x5199;"></a>&#xFF08;7&#xFF09;&#x6240;&#x6709;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5FC5;&#x987B;&#x5C0F;&#x5199;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// mIxeD CaSe nAMEs</span><br><span class="line">if (name.toLowerCase() !== name) {</span><br><span class="line">    warnings.push(&apos;name can no longer contain capital letters&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;8&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;-&#x2018;-&#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;"><a href="#&#xFF08;8&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;-&#x2018;-&#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;" class="headerlink" title="&#xFF08;8&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B; ~)(&#x2018;!* &#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;"></a>&#xFF08;8&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B; <strong>~)(&#x2018;!*</strong> &#x4EFB;&#x610F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;if (/[~&apos;!()*]/.test(name.split(&apos;/&apos;).slice(-1)[0])) {</span><br><span class="line">    warnings.push(&apos;name can no longer contain special characters (&quot;~\&apos;!()*&quot;)&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h5 id="&#xFF08;9&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x975E;-url-&#x5B89;&#x5168;&#x5B57;&#x7B26;"><a href="#&#xFF08;9&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x975E;-url-&#x5B89;&#x5168;&#x5B57;&#x7B26;" class="headerlink" title="&#xFF08;9&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x975E; url &#x5B89;&#x5168;&#x5B57;&#x7B26;"></a>&#xFF08;9&#xFF09;&#x5305;&#x540D;&#x4E0D;&#x5F97;&#x5305;&#x542B;&#x4EFB;&#x4F55;&#x975E; url &#x5B89;&#x5168;&#x5B57;&#x7B26;</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const regx = new RegExp(&apos;^(?:@([^/]+?)[/])?([^/]+?)$&apos;) </span><br><span class="line">const name = &apos;@user/package&apos;</span><br><span class="line">//  ?: &#x4F1A;&#x5FFD;&#x7565;&#x5206;&#x7EC4; </span><br><span class="line">// [&apos;@user/package&apos;, &apos;user&apos;, &apos;package&apos;, index: 0, input: &apos;@user/package&apos;, groups: undefined]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;if (encodeURIComponent(name) !== name) {</span><br><span class="line">    // Maybe it&apos;s a scoped package name, like @user/package</span><br><span class="line">    var nameMatch = name.match(scopedPackagePattern)</span><br><span class="line">    if (nameMatch) {</span><br><span class="line">      var user = nameMatch[1]</span><br><span class="line">      var pkg = nameMatch[2]</span><br><span class="line">      if (encodeURIComponent(user) === user &amp;&amp; encodeURIComponent(pkg) === pkg) {</span><br><span class="line">        return done(warnings, errors)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    errors.push(&apos;name can only contain URL-friendly characters&apos;)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="6-2-done-&#x51FD;&#x6570;"><a href="#6-2-done-&#x51FD;&#x6570;" class="headerlink" title="6.2 done &#x51FD;&#x6570;"></a>6.2 done &#x51FD;&#x6570;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var done = function (warnings, errors) {</span><br><span class="line">  var result = {</span><br><span class="line">    validForNewPackages: errors.length === 0 &amp;&amp; warnings.length === 0,</span><br><span class="line">    validForOldPackages: errors.length === 0,</span><br><span class="line">    warnings: warnings,</span><br><span class="line">    errors: errors</span><br><span class="line">  }</span><br><span class="line">  if (!result.warnings.length) delete result.warnings</span><br><span class="line">  if (!result.errors.length) delete result.errors</span><br><span class="line">  return result</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>&#x603B;&#x7ED3;</li>
</ol>
<hr>
<p>&#x6574;&#x4E2A;&#x9879;&#x76EE;&#x5E76;&#x4E0D;&#x662F;&#x592A;&#x96BE;&#xFF0C; &#x90FD;&#x662F;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5224;&#x65AD;&#xFF0C;&#x4EE5;&#x53CA;&#x6B63;&#x5219;&#x5339;&#x914D;&#xFF0C;&#x4F46;&#x662F;&#x503C;&#x5F97;&#x6BCF;&#x4E2A;&#x4EBA;&#x53BB;&#x5B66;&#x4E60;&#xFF0C; &#x5728;&#x7F16;&#x5199;&#x4E00;&#x4E2A;&#x5DE5;&#x5177;&#x7684;&#x65F6;&#x5019;&#xFF0C; &#x4FDD;&#x8BC1;&#x4EE3;&#x7801;&#x7684;&#x903B;&#x8F91;&#x6E05;&#x6670;&#xFF0C; &#x4EE3;&#x7801;&#x7684;&#x4E66;&#x5199;&#x89C4;&#x8303;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/8b9db3b81a1373689431b04f2c0f2564.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../130/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../130/">130</a><span class="page-number current">131</span><a class="page-number" href="../132/">132</a><span class="space">&hellip;</span><a class="page-number" href="../178/">178</a><a class="extend next" rel="next" href="../132/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">1775</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">725</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
