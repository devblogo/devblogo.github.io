<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="../../css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="../../images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="../../atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:url" content="https://dev.newban.cn/page/99/index.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发者博客 – IT技术 尽在开发者博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/page/99/">





  <title>开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7237001554083266617.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7237001554083266617.html" itemprop="url">JYM 设计模式系列-工厂模式，让你的代码更优雅！！！ 概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-25T16:13:31+08:00">
                2023-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x89C9;&#x5F97;&#x4E0D;&#x9519;&#x8BF7;&#x6309;&#x4E0B;&#x56FE;&#x64CD;&#x4F5C;&#xFF0C;&#x6398;&#x53CB;&#x4EEC;&#xFF0C;&#x54C8;&#x54C8;&#x54C8;&#xFF01;&#xFF01;&#xFF01;<br><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/65778c41bc60c72d236c320e8d0f067c99f567e785167c96bbb39732a5310da4" alt="image.png"></p>
<h1 id="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"><a href="#&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;" class="headerlink" title="&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;"></a>&#x6982;&#x8FF0;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x7C7B;</h1><p>&#x603B;&#x4F53;&#x6765;&#x8BF4;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x7C7B;&#xFF1A;</p>
<ul>
<li><strong>&#x521B;&#x5EFA;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E94;&#x79CD;&#xFF1A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x7ED3;&#x6784;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x4E03;&#x79CD;&#xFF1A;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x88C5;&#x9970;&#x5668;&#x6A21;&#x5F0F;&#x3001;&#x4EE3;&#x7406;&#x6A21;&#x5F0F;&#x3001;&#x5916;&#x89C2;&#x6A21;&#x5F0F;&#x3001;&#x6865;&#x63A5;&#x6A21;&#x5F0F;&#x3001;&#x7EC4;&#x5408;&#x6A21;&#x5F0F;&#x3001;&#x4EAB;&#x5143;&#x6A21;&#x5F0F;&#x3002;</strong></li>
<li><strong>&#x884C;&#x4E3A;&#x578B;&#x6A21;&#x5F0F;&#xFF0C;&#x5171;&#x5341;&#x4E00;&#x79CD;&#xFF1A;&#x7B56;&#x7565;&#x6A21;&#x5F0F;&#x3001;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x8FED;&#x4EE3;&#x5B50;&#x6A21;&#x5F0F;&#x3001;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#x3001;&#x547D;&#x4EE4;&#x6A21;&#x5F0F;&#x3001;&#x5907;&#x5FD8;&#x5F55;&#x6A21;&#x5F0F;&#x3001;&#x72B6;&#x6001;&#x6A21;&#x5F0F;&#x3001;&#x8BBF;&#x95EE;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x4E2D;&#x4ECB;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x89E3;&#x91CA;&#x5668;&#x6A21;&#x5F0F;&#x3002;</strong></li>
</ul>
<h1 id="&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;"><a href="#&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;" class="headerlink" title="&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;"></a>&#x4E00;&#xFF1A;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF08;5&#x79CD;&#xFF09;</h1><p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#x3001;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x3001;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3001;&#x5EFA;&#x9020;&#x8005;&#x6A21;&#x5F0F;&#x3001;&#x539F;&#x578B;&#x6A21;&#x5F0F;&#x3002;</p>
<h2 id="1-&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"><a href="#1-&#x5DE5;&#x5382;&#x6A21;&#x5F0F;" class="headerlink" title="1. &#x5DE5;&#x5382;&#x6A21;&#x5F0F;"></a><strong>1. &#x5DE5;&#x5382;&#x6A21;&#x5F0F;</strong></h2><h3 id="1-1-&#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"><a href="#1-1-&#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;" class="headerlink" title="1.1 &#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;"></a><strong>1.1 &#x7B80;&#x5355;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;</strong></h3><p>Factory&#x662F;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x5E76;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x4FBF;&#x9690;&#x85CF;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#x5E76;&#x4F7F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x4E13;&#x6CE8;&#x4E8E;&#x4F7F;&#x7528;&#x800C;&#x4E0D;&#x662F;&#x5BF9;&#x8C61;&#x521D;&#x59CB;&#x5316;&#x548C;&#x7BA1;&#x7406;&#x3002;</p>
<p>&#x4E8C;&#x8BDD;&#x4E0D;&#x8BF4;&#x4E0A;&#x4E00;&#x4E2A;demo&#xFF1A;&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x901A;&#x8FC7;&#x5236;&#x9020;&#x786C;&#x5E01;&#x4E1A;&#x52A1;&#x8BB2;&#x89E3;&#x3002;CoinFactory&#x662F;&#x5DE5;&#x5382;&#x7C7B;&#xFF0C;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x786C;&#x5E01;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/7e7ed54b1c8a7bdb3cc8317a264830ff9450e362c0e6d8dc8f62e6f257ec28af" alt="image.png"></p>
<p>Coin &#x63A5;&#x53E3;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Coin {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Coin&#x5DE5;&#x5382;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class CoinFactory {</span><br><span class="line"></span><br><span class="line">      /**</span><br><span class="line">       *  &#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5C06;&#x786C;&#x5E01;&#x7C7B;&#x578B;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x7C7B;</span><br><span class="line">       */</span><br><span class="line">      public static Coin getCoin(CoinType type) {</span><br><span class="line">        return type.getConstructor().get();</span><br><span class="line">      }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x786C;&#x5E01;&#x7684;&#x679A;&#x4E3E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public enum CoinType {</span><br><span class="line"></span><br><span class="line">  COPPER(CopperCoin::new),</span><br><span class="line">  GOLD(GoldCoin::new);</span><br><span class="line"></span><br><span class="line">  private final Supplier&lt;Coin&gt; constructor;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x94DC;&#x786C;&#x5E01;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class CopperCoin implements Coin {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is a copper coin.&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x91D1;&#x786C;&#x5E01;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class GoldCoin implements Coin {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is a gold coin.&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;Factory&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;<br>&#x521B;&#x5EFA;&#x5E76;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x4FBF;&#x9690;&#x85CF;&#x5B9E;&#x73B0;&#x903B;&#x8F91;<br>&#x5E76;&#x4F7F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x4E13;&#x6CE8;&#x4E8E;&#x4F7F;&#x7528;&#x800C;&#x4E0D;&#x662F;&#x5BF9;&#x8C61;&#x521D;&#x59CB;&#x5316;&#x548C;&#x7BA1;&#x7406;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program main entry point.</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    LOGGER.info(&quot;The alchemist begins his work.&quot;);</span><br><span class="line">    var coin1 = CoinFactory.getCoin(CoinType.COPPER);</span><br><span class="line">    var coin2 = CoinFactory.getCoin(CoinType.GOLD);</span><br><span class="line">    LOGGER.info(coin1.getDescription());</span><br><span class="line">    LOGGER.info(coin2.getDescription());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x70BC;&#x91D1;&#x672F;&#x58EB;&#x5236;&#x9020;&#x786C;&#x5E01;&#x3002;CoinFactory&#x662F;&#x5DE5;&#x5382;&#x7C7B;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x786C;&#x5E01;&#x3002;</strong></p>
<h3 id="1-2-&#x5DE5;&#x5382;&#x65B9;&#x6CD5;"><a href="#1-2-&#x5DE5;&#x5382;&#x65B9;&#x6CD5;" class="headerlink" title="1.2 &#x5DE5;&#x5382;&#x65B9;&#x6CD5;"></a>1.2 &#x5DE5;&#x5382;&#x65B9;&#x6CD5;</h3><p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6A21;&#x5F0F;&#xFF08;FACTORY METHOD&#xFF09;&#x662F;&#x4E00;&#x79CD;&#x5E38;&#x7528;&#x7684;&#x7C7B;&#x521B;&#x5EFA;&#x578B;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;,&#x6B64;&#x6A21;&#x5F0F;&#x7684;&#x6838;&#x5FC3;&#x7CBE;&#x795E;&#x662F;&#x5C01;&#x88C5;&#x7C7B;&#x4E2D;&#x53D8;&#x5316;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x63D0;&#x53D6;&#x5176;&#x4E2D;&#x4E2A;&#x6027;&#x5316;&#x5584;&#x53D8;&#x7684;&#x90E8;&#x5206;&#x4E3A;&#x72EC;&#x7ACB;&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x4EE5;&#x8FBE;&#x5230;&#x89E3;&#x8026;&#x3001;&#x590D;&#x7528;&#x548C;&#x65B9;&#x4FBF;&#x540E;&#x671F;&#x7EF4;&#x62A4;&#x62D3;&#x5C55;&#x7684;&#x76EE;&#x7684;&#x3002;&#x5B83;&#x7684;&#x6838;&#x5FC3;&#x7ED3;&#x6784;&#x6709;&#x56DB;&#x4E2A;&#x89D2;&#x8272;&#xFF0C;&#x5206;&#x522B;&#x662F;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#xFF1B;&#x5177;&#x4F53;&#x5DE5;&#x5382;&#xFF1B;&#x62BD;&#x8C61;&#x4EA7;&#x54C1;&#xFF1B;&#x5177;&#x4F53;&#x4EA7;&#x54C1;&#x3002;</p>
<p><strong>&#x9002;&#x7528;&#x573A;&#x666F;</strong></p>
<p>&#x5982;&#x679C;&#x65E0;&#x6CD5;&#x9884;&#x77E5;&#x5BF9;&#x8C61;&#x786E;&#x5207;&#x7C7B;&#x522B;&#x53CA;&#x5176;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x65F6;&#xFF0C;&#x53EF;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x3002;<br>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5C06;&#x521B;&#x5EFA;&#x4EA7;&#x54C1;&#x7684;&#x4EE3;&#x7801;&#x4E0E;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x4EA7;&#x54C1;&#x7684;&#x4EE3;&#x7801;&#x5206;&#x79BB;&#xFF0C; &#x4ECE;&#x800C;&#x80FD;&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x4EE3;&#x7801;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x6269;&#x5C55;&#x4EA7;&#x54C1;&#x521B;&#x5EFA;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#x3002;<br>&#x4F8B;&#x5982;&#xFF0C; &#x5982;&#x679C;&#x9700;&#x8981;&#x5411;&#x5E94;&#x7528;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x79CD;&#x65B0;&#x4EA7;&#x54C1;&#xFF0C; &#x4F60;&#x53EA;&#x9700;&#x8981;&#x5F00;&#x53D1;&#x65B0;&#x7684;&#x521B;&#x5EFA;&#x8005;&#x5B50;&#x7C7B;&#xFF0C; &#x7136;&#x540E;&#x91CD;&#x5199;&#x5176;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#x3002;</p>
<p><strong>&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;</strong></p>
<ol>
<li>&#x8BA9;&#x6240;&#x6709;&#x4EA7;&#x54C1;&#x90FD;&#x9075;&#x5FAA;&#x540C;&#x4E00;&#x63A5;&#x53E3;&#x3002;&#x8BE5;&#x63A5;&#x53E3;&#x5FC5;&#x987B;&#x58F0;&#x660E;&#x5BF9;&#x6240;&#x6709;&#x4EA7;&#x54C1;&#x90FD;&#x6709;&#x610F;&#x4E49;&#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
<li>&#x5728;&#x521B;&#x5EFA;&#x7C7B;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x3002;&#x8BE5;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x9075;&#x5FAA;&#x901A;&#x7528;&#x7684;&#x4EA7;&#x54C1;&#x63A5;&#x53E3;&#x3002;</li>
</ol>
<p><strong>&#x4EE5;&#x4E0D;&#x540C;&#x79CD;&#x7C7B;&#x7684;&#x94C1;&#x5320;&#x94F8;&#x9020;&#x6B66;&#x5668;&#x4E3A;demo&#xFF1A;</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/46584c613158a066d4458f83fd54086c7537c84b527d53e89be24b578569ab1a" alt="image.png"></p>
<p>Blacksmith &#x94C1;&#x5320; &#x5305;&#x542B;&#x7528;&#x4E8E;&#x751F;&#x6210;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;&#x7684;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Blacksmith {</span><br><span class="line"></span><br><span class="line">  Weapon manufactureWeapon(WeaponType weaponType);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>WeaponType&#xFF1A;&#x6B66;&#x5668;&#x7C7B;&#x578B;&#x679A;&#x4E3E;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line"> * WeaponType enumeration.</span><br><span class="line"> */</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public enum WeaponType {</span><br><span class="line"></span><br><span class="line">  SHORT_SWORD(&quot;short sword&quot;),</span><br><span class="line">  SPEAR(&quot;spear&quot;),</span><br><span class="line">  AXE(&quot;axe&quot;),</span><br><span class="line">  UNDEFINED(&quot;&quot;);</span><br><span class="line"></span><br><span class="line">  private final String title;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return title;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Weapon &#x6B66;&#x5668;&#x7C7B;&#x578B;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;/**</span><br><span class="line"> * Weapon interface.</span><br><span class="line"> */</span><br><span class="line">public interface Weapon {</span><br><span class="line"></span><br><span class="line">  WeaponType getWeaponType();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7CBE;&#x7075;&#x94C1;&#x5320;&#xFF1A;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x5BF9;&#x8C61;&#x7684;&#x5177;&#x4F53;&#x5B50;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfBlacksmith implements Blacksmith {</span><br><span class="line"></span><br><span class="line">  private static final Map&lt;WeaponType, ElfWeapon&gt; ELFARSENAL;</span><br><span class="line"></span><br><span class="line">  static {</span><br><span class="line">    ELFARSENAL = new EnumMap&lt;&gt;(WeaponType.class);</span><br><span class="line">    Arrays.stream(WeaponType.values()).forEach(type -&gt; ELFARSENAL.put(type, new ElfWeapon(type)));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Weapon manufactureWeapon(WeaponType weaponType) {</span><br><span class="line">    return ELFARSENAL.get(weaponType);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;The elf blacksmith&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Elf Weapon &#x6B66;&#x5668;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public class ElfWeapon implements Weapon {</span><br><span class="line"></span><br><span class="line">  private final WeaponType weaponType;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;an elven &quot; + weaponType;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x94C1;&#x5320;&#xFF1A;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x65B0;&#x5BF9;&#x8C61;&#x7684;&#x5177;&#x4F53;&#x5B50;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcBlacksmith implements Blacksmith {</span><br><span class="line"></span><br><span class="line">  private static final Map&lt;WeaponType, OrcWeapon&gt; ORCARSENAL;</span><br><span class="line"></span><br><span class="line">  static {</span><br><span class="line">    ORCARSENAL = new EnumMap&lt;&gt;(WeaponType.class);</span><br><span class="line">    Arrays.stream(WeaponType.values()).forEach(type -&gt; ORCARSENAL.put(type, new OrcWeapon(type)));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Weapon manufactureWeapon(WeaponType weaponType) {</span><br><span class="line">    return ORCARSENAL.get(weaponType);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;The orc blacksmith&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>OrcWeapon &#x6B66;&#x5668;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@RequiredArgsConstructor</span><br><span class="line">@Getter</span><br><span class="line">public class OrcWeapon implements Weapon {</span><br><span class="line"></span><br><span class="line">  private final WeaponType weaponType;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;an orcish &quot; + weaponType;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line"> private static final String MANUFACTURED = &quot;{} manufactured {}&quot;;</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">  * Program entry point.</span><br><span class="line">  * @param args command line args</span><br><span class="line">  */</span><br><span class="line"> public static void main(String[] args) {</span><br><span class="line"></span><br><span class="line">   Blacksmith blacksmith = new OrcBlacksmith();</span><br><span class="line">   Weapon weapon = blacksmith.manufactureWeapon(WeaponType.SPEAR);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.AXE);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line"></span><br><span class="line">   blacksmith = new ElfBlacksmith();</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.SPEAR);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line">   weapon = blacksmith.manufactureWeapon(WeaponType.AXE);</span><br><span class="line">   LOGGER.info(MANUFACTURED, blacksmith, weapon);</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x79CD;&#x521B;&#x9020;&#x6027;&#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6765;&#x5904;&#x7406;<br>&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x65F6;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x8981;&#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x786E;&#x5207;&#x7C7B;&#x7684;&#x95EE;&#x9898;&#x3002;<br>&#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x5728;&#x63A5;&#x53E3;&#x4E2D;&#x6307;&#x5B9A;&#x7684;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6765;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x6765;&#x5B8C;&#x6210;&#x7684;<br>&#x5E76;&#x7531;&#x5B50;&#x7C7B;&#x5B9E;&#x73B0;&#xFF0C;&#x6216;&#x5728;&#x57FA;&#x7C7B;&#x4E2D;&#x5B9E;&#x73B0;&#x5E76;&#x53EF;&#x9009;&#x5730;&#x88AB;&#x8986;&#x76D6;<br>&#x6D3E;&#x751F;&#x7C7B;&#x2014;&#x2014;&#x800C;&#x4E0D;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x63A5;&#x53E3; Blacksmith &#x548C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<br>&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#xFF08;manufactureWeapon&#xFF09;&#x3002; &#x5177;&#x4F53;&#x7684;&#x5B50;&#x7C7B;&#xFF08;<br>OrcBlacksmith, ElfBlacksmith) &#x7136;&#x540E;&#x8986;&#x76D6;&#x8BE5;&#x65B9;&#x6CD5;&#x4EE5;&#x751F;&#x6210;&#x4ED6;&#x4EEC;&#x559C;&#x6B22;&#x7684;&#x5BF9;&#x8C61;</p>
<h3 id="1-3-&#x62BD;&#x8C61;&#x5DE5;&#x5382;"><a href="#1-3-&#x62BD;&#x8C61;&#x5DE5;&#x5382;" class="headerlink" title="1.3 &#x62BD;&#x8C61;&#x5DE5;&#x5382;"></a>1.3 &#x62BD;&#x8C61;&#x5DE5;&#x5382;</h3><p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#xFF08;AbstractFactory&#xFF09;&#x6A21;&#x5F0F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x5C01;&#x88C5;&#x4E00;&#x7EC4;&#x72EC;&#x7ACB;&#x5DE5;&#x5382;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x4E00;&#x4E2A;&#x5171;&#x540C;&#x7684;&#x76EE;&#x6807;&#xFF0C;&#x800C;&#x4E0D;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x3002;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8F6F;&#x4EF6;&#x521B;&#x5EFA;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x6CDB;&#x578B;&#x63A5;&#x53E3;&#xFF0C;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x4F5C;&#x4E3A;&#x4E3B;&#x9898;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x77E5;&#x9053;(&#x6216;&#x4E0D;&#x5173;&#x5FC3;)&#x5B83;&#x4ECE;&#x6BCF;&#x4E2A;&#x5185;&#x90E8;&#x5DE5;&#x5382;&#x83B7;&#x5F97;&#x54EA;&#x4E9B;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x53EA;&#x4F7F;&#x7528;&#x4ED6;&#x4EEC;&#x4EA7;&#x54C1;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x5C06;&#x7EC6;&#x8282;&#x5206;&#x5F00;&#x4E00;&#x7EC4;&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;&#x4ECE;&#x5B83;&#x4EEC;&#x7684;&#x4E00;&#x822C;&#x7528;&#x6CD5;&#x548C;&#x4F9D;&#x8D56;&#x4E8E;&#x5BF9;&#x8C61;&#x7EC4;&#x5408;&#xFF0C;&#x56E0;&#x4E3A;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x662F;&#x5728;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#x4E2D;&#x516C;&#x5F00;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x7684;&#x672C;&#x8D28;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x63A5;&#x53E3; &#xFF08;KingdomFactory&#xFF09;&#x53CA;&#x5176;&#x5B9E;&#x73B0;ElfKingdomFactory&#xFF0C;OrcKingdomFactory&#x3002;&#x8BE5;&#x793A;&#x4F8B;&#x4F7F;&#x7528;&#x521B;&#x5EFA;&#x56FD;&#x738B;&#x3001;&#x57CE;&#x5821;&#x548C;&#x519B;&#x961F;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/92e548ac9e34a4c981af868dece00e371321a4c09cf730524da03d1b037c592b" alt="image.png"></p>
<p>King &#x56FD;&#x738B;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface King {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Army &#x519B;&#x961F;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Army {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Castle&#xFF1A;&#x57CE;&#x5821;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Castle {</span><br><span class="line"></span><br><span class="line">  String getDescription();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>KingdomFactory&#xFF1A;&#x738B;&#x56FD;&#x5DE5;&#x5382;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface KingdomFactory {</span><br><span class="line"></span><br><span class="line">  Castle createCastle();</span><br><span class="line"></span><br><span class="line">  King createKing();</span><br><span class="line"></span><br><span class="line">  Army createArmy();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5E2E;&#x52A9;KingdomFactory &#x751F;&#x4EA7; bean&#x7684;&#x7C7B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;@Getter</span><br><span class="line">@Setter</span><br><span class="line">public class Kingdom {</span><br><span class="line"></span><br><span class="line">  private King king;</span><br><span class="line">  private Castle castle;</span><br><span class="line">  private Army army;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * The factory of kingdom factories.</span><br><span class="line">   */</span><br><span class="line">  public static class FactoryMaker {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Enumeration for the different types of Kingdoms.</span><br><span class="line">     */</span><br><span class="line">    public enum KingdomType {</span><br><span class="line">      ELF, ORC</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The factory method to create KingdomFactory concrete objects.</span><br><span class="line">     */</span><br><span class="line">    public static KingdomFactory makeFactory(KingdomType type) {</span><br><span class="line">      return switch (type) {</span><br><span class="line">        case ELF -&gt; new ElfKingdomFactory();</span><br><span class="line">        case ORC -&gt; new OrcKingdomFactory();</span><br><span class="line">        default -&gt; throw new IllegalArgumentException(&quot;KingdomType not supported.&quot;);</span><br><span class="line">      };</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfArmy &#xFF1A;&#x7CBE;&#x7075;&#x7684;&#x519B;&#x961F;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfArmy implements Army {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven army!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfCastle&#xFF1A;&#x7CBE;&#x7075;&#x57CE;&#x5821;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfCastle implements Castle {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven castle!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ElfKing &#x7CBE;&#x7075;&#x56FD;&#x738B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfKing implements King {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the elven king!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7CBE;&#x7075;&#x56FD;&#x5DE5;&#x5382;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class ElfKingdomFactory implements KingdomFactory {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Castle createCastle() {</span><br><span class="line">    return new ElfCastle();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public King createKing() {</span><br><span class="line">    return new ElfKing();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Army createArmy() {</span><br><span class="line">    return new ElfArmy();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x519B;&#x961F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcArmy implements Army {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc army!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x57CE;&#x5821;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcCastle implements Castle {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc castle!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x56FD;&#x738B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcKing implements King {</span><br><span class="line"></span><br><span class="line">  static final String DESCRIPTION = &quot;This is the orc king!&quot;;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public String getDescription() {</span><br><span class="line">    return DESCRIPTION;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x517D;&#x4EBA;&#x738B;&#x56FD;&#x5DE5;&#x5382;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class OrcKingdomFactory implements KingdomFactory {</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Castle createCastle() {</span><br><span class="line">    return new OrcCastle();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public King createKing() {</span><br><span class="line">    return new OrcKing();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Army createArmy() {</span><br><span class="line">    return new OrcArmy();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App implements Runnable {</span><br><span class="line"></span><br><span class="line">  private final Kingdom kingdom = new Kingdom();</span><br><span class="line"></span><br><span class="line">  public Kingdom getKingdom() {</span><br><span class="line">    return kingdom;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    var app = new App();</span><br><span class="line">    app.run();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void run() {</span><br><span class="line">    LOGGER.info(&quot;elf kingdom&quot;);</span><br><span class="line">    createKingdom(Kingdom.FactoryMaker.KingdomType.ELF);</span><br><span class="line">    LOGGER.info(kingdom.getArmy().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getCastle().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getKing().getDescription());</span><br><span class="line"></span><br><span class="line">    LOGGER.info(&quot;orc kingdom&quot;);</span><br><span class="line">    createKingdom(Kingdom.FactoryMaker.KingdomType.ORC);</span><br><span class="line">    LOGGER.info(kingdom.getArmy().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getCastle().getDescription());</span><br><span class="line">    LOGGER.info(kingdom.getKing().getDescription());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates kingdom.</span><br><span class="line">   * @param kingdomType type of Kingdom</span><br><span class="line">   */</span><br><span class="line">  public void createKingdom(final Kingdom.FactoryMaker.KingdomType kingdomType) {</span><br><span class="line">    final KingdomFactory kingdomFactory = Kingdom.FactoryMaker.makeFactory(kingdomType);</span><br><span class="line">    kingdom.setKing(kingdomFactory.createKing());</span><br><span class="line">    kingdom.setCastle(kingdomFactory.createCastle());</span><br><span class="line">    kingdom.setArmy(kingdomFactory.createArmy());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x5C01;&#x88C5;&#x4E00;&#x7EC4;&#x5177;&#x6709;&#x5171;&#x540C;&#x4E3B;&#x9898;&#x7684;&#x72EC;&#x7ACB;&#x5DE5;&#x5382;&#xFF0C;&#x800C;&#x65E0;&#x9700;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x3002;&#x5728;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8F6F;&#x4EF6;&#x521B;&#x5EFA;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x5DE5;&#x5382;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x521B;&#x5EFA;&#x4F5C;&#x4E3A;&#x4E3B;&#x9898;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x5BA2;&#x6237;&#x4E0D;&#x77E5;&#x9053;&#xFF08;&#x6216;&#x4E0D;&#x5173;&#x5FC3;&#xFF09;&#x5B83;&#x4ECE;&#x8FD9;&#x4E9B;&#x5185;&#x90E8;&#x5DE5;&#x5382;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x83B7;&#x5F97;&#x4E86;&#x54EA;&#x4E9B;&#x5177;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C; &#x56E0;&#x4E3A;&#x5B83;&#x53EA;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x4EA7;&#x54C1;&#x7684;&#x901A;&#x7528;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x5C06;&#x4E00;&#x7EC4;&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#x4E0E;&#x5B83;&#x4EEC;&#x7684;&#x4E00;&#x822C;&#x7528;&#x6CD5;&#x5206;&#x5F00;&#xFF0C;&#x5E76;&#x4F9D;&#x8D56;&#x4E8E;&#x5BF9;&#x8C61;&#x7EC4;&#x5408;&#xFF0C;&#x56E0;&#x4E3A;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x662F;&#x5728;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#x4E2D;&#x516C;&#x5F00;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x62BD;&#x8C61;&#x5DE5;&#x5382;&#x6A21;&#x5F0F;&#x7684;&#x672C;&#x8D28;&#x662F;&#x5DE5;&#x5382;&#x63A5;&#x53E3;&#xFF08;{@link KingdomFactory}&#xFF09;&#x53CA;&#x5176;&#x5B9E;&#x73B0;&#xFF08;{@link ElfKingdomFactory}&#x3001;{@link OrcKingdomFactory}&#xFF09;&#x3002;&#x8BE5;&#x793A;&#x4F8B;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x6765;&#x521B;&#x5EFA;&#x56FD;&#x738B;&#x3001;&#x57CE;&#x5821;&#x548C;&#x519B;&#x961F;&#x3002;</p>
<h3 id="1-4-Factory-kit-&#x6A21;&#x5F0F;"><a href="#1-4-Factory-kit-&#x6A21;&#x5F0F;" class="headerlink" title="1.4 Factory kit &#x6A21;&#x5F0F;"></a>1.4 Factory kit &#x6A21;&#x5F0F;</h3><p>Factory kit &#x662F;&#x4E00;&#x79CD;&#x521B;&#x5EFA;&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x53D8;&#x5185;&#x5BB9;&#x7684;&#x5DE5;&#x5382;&#xFF0C;&#x5177;&#x6709;&#x5206;&#x79BB;&#x7684;builder &#x548C; factory &#x63A5;&#x53E3;&#xFF0C;&#x4EE5;&#x5904;&#x7406;&#x76F4;&#x63A5;&#x5728; factory kit &#x5B9E;&#x4F8B;&#x4E2D;&#x521B;&#x5EFA;&#x6307;&#x5B9A;&#x5BF9;&#x8C61;&#x4E4B;&#x4E00;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/ad50c6906149244ad66444acc87422906f8a979620c7d3cd6c0469249a252b16" alt="image.png"></p>
<p><strong>&#x5177;&#x4F53;demo</strong></p>
<p>&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x6B66;&#x5668;&#x63A5;&#x53E3;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Weapon {</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x529F;&#x80FD;&#x63A5;&#x53E3;&#xFF0C;&#x5DE5;&#x5382;&#x5957;&#x4EF6;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x7684;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x3002; &#x672C;&#x5730;&#x521B;&#x5EFA;&#x7684;&#x5B9E;&#x4F8B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x673A;&#x4F1A;&#x6765;&#x4E25;&#x683C;&#x5B9A;&#x4E49;&#x5DE5;&#x5382;&#x5B9E;&#x4F8B;&#x5C06;&#x80FD;&#x591F;&#x521B;&#x5EFA;&#x54EA;&#x4E9B;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x3002;Factory &#x662F; Builder &#x7684;&#x5360;&#x4F4D;&#x7B26;&#x4F7F;&#x7528; WeaponFactory#create(WeaponType) &#x65B9;&#x6CD5;&#x521D;&#x59CB;&#x5316;&#x65B0;&#x5BF9;&#x8C61;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">php&#x590D;&#x5236;&#x4EE3;&#x7801;public interface WeaponFactory {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates an instance of the given type.</span><br><span class="line">   *</span><br><span class="line">   * @param name representing enum of an object type to be created.</span><br><span class="line">   * @return new instance of a requested class implementing {@link Weapon} interface.</span><br><span class="line">   */</span><br><span class="line">  Weapon create(WeaponType name);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Creates factory - placeholder for specified {@link Builder}s.</span><br><span class="line">   *</span><br><span class="line">   * @param consumer for the new builder to the factory.</span><br><span class="line">   * @return factory with specified {@link Builder}s</span><br><span class="line">   */</span><br><span class="line">  static WeaponFactory factory(Consumer&lt;Builder&gt; consumer) {</span><br><span class="line">    var map = new HashMap&lt;WeaponType, Supplier&lt;Weapon&gt;&gt;();</span><br><span class="line">    consumer.accept(map::put);</span><br><span class="line">    return name -&gt; map.get(name).get();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Builder&#xFF1A;&#x5141;&#x8BB8;&#x5C06;&#x5177;&#x6709;&#x540D;&#x79F0;&#x7684;&#x6784;&#x5EFA;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x5DE5;&#x5382;&#x7684;&#x529F;&#x80FD;&#x63A5;&#x53E3;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;public interface Builder {</span><br><span class="line">  void add(WeaponType name, Supplier&lt;Weapon&gt; supplier);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868; &#x65A7;&#x5934; &#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Axe implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Axe&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x5F13;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Bow implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Bow&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x77DB;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Spear implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Spear&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x8868;&#x5251;&#x7684;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typescript&#x590D;&#x5236;&#x4EE3;&#x7801;public class Sword implements Weapon {</span><br><span class="line">  @Override</span><br><span class="line">  public String toString() {</span><br><span class="line">    return &quot;Sword&quot;;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6B66;&#x5668;&#x7C7B;&#x578B;&#x7684;&#x679A;&#x4E3E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arduino&#x590D;&#x5236;&#x4EE3;&#x7801;public enum WeaponType {</span><br><span class="line">  SWORD,</span><br><span class="line">  AXE,</span><br><span class="line">  BOW,</span><br><span class="line">  SPEAR</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3B;&#x7C7B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">csharp&#x590D;&#x5236;&#x4EE3;&#x7801;@Slf4j</span><br><span class="line">public class App {</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Program entry point.</span><br><span class="line">   *</span><br><span class="line">   * @param args command line args</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) {</span><br><span class="line">    var factory = WeaponFactory.factory(builder -&gt; {</span><br><span class="line">      builder.add(WeaponType.SWORD, Sword::new);</span><br><span class="line">      builder.add(WeaponType.AXE, Axe::new);</span><br><span class="line">      builder.add(WeaponType.SPEAR, Spear::new);</span><br><span class="line">      builder.add(WeaponType.BOW, Bow::new);</span><br><span class="line">    });</span><br><span class="line">    var list = new ArrayList&lt;Weapon&gt;();</span><br><span class="line">    list.add(factory.create(WeaponType.AXE));</span><br><span class="line">    list.add(factory.create(WeaponType.SPEAR));</span><br><span class="line">    list.add(factory.create(WeaponType.SWORD));</span><br><span class="line">    list.add(factory.create(WeaponType.BOW));</span><br><span class="line">    list.forEach(weapon -&gt; LOGGER.info(&quot;{}&quot;, weapon.toString()));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x7ED9;&#x5B9A;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;WeaponFactory&#x8868;&#x793A;&#x5DE5;&#x5382;&#x5957;&#x4EF6;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x56DB;&#x4E2A; Builder&#xFF0C;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x5B9E;&#x73B0; Weapon&#x63A5;&#x53E3;&#x7684;&#x7C7B;&#x7684;&#x65B0;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x5B83;&#x4EEC;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x90FD;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; WeaponFactory#create(WeaponType) &#x65B9;&#x6CD5;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x4E2D; &#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x8868;&#x793A; WeaponType &#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x5DE5;&#x5382;&#x5B9E;&#x4F8B;&#x4E2D;&#x663E;&#x5F0F;&#x6620;&#x5C04;&#x6240;&#x9700;&#x7684;&#x7C7B;&#x7C7B;&#x578B;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/dfd3743d38b4f04fa3c2196b87093a7a.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233964656287973436.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233964656287973436.html" itemprop="url">Flutter 小技巧之 310 适配之单例 Window</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-17T11:59:38+08:00">
                2023-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Flutter 3.10 &#x53D1;&#x5E03;&#x4E4B;&#x540E;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x80FD;&#x6CE8;&#x610F;&#x5230;&#xFF0C;&#x5728;&#x5B83;&#x7684; <a href="https://dev.newban.cn/7231565908631633979#heading-46">release note</a> &#x91CC;&#x63D0;&#x4E86;&#x4E00;&#x53E5;&#xFF1A; <strong>Window singleton &#x76F8;&#x5173;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x6539;&#x52A8;&#x662F;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x672A;&#x6765;&#x591A;&#x7A97;&#x53E3;&#x7684;&#x76F8;&#x5173;&#x5B9E;&#x73B0;</strong>&#x3002;</p>
<blockquote>
<p>&#x6240;&#x4EE5;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x591A;&#x7A97;&#x53E3;&#x7684;&#x76F8;&#x5173;&#x6539;&#x8FDB;&#xFF0C;&#x591A;&#x7A97;&#x53E3;&#x66F4;&#x591A;&#x662F;&#x5728; PC &#x573A;&#x666F;&#x4E0B;&#x66F4;&#x5E38;&#x89C1;&#xFF0C;&#x4F46;&#x662F;&#x53C8;&#x9700;&#x8981;&#x517C;&#x5BB9; Mobile &#x573A;&#x666F;&#xFF0C;&#x6545;&#x800C;&#x6709;&#x6B64;&#x6B21;&#x6539;&#x52A8;&#x4F5C;&#x4E3A;&#x63D0;&#x524D;&#x94FA;&#x57AB;&#x3002;</p>
</blockquote>
<p>&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x5982;&#x679C;&#x5177;&#x4F53;&#x5230;&#x5BF9;&#x5E94;&#x7684; API &#x573A;&#x666F;&#xFF0C;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x6D89;&#x53CA; <code>WidgetsBinding.instance.window</code> &#x548C; <code>MediaQueryData.fromWindow</code> &#x7B49;&#x63A5;&#x53E3;&#x7684;&#x9002;&#x914D;&#xFF0C;&#x56E0;&#x4E3A; <code>WidgetsBinding.instance.window</code> &#x5373;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/31f86cfeafe61449ad72b36cd0c0e23262c315ede09114f152afa8291d7d58ab" alt></p>
<blockquote>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x4E0D;&#x9002;&#x914D;&#xFF0C;&#x8FD8;&#x80FD;&#x8DD1;&#xFF0C;&#x53EA;&#x662F;&#x5347;&#x7EA7;&#x7684;&#x6280;&#x672F;&#x503A;&#x52A1;&#x5F80;&#x540E;&#x7D2F;&#x8BA1;&#x800C;&#x5DF2;&#x3002;</p>
</blockquote>
<p>&#x90A3;&#x9996;&#x5148;&#x53EF;&#x80FD;&#x5C31;&#x6709;&#x4E00;&#x4E2A;&#x7591;&#x95EE;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6709;&#x9700;&#x8981;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.window</code> &#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#xFF1F;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x603B;&#x7ED3;&#x4E3A;&#xFF1A;</p>
<ul>
<li>&#x6CA1;&#x6709; <code>BuildContext</code> &#xFF0C;&#x4E0D;&#x60F3;&#x5F15;&#x5165; <code>BuildContext</code></li>
<li>&#x4E0D;&#x5E0C;&#x671B;&#x83B7;&#x53D6;&#x5230;&#x7684; <code>MediaQueryData</code> &#x53D7;&#x5230;&#x6240;&#x5728; <code>BuildContext</code> &#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x4F8B;&#x5982;&#x952E;&#x76D8;&#x5F39;&#x8D77;&#x5BFC;&#x81F4; padding &#x53D8;&#x5316;&#x91CD;&#x6784;&#x548C;&#x53D7;&#x5230; <code>Scaffold</code> &#x4E0B;&#x7684;&#x53C2;&#x6570;&#x5F71;&#x54CD;&#x7B49;</li>
</ul>
<blockquote>
<p>&#x8FD9;&#x90E8;&#x5206;&#x8BE6;&#x7EC6;&#x53EF;&#x89C1;&#xFF1A;<a href="https://dev.newban.cn/7114098725600903175">&#x300A;MediaQuery &#x548C; build &#x4F18;&#x5316;&#x4F60;&#x4E0D;&#x77E5;&#x9053;&#x7684;&#x79D8;&#x5BC6;&#x300B;</a> &#x3002;</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x4ECE; 3.10 &#x5F00;&#x59CB;&#xFF0C;&#x9488;&#x5BF9; <code>WidgetsBinding.instance.window</code> &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x65B0;&#x7684; API &#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x517C;&#x5BB9;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;&#x5B58;&#x5728; <code>BuildContex</code> &#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>View.of</code> &#x83B7;&#x53D6; <code>FlutterView</code>&#xFF0C;&#x8FD9;&#x662F;&#x5B98;&#x65B9;&#x6700;&#x63A8;&#x8350;&#x7684;&#x66FF;&#x4EE3;&#x65B9;&#x5F0F;</li>
<li>&#x5982;&#x679C;&#x6CA1;&#x6709; <code>BuildContex</code> &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>PlatformDispatcher</code> &#x7684; <code>views</code> &#x5BF9;&#x8C61;&#x53BB;&#x83B7;&#x53D6;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x6CE8;&#x610F;&#x5230;&#x6CA1;&#x6709;&#xFF0C;&#x73B0;&#x5728;&#x7528;&#x7684;&#x662F; <code>View.of</code> &#xFF0C;&#x83B7;&#x53D6;&#x7684;&#x662F; <code>FlutterView</code> &#xFF0C;&#x5BF9;&#x8C61;&#x90FD;&#x79F0;&#x547C;&#x4E3A; View &#x800C;&#x4E0D;&#x662F; &#x300C;Window&#x300D;&#xFF0C;&#x5BF9;&#x5E94;&#x7684; <code>MediaQueryData.fromWindow</code> API &#x4E5F;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x4FEE;&#x6539;&#x4E3A; <code>MediaQueryData.fromView</code> &#xFF0C;&#x8FD9;&#x4E2A;&#x4FEE;&#x6539;&#x7684;&#x4F9D;&#x636E;&#x5728;&#x4E8E;&#xFF1A;</p>
<blockquote>
<p>&#x8D77;&#x521D; Flutter &#x5047;&#x5B9A;&#x4E86;&#x5B83;&#x53EA;&#x652F;&#x6301;&#x4E00;&#x4E2A; Window &#x7684;&#x573A;&#x666F;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x6709; <code>SingletonFlutterWindow</code> &#x8FD9;&#x6837;&#x7684; instance window &#x5BF9;&#x8C61;&#x5B58;&#x5728;&#xFF0C;&#x540C;&#x65F6; <code>window</code> &#x5C5E;&#x6027;&#x53C8;&#x63D0;&#x4F9B;&#x4E86;&#x8BB8;&#x591A;&#x548C;&#x7A97;&#x53E3;&#x672C;&#x8EAB;&#x65E0;&#x5173;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5728;&#x591A;&#x7A97;&#x53E3;&#x903B;&#x8F91;&#x4E0B;&#x4F1A;&#x663E;&#x5F97;&#x5F88;&#x53E6;&#x7C7B;&#x3002;</p>
</blockquote>
<p>&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x7528;&#x300C;&#x957F;&#x7BC7;&#x5927;&#x8BBA;&#x300D;&#x6765;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E0B;&#x8FD9;&#x4E24;&#x4E2A;&#x573A;&#x666F;&#x7684;&#x7279;&#x522B;&#x4E4B;&#x5904;&#x3002;</p>
<h1 id="&#x5B58;&#x5728;-BuildContext"><a href="#&#x5B58;&#x5728;-BuildContext" class="headerlink" title="&#x5B58;&#x5728; BuildContext"></a>&#x5B58;&#x5728; BuildContext</h1><p>&#x56DE;&#x5F52;&#x5230;&#x672C;&#x6B21;&#x7684;&#x8C03;&#x6574;&#xFF0C;&#x9996;&#x5148;&#x662F;&#x5B58;&#x5728; BuildContext &#x7684;&#x573A;&#x666F;&#xFF0C;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x5BF9;&#x4E8E;&#x5B58;&#x5728; <code>BuildContex</code> &#x7684;&#x573A;&#x666F;&#xFF0C; <code>View.of</code> &#x76F8;&#x5173;&#x7684;&#x8C03;&#x6574;&#x4E3A;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;/// 3.10 &#x4E4B;&#x524D;</span><br><span class="line">double&#xA0;dpr&#xA0;=&#xA0;WidgetsBinding.instance.window.devicePixelRatio;</span><br><span class="line">Locale&#xA0;locale&#xA0;=&#xA0;WidgetsBinding.instance.window.locale;</span><br><span class="line">double&#xA0;width&#xA0;=</span><br><span class="line">&#xA0; &#xA0;MediaQueryData.fromWindow(WidgetsBinding.instance.window).size.width;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/// 3.10 &#x4E4B;&#x540E;</span><br><span class="line">double&#xA0;dpr&#xA0;=&#xA0;View.of(context).devicePixelRatio;</span><br><span class="line">Locale&#xA0;locale&#xA0;=&#xA0;View.of(context).platformDispatcher.locale;</span><br><span class="line">double&#xA0;width&#xA0;=</span><br><span class="line">&#xA0; &#xA0;MediaQueryData.fromView(View.of(context)).size.width;</span><br></pre></td></tr></table></figure>

<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; <code>View</code> &#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x80AF;&#x5B9A;&#x662F;&#x6709;&#x4E00;&#x4E2A; <code>InheritedWidget</code> &#xFF0C;&#x5B83;&#x5C06; <code>FlutterView</code> &#x901A;&#x8FC7; <code>BuildContext</code> &#x5F80;&#x4E0B;&#x5171;&#x4EAB;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x4F9B;&#x7C7B;&#x4F3C; &#x300C;window&#x300D; &#x7684;&#x53C2;&#x6570;&#x80FD;&#x529B;&#xFF0C;&#x800C;&#x901A;&#x8FC7; <code>View.of</code> &#x83B7;&#x53D6;&#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<ul>
<li><strong>&#x5F53; <code>FlutterView</code> &#x672C;&#x8EAB;&#x7684;&#x5C5E;&#x6027;&#x503C;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x662F;&#x4E0D;&#x4F1A;&#x901A;&#x77E5;&#x7ED1;&#x5B9A;&#x7684; <code>context</code> &#x66F4;&#x65B0;&#xFF0C;&#x8FD9;&#x4E2A;&#x884C;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E4B;&#x524D;&#x7684; <code>WidgetsBinding.instance.window</code></strong></li>
<li>&#x53EA;&#x6709;&#x5F53; <code>FlutterView</code> &#x672C;&#x8EAB;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x6BD4;&#x5982; <code>context</code> &#x7ED8;&#x5236;&#x5230;&#x4E0D;&#x540C;&#x7684; <code>FlutterView</code> &#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x89E6;&#x53D1;&#x5BF9;&#x5E94;&#x7ED1;&#x5B9A;&#x7684; <code>context</code> &#x66F4;&#x65B0;</li>
</ul>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230; <code>View.of</code> &#x8FD9;&#x4E2A;&#x884C;&#x4E3A;&#x8003;&#x8651;&#x7684;&#x662F;&#x300C;&#x591A; <code>FlutterView</code>&#x300D; &#x4E0B;&#x7684;&#x66F4;&#x65B0;&#x573A;&#x666F;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x9700;&#x8981;&#x7ED1;&#x5B9A;&#x5230;&#x5177;&#x4F53;&#x5BF9;&#x5E94;&#x53C2;&#x6570;&#x7684;&#x53D8;&#x52A8;&#x66F4;&#x65B0;&#xFF0C;&#x5982; <code>size</code> &#x7B49;&#xFF0C;&#x8FD8;&#x662F;&#x8981;&#x901A;&#x8FC7;&#x4EE5;&#x524D;&#x7684; <code>MediaQuery.of</code> / <code>MediaQuery.maybeOf</code> &#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x800C;&#x5BF9;&#x4E8E; <code>View</code> &#x6765;&#x8BF4;&#xFF0C;<strong>&#x6BCF;&#x4E2A; <code>FlutterView</code> &#x90FD;&#x5FC5;&#x987B;&#x662F;&#x72EC;&#x7ACB;&#x4E14;&#x552F;&#x4E00;&#x7684;</strong>&#xFF0C;&#x5728;&#x4E00;&#x4E2A; Widget Tree &#x91CC;&#xFF0C;&#x4E00;&#x4E2A; <code>FlutterView</code> &#x53EA;&#x80FD;&#x548C;&#x4E00;&#x4E2A; <code>View</code> &#x76F8;&#x5173;&#x8054;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E3B;&#x8981;&#x4F53;&#x73B0;&#x5728; <code>FlutterView</code> &#x6807;&#x8BC6; <code>GlobalObjectKey</code> &#x7684;&#x5B9E;&#x73B0;&#x4E0A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/8992e156ad9bbb3991e62451f5265412d8fe33d2959984be71fea30ac1a45587" alt></p>
<p>&#x7B80;&#x5355;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;<strong>&#x5728;&#x5B58;&#x5728; <code>BuildContex</code> &#x7684;&#x573A;&#x666F;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x5C06; <code>WidgetsBinding.instance.window</code> &#x66FF;&#x6362;&#x4E3A; <code>View.of(context)</code> &#xFF0C;&#x4E0D;&#x7528;&#x62C5;&#x5FC3;&#x7ED1;&#x5B9A;&#x4E86; <code>context</code> &#x5BFC;&#x81F4;&#x91CD;&#x6784;&#xFF0C;&#x56E0;&#x4E3A; <code>View.of</code> &#x53EA;&#x5BF9; <code>FlutterView</code> &#x5207;&#x6362;&#x7684;&#x573A;&#x666F;&#x751F;&#x6548;</strong>&#x3002;</p>
<h1 id="&#x4E0D;&#x5B58;&#x5728;-BuildContext"><a href="#&#x4E0D;&#x5B58;&#x5728;-BuildContext" class="headerlink" title="&#x4E0D;&#x5B58;&#x5728; BuildContext"></a>&#x4E0D;&#x5B58;&#x5728; BuildContext</h1><p>&#x5BF9;&#x4E8E;&#x4E0D;&#x5B58;&#x5728;&#x6216;&#x8005;&#x4E0D;&#x65B9;&#x4FBF;&#x4F7F;&#x7528; <code>BuildContext</code> &#x7684;&#x573A;&#x666F;&#xFF0C;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x4E86; <code>PlatformDispatcher.views</code> API &#x6765;&#x8FDB;&#x884C;&#x652F;&#x6301;&#xFF0C;&#x4E0D;&#x8FC7;&#x56E0;&#x4E3A; <code>get views</code> &#x5BF9;&#x5E94;&#x7684;&#x662F; <code>Map</code> &#x7684; <code>values</code> &#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A; <code>Iterable</code> &#x5BF9;&#x8C61;&#xFF0C;<strong>&#x90A3;&#x4E48;&#x5BF9;&#x4E8E; 3.10 &#x6211;&#x4EEC;&#x9700;&#x8981;&#x5982;&#x4F55;&#x4F7F;&#x7528; <code>PlatformDispatcher.views</code> &#x6765;&#x9002;&#x914D;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684; <code>WidgetsBinding.instance.window</code> &#x573A;&#x9762;</strong>&#xFF1F;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/99ff77582cb730e4170b4e34ce705e4013afe5960c9e8ffa21099c74b95b028f" alt></p>
<blockquote>
<p><code>PlatformDispatcher</code> &#x5185;&#x90E8;&#x7684;<code>views</code> &#x7EF4;&#x62A4;&#x4E86;&#x4E2D;&#x6240;&#x6709;&#x53EF;&#x7528; <code>FlutterView</code> &#x7684;&#x5217;&#x8868;&#xFF0C;&#x7528;&#x4E8E;&#x63D0;&#x4F9B;&#x5728;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8BBF;&#x95EE;&#x89C6;&#x56FE;&#x7684;&#x652F;&#x6301;&#x3002;</p>
</blockquote>
<p>&#x4F60;&#x8BF4;&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x6709;&#x6CA1;&#x6709; <code>BuildContext</code> &#xFF1F;&#x6BD4;&#x5982; Flutter &#x91CC; &#x7684; <code>runApp</code> &#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;3.10 &#x76EE;&#x524D;&#x5728; <code>runApp</code> &#x65F6;&#x4F1A;&#x901A;&#x8FC7; <code>platformDispatcher.implicitView</code> &#x6765;&#x585E;&#x8FDB;&#x53BB;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684; <code>FlutterView</code> &#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/6d16abfc37df39d0617509f2bfa5993efa87bc0c18a5d22644145e441e801e30" alt></p>
<p><code>implicitView</code> &#x53C8;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x5176;&#x5B9E; <code>implicitView</code> &#x5C31;&#x662F; <code>PlatformDispatcher._views</code> &#x91CC; id &#x4E3A; 0 &#x7684; <code>FlutterView</code> &#xFF0C;&#x9ED8;&#x8BA4;&#x4E5F;&#x662F; <code>views</code> &#x8FD9;&#x4E2A; <code>Iterable</code> &#x91CC;&#x7684; <code>first</code> &#x5BF9;&#x8C61;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/095083a377afd9fed7c784d1216efbaced341ab8430d6a87d76e26030b9e0dd0" alt></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x6CA1;&#x6709; <code>BuildContext</code> &#x7684;&#x573A;&#x666F;&#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>platformDispatcher.views.first</code> &#x7684;&#x5B9E;&#x73B0;&#x8FC1;&#x79FB;&#x5BF9;&#x5E94;&#x7684; <code>instance.window</code> &#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;/// 3.10 &#x4E4B;&#x524D;</span><br><span class="line">MediaQueryData.fromWindow(WidgetsBinding.instance.window)</span><br><span class="line">/// 3.10 &#x4E4B;&#x540E;</span><br><span class="line">MediaQueryData.fromView(WidgetsBinding.instance.platformDispatcher.views.first)</span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>implicitView</code> &#x5BF9;&#x8C61;&#xFF1F; &#x56E0;&#x4E3A; <code>implicitView</code> &#x76EE;&#x524D;&#x662F;&#x4E00;&#x4E2A;&#x8FC7;&#x6E21;&#x6027;&#x65B9;&#x6848;&#xFF0C;&#x5B98;&#x65B9;&#x5E0C;&#x671B;&#x5728;&#x591A;&#x89C6;&#x56FE;&#x7684;&#x573A;&#x666F;&#x4E0B;&#x4E0D;&#x5E94;&#x8BE5;&#x59CB;&#x7EC8;&#x5B58;&#x5728; implicit view &#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x800C;&#x662F;&#x5E94;&#x7528;&#x81EA;&#x5DF1;&#x5E94;&#x8BE5;&#x4E3B;&#x52A8;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7A97;&#x53E3;&#xFF0C;&#x53BB;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x89C6;&#x56FE;&#x8FDB;&#x884C;&#x7ED8;&#x5236;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/b5e4fe05e2c7a74ecee4a21d0a4ee50dd15ccdb0e4ade570a43acc260791b482" alt></p>
<p>&#x6240;&#x4EE5;&#x5BF9;&#x4E8E; <code>implicitView</code> &#x76EE;&#x524D;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x4E86; <code>_implicitViewEnabled</code> &#x51FD;&#x6570;&#xFF0C;&#x540E;&#x7EED;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53EF;&#x914D;&#x7F6E;&#x4F4D;&#x6765;&#x63A7;&#x5236;&#x5F15;&#x64CE;&#x662F;&#x5426;&#x652F;&#x6301; <code>implicitView</code> &#xFF0C;&#x4E5F;&#x5C31;&#x662F; <strong><code>implicitView</code> &#x5728;&#x540E;&#x7EED;&#x66F4;&#x65B0;&#x968F;&#x65F6;&#x53EF;&#x80FD;&#x4E3A; null &#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x4E0D;&#x5E94;&#x8BE5;&#x5728;&#x5916;&#x90E8;&#x53BB;&#x4F7F;&#x7528;&#x5B83;&#x7684;&#x7406;&#x7531;</strong>&#xFF0C;&#x540C;&#x65F6;&#x5B83;&#x662F;&#x5728; <code>runApp</code> &#x65F6;&#x914D;&#x7F6E;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5728;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x8FD0;&#x884C;&#x540E;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x6539;&#x53D8;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x5B83;&#x6C38;&#x8FDC;&#x90FD;&#x4F1A;&#x662F; null&#x3002;</p>
<blockquote>
<p><code>PlatformDispatcher.instance.views[0]</code> &#x5728;&#x4E4B;&#x524D;&#x7684;&#x5355;&#x89C6;&#x56FE;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x6709;&#x7A97;&#x53E3;&#x5B58;&#x5728;&#xFF0C;&#x7C7B;&#x4F3C;&#x7684; <code>implicitView</code> &#x4F1A;&#x59CB;&#x7EC8;&#x5B58;&#x5728;&#xFF1B;&#x800C;&#x5728;&#x591A;&#x7A97;&#x53E3;&#x573A;&#x666F;&#x4E0B;&#xFF0C;<code>PlatformDispatcher.instance.views</code> &#x5C06;&#x4F1A;&#x8DDF;&#x968F;&#x7A97;&#x53E3;&#x53D8;&#x5316;&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x5916;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#x53BB;&#x8BBF;&#x95EE; <code>views</code> &#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x901A;&#x8FC7; <code>PlatformDispatcher.instance.views</code> &#xFF0C;&#x56E0;&#x4E3A;&#x901A;&#x5E38;&#x5B98;&#x65B9;&#x66F4;&#x5EFA;&#x8BAE;&#x5728; Binding &#x7684;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x4E0B;&#x53BB;&#x8BBF;&#x95EE; <code>PlatformDispatcher</code> &#x3002;</p>
<blockquote>
<p>&#x9664;&#x4E86;&#x9700;&#x8981;&#x5728; <code>runApp()</code> &#x6216;&#x8005; <code>ensureInitialized()</code> &#x4E4B;&#x524D;&#x8BBF;&#x95EE; PlatformDispatcher &#x7684;&#x573A;&#x666F;&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x5916;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x901A;&#x8FC7; Engine &#x91CC;&#x5BF9;&#x4E8E; window &#x90E8;&#x5206;&#x4EE3;&#x7801;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x6240;&#x9700;&#x7684;&#x9ED8;&#x8BA4;<code>FlutterView</code> &#x662F; id &#x4E3A; 0 &#x7684;&#x76F8;&#x5173;&#x4F9D;&#x636E;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#x53BB;&#x517C;&#x5BB9;&#x652F;&#x6301;&#x7684;&#x903B;&#x8F91;&#x6240;&#x5728;&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
</table>
<h1 id="&#x6700;&#x540E;"><a href="#&#x6700;&#x540E;" class="headerlink" title="&#x6700;&#x540E;"></a>&#x6700;&#x540E;</h1><p>&#x6700;&#x540E;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF0C;&#x8BF4;&#x4E86;&#x90A3;&#x4E48;&#x591A;&#xFF0C;&#x5176;&#x5B9E;&#x4E0D;&#x5916;&#x4E4E;&#x5C31;&#x662F;&#x5C06; <code>WidgetsBinding.instance.window</code> &#x66FF;&#x6362;&#x4E3A; <code>View.of(context)</code> &#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x9A9A;&#x64CD;&#x4F5C;&#x573A;&#x666F;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.platformDispatcher.views</code> &#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6015;&#x540E;&#x7EED;&#x53C8;&#x5751;&#xFF0C;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528; <code>WidgetsBinding.instance.platformDispatcher.implicitView</code> &#x3002;</p>
<p>&#x6574;&#x4F53;&#x4E0A;&#x89E3;&#x91CA;&#x90A3;&#x4E48;&#x591A;&#xFF0C;<strong>&#x4E3B;&#x8981;&#x8FD8;&#x662F;&#x7ED9;&#x5927;&#x5BB6;&#x5BF9;&#x8FD9;&#x6B21;&#x53D8;&#x52A8;&#x6709;&#x4E00;&#x4E2A;&#x80CC;&#x666F;&#x8BA4;&#x77E5;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x5BF9;&#x672A;&#x6765;&#x591A;&#x7A97;&#x53E3;&#x5B9E;&#x73B0;&#x8FDB;&#x5C55;&#x6709;&#x8FDB;&#x4E00;&#x6B65;&#x7684;&#x4E86;&#x89E3;</strong>&#xFF0C;&#x76F8;&#x4FE1;&#x4E0B;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x591A;&#x7A97;&#x53E3;&#x5E94;&#x8BE5;&#x5C31;&#x53EF;&#x4EE5;&#x548C;&#x5927;&#x5BB6;&#x89C1;&#x9762;&#x4E86;&#x3002;</p>
<p>&#x66F4;&#x591A;&#x8BA8;&#x8BBA;&#x53EF;&#x89C1;&#xFF1A;</p>
<ul>
<li><a href="/external_links/36e2e1b464fadefe00c92d9548c60b68.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/71be0d321405088e7bea5c4bfb5a6528.html" target="blank" rel="noopener">github.com/flutter/eng&#x2026;</a></li>
<li><a href="/external_links/bc745af0eebe9a54930fbcbc0cfa3a83.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/0249a9b5af89ca99c5f3ad4233767a22.html" target="blank" rel="noopener">github.com/flutter/flu&#x2026;</a></li>
<li><a href="/external_links/b630f10a5f2068b2d33787ed0b4bac13.html" target="blank" rel="noopener">github.com/flutter/eng&#x2026;</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/172745dea4c9f79d934c182058e00504.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233625509107499067.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233625509107499067.html" itemprop="url">Node 中的 AsyncLocalStorage 的前世今</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-16T15:22:14+08:00">
                2023-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="&#x4E00;&#x3001;&#x80CC;&#x666F;"><a href="#&#x4E00;&#x3001;&#x80CC;&#x666F;" class="headerlink" title="&#x4E00;&#x3001;&#x80CC;&#x666F;"></a>&#x4E00;&#x3001;&#x80CC;&#x666F;</h1><p>&#x4F60;&#x597D;&#xFF01;&#x6211;&#x662F;&#x903B;&#x5343;&#xFF0C;&#x975E;&#x5E38;&#x9AD8;&#x5174;&#x4F60;&#x80FD;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5728;&#x5F00;&#x59CB;&#x524D;&#x6211;&#x5C06;&#x5927;&#x81F4;&#x4ECB;&#x7ECD;&#x4E24;&#x70B9;&#xFF0C;&#x5173;&#x4E8E;&#x9002;&#x5408;&#x8C01;&#x770B;&#x548C;&#x80FD;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;</p>
<h2 id="&#x9002;&#x5408;&#x8C01;&#x770B;"><a href="#&#x9002;&#x5408;&#x8C01;&#x770B;" class="headerlink" title="&#x9002;&#x5408;&#x8C01;&#x770B;"></a>&#x9002;&#x5408;&#x8C01;&#x770B;</h2><table>
<thead>
<tr>
<th><strong>&#x7C7B;&#x578B;&#x4EBA;&#x7FA4;</strong></th>
<th><strong>&#x63A8;&#x8350;&#x6307;&#x6570;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>&#x5B8C;&#x5168;&#x4E0D;&#x4E86;&#x89E3;Node&#xFF0C;&#x4F46;&#x6709;&#x5174;&#x8DA3;&#x770B;&#x770B;</td>
<td>&#x9002;&#x5408;&#xFF0C;&#x6709;&#x70B9;&#x95E8;&#x69DB;&#xFF0C;&#x4F1A;&#x5C3D;&#x91CF;&#x7167;&#x987E;&#x5230;</td>
</tr>
<tr>
<td>&#x5199;&#x8FC7;Node Server&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x8FD9;&#x4E2A;API</td>
<td>&#x5F88;&#x9002;&#x5408;&#xFF0C;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#x7684;&#x673A;&#x4F1A;</td>
</tr>
<tr>
<td>&#x7528;&#x8FC7;&#x4E86;&#x89E3;&#x8FC7;&#x6B64;API&#xFF0C;&#x4F46;&#x4E0D;&#x77E5;&#x9053;&#x4ED6;&#x7684;&#x524D;&#x4E16;&#x4ECA;&#x751F;</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF0C;&#x4F60;&#x770B;&#x6807;&#x9898;&#x554A;</td>
</tr>
<tr>
<td>&#x975E;&#x5E38;&#x4E86;&#x89E3;&#x6B64;API&#x751A;&#x81F3;&#x63D0;&#x8FC7;&#x76F8;&#x5173;PR</td>
<td>&#x975E;&#x5E38;&#x9002;&#x5408;&#xFF01;</td>
</tr>
</tbody></table>
<h2 id="Takeaway"><a href="#Takeaway" class="headerlink" title="Takeaway"></a>Takeaway</h2><p>&#x5982;&#x679C;&#x4F60;&#x6709;&#x8010;&#x5FC3;&#x770B;&#x5B8C;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4F60;&#x5C06;&#x4E86;&#x89E3;&#x5230;&#x4EC0;&#x4E48;&#xFF1A;</p>
<ol>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4E00;&#x822C;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
<li>AsyncLocalStorage &#x4E0E;&#x6700;&#x65B0;&#x7684;&#x963F;&#x91CC;&#x5DF4;&#x5DF4;&#x4E3B;&#x5BFC;&#x7684; TC39 &#x63D0;&#x6848; AsyncContext &#x4E4B;&#x95F4;&#x662F;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#xFF1F;</li>
<li>&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7C7B;&#x4F3C;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x600E;&#x4E48;&#x7528;&#x7684;&#xFF1F;</li>
<li>Node &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684; AsyncHook&#xFF1F;</li>
</ol>
<h1 id="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage"><a href="#&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F;-AsyncLocalStorage" class="headerlink" title="&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage"></a>&#x4E8C;&#x3001;&#x5F00;&#x95E8;&#x89C1;&#x5C71;&#xFF1A;&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage</h1><h2 id="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"><a href="#&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;" class="headerlink" title="&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;"></a>&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5F15;&#x5165;</h2><p>&#x5F53;&#x4E00;&#x4E2A; Request &#x901A;&#x8FC7;&#x5C42;&#x5C42;&#x5173;&#x5361;&#x6253;&#x5230;&#x6211;&#x4EEC;&#x7684; Server&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x4EA7;&#x751F;&#x591A;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#xFF1A;</p>
<ol>
<li>&#x8BBF;&#x95EE;&#x65E5;&#x5FD7;</li>
<li>&#x5F02;&#x5E38;&#x65E5;&#x5FD7;</li>
<li>SQL&#x65E5;&#x5FD7;</li>
<li>&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x65E5;&#x5FD7;&#x7B49;</li>
</ol>
<p>&#x800C;&#x5F53;&#x53D1;&#x751F;&#x4E86;&#x7EBF;&#x4E0A;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x6EAF;&#x6E90;&#x6392;&#x67E5;&#x3002;</p>
<p>&#x4E00;&#x822C;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x5728;&#x8BF7;&#x6C42;&#x4E4B;&#x5904;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x4E2A; unique traceId&#xFF0C;&#x6B64; id &#x5728;&#x6240;&#x6709;&#x65E5;&#x5FD7;&#x4E2D;&#x643A;&#x5E26;&#x5C31;&#x53EF;&#x4EE5;&#x8FFD;&#x8E2A;&#x8BE5;&#x8BF7;&#x6C42;&#x7684;&#x6240;&#x6709;&#x94FE;&#x8DEF;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;<strong>&#x5168;&#x94FE;&#x8DEF;&#x65E5;&#x5FD7;&#x8FFD;&#x8E2A;</strong>&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5728; Node Server &#x4E2D;&#x5982;&#x4F55;&#x8BA9;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0A;&#x4E0B;&#x6E38;&#x8C03;&#x7528;&#x90FD;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A; traceId &#x5462;&#xFF0C;&#x6211;&#x4EEC;&#x4E0B;&#x9762;&#x7ED9;&#x51E0;&#x4E2A;&#x65B9;&#x6848;&#x3002;</p>
<p>&#xFF08;&#x5148;&#x4E0D;&#x7BA1;&#x8FD9;&#x4E2A; id &#x662F; server &#x81EA;&#x5DF1;&#x751F;&#x6210;&#x7684;&#x8FD8;&#x662F; client &#x5E26;&#x4E0A;&#x6765;&#x7684;&#xFF09;</p>
<h2 id="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"><a href="#&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;" class="headerlink" title="&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;"></a>&#x65B9;&#x6848;1&#xFF1A;&#x5168;&#x5C40;&#x53D8;&#x91CF;</h2><p>&#x7B80;&#x5355;&#xFF0C;&#x5148;&#x62CD;&#x8111;&#x888B;&#x60F3;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>globalTraceId</code>&#xFF01;</p>
<p>&#x56E0;&#x4E3A;<code>closure</code>&#x95ED;&#x5305;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;close&#x4F4F;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5728;&#x4EFB;&#x4F55;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#xFF0C;&#x8BFB;&#x53D6;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x6240;&#x6307;&#x7684;&#x5185;&#x5B58;&#x91CC;&#x7684;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x4F20;&#x7ED9;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x5373;&#x53EF;&#xFF1A;&#xFF08;&#x4EE5; raw Node.js &#x4E3A;&#x4F8B;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Raw Node.js HTTP server</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">let globalTraceId // &#xF8FF;&#x5168;&#x5C40;&#x53D8;&#x91CF;</span><br><span class="line"></span><br><span class="line">// 0. &#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x6CD5;</span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  // &#x751F;&#x6210;&#x552F;&#x4E00; traceId&#xFF0C;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#xFF0C;&#x590D;&#x5199; globalTraceId &#x7684;&#x503C;</span><br><span class="line">  globalTraceId = generateTraceId()</span><br><span class="line"></span><br><span class="line">  // &#x68C0;&#x67E5;&#x7528;&#x6237;cookie&#x662F;&#x5426;&#x6709;&#x6548;</span><br><span class="line">  cookieValidator().then((res) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">    res.writeHead(200, { &apos;Content-Type&apos;: &apos;text/plain&apos; });</span><br><span class="line">    res.write(&apos;Congrats! Your damn cookie is the best one!&apos;);</span><br><span class="line">    res.end();</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x628A; traceId &#x8FDE;&#x540C; error &#x4E0A;&#x62A5;&#x7ED9;&#x5F02;&#x5E38;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;</span><br><span class="line">    reportError(err, globalTraceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 1. &#x521B;&#x5EFA; server </span><br><span class="line">const server = http.createServer((req, res) =&gt; {</span><br><span class="line">	handleRequest(req, res)</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// 2. &#x8BA9; server &#x548C; port:3000 &#x5EFA;&#x7ACB; socket &#x94FE;&#x63A5;&#xFF0C;&#x6301;&#x7EED;&#x63A5;&#x6536;&#x7AEF;&#x53E3;&#x4FE1;&#x606F;</span><br><span class="line">server.listen(3000, () =&gt; {</span><br><span class="line">  console.log(&apos;Server listening on port 3000&apos;);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x4F46;&#x662F;&#x5728; Node.js &#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF08;&#x4E3B;&#x7EBF;&#x7A0B;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF09;&#xFF0C;<code>globalTraceId</code>&#x8FD9;&#x6837;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5F02;&#x6B65;&#x6821;&#x9A8C; cookie &#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x56E0;&#x4E3A; main stack &#x5DF2;&#x7A7A;&#xFF0C;&#x6240;&#x4EE5;&#x4ECE;<code>backlog</code>&#x91CC;&#x9762;&#x8C03;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x5165;&#x4E3B;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x800C;<code>globalTraceId</code>&#x4F1A;&#x88AB;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x590D;&#x5199;&#xFF0C;&#x5BFC;&#x81F4;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x5728;&#x9519;&#x8BEF;&#x4E0A;&#x62A5;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x80FD;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684; id</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/76690e004be71e4ff5901390b5a94fd201f8c4fd85ed6d171e7e4be7e5007477" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"><a href="#&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;" class="headerlink" title="&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;"></a>&#x65B9;&#x6848;2&#xFF1A;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</h2><p>&#x90A3;&#x4E0A;&#x9762;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x6CD5;&#x786E;&#x5B9E;&#x4E0D;&#x5BF9;&#xFF0C;&#x90A3;&#x4F60;&#x4F1A;&#x60F3;&#xFF0C;&#x90A3;&#x6211;&#x628A;&#x751F;&#x6210;&#x7684; traceId &#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4E00;&#x6B65;&#x6B65;&#x900F;&#x4F20;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x540C;&#x4E00;&#x4E2A; traceId &#x7684;&#x6548;&#x679C;&#xFF0C;&#x597D;&#x50CF;&#x597D;&#x591A;&#x5E93;&#x548C;&#x6846;&#x67B6;&#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<p>&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">function handleRequest(req, res) {</span><br><span class="line">  const traceId = req.headers[&apos;x-trace-id&apos;] || generateTraceId();</span><br><span class="line">  // &#x628A; traceId &#x5199;&#x5165; req &#x8FD9;&#x4E2A; object&#xFF0C;&#x5C06;&#x53C2;&#x6570;&#x4E00;&#x8DEF;&#x5E26;&#x4E0B;&#x53BB;</span><br><span class="line">  req.traceId = traceId;</span><br><span class="line"></span><br><span class="line">  // &#x540C;&#x4E0A;</span><br><span class="line">  cookieValidator().then((result) =&gt; {</span><br><span class="line">    // &#x6821;&#x9A8C;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#x4ED6;&#x9700;&#x8981;&#x7684;&#x5185;&#x5BB9;</span><br><span class="line">  	// ...</span><br><span class="line">  }).catch((err) =&gt; {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">    reportError(err, req.traceId)</span><br><span class="line"></span><br><span class="line">    // &#x5199;&#x72B6;&#x6001;&#x7801;500&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function cookieValidator() {</span><br><span class="line">  return new Promise((resolve, reject) =&gt; {</span><br><span class="line">    setTimeout(() =&gt; {</span><br><span class="line">      // do someting</span><br><span class="line">      // ...</span><br><span class="line">    }, 1000);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// &#x6B64;&#x540E;&#x7701;&#x7565;&#x76D1;&#x542C;&#x7B49;&#x64CD;&#x4F5C;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x80FD;&#x591F;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x628A; traceId &#x901A;&#x8FC7; req &#x8FD9;&#x4E2A; object &#x4E00;&#x8DEF;&#x4F20;&#x4E0B;&#x53BB;&#x3002;&#x80FD;&#x4F20;&#x4E0B;&#x53BB;&#x7684;&#x539F;&#x56E0;&#x662F; node &#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684; context&#xFF08;&#x4E0A;&#x4E0B;&#x6587;&#xFF09;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x8C03;&#x7528;&#x6808;&#x3001;local variable&#x3001;referenced global variable &#x5B58;&#x4E0B;&#x6765;&#xFF0C;&#x4E00;&#x76F4;&#x5230;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x518D;&#x5728;&#x5B58;&#x4E0B;&#x6765;&#x7684; context &#x4E2D;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6240;&#x8C13;&#x7684;<code>&#x76F4;&#x63A5;&#x900F;&#x4F20;&#x53C2;&#x6570;</code>&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7; local variable &#x88AB;&#x5B58;&#x5230;&#x4E86; async function call context &#x91CC;&#x9762;&#x800C;&#x5B8C;&#x6210;&#x4E86;<code>traceId</code>&#x5728;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x91CC;&#x9762;&#x4E00;&#x8DEF;&#x4F20;&#x9012;&#x3002;</p>
<p><strong>&#x5E38;&#x89C1;&#x7684; Node &#x5E93;&#x5982;&#x4F55;&#x5904;&#x7406; traceId &#x7684;&#xFF1F;</strong></p>
<p>&#x7EC6;&#x5FC3;&#x7684;&#x4F60;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x5E38;&#x7528; express &#x6216;&#x8005; koa &#x8FD9;&#x6837;&#x7684;&#x5E93;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x5E72;&#x7684;&#x561B;&#x3002;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x4E3E;&#x51E0;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x5E93;&#x7684;&#x4F8B;&#x5B50;</p>
<p><strong>Express.js</strong></p>
<p><a href="/external_links/4ed5922eb818b953fc6e20d667e67b46.html" target="blank" rel="noopener">Express</a> &#x662F;&#x6700;&#x65E9;&#x6D41;&#x884C;&#x7684;Node server&#x5E93;&#xFF0C;&#x5230;&#x73B0;&#x5728;&#x4F9D;&#x7136;&#x5F88;&#x6D41;&#x884C;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x8DEF;&#x7531;&#x3001;&#x4E2D;&#x95F4;&#x4EF6;&#x7B49;&#x5404;&#x79CD;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x770B;&#x4E0B; Express &#x662F;&#x5982;&#x4F55;&#x4F20;&#x9012; TraceId &#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// Via express</span><br><span class="line">const express = require(&apos;express&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  req.traceId = traceId; // attach the trace ID to the request object</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x8BBE;&#x7F6E;&#x8DEF;&#x7531;</span><br><span class="line">app.get(&apos;/&apos;, async (req, res, next) =&gt; {</span><br><span class="line">  const traceId = req.traceId;</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    // call an asynchronous function and pass along the trace ID</span><br><span class="line">    const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">    // do something with the result</span><br><span class="line">    res.send(result);</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    next(error);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p><strong>Koa.js</strong></p>
<p><a href="/external_links/375bfd688767fe0bd21f1453cbb48a1c.html" target="blank" rel="noopener">Koa</a> &#x4E5F;&#x662F;&#x793E;&#x533A;&#x975E;&#x5E38;&#x6D41;&#x884C;&#x7684;&#x5E93;</p>
<p>Koa &#x65E9;&#x671F;&#x4F7F;&#x7528; <code>yield</code>&#x8BED;&#x6CD5;&#xFF0C;&#x540E;&#x671F;&#x652F;&#x6301;&#x4E86;<code>await</code>&#x8BED;&#x6CD5;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684; <code>egg.js</code>&#x662F;&#x57FA;&#x4E8E; Koa &#x5C01;&#x88C5;&#x7684;Node Server&#x6846;&#x67B6;&#x3002;&#x73B0;&#x5728;&#x6DD8;&#x5B9D;&#x7684;<code>midwayjs</code>&#x6700;&#x65E9;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;<code>egg.js</code>&#x505A;&#x7684;&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8F88;&#x5206;&#x5173;&#x7CFB;&#x68B3;&#x7406;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Koa &#x4E2D;&#x662F;&#x5982;&#x4F55;&#x900F;&#x4F20;&#x53C2;&#x6570;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const Koa = require(&apos;koa&apos;);</span><br><span class="line">const { v4: uuidv4 } = require(&apos;uuid&apos;);</span><br><span class="line">const { reportError } = require(&apos;./error-logging&apos;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;A</span><br><span class="line">app.use(async (ctx, next) =&gt; {</span><br><span class="line">  const traceId = uuidv4(); // generate a new UUID for the trace ID</span><br><span class="line">  ctx.state.traceId = traceId; // store the trace ID in the Koa context object</span><br><span class="line"></span><br><span class="line">  try {</span><br><span class="line">    await next();</span><br><span class="line">  } catch (error) {</span><br><span class="line">    // log the error and trace ID to the error logging system</span><br><span class="line">    reportError(error, { traceId });</span><br><span class="line">    throw error;</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x4E2D;&#x95F4;&#x4EF6;B&#xFF0C;&#x901A;&#x8FC7; ctx &#x900F;&#x4F20; traceId</span><br><span class="line">app.use(async (ctx) =&gt; {</span><br><span class="line">  const traceId = ctx.state.traceId;</span><br><span class="line"></span><br><span class="line">  // call an asynchronous function and pass along the trace ID</span><br><span class="line">  const result = await someAsyncFunction(traceId);</span><br><span class="line"></span><br><span class="line">  // do something with the result</span><br><span class="line">  ctx.body = result;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// &#x76D1;&#x542C;&#x7AEF;&#x53E3;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x51E0;&#x4E4E;&#x548C; express &#x4E00;&#x6837;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x628A; tracId &#x5B58;&#x5230;&#x4E00;&#x8DEF;&#x900F;&#x4F20;&#x7684; ctx &#x53D8;&#x91CF;&#x91CC;&#x9762;&#x5B9E;&#x73B0;&#x53C2;&#x6570;&#x7684;&#x900F;&#x4F20;&#x3002;</p>
<p><strong>Nest.js</strong></p>
<p><a href="/external_links/12ea646682d52a51d59a7d141b2bc347.html" target="blank" rel="noopener">Nest</a> (NestJS) &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x9AD8;&#x6548;&#x3001;&#x53EF;&#x6269;&#x5C55;&#x7684; Node.js &#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5F00;&#x53D1;&#x6846;&#x67B6;&#x3002;&#x5B83;&#x5229;&#x7528; JavaScript &#x7684;&#x6E10;&#x8FDB;&#x589E;&#x5F3A;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F7F;&#x7528;&#x5E76;&#x5B8C;&#x5168;&#x652F;&#x6301; TypeScript &#xFF08;&#x4ECD;&#x7136;&#x5141;&#x8BB8;&#x5F00;&#x53D1;&#x8005;&#x4F7F;&#x7528;&#x7EAF; JavaScript &#x8FDB;&#x884C;&#x5F00;&#x53D1;&#xFF09;&#xFF0C;&#x5E76;&#x7ED3;&#x5408;&#x4E86; OOP &#xFF08;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#xFF09;&#x3001;FP &#xFF08;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x548C; FRP &#xFF08;&#x51FD;&#x6570;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#xFF09;&#x3002;</p>
<p>&#x603B;&#x7ED3;&#x6765;&#x8BF4; Nest &#x7684;&#x7279;&#x70B9;&#x662F;&#xFF0C;&#x5B8C;&#x7F8E;&#x652F;&#x6301;ts&#x3001;&#x62E5;&#x62B1;&#x88C5;&#x9970;&#x5668;&#x548C;&#x6CE8;&#x89E3;&#xFF0C;&#x540C;&#x65F6;&#x901A;&#x8FC7;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#xFF08;DI&#xFF09;&#x548C;&#x6A21;&#x5757;&#x5316;&#x601D;&#x60F3;&#x7B49;&#xFF0C;&#x4F7F;&#x4EE3;&#x7801;&#x7ED3;&#x6784;&#x5DE5;&#x6574;&#xFF0C;&#x6613;&#x4E8E;&#x9605;&#x8BFB;&#x3002;&#x66F4;&#x591A;&#x4ECB;&#x7ECD;&#x53EF;&#x4EE5;&#x770B;&#x5B98;&#x7F51;&#x3002;</p>
<p>&#x5728;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x4E0A;&#xFF0C;Nest &#x662F;&#x63A8;&#x8350;&#x5982;&#x4F55;&#x4F7F;&#x7528; Async Local Storage &#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x89C1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<p><a href="/external_links/feb8be566d78178e7a3d1f7852caa0bd.html" target="blank" rel="noopener">docs.nestjs.com/recipes/asy&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// &#x4F7F;&#x7528; nestjs-cls&#x8FD9;&#x4E2A;&#x5E93;</span><br><span class="line">// npm i nestjs-cls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x6A21;&#x5757;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7533;&#x660E; Cls Module</span><br><span class="line">@Module({</span><br><span class="line">  imports: [</span><br><span class="line">    // Register the ClsModule,</span><br><span class="line">    ClsModule.forRoot({</span><br><span class="line">      middleware: {</span><br><span class="line">        // automatically mount the</span><br><span class="line">        // ClsMiddleware for all routes</span><br><span class="line">        mount: true,</span><br><span class="line">        // and use the setup method to</span><br><span class="line">        // provide default store values.</span><br><span class="line">        setup: (cls, req) =&gt; {</span><br><span class="line">          // &#x901A;&#x8FC7;CLS&#x5B58;&#x50A8; traceId</span><br><span class="line">          cls.set(&apos;traceId&apos;, req.headers[&apos;x-trace-id&apos;] || generateTraceId()); </span><br><span class="line">        },</span><br><span class="line">      },</span><br><span class="line">    }),</span><br><span class="line">  ],</span><br><span class="line">  providers: [CatService],</span><br><span class="line">  controllers: [CatController],</span><br><span class="line">})</span><br><span class="line">export class AppModule {}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// &#x5728; Service &#x4E2D;&#x6CE8;&#x518C; Cls&#xFF0C;&#x5E76;&#x4E14;&#x76F4;&#x63A5;&#x8C03;&#x7528;</span><br><span class="line">@Injectable()</span><br><span class="line">export class CatService {</span><br><span class="line">  constructor(</span><br><span class="line">    // We can inject the provided ClsService instance,</span><br><span class="line">    private readonly cls: ClsService,</span><br><span class="line">    private readonly catRepository: CatRepository,</span><br><span class="line">  ) {}</span><br><span class="line"></span><br><span class="line">  getCatForUser() {</span><br><span class="line">    // and use the &quot;get&quot; method to retrieve any stored value.</span><br><span class="line">    const userId = this.cls.get(&apos;traceId&apos;); // &#x83B7;&#x5F97; traceId</span><br><span class="line">    return this.catRepository.getForUser(userId);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Nest &#x548C;&#x4E0A;&#x9762;&#x7684;&#x5E93;&#x8089;&#x773C;&#x4E0A;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x662F;&#x91C7;&#x7528;&#x4E86;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#xFF0C;&#x540C;&#x65F6;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x88C5;&#x9970;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x5982;&#x679C;&#x5BF9;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x6709;&#x5174;&#x8DA3;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5B8C;&#x6210;&#x4E86;IOC&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>
<p><a href="/external_links/70d2f105f034cda3227e2404a8261f1f.html" target="blank" rel="noopener">zhuanlan.zhihu.com/p/311184005</a></p>
<p>OK&#xFF0C;&#x90A3;&#x4E48; <code>nestjs-cls</code>&#x8FD9;&#x4E2A;&#x5E93;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x8FD9;&#x4E2A;&#x5305;&#x7684;&#x63CF;&#x8FF0;</p>
<p>The <a href="/external_links/a0093739fc6f0cfaa52e7579861105d8.html" target="blank" rel="noopener">nestjs-cls</a> package provides several DX improvements over using plain <strong>AsyncLocalStorage</strong> (<strong>CLS</strong> is an abbreviation of the term continuation-local storage).</p>
<p>DX &#x662F; Developer Experience &#x5373;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x5E93;&#x662F;&#x7528;&#x4E8E;&#x63D0;&#x5347;&#x5F00;&#x53D1;&#x8005;&#x4F53;&#x9A8C;&#x7684;&#x57FA;&#x4E8E;&#x539F;&#x751F;<code>AsyncLocalStorage</code>&#x7684;&#x5305;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x4E0B;&#x9762;&#x7EC8;&#x4E8E;&#x4ECB;&#x7ECD;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x7684;&#x4E3B;&#x89D2;<code>AsyncLocalStorage</code>&#xFF01;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/474a62136aef30b6aa5a113fa6f0fb7870b2959bb58557a6cabb0b622807356a" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<h2 id="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"><a href="#&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage" class="headerlink" title="&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;AsyncLocalStorage"></a>&#x65B9;&#x6848;3&#xFF1A;&#x4ECA;&#x5929;&#x7684;&#x89D2;&#xFF0C;<code>AsyncLocalStorage</code></h2><p>AsyncLocalStorage &#x662F; Nodejs &#x7684; API&#xFF08;&#x5927;&#x7EA6;&#x5728;2019&#x5E74;&#x63A8;&#x51FA;&#xFF0C;2020&#x5E74;&#x8FDB;&#x5165;&#x7A33;&#x5B9A;&#x7248;&#x672C;&#xFF09;</p>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F; Node.js &#x89C9;&#x5F97;&#x5927;&#x5BB6;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x4E0D;&#x591F;&#x4F18;&#x96C5;&#xFF0C;&#x54E5;&#x76F4;&#x63A5;&#x5728;<code>C++</code>&#x7684;&#x5C42;&#x9762;&#x7ED9;&#x4F60;&#x4EEC;&#x505A;&#x6389;&#x8FD9;&#x4E2A;&#x4E8B;&#xFF0C;&#x7136;&#x540E;&#x63D0;&#x4F9B;&#x4E2A;API&#x7ED9;&#x5927;&#x4F19;&#x7528;&#xFF0C;&#x600E;&#x4E48;&#x6837;&#xFF1F;&#x55EF;&#x5927;&#x6982;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x3002;</p>
<p>&#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x8BF4;&#x4E86;&#xFF0C;&#x8FD9;&#x662F;&#x5B98;&#x65B9;&#x7684;API&#xFF0C;&#x81EA;&#x7136;&#x6709;&#x5B98;&#x65B9;&#x7684;&#x6587;&#x6863;&#x6765;&#x63CF;&#x8FF0;</p>
<p>&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF1A;</p>
<blockquote>
<p>This class creates stores that stay coherent through asynchronous operations.</p>
<p>While you can create your own implementation on top of the node:async_hooks module, AsyncLocalStorage should be preferred as it is a performant and memory safe implementation that involves significant optimizations that are non-obvious to implement.</p>
<p>The following example uses AsyncLocalStorage to build a simple logger that assigns IDs to incoming HTTP requests and includes them in messages logged within each request.</p>
</blockquote>
<p>&#x6587;&#x6863;&#x5730;&#x5740;&#xFF1A;<a href="/external_links/8b7ffbb550a0eb20f988772d3dcd2f09.html" target="blank" rel="noopener">nodejs.org/api/async_c&#x2026;</a></p>
<p>&#x4E2D;&#x6587;&#x89E3;&#x91CA;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#xFF1A;<code>AsyncLocalStorage</code>&#x662F;&#x57FA;&#x4E8E;<code>node:async_hooks</code>&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#xFF08;&#x6BD4;&#x4E4B;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#xFF09;&#x662F;&#x6027;&#x80FD;&#x597D;&#x3001;&#x5185;&#x5B58;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x5B58;&#x50A8;&#x7528;&#x4E8E;<code>log</code>&#x7684;&#x4FE1;&#x606F;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E2A;&#x4F8B;&#x5B50; <code>AsyncLocalStorage</code>&#x662F;&#x600E;&#x4E48;&#x4F7F;&#x7528;&#x7684;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;// How to use AsyncLocalStorage in Node.js</span><br><span class="line">import http from &apos;node:http&apos;;</span><br><span class="line">import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">function logWithId(msg) {</span><br><span class="line">  const traceId = asyncLocalStorage.getStore();</span><br><span class="line">  console.log(`${traceId}:`, msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">http.createServer((req, res) =&gt; {</span><br><span class="line">  // &#xF8FF;&#x5173;&#x952E;&#x7684;API&#x8C03;&#x7528;&#xF8FF;</span><br><span class="line">  asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">    logWithId(&apos;start&apos;);</span><br><span class="line">    // Imagine any chain of async operations here</span><br><span class="line">    setImmediate(() =&gt; {</span><br><span class="line">      logWithId(&apos;finish&apos;);</span><br><span class="line">      res.end();</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}).listen(8080);</span><br><span class="line"></span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">http.get(&apos;http://localhost:8080&apos;);</span><br><span class="line">// Prints:</span><br><span class="line">//   0: start</span><br><span class="line">//   1: start</span><br><span class="line">//   0: finish</span><br><span class="line">//   1: finish</span><br></pre></td></tr></table></figure>

<p>&#x4E0B;&#x9762;&#x662F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x89E3;&#x91CA;&#xFF1A;</p>
<p>&#x4E0A;&#x9762;&#x5C55;&#x793A;&#x4E86;2&#x4E2A;&#x8BF7;&#x6C42;&#x88AB;&#x6253;&#x5230;<code>port:8080</code>&#xFF0C;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x88AB;&#x653E;&#x5728;&#x4E86;<code>asyncLocalStorage.run</code>&#x8FD9;&#x4E2A;API&#x91CC;&#x9762;&#x3002;<code>setImmediate</code>&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7;<code>logWithId</code>&#x53D6;&#x51FA;&#x8BE5;&#x8BF7;&#x6C42;&#x5728;&#x8FDB;&#x5165;&#x65F6;&#x88AB;&#x8D4B;&#x4E88;&#x7684;<code>id</code>&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5373;&#x4F7F;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;id(&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;idSeq=0&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x65F6;idSeq=1)&#x5DF2;&#x7ECF;&#x88AB;log&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x662F; line 8 &#x7684; &#x540C;&#x4E00;&#x4E2A; <code>asyncLocalStorage</code>&#x5374;&#x80FD;<code>getStore</code>&#x51FA;&#x5BF9;&#x5E94;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x4E0D;&#x540C;id&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6B64;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x65B9;&#x5F0F;&#x5B58;&#x50A8;<code>id</code>&#x4F18;&#x96C5;&#x5F97;&#x591A;&#xFF08;&#x53E6;&#x5916;&#xFF0C;&#x901A;&#x8FC7;<code>asyncLocalStorage</code>&#x8FD9;&#x6837;&#x9690;&#x5F0F;&#x4F20;&#x9012;&#x53C2;&#x6570;&#x6709;&#x70B9;&#x50CF;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; State Monad &#x5E2E;&#x52A9;&#x5F00;&#x53D1;&#x8005;&#x9690;&#x5F0F;&#x7BA1;&#x7406;&#x53C2;&#x6570;&#x4F20;&#x9012;&#xFF09;</p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x8BB2;&#x5230;&#x8FD9;&#xFF0C;&#x6211;&#x4EEC;<code>Takeaway</code>&#x4E2D;&#x7684;1&#x5DF2;&#x7ECF;&#x88AB;&#x89E3;&#x51B3;&#x4E86;</p>
<ul>
<li>&#x4EC0;&#x4E48;&#x662F; AsyncLocalStorage &#xFF1F;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5B83;&#xFF1F;</li>
</ul>
<p>&#x5982;&#x679C;&#x8BA4;&#x771F;&#x770B;&#x5B8C;&#xFF0C;&#x76F8;&#x4FE1;&#x4F60;&#x5BF9;&#x5B83;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x4E2A;&#x611F;&#x6027;&#x7684;&#x8BA4;&#x8BC6;&#x3002;&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6807;&#x9898;&#x7684;&#x540E;&#x4E00;&#x53E5;&#x8BDD;&#xFF0C;<code>AsyncLocalStorage</code>&#x7684;<code>&#x524D;&#x4E16;&#x4ECA;&#x751F;</code></p>
<h1 id="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage"><a href="#&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728;-Node-js-14-&#x4E4B;&#x524D;&#x7684;-Async-Local-Storage" class="headerlink" title="&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage"></a>&#x4E09;&#x3001;&#x5386;&#x53F2;&#x5408;&#x8BA2;&#xFF1A;&#x5728; Node.js 14 &#x4E4B;&#x524D;&#x7684; Async Local Storage</h1><blockquote>
<p>&#x5FD8;&#x8BB0;&#x5386;&#x53F2;&#x5C31;&#x610F;&#x5473;&#x7740;&#x80CC;&#x53DB;&#xFF08;&#x72D7;&#x5934;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x5386;&#x53F2;&#x7684;&#x5408;&#x8BA2;&#x672C;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x5927;&#x5BB6;&#x90FD;&#x6709;&#x53C2;&#x6570;&#x5F02;&#x6B65;&#x4F20;&#x9012;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x6240;&#x4EE5;&#x7B49;19&#x5E74;AsyncLocalStorage&#x88AB;&#x63A8;&#x51FA;&#x4E4B;&#x524D;&#x4E00;&#x5B9A;&#x6709;&#x793E;&#x533A;&#x65B9;&#x6848;&#x88AB;&#x5927;&#x5BB6;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5728; Node.js 14&#x53D1;&#x5E03;&#x4E4B;&#x524D;&#xFF0C;&#x793E;&#x533A;&#x662F;&#x5982;&#x4F55;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x7EBF;&#x6765;&#x68B3;&#x7406;&#x6B64;&#x4E8B;&#xFF0C;&#x90A3;&#x8981;&#x4ECE;2013&#x5E74;&#x7684;&#x6625;&#x5929;&#x8BF4;&#x8D77;</p>
<h2 id="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;"><a href="#2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1-1k-Star&#xFF09;" class="headerlink" title="2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;"></a>2013&#x5E74;&#xFF1A;CLS&#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#xFF08;1.1k Star&#xFF09;</h2><p>2013&#x5E74;4&#x6708;30&#x53F7;&#xFF0C;<a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">node-continuation-local-storage</a> &#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x63D0;&#x4EA4;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A; <code>commit</code>&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#xFF0C;&#x793E;&#x533A;&#x66F4;&#x591A;&#x5730;&#x79F0;&#x5B83;&#x4E3A;<code>CLS</code>(Continuation-Local Storage&#xFF0C;&#x4E4B;&#x540E;&#x7B80;&#x79F0;&#x4E3A;CLS)&#x3002;&#x6211;&#x622A;&#x53D6;&#x4E86;&#x8FD9;&#x4E2A;10&#x5C81;&#x7684;&#x4ED3;&#x5E93;README&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x6BB5;&#x7ED9;&#x5927;&#x5BB6;</p>
<blockquote>
<p>Continuation-local storage works like thread-local storage in threaded programming, but is based on chains of Node-style callbacks instead of threads. The standard Node convention of functions calling functions is very similar to something called <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> in functional programming, and the name comes from the way this module allows you to set and get values that are scoped to the lifetime of these chains of function calls.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x8BDD;&#x53EF;&#x4EE5;&#x63D0;&#x53D6;&#x51FA;&#x51E0;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<ol>
<li>CLS &#x50CF;&#x591A;&#x7EBF;&#x7A0B;&#x7F16;&#x7A0B;&#x4E2D;&#x7684;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x7684; storage&#xFF08;TLS: thread local storage&#xFF09;&#x4E00;&#x6837;&#x5DE5;&#x4F5C;&#xFF0C;&#x53EA;&#x662F;&#x539F;&#x7406;&#x662F;&#x57FA;&#x4E8E; callback function &#x800C;&#x4E0D;&#x662F;&#x7EBF;&#x7A0B;</li>
<li>&#x53D6;&#x540D;&#x4E2D;&#x6709; Continuation &#x4EE3;&#x8868; C&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x51FD;&#x6570;&#x7F16;&#x7A0B;&#x4E2D;&#x7684; <a href="/external_links/ef2e8ecb21259ae3379791daab5f566a.html" target="blank" rel="noopener">&#x201C;continuation-passing style&#x201D;</a> &#x6982;&#x5FF5;&#xFF0C;&#x65E8;&#x5728;&#x94FE;&#x5F0F;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E2D;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x6301;&#x4E45;&#x7684;&#x6570;&#x636E;</li>
<li>&#x4F60;<code>set</code>&#x548C;<code>get</code>&#x7684;&#x503C;&#xFF0C;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5F02;&#x6B65;&#x7684;function&#x7684;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x8C03;&#x7528;&#x94FE;&#x5185;&#x7684;</li>
</ol>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x4E0B;&#x9762;&#x662F; github &#x4E0A;&#x8BE5;&#x4ED3;&#x5E93;&#x7684;&#x793A;&#x4F8B;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const cls = require(&apos;continuation-local-storage&apos;); // require(&apos;cls-hooked&apos;) &#x4E5F;&#x884C;&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;</span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">// Create a new namespace for the traceId</span><br><span class="line">const traceNamespace = cls.createNamespace(&apos;trace&apos;);</span><br><span class="line"></span><br><span class="line">// Middleware to set the traceId for each request</span><br><span class="line">app.use((req, res, next) =&gt; {</span><br><span class="line">  traceNamespace.run(() =&gt; {</span><br><span class="line">    // Generate a new traceId if one doesn&apos;t exist</span><br><span class="line">    traceNamespace.set(&apos;traceId&apos;, generateTraceId());</span><br><span class="line">    next();</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// Route to get the traceId for the current request</span><br><span class="line">app.get(&apos;/traceId&apos;, async (req, res) =&gt; {</span><br><span class="line">  try {</span><br><span class="line">    const cookie = await cookieValidator()</span><br><span class="line">    // &#x6821;&#x9A8C;&#x662F;&#x5426;&#x6210;&#x529F;&#x7B49;</span><br><span class="line">    // ...</span><br><span class="line">  } catch(e) {</span><br><span class="line">    // &#xF8FF; &#x4E0A;&#x62A5; traceId</span><br><span class="line">  	const traceId = traceNamespace.get(&apos;traceId&apos;);</span><br><span class="line">    reportError(err, traceId)</span><br><span class="line">  }</span><br><span class="line">  res.send(`Trace ID: ${traceId}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x6BCF;&#x6B21;&#x6267;&#x884C; <code>namespace.run(callback)</code> &#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x8BED;&#x6CD5;&#x4E0A;&#xFF0C;&#x901A;&#x8FC7; run &#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x4F4F;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x56DE;&#x8C03;&#x5185;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x6211;&#x4EEC;&#x7684; <code>Continuation-Local Storage</code>&#x3002;&#x8FD9;&#x4E2A;<code>xxx.run(callbakc, ...)</code>&#x7684;&#x8BED;&#x6CD5;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x4F1A;&#x591A;&#x6B21;&#x770B;&#x5230;&#x3002;</p>
<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>CLS &#x901A;&#x8FC7; <code>process.addAsyncListener</code> &#x8FD9;&#x4E2A; API &#x76D1;&#x542C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x3002;&#x5728;&#x521B;&#x5EFA;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#x5C06;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x5165;&#xFF0C;&#x6267;&#x884C;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x65F6;&#xFF0C;&#x4F20;&#x5165;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x6267;&#x884C;&#x7ED3;&#x675F;&#x9500;&#x6BC1;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x800C;<code>process.addAsyncListener</code>&#x662F; <a href="/external_links/579311e71bce05526dda23c9eec7c845.html" target="blank" rel="noopener">Node v0.11 &#x7248;&#x672C;&#x7684; API</a>&#xFF0C;&#x76EE;&#x524D;&#x4ED3;&#x5E93;&#x5F15;&#x7528;&#x7684;&#x662F; polyfill &#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4ECE;&#x4E0B;&#x9762;&#x622A;&#x56FE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x8FD9;&#x662F;&#x6BB5; polyfill &#x7684;&#x4EE3;&#x7801;&#x662F;2013&#x5E74;9&#x6708;2&#x53F7;&#x88AB;&#x63D0;&#x4EA4;&#x7684;&#xFF0C;&#x662F;&#x76F8;&#x5F53;&#x53E4;&#x65E9;&#x7684;&#x4E8B;&#x60C5;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// load polyfill if native support is unavailable</span><br><span class="line">if (!process.addAsyncListener) require(&apos;async-listener&apos;);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/d502057cb6d6c203cbee7f6d8b8418543828a268e169049b8144de25a6b1d788" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x901A;&#x8FC7; async call &#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x5199;&#x51FA;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x4E2D;&#x7684;&#x9700;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x53D8;&#x91CF;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6765;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF1B;&#x540C;&#x65F6;&#x5728;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x91CC;&#x9762;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x901A;&#x8FC7;&#x6B64;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5B8C;&#x6210;&#x4E86;<code>nest</code>&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5373;&#x5D4C;&#x5957;&#x8C03;&#x7528;&#xFF0C;run&#x91CC;&#x9762;&#x5728;&#x5D4C;&#x5165;&#x4E00;&#x4E2A;run&#x3002;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x975E;&#x5E38;&#x9002;&#x5408;&#x505A;&#x8C03;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x56E0;&#x4E3A; main call stack &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6808; : &#xFF09;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5177;&#x4F53;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF1A;<a href="/external_links/7113efbf78025131b4cfb56c78bc528d.html" target="blank" rel="noopener">github.com/othiym23/no&#x2026;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lua&#x590D;&#x5236;&#x4EE3;&#x7801;// createNamespace &#x5C31;&#x662F;&#x8C03;&#x7528;&#x5185;&#x90E8;&#x7684; create &#x65B9;&#x6CD5;</span><br><span class="line">function create(name) {</span><br><span class="line">  assert.ok(name, &quot;namespace must be given a name!&quot;);</span><br><span class="line"></span><br><span class="line">  var namespace = new Namespace(name); // &#x65B0;&#x5EFA; space</span><br><span class="line">  namespace.id = process.addAsyncListener({</span><br><span class="line">    create : function () { return namespace.active; },</span><br><span class="line">    before : function (context, storage) { if (storage) namespace.enter(storage); },</span><br><span class="line">    after  : function (context, storage) { if (storage) namespace.exit(storage); },</span><br><span class="line">    error  : function (storage) { if (storage) namespace.exit(storage); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  process.namespaces[name] = namespace;</span><br><span class="line">  return namespace;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;<code>create</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A; Namespace &#x6765;&#x7BA1;&#x7406;&#x6240;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64; name &#x4F1A;&#x5728;&#x539F;&#x751F;API&#x4E0A;&#x76D1;&#x542C;&#x5404;&#x79CD;&#x4E8B;&#x4EF6;&#xFF0C;&#x540C;&#x65F6;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x7684; store &#x53D8;&#x5316;&#x3002;&#x5176;&#x4E2D;<code>namespace.enter(storage)</code>&#x8868;&#x793A;&#x5C06;&#x6B64;&#x65F6;&#x7684; ctx &#x5165;&#x6808;&#xFF0C;&#x5728;async call before&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#xFF0C;&#x5373;&#x5B8C;&#x6210;&#x5F02;&#x6B65;&#x65F6;&#x95F4;&#x540E;&#x3001;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#x3002;&#x800C;&#x5728;async call after&#x65F6;&#xFF0C;&#x5219;&#x662F;&#x8C03;&#x7528;&#x51FA;&#x6808;&#x65B9;&#x6CD5; <code>namespace.exit(storage)</code>&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570; storage&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728; store &#x4E2D;&#x5B58;&#x5165;&#x7684; traceId</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// cls&#x7684;&#x5B9E;&#x73B0;</span><br><span class="line"></span><br><span class="line">// &#x8FD9;&#x662F; store &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684; class</span><br><span class="line">function Namespace(name) {</span><br><span class="line">  this.name   = name;</span><br><span class="line">  // changed in 2.7: no default context</span><br><span class="line">  this.active = null;</span><br><span class="line">  this._set   = [];</span><br><span class="line">  this.id     = null;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// run&#x65B9;&#x6CD5;</span><br><span class="line">Namespace.prototype.run = function (fn) {</span><br><span class="line">  var context = this.createContext();</span><br><span class="line">  this.enter(context);</span><br><span class="line">  try {</span><br><span class="line">    fn(context);</span><br><span class="line">    return context;</span><br><span class="line">  }</span><br><span class="line">  catch (exception) {</span><br><span class="line">    if (exception) {</span><br><span class="line">      exception[ERROR_SYMBOL] = context;</span><br><span class="line">    }</span><br><span class="line">    throw exception;</span><br><span class="line">  }</span><br><span class="line">  finally {</span><br><span class="line">    this.exit(context);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// &#x5F53;&#x524D;&#x7684; active &#x5165;&#x6808;&#xFF0C;&#x628A;&#x65B0;&#x7684; ctx &#x5F53;&#x505A; this.active</span><br><span class="line">Namespace.prototype.enter = function (context) {</span><br><span class="line">  assert.ok(context, &quot;context must be provided for entering&quot;);</span><br><span class="line"></span><br><span class="line">  this._set.push(this.active);</span><br><span class="line">  this.active = context;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x4E0A;&#x9762;&#x7684; <code>this._set</code>&#x5C31;&#x662F;&#x521A;&#x624D;&#x8BF4;&#x7684;&#x88AB;&#x7EF4;&#x62A4;&#x7684;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x6BCF;&#x4E00;&#x6B21; run &#x7684;&#x8C03;&#x7528;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; context &#x4F5C;&#x4E3A; this.active&#xFF0C;&#x540C;&#x65F6;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;&#x7684; context&#xFF08;this.active&#xFF09;&#x7ED9; push &#x8FDB;&#x5165; this._set &#x8FD9;&#x4E2A;&#x6808;&#xFF0C;&#x7B49;&#x5F85;&#x540E;&#x7EED;&#x88AB;pop&#x540E;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540E;&#x6765;&#x4ECB;&#x7ECD;&#x7684;<code>cls-hooked</code>&#x903B;&#x8F91;&#x548C;&#x4ED6;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x73B0;&#x66F4;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x628A;&#x4ED6;&#x628A;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5B58;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>new map()</code>&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;<code>&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x4E3A;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#x751F;&#x6210;&#x7684;asyncId</code> &#x4F5C;&#x4E3A; key &#x6765;&#x533A;&#x5206;&#x3002;&#x4E0D;&#x8FC7;&#x4E3A;&#x4E86;&#x5D4C;&#x5957;&#x80FD;&#x529B;&#xFF0C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x4F9D;&#x65E7;&#x4FDD;&#x7559;&#x3002;</p>
<p>&#x867D;&#x7136;&#x8FD9;&#x4E2A;&#x4ED3;&#x5E93;&#x5DF2;&#x7ECF;&#x5728;&#x201D;&#x5386;&#x53F2;&#x7684;&#x5783;&#x573E;&#x5806;&#x201D;&#x91CC;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x91CC;&#x9762; API &#x7684;&#x8BBE;&#x8BA1;&#x548C;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x7684;&#x8FD8;&#x662F;&#x503C;&#x5F97;&#x4E00;&#x770B;&#xFF0C;&#x56E0;&#x4E3A;&#x4E4B;&#x540E;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x6CBF;&#x7528;&#x7684;&#x7C7B;&#x4F3C;&#x7684;&#x8BBE;&#x8BA1;&#x3002;</p>
<p>&#x90A3;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x770B;&#x4E0B;&#x4E00;&#x4E2A;API&#x7684;&#x53D1;&#x5E03;</p>
<h2 id="2017&#x5E74;&#xFF1A;async-hooks"><a href="#2017&#x5E74;&#xFF1A;async-hooks" class="headerlink" title="2017&#x5E74;&#xFF1A;async_hooks"></a>2017&#x5E74;&#xFF1A;async_hooks</h2><blockquote>
<p><code>async_hooks</code>&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x4E09;&#x65B9;&#x5E93;&#xFF0C;&#x800C;&#x662F;&#x4E00;&#x4E2A;Node build-in&#x7684;module&#xFF0C;&#x4F9B;&#x7528;&#x6237;&#x8C03;&#x7528;&#x3002;</p>
</blockquote>
<p>The async_hooks API was released in Node.js 8.x in 2017</p>
<p><strong>&#x5982;&#x4F55;&#x4F7F;&#x7528;</strong></p>
<p>&#x901A;&#x8FC7; hook &#x53EF;&#x4EE5;&#x5F80; async call &#x7684;&#x5404;&#x4E2A;&#x9636;&#x6BB5;&#x6CE8;&#x518C;&#x65B9;&#x6CD5;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;&#x6211;&#x4EEC;&#x719F;&#x6089;&#x7684;React&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x90FD;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x72EC;&#x4E00;&#x65E0;&#x4E8C;&#x7684;<code>asyncId</code>&#xFF0C;&#x6240;&#x4EE5;&#x57FA;&#x4E8E;&#x6B64;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6211;&#x4EEC;&#x7684;&#x5F02;&#x6B65;&#x76D1;&#x542C;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">javascript&#x590D;&#x5236;&#x4EE3;&#x7801;const asyncHooks = require(&apos;async-hooks&apos;)</span><br><span class="line">const asyncHook = asyncHooks.createHook({</span><br><span class="line">  init: (asyncId, type, triggerAsyncId, resource) =&gt; {},</span><br><span class="line">  before: asyncId =&gt; {},</span><br><span class="line">  after: asyncId =&gt; {},</span><br><span class="line">  destroy: asyncId =&gt; {},</span><br><span class="line">  promiseResolve: asyncId =&gt; {},</span><br><span class="line">})</span><br><span class="line">asyncHook.enable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// init() is called during object construction. The resource may not have</span><br><span class="line">// completed construction when this callback runs. Therefore, all fields of the</span><br><span class="line">// resource referenced by &quot;asyncId&quot; may not have been populated.</span><br><span class="line">function init(asyncId, type, triggerAsyncId, resource) { }</span><br><span class="line"></span><br><span class="line">// before() is called just before the resource&apos;s callback is called. It can be</span><br><span class="line">// called 0-N times for handles (such as TCPWrap), and will be called exactly 1</span><br><span class="line">// time for requests (such as FSReqCallback).</span><br><span class="line">function before(asyncId) { }</span><br><span class="line"></span><br><span class="line">// after() is called just after the resource&apos;s callback has finished.</span><br><span class="line">function after(asyncId) { }</span><br><span class="line"></span><br><span class="line">// destroy() is called when the resource is destroyed.</span><br><span class="line">function destroy(asyncId) { }</span><br></pre></td></tr></table></figure>

<p><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;</strong></p>
<p>&#x5177;&#x4F53;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x6700;&#x540E;&#x7684;&#x5EF6;&#x5C55;&#x7AE0;&#x8282;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x4E86;</p>
<h2 id="2017&#x5E74;&#xFF1A;cls-hooked"><a href="#2017&#x5E74;&#xFF1A;cls-hooked" class="headerlink" title="2017&#x5E74;&#xFF1A;cls-hooked"></a>2017&#x5E74;&#xFF1A;cls-hooked</h2><p>&#x5728;2017&#x5E74;&#xFF0C;async_hooks&#x53D1;&#x5E03;&#x540E;&#xFF0C;Jeff Lewis &#x8FD9;&#x4F4D;&#x8001;&#x5144;&#x9A6C;&#x4E0D;&#x505C;&#x8E44;&#x5730;&#x5C06;&#x8001;&#x4ED3;&#x5E93;fork&#x51FA;&#x6765;&#xFF0C;&#x91CD;&#x65B0;&#x7528;&#x6700;&#x65B0;&#x7684; async_hooks &#x91CD;&#x5199;&#x4E86; CLS&#x3002;&#x7531;&#x4E8E;&#x91CD;&#x5199;&#x540E; API &#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53D8;&#x5316;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x5217;&#x4E3E;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E86;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4ED6;&#x7684; <code>README</code></p>
<blockquote>
<p>This is a fork of <a href="/external_links/1f65ef65169b268c4cb13dca41f2f78b.html" target="blank" rel="noopener">CLS</a> using <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> OR <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> instead of <a href="/external_links/688d0de2171d760751ff9c148c702be3.html" target="blank" rel="noopener">async-listener</a>.</p>
<p>When running Nodejs version &lt; 8, this module uses <a href="/external_links/3eb6c58480ad019be74c96516de5dcd5.html" target="blank" rel="noopener">AsyncWrap</a> which is an unsupported Nodejs API, so please consider the risk before using it.</p>
<p>When running Nodejs version &gt;= 8.2.1, this module uses the newer <a href="/external_links/da7c1a322211e532aa949ea674d9d412.html" target="blank" rel="noopener">async_hooks</a> API which is considered <strong>Experimental</strong> by Nodejs.</p>
</blockquote>
<p>&#x4ECE;&#x4ED6;&#x7684; <code>README</code> &#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;Node&#x7248;&#x672C;&#x5C0F;&#x4E8E;8&#x7684;&#xFF0C;&#x4F7F;&#x7528;&#x4E86; AsyncWrap&#xFF0C;&#x800C;Node&#x7248;&#x672C;&#x5927;&#x4E8E;8.2.1&#x7684;&#x5219;&#x7528;async_hooks&#x91CD;&#x5199;&#x4E86;&#x3002;</p>
<p>&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x4ED6;&#x7528; <code>Experimental</code>&#x6765;&#x63CF;&#x8FF0;&#x6B64;API&#xFF0C;&#x81EA;&#x7136;&#x800C;&#x7136;&#x6211;&#x4EEC;&#x5230; Nodejs &#x7684;&#x5B98;&#x7F51;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E0D;&#x518D;&#x88AB;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x3002;&#x539F;&#x56E0;&#x662F;&#x53EF;&#x7528;&#x6027;&#x3001;&#x5B89;&#x5168;&#x6027;&#x3001;&#x4EE5;&#x53CA;&#x6027;&#x80FD;&#x8868;&#x73B0;&#x90FD;&#x6709;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x4F60;&#x60F3;&#x4F7F;&#x7528; Async Context Tracking &#x7684;&#x80FD;&#x529B;&#xFF0C;&#x53D6;&#x800C;&#x4EE3;&#x4E4B;&#x7684;&#x5E94;&#x8BE5;&#x662F; <code>AsyncLocalStorage</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x56E0;&#x4E3A;&#x662F; ALS &#x505A;&#x4E86;&#x9002;&#x5F53;&#x7684;&#x4F18;&#x5316;&#x5E76;&#x4E14;&#x8BED;&#x6CD5;&#x66F4;&#x7B80;&#x6D01;</p>
<blockquote>
<p>Stability: 1 - Experimental. Please migrate away from this API, if you can. We do <strong>not</strong> recommend using the createHook, AsyncHook, and executionAsyncResource APIs as they have usability issues, safety risks, and performance implications. Async context tracking use cases are better served by the stable <strong>AsyncLocalStorage</strong> API.</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/4e394fb3ecc3c17de3e353cf678a0b77487fe35285a9b8af5f8dfc32c7e5ee65" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>Node&#x6587;&#x6863;&#x4E2D;&#xFF0C;API&#x7684;&#x7A33;&#x5B9A;&#x6027;&#xFF08;&#x5C31;&#x662F;&#x544A;&#x8BC9;&#x4F60;&#x6562;&#x4E0D;&#x6562;&#x7528;&#x8FD9;&#x4E2A; API&#xFF09;&#x6709;&#x5206;&#x7EA7;</p>
<p>&#x5373;<code>Stability index</code>&#x88AB;&#x5206;&#x4E3A;&#x4E86;4&#x6863;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;</p>
<ul>
<li>Stability: 0 - Deprecated</li>
<li>Stability: 1 - Experimental</li>
<li>Stability: 2 - Stable</li>
<li>Stability: 3 - Legacy</li>
</ul>
<p>&#x6211;&#x4EEC;&#x7684; async_hooks &#x88AB;&#x5F52;&#x5230;&#x4E86; Experimental&#xFF0C;<code>&#x5728;&#x672A;&#x6765;&#x7684;&#x4EFB;&#x4F55;&#x7248;&#x672C;&#x4E2D;&#x90FD;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x975E;&#x5411;&#x540E;&#x517C;&#x5BB9;&#x7684;&#x53D8;&#x5316;&#x6216;&#x5220;&#x9664;&#x3002;&#x4E0D;&#x5EFA;&#x8BAE;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;</code>&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x4EFB;&#x4F55;&#x7EBF;&#x4E0A;&#x73AF;&#x5883;&#x90FD;&#x53EA;&#x4F7F;&#x7528; Statbility:2 - Stable &#x5C31;&#x597D;&#x3002;</p>
<h2 id="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"><a href="#2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;" class="headerlink" title="2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;"></a>2019&#x5E74;&#xFF1A;AsyncLocalStorage&#xFF08;ALS&#xFF09;&#x5343;&#x547C;&#x4E07;&#x5524;&#x59CB;&#x51FA;&#x6765;</h2><p>AsyncLocalStorage was first introduced in Node.js version 12.0.0, released on April 23, 2019.</p>
<p>&#x56E0;&#x4E3A;AsyncLocalStorage (ALS) &#x7684;&#x9700;&#x6C42;&#x5F3A;&#x70C8;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x7ECF;&#x8FC7;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5B9E;&#x9A8C;&#x540E;&#xFF0C;ALS&#x7EC8;&#x4E8E;&#x5728; Node v13.10.0 &#x5B8C;&#x6574;&#x652F;&#x6301;&#x4E86;&#xFF0C;&#x968F;&#x540E; API &#x8FC1;&#x79FB;&#x5230;&#x4E86;&#x957F;&#x671F;&#x652F;&#x6301;&#x7248;&#x672C; Node v12.17.0</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0440a7ec9c3e4ae1819413914bfe7196a1af2a491f399ade0291d8179c778da4" alt title="nestjs-cls &#x76F4;&#x63A5;&#x5F15;&#x7528;&#x4E86; AsyncLocalStorage"></p>
<p>&#x56E0;&#x4E3A;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;API&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x4E5F;&#x5938;&#x4E86;&#x4E0D;&#x5C11;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4ECE;&#x5176;&#x4ED6;&#x89D2;&#x5EA6;&#x6765;&#x9610;&#x8FF0;&#x4E0B;</p>
<p><strong>&#x6027;&#x80FD;&#x95EE;&#x9898;</strong></p>
<p>AsyncLocalStorage &#x76F4;&#x63A5;&#x57FA;&#x4E8E; async_hooks &#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x3002;&#x800C; async_hooks &#x5BF9;&#x4E8E;&#x6027;&#x80FD;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x5728;&#x9AD8;&#x5E76;&#x53D1;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x5927;&#x5BB6;&#x5BF9;&#x6B64; API &#x4FDD;&#x6301;&#x4E86;&#x8C28;&#x614E;&#x7684;&#x6001;&#x5EA6;&#x3002;</p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/6f76ee04dc2a41d55ed6ec8653f3fcec.html" target="blank" rel="noopener">github.com/bmeurer/asy&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/1d6835046c3c728f13ce977774869f58514f4914567005e70519950c3823abf5" alt="image.png"></p>
<p>&#x540C;&#x65F6;&#xFF0C;Node &#x7684; issue &#x91CC;&#x9762;&#x4E5F;&#x6709;&#x5927;&#x91CF;&#x5BF9;&#x6B64;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x4E2A;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">&#x300A;AsyncLocalStorage kills 97% of performance in an async environment #34493&#x300B;</a></p>
<p>&#x672C;&#x6765;Node&#x7684;&#x6027;&#x80FD;&#x5C31;&#x662F;&#x4ED6;&#x7684;&#x77ED;&#x677F;&#xFF08;&#x6216;&#x8005;&#x8BF4;&#x8FD9;&#x4E8B;&#x56E0;&#x4E3A;&#x4ED6;&#x7684;&#x7279;&#x8D28;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#xFF09;&#xFF0C;&#x73B0;&#x5728;&#x7528;&#x4E0A;ALS&#x540E;&#x6027;&#x80FD;&#x53C8;&#x53D8;&#x5DEE;&#x4E86;&#x4E0D;&#x5C11;&#xFF0C;&#x81EA;&#x7136;&#x4F1A;&#x8BA9;&#x4EBA;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5BF9;&#x4ED6;&#x656C;&#x800C;&#x8FDC;&#x4E4B;&#xFF0C;&#x6240;&#x4EE5;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5462;&#xFF1F;</p>
<p><strong>&#x540E;&#x7EED;&#x66F4;&#x65B0;</strong></p>
<p>&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x8001;&#x5927;&#x54E5; V8 &#x51FA;&#x624B;&#x4E86;&#xFF0C;&#x6211;&#x501F;&#x7ED9;&#x4F60;&#x4E00;&#x4E2A; V8 &#x7684; API &#x7528;&#x5427;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x76D1;&#x542C;&#x6211;&#x7684; Promise lifecycle</p>
<p>&#x8FD9;&#x5C31;&#x662F; v8::Context PromiseHook API&#x3002;&#x8FD9;&#x4E2A; Hook &#x88AB;&#x52A0;&#x5165; V8 &#x540E;&#xFF0C;&#x5F88;&#x5FEB;&#x88AB; <a href="/external_links/706a78c569161016581eebbc66a99d27.html" target="blank" rel="noopener">Stephen Belanger</a> &#x52A0;&#x5165;&#x5230;&#x4E86; async_hooks</p>
<p>&#x8FD9;&#x662F;&#x5F15;&#x5165; PromiseHook &#x7684; PR &#x5730;&#x5740;&#xFF1A;<a href="/external_links/91da14a86e1b4f6cd2f94e947848e1eb.html" target="blank" rel="noopener">PR: async_hooks: use new v8::Context PromiseHook API #36394</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6a45a352587f4dc1e58ec99514f8955ca1c7f6d6538cb184865c599abdb8f6d" alt="image.png"></p>
<p>&#x7136;&#x540E;&#xFF0C;&#x4ECE;21&#x5E74;5&#x6708;&#x8FD9;&#x4E2A;&#x8BC4;&#x8BBA;&#x91CC;&#x9762;&#x5C31;&#x80FD;&#x770B;&#x51FA;&#xFF0C;<a href="/external_links/8829820176019ad463dd03618533b481.html" target="blank" rel="noopener">github.com/nodejs/node&#x2026;</a>&#xFF0C;&#x5728;V8&#x7684;&#x52A0;&#x6301;&#x4E0B;&#xFF0C;&#x5728; Node v16.2.0 &#x7684;&#x7248;&#x672C;&#x91CC;&#xFF0C;ALS&#x7684;&#x6027;&#x80FD;&#x201D;&#x5927;&#x5E45;&#x201D;&#x63D0;&#x5347;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/63210224001af4e04afb287cfbba4bab36fef05ae575f0457d20dcce0a2ca191" alt="image.png"></p>
<h2 id="&#x5C0F;&#x7ED3;-1"><a href="#&#x5C0F;&#x7ED3;-1" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x6211;&#x4EEC;&#x5B8C;&#x6210;&#x4E86;2&#x548C;3&#xFF0C;&#x540C;&#x65F6;&#x62D3;&#x5C55;&#x4E86;&#x4E9B;&#x7C7B;&#x4F3C;&#x7684;&#x573A;&#x666F;&#x548C;&#x7528;&#x6CD5;</p>
<ul>
<li>&#x6CA1;&#x6709; AsyncLocalStorage &#x8FD9;&#x4E2A; API &#x4E4B;&#x524D;&#x7684;&#x65F6;&#x4EE3;&#x662F;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x5F02;&#x6B65;&#x5B58;&#x50A8;&#x7684;&#xFF1F;&#x5927;&#x6982;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x4E86;&#x89E3;&#x5E7F;&#x4E49;&#x4E0A;&#x7684; Async Local Storage &#x662F;&#x5982;&#x4F55;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x53D1;&#x5C55;&#x8FC7;&#x6765;&#x7684;&#xFF1F;&#xFF08;&#x5373;&#x5408;&#x8BA2;&#x672C;&#xFF09;</li>
</ul>
<p>&#x901A;&#x8FC7;&#x6B64;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x65F6;&#x95F4;&#x8F74;&#x753B;&#x4E00;&#x5F20;&#x56FE;&#x51FA;&#x6765;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/3e1d3b38e1e7e8075a119a3b5337234f407feb5dfda92faaab344525995cc994" alt="image.png"></p>
<p>&#x597D;&#x7684;&#xFF0C;&#x8FD9;&#x5E45;&#x56FE;&#x5DF2;&#x7ECF;&#x9610;&#x8FF0;&#x4E86;&#x5927;&#x81F4;&#x7684;&#x53D1;&#x5C55;&#x7684;&#x5386;&#x53F2;</p>
<p>&#x800C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x4E4B;&#x524D;&#x4ECE;&#x672A;&#x63D0;&#x53CA;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x4E5F;&#x5F15;&#x51FA;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x88AB;&#x5199;&#x51FA;&#x7684;&#x539F;&#x56E0;<code>AsyncContext</code>&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BF4;&#xFF0C;&#x6700;&#x603B;&#x7ED3;&#x7684;&#x65F6;&#x5019;&#x8BF4;&#x5427;</p>
<h1 id="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;"><a href="#&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS-&#x4E0E;&#x6700;&#x65B0;-TC39-&#x63D0;&#x6848;-AsyncContext-&#x7684;&#x5173;&#x7CFB;" class="headerlink" title="&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;"></a>&#x56DB;&#x3001;&#x5F02;&#x679D;&#x540C;&#x6839;&#xFF1A;ALS &#x4E0E;&#x6700;&#x65B0; TC39 &#x63D0;&#x6848; AsyncContext &#x7684;&#x5173;&#x7CFB;</h1><blockquote>
<p>&#x7531;&#x963F;&#x91CC;&#x5DF4;&#x5DF4; TC39 &#x4EE3;&#x8868;&#x4E3B;&#x5BFC;&#x7684; <a href="/external_links/f44d0aeb1204b34bfe7e868bfb06412a.html" target="blank" rel="noopener">Async Context &#x63D0;&#x6848;</a> &#x521A;&#x5728; 2023&#x5E74; 2 &#x6708;&#x521D;&#x7684; TC39 &#x4F1A;&#x8BAE;&#x4E2D;&#x6210;&#x4E3A;&#x4E86; TC39 Stage 1 &#x63D0;&#x6848;&#x3002;&#x63D0;&#x6848;&#x7684;&#x76EE;&#x6807;&#x662F;&#x5B9A;&#x4E49;&#x5728; JavaScript &#x7684;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;&#x4E2D;&#x4F20;&#x9012;&#x6570;&#x636E;&#x7684;&#x65B9;&#x6848;&#x3002;</p>
</blockquote>
<p>&#x65E2;&#x7136;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x5927;&#x5BB6;&#x4E5F;&#x80FD;&#x5F88;&#x5FEB;&#x660E;&#x767D;&#x65B0;&#x7684; TC39 &#x63D0;&#x6848;<code>AsyncContext</code>&#x662F;&#x5728;&#x505A;&#x4EC0;&#x4E48;&#x3002;</p>
<p>&#x5BF9;&#x6BD4;&#x4E24;&#x8005;&#x7684;API&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>AsyncContext</code>&#x7ED3;&#x5408;&#x4E86;<code>AsyncLocalStorage</code>&#x548C;<code>AsyncResource</code>&#xFF0C;&#x5E76;&#x7528;&#x4E86;&#x66F4;&#x901A;&#x7528;&#x7684;&#x540D;&#x5B57;<code>context</code>&#x6765;&#x6307;&#x4EE3;&#x540E;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x7684;&#x7ED3;&#x5408;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// ======= TC39&#x63D0;&#x6848;: AsyncContext =======</span><br><span class="line">class AsyncContext&lt;T&gt; {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x6240;&#x6709; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x3002;</span><br><span class="line">  // &#x5F53;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6267;&#x884C;&#x65F6;&#xFF0C;&#x4F1A;&#x5C06; AsyncContext &#x72B6;&#x6001;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  static wrap&lt;R&gt;(fn: (...args: any[]) =&gt; R): (...args: any[]) =&gt; R;</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06; value &#x8BBE;&#x7F6E;&#x4E3A;&#x5F53;&#x524D; </span><br><span class="line">  // AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x4E2A;&#x503C;&#x4F1A;&#x5728; fn &#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x8D77;&#x7684;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x4E2D;&#x88AB;</span><br><span class="line">  // &#x5FEB;&#x7167;&#xFF08;&#x76F8;&#x5F53;&#x4E8E; wrap&#xFF09;&#x3002;</span><br><span class="line">  run&lt;R&gt;(value: T, fn: () =&gt; R): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F53;&#x524D; AsyncContext &#x5B9E;&#x4F8B;&#x7684;&#x503C;&#x3002;</span><br><span class="line">  get(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ======= Node API: AsyncLocalStorage =======</span><br><span class="line">class AsyncLocalStorage&lt;T&gt; {</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; callback&#xFF0C;&#x5E76;&#x5728; callback &#x6267;&#x884C;&#x671F;&#x95F4;&#x8BBE;&#x7F6E;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x503C;&#x3002;</span><br><span class="line">  run&lt;R&gt;(store: T, callback: (...args: any[]) =&gt; R, ...args: any[]): R;</span><br><span class="line"></span><br><span class="line">  // &#x83B7;&#x53D6;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5F53;&#x524D;&#x503C;</span><br><span class="line">  getStore(): T;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">class AsyncResource {</span><br><span class="line">  // &#x5FEB;&#x7167;&#x5F53;&#x524D;&#x7684;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  constructor();</span><br><span class="line"></span><br><span class="line">  // &#x7ACB;&#x523B;&#x6267;&#x884C; fn&#xFF0C;&#x5E76;&#x5728; fn &#x6267;&#x884C;&#x671F;&#x95F4;&#x5C06;&#x5FEB;&#x7167;&#x6062;&#x590D;&#x4E3A;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x5F02;&#x6B65;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5168;&#x5C40;&#x72B6;&#x6001;&#x3002;</span><br><span class="line">  runInAsyncScope&lt;R&gt;(fn: (...args: any[]) =&gt; R, thisArg, ...args: any[]): R;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x5728;&#x8FD9;&#x91CC;&#x56DE;&#x7B54;&#x4E0B;&#x8FD9;&#x7AE0;&#x7684;&#x6807;&#x9898;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684;&#x5173;&#x7CFB;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x662F;</p>
<ul>
<li>AsyncLocalStorage&#x662F;Node&#x7684;API&#xFF1B;&#x4E0D;&#x662F;&#x6807;&#x51C6;&#xFF0C;&#x53EA;&#x662F;&#x4E00;&#x4E2A; runtime &#x7684; API</li>
<li>AsyncContext&#x662F;EMACScript&#x6807;&#x51C6;(&#x5982;&#x679C;&#x901A;&#x8FC7;)&#xFF1B;&#x901A;&#x8FC7;&#x540E;&#x5C06;&#x6210;&#x4E3A;&#x89C4;&#x8303;&#xFF0C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7531;&#x5404;&#x79CD; runtime &#x914D;&#x5408; JS Engine &#x6765;&#x652F;&#x6301;</li>
</ul>
<p>&#x770B;&#x6765;&#x8FD9;&#x6BD4;&#x96F7;&#x950B;&#x548C;&#x96F7;&#x950B;&#x5854;&#x7684;&#x5173;&#x7CFB;&#x66F4;&#x8FD1;&#x4E9B;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x4E3A;&#x4E86;&#x8BA9; ECMA &#x6807;&#x51C6;&#x80FD;&#x540C;&#x65F6;&#x80FD;&#x517C;&#x5BB9;Node&#x7684;API&#xFF08;&#x56E0;&#x4E3A;&#x6807;&#x51C6;&#x548C;&#x76EE;&#x524D;&#x7684;API&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5230;&#x65F6;&#x5019;&#x53C8;&#x5F97;&#x6539;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x541E;&#x541E;&#x8001;&#x5E08;&#x7684;&#x63D0;&#x6848;&#x8BA9; AsyncContext &#x7684;&#x8BED;&#x6CD5;&#x548C; AsyncLocalStorage &#x975E;&#x5E38;&#x63A5;&#x8FD1;</p>
<h1 id="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"><a href="#&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;" class="headerlink" title="&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;"></a>&#x4E94;&#x3001;&#x5B83;&#x5C71;&#x4E4B;&#x77F3;&#xFF1A;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x4E2D;&#x7BA1;&#x7406;&#x591A;&#x7EBF;&#x7A0B;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x65B9;&#x6CD5;</h1><p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x4E0B;&#x540C;&#x884C;&#x90FD;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#xFF0C;&#x5927;&#x5BB6;&#x770B;&#x770B;&#x95E8;&#x9053;&#xFF0C;&#x6211;&#x4E5F;&#x770B;&#x4E2A;&#x70ED;&#x95F9;</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>&#x4F7F;&#x7528; ThreadLocal &#x6765;&#x5904;&#x7406;&#x7EBF;&#x7A0B;&#x5185;&#x7684;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java&#x590D;&#x5236;&#x4EE3;&#x7801;public class TraceIdFilter implements Filter {</span><br><span class="line"></span><br><span class="line">    private static final String TRACE_ID_HEADER = &quot;X-Trace-Id&quot;;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;String&gt; TRACE_ID = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)</span><br><span class="line">            throws IOException, ServletException {</span><br><span class="line">        HttpServletRequest httpRequest = (HttpServletRequest) request;</span><br><span class="line">        String traceId = httpRequest.getHeader(TRACE_ID_HEADER);</span><br><span class="line">        if (traceId == null || traceId.isEmpty()) {</span><br><span class="line">            traceId = generateTraceId();</span><br><span class="line">        }</span><br><span class="line">        TRACE_ID.set(traceId);</span><br><span class="line">        try {</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        } finally {</span><br><span class="line">            TRACE_ID.remove();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static String getTraceId() {</span><br><span class="line">        return TRACE_ID.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private String generateTraceId() {</span><br><span class="line">        return UUID.randomUUID().toString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // Other methods for initializing and destroying the filter...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h3><p>&#x4F7F;&#x7528; thread_local &#x6765;&#x5904;&#x7406;&#x672C;&#x5730;&#x7EBF;&#x7A0B;&#x53D8;&#x91CF;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;#include &lt;iostream&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line"></span><br><span class="line">thread_local int my_thread_local;</span><br><span class="line"></span><br><span class="line">void my_thread_function() {</span><br><span class="line">    my_thread_local = std::hash&lt;std::thread::id&gt;()(std::this_thread::get_id());</span><br><span class="line">    std::cout &lt;&lt; &quot;My thread-local value is &quot; &lt;&lt; my_thread_local &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int main() {</span><br><span class="line">    std::thread t1(my_thread_function);</span><br><span class="line">    std::thread t2(my_thread_function);</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>&#x540C;&#x4E0A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">py&#x590D;&#x5236;&#x4EE3;&#x7801;import threading</span><br><span class="line"></span><br><span class="line">my_thread_local = threading.local()</span><br><span class="line"></span><br><span class="line">def my_thread_function():</span><br><span class="line">    my_thread_local.value = threading.get_ident()</span><br><span class="line">    print(f&quot;My thread-local value is {my_thread_local.value}&quot;)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=my_thread_function)</span><br><span class="line">t2 = threading.Thread(target=my_thread_function)</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br></pre></td></tr></table></figure>

<h1 id="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage-&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;"></a>&#x516D;&#x3001;&#x591A;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncLocalStorage &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;</h1><p>&#x4E0B;&#x9762;&#x4E24;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x591A;&#x8D70;&#x4FE9;&#x6B65;&#xFF0C;&#x4ECB;&#x7ECD;&#x548C;&#x8BA8;&#x8BBA;&#x4E0B;&#x8FD9;&#x4E9B; API &#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x5E0C;&#x671B;&#x6307;&#x6B63;&#x3002;</p>
<blockquote>
<p>&#x56E0;&#x4E3A;&#x5177;&#x4F53;&#x7684;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x4F1A;&#x548C; Node &#x7684;&#x7248;&#x672C;&#x6709;&#x5F3A;&#x76F8;&#x5173;</p>
<p>&#x6240;&#x4EE5;&#x7279;&#x522B;&#x58F0;&#x660E;&#xFF1A;&#x4E0B;&#x9762;&#x7684;&#x6587;&#x6863;&#x3001;&#x4EE3;&#x7801;&#x90FD;&#x4EE5; <strong>Node v16.x LTS</strong> (Long-term Support) &#x4E2D;&#x7684;&#x6587;&#x6863;&#x548C;&#x4EE3;&#x7801;&#x4E3A;&#x4F8B;&#x3002;</p>
</blockquote>
<h2 id="I-Wonder-Where-the-API-Comes-From"><a href="#I-Wonder-Where-the-API-Comes-From" class="headerlink" title="I Wonder Where the API Comes From"></a>I Wonder Where the API Comes From</h2><p>&#x8981;&#x60F3;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;API&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x8BFB;&#x6587;&#x6863;</p>
<p><a href="/external_links/664de0d336dbe22f94ea8fc636ae5876.html" target="blank" rel="noopener">nodejs.org/docs/latest&#x2026;</a></p>
<p>&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x6587;&#x6863;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;API&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x662F;&#x5374;&#x900F;&#x9732;&#x4E86;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x4FE1;&#x606F;&#xFF0C;source code &#x6765;&#x81EA;<code>lib/async_hook.js</code></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0a02586a931534dafb9e51e01ab042a798a29318da44f3547f84e3b18e00a4a0" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a99ea1bac5616fc973b92571f342f503fd686f3035cc42b371621f724058a731" alt="image.png"><br>&#x6240;&#x4EE5;&#x987A;&#x7406;&#x6210;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x63A2;&#x7D22;</p>
<p>&#x63A2;&#x7D22;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x5148;&#x5927;&#x6982;&#x4ECB;&#x7ECD;&#x4E0B; nodejs &#x9879;&#x76EE;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;</p>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x548C;&#x6784;&#x5EFA;&#x6587;&#x4EF6;&#x54B1;&#x5148;&#x4E0D;&#x770B;&#xFF0C;&#x54B1;&#x4EEC;&#x770B;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x4E09;&#x4E2A;&#x6587;&#x4EF6;&#x5939;<code>deps</code>&#x3001;<code>lib</code>&#x3001;<code>src</code></p>
<table>
<thead>
<tr>
<th><strong>&#x540D;&#x5B57;</strong></th>
<th><strong>&#x8BF4;&#x660E;</strong></th>
<th><strong>&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x8BED;&#x8A00;</strong></th>
</tr>
</thead>
<tbody><tr>
<td>deps</td>
<td>&#x5305;&#x542B; Node.js &#x4F7F;&#x7528;&#x7684;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#xFF0C;&#x5305;&#x62EC; V8 &#x5F15;&#x64CE;&#x548C; libuv &#x5E93;&#x7B49;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F; node_modules</td>
<td>C++/C</td>
</tr>
<tr>
<td>lib</td>
<td>&#x5305;&#x542B; Node.js &#x6838;&#x5FC3;&#x5E93;&#x6587;&#x4EF6;&#xFF0C;&#x5305;&#x62EC;&#x7528;&#x4E8E;&#x5904;&#x7406; I/O &#x64CD;&#x4F5C;&#x3001;&#x7F51;&#x7EDC;&#x548C;&#x5176;&#x4ED6;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#x7684;&#x6A21;&#x5757;&#x3002;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x6838;&#x5FC3;&#x5E93;&#x7684;JS&#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x4F5C;&#x4E3A;API&#x63D0;&#x4F9B;&#x7ED9;Nodejs&#x4F7F;&#x7528;&#x3002;&#x6BD4;&#x5982;&#x54B1;&#x4EEC;&#x719F;&#x6089;&#x7684; require(http) &#x5C31;&#x662F;&#x5F15;&#x7528;&#x7684; <code>lib/http.js</code></td>
<td>Javascript</td>
</tr>
<tr>
<td>src</td>
<td>&#x5305;&#x542B; Node.js &#x7684; C++ &#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x5305;&#x62EC;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#x5982;&#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;&#x3001;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x548C; HTTP &#x670D;&#x52A1;&#x5668;&#x3002;C++&#x6838;&#x5FC3;&#x6A21;&#x5757;</td>
<td>C++</td>
</tr>
</tbody></table>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x6B65;&#x6B65;&#x6765;&#x68B3;&#x7406; AsyncLocalStorage API&#x2019;s calling chain</p>
<h2 id="Javascript-Zone"><a href="#Javascript-Zone" class="headerlink" title="Javascript Zone"></a>Javascript Zone</h2><p>OK&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x5927;&#x6982;&#x77E5;&#x9053;&#x4E86;&#x7684; <code>AsyncLocalStorage</code>API &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF0C;&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x6253;&#x5F00; <code>async_hooks.js</code>&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 1. &#x771F;&#x6B63;&#x7684;&#x50A8;&#x5B58;&#x4F4D;&#x7F6E;</span><br><span class="line">const storageList = [];</span><br><span class="line">const storageHook = createHook({</span><br><span class="line">  init(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">    const currentResource = executionAsyncResource();</span><br><span class="line">    // Value of currentResource is always a non null object</span><br><span class="line">    for (let i = 0; i &lt; storageList.length; ++i) {</span><br><span class="line">      storageList[i]._propagate(resource, currentResource);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">function createHook(fns) {</span><br><span class="line">  return new AsyncHook(fns);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 2. ALS Class &#x7684;&#x5B9E;&#x73B0;</span><br><span class="line">class AsyncLocalStorage {</span><br><span class="line">  constructor() {</span><br><span class="line">    this.kResourceStore = Symbol(&apos;kResourceStore&apos;);</span><br><span class="line">    this.enabled = false;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  _enable() {</span><br><span class="line">    if (!this.enabled) {</span><br><span class="line">      this.enabled = true;</span><br><span class="line">      ArrayPrototypePush(storageList, this);</span><br><span class="line">      storageHook.enable();</span><br><span class="line">		}</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  run(store, callback, ...args) {</span><br><span class="line">    // Avoid creation of an AsyncResource if store is already active</span><br><span class="line">    if (ObjectIs(store, this.getStore())) {</span><br><span class="line">      return ReflectApply(callback, null, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    this._enable();</span><br><span class="line"></span><br><span class="line">    // &#x65B0;&#x8001; resource &#x4EA4;&#x63A5;&#x73ED;</span><br><span class="line">    const resource = executionAsyncResource(); // &#x65B0;&#x7684;resource</span><br><span class="line">    const oldStore = resource[this.kResourceStore];  // &#x8001;&#x7684;resource</span><br><span class="line"></span><br><span class="line">    resource[this.kResourceStore] = store; // &#x65B0;&#x7684;resource&#xFF0C;traceId&#x5B58;&#x653E;&#x7684;&#x5730;&#x65B9;</span><br><span class="line"></span><br><span class="line">    try {</span><br><span class="line">      return ReflectApply(callback, null, args); </span><br><span class="line">    } finally {</span><br><span class="line">      resource[this.kResourceStore] = oldStore; // &#x7B49;callback&#x6267;&#x884C;&#x7ED3;&#x675F;&#xFF0C;&#x5C06;&#x8001;&#x7684;oldStore&#x5F52;&#x8FD8;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  getStore() {</span><br><span class="line">    if (this.enabled) {</span><br><span class="line">      const resource = executionAsyncResource();</span><br><span class="line">      return resource[this.kResourceStore];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4E3A;&#x4E86;&#x4FBF;&#x4E8E;&#x9605;&#x8BFB;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5220;&#x53BB;&#x4E86;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FD0;&#x884C; <code>AsyncLocalStorage.run(callback)</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x6267;&#x884C;2&#x4E2A;&#x52A8;&#x4F5C;&#xFF1A;</p>
<p>&#x53C2;&#x7167;&#x4E0B;&#x9762;&#x7684;API&#x8C03;&#x7528;&#x4EE3;&#x7801;&#x6765;&#x770B;</p>
<ul>
<li><code>this._enable()</code>&#xFF0C;&#x6FC0;&#x6D3B; hook &#x76D1;&#x542C;</li>
<li>&#x901A;&#x8FC7; <code>executionAsyncResource()</code>&#xFF0C;&#x83B7;&#x5F97;&#x5F53;&#x524D;&#x5F02;&#x6B65;&#x8D44;&#x6E90;<code>resource</code>&#xFF08;AsyncResource&#xFF0C;&#x6BCF;&#x6B21;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;V8&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;AsyncResource&#xFF09;</li>
<li>&#x7136;&#x540E;&#x628A;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; store &#x5F53;&#x505A;<code>resource</code>&#x91CC;<code>kResourceStore</code>&#x5BF9;&#x5E94;&#x7684;&#x503C;&#xFF08;store&#x5C31;&#x662F;traceId&#xFF0C;kResourceStore&#x5C31;&#x662F;&#x4E00;&#x4E2A;Symbol&#x800C;&#x5DF2;&#xFF09;</li>
<li>&#x7136;&#x540E;&#x624D;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684;callback&#x4EE3;&#x7801;<code>ReflectApply(callback, null, args)</code>&#x3002;&#x5176;&#x4E2D;<code>ReflectApply</code>&#x76F4;&#x63A5;&#x7406;&#x89E3;&#x4E3A;JS&#x4E2D;&#x7684;<code>Function.Apply()</code>&#x3002;</li>
<li>&#x4E4B;&#x540E;&#x8FD9;&#x4E2A; run &#x65B9;&#x6CD5;&#x91CC;&#x9762;&#xFF0C;&#x4EFB;&#x4F55;&#x901A;&#x8FC7;<code>executionAsyncResource()</code>&#x5F97;&#x5230;&#x7684;&#x503C;&#x90FD;&#x662F;&#x6211;&#x4EEC;&#x1F446;&#x1F3FB;&#x4E0A;&#x9762;&#x7684; <code>traceId</code></li>
<li>&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>getStore()</code>&#x62FF;&#x5230;&#x8FD9;&#x4E2A;<code>traceId</code>&#xFF0C;&#x5B8C;&#x7F8E;&#xFF01;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;import { AsyncLocalStorage } from &apos;node:async_hooks&apos;;</span><br><span class="line"></span><br><span class="line">const asyncLocalStorage = new AsyncLocalStorage();</span><br><span class="line"></span><br><span class="line">let traceId = 0;</span><br><span class="line">asyncLocalStorage.run(traceId++, () =&gt; {</span><br><span class="line">  console.log(asyncLocalStorage.getStore())</span><br><span class="line">  setImmediate(() =&gt; {</span><br><span class="line">    console.log(asyncLocalStorage.getStore())</span><br><span class="line">  })</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">asyncLocalStorage.run(&apos;test&apos;, () =&gt; {})</span><br></pre></td></tr></table></figure>

<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#x57FA;&#x4E8E;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;<code>ALS.run()</code>&#x91CC;&#x9762;&#x7684;callback&#x540C;&#x6B65;&#x8BF7;&#x6C42;&#x90FD;&#x53EF;&#x4EE5;&#x987A;&#x5229;&#x62FF;&#x5230;&#x5BF9;&#x5E94;&#x7684;<code>store</code>&#xFF0C;&#x4F46;&#x662F;&#x5F02;&#x6B65;&#x7684;&#x8BF7;&#x6C42;&#x6BCF;&#x6B21;&#x4F1A;&#x65B0;&#x5EFA; <code>AsyncResource</code>&#x3002;&#x6240;&#x4EE5;&#x62FF;&#x4E0D;&#x5230;&#x4E0A;&#x9762;&#x7684; store</p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x6765;&#x770B;<code>storageHook</code>&#x53D8;&#x91CF;&#xFF0C;&#x4ED6;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; Hook &#x6765;&#x76D1;&#x542C; init &#x4E8B;&#x4EF6;&#xFF0C;&#x5728;&#x6BCF;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x628A;&#x5F53;&#x524D;&#x7684;&#x5F02;&#x6B65;&#x8D44;&#x6E90;(AsyncResource)&#x7684;&#x503C;&#x4F20;&#x7ED9;&#x6211;&#x4EEC;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x547D;&#x540D;&#x5B83;&#x4E3A;&#x5F02;&#x6B65;A&#x3002;&#x6240;&#x4EE5;&#x5728;&#x4E0D;&#x4E45;&#x7684;&#x5C06;&#x6765;&#xFF0C;&#x5F02;&#x6B65;A&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>asyncLocalStorage.getStore()</code>&#x53EF;&#x4EE5;&#x62FF;&#x5230;&#x6B63;&#x786E;&#x7684;&#x503C;</p>
<p>&#x7ED3;&#x8BBA;&#xFF0C;ALS&#x4E5F;&#x662F;&#x57FA;&#x4E8E;AsyncHook&#x548C;&#x795E;&#x79D8;&#x7684;<code>executionAsyncResource</code>&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x4F46;&#x662F;&#x4ED6;&#x53EA;&#x4F7F;&#x7528;&#x4E86; init Hook&#xFF0C;&#x800C;&#x4E14;&#x5C01;&#x88C5;&#x7684;&#x5F88;&#x597D;&#xFF0C;&#x6240;&#x4EE5;&#x6027;&#x80FD;&#x548C;&#x53EF;&#x7528;&#x6027;&#x90FD;&#x66F4;&#x597D;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x770B; <code>AsyncHook</code>&#x90FD;&#x66F4;&#x53EF;&#x7591;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x7AE0;&#x6211;&#x4EEC;&#x6765;&#x5206;&#x6790;&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x76D1;&#x542C;&#x52AB;&#x6301;&#x4EFB;&#x4F55;&#x4E00;&#x79CD;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x8FD9;&#x4E2A;<code>run&#x65B9;&#x6CD5;</code> &#x91CC;&#x9762;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x6808;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x5B9E;&#x73B0;&#x7684;&#x5F62;&#x5F0F;&#x662F;&#x901A;&#x8FC7;&#x7C7B;&#x4F3C;&#x4E8E;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B8C;&#x6210;&#x4E86;<code>&#x5D4C;&#x5957;nest</code>&#x80FD;&#x529B;</p>
<p>&#x5176;&#x5B9E;&#x4ECE;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684; commit log &#x4E2D;&#x4E5F;&#x80FD;&#x8BC1;&#x5B9E;&#x6211;&#x4EEC;&#x7684;&#x731C;&#x60F3;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9aee0aaa769ea22a8b6a157e78a739a312a16595e6bde4cdc654c0a09856bce5" alt></p>
<p>&#x8FD9;&#x4E2A;&#x622A;&#x56FE;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E2A;&#x5C0F;&#x5F69;&#x86CB; Reviewed-By: Zijian Liu</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x8FD9;&#x79CD;&#x9012;&#x5F52;&#x8FD8;&#x6709;&#x70B9;&#x50CF; Leetcode &#x7ECF;&#x5178;&#x7684;&#x56DE;&#x6EAF;&#x7B97;&#x6CD5;&#x9898; <a href="/external_links/25a09439e0a56f47cfbff81fc581b659.html" target="blank" rel="noopener">51. N-Queens</a>&#xFF0C;&#x5B83;&#x5C31;&#x662F;&#x5BF9; tree &#x7684;DFS&#x904D;&#x5386;&#x3002;DFS&#x904D;&#x5386;&#x7528;&#x9012;&#x5F52;&#x5199;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x800C;&#x7528;&#x8FED;&#x4EE3;&#x5199;&#x5C31;&#x662F;&#x7528;Stack&#x4E86;</p>
<h1 id="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;"><a href="#&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook-&#x662F;&#x5982;&#x4F55;&#x5728;-Node-Core-&#x5C42;&#x5B9E;&#x73B0;&#x7684;" class="headerlink" title="&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;"></a>&#x4E03;&#x3001;&#x518D;&#x8D70;&#x4E00;&#x6B65;&#xFF1A;AsyncHook &#x662F;&#x5982;&#x4F55;&#x5728; Node Core &#x5C42;&#x5B9E;&#x73B0;&#x7684;</h1><h2 id="Intro-and-Guess"><a href="#Intro-and-Guess" class="headerlink" title="Intro and Guess"></a>Intro and Guess</h2><p>&#x5728;&#x4E0A;&#x4E00;&#x4E2A;&#x7AE0;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53D1;&#x73B0; AsyncHook &#x548C; executionAsyncResource &#x662F;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B; AsyncHook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/async_hooks.js</span><br><span class="line"></span><br><span class="line">class AsyncHook {</span><br><span class="line">  constructor({</span><br><span class="line">    init,</span><br><span class="line">    before,</span><br><span class="line">    after,</span><br><span class="line">    destroy,</span><br><span class="line">    promiseResolve</span><br><span class="line">  }) {</span><br><span class="line">    this[init_symbol] = init;</span><br><span class="line">    this[before_symbol] = before;</span><br><span class="line">    this[after_symbol] = after;</span><br><span class="line">    this[destroy_symbol] = destroy;</span><br><span class="line">    this[promise_resolve_symbol] = promiseResolve;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  enable() {</span><br><span class="line">    // The set of callbacks for a hook should be the same regardless of whether</span><br><span class="line">    // enable()/disable() are run during their execution. The following</span><br><span class="line">    // references are reassigned to the tmp arrays if a hook is currently being</span><br><span class="line">    // processed.</span><br><span class="line">    const {</span><br><span class="line">      0: hooks_array,</span><br><span class="line">      1: hook_fields</span><br><span class="line">    } = getHookArrays();</span><br><span class="line"></span><br><span class="line">    // Each hook is only allowed to be added once.</span><br><span class="line">    if (ArrayPrototypeIncludes(hooks_array, this))</span><br><span class="line">      return this;</span><br><span class="line"></span><br><span class="line">    const prev_kTotals = hook_fields[kTotals];</span><br><span class="line"></span><br><span class="line">    // createHook() has already enforced that the callbacks are all functions,</span><br><span class="line">    // so here simply increment the count of whether each callbacks exists or</span><br><span class="line">    // not.</span><br><span class="line">    hook_fields[kTotals] = hook_fields[kInit] += +!!this[init_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kBefore] += +!!this[before_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kAfter] += +!!this[after_symbol];</span><br><span class="line">    hook_fields[kTotals] += hook_fields[kDestroy] += +!!this[destroy_symbol];</span><br><span class="line">    hook_fields[kTotals] +=</span><br><span class="line">      hook_fields[kPromiseResolve] += +!!this[promise_resolve_symbol];</span><br><span class="line">    ArrayPrototypePush(hooks_array, this);</span><br><span class="line"></span><br><span class="line">    if (prev_kTotals === 0 &amp;&amp; hook_fields[kTotals] &gt; 0) {</span><br><span class="line">      enableHooks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    updatePromiseHookMode();</span><br><span class="line"></span><br><span class="line">    return this;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD8;&#x597D;&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E0D;&#x7B97;&#x53EF;&#x7591;&#xFF0C;&#x548C;&#x9884;&#x60F3;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x628A;&#x6BCF;&#x4E2A;&#x9636;&#x6BB5;&#x7684; hook &#x7684; callback &#x5B58;&#x8D77;&#x6765;&#x3002;&#x7136;&#x540E;&#x518D;&#x901A;&#x8FC7; enable &#x65B9;&#x6CD5;&#x6FC0;&#x6D3B;&#x4ED6;&#x4EEC;&#xFF0C;&#x90A3; line 44 &#x7684; enableHooks() &#x6765;&#x81EA;&#x54EA;&#x91CC;&#xFF1F;&#x6765;&#x81EA;<code>lib/internal/async_hooks.js</code>&#xFF08;&#x662F;&#x7684;&#xFF0C;&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x539F;&#x6765;&#x6BCF;&#x4E00;&#x4E2A;lib&#x6587;&#x4EF6;&#x5939;&#x7684;API&#x8FD8;&#x8C03;&#x7528;&#x4E86;<code>lib/internal</code>&#x8FD9;&#x5C42;&#x5185;&#x90E8;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x53C8;&#x62BD;&#x8C61;&#x4E86;&#x4E00;&#x5C42;&#x51FA;&#x6765;&#x3002;&#xFF09;</p>
<p>&#x770B;&#x4E0B;&#x4EE3;&#x7801;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">const async_wrap = internalBinding(&apos;async_wrap&apos;);</span><br><span class="line">const { setCallbackTrampoline } = async_wrap;</span><br><span class="line"></span><br><span class="line">function enableHooks() {</span><br><span class="line">  async_hook_fields[kCheck] += 1;</span><br><span class="line"></span><br><span class="line">  setCallbackTrampoline(callbackTrampoline);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; setCallbackTrampoline&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x81EA; async_wrap&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x770B;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x8C03;&#x7528;&#x7684;&#x795E;&#x79D8;&#x7684; executionAsyncResource &#x91CC;&#x9762;&#x8C03;&#x7528;&#x7684;&#x5173;&#x952E;&#x53D8;&#x91CF;&#xFF0C;&#x51E0;&#x4E4E;&#x90FD;&#x6765;&#x81EA;<code>async_wrap</code>&#xFF0C;&#x901A;&#x8FC7; internalBinding &#x83B7;&#x53D6;&#x5230;&#x7684;&#x3002;</p>
<p>&#x65E2;&#x7136;&#x8FD9;&#x91CC;&#x7528;&#x7684;&#x662F;<code>internalBinding(String)</code>&#xFF0C;&#x5165;&#x53C2;&#x662F;&#x4E2A;string&#xFF0C;&#x518D;&#x52A0;&#x4E0A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x7136;&#x53EF;&#x4EE5;&#x731C;&#x6D4B; internalBinding &#x91CC;&#x9762;&#x8FD8;&#x6709;&#x8BB8;&#x591A;string&#x53EF;&#x4EE5;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x4E14;&#x53EF;&#x679A;&#x4E3E;&#x5B8C;&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x6CA1;&#x6709;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x4E3A;const&#x3001;enum&#x3001;&#x6216;&#x8005;symbol&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x806A;&#x660E;&#x7684;&#x4F60;&#x53BB;&#x89E3;&#x7B54;&#x4E86;&#xFF09;</p>
<p>&#x968F;&#x4FBF;&#x641C;&#x4E0B;&#xFF0C;&#x65E0;&#x6570;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x901A;&#x8FC7; <code>internalBinding</code>&#x83B7;&#x53D6;&#x5230;&#xFF0C;&#x731C;&#x6D4B;&#x9A8C;&#x8BC1;&#x7ED3;&#x675F;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e79cdd5ec76c51fed2f9131d9d1d63468dee25af205f5c74876aeec6d017630c" alt="image.png"></p>
<p>&#x4F46;&#x662F;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x9047;&#x5230;&#x4E00;&#x4E9B;&#x5C0F;&#x9EBB;&#x70E6;&#xFF0C;&#x56E0;&#x4E3A;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;<code>internalBinding</code>&#x5E76;&#x6CA1;&#x6709;&#x901A;&#x8FC7; <code>require()</code>&#x7684;&#x65B9;&#x5F0F;&#x5F15;&#x7528;&#x8FDB;&#x4EE3;&#x7801;&#xFF0C;command+&#x5DE6;&#x952E;&#x4E5F;&#x53EA;&#x80FD;&#x5230;&#x5B83;&#x7684;d.ts&#x5B9A;&#x4E49;&#x91CC;&#x9762;&#x3002;&#x611F;&#x89C9;&#x4F3C;&#x4E4E;&#x9677;&#x5165;&#x4E86;&#x6B7B;&#x80E1;&#x540C;&#x6216;&#x8005;&#x4EC0;&#x4E48;&#x9ED1;&#x9B54;&#x6CD5;&#x4E4B;&#x4E2D;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ts&#x590D;&#x5236;&#x4EE3;&#x7801;// d.ts file</span><br><span class="line">declare function InternalBinding(binding: &apos;blob&apos;): {</span><br><span class="line">  createBlob(sources: Array&lt;Uint8Array | InternalBlobBinding.BlobHandle&gt;, length: number): InternalBlobBinding.BlobHandle;</span><br><span class="line">  FixedSizeBlobCopyJob: typeof InternalBlobBinding.FixedSizeBlobCopyJob;</span><br><span class="line">  getDataObject(id: string): [handle: InternalBlobBinding.BlobHandle | undefined, length: number, type: string] | undefined;</span><br><span class="line">  storeDataObject(id: string, handle: InternalBlobBinding.BlobHandle, size: number, type: string): void;</span><br><span class="line">  revokeDataObject(id: string): void;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p><a href="/external_links/94019a2c32ae2ec25e3db8f62529a519.html" target="blank" rel="noopener">github.com/nodejs/help&#x2026;</a></p>
<p>&#x7B80;&#x5355;&#x4E00;&#x641C;&#xFF0C;&#x5C31;&#x80FD;&#x641C;&#x5230;&#x95EE;&#x9898;&#x7684;&#x56DE;&#x7B54;&#xFF0C;&#x67F3;&#x6697;&#x82B1;&#x660E;&#x3002;&#xFF08;&#x5176;&#x5B9E;&#x5168;&#x5C40;&#x641C;&#x7D22;&#x4E5F;&#x80FD;&#x641C;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF09;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x6765;&#x5230;<code>lib/internal/bootstrap/loader.js</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line"></span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Set up internalBinding() in the closure.</span><br><span class="line">/**</span><br><span class="line"> * @type {InternalBinding}</span><br><span class="line"> */</span><br><span class="line">let internalBinding;</span><br><span class="line">{</span><br><span class="line">  const bindingObj = ObjectCreate(null);</span><br><span class="line">  // eslint-disable-next-line no-global-assign</span><br><span class="line">  internalBinding = function internalBinding(module) {</span><br><span class="line">    let mod = bindingObj[module];</span><br><span class="line">    if (typeof mod !== &apos;object&apos;) {</span><br><span class="line">      mod = bindingObj[module] = getInternalBinding(module);</span><br><span class="line">      ArrayPrototypePush(moduleLoadList, `Internal Binding ${module}`);</span><br><span class="line">    }</span><br><span class="line">    return mod;</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x662F;&#x7B80;&#x5316;&#x540E;&#x7684;&#x5907;&#x6CE8;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x52A0;&#x8F7D;&#x4E3A;&#x4E86; loader&#xFF0C;&#x65E2;&#x7136;&#x662F; loader &#x81EA;&#x7136;&#x8981; load &#x6587;&#x4EF6;&#xFF0C;load &#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p>
<p>&#x7528;&#x4E8E; load built-in modules&#xFF08;&#x52A0;&#x8F7D;&#x5185;&#x90E8;&#x6A21;&#x5757;&#xFF09;&#x3002;&#x628A;C++&#x7684;&#x6A21;&#x5757;load&#x5230;js&#x91CC;&#x9762;&#x8FDB;&#x884C;&#x8C03;&#x7528;</p>
<p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;In line 30&#xFF0C;getInternalBinding &#x4E5F;&#x662F;&#x2018;&#x51ED;&#x7A7A;&#x2019;&#x51FA;&#x73B0;&#x7684;&#x3002;&#x81EA;&#x7136;&#x6211;&#x4EEC;&#x53BB;&#x641C;&#x4E0B;&#x4ED6;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c9646e201b380478add1555fb6f67723ad28add54181450934531e80a7de82de" alt="image.png"></p>
<p>&#x770B;&#x6765;&#xFF0C;getInternalBinding() &#x662F;&#x771F;&#x5728;js&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x627E;&#x4E0D;&#x5230;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x4E0D;&#x6765;&#x81EA;js&#x4E16;&#x754C;</p>
<p>Alright&#xFF0C;&#x606D;&#x559C;&#x4F60;&#xFF0C;&#x5230;&#x8FBE;C++&#x7684;&#x5730;&#x76D8;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4F7F;&#x7528; internalBinding() &#x5C06; async_wrap &#x4ECE;<code>async_wrap.cc</code>&#x52A0;&#x8F7D;&#x5230;&#x4E86; <code>async_wrap.js</code></p>
<p>&#x90A3; internalBinding &#x662F;&#x88AB;&#x5B9A;&#x4E49;&#x5728;&#x4E86; js &#x6587;&#x4EF6;&#x91CC;&#x9762;&#xFF0C;&#x53C8;&#x4E3A;&#x5565;&#x53EF;&#x4EE5;&#x88AB;&#x5168;&#x5C40;&#x8BBF;&#x95EE;&#x5230;&#xFF0C;&#x800C;&#x4E14;&#x6CA1;&#x4F7F;&#x7528; require&#x3002;&#x8FD9;&#x4E2A;&#x5728;&#x5907;&#x6CE8;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x89E3;&#x91CA;</p>
<blockquote>
<p><code>// This file is compiled as if it&apos;s wrapped in a function with arguments</code>  </p>
<p><code>// passed by node::RunBootstrapping()</code></p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x88AB;&#x7F16;&#x8BD1;&#x4E86;&#xFF0C;&#x5C31;&#x50CF;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x4E00;&#x6837;&#x88AB;&#x4F20;&#x5165;<code>node::RunBootstrapping()</code>&#x8C03;&#x7528;&#x3002;&#x800C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Node&#x7684;<code>C++ built-in module</code>&#x7684;&#x542F;&#x52A8;&#x51FD;&#x6570;</p>
<h3 id="C-World"><a href="#C-World" class="headerlink" title="C++ World"></a>C++ World</h3><p>&#x6211;&#x4EEC;&#x56DE;&#x5230;&#x4E3B;&#x7EBF;&#xFF0C;&#x770B;&#x770B;<code>async_wrap</code>&#x5728;&#x505A;&#x4EC0;&#x4E48;&#xFF0C;&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p>&#x603B;&#x4E4B;&#xFF0C;<code>async_wrap</code>&#x88AB;<code>getInternalBinding</code>&#x7ED9;get&#x5230;&#x4E86;loader.js&#x91CC;&#x9762;&#xFF0C;&#x90A3;&#x6709;get&#x5C31;&#x4E00;&#x5B9A;&#x6709;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;set&#x6216;&#x8005;&#x8BF4;&#x6CE8;&#x518C;&#x3002;&#x662F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x653E;&#x5230;src&#x6587;&#x4EF6;&#x5939;&#x7684;&#x8FD9;&#x91CC;<code>src/async_wrap.cc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">// &#x8BE5;&#x6587;&#x4EF6;&#x7ED3;&#x5C3E;&#x5904;</span><br><span class="line">// &#x5728;node_binding.h&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x4E86;&#x5B8F;macro</span><br><span class="line">// #define NODE_MODULE_CONTEXT_AWARE_INTERNAL(modname, regfunc)</span><br><span class="line">NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize);  </span><br><span class="line">NODE_MODULE_EXTERNAL_REFERENCE(async_wrap, node::AsyncWrap::RegisterExternalReferences);</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8BE5;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x5C3E;&#x5904;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x8FD9;&#x4E2A;<code>&#x5B8F;(macro)</code>&#xFF0C;&#x6CE8;&#x518C;&#x4E86;<code>async_wrap</code>&#x3002;</p>
<p>&#x81EA;&#x6B64;&#x6211;&#x4EEC;&#x5728;&#x4EE3;&#x7801;&#x5C42;&#x9762;&#x56DE;&#x7B54;&#x4E86; <code>where set</code>async_wrap<code>is called</code>&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x7684;<code>&#x5185;&#x90E8;&#x6A21;&#x5757;(Internal Module)</code>&#x662F;&#x901A;&#x8FC7;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x6765;&#x66B4;&#x9732;&#x7ED9;js&#x4EE5;&#x4F5C;&#x8C03;&#x7528;&#x7684;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x7684; loader &#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;<code>getInternalBinding</code></p>
<p>&#x81F3;&#x4E8E;<code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x6DF1;&#x6316;&#x3002;</p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code>-&gt; <code>NODE_MODULE_CONTEXT_AWARE_CPP</code> -&gt; &#x2026;</p>
<p>&#x81EA;&#x6B64;&#x5C0F;&#x7ED3;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;<code>async_wrap</code>&#x662F;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#xFF0C;&#x4EE5;&#x53CA;<code>async_wrap</code>&#x7684;&#x884C;&#x4E3A;&#x5728;&#x54EA;&#x91CC;&#x88AB;&#x5B9A;&#x4E49;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;<code>async_wrap.cc</code>&#x5185;&#x90E8;&#x5728;&#x505A;&#x4EC0;&#x4E48;</p>
<p><strong>async_wrap.cc</strong></p>
<p>&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x6709;700&#x884C;&#x5DE6;&#x53F3;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x5C31;&#x4E0D;&#x5168;&#x90E8;&#x8D34;&#x51FA;&#x6765;&#x4E86;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5728;&#x770B;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x731C;&#x4E0B;&#xFF0C;&#x4ED6;&#x5728;&#x5E72;&#x561B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x7684;&#x731C;&#x6D4B;&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x6765;&#x770B;&#xFF0C;&#x4ED6;&#x53EB;&#x505A; async wrap&#xFF0C;wrap&#x5C31;&#x662F;&#x628A;&#x6211;&#x4EEC;&#x7684;async call&#x7ED9;&#x5305;&#x4F4F;&#x4E86;&#xFF0C;&#x5305;&#x4F4F;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#xFF1F;&#x4EE3;&#x8868;async call&#x60F3;&#x505A;&#x4EC0;&#x4E48;&#x4E8B;&#xFF0C;&#x90FD;&#x5F97;&#x5148;&#x8FC7;&#x4E00;&#x5C42;&#x6211;wrap&#x518D;&#x8BF4;&#x3002;</p>
<p>&#x719F;&#x6089;&#x5417;&#xFF1F;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x8C13;&#x7684;&#x76D1;&#x542C;(listen)&#x3001;&#x52AB;&#x6301;(hijack)&#x3001;&#x5305;&#x88F9;(wrap)&#x3001;&#x76D1;&#x63A7;(monitor)&#xFF0C;&#x5927;&#x81F4;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x610F;&#x601D;&#x3002;wrap&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x70B9;&#x50CF;AOP&#xFF08;&#x9762;&#x5411;&#x5207;&#x9762;&#x7F16;&#x7A0B;&#xFF09;&#x3001;&#x6D0B;&#x8471;&#x6A21;&#x578B;&#x3001;&#x4EE3;&#x7406;proxy&#x7B49;&#x4E1C;&#x897F;&#xFF0C;&#x90FD;&#x662F;&#x4E3B;&#x89C2;&#x4E0A;&#x7ED9;&#x4EBA;&#x4E00;&#x79CD;&#x5C42;(layer)&#x7684;&#x611F;&#x89C9;&#x3002;</p>
<p>&#x8BDD;&#x8BF4;&#x56DE;&#x6765;&#xFF0C;&#x5728;&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x5C31;&#x77E5;&#x9053;&#xFF0C;<code>libuv</code>&#x662F;&#x7528;C&#x5199;&#x7684;&#x5E93;&#xFF0C;&#x8D1F;&#x8D23;&#x5F02;&#x6B65;I/O&#x7B49;&#x5DE5;&#x4F5C;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x7684;&#x5C31;&#x731C;&#x6D4B;&#xFF0C;&#x4F60;&#x65E2;&#x7136;wrap&#x52AB;&#x6301;async call&#xFF0C;&#x90A3;&#x5177;&#x4F53;&#x662F;&#x52AB;&#x6301;&#x4EC0;&#x4E48;&#x5462;&#xFF0C;&#x591A;&#x534A;&#x5C31;&#x662F;&#x548C;libuv&#x7684;&#x4E1C;&#x897F;&#x6709;&#x5173;&#x4E86;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x548C;libuv&#x548C;&#x52AB;&#x6301;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x5F88;&#x9057;&#x61BE;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5728;<code>async_wrap.cc</code>&#x4EE3;&#x7801;&#x5185;&#x90E8;&#x627E;&#x5230;<code>uv.h</code>&#x5934;&#x6587;&#x4EF6;&#xFF08;&#x4EE3;&#x8868;libuv&#xFF09;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x81F3;&#x5C11;libuv&#x6CA1;&#x6709;&#x88AB;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x3002;&#x4F46;&#x662F;&#x5927;&#x7684;&#x65B9;&#x5411;&#x4E0D;&#x4F1A;&#x9519;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x770B;libuv&#x5B98;&#x7F51;&#x6587;&#x6863;<a href="/external_links/2069550e1bd72141db50b5b89d29f779.html" target="blank" rel="noopener">docs.libuv.org/en/v1.x/api&#x2026;</a></p>
<p>&#x8FD9;&#x91CC;&#x91CC;&#x9762;&#x6709;&#x5927;&#x91CF;&#x53E5;&#x67C4;(handle)&#xFF0C;&#x7528;&#x4E8E;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x5E95;&#x5C42;I/O&#x8D44;&#x6E90;&#x7684;&#x5206;&#x914D;&#x548C;&#x91CA;&#x653E;&#xFF0C;&#x4EE5;&#x53CA;&#x5904;&#x7406;I/O&#x4E8B;&#x4EF6;&#x7684;&#x901A;&#x77E5;&#x548C;&#x56DE;&#x8C03;</p>
<p><strong>&#x6CE8;&#x610F;&#x4E0B;&#x9762;&#x53EA;&#x662F;&#x731C;&#x60F3;&#xFF01;&#x4E0D;&#x662F;&#x5BF9;&#x7684;&#xFF01;</strong></p>
<p><strong>&#x731C;&#x60F3;1&#xFF1A;</strong></p>
<p>&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x7684; libuv &#x91CC;&#x8FD9;&#x4E2A;API&#x4E86;&#xFF0C;&#x7528;&#x4F5C;&#x63D0;&#x4EA4;&#x5F02;&#x6B65;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x4E14;&#x62FF;&#x5230;&#x5F02;&#x6B65;&#x7684;&#x56DE;&#x8C03;&#x3002;</p>
<p>&#x4E24;&#x4E2A;&#x5E93;&#x5185;&#x90E8;&#x7684;&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x4E92;&#x76F8;&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E0D;&#x7B26;&#x5408;&#x89C4;&#x8303;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x88AB;&#x5305;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x5BF9;&#x5916;&#x7684;API&#x8FDB;&#x884C;&#x4EA4;&#x4E92;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC; <code>async_wrap</code> <code>&lt;---&gt;</code> <code>libuv</code> &#x8FD9;&#x79CD;&#x5173;&#x7CFB;&#x53EF;&#x4EE5;&#x62BD;&#x8C61;&#x4E3A;&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x1F447;&#x1F3FB;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/27f4e2f98ca15ebc9cec99dec11e17f5cae12cc5b6554a14547d8cb3298f8175" alt="image.png"></p>
<p><strong>&#x731C;&#x60F3;2&#xFF1A;</strong></p>
<p>AsyncWrap&#x4F5C;&#x4E3A;&#x57FA;&#x7C7B;&#xFF0C;&#x63D0;&#x4F9B;&#x5404;&#x79CD;&#x57FA;&#x7840;API&#x548C;JS&#x5C42;&#x4EA4;&#x4E92;&#x3002;&#x884D;&#x751F;&#x7684;&#x5B50;&#x7C7B;&#x548C; libuv &#x901A;&#x8FC7; uv_handle_t &#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x7531; libuv &#x901A;&#x77E5;&#x5B50;&#x7C7B;&#x53BB;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684; async hook</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x4E0B;&#x4E00;&#x7AE0;&#x770B;&#x770B;&#x731C;&#x6D4B;&#x662F;&#x5426;&#x6B63;&#x786E;</p>
<p>&#x6700;&#x540E;&#xFF0C;<code>libuv</code>&#x91CC;&#x9762;&#x7684;uv&#x4E0D;&#x662F;&#x6BCF;&#x65E5;&#x8BBF;&#x95EE;&#x91CF;UV&#xFF08;Unique Visitor&#xFF09;&#x6216;&#x8005;DAU&#xFF08;Daily Active User&#xFF09;&#xFF0C;&#x800C;&#x662F; Lib of Unicorn Velociraptor&#xFF08;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF09;&#x3002;&#x4F60;&#x95EE;&#x6211;&#x4E3A;&#x5565;&#x662F;&#x72EC;&#x89D2;&#x8FC5;&#x731B;&#x9F99;&#xFF0C;&#x56E0;&#x4E3A;&#x3002;&#x3002;&#x3002;&#x3002;&#x770B;&#x4ED6;&#x7684;logo&#x5427;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/67c7cea90f445928c63b97f391252389ef4a80b55ea349a67a57ab22c225cc36" alt="image.png"></p>
<h2 id="How-Is-AsyncHook-Init-Invoked-by-Node-Core"><a href="#How-Is-AsyncHook-Init-Invoked-by-Node-Core" class="headerlink" title="How Is AsyncHook.Init() Invoked by Node Core"></a>How Is AsyncHook.Init() Invoked by Node Core</h2><p>&#x4E3A;&#x4E86;&#x56DE;&#x7B54;&#x4E0A;&#x9762;&#x90A3;&#x4E2A;&#x731C;&#x60F3;&#xFF0C;&#x6211;&#x60F3;&#x6211;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECB;&#x7ECD;&#x4E0B; AsyncHook &#x7684; init &#x65B9;&#x6CD5;&#x662F;&#x5982;&#x4F55;&#x88AB; Node Core &#x8C03;&#x7528;&#x7684;</p>
<p>&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x628A; init &#x5B58;&#x5728;&#x4E86;&#x67D0;&#x4E2A;&#x5730;&#x65B9;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x4E00;&#x4E2A; async call &#x7684;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x4F1A;&#x88AB;&#x89E6;&#x53D1;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6709;&#x4E86;&#x4E0B;&#x9762;2&#x4E2A;&#x6B65;&#x9AA4;&#xFF1A;</p>
<h3 id="Step-1-where-is-callback-stored-in"><a href="#Step-1-where-is-callback-stored-in" class="headerlink" title="Step 1, where is callback stored in?"></a>Step 1, where is callback stored in?</h3><p>&#x4E0A;&#x4E00;&#x7AE0;&#x8BF4;&#x4E86;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; hook cb &#x88AB;&#x5B58;&#x5728;&#x4E86; AsyncHook Class &#x5BF9;&#x5E94;&#x7684; this[xxx_symbol] = xxx &#x91CC;&#x9762;&#xFF0C;&#x5728;&#x88AB; enable &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x901A;&#x8FC7; ArrayPrototypePush(hooks_array, this) &#x88AB; push &#x5230;&#x4E86; hooks_array&#x3002;</p>
<p>&#x8FD9;&#x4E2A; hooks_array &#x6765;&#x81EA; lib/internal/async_hooks.js&#xFF0C;&#x53EB;&#x505A; active_hooks&#xFF0C;&#x770B;&#x4E0B;&#x5B9A;&#x4E49;&#xFF0C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; object</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Properties in active_hooks are used to keep track of the set of hooks being</span><br><span class="line">// executed in case another hook is enabled/disabled. The new set of hooks is</span><br><span class="line">// then restored once the active set of hooks is finished executing.</span><br><span class="line">const active_hooks = {</span><br><span class="line">  // Array of all AsyncHooks that will be iterated whenever an async event</span><br><span class="line">  // fires. Using var instead of (preferably const) in order to assign</span><br><span class="line">  // active_hooks.tmp_array if a hook is enabled/disabled during hook</span><br><span class="line">  // execution.</span><br><span class="line">  array: [],</span><br><span class="line">  // Use a counter to track nested calls of async hook callbacks and make sure</span><br><span class="line">  // the active_hooks.array isn&apos;t altered mid execution.</span><br><span class="line">  call_depth: 0,</span><br><span class="line">  // Use to temporarily store and updated active_hooks.array if the user</span><br><span class="line">  // enables or disables a hook while hooks are being processed. If a hook is</span><br><span class="line">  // enabled() or disabled() during hook execution then the current set of</span><br><span class="line">  // active hooks is duplicated and set equal to active_hooks.tmp_array. Any</span><br><span class="line">  // subsequent changes are on the duplicated array. When all hooks have</span><br><span class="line">  // completed executing active_hooks.tmp_array is assigned to</span><br><span class="line">  // active_hooks.array.</span><br><span class="line">  tmp_array: null,</span><br><span class="line">  // Keep track of the field counts held in active_hooks.tmp_array. Because the</span><br><span class="line">  // async_hook_fields can&apos;t be reassigned, store each uint32 in an array that</span><br><span class="line">  // is written back to async_hook_fields when active_hooks.array is restored.</span><br><span class="line">  tmp_fields: null</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = {</span><br><span class="line">  executionAsyncId,</span><br><span class="line">  triggerAsyncId,</span><br><span class="line">  // Private API</span><br><span class="line">  getHookArrays,</span><br><span class="line">  symbols: {</span><br><span class="line">    async_id_symbol, trigger_async_id_symbol,</span><br><span class="line">    init_symbol, before_symbol, after_symbol, destroy_symbol,</span><br><span class="line">    promise_resolve_symbol, owner_symbol</span><br><span class="line">  },</span><br><span class="line">  // ..</span><br><span class="line">  executionAsyncResource,</span><br><span class="line">  // Internal Embedder API</span><br><span class="line">	// ...</span><br><span class="line">  nativeHooks: {  </span><br><span class="line">    init: emitInitNative, //  &lt;====== &#x770B;&#x8FD9;&#x91CC;</span><br><span class="line">    before: emitBeforeNative,</span><br><span class="line">    after: emitAfterNative,</span><br><span class="line">    destroy: emitDestroyNative,</span><br><span class="line">    promise_resolve: emitPromiseResolveNative</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>&#x540C;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A; lib/internal/async_hooks.js &#x6587;&#x4EF6;export&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x6709;&#x4E2A;&#x540D;&#x5B57;&#x6BD4;&#x8F83;&#x53EF;&#x7591;&#xFF0C;emitInitNative&#x3002;Native, Native&#xFF0C;&#x540D;&#x5B57;&#x91CC;&#x9762;&#x6709; Native&#xFF0C;&#x5B9E;&#x5728;&#x592A;&#x4E0D;&#x5BF9;&#x52B2;&#x4E86;&#x3002;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;&#x5B9E;&#x73B0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/async_hooks.js</span><br><span class="line"></span><br><span class="line">// Emit From Native //</span><br><span class="line"></span><br><span class="line">// Used by C++ to call all init() callbacks. Because some state can be setup</span><br><span class="line">// from C++ there&apos;s no need to perform all the same operations as in</span><br><span class="line">// emitInitScript.</span><br><span class="line">function emitInitNative(asyncId, type, triggerAsyncId, resource) {</span><br><span class="line">  active_hooks.call_depth += 1;</span><br><span class="line">  resource = lookupPublicResource(resource);</span><br><span class="line">  // Use a single try/catch for all hooks to avoid setting up one per iteration.</span><br><span class="line">  try {</span><br><span class="line">    // Using var here instead of let because &quot;for (var ...)&quot; is faster than let.</span><br><span class="line">    // Refs: https://github.com/nodejs/node/pull/30380#issuecomment-552948364</span><br><span class="line">    // eslint-disable-next-line no-var</span><br><span class="line">    for (var i = 0; i &lt; active_hooks.array.length; i++) {</span><br><span class="line">      if (typeof active_hooks.array[i][init_symbol] === &apos;function&apos;) {</span><br><span class="line">        active_hooks.array[i][init_symbol](</span><br><span class="line">          asyncId, type, triggerAsyncId,</span><br><span class="line">          resource</span><br><span class="line">        );</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  } catch (e) {</span><br><span class="line">    fatalError(e);</span><br><span class="line">  } finally {</span><br><span class="line">    active_hooks.call_depth -= 1;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // Hooks can only be restored if there have been no recursive hook calls.</span><br><span class="line">  // Also the active hooks do not need to be restored if enable()/disable()</span><br><span class="line">  // weren&apos;t called during hook execution, in which case active_hooks.tmp_array</span><br><span class="line">  // will be null.</span><br><span class="line">  if (active_hooks.call_depth === 0 &amp;&amp; active_hooks.tmp_array !== null) {</span><br><span class="line">    restoreActiveHooks();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x901A;&#x8FC7; comment &#x8BC1;&#x660E;&#x4E86;&#xFF0C;emitInitNative &#x786E;&#x5B9E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x88AB; native &#x8C03;&#x7528;&#xFF08;C++&#xFF09;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x8DEF;&#x5B58;&#x4E0B;&#x6765;&#x7684; active_hooks &#x4F1A;&#x5728; line 18 &#x91CC;&#x9762;&#xFF0C;&#x5728;js&#x5C42;&#x88AB;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540C;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x7684; before, after &#x7B49;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x56DE;&#x7B54;&#x4E86;&#x6807;&#x9898;&#xFF0C;callback&#x662F;&#x5B58;&#x5728;&#x54EA;&#x91CC;&#x5E76;&#x88AB;&#x6267;&#x884C;&#x7684;</p>
<p>&#x5148;&#x522B;&#x6025;&#x7740;&#x8D70;&#x5230;&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x5DEE;&#x4E00;&#x4EF6;&#x4E8B;&#xFF0C;&#x5C31;&#x662F;&#x5982;&#x4F55;&#x628A;&#x8FD9;&#x4E2A; js &#x7684;&#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9;&#x6211;&#x4EEC;&#x7684; native &#x5C42;&#xFF1F;&#x5728;&#x8FD9;&#x91CC;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap.js</span><br><span class="line"></span><br><span class="line">const { nativeHooks } = require(&apos;internal/async_hooks&apos;);</span><br><span class="line">internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</span><br></pre></td></tr></table></figure>

<p>&#x795E;&#x79D8;&#x7684;&#xFF0C;&#x4ECE;C++&#x5C42;&#x6765;&#x7684; async_wrap &#x8D1F;&#x8D23;&#x628A;&#x6211;&#x4EEC;&#x7684; nativeHooks &#x6CE8;&#x518C;&#x5230;c++&#x3002;OK&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F; setupHooks is responsible for registering nativeHooks &#x5373;&#x53EF;</p>
<h3 id="Step-2-which-code-line-is-responsible-for-calling-init-callback"><a href="#Step-2-which-code-line-is-responsible-for-calling-init-callback" class="headerlink" title="Step 2, which code line is responsible for calling init callback?"></a>Step 2, which code line is responsible for calling init callback?</h3><p>&#x5148;&#x8BF4;&#x7ED3;&#x8BBA;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; async call &#x90FD;&#x4F1A;&#x7531;&#x4E00;&#x4E2A; C++ &#x7684;&#x7C7B;&#x53EB;&#x505A; AsyncWrap &#x6765;&#x5305;&#x88C5;&#xFF0C;&#x5730;&#x5740;&#x5728; src/async_wrap.cc</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x901A;&#x8FC7;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x628A; async_wrap &#x66B4;&#x9732;&#x51FA;&#x53BB;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x6765;&#x770B;<code>Initialize</code></p>
<p><code>NODE_MODULE_CONTEXT_AWARE_INTERNAL(async_wrap, node::AsyncWrap::Initialize)</code></p>
<p><strong>Initialize</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::Initialize(Local&lt;Object&gt; target,</span><br><span class="line">                           Local&lt;Value&gt; unused,</span><br><span class="line">                           Local&lt;Context&gt; context,</span><br><span class="line">                           void* priv) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(context);</span><br><span class="line">  Isolate* isolate = env-&gt;isolate();</span><br><span class="line">  HandleScope scope(isolate);</span><br><span class="line"></span><br><span class="line">  env-&gt;SetMethod(target, &quot;setupHooks&quot;, SetupHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setCallbackTrampoline&quot;, SetCallbackTrampoline);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;pushAsyncContext&quot;, PushAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;popAsyncContext&quot;, PopAsyncContext);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;executionAsyncResource&quot;, ExecutionAsyncResource);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;clearAsyncIdStack&quot;, ClearAsyncIdStack);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;queueDestroyAsyncId&quot;, QueueDestroyAsyncId);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;setPromiseHooks&quot;, SetPromiseHooks);</span><br><span class="line">  env-&gt;SetMethod(target, &quot;registerDestroyHook&quot;, RegisterDestroyHook);</span><br><span class="line"></span><br><span class="line">  PropertyAttribute ReadOnlyDontDelete =</span><br><span class="line">      static_cast&lt;PropertyAttribute&gt;(ReadOnly | DontDelete);</span><br><span class="line">  // ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5148;&#x89E3;&#x91CA;&#x51E0;&#x4E2A;&#x57FA;&#x672C;&#x6982;&#x5FF5;&#x548C;&#x6570;&#x636E;&#x7C7B;&#x578B;:</p>
<ul>
<li><strong>Isolate</strong>: line 8 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728; <code>v8.h</code>&#x3002;Isolate&#x662F;V8&#x5F15;&#x64CE;&#x7684;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x5B9E;&#x4F8B;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;JavaScript&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x8FD0;&#x884C;&#x5728;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5185;&#x5B58;&#x5806;&#x3001;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x548C;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Isolate&#xFF0C;&#x6BCF;&#x4E2A;Isolate&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#xFF0C;&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x8FD0;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;</li>
<li><strong>Context</strong>: line 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;Context&#x8868;&#x793A;Isolate&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A;JavaScript&#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x542B;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x53D8;&#x91CF;&#x3001;&#x51FD;&#x6570;&#x548C;&#x5176;&#x4ED6;&#x6570;&#x636E;&#x3002;Context&#x5728;Isolate&#x4E2D;&#x521B;&#x5EFA;&#xFF0C;&#x5E76;&#x4E0E;&#x7279;&#x5B9A;&#x7684;&#x6267;&#x884C;&#x7EBF;&#x7A0B;&#x76F8;&#x5173;&#x8054;&#x3002;&#x53EF;&#x4EE5;&#x5728;&#x5355;&#x4E2A;Isolate&#x4E2D;&#x521B;&#x5EFA;&#x591A;&#x4E2A;Context&#xFF0C;&#x6BCF;&#x4E2A;Context&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x5730;&#x6267;&#x884C;JavaScript&#x4EE3;&#x7801;&#x3002;&#x6211;&#x4EEC;&#x719F;&#x77E5;&#x7684; <code>vm.createContext()</code>&#x4E5F;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; Context &#x5B9E;&#x4F8B;&#x3002;</li>
<li><strong>Local</strong>: lin 5 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>v8.h</code>&#x3002;&#x5728; V8 &#x5F15;&#x64CE;&#xFF08;Node.js &#x7684; JavaScript &#x5F15;&#x64CE;&#xFF09;&#x4E2D;&#xFF0C;&#x7528;&#x4E8E;&#x8868;&#x793A; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#xFF08;Handle&#xFF09;</li>
</ul>
<ul>
<li><ul>
<li>&#x770B;&#x4E0B;&#x539F;&#x6587;&#x63CF;&#x8FF0;&#xFF1A;<code>An object reference managed by the v8 garbage collector. All objects returned from v8 have to be tracked by the garbage collector so that it knows that the objects are still alive</code>&#x3002;<ul>
<li>&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;&#x6307;&#x9488;&#xFF0C;&#x4F46;&#x662F;&#x6307;&#x5411;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;&#x4F1A;&#x968F;&#x7740;GC&#xFF08;garbage collection&#xFF09;&#x800C;&#x53D8;&#x5316;&#xFF0C;&#x786E;&#x4FDD;&#x603B;&#x662F;&#x6307;&#x5411;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x503C;&#xFF0C;&#x540C;&#x65F6;&#x7BA1;&#x7406;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x88AB;&#x6E05;&#x7406;&#x3002;</li>
<li>Local &#x53E5;&#x67C4;&#x662F;&#x4E00;&#x79CD;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#xFF0C;&#x5B83;&#x5728; V8 &#x7684;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x662F;&#x6709;&#x9650;&#x7684;&#x3002;&#x5F53; V8 &#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x56DE;&#x6536;&#x65F6;&#xFF0C;Local &#x53E5;&#x67C4;&#x6240;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x6E05;&#x7406;&#x3002;Local&#x5C31;&#x4EE3;&#x8868;&#x4E00;&#x4E2A;V8 Context &#x7684;&#x672C;&#x5730;&#x53E5;&#x67C4;&#x3002;&#x9664;&#x4E86;&#x672C;&#x5730;&#x53E5;&#x67C4;Local&#xFF0C;&#x8FD8;&#x6709;MaybeLocal&#xFF0C;Eternal&#x7B49;&#x7C7B;&#x578B;&#x3002;</li>
<li>line 9 &#x4E2D;&#x7684; HandleScope &#x4E5F;&#x662F;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x53E5;&#x67C4;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Environment</strong>: line 7 &#x4E2D;&#x88AB;&#x7528;&#x5230;&#xFF0C;&#x88AB;&#x5B9A;&#x4E49;&#x5728;<code>src/env.h</code>&#x3002;&#x5728; Node.js &#x7684; C++ &#x5C42;&#x9762;&#xFF0C;Environment &#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x548C;&#x7EF4;&#x62A4; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x73AF;&#x5883;&#x548C;&#x8D44;&#x6E90;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x6865;&#x6881;&#xFF0C;&#x8BA9; Node.js &#x7684; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;Environment &#x7C7B;&#x5C01;&#x88C5;&#x4E86;&#x8BB8;&#x591A;&#x4E0E; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x4EE5;&#x4E0B;&#x662F; Environment &#x7C7B;&#x7684;&#x4E00;&#x4E9B;&#x4E3B;&#x8981;&#x804C;&#x8D23;&#xFF1A;</li>
</ul>
<ul>
<li><ul>
<li>&#x7BA1;&#x7406; V8 Isolate &#x5B9E;&#x4F8B;&#xFF1A;Isolate &#x662F; V8 &#x5F15;&#x64CE;&#x4E2D;&#x8868;&#x793A;&#x72EC;&#x7ACB;&#x7684; JavaScript &#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x4E00;&#x4E2A; Environment &#x5B9E;&#x4F8B;&#x4E0E;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684; Isolate &#x5B9E;&#x4F8B;&#x5173;&#x8054;&#xFF0C;&#x5B83;&#x4EEC;&#x5171;&#x540C;&#x6784;&#x6210;&#x4E86; Node.js &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x3002;<ul>
<li>&#x5185;&#x5B58;&#x7BA1;&#x7406;&#xFF1A;Environment &#x7C7B;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x4E0E;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x5982;&#x5BF9;&#x8C61;&#x53E5;&#x67C4;&#x3001;&#x7F13;&#x51B2;&#x533A;&#x7B49;&#x3002;&#x901A;&#x8FC7;&#x521B;&#x5EFA; V8 HandleScope &#x548C; EscapableHandleScope &#x5B9E;&#x4F8B;&#xFF0C;Environment &#x80FD;&#x786E;&#x4FDD; V8 &#x80FD;&#x6B63;&#x786E;&#x5730;&#x7BA1;&#x7406; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</li>
<li>&#x4E0E; JavaScript &#x5C42;&#x7684;&#x4E92;&#x64CD;&#x4F5C;&#xFF1A;Environment &#x7C7B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F; JavaScript &#x5C42;&#x4E0E;&#x5E95;&#x5C42;&#x7684; C++ &#x5B9E;&#x73B0;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x5305;&#x62EC;&#x8BBE;&#x7F6E; JavaScript &#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x65B9;&#x6CD5;&#x3001;&#x6267;&#x884C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7B49;&#x3002;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>OK&#xFF0C;&#x57FA;&#x4E8E;&#x6B64;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x5728; line 7&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; Environment::GetCurrent(context) &#x83B7;&#x53D6;&#x5230;&#x5F53;&#x524D;&#x4E0A;&#x4E0B;&#x6587;&#x7684; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x5728;line 11&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x6307;&#x9488;&#x6240;&#x6307;&#x7684;&#x65B9;&#x6CD5; SetMethod&#xFF0C;&#x8BB2;&#x6211;&#x4EEC;&#x7684; SetupHooks &#x7ED1;&#x5B9A;&#x5230;&#x4E0A;&#x4E00;&#x8282;&#x63D0;&#x5230;&#x8FC7;&#x7684; <code>internalBinding(&apos;async_wrap&apos;).setupHooks(nativeHooks);</code></p>
<p>&#x90A3; SetupHooks &#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x7684;</p>
<p><strong>SetupHooks</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">static void SetupHooks(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span><br><span class="line">  Environment* env = Environment::GetCurrent(args);</span><br><span class="line"></span><br><span class="line">  CHECK(args[0]-&gt;IsObject());</span><br><span class="line"></span><br><span class="line">  // All of init, before, after, destroy, and promise_resolve are supplied by</span><br><span class="line">  // async_hooks internally, so this should only ever be called once. At which</span><br><span class="line">  // time all the functions should be set. Detect this by checking if</span><br><span class="line">  // init !IsEmpty().</span><br><span class="line">  CHECK(env-&gt;async_hooks_init_function().IsEmpty());</span><br><span class="line"></span><br><span class="line">  Local&lt;Object&gt; fn_obj = args[0].As&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">#define SET_HOOK_FN(name)                                                      \</span><br><span class="line">  do {                                                                         \</span><br><span class="line">    Local&lt;Value&gt; v =                                                           \</span><br><span class="line">        fn_obj-&gt;Get(env-&gt;context(),                                            \</span><br><span class="line">                    FIXED_ONE_BYTE_STRING(env-&gt;isolate(), #name))              \</span><br><span class="line">            .ToLocalChecked();                                                 \</span><br><span class="line">    CHECK(v-&gt;IsFunction());                                                    \</span><br><span class="line">    env-&gt;set_async_hooks_##name##_function(v.As&lt;Function&gt;());                  \</span><br><span class="line">  } while (0)</span><br><span class="line"></span><br><span class="line">  SET_HOOK_FN(init);</span><br><span class="line">  SET_HOOK_FN(before);</span><br><span class="line">  SET_HOOK_FN(after);</span><br><span class="line">  SET_HOOK_FN(destroy);</span><br><span class="line">  SET_HOOK_FN(promise_resolve);</span><br><span class="line">#undef SET_HOOK_FN</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x662F;&#x83B7;&#x53D6; Environment* &#x6307;&#x9488;&#xFF0C;&#x63A5;&#x7740;&#x786E;&#x4FDD; args[0] &#x662F;&#x4E00;&#x4E2A; Objext&#xFF0C;&#x540C;&#x65F6; async_hooks_init_function &#x662F; empty&#xFF0C;&#x786E;&#x4FDD;&#x53EA;&#x4F1A;&#x88AB;&#x521D;&#x59CB;&#x5316;1&#x6B21;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x5B9A;&#x4E49;&#x4E86; SET_HOOK_FN &#x8FD9;&#x4E2A;&#x5B8F;(marco)&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x5B8F;&#xFF0C;&#x5C06; init &#x65B9;&#x6CD5;&#x7ED1;&#x5B9A;&#x5230;&#x89E6;&#x53D1;&#x51FD;&#x6570;</p>
<p><code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>##name## &#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;init&#x3001;before&#x3001;after&#x3001;destroy&#x53D8;&#x91CF;&#xFF0C;&#x2018;#&#x2019; &#x548C; &#x2018;##&#x2019; &#x8BED;&#x6CD5;&#x7528;&#x4E8E; C/C++ &#x4E2D;&#x7684; macro &#x547D;&#x4EE4;&#x3002;&#x6700;&#x540E;&#x7684; #undef &#x4F7F;&#x7528;&#x662F;&#x53BB;&#x6389;&#x5B8F;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x6B64;&#x5B8F;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5728; AsyncWrap::EmitAsyncInit &#x4E2D;&#x8C03;&#x7528;</p>
<p><strong>EmitAsyncInit</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cc&#x590D;&#x5236;&#x4EE3;&#x7801;// location: src/async_wrap.cc</span><br><span class="line"></span><br><span class="line">void AsyncWrap::EmitAsyncInit(Environment* env,</span><br><span class="line">                              Local&lt;Object&gt; object,</span><br><span class="line">                              Local&lt;String&gt; type,</span><br><span class="line">                              double async_id,</span><br><span class="line">                              double trigger_async_id) {</span><br><span class="line">  CHECK(!object.IsEmpty());</span><br><span class="line">  CHECK(!type.IsEmpty());</span><br><span class="line">  AsyncHooks* async_hooks = env-&gt;async_hooks();</span><br><span class="line"></span><br><span class="line">  // Nothing to execute, so can continue normally.</span><br><span class="line">  if (async_hooks-&gt;fields()[AsyncHooks::kInit] == 0) {</span><br><span class="line">    return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  HandleScope scope(env-&gt;isolate());</span><br><span class="line">  Local&lt;Function&gt; init_fn = env-&gt;async_hooks_init_function();</span><br><span class="line"></span><br><span class="line">  Local&lt;Value&gt; argv[] = {</span><br><span class="line">    Number::New(env-&gt;isolate(), async_id),</span><br><span class="line">    type,</span><br><span class="line">    Number::New(env-&gt;isolate(), trigger_async_id),</span><br><span class="line">    object,</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);</span><br><span class="line">  USE(init_fn-&gt;Call(env-&gt;context(), object, arraysize(argv), argv));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// location: v8.h</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A JavaScript function object (ECMA-262, 15.3).</span><br><span class="line"> */</span><br><span class="line">class V8_EXPORT Function : public Object {}</span><br></pre></td></tr></table></figure>

<p>set the fn: <code>env -&gt; set_async_hooks_##name##_function()</code></p>
<p>get the corresponding fn: <code>env -&gt; async_hooks_init_function()</code></p>
<p>&#x5728; line 18&#xFF0C;&#x6211;&#x4EEC;&#x83B7;&#x5F97;&#x4E86;&#x4E4B;&#x524D;&#x6CE8;&#x518C;&#x7684; init&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A; Local &#x53E5;&#x67C4;&#xFF0C;Local &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411; js &#x7684; function &#x7684;&#x53E5;&#x67C4;&#xFF0C;&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7; line 28 &#x7684; init_fn -&gt; Call() &#x53EF;&#x4EE5;&#x6765;&#x89E6;&#x53D1; js &#x51FD;&#x6570;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x8BF4;&#x5B8C;&#x4E86;&#x4E00;&#x4E2A; Async Init Hook &#x662F;&#x5982;&#x4F55;&#x88AB;&#x5B8C;&#x6574;&#x8C03;&#x7528;&#x7684;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x56DE;&#x987E;&#x4E0B;&#x6574;&#x4F53;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x7B97;&#x662F;&#x662F;&#x4E00;&#x4E2A;&#x5C0F;&#x7ED3;</p>
<h2 id="Sum-Up-High-Level-Overview-Flowchart"><a href="#Sum-Up-High-Level-Overview-Flowchart" class="headerlink" title="Sum Up: High-Level Overview Flowchart"></a>Sum Up: High-Level Overview Flowchart</h2><p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/7b9f597c2442a81082bc6816d805b2904396ed0c8f013427bf43cca69f7b9a81" alt="image.png"></p>
<ul>
<li>API&#xFF1A;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF0C;&#x66B4;&#x9732;&#x4E86;&#x8FD9;3&#x4E2A;&#x91CD;&#x8981;&#x7684;API</li>
<li>Node Core - Native JS Module:</li>
</ul>
<pre><code>+ &#x4E0A;&#x9762;&#x7684;3&#x4E2A;API&#x6765;&#x81EA;async\_hooks.js&#x4E2D;&#x7684;3&#x4E2A;&#x7C7B;&#xFF1A;AsyncLocalStorage/AsyncResource/AsyncHook
+ AsyncHook&#x8D1F;&#x8D23;&#x6CE8;&#x518C;4&#x4E2A;&#x9636;&#x6BB5;&#x7684;Callback function
+ &#x5728;&#x8FD9;&#x91CC;&#x901A;&#x8FC7; internalBinding(&apos;async\_wrap&apos;) &#x83B7;&#x5F97;C++&#x5C42;&#x7684; AsyncWrap</code></pre><ul>
<li>Node Core - C++ Binding:</li>
</ul>
<pre><code>+ &#x5728; async\_wrap.cc &#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x5173;&#x952E;&#x7684;&#x57FA;&#x7C7B; `AsyncWrap`&#xFF0C;&#x5B83;&#x7EE7;&#x627F;&#x81EA; `BaseObject`
+ &#x901A;&#x8FC7; NODE\_MODULE\_CONTEXT\_AWARE\_INTERNAL &#x65B9;&#x6CD5;&#x66B4;&#x9732;&#x7ED9; JS &#x5C42;
+ AsyncWrap&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x7C7B;&#x3002;UPDWrap&#x3001;TCPWrap&#x3001;FSEventWrap&#x7B49;&#x76F4;&#x63A5;&#x6216;&#x95F4;&#x63A5;&#x7EE7;&#x627F;&#x8005;&#x5B83;&#xFF0C;&#x4E3A;&#x5404;&#x79CD; Wrap &#x63D0;&#x4F9B;&#x8D1F;&#x8D23;&#x89E6;&#x53D1;Hook&#x56DE;&#x8C03;&#x7684;&#x65B9;&#x6CD5;&#x3002;
    - &#x6BD4;&#x5982; TCPWrap -&gt; ConnectionWrap -&gt; LibuvStreamWrap -&gt; HandleWrap -&gt; AsyncWrap
    - libuv&#x7684;&#x65B9;&#x6CD5;&#x5728;&#x5177;&#x4F53;&#x7684; Wrap &#x91CC;&#x9762;&#x8C03;&#x7528;&#x3002;
        * &#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A; TCP &#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x53D1;&#x51FA;&#x65F6;&#xFF0C;&#x4F1A;&#x6267;&#x884C; new TCPWrap&#xFF0C;&#x901A;&#x8FC7; uv\_tcp\_connect() &#x53D1;&#x8D77;&#x94FE;&#x63A5;&#xFF08;&#x65B9;&#x6CD5;&#x6765;&#x81EA;libuv&#xFF09;&#xFF1B;
        * &#x94FE;&#x63A5;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x53E5;&#x67C4;&#xFF08;uv\_tcp\_t&#xFF09;&#xFF0C;&#x5BF9; libuv &#x4FDD;&#x6301;&#x8BBF;&#x95EE;&#x3002;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x53E5;&#x67C4;&#x7C7B;&#x578B;&#x4F1A;&#x88AB;&#x8F6C;&#x53D8; uv\_tcp\_t -&gt; uv\_stream\_t
        * &#x5F53;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x65F6;&#x5019;&#xFF0C; TCPHandle &#x5BF9;&#x8C61;&#x4F1A;&#x89E6;&#x53D1; uv\_\_stream\_io() &#x65B9;&#x6CD5;&#x53BB;&#x6267;&#x884C; uv\_\_read()&#xFF0C;&#x6700;&#x7EC8;&#x901A;&#x77E5; TCPWrap &#x6216;&#x8005;&#x5176;&#x7236;&#x7C7B;&#x6267;&#x884C;&#x56DE;&#x8C03;
+ src/api &#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x7ED9;&#x4E09;&#x65B9;addons&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;API&#xFF0C;&#x5176;&#x4E2D;AsyncResource&#x662F;&#x57FA;&#x4E8E;AsyncWrap&#x7684;&#x5C01;&#x88C5;&#xFF0C;AsyncWrap&#x89E6;&#x53D1;before&#x548C;after&#x7684;&#x5F02;&#x6B65;&#x4E8B;&#x4EF6;&#x662F;&#x901A;&#x8FC7; AsyncWrap::MakeCallback &#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x8C03;&#x7528; CallbackScope &#x5185;&#x90E8;&#x7684; InternalMakeCallback</code></pre><ul>
<li>Deps:</li>
</ul>
<pre><code>+ Libuv: &#x5BF9;I/O&#x5F02;&#x6B65;&#x3001;&#x7F51;&#x7EDC;&#x5F02;&#x6B65;&#x56DE;&#x8C03;&#x8D1F;&#x8D23;
+ V8: &#x5BF9;Promise &#x548C; async/await &#x8BED;&#x6CD5;&#x8D1F;&#x8D23;
+ &#x6700;&#x7EC8;&#x901A;&#x8FC7; AsyncWrap &#x901A;&#x77E5;&#x5230; JS &#x5C42;&#x7684; AsyncHook</code></pre><h2 id="Add-On"><a href="#Add-On" class="headerlink" title="Add-On"></a>Add-On</h2><p>&#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x4E9B;&#x6536;&#x96C6;&#x8D44;&#x6599;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x73B0;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x548C;&#x5F69;&#x86CB;&#xFF0C;&#x5206;&#x4EAB;&#x7ED9;&#x5927;&#x5BB6;</p>
<p><strong>Performance Improvement</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/294ec9faacde0f406b4d878df7baa70ca35b2dd6aacba5ff8e92d15af29fdbad" alt="image.png"></p>
<p><a href="/external_links/4785ad23bbb7e952c4771db1818ea44a.html" target="blank" rel="noopener">PR&#xFF1A;async_hooks: use resource stack for AsyncLocalStorage run #39890</a></p>
<p>&#x5173;&#x952E;&#x5B57;&#xFF1A;</p>
<ul>
<li>using stack instead of AsyncResouce instance</li>
<li>eliminate extra lifecycle event</li>
</ul>
<p>&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x6267;&#x884C;<code>AsyncLocalStorage.run</code>&#x7684;&#x65F6;&#x5019;&#x6709;&#x4E2A; commit log&#xFF0C;&#x8FD9;&#x6B21;&#x7684; PR &#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x5347;&#x6027;&#x80FD;</p>
<p><strong>PromiseHook</strong></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f728b446fc8621087f2a0190c1cb7d893fcf3cb3f77dbcb0c8127ab08824abe5" alt="image.png"></p>
<p><a href="/external_links/16fe0b66fa48442349ec71a97786b483.html" target="blank" rel="noopener">PR: async_hooks: fast-path for PromiseHooks in JS #32891</a></p>
<p>&#x53C8;&#x662F;&#x8FD9;&#x4E2A;&#x54E5;&#x4EEC;&#x3002;</p>
<p>&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5F69;&#x86CB;&#x3002;Reviewed-By: Chengzhong Wu</p>
<p>&#xFF08;&#x4F46;&#x662F;&#x4E3A;&#x5565;&#x660E;&#x660E;&#x88AB;&#x5173;&#x95ED;&#x7684;PR&#xFF1F;&#x4EE3;&#x7801; commit &#x5374;&#x51FA;&#x73B0;&#x4E86;&#x5728;&#x4E86; Node v16.18&#xFF1F;&#x56E0;&#x4E3A;Node&#x53D1;&#x7248;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x4E0D;&#x4F7F;&#x7528;Github&#x7684;PR&#xFF0C;&#x6709;&#x4E00;&#x5957;&#x81EA;&#x5DF1;&#x7684;&#x6D41;&#x7A0B;&#xFF09;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/0799228bb37158f0fcedcbed7bb168f85f5fefaf667bc7d5a943bc229a49ef6e" alt="image.png"></p>
<p><strong>How is loader created</strong></p>
<p>&#x8FD9;&#x91CC;&#x653E;&#x4E0B; <code>lib/internal/bootstrap/loader.js</code>&#x6587;&#x4EF6;&#x7684;&#x5B8C;&#x6574;&#x5907;&#x6CE8;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x5206;&#x60C5;&#x51B5;&#x8BA8;&#x8BBA;&#x4E86;<code>require</code>&#x8BED;&#x6CD5;&#x91CC;&#x62FF;&#x5230;&#x7684;&#x5404;&#x79CD;&#x5BF9;&#x8C61;&#x662F;&#x600E;&#x4E48;&#x88AB;&#x52A0;&#x8F7D;&#x8FDB;&#x53BB;&#x7684;&#x3002;</p>
<p>&#x5176;&#x5B9E;&#x628A;&#x6587;&#x6863;&#x7684;&#x6CE8;&#x91CA;&#x8BFB;&#x5B8C;&#xFF0C;&#x6574;&#x4E2A; loader &#x8FD9;&#x4E00;&#x5C42;&#x5C31;&#x4F1A;&#x6E05;&#x695A;&#x5F88;&#x591A;&#x3002;&#x6240;&#x4EE5;&#x975E;&#x5E38;&#x559C;&#x6B22; Node &#x7684;&#x4E30;&#x5BCC;&#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;// location: lib/internal/bootstrap/loader.js</span><br><span class="line"></span><br><span class="line">// This file creates the internal module &amp; binding loaders used by built-in</span><br><span class="line">// modules. In contrast, user land modules are loaded using</span><br><span class="line">// lib/internal/modules/cjs/loader.js (CommonJS Modules) or</span><br><span class="line">// lib/internal/modules/esm/* (ES Modules).</span><br><span class="line">//</span><br><span class="line">// This file is compiled and run by node.cc before bootstrap/node.js</span><br><span class="line">// was called, therefore the loaders are bootstrapped before we start to</span><br><span class="line">// actually bootstrap Node.js. It creates the following objects:</span><br><span class="line">//</span><br><span class="line">// C++ binding loaders:</span><br><span class="line">// - process.binding(): the legacy C++ binding loader, accessible from user land</span><br><span class="line">//   because it is an object attached to the global process object.</span><br><span class="line">//   These C++ bindings are created using NODE_BUILTIN_MODULE_CONTEXT_AWARE()</span><br><span class="line">//   and have their nm_flags set to NM_F_BUILTIN. We do not make any guarantees</span><br><span class="line">//   about the stability of these bindings, but still have to take care of</span><br><span class="line">//   compatibility issues caused by them from time to time.</span><br><span class="line">// - process._linkedBinding(): intended to be used by embedders to add</span><br><span class="line">//   additional C++ bindings in their applications. These C++ bindings</span><br><span class="line">//   can be created using NODE_MODULE_CONTEXT_AWARE_CPP() with the flag</span><br><span class="line">//   NM_F_LINKED.</span><br><span class="line">// - internalBinding(): the private internal C++ binding loader, inaccessible</span><br><span class="line">//   from user land unless through `require(&apos;internal/test/binding&apos;)`.</span><br><span class="line">//   These C++ bindings are created using NODE_MODULE_CONTEXT_AWARE_INTERNAL()</span><br><span class="line">//   and have their nm_flags set to NM_F_INTERNAL.</span><br><span class="line">//</span><br><span class="line">// Internal JavaScript module loader:</span><br><span class="line">// - NativeModule: a minimal module system used to load the JavaScript core</span><br><span class="line">//   modules found in lib/**/*.js and deps/**/*.js. All core modules are</span><br><span class="line">//   compiled into the node binary via node_javascript.cc generated by js2c.py,</span><br><span class="line">//   so they can be loaded faster without the cost of I/O. This class makes the</span><br><span class="line">//   lib/internal/*, deps/internal/* modules and internalBinding() available by</span><br><span class="line">//   default to core modules, and lets the core modules require itself via</span><br><span class="line">//   require(&apos;internal/bootstrap/loaders&apos;) even when this file is not written in</span><br><span class="line">//   CommonJS style.</span><br><span class="line">//</span><br><span class="line">// Other objects:</span><br><span class="line">// - process.moduleLoadList: an array recording the bindings and the modules</span><br><span class="line">//   loaded in the process and the order in which they are loaded.</span><br><span class="line"></span><br><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">// This file is compiled as if it&apos;s wrapped in a function with arguments</span><br><span class="line">// passed by node::RunBootstrapping()</span><br><span class="line">/* global process, getLinkedBinding, getInternalBinding, primordials */</span><br></pre></td></tr></table></figure>

<p><strong>The Workflow of Node.js Startup</strong></p>
<p>&#x56FE;&#x7247;&#x6765;&#x6E90;&#xFF1A;<a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">leezhenghui.github.io/node.js/201&#x2026;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f845a06ae4ed9ff595b40092d9a927218ff167b7fbcdcd18780185984495a126" alt="image.png"></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/b2601115c384c4f09a83168693bc45d3e48d30675afc17f1cffdfb2f34b4c430" alt></p>
<p>&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#x7684; loader &#x5C31;&#x662F;&#x5728; LoadEnv &#x9636;&#x6BB5;&#x88AB;&#x6267;&#x884C;&#x7684;&#x3002;</p>
<p>&#x800C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BA8;&#x8BBA;&#x7684; AsyncHook &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5C31;&#x5728;&#x4E0A;&#x9762;&#x7684; [node native module] - [node-core(c/c++)] &#x4E24;&#x5C42;&#x4E4B;&#x95F4;</p>
<p>&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x539F;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x975E;&#x5E38;&#x8BE6;&#x7EC6;&#x5F97;&#x4ECB;&#x7ECD;&#x4E86; Node&#xFF0C;&#x540D;&#x5B57;&#x4E5F;&#x5F88;&#x6709;&#x610F;&#x601D; <a href="/external_links/5977511887a1f2c5677f60f83ac8681e.html" target="blank" rel="noopener">&#x300A;Demystify node.js - Modularization&#x300B;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c373a20c3aed76aa8b06ab581ff052ece9b5ff0870ddcb706e3ad11538bcaf4d" alt="image.png"></p>
<h1 id="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"><a href="#&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;" class="headerlink" title="&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;"></a>&#x516B;&#x3001;&#x6700;&#x540E;&#x7684;&#x6700;&#x540E;&#xFF1A;&#x6253;&#x4E2A;&#x603B;&#x7ED3;</h1><p>&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x60F3;&#x6CD5;&#x975E;&#x5E38;&#x7A81;&#x7136;&#x3002;&#x5927;&#x6982;&#x662F;2&#x6708;&#x521D;&#xFF0C;&#x541E;&#x541E;&#x8001;&#x5E08;&#x5728;&#x7FA4;&#x91CC;&#x5206;&#x4EAB;&#x4E86;&#x5173;&#x4E8E; AsyncContext &#x63D0;&#x6848;&#x8FDB;&#x5165; Stage1 &#x7684;&#x6D88;&#x606F;&#xFF0C;&#x5C31;&#x7784;&#x4E86;&#x4E00;&#x773C;&#x53D1;&#x73B0;&#x770B;&#x4E0D;&#x61C2;&#xFF0C;&#x4E8E;&#x662F;&#x5728;&#x5927;&#x7FA4;&#x91CC;&#x6C42;&#x6559;&#x3002;</p>
<p>&#x540E;&#x6765;&#xFF0C;&#x4E86;&#x89E3;&#x5230;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x548C;Node&#x4E2D;&#x7684;&#x4E00;&#x4E9B;API&#x7C7B;&#x4F3C;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x5F00;&#x59CB;&#x6162;&#x6162;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#x7684;&#x80CC;&#x666F;&#xFF0C;&#x5FC3;&#x91CC;&#x60F3;&#x7740;&#x90FD;&#x6574;&#x7406;&#x4E86;&#x4E9B;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5199;&#x7BC7;&#x6587;&#x7AE0;&#x603B;&#x7ED3;&#x4E0B;&#x5427;&#x3002;&#x4F46;&#x662F;&#x5149;&#x4ECB;&#x7ECD; API &#x548B;&#x7528;&#x7531;&#x6709;&#x70B9;&#x6D45;&#xFF0C;&#x5B98;&#x7F51;&#x6587;&#x6863;&#x4E5F;&#x6709;&#xFF0C;&#x4E8E;&#x662F;&#x6240;&#x5E78;&#x68B3;&#x7406;&#x4E0B;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x3002;&#x540E;&#x6765;&#x611F;&#x89C9;&#xFF0C;&#x53D1;&#x5C55;&#x8FC7;&#x7A0B;&#x90FD;&#x770B;&#x4E86;&#xFF0C;&#x4E0D;&#x5982;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x4E5F;&#x4E00;&#x628A;&#x68AD;&#x5427;&#xFF0C;&#x51B5;&#x4E14;&#x8981;&#x5199;&#x5C31;&#x8D28;&#x91CF;&#x5199;&#x9AD8;&#x70B9;&#x561B;&#xFF0C;&#x6B63;&#x597D;&#x501F;&#x8FD9;&#x4E2A;&#x673A;&#x4F1A;&#x518D;&#x4E86;&#x89E3;&#x4E0B;Node&#xFF0C;&#x4E8E;&#x662F;&#xFF0C;&#x4FBF;&#x6709;&#x4E86;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x8270;&#x96BE;&#x7684;&#xFF0C;&#x8FB9;&#x731C;&#x8FB9;&#x5B66;&#x8FB9;&#x5199;&#x3002;&#x96BE;&#x70B9;&#x6709;&#x4E8C;&#xFF0C;&#x96BE;&#x70B9;&#x4E4B;&#x4E00;&#xFF0C;&#x662F;&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x5BF9;&#x6211;&#x6709;&#x4E00;&#x5B9A;&#x96BE;&#x5EA6;&#xFF1B;&#x4ECE;&#x4E00;&#x4E2A;&#x70B9;&#x5207;&#x5165;&#x8FDB;&#x5165;&#xFF08;&#x4E00;&#x4E2A;API&#xFF09;&#xFF0C;&#x53D1;&#x73B0;&#x8FD8;&#x9700;&#x8981;&#x4E00;&#x6761;&#x7EBF;&#xFF08;Node&#x7684;&#x673A;&#x5236;&#xFF09;&#x751A;&#x81F3;&#x4E00;&#x4E2A;&#x9762;&#x7684;&#x77E5;&#x8BC6;&#xFF08;&#x5176;&#x4ED6;&#x8BED;&#x8A00;&#x3001;&#x751A;&#x81F3;&#x76F8;&#x5173;&#x9886;&#x57DF;&#x7684;&#x77E5;&#x8BC6;&#xFF09;&#x3002;&#x4E00;&#x5F00;&#x59CB;&#x6709;&#x70B9;overwhelming&#xFF0C;&#x53D1;&#x73B0;&#x9700;&#x8981;&#x540C;&#x6B65;&#x5B66;&#x7684;&#x77E5;&#x8BC6;&#x592A;&#x591A;&#x4E86;&#x3002;&#x540E;&#x6765;&#x53EF;&#x7B97;&#x627E;&#x5230;&#x4E86;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x53EA;&#x8981;&#x7D27;&#x76EF;&#x7740;&#x8FD9;&#x4E2A;&#x70B9;&#xFF0C;&#x4E0D;&#x8981;&#x76F2;&#x76EE;&#x5C55;&#x5F00; Todo List&#xFF0C;&#x5C31;&#x6162;&#x6162;&#x5411;&#x5916;&#x6269;&#x5C55;&#x5373;&#x53EF;&#x3002;&#x96BE;&#x70B9;&#x4E4B;&#x4E8C;&#xFF0C;&#x662F;&#x884C;&#x6587;&#x5982;&#x4F55;&#x5C55;&#x5F00;&#xFF0C;&#x56E0;&#x4E3A;&#x5C31;&#x6211;&#x81EA;&#x5DF1;&#x8BFB;&#x6280;&#x672F;&#x4E66;&#x7C4D;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x5F88;&#x5C11;&#x63CF;&#x5199;&#x4E3A;&#x4EC0;&#x4E48;&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x53BB;&#x60F3;&#x6216;&#x8005;&#x672C;&#x8EAB;&#x5C31;&#x6709;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x624D;&#x80FD;&#x5F97;&#x5230;&#x7B54;&#x6848;&#xFF0C;&#x6211;&#x8FD8;&#x662F;&#x5E0C;&#x671B;&#x80FD;&#x63D0;&#x4F9B;&#x66F4;&#x591A;&#x7684;&#x80CC;&#x666F;&#x6765;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x3002;&#x60F3;&#x6CD5;&#x5F88;&#x7F8E;&#x597D;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E8B;&#x5B9E;&#x4E0A;&#x81EA;&#x5DF1;&#x4E0A;&#x624B;&#x4E4B;&#x540E;&#x53D1;&#x73B0;&#xFF0C;&#x8FD8;&#x662F;&#x5F88;&#x96BE;&#x7406;&#x51FA;&#x4E00;&#x6761;&#x601D;&#x8DEF;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x50CF;&#x6F14;&#x5458;&#x5E26;&#x5165;&#x89D2;&#x8272;&#x4E00;&#x6837;&#x6765;&#x5E26;&#x5165;&#x8BFB;&#x8005;&#xFF0C;&#x5F88;&#x8003;&#x9A8C;&#x529F;&#x529B;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x6700;&#x540E;3&#x7AE0;&#xFF0C;&#x628A;&#x63E1;&#x4E0D;&#x4F4F;&#x4E86;&#x3002;</p>
<p>&#x5E78;&#x597D;&#xFF0C;&#x8FC7;&#x7A0B;&#x4E2D;&#x6709;&#x8D35;&#x4EBA;&#x76F8;&#x52A9;&#xFF0C;&#x611F;&#x8C22;&#x8FC7;&#x7A0B;&#x4E2D;&#x5404;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x6307;&#x6559; @&#x5B50;&#x8083; @&#x6B65;&#x767D; @&#x9769;&#x65B0;&#x3002;&#x611F;&#x8C22;&#x4E24;&#x4F4D;&#x8001;&#x5E08;&#x7684;&#x5BA1;&#x7A3F;@&#x541E;&#x541E; @&#x6653;&#x7530;&#xFF1B;&#x4EE5;&#x53CA;&#x611F;&#x8C22;&#x8BA9;&#x6211;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x201D;&#x59CB;&#x4F5C;&#x4FD1;&#x8005;&#x201D; @&#x541E;&#x541E;&#xFF0C;&#x6CA1;&#x6709;&#x90A3;&#x6761;&#x606D;&#x559C;&#x63D0;&#x6848;&#x7684;&#x6D88;&#x606F;&#x6211;&#x4E5F;&#x4E0D;&#x4F1A;&#x53BB;&#x770B;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x81EA;&#x7136;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;&#x8FD8;&#x6709;&#x4E9B;&#x6CA1;&#x6709;&#x70B9;&#x540D;&#x7684;&#x670B;&#x53CB;&#xFF0C;&#x518D;&#x6B21;&#x4E5F;&#x4E00;&#x4E00;&#x611F;&#x8C22;&#x4E86;&#x3002;&#x591A;&#x52A9;&#x5F97;&#x9053;&#x3001;&#x5BE1;&#x52A9;&#x5931;&#x9053;&#xFF0C;&#x5BFB;&#x6C42;&#x5E2E;&#x52A9;&#x5BF9;&#x6211;&#x6765;&#x8BF4;&#x610F;&#x4E49;&#x5F88;&#x5927;&#xFF0C;&#x611F;&#x8C22;&#x5927;&#x5BB6;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x5728;&#x6709;&#x6536;&#x83B7;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x70B9;&#x8D5E;&#xFF0C;&#x53D1;&#x73B0;&#x9519;&#x8BEF;&#x7684;&#x5730;&#x65B9;&#x4E0D;&#x541D;&#x6307;&#x6B63;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e18b6744359e79d681dc89e018e2ff09.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7233359844974182437.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7233359844974182437.html" itemprop="url">手把手带你入门 Threejs Shader 系列（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-15T21:25:42+08:00">
                2023-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x63D2;&#x64AD;&#x4E00;&#x6761;&#x5728;&#x670B;&#x53CB;&#x5708;&#x3001;&#x7FA4;&#x91CC;&#x65E9;&#x53D1;&#x8FC7;&#x4F46;&#x6587;&#x7AE0;&#x91CC;&#x8FD8;&#x6CA1;&#x53D1;&#x7684;&#x201C;&#x6700;&#x65B0;&#x201D;&#x52A8;&#x6001;&#xFF1A;&#x4E94;&#x4E00;&#x524D;&#x540E;&#x53E4;&#x67F3;&#x603B;&#x7B97;&#x6362;&#x4E86;&#x80FD;&#x770B;&#x5230; AR &#x7684;&#x624B;&#x673A;&#xFF0C;&#x57FA;&#x4E8E;&#x4E00;&#x5E74;&#x524D;&#x7684; demo &#x7528; Three.js + Shader &#x7B49;&#x505A;&#x4E86;&#x4E2A; AR &#x7B80;&#x5355;&#x6548;&#x679C;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x7528;&#x624B;&#x673A; Chrome &#x8BBF;&#x95EE; <a href="/external_links/4474c9a1c92abe5487f1a5c8308109e2.html" target="blank" rel="noopener">desertsx.github.io/webxr</a> &#x4F53;&#x9A8C;&#x4E0B;&#x5E76;&#x5206;&#x4EAB;&#x5F55;&#x5C4F;&#x6548;&#x679C;&#xFF0C;&#x6BCF;&#x6B21;&#x914D;&#x8272;&#x90FD;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x5728;&#x81EA;&#x5DF1;&#x8EAB;&#x8FB9;&#x663E;&#x793A;&#x51FA;&#x589E;&#x5F3A;&#x73B0;&#x5B9E;&#x6548;&#x679C;&#x8FD8;&#x662F;&#x5F88;&#x9177;&#x7684;&#x3002;&#x5F53;&#x7136;&#x6709;&#x4E9B;&#x624B;&#x673A;&#x53EF;&#x80FD;&#x4E0D;&#x652F;&#x6301;&#xFF0C;&#x51FA;&#x73B0; not supported &#x5C31;&#x662F;&#x4E0D;&#x884C;&#xFF0C;&#x6CE8;&#x610F;&#x5F97;&#x7528;&#x624B;&#x673A; Chrome &#x8BBF;&#x95EE;&#x3002;&#x5177;&#x4F53;&#x6548;&#x679C;&#x53EF;&#x53C2;&#x89C1;&#x539F;&#x6587;&#x91CC;&#x7684;&#x89C6;&#x9891;&#x53F7;&#x5185;&#x5BB9;&#xFF1A;<a href="/external_links/ea0cad2cbe7eb98a94c808944bcffef7.html" target="blank" rel="noopener">&#x624B;&#x628A;&#x624B;&#x5E26;&#x4F60;&#x5165;&#x95E8; Three.js Shader &#x7CFB;&#x5217;&#xFF08;&#x4E00;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3;</a></p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ffcb1fa7533db70dfde6b076c19d6a1b1d2a886cc3ea34c62e4804df313b032b" alt></p>
<h2 id="&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;"><a href="#&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;" class="headerlink" title="&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;"></a>&#x8BF4;&#x591A;&#x4E86;&#x90FD;&#x662F;&#x6CEA;</h2><p>&#x79BB;&#x4E0A;&#x7BC7;&#x6587;&#x7AE0;&#x53D1;&#x5E03;&#x53C8;&#x5FEB;&#x8FC7;&#x53BB;&#x4E00;&#x4E2A;&#x6708;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x53E4;&#x67F3;&#x5199;&#x8D77;&#x6765;&#x4E5F;&#x662F;&#x5F88;&#x96BE;&#x53D7;&#xFF0C;&#x611F;&#x89C9;&#x5F88;&#x591A;&#x4E1C;&#x897F;&#x8BB2;&#x8D77;&#x6765;&#x5F88;&#x7E41;&#x7410;&#xFF0C;&#x81EA;&#x5DF1;&#x8BB2;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x4E00;&#x76F4;&#x4E0D;&#x64C5;&#x957F;&#x8BB2;&#x89E3;&#x539F;&#x7406;&#x548C;&#x57FA;&#x7840;&#x7684;&#x7EC6;&#x8282;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x771F;&#x60F3;&#x76F4;&#x63A5;&#x653E;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x548C;&#x89C6;&#x9891;&#xFF0C;&#x8BA9;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x53BB;&#x770B;&#xFF0C;&#x4E0D;&#x505A;&#x89E3;&#x91CA;&#xFF0C;&#x4F46;&#x611F;&#x89C9;&#x90A3;&#x6837;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x7CFB;&#x5217;&#x7684;&#x6559;&#x7A0B;&#x800C;&#x8A00;&#x5C31;&#x6709;&#x6240;&#x7F3A;&#x5931;&#xFF0C;&#x6240;&#x4EE5;&#x7EC8;&#x7A76;&#x8FD8;&#x662F;&#x8FB9;&#x75DB;&#x82E6;&#x5730;&#x5C1D;&#x8BD5;&#x89E3;&#x91CA;&#xFF0C;&#x8FB9;&#x8270;&#x96BE;&#x5730;&#x7740;&#x4E00;&#x6B65;&#x6B65;&#x5B8C;&#x6210;&#x5185;&#x5BB9;&#xFF0C;&#x867D;&#x7136;&#x6700;&#x7EC8;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4ECD;&#x4E0D;&#x5B8C;&#x7F8E;&#xFF0C;&#x4F46;&#x597D;&#x6B79;&#x5148;&#x5B8C;&#x6210;&#x518D;&#x8BF4;&#x3002;&#x4E5F;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x70B9;&#x8D5E;&#x3001;&#x8F6C;&#x53D1;&#x3001;&#x6253;&#x8D4F;&#x3001;&#x8BC4;&#x8BBA;&#x7B49;&#x591A;&#x591A;&#x652F;&#x6301;&#x3002;&#x53E6;&#x5916;&#x653E;&#x4E86;&#x4E00;&#x4E9B;&#x94FE;&#x63A5;&#x53EF;&#x4F9B;&#x5927;&#x5BB6;&#x53C2;&#x8003;&#x5B66;&#x4E60;&#xFF0C;&#x5E0C;&#x671B;&#x80FD;&#x5BF9;&#x5927;&#x5BB6;&#x6709;&#x6240;&#x5E2E;&#x52A9;&#x3002;</p>
<h2 id="&#x524D;&#x7F6E;&#x8981;&#x6C42;"><a href="#&#x524D;&#x7F6E;&#x8981;&#x6C42;" class="headerlink" title="&#x524D;&#x7F6E;&#x8981;&#x6C42;"></a>&#x524D;&#x7F6E;&#x8981;&#x6C42;</h2><p>&#x5728;&#x6B63;&#x5F0F;&#x5E26;&#x5927;&#x5BB6;&#x8D70;&#x8FDB; Three.js Shader &#x4E16;&#x754C;&#x4E4B;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x5927;&#x5BB6;&#x5BF9; Three.js &#x6709;&#x6700;&#x57FA;&#x672C;&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x80FD;&#x770B;&#x61C2;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x5728; 3D &#x91CC;&#x653E;&#x4E00;&#x4E2A;&#x7EAF;&#x8272;&#x7684;&#x5E73;&#x9762;&#x7269;&#x4F53;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">html&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Three.js Shader&lt;/title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        body {</span><br><span class="line">            margin: 0;</span><br><span class="line">        }</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script type=&quot;module&quot;&gt;</span><br><span class="line">        import * as THREE from &apos;https://unpkg.com/three@0.152.2/build/three.module.js&apos;;</span><br><span class="line"></span><br><span class="line">        // Scene</span><br><span class="line">        const scene = new THREE.Scene();</span><br><span class="line"></span><br><span class="line">        // Camera</span><br><span class="line">        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);</span><br><span class="line">        camera.position.z = 2;</span><br><span class="line">        // camera.lookAt(new THREE.Vector3());</span><br><span class="line"></span><br><span class="line">        // Mesh = Geometry + Material</span><br><span class="line">        const geometry = new THREE.PlaneGeometry(1, 1);</span><br><span class="line">        const material = new THREE.MeshBasicMaterial({</span><br><span class="line">            color: 0x0ca678,</span><br><span class="line">            // wireframe: true</span><br><span class="line">        });</span><br><span class="line">        const mesh = new THREE.Mesh(geometry, material);</span><br><span class="line">        scene.add(mesh);</span><br><span class="line"></span><br><span class="line">        // Renderer</span><br><span class="line">        const renderer = new THREE.WebGLRenderer();</span><br><span class="line">        renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">        renderer.setClearColor(&quot;#e6fcf5&quot;, 1);</span><br><span class="line">        document.body.appendChild(renderer.domElement);</span><br><span class="line"></span><br><span class="line">        // Animation</span><br><span class="line">        function animate() {</span><br><span class="line">            requestAnimationFrame(animate);</span><br><span class="line">            // mesh.rotation.y += 0.01;</span><br><span class="line">            renderer.render(scene, camera);</span><br><span class="line">        }</span><br><span class="line">        animate();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6fc694a86db505683d807a138775d9c1634c6d2b7096ff7b75bb2de549a507c0" alt></p>
<p>&#x5982;&#x679C;&#x4F60;&#x4E4B;&#x524D;&#x6CA1;&#x63A5;&#x89E6;&#x8FC7; Three.js&#xFF0C;&#x5EFA;&#x8BAE;&#x5148;&#x770B;&#x770B; Three.js &#x5B98;&#x65B9;&#x6587;&#x6863;&#x7684;&#x8FD9;&#x7BC7;&#x6559;&#x7A0B;<a href="/external_links/4d7b7b99240afce9a5c0800258c77c4d.html" target="blank" rel="noopener">&#x300C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF08;Creating a scene&#xFF09;&#x300D;</a>&#xFF0C;&#x6216;&#x8005;&#x770B;&#x770B;&#x53E4;&#x67F3;&#x4E4B;&#x524D;&#x5B89;&#x5229;&#x8FC7;&#x7684;b&#x7AD9;up&#x4E3B;<code>&#x8FDB;&#x534E;</code>&#x7B80;&#x6D01;&#x6E05;&#x6670;&#x7684;&#x89C6;&#x9891;&#x2014;&#x2014;<a href="/external_links/52f884c1d280528cbadbf5949612b743.html" target="blank" rel="noopener">&#x300C;three.js&#x6559;&#x7A0B;-&#x4ECE;&#x5165;&#x95E8;&#x5230;&#x5165;&#x95E8;&#x300D;</a>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/8a1642ee9467901a43a28c8af11a6929936bbe04d275fed4c76266c14a604174" alt></p>
<p>&#x5982;&#x679C;&#x4F60;&#x559C;&#x6B22;&#x770B;&#x4E66;&#x5B66;&#x4E60;&#xFF0C;&#x521A;&#x597D;<code>&#x300C;Learn Three.js/Three.js&#x5F00;&#x53D1;&#x6307;&#x5357;&#x300D;</code>&#x82F1;&#x6587;&#x7B2C;&#x56DB;&#x7248;&#x524D;&#x51E0;&#x4E2A;&#x6708;&#x4E0A;&#x5E02;&#xFF0C;zlibrary &#x4E0A;&#x5DF2;&#x7ECF;&#x6709;&#x7535;&#x5B50;&#x4E66;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x81EA;&#x884C;&#x4E0B;&#x8F7D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;<code>&#x300C;&#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</code>&#x516C;&#x4F17;&#x53F7;&#x540E;&#x53F0;&#x56DE;&#x590D; <code>learn three.js</code> &#x83B7;&#x53D6; PDF &#x7248;&#x672C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/ffab320240ae49bcaa975eb97ba9ba9350ff6013f4df4bd207ed8c9b19f4c1e0" alt></p>
<h2 id="&#x70B9;&#x7EBF;&#x9762;&#x4F53;"><a href="#&#x70B9;&#x7EBF;&#x9762;&#x4F53;" class="headerlink" title="&#x70B9;&#x7EBF;&#x9762;&#x4F53;"></a>&#x70B9;&#x7EBF;&#x9762;&#x4F53;</h2><p>&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x5728;&#x573A;&#x666F;&#x91CC;&#x653E;&#x4E86;&#x4E00;&#x4E2A;&#x5BBD;&#x9AD8; 1x1 &#x7684;&#x5E73;&#x9762;&#xFF0C;&#x5F53;&#x5F00;&#x542F;&#x7EBF;&#x6846;&#x6A21;&#x5F0F; <code>wireframe: true</code>&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x9ED8;&#x8BA4;&#x7684;&#x5E73;&#x9762;&#x7531;4&#x4E2A;&#x9876;&#x70B9;&#x3001;2&#x4E2A;&#x4E09;&#x89D2;&#x5F62;&#x7EC4;&#x6210;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const geometry = new THREE.PlaneGeometry(1, 1);</span><br><span class="line">const material = new THREE.MeshBasicMaterial({</span><br><span class="line">    color: 0x0ca678,</span><br><span class="line">    wireframe: true</span><br><span class="line">});</span><br><span class="line">const mesh = new THREE.Mesh(geometry, material);</span><br><span class="line">scene.add(mesh);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/40a167e8621c01de55c0b49e00daa6a4741942da89639b6b31addf3d3c2944cf" alt></p>
<p>&#x9876;&#x70B9;&#x8FDE;&#x6210;&#x7EBF;&#x3001;&#x7EBF;&#x7EC4;&#x6210;&#x4E09;&#x89D2;&#x5F62;&#x3001;&#x4E09;&#x89D2;&#x5F62;&#x7EC4;&#x6210;&#x51E0;&#x4F55;&#x4F53;&#xFF0C;&#x7ACB;&#x65B9;&#x4F53;&#x3001;&#x7403;&#x4F53;&#x7B49;&#x4EA6;&#x662F;&#x5982;&#x6B64;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/f48ef765ced63efe89e12b2bc63fd997727a5c52fd59dcc77453aab20dd474c4" alt></p>
<h2 id="&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;"><a href="#&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;" class="headerlink" title="&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;"></a>&#x9876;&#x70B9;&#x5C5E;&#x6027;&#x6570;&#x636E;</h2><p><code>console.log(geometry)</code> &#x6253;&#x5370;&#x51E0;&#x4F55;&#x4F53;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5176;&#x4E2D; <code>attributes</code> &#x4E0A;&#x643A;&#x5E26;&#x7684;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x91CC;&#x9762;&#x5305;&#x542B;&#x9876;&#x70B9;&#x5750;&#x6807; position&#x3001;&#x7EB9;&#x7406;&#x5750;&#x6807; uv&#x3001;&#x6CD5;&#x7EBF; normal&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/9e673cf0a00681e5816fc4c2252c990c521e81b9c1617f3836c50c723ad12d63" alt></p>
<p>&#x8FD9;&#x91CC; count &#x662F;&#x9876;&#x70B9;&#x6570;&#xFF0C;itemSize &#x662F;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x7684;&#x7EF4;&#x5EA6;&#x6570;&#xFF0C;&#x6BD4;&#x5982; position &#x548C; normal &#x90FD;&#x662F;3&#x7EF4;&#x7684;&#x3001;uv &#x662F;2&#x7EF4;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x8BF4;&#x6765;&#x5C31;&#x662F; position &#x7684; array &#x91CC;&#x662F;3&#x4E2A;&#x4E00;&#x7EC4;&#x8868;&#x793A;&#x67D0;&#x4E2A;&#x9876;&#x70B9;&#x7684;&#x5750;&#x6807;&#x6570;&#x636E;&#xFF0C;uv&#x3001;normal &#x540C;&#x7406;&#x3002;&#x914D;&#x56FE;&#x91CC;&#x53E4;&#x67F3;&#x6309;&#x7167;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x4E00;&#x6761;&#x6570;&#x636E;&#x7684;&#x683C;&#x5F0F;&#x8FDB;&#x884C;&#x6392;&#x5217;&#xFF0C;&#x65B9;&#x4FBF;&#x5927;&#x5BB6;&#x7406;&#x89E3;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e250c743aea9523bc06fefebcf24ebfd17bc35051c3375dfcd0232ebe0312494" alt></p>
<p>&#x56E0;&#x4E3A;&#x5E73;&#x9762;&#x5BBD;&#x9AD8;&#x5747;&#x4E3A;1&#xFF0C;&#x9ED8;&#x8BA4;&#x51E0;&#x4F55;&#x4F53;&#x5728;3&#x7EF4;&#x5750;&#x6807;&#x7CFB;&#x7684;&#x539F;&#x70B9;(0, 0, 0)&#x5904;&#x5C45;&#x4E2D;&#x4E14;&#x9762;&#x671D;z&#x8F74;&#x6B63;&#x65B9;&#x5411;&#x663E;&#x793A;&#xFF0C;&#x6240;&#x4EE5;&#x9876;&#x70B9;&#x5750;&#x6807;&#x4F9D;&#x6B21;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x633A;&#x597D;&#x7406;&#x89E3;&#x7684;&#x3002;</p>
<h2 id="uv-&#x7EB9;&#x7406;&#x5750;&#x6807;"><a href="#uv-&#x7EB9;&#x7406;&#x5750;&#x6807;" class="headerlink" title="uv &#x7EB9;&#x7406;&#x5750;&#x6807;"></a>uv &#x7EB9;&#x7406;&#x5750;&#x6807;</h2><p>&#x800C; uv &#x7EB9;&#x7406;&#x5750;&#x6807;&#x5F88;&#x591A;&#x4EBA;&#x53EF;&#x80FD;&#x7B2C;&#x4E00;&#x6B21;&#x63A5;&#x89E6;&#x4E0D;&#x592A;&#x4E86;&#x89E3;&#xFF0C;&#x5176;&#x5B9E;&#x53EA;&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x8FD9;&#x5F20;&#x56FE;&#xFF0C;u &#x4ECE;&#x5DE6;&#x5230;&#x53F3;&#x589E;&#x52A0;&#x3001;v &#x4ECE;&#x4E0B;&#x5230;&#x4E0A;&#x589E;&#x52A0;&#xFF0C;&#x8303;&#x56F4;&#x4ECE;&#x5DE6;&#x4E0B;&#x89D2; (0, 0) &#x5230;&#x53F3;&#x4E0A;&#x89D2; (1, 1) &#x5373;&#x53EF;&#xFF0C;&#x54EA;&#x6015;&#x662F;&#x957F;&#x65B9;&#x5F62;&#x5E73;&#x9762;&#x3001;&#x7403;&#x4F53;&#x3001;&#x590D;&#x6742;3D&#x6A21;&#x578B;&#x7B49;&#x7269;&#x4F53;&#xFF0C;&#x5176;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x7EB9;&#x7406;&#x5750;&#x6807;&#x90FD;&#x662F;&#x8FD9;&#x4E2A;&#x8303;&#x56F4;&#x3002;&#x501F;&#x52A9; uv &#x5C31;&#x80FD;&#x628A;&#x7EB9;&#x7406;&#x56FE;&#x7247;&#x8D34;&#x5230;3D&#x7269;&#x4F53;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F; uv &#x7684;&#x4E00;&#x5927;&#x7528;&#x5904;&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x6F14;&#x793A;&#xFF0C;&#x5F88;&#x7B80;&#x5355;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/2b9cd08c116c40e3cdcce285fc0d4ff80d3bf8f6e76304a2af198cfeea2ba27f" alt></p>
<p>&#x522B;&#x770B;&#x53EA;&#x6709;&#x51E0;&#x4E2A;&#x9876;&#x70B9;&#x624D;&#x6709; uv &#x503C;&#xFF0C;&#x5176;&#x5B9E;&#x4E09;&#x89D2;&#x5F62;&#x5185;&#x6BCF;&#x4E2A;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x540E;&#x7EED;&#x90FD;&#x4F1A;&#x81EA;&#x52A8;&#x63D2;&#x503C;&#x5F97;&#x5230;&#x6570;&#x503C;&#xFF0C;&#x8FD9;&#x80CC;&#x540E;&#x501F;&#x52A9;&#x4E86;&#x4E09;&#x89D2;&#x5F62;<code>&#x91CD;&#x5FC3;&#x5750;&#x6807;/barycentric coordinates</code>&#x8FD9;&#x4E00;&#x826F;&#x597D;&#x7279;&#x6027;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x670B;&#x53CB;&#x53EF;&#x81EA;&#x884C;&#x4E86;&#x89E3;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x9700;&#x77E5;&#x9053;&#x5E73;&#x9762; plane &#x5185;&#x6BCF;&#x4E2A;&#x4F4D;&#x7F6E;&#x90FD;&#x4F1A;&#x6709; uv &#x503C;&#xFF0C;&#x6BD4;&#x5982;&#x4E2D;&#x5FC3;&#x4F4D;&#x7F6E;&#x662F; (0.5, 0.5)&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/c94a7c6d64208f83f776fb10483ff4d1652d9929f42bfd4030b6c042e0915d8a" alt></p>
<p>&#x800C;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x540E;&#x7EED;&#x5728; vertex shader &#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x5C31;&#x80FD;&#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x5230;&#x5E76;&#x4F7F;&#x7528;&#x3002;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5F80;&#x9876;&#x70B9;&#x4E0A;&#x6302;&#x6240;&#x9700;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5373;&#x81EA;&#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x7740;&#x8272;&#x5668;&#x91CC;&#x4F7F;&#x7528;&#xFF0C;&#x8FD9;&#x4E9B;&#x540E;&#x7EED;&#x90FD;&#x4F1A;&#x4ECB;&#x7ECD;&#x3002;</p>
<h2 id="Shader-&#x767B;&#x573A;"><a href="#Shader-&#x767B;&#x573A;" class="headerlink" title="Shader &#x767B;&#x573A;"></a>Shader &#x767B;&#x573A;</h2><p>&#x8BB2;&#x5B8C;&#x9876;&#x70B9;&#x4E0A;&#x7684;&#x5C5E;&#x6027;&#x6570;&#x636E;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x540E;&#x7EED;&#x4F1A;&#x7528;&#x5230;&#x7684; uv &#x503C;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8BE5; Shader &#x7740;&#x8272;&#x5668;&#x767B;&#x573A;&#xFF0C;&#x770B;&#x770B;&#x5177;&#x4F53;&#x80FD;&#x7528; uv &#x505A;&#x4E9B;&#x4EC0;&#x4E48;&#xFF08;&#x5F97;&#x5230;&#x4E0B;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x624D;&#x6765;&#x5F97;&#x53CA;&#x8BB2;&#x4E86;&#xFF09;&#x3002;</p>
<p>&#x5728;<a href="https://dev.newban.cn/7224314619865628709">&#x300C;&#x65AD;&#x66F4;19&#x4E2A;&#x6708;&#xFF0C;&#x643A; Three.js Shader &#x5F52;&#x6765;&#xFF01;&#xFF08;&#x4E0B;&#xFF09; - &#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</a>&#x4E00;&#x6587;&#xFF0C;&#x53E4;&#x67F3;&#x5C31;&#x7B80;&#x5355;&#x6F14;&#x793A;&#x8FC7; Three.js &#x91CC;&#x8981;&#x5199;&#x7684; Shader &#x4EE3;&#x7801;&#x957F;&#x4EC0;&#x4E48;&#x6837;&#xFF0C;&#x8FD9;&#x91CC;&#x5C55;&#x5F00;&#x4ECB;&#x7ECD;&#x4E0B;&#x7EC6;&#x8282;&#x3002;</p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4F7F;&#x7528; Three.js &#x5185;&#x7F6E;&#x7684;&#x90A3;&#x4E9B;&#x6750;&#x8D28;&#xFF0C;&#x800C;&#x662F;&#x7528; <code>ShaderMaterial</code> &#x66FF;&#x6362; <code>MeshBasicMaterial</code>&#xFF0C;&#x5E76;&#x4E14;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>vertexShader</code> &#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x548C; <code>fragmentShader</code> &#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#xFF0C;&#x6765;&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x3001;&#x6BCF;&#x4E2A;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x5982;&#x4F55;&#x663E;&#x793A;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/4d7b7b99240afce9a5c0800258c77c4d.html" target="blank" rel="noopener">ShaderMaterial - Three.js</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">// const material = new THREE.MeshBasicMaterial({ color: 0x0ca678 });</span><br><span class="line">const material = new THREE.ShaderMaterial({</span><br><span class="line">  vertexShader: vertex,</span><br><span class="line">  fragmentShader: fragment</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p><code>vertex</code> &#x548C; <code>fragment</code> &#x91CC;&#x662F;&#x7528;&#x7C7B;&#x4F3C;C&#x8BED;&#x8A00;&#x7684; <code>GLSL</code> &#x8BED;&#x8A00;&#x2014;&#x2014;&#x5373; <code>OpenGL Shading Language</code>&#x2014;&#x2014;&#x5199;&#x7684; shader &#x7A0B;&#x5E8F;&#xFF0C;&#x7531; GPU &#x5206;&#x522B;&#x5BF9;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x3001;&#x6BCF;&#x4E2A;&#x7247;&#x5143;&#x72EC;&#x7ACB;&#x6267;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x9876;&#x70B9;&#x6216;&#x7247;&#x5143;&#x90FD;&#x4E0D;&#x77E5;&#x9053;&#x5176;&#x4ED6;&#x9876;&#x70B9;&#x6216;&#x7247;&#x5143;&#x7684;&#x6570;&#x636E;&#x3002;&#x8FD9;&#x53E5;&#x8BDD;&#x770B;&#x4F3C;&#x4E0D;&#x8D77;&#x773C;&#xFF0C;&#x4F46;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x5374;&#x662F;&#x5927;&#x5BB6;&#x521A;&#x63A5;&#x89E6; shader &#x65F6;&#x89C9;&#x5F97;&#x5F88;&#x62BD;&#x8C61;&#x4E0D;&#x597D;&#x7406;&#x89E3;&#x7684;&#x539F;&#x56E0;&#x4E4B;&#x4E00;&#xFF0C;&#x4E5F;&#x662F;&#x53E4;&#x67F3;&#x521A;&#x5F00;&#x59CB;&#x5165;&#x95E8;&#x65F6;&#x89C9;&#x5F97;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x5207;&#x5165;&#x70B9;&#xFF0C;&#x540E;&#x7EED;&#x8BB2;&#x5230;&#x5177;&#x4F53;&#x4F8B;&#x5B50;&#x65F6;&#x4F1A;&#x518D;&#x63D0;&#xFF0C;&#x8FD9;&#x91CC;&#x5927;&#x5BB6;&#x8FD8;&#x4E00;&#x5934;&#x96FE;&#x6C34;&#x4E5F;&#x6CA1;&#x4E8B;&#x3002;</p>
<p>shader &#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x5355;&#x72EC;&#x5199;&#x5728;&#x8BF8;&#x5982; <code>vertex.glsl</code>&#x3001;<code>fragment.glsl</code> &#x7684;&#x6587;&#x4EF6;&#x91CC;&#x518D;&#x5BFC;&#x5165;&#x4F7F;&#x7528;&#xFF1B;&#x4E5F;&#x53EF;&#x4EE5;&#x548C;&#x793A;&#x4F8B;&#x4E00;&#x6837;&#x76F4;&#x63A5;&#x5728; JavaScript &#x91CC;&#x7528;&#x5B57;&#x7B26;&#x4E32;&#x683C;&#x5F0F;&#x8868;&#x793A;&#x3002;&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x8BB2;&#x89E3;&#x65B9;&#x4FBF;&#x91C7;&#x53D6;&#x540E;&#x8005;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x9700;&#x8981;&#x8BBE;&#x7F6E; <code>gl_Position</code> &#x9876;&#x70B9;&#x4F4D;&#x7F6E;&#xFF0C;&#x5728;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#x91CC;&#x9700;&#x8981;&#x8BBE;&#x7F6E; <code>gl_FragColor</code> &#x7247;&#x5143;/&#x50CF;&#x7D20;&#x989C;&#x8272;&#xFF0C;&#x4E24;&#x8005;&#x90FD;&#x5728;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x7684; <code>void main() {}</code> &#x4E3B;&#x51FD;&#x6570;&#x91CC;&#x8BBE;&#x7F6E;&#xFF0C;&#x5E76;&#x4E14; main &#x51FD;&#x6570;&#x4F1A;&#x88AB;&#x81EA;&#x52A8;&#x6267;&#x884C;&#x3002;&#x5728;&#x540E;&#x7EED;&#x5F88;&#x591A;&#x4F8B;&#x5B50;&#x91CC;&#x6211;&#x4EEC;&#x90FD;&#x53EA;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x8FD9;&#x4FE9;&#x5185;&#x7F6E;&#x53D8;&#x91CF;&#x7684;&#x503C;&#xFF0C;&#x53EA;&#x6709;&#x7B49;&#x4ECB;&#x7ECD;&#x7C92;&#x5B50;&#x7CFB;&#x7EDF;&#x65F6;&#x624D;&#x4F1A;&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x53E6;&#x5916;&#x8BBE;&#x7F6E; <code>gl_PointSize</code> &#x7C92;&#x5B50;&#x5927;&#x5C0F;&#x3002;</p>
<h2 id="Vertex-Shader"><a href="#Vertex-Shader" class="headerlink" title="Vertex Shader"></a>Vertex Shader</h2><p>&#x4E00;&#x822C;&#x7684;&#x6559;&#x7A0B;&#x4F1A;&#x5148;&#x8BB2;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#xFF0C;&#x5148;&#x4E0D;&#x53BB;&#x6539;&#x53D8;&#x9876;&#x70B9;&#x3001;&#x6539;&#x53D8;&#x4E09;&#x7EF4;&#x7269;&#x4F53;&#x5F62;&#x72B6;&#xFF0C;&#x6BD5;&#x7ADF;&#x5148;&#x628A;&#x53E6;&#x4E00;&#x4E2A;&#x653E;&#x4E00;&#x8FB9;&#x8BB2;&#x8D77;&#x6765;&#x66F4;&#x65B9;&#x4FBF;&#xFF0C;&#x800C;&#x8BBE;&#x7F6E;&#x989C;&#x8272;&#x76F8;&#x5BF9;&#x597D;&#x8BB2;&#x4E9B;&#x3002;&#x4F46;&#x5373;&#x4F7F;&#x5982;&#x6B64;&#xFF0C;&#x8981;&#x786E;&#x4FDD; Three.js Shader &#x91CC;&#x4EE3;&#x7801;&#x5B8C;&#x6574;&#x6027;&#xFF0C;&#x6700;&#x7B80;&#x5355;&#x7684;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x4E5F;&#x8981;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E00;&#x4E32;&#x4E1C;&#x897F;&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x4E09;&#x7EF4;&#x7A7A;&#x95F4;&#x7684;&#x7269;&#x4F53;&#x5448;&#x73B0;&#x5728;&#x4E8C;&#x7EF4;&#x5C4F;&#x5E55;&#x4E0A;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    // gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0);</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x91CC;&#x867D;&#x7136;&#x5C31;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x4F46;&#x80CC;&#x540E;&#x539F;&#x7406;&#x9700;&#x8981;&#x4E00;&#x6574;&#x7BC7;&#x6587;&#x7AE0;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;&#xFF0C;&#x6B64;&#x5904;&#x7F57;&#x5217;&#x4E86;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x4EC5;&#x4F9B;&#x53C2;&#x8003;&#xFF0C;&#x7531;&#x4E8E;&#x6D89;&#x53CA;&#x4E0D;&#x5C11;&#x56FE;&#x5F62;&#x5B66;&#x77E5;&#x8BC6;&#xFF0C;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x76EE;&#x524D;&#x8FD8;&#x4E0D;&#x7406;&#x89E3;&#xFF0C;&#x4E5F;&#x4E0D;&#x91CD;&#x8981;&#xFF0C;&#x53EA;&#x9700;&#x77E5;&#x9053;&#x5FC5;&#x987B;&#x8FD9;&#x6837;&#x56FA;&#x5B9A;&#x8BBE;&#x7F6E;&#x624D;&#x80FD;&#x663E;&#x793A;&#xFF0C;&#x770B;&#x5B8C;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x521D;&#x6B65;&#x4E86;&#x89E3;&#x540E;&#x8DF3;&#x5230; GLSL &#x57FA;&#x7840;&#x8BB2;&#x89E3;&#x4E0E;&#x7247;&#x5143;&#x7740;&#x8272;&#x5668;&#x5B66;&#x4E60;&#x989C;&#x8272;&#x8BBE;&#x7F6E;&#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/ac63cb31da9891bef95b58d1e988994b.html" target="blank" rel="noopener">&#x4ECE;&#x96F6;&#x5F00;&#x59CB;&#x5B66;&#x56FE;&#x5F62;&#x5B66;&#xFF1A;MVP Transformation</a></li>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/86fadecd4c1a5d0c080db8fbcdd8d759.html" target="blank" rel="noopener">&#x56FE;&#x5F62;&#x5B66;&#xFF1A;MVP&#x53D8;&#x6362;&#x6982;&#x8FF0;</a></li>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/40c4babdf47fda76137c097414eedbad.html" target="blank" rel="noopener">&#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66; 5&#xFF1A;&#x9F50;&#x6B21;&#x5750;&#x6807;&#x4E0E; MVP &#x77E9;&#x9635;&#x53D8;&#x6362;</a></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/90e6cad1934f51dabfd3a07476b2f5c2611871374e0044d43329530a55102b5c" alt></p>
<p>&#x867D;&#x7136;&#x89E3;&#x91CA;&#x8D77;&#x6765;&#x5F88;&#x4E3A;&#x96BE;&#xFF0C;&#x4F46;&#x53E4;&#x67F3;&#x8FD8;&#x662F;&#x7B80;&#x5355;&#x8BB2;&#x4E0B;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; <code>position</code> &#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;&#x51E0;&#x4F55;&#x4F53; attributes &#x91CC;&#x5404;&#x9876;&#x70B9;&#x7684;&#x5750;&#x6807;&#xFF0C;&#x5B83;&#x662F;&#x4E09;&#x7EF4;&#x5411;&#x91CF;&#x7C7B;&#x578B; <code>vec3</code>&#xFF0C;&#x9700;&#x8981;&#x5148;&#x53D8;&#x6210; <code>vec4</code> &#x56DB;&#x7EF4;&#x5411;&#x91CF;&#x7C7B;&#x578B;&#x2014;&#x2014;&#x5373;(x, y, z, w)4&#x4E2A;&#x5206;&#x91CF;&#x7684;&#x683C;&#x5F0F;&#x2014;&#x2014;&#x56E0;&#x4E3A;&#x6709;&#x4E86;&#x7B2C;4&#x4E2A;&#x503C; w=1.0 &#x624D;&#x80FD;&#x8FDB;&#x884C;&#x77E9;&#x9635;&#x64CD;&#x4F5C;&#xFF0C;&#x5B9E;&#x73B0;&#x65CB;&#x8F6C;&#x3001;&#x5E73;&#x79FB;&#x3001;&#x7F29;&#x653E;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>modelMatrix</code> &#x6A21;&#x578B;&#x77E9;&#x9635;&#x5C06;&#x539F;&#x672C;&#x6A21;&#x578B;&#x4EE5;&#x81EA;&#x8EAB;&#x672C;&#x5730;&#x5750;&#x6807;&#x5B9A;&#x4F4D;&#x7684;&#x65B9;&#x5F0F;&#x53D8;&#x6210;&#x4E16;&#x754C;&#x5750;&#x6807;&#x91CC;&#x9002;&#x5F53;&#x7684;&#x4F4D;&#x7F6E;&#x548C;&#x5927;&#x5C0F;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x60F3;&#x8981;&#x7684;&#x573A;&#x666F;&#x5E03;&#x5C40;&#xFF1B;&#x573A;&#x666F;&#x6709;&#x4E86;&#xFF0C;&#x76F8;&#x673A;&#x4F4D;&#x7F6E;&#x3001;&#x89C6;&#x89D2;&#x7684;&#x4E0D;&#x540C;&#x770B;&#x5230;&#x7684;&#x753B;&#x9762;&#x4E5F;&#x4F1A;&#x4E0D;&#x540C;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>viewMatrix</code> &#x89C6;&#x56FE;&#x77E9;&#x9635;&#x5B9E;&#x73B0;&#x7269;&#x4F53;&#x57FA;&#x4E8E;&#x76F8;&#x673A;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x524D;&#x4E24;&#x8005;&#x53EF;&#x4EE5;&#x7B80;&#x5199;&#x6210; <code>modelViewMartix</code>&#xFF0C;&#x6700;&#x540E;&#x518D;&#x901A;&#x8FC7;&#x4E58;&#x4EE5; <code>projectionMatrix</code> &#x6295;&#x5F71;&#x77E9;&#x9635;&#x53D8;&#x6362;&#x5230;&#x526A;&#x88C1;&#x7A7A;&#x95F4;&#xFF0C;&#x6700;&#x7EC8;&#x53D8;&#x6210;&#x4E8C;&#x7EF4;&#x5C4F;&#x5E55;&#x4E0A;&#x6E32;&#x67D3;&#x51FA;&#x6765;&#x7684;&#x6548;&#x679C;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x5728; b &#x7AD9;&#x770B;&#x72B9;&#x4ED6;&#x5927;&#x5B66;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66;&#x8BFE;&#x7A0B;&#xFF0C;&#x611F;&#x89C9;&#x8FD9;&#x90E8;&#x5206;&#x8BFE;&#x4EF6;&#x5F88;&#x76F4;&#x89C2;&#x3002;&#x4E00;&#x5F00;&#x59CB;&#x6905;&#x5B50;&#x3001;&#x684C;&#x5B50;&#x7B49;&#x4E09;&#x7EF4;&#x7269;&#x4F53;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x81EA;&#x8EAB;&#x4E2D;&#x5FC3;&#x6765;&#x653E;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x5E73;&#x79FB;&#x3001;&#x7F29;&#x653E;&#x3001;&#x65CB;&#x8F6C;&#x7B49;&#x6A21;&#x578B;&#x53D8;&#x6362;&#x6784;&#x5EFA;&#x51FA;&#x5408;&#x9002;&#x7684;&#x573A;&#x666F;&#x4E16;&#x754C;&#x91CC;&#x7684;&#x5E03;&#x5C40;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x7684;&#x76F8;&#x673A;&#x770B;&#x5230;&#x7279;&#x5B9A;&#x7684;&#x753B;&#x9762;&#xFF0C;&#x6700;&#x540E;&#x518D;&#x6E32;&#x67D3;&#x5230;&#x753B;&#x9762;&#x91CC;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/44567b86f56efcf074ba66ae9e1ba63d.html" target="blank" rel="noopener">2020&#x5E74; &#x79CB; &#x72B9;&#x4ED6;&#x5927;&#x5B66; &#x8BA1;&#x7B97;&#x673A;&#x56FE;&#x5F62;&#x5B66;&#x8BFE;&#x7A0B;&#xFF08;&#x4E2D;&#x82F1;&#x5B57;&#x5E55;&#xFF09;</a></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/6237af06e46942fb941140ad6aaaeb90ddbe7125818d0f268fa2738d125b10da" alt></p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x53D8;&#x91CF; <code>modelViewMatrix</code>&#x3001;<code>projectionMatrix</code> &#x548C;&#x5C5E;&#x6027; <code>position</code> &#x90FD;&#x662F; ShaderMaterial &#x91CC;&#x5185;&#x7F6E;&#x7684;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x62FF;&#x6765;&#x7528;&#xFF0C;&#x5DF2;&#x7ECF;&#x5E2E;&#x6211;&#x4EEC;&#x58F0;&#x660E;&#x597D;&#x4E86;&#xFF0C;&#x9876;&#x70B9;&#x4E0A;&#x7684; uv&#x3001;normal &#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x9876;&#x70B9;&#x7740;&#x8272;&#x5668;&#x91CC;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#xFF1B;&#x5047;&#x5982;&#x6362;&#x6210; RawShaderMaterial &#x5C31;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x58F0;&#x660E;&#x540E;&#x624D;&#x80FD;&#x7528;&#xFF0C;&#x5F53;&#x7136;&#x76EE;&#x524D;&#x53E4;&#x67F3;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x5230;&#x8FC7;&#x76F4;&#x63A5;&#x7528; RawShaderMaterial &#x7684;&#x3002;&#x5176;&#x4ED6;&#x5185;&#x7F6E;&#x53D8;&#x91CF;&#x548C;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x7BC7;&#x6587;&#x6863;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/8eface4fa5365e60f9ad6ede737524a8.html" target="blank" rel="noopener">WebGLProgram - Three.js</a></li>
</ul>
<h2 id="GLSL-&#x8BED;&#x8A00;&#x57FA;&#x7840;"><a href="#GLSL-&#x8BED;&#x8A00;&#x57FA;&#x7840;" class="headerlink" title="GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;"></a>GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;</h2><p>&#x5728;&#x5F00;&#x59CB;&#x8BB2; fragment shader &#x91CC;&#x5982;&#x4F55;&#x7ED9;&#x7247;&#x5143;/&#x50CF;&#x7D20;&#x8D4B;&#x989C;&#x8272;&#x503C;&#x4E4B;&#x524D;&#xFF0C;&#x6709;&#x5FC5;&#x8981;&#x5148;&#x8BB2;&#x4E0B; GLSL &#x8BED;&#x8A00;&#x57FA;&#x7840;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x770B;&#x672C;&#x6587;&#x65F6;&#x4E5F;&#x8DDF;&#x7740;&#x6572;&#x4E86;&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x4E14;&#x201C;&#x81EA;&#x4F5C;&#x806A;&#x660E;&#x201D;&#x5730;&#x7701;&#x7565;&#x4E86; GLSL &#x6BCF;&#x884C;&#x8BED;&#x53E5;&#x6700;&#x540E;&#x7684;<code>&#x5206;&#x53F7;;</code>&#xFF0C;&#x6216;&#x8005;&#x628A; float &#x6D6E;&#x70B9;&#x6570;0.0&#x3001;1.0&#x5077;&#x61D2;&#x5199;&#x6210;&#x4E86;&#x6574;&#x578B; 0&#x3001;1&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x753B;&#x9762;&#x91CC;&#x7684;&#x7269;&#x4F53;&#x65E0;&#x6CD5;&#x663E;&#x793A;&#x3001;&#x63A7;&#x5236;&#x53F0;&#x6709;&#x62A5;&#x9519;&#xFF0C;&#x56E0;&#x4E3A; GLSL &#x91CC;&#x8FD9;&#x4E24;&#x70B9;&#x662F;&#x5F88;&#x4E25;&#x683C;&#x7684;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x5927;&#x5BB6;&#x4E0D;&#x8BBA;&#x521A;&#x5165;&#x95E8; Shader&#x3001;&#x8FD8;&#x662F;&#x540E;&#x7EED;&#x7F16;&#x5199; Shader &#x8FC7;&#x7A0B;&#x4E2D;&#x4E00;&#x4E0D;&#x5C0F;&#x5FC3;&#x5C31;&#x975E;&#x5E38;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x52A1;&#x5FC5;&#x7262;&#x8BB0;&#x5728;&#x5FC3;&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x53E4;&#x67F3;&#x521A;&#x6D4B;&#x8BD5;&#x4E86;&#x4E0B;&#xFF0C;&#x8FD9;&#x51E0;&#x5904;&#x6570;&#x5B57;&#x73B0;&#x5728;&#x5199;&#x6210;&#x6574;&#x6570;&#x4E5F;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#x4E86;&#xFF0C;&#x8BB0;&#x5F97;&#x4EE5;&#x524D;&#x662F;&#x4F1A;&#x62A5;&#x9519;&#x7684;&#xFF0C;&#x800C;&#x4E14;&#x5927;&#x5BB6;&#x770B;&#x7F51;&#x4E0A;&#x5176;&#x4ED6;&#x6559;&#x7A0B;&#x5927;&#x591A;&#x90FD;&#x662F;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x867D;&#x7136;&#x53EF;&#x80FD;&#x5411;&#x91CF;&#x7C7B;&#x578B; vec &#x91CC;&#x652F;&#x6301;&#x6574;&#x6570;&#x4E86;&#xFF0C;&#x4F46;&#x540E;&#x7EED;&#x6559;&#x7A0B;&#x91CC;&#x53E4;&#x67F3;&#x53EF;&#x80FD;&#x8FD8;&#x662F;&#x4F1A;&#x5EF6;&#x7EED;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x5199;&#x6CD5;&#xFF0C;&#x8FD9;&#x70B9;&#x9700;&#x8981;&#x5927;&#x5BB6;&#x6CE8;&#x610F;&#x4E0B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const vertex = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p>GLSL &#x91CC;&#x53D8;&#x91CF;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x6709;&#x6D6E;&#x70B9;&#x6570; float&#x3001;&#x6574;&#x578B; int&#x3001;&#x5E03;&#x5C14;&#x578B; bool&#xFF0C;&#x4F46;&#x4EE5;&#x53E4;&#x67F3;&#x76EE;&#x524D;&#x63A5;&#x89E6;&#x8FC7;&#x7684;&#x4EE3;&#x7801;&#x91CC;&#xFF0C;&#x6D6E;&#x70B9;&#x6570;&#x7684;&#x4F7F;&#x7528;&#x8FDC;&#x8FDC;&#x591A;&#x4E8E;&#x540E;&#x4E24;&#x8005;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;float alpha = 0.5;</span><br><span class="line">int num = 10;</span><br><span class="line">bool flag = true;</span><br></pre></td></tr></table></figure>

<p>&#x53E6;&#x5916;&#x8FD8;&#x6709; vec &#x5411;&#x91CF;&#x7C7B;&#x578B;&#x7CFB;&#x5217;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E8C;&#x7EF4;&#x5411;&#x91CF; vec2&#x3001;&#x4E09;&#x7EF4;&#x5411;&#x91CF; vec3&#x3001;&#x56DB;&#x7EF4;&#x5411;&#x91CF; vec4&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x522B;&#x770B;&#x6210;&#x7531; (x,y)&#x3001;(x,y,z)&#x6216;(r,g,b)&#x3001;(x,y,z,w)&#x6216;(r,g,b,a) &#x7B49;&#x5206;&#x91CF;&#x7EC4;&#x6210;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x50CF;&#x4E0B;&#x9762;&#x4EE3;&#x7801;&#x91CC;&#x4E00;&#x6837;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x6216;&#x4FEE;&#x6539;&#x5BF9;&#x5E94;&#x5206;&#x91CF;&#x6570;&#x503C;&#xFF1B;&#x5F53;&#x5206;&#x91CF;&#x7684;&#x503C;&#x90FD;&#x4E00;&#x6837;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x53EA;&#x5199;&#x4E00;&#x4E2A;&#x503C;&#xFF1B;&#x5411;&#x91CF;&#x4E4B;&#x95F4;&#x6216;&#x5411;&#x91CF;&#x4E0E;&#x6D6E;&#x70B9;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x52A0;&#x51CF;&#x4E58;&#x9664;&#x56DB;&#x5219;&#x8FD0;&#x7B97;&#xFF0C;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x6BCF;&#x4E2A;&#x5206;&#x91CF;&#x5355;&#x72EC;&#x8BA1;&#x7B97;&#x7684;&#x3002;</p>
<p>&#x53E6;&#x5916; vec3 &#x53EF;&#x4EE5;&#x7531; vec2+float &#x521B;&#x5EFA;&#x3001;vec4 &#x53EF;&#x4EE5;&#x7531; vec3+float&#x3001;vec2+vec2 &#x7B49;&#x4E0D;&#x540C;&#x65B9;&#x5F0F;&#x521B;&#x5EFA;&#xFF0C;&#x6BD4;&#x8F83;&#x7075;&#x6D3B;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">C&#x590D;&#x5236;&#x4EE3;&#x7801;vec2 a = vec2(1.0, 0.0);</span><br><span class="line">// a.x=1.0 a.y=0.0</span><br><span class="line">a.x = 2.0;</span><br><span class="line">a.y = 0.5;</span><br><span class="line"></span><br><span class="line">vec2 a = vec2(1.0);</span><br><span class="line">// a.x=1.0 a.y=1.0</span><br><span class="line"></span><br><span class="line">// &#x5411;&#x91CF;&#x4E4B;&#x95F4;&#x6216;&#x5411;&#x91CF;&#x4E0E;&#x6D6E;&#x70B9;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x52A0;&#x51CF;&#x4E58;&#x9664;&#x56DB;&#x5219;&#x8FD0;&#x7B97;&#x662F;&#x57FA;&#x4E8E;&#x6BCF;&#x4E2A;&#x5206;&#x91CF;&#x5355;&#x72EC;&#x8BA1;&#x7B97;</span><br><span class="line">vec2 a = vec2(1.0) + vec2(0.1, 0.2);</span><br><span class="line">// a.x=1.1 a.y=1.2</span><br><span class="line">vec2 a = vec2(1.0) * 2.0;</span><br><span class="line">// a.x=2.0 a.y=2.0</span><br><span class="line"></span><br><span class="line">vec3 b = vec3(1.0, 2.0, 0.0);</span><br><span class="line">// b.x=1.0 b.y=2.0 b.z=0.0</span><br><span class="line">// b.r=1.0 b.g=2.0 b.b=0.0</span><br><span class="line">b.z = 3.0;</span><br><span class="line"></span><br><span class="line">vec4 c = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">// c.x=c.y=c.z=c.w=1.0</span><br><span class="line">// c.r=c.g=c.b=c.a=1.0</span><br><span class="line">c.r = 0.9</span><br><span class="line">c.g = 0.0;</span><br><span class="line">c.b = 0.0;</span><br><span class="line"></span><br><span class="line">vec3 d = vec3(vec2(0.5), 1.0);</span><br><span class="line">vec4 e = vec4(vec3(1.0), 1.0);</span><br><span class="line">vec4 e = vec4(vec2(0.3), vec2(0.1));</span><br></pre></td></tr></table></figure>

<p>vec3(1.0) &#x65E2;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F; x=y=z=1.0 &#x5904;&#x7684;&#x5750;&#x6807;&#x70B9;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F;&#x4ECE;&#x539F;&#x70B9;&#x6307;&#x5411;&#x8BE5;&#x70B9;&#x7684;&#x5411;&#x91CF;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F; r=g=b=1.0 &#x4E5F;&#x5C31;&#x662F;&#x767D;&#x8272;&#x989C;&#x8272;&#xFF0C;&#x6CE8;&#x610F;&#x5728; <strong>GLSL &#x91CC; rgb &#x8303;&#x56F4;&#x90FD;&#x662F; 0.0-1.0</strong>&#xFF0C;&#x800C;&#x975E;&#x4E00;&#x822C;&#x7684; 0-255&#x3002;&#x9ED1;&#x8272;&#x4E3A;(0.0,0.0,0.0)&#x3001;&#x767D;&#x8272;&#x4E3A;(1.0,1.0,1.0)&#x3001;&#x7EA2;&#x8272;&#x4E3A;(1.0,0.0,0.0)&#x2026;&#x2026;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x7684;&#x989C;&#x8272;&#x503C;&#x5C0F;&#x4E8E;0.0&#x4F1A;&#x88AB;&#x622A;&#x53D6;&#x5230;0.0&#xFF0C;&#x5927;&#x4E8E;1.0&#x4F1A;&#x88AB;&#x622A;&#x53D6;&#x5230;1.0&#x3002;</p>
<p>&#x53E6;&#x5916; GLSL &#x91CC;&#x7684;&#x51FD;&#x6570;&#x9700;&#x8981;&#x4EE5;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x7C7B;&#x578B;&#x5F00;&#x5934;&#xFF0C;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x5C31;&#x5982;&#x540C; main &#x4E3B;&#x51FD;&#x6570;&#x4E00;&#x6837;&#x4EE5; void &#x5F00;&#x5934;&#xFF0C;&#x51FD;&#x6570;&#x91CC;&#x6709;&#x53C2;&#x6570;&#x7684;&#x9700;&#x8981;&#x5199;&#x660E;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1B;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x3001;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x3001;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#x7B49;&#x4E0D;&#x540C;&#x7684;&#x540C;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x5B58;&#x5728;&#x4EE5;&#x5B9E;&#x73B0;&#x7C7B;&#x4F3C;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x51FD;&#x6570;&#x91CD;&#x8F7D;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x91CC;&#x865A;&#x6784;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x652F;&#x6301;&#x4F20;&#x5165;&#x4E0D;&#x540C;&#x683C;&#x5F0F;&#x7684; rgb &#x989C;&#x8272;&#x6570;&#x503C;&#x4EE5;&#x5F97;&#x5230; hsl &#x989C;&#x8272;&#x683C;&#x5F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;vec3 rgb2hsl(float r, float g, float b){</span><br><span class="line">  return vec3(1.0, 1.0, 1.0);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vec3 rgb2hsl(vec3 color){</span><br><span class="line">  return vec3(1.0, 1.0, 1.0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="Fragment-Shader"><a href="#Fragment-Shader" class="headerlink" title="Fragment Shader"></a>Fragment Shader</h2><p>&#x6709;&#x4E86;&#x524D;&#x9762;&#x8FD9;&#x4E9B; GLSL &#x57FA;&#x7840;&#xFF0C;&#x56DE;&#x8FC7;&#x5934;&#x770B; fragment shader &#x91CC;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x60F3;&#x6765;&#x5927;&#x5BB6;&#x5E94;&#x8BE5;&#x6CA1;&#x4EC0;&#x4E48;&#x7591;&#x95EE;&#x4E86;&#x5427;&#x3002;</p>
<p>&#x8BBE;&#x7F6E; gl_FragColor &#x4E3A; vec4(1.0, 0.0, 0.0, 1.0) &#x5C31;&#x662F;&#x8BBE;&#x7F6E;&#x7EA2;&#x8272;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4F1A;&#x901A;&#x8FC7; GPU &#x5BF9;&#x6240;&#x6709; plane &#x4E0A;&#x7684;&#x50CF;&#x7D20;&#x6267;&#x884C;&#xFF0C;&#x4E8E;&#x662F;&#x5448;&#x73B0;&#x51FA;&#x6765;&#x7684;&#x5C31;&#x662F;&#x7EA2;&#x8272;&#x7684;&#x5E73;&#x9762;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const fragment = `</span><br><span class="line">  void main() {</span><br><span class="line">    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);</span><br><span class="line">  }</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/a9774fbde2b63271cd65ee1a3a8ddf03397127247c464a40ecaa268164012fff" alt></p>
<h2 id="&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;"><a href="#&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;" class="headerlink" title="&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;"></a>&#x4E0B;&#x7BC7;&#x5185;&#x5BB9;&#x66F4;&#x7CBE;&#x5F69;</h2><p>&#x539F;&#x672C;&#x60F3;&#x7EE7;&#x7EED;&#x4EE5; uv &#x4E3A;&#x5207;&#x5165;&#x70B9;&#xFF0C;&#x8BB2;&#x8BB2;&#x5C06;&#x5176;&#x76F4;&#x63A5;&#x7528;&#x4E8E; fragment shader &#x91CC;&#x4F5C;&#x4E3A;&#x989C;&#x8272;&#xFF0C;&#x5E76;&#x7ED3;&#x5408; GLSL &#x7684;&#x4E00;&#x4E9B;&#x5185;&#x7F6E;&#x51FD;&#x6570;&#x4EE5;&#x751F;&#x6210;&#x91CD;&#x590D;&#x7684;&#x6761;&#x7EB9;&#x3001;&#x91CD;&#x590D;&#x7684;&#x5706;&#x5708;&#x7B49;&#x6548;&#x679C;&#xFF0C;&#x4F46;&#x4E00;&#x4E9B;&#x5FC5;&#x8981;&#x4ECB;&#x7ECD;&#x4E00;&#x5199;&#x8D77;&#x6765;&#x7BC7;&#x5E45;&#x5C31;&#x5197;&#x957F;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x8FD8;&#x6CA1;&#x6765;&#x53CA;&#x8BB2;&#x7684;&#x5185;&#x5BB9;&#x53EA;&#x80FD;&#x7559;&#x5230;&#x4E0B;&#x4E00;&#x7BC7;&#x7EE7;&#x7EED;&#xFF0C;&#x8FD9;&#x91CC;&#x5148;&#x7ED9;&#x5927;&#x5BB6;&#x770B;&#x770B;&#x65E9;&#x5C31;&#x751F;&#x6210;&#x7684;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x914D;&#x56FE;&#x5C1D;&#x5C1D;&#x9C9C;&#xFF08;&#x5F53;&#x7136;&#x670B;&#x53CB;&#x5708;&#x548C;&#x7FA4;&#x91CC;&#x65E9;&#x5C31;&#x653E;&#x51FA;&#x53BB;&#x4E86;&#xFF0C;&#x4E5F;&#x6B22;&#x8FCE;&#x65B0;&#x670B;&#x53CB;&#x6765;&#x56F4;&#x89C2;&#x4E0E;&#x4EA4;&#x6D41;&#xFF09;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p3/raw/master/img/e6347d7b1757b748da57f4d6e04164f05a3ce6e59b7afe4f71e5c9f74555f424" alt></p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x672C;&#x6587;&#x53EA;&#x8BB2;&#x4E86;&#x4E9B;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x76EE;&#x524D;&#x5927;&#x5BB6;&#x9700;&#x8981;&#x77E5;&#x9053;&#x7684; GLSL &#x57FA;&#x7840;&#xFF0C;&#x6709;&#x610F;&#x4E0D;&#x5199;&#x6210;&#x5927;&#x800C;&#x5168;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x53EA;&#x6D89;&#x53CA;&#x5F53;&#x524D;&#x591F;&#x7528;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x540E;&#x9762;&#x7B49;&#x8BB2;&#x5230;&#x5176;&#x4ED6;&#x4F8B;&#x5B50;&#x65F6;&#x518D;&#x4E00;&#x6B65;&#x6B65;&#x5E26;&#x51FA;&#x6765;&#x66F4;&#x591A;&#x5185;&#x5BB9;&#x3002;&#x5F53;&#x7136;&#x5982;&#x6587;&#x7AE0;&#x5F00;&#x5934;&#x6240;&#x8A00;&#xFF0C;&#x8BB2;&#x89E3;&#x5730;&#x53EF;&#x80FD;&#x4ECD;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x4E86;&#x89E3;&#x66F4;&#x591A; GLSL &#x57FA;&#x7840;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x53E4;&#x67F3;&#x89C9;&#x5F97;&#x8FD8;&#x4E0D;&#x9519;&#x3002;</p>
<ul>
<li>&#x94FE;&#x63A5;&#xFF1A;<a href="https://dev.newban.cn/7158032481302609950">Three.js &#x8FDB;&#x9636;&#x4E4B;&#x65C5;&#xFF1A;Shader&#x7740;&#x8272;&#x5668;&#x5165;&#x95E8;</a></li>
</ul>
<h2 id="&#x7167;&#x4F8B;"><a href="#&#x7167;&#x4F8B;" class="headerlink" title="&#x7167;&#x4F8B;"></a>&#x7167;&#x4F8B;</h2><p>&#x6700;&#x540E;&#x6B22;&#x8FCE;&#x52A0;&#x5165;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x4EA4;&#x6D41;&#x7FA4;&#x300D;</code>&#xFF0C;&#x8FDB;&#x7FA4;&#x591A;&#x591A;&#x4EA4;&#x6D41;&#xFF0C;&#x5BF9;&#x672C;&#x6587;&#x4EFB;&#x4F55;&#x5730;&#x65B9;&#x6709;&#x7591;&#x60D1;&#x7684;&#x53EF;&#x4EE5;&#x7FA4;&#x91CC;&#x63D0;&#x95EE;&#x3002;&#x52A0;&#x53E4;&#x67F3;&#x5FAE;&#x4FE1;&#xFF1A;<code>xiaoaizhj</code>&#xFF0C;&#x5907;&#x6CE8;<code>&#x300C;&#x53EF;&#x89C6;&#x5316;&#x52A0;&#x7FA4;&#x300D;</code>&#x5373;&#x53EF;&#x3002;</p>
<p>&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#x53E4;&#x67F3;&#x7684;&#x516C;&#x4F17;&#x53F7;<code>&#x300C;&#x725B;&#x8863;&#x53E4;&#x67F3;&#x300D;</code>&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x661F;&#x6807;&#xFF0C;&#x4EE5;&#x4FBF;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x6536;&#x5230;&#x66F4;&#x65B0;&#x3002;</p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/e5c6edad625b0946ccf95ed3469deef0.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7232164444985622588.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7232164444985622588.html" itemprop="url">Flutter 310 之 Flutter Web 路线已</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-12T14:50:32+08:00">
                2023-05-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&#x968F;&#x7740; <a href="https://dev.newban.cn/7231565908631633979">Flutter 3.10 &#x53D1;&#x5E03;</a>&#xFF0C;Flutter Web &#x4E5F;&#x5F15;&#x6765;&#x4E86;&#x5B83;&#x6700;&#x5177;&#x6709;&#x300C;&#x91CC;&#x7A0B;&#x7891;&#x300D;&#x610F;&#x4E49;&#x7684;&#x66F4;&#x65B0;&#xFF0C;<strong>&#x8FD9;&#x91CC;&#x7684;&#x300C;&#x91CC;&#x7A0B;&#x7891;&#x300D;&#x4E0D;&#x662F;&#x8BF4;&#x8FD9;&#x6B21; Flutter Web &#x6709;&#x591A;&#x4E48;&#x91CD;&#x5927;&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x800C;&#x662F; Flutter &#x5B98;&#x65B9;&#x5BF9;&#x4E8E; Web &#x7EC8;&#x4E8E;&#x6709;&#x4E86;&#x660E;&#x786E;&#x7684;&#x5B9A;&#x4F4D;&#x548C;&#x65B9;&#x5411;</strong>&#x3002;</p>
<h1 id="&#x63D0;&#x5347;"><a href="#&#x63D0;&#x5347;" class="headerlink" title="&#x63D0;&#x5347;"></a>&#x63D0;&#x5347;</h1><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x804A;&#x63D0;&#x5347;&#xFF0C;&#x8FD9;&#x4E0D;&#x662F;&#x672C;&#x7BC7;&#x7684;&#x91CD;&#x70B9;&#xFF0C;&#x53EA;&#x662F;&#x987A;&#x5E26;&#x3002;</p>
<p>&#x672C;&#x6B21;&#x63D0;&#x5347;&#x4E3B;&#x8981;&#x5728;&#x4E8E;&#x4E24;&#x4E2A;&#x5927;&#x70B9;&#xFF1A;<strong>Element &#x5D4C;&#x5165;&#x652F;&#x6301;&#x548C; fragment shaders &#x652F;&#x6301;</strong> &#x3002;</p>
<p>&#x9996;&#x5148;&#x662F; Element &#x5D4C;&#x5165;&#xFF0C;<strong>Flutter 3.10 &#x5F00;&#x59CB;&#xFF0C;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x5C06; Flutter Web&#x5D4C;&#x5165;&#x5230;&#x7F51;&#x9875;&#x7684;&#x4EFB;&#x4F55; HTML &#x5143;&#x7D20;&#x4E2D;&#xFF0C;&#x5E76;&#x5E26;&#x6709; <code>flutter.js</code> &#x5F15;&#x64CE;&#x548C; <code>hostElement</code> &#x521D;&#x59CB;&#x5316;&#x53C2;&#x6570;</strong>&#x3002;</p>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#x4E0D;&#x9700;&#x8981; <code>iframe</code> &#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x901A;&#x8FC7; <code>initializeEngine</code> &#x7684; <code>hostElement</code> &#x53C2;&#x6570;&#x5C31;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x5D4C;&#x5165;&#x7684;&#x5143;&#x7D20;&#xFF0C;<strong>&#x7075;&#x6D3B;&#x5EA6;&#x652F;&#x6301;&#x5F97;&#x5230;&#x4E86;&#x63D0;&#x9AD8;</strong>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;html&gt;</span><br><span class="line">&#xA0;&lt;head&gt;</span><br><span class="line">&#xA0; &#xA0;&lt;!-- ... --&gt;</span><br><span class="line">&#xA0; &#xA0;&lt;script&#xA0;src=&quot;flutter.js&quot;&#xA0;defer&gt;&lt;/script&gt;</span><br><span class="line">&#xA0;&lt;/head&gt;</span><br><span class="line">&#xA0;&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0;&lt;!-- Ensure your flutter target is present on the page... --&gt;</span><br><span class="line">&#xA0; &#xA0;&lt;div&#xA0;id=&quot;flutter_host&quot;&gt;Loading...&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0;&lt;script&gt;</span><br><span class="line">&#xA0; &#xA0; &#xA0;window.addEventListener(&quot;load&quot;,&#xA0;function&#xA0;(ev) {</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0;_flutter.loader.loadEntrypoint({</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0;onEntrypointLoaded:&#xA0;async&#xA0;function(engineInitializer) {</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;let&#xA0;appRunner&#xA0;=&#xA0;await&#xA0;engineInitializer.initializeEngine({</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;// Pass a reference to &quot;div#flutter_host&quot; into the Flutter engine.</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;hostElement:&#xA0;document.querySelector(&quot;#flutter_host&quot;)</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; });</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;await&#xA0;appRunner.runApp();</span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; }</span><br><span class="line">&#xA0; &#xA0; &#xA0; });</span><br><span class="line">&#xA0; &#xA0; });</span><br><span class="line">&#xA0; &#xA0;&lt;/script&gt;</span><br><span class="line">&#xA0;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS &#xFF1A;&#x5982;&#x679C;&#x4F60;&#x7684;&#x9879;&#x76EE;&#x662F;&#x5728; Flutter 2.10 &#x6216;&#x66F4;&#x65E9;&#x7248;&#x672C;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x8981;&#x5148;&#x4ECE;&#x76EE;&#x5F55;&#x4E2D;&#x5220;&#x9664; <code>/web</code> &#x6587;&#x4EF6; &#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7; <code>flutter create . --platforms=web</code> &#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x6A21;&#x7248;&#x3002;</p>
</blockquote>
<p>fragment shaders &#x90E8;&#x5206;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x5927;&#x5BB6;&#x53EF;&#x80FD;&#x5E76;&#x4E0D;&#x4F1A;&#x7528;&#x5230;&#xFF0C;shaders &#x5C31;&#x662F;&#x4EE5; <code>.frag</code> &#x6269;&#x5C55;&#x540D;&#x51FA;&#x73B0;&#x7684; GLSL &#x6587;&#x4EF6;&#xFF0C;&#x5728; Flutter &#x91CC;&#x662F;&#x5728; <code>pubspec.yaml</code> &#x6587;&#x4EF6;&#x4E0B;&#x7684; <code>shaders</code> &#x4E2D;&#x58F0;&#x660E;&#xFF0C;&#x73B0;&#x5728;&#x5B83;&#x652F;&#x6301; Web &#x4E86;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;flutter:</span><br><span class="line">shaders:</span><br><span class="line">&#xA0; -&#xA0;shaders/myshader.frag</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x4E00;&#x822C;&#x8FD0;&#x884C;&#x65F6;&#x4F1A;&#x628A; frag &#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x5230; <code>FragmentProgram</code> &#x5BF9;&#x8C61;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7; program &#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5230;&#x5BF9;&#x5E94;&#x7684; <code>shader</code>&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7; <code>Paint.shader</code> &#x8FDB;&#x884C;&#x4F7F;&#x7528;&#x7ED8;&#x5236;&#xFF0C; &#x5F53;&#x7136; Flutter &#x91CC; shaders &#x6587;&#x4EF6;&#x662F;&#x5B58;&#x5728;&#x9650;&#x5236;&#x7684;&#xFF0C;&#x6BD4;&#x5982;&#x4E0D;&#x652F;&#x6301; UBO &#x548C; SSBO &#x7B49;&#x3002;</p>
</blockquote>
<p><strong>&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x662F;&#x8BB2;&#x89E3; shaders &#xFF0C;&#x800C;&#x662F;&#x5BA3;&#x544A;&#x4E00;&#x4E0B;&#xFF0C;Flutter Web &#x652F;&#x6301; shaders &#x4E86;</strong>&#x3002;</p>
<h1 id="&#x672A;&#x6765;"><a href="#&#x672A;&#x6765;" class="headerlink" title="&#x672A;&#x6765;"></a>&#x672A;&#x6765;</h1><p><strong>&#x5176;&#x5B9E;&#x672A;&#x6765;&#x624D;&#x662F;&#x672C;&#x7BC7;&#x7684;&#x91CD;&#x70B9;</strong>&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053; Flutter &#x5728; Web &#x9886;&#x57DF;&#x7684;&#x652F;&#x6301;&#x4E0A;&#x4E00;&#x76F4;&#x5728;&#x300C;&#x59A5;&#x534F;&#x300D;&#xFF0C;Flutter Web &#x5728;&#x6574;&#x4E2A; Flutter &#x4F53;&#x7CFB;&#x4E0B;&#x4E00;&#x76F4;&#x5904;&#x4E8E;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E00;&#x76F4;&#x5B58;&#x5728;&#x4E24;&#x79CD;&#x6E32;&#x67D3;&#x65B9;&#x5F0F;&#xFF1A;<a href="https://dev.newban.cn/7095294020900880420">html &#x548C; canvaskit</a>&#x3002;</p>
<p>&#x7B80;&#x5355;&#x8BF4; html &#x5C31;&#x662F;&#x8F6C;&#x5316;&#x4E3A; <a href="https://dev.newban.cn/7095294020900880420">JS + Html Element</a> &#x6E32;&#x67D3;&#xFF0C;&#x800C; canvaskit &#x662F;&#x91C7;&#x7528; <a href="/external_links/99f51900c0cf37576d0c78d13093e5b2.html" target="blank" rel="noopener">Skia + WebAssembly</a> &#x7684;&#x65B9;&#x5F0F;&#xFF0C;<strong>&#x800C; html &#x7684;&#x6A21;&#x5F0F;&#x8BA9; Web &#x5728; Flutter &#x4E2D;&#x663E;&#x5F97;&#x300C;&#x683C;&#x683C;&#x4E0D;&#x5165;&#x300D;&#xFF0C;&#x8DEF;&#x5F84;&#x4F9D;&#x8D56;&#x548C;&#x7EF4;&#x62A4;&#x6210;&#x672C;&#x4E5F;&#x4E00;&#x76F4;&#x662F; Flutter Web &#x7684;&#x5934;&#x75DB;&#x95EE;&#x9898;</strong>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/eb48a5cd96b7dff422e22e9baebff9a5583ee3dd4f786a215841aa7aa55c9536" alt></p>
<p>&#x9762;&#x5BF9;&#x8FD9;&#x4E2A;&#x56F0;&#x5883;&#xFF0C;&#x5B98;&#x65B9;&#x5728;&#x5E74;&#x521D;&#x7684; <a href="https://dev.newban.cn/7192646390948823098">Flutter Forword</a> &#x5927;&#x4F1A;&#x4E0A;&#x63D0;&#x51FA;&#x91CD;&#x65B0;&#x89C4;&#x5212; Flutter Web &#x7684;&#x672A;&#x6765;&#xFF0C;&#x800C;&#x968F;&#x7740; Flutter 3.10 &#x7684;&#x53D1;&#x5E03;&#xFF0C;&#x5B98;&#x65B9;&#x7EC8;&#x4E8E;&#x5BF9;&#x4E8E; Web &#x7684;&#x672A;&#x6765;&#x6709;&#x4E86;&#x660E;&#x786E;&#x7684;&#x5B9A;&#x4F4D;&#xFF1A;</p>
<blockquote>
<p><strong>&#x201C;Flutter &#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x56F4;&#x7ED5; CanvasKit &#x548C; WebAssembly &#x7B49;&#x65B0;&#x5174; Web &#x6280;&#x672F;&#x8FDB;&#x884C;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x7684;&#x6846;&#x67B6;&#x3002;&#x201D;</strong></p>
</blockquote>
<p>Flutter &#x56E2;&#x961F;&#x8868;&#x793A;&#xFF0C;<strong>Flutter Web &#x7684;&#x5B9A;&#x4F4D;&#x4E0D;&#x662F;&#x8BBE;&#x8BA1;&#x4E3A;&#x901A;&#x7528; Web &#x7684;&#x6846;&#x67B6;</strong>&#xFF0C;&#x7C7B;&#x4F3C;&#x7684; Web &#x6846;&#x67B6;&#x73B0;&#x5728;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982; Angular &#x548C; React &#x7B49;&#x5728;&#x8FD9;&#x4E2A;&#x9886;&#x57DF;&#x8868;&#x73B0;&#x5C31;&#x5F88;&#x51FA;&#x8272;&#xFF0C;&#x800C; Flutter &#x5E94;&#x8BE5;&#x662F;&#x56F4;&#x7ED5; CanvasKit &#x548C; <a href="/external_links/870e566f124613a96c18208c868ad22a.html" target="blank" rel="noopener">WebAssembly</a> &#x7B49;&#x65B0;&#x6280;&#x672F;&#x8FDB;&#x884C;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x7684;&#x6846;&#x67B6;&#x3002;</p>
<p>&#x6240;&#x4EE5; Flutter Web &#x672A;&#x6765;&#x7684;&#x8DEF;&#x7EBF;&#x4F1A;&#x662F;&#x66F4;&#x591A; CanvasKit &#xFF0C;&#x4E5F;&#x5C31;&#x662F; WebAssembly + Skia &#xFF0C;&#x540C;&#x65F6;&#x5728;&#x8FD9;&#x4E2A;&#x9886;&#x57DF; Dart &#x4E5F;&#x5728;&#x6301;&#x7EED;&#x6DF1;&#x8015;&#xFF1A;<strong>&#x4ECE; Dart 3 &#x5F00;&#x59CB;&#xFF0C;&#x5BF9;&#x4E8E; Web &#x7684;&#x652F;&#x6301;&#x5C06;&#x9010;&#x6B65;&#x6F14;&#x8FDB;&#x4E3A; WebAssembly &#x7684; Dart native &#x7684;&#x5B9A;&#x4F4D;</strong>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/3ded6d0095bc458c54bf0d811c0e049efb9ca9ea79e33eb9bf6209518e9c016e" alt></p>
<p>&#x4EC0;&#x4E48;&#x662F; WebAssembly &#x7684; dart native &#xFF1F;&#x4E00;&#x76F4;&#x4EE5;&#x6765; Flutter &#x5BF9;&#x4E8E; WebAssembly &#x7684;&#x652F;&#x6301;&#x90FD;&#x662F;&#xFF1A;&#x4F7F;&#x7528; Wasm &#x6765;&#x5904;&#x7406;CanvasKit &#x7684; runtime&#xFF0C;&#x800C; Dart &#x4EE3;&#x7801;&#x4F1A;&#x88AB;&#x7F16;&#x8BD1;&#x4E3A; JS&#xFF0C;&#x800C;&#x8FD9;&#x5BF9;&#x4E8E; Dart &#x56E2;&#x961F;&#x6765;&#x65F6;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x300C;&#x59A5;&#x534F;&#x300D;&#x7684;&#x8FC7;&#x6E21;&#x671F;&#x3002;</p>
<p>&#x800C;&#x968F;&#x7740;&#x5B98;&#x65B9;&#x4E0E; WebAssembly &#x751F;&#x6001;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x591A;&#x4E2A;&#x56E2;&#x961F;&#x7684;&#x6DF1;&#x5165;&#x5408;&#x4F5C;&#xFF0C;<strong>Dart &#x5DF2;&#x7ECF;&#x5F00;&#x59CB;&#x652F;&#x6301;&#x76F4;&#x63A5;&#x7F16;&#x8BD1;&#x4E3A;&#x539F;&#x751F;&#x7684; wasm &#x4EE3;&#x7801;&#xFF0C;&#x4E00;&#x4E2A;&#x53EB; WasmGC &#x7684;&#x5783;&#x573E;&#x6536;&#x96C6;&#x5B9E;&#x73B0;&#x88AB;&#x5F15;&#x5165;&#x6807;&#x51C6;</strong>&#xFF0C;&#x8BE5;&#x6269;&#x5C55;&#x5B9E;&#x73B0;&#x76EE;&#x524D;&#x5728;&#x57FA;&#x4E8E; Chromium &#x7684;&#x6D4F;&#x89C8;&#x5668;&#x548C; Firefox &#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x5728;&#x8D8B;&#x5411;&#x7A33;&#x5B9A;&#x3002;</p>
<blockquote>
<p>&#x76EE;&#x524D;&#x5728;&#x57FA;&#x51C6;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x6267;&#x884C;&#x901F;&#x5EA6;&#x63D0;&#x9AD8;&#x4E86; 3 &#x500D;</p>
</blockquote>
<p>&#x8981;&#x5C06; Dart &#x548C; Flutter &#x7F16;&#x8BD1;&#x6210; Wasm&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x652F;&#x6301; <a href="/external_links/a1f47d6b9d0a43b5c09d485abc2f9924.html" target="blank" rel="noopener">WasmGC</a> &#x7684;&#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x76EE;&#x524D; <a href="/external_links/a5c24a58af2ddd978ef646c092124fbe.html" target="blank" rel="noopener">Chromium V8</a> &#x548C; Firefox &#x56E2;&#x961F;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x90FD;&#x5728;&#x8FDB;&#x884C;&#x652F;&#x6301;&#xFF0C;&#x6BD4;&#x5982; Chromium &#x4E0B;&#xFF1A;</p>
<blockquote>
<p>&#x901A;&#x8FC7;&#x7ED3;&#x6784;&#x548C;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x4E3A; WebAssembly &#x589E;&#x52A0;&#x4E86;&#x5BF9;&#x9AD8;&#x7EA7;&#x8BED;&#x8A00;&#x7684;&#x6709;&#x6548;&#x652F;&#x6301;&#xFF0C;&#x4EE5; Wasm &#x4E3A; target &#x7684;&#x8BED;&#x8A00;&#x7F16;&#x8BD1;&#x5668;&#x80FD;&#x591F;&#x4E0E;&#x4E3B;&#x673A; VM &#x4E2D;&#x7684;&#x5783;&#x573E;&#x6536;&#x96C6;&#x5668;&#x96C6;&#x6210;&#x3002;&#x5728; Chrome &#x4E2D;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#x610F;&#x5473;&#x7740;&#x542F;&#x7528;&#x7C7B;&#x578B;&#x5316;&#x51FD;&#x6570;&#x5F15;&#x7528;&#xFF0C;&#x5B83;&#x4F1A;&#x5C06;&#x51FD;&#x6570;&#x5F15;&#x7528;&#x5B58;&#x50A8;&#x5728;&#x4E0A;&#x8FF0;&#x7ED3;&#x6784;&#x548C;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</p>
</blockquote>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/27e41fd64f3191f3dc4de8fc1ab08319fc99efd317c721ea5c0b11617ff82361" alt></p>
<p>&#x73B0;&#x5728;&#x5728; Flutter master &#x5206;&#x652F;&#x4E0B;&#x5C31;&#x53EF;&#x4EE5;&#x63D0;&#x524D;&#x5C1D;&#x8BD5; wasm &#x7684;&#x652F;&#x6301;&#xFF0C;&#x8FD0;&#x884C; <code>flutter build web --help</code> &#x5982;&#x679C;&#x51FA;&#x73B0;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x573A;&#xFF0C; &#x8BF4;&#x660E;&#x652F;&#x6301; wasm &#x7F16;&#x8BD1;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2c47911c50fe63295ffc6de72790ebc9ebbb75c0ad28823b442eb2018203f2f6" alt></p>
<p>&#x4E4B;&#x540E;&#x6267;&#x884C; <code>flutter build web --wasm</code> &#x5C31;&#x53EF;&#x4EE5;&#x7F16;&#x8BD1;&#x4E00;&#x4E2A;&#x5E26;&#x6709; native dart wasm &#x7684; web &#x5305;&#xFF0C;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x540E;&#xFF0C;&#x4F1A;&#x5C06;&#x4EA7;&#x7269;&#x8F93;&#x51FA;&#x5230; <code>build/web_wasm</code> &#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>
<p>&#x4E4B;&#x540E;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; pub &#x4E0A;&#x7684; <a href="/external_links/1976660bb73a3850b325cdd21f94ba5a.html" target="blank" rel="noopener"><code>dhttpd</code></a> &#x5305;&#x5728; <code>build/web_wasm</code>&#x76EE;&#x5F55;&#x4E0B;&#x6267;&#x884C;&#x672C;&#x5730;&#x670D;&#x52A1;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x9884;&#x89C8;&#x6548;&#x679C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;&gt; cd build/web_wasm</span><br><span class="line">&gt; dhttpd</span><br><span class="line">Server started on port 8080</span><br></pre></td></tr></table></figure>

<p>&#x76EE;&#x524D;&#x9700;&#x8981;&#x7248;&#x672C; 112 &#x6216;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x7684; Chromium &#x624D;&#x80FD;&#x652F;&#x6301;&#xFF0C;&#x540C;&#x65F6;&#x9700;&#x8981;&#x542F;&#x52A8;&#x5BF9;&#x5E94;&#x7684; Chrome &#x6807;&#x8BC6;&#x4F4D;&#xFF1A;</p>
<ul>
<li><code>enable-experimental-webassembly-stack-switching</code></li>
<li><code>enable-webassembly-garbage-collection</code></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/10f0069931d10d1f068f3ecf09119de1f3810a67215671aa0b2a2176804f6cc1" alt></p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x76EE;&#x524D;&#x9636;&#x6BB5;&#x8FD8;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x9650;&#x5236;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<blockquote>
<p>Dart Wasm &#x7F16;&#x8BD1;&#x5668;&#x5229;&#x7528;&#x4E86; <a href="/external_links/8ca035bb2474aeeb3474497af30c1ffe.html" target="blank" rel="noopener">JavaScript-Promise Integration (JSPI)</a> &#x7279;&#x6027;&#xFF0C;Firefox &#x4E0D;&#x652F;&#x6301; JSPI &#x63D0;&#x8BAE;&#xFF0C;&#x6240;&#x4EE5;&#x4E00;&#x65E6; Dart &#x4ECE; JSPI &#x8FC1;&#x79FB;&#x51FA;&#x6765;&#xFF0C;Firefox &#x5E94;&#x542F;&#x7528;&#x9002;&#x5F53;&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#x624D;&#x80FD;&#x8FD0;&#x884C;&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x5916;&#x8FD8;&#x9700;&#x8981; JS-interop &#x652F;&#x6301;&#xFF0C;&#x56E0;&#x4E3A;&#x4E3A;&#x4E86;&#x652F;&#x6301; Wasm&#xFF0C;Dart &#x6539;&#x53D8;&#x4E86;&#x5B83;&#x9488;&#x5BF9;&#x6D4F;&#x89C8;&#x5668;&#x548C; JavaScript &#x7684; API &#x652F;&#x6301;&#x65B9;&#x5F0F;&#xFF0C; &#x8FD9;&#x79CD;&#x8F6C;&#x53D8;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x628A; <code>dart:html</code> &#x6216; <code>package:js</code> &#x7F16;&#x8BD1;&#x4E3A; Wasm &#x7684; Dart &#x4EE3;&#x7801;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x7279;&#x5B9A;&#x4E8E;&#x5E73;&#x53F0;&#x7684;&#x5305;&#x5982; url_launcher &#x4F1A;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x5E93;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/a47a754dcdf5123876fa3149d432330a3823e6fd0b8be2198f00f3ed02b762c2" alt></p>
<p>&#x6700;&#x540E;&#xFF0C;<strong>&#x76EE;&#x524D; DevTools &#x8FD8;&#x4E0D;&#x652F;&#x6301; <code>flutter run</code> &#x53BB;&#x8FD0;&#x884C;&#x548C;&#x8C03;&#x8BD5; Wasm</strong>&#x3002;</p>
<h1 id="&#x6700;&#x540E;"><a href="#&#x6700;&#x540E;" class="headerlink" title="&#x6700;&#x540E;"></a>&#x6700;&#x540E;</h1><p>&#x5F88;&#x9AD8;&#x5174;&#x80FD;&#x770B;&#x5230; Flutter &#x56E2;&#x961F;&#x6700;&#x7EC8;&#x53BB;&#x5B9A;&#x4E86; Web &#x7684;&#x672A;&#x6765;&#x8DEF;&#x7EBF;&#xFF0C;&#x8FD9;&#x8BA9; Web &#x7684;&#x672A;&#x6765;&#x66F4;&#x52A0;&#x660E;&#x6717;&#xFF0C;&#x5F53;&#x7136;&#xFF0C;&#x6B63;&#x5982;&#x524D;&#x9762;&#x6240;&#x8BF4;&#x7684;&#xFF0C;<strong>Flutter &#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x56F4;&#x7ED5; CanvasKit &#x548C; WebAssembly &#x7B49;&#x65B0;&#x5174; Web &#x6280;&#x672F;&#x8FDB;&#x884C;&#x67B6;&#x6784;&#x8BBE;&#x8BA1;&#x7684;&#x6846;&#x67B6;</strong>&#x3002;</p>
<p><strong>&#x6240;&#x4EE5; Flutter Web&#x4E0D;&#x662F;&#x4E3A;&#x4E86;&#x8BBE;&#x8BA1;&#x4E3A;&#x901A;&#x7528; Web &#x7684;&#x6846;&#x67B6;&#x53BB; Angular &#x548C; React &#x7B49;&#x7ADE;&#x4E89;&#xFF0C;&#x5B83;&#x662F;&#x8BA9;&#x4F60;&#x5728;&#x4F7F;&#x7528; Flutter &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x80FD;&#x529B;&#x5F88;&#x597D;&#x5730;&#x91CA;&#x653E;&#x5230; Web &#x9886;&#x57DF;</strong>&#xFF0C;&#x800C; CanvasKit &#x5E26;&#x6765;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x66F4;&#x7B26;&#x5408; Flutter Web &#x7684;&#x5B9A;&#x4F4D;&#xFF0C;&#x5F53;&#x7136;&#xFF0C;&#x89E3;&#x51B3;&#x52A0;&#x8F7D;&#x65F6;&#x957F;&#x95EE;&#x9898;&#x4F1A;&#x662F;&#x4EFB;&#x91CD;&#x9053;&#x8FDC;&#x7684;&#x9700;&#x6C42;&#x3002;</p>
<p><strong>&#x6700;&#x540E;&#x4E0D;&#x5F97;&#x4E0D;&#x63D0; WebGPU</strong>&#xFF0C; WebGPU &#x4F5C;&#x4E3A;&#x65B0;&#x4E00;&#x4EE3;&#x7684; WebGL&#xFF0C;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x7ED8;&#x5236; 3D &#x7684;&#x5168;&#x65B0;&#x5B9E;&#x73B0;&#xFF0C;&#x5B83;&#x5C5E;&#x4E8E; GPU&#x786C;&#x4EF6;&#xFF08;&#x663E;&#x5361;&#xFF09;&#x5411; Web&#xFF08;&#x6D4F;&#x89C8;&#x5668;&#xFF09;&#x5F00;&#x653E;&#x7684;&#x4F4E;&#x7EA7; API&#xFF0C;&#x5305;&#x62EC;&#x56FE;&#x5F62;&#x548C;&#x8BA1;&#x7B97;&#x4E24;&#x65B9;&#x9762;&#x76F8;&#x5173;&#x63A5;&#x53E3;&#x3002;</p>
<p>WebGPU &#x6765;&#x81EA; W3C &#x5236;&#x5B9A;&#x7684;&#x6807;&#x51C6;&#xFF0C;&#x4E0E; WebGL &#x4E0D;&#x540C;&#xFF0C;WebGPU &#x4E0D;&#x662F;&#x57FA;&#x4E8E; OpenGL &#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5168;&#x65B0;&#x6807;&#x51C6;&#xFF0C;&#x53D1;&#x8D77;&#x8005;&#x662F;&#x82F9;&#x679C;&#xFF0C;&#x76EE;&#x524D;&#x7531; W3C GPU &#x4E0E;&#x6765;&#x81EA;&#x82F9;&#x679C;&#x3001;Mozilla&#x3001;&#x5FAE;&#x8F6F;&#x548C;&#x8C37;&#x6B4C;&#x4E00;&#x8D77;&#x5236;&#x5B9A;&#x5F00;&#x53D1;&#xFF0C;&#x4E0D;&#x540C;&#x4E8E; WebGL (OpenGL ES Web &#x7248;&#x672C;)&#xFF0C;WebGPU &#x662F;&#x57FA;&#x4E8E; Vulkan&#x3001;Metal &#x548C; Direct3D 12 &#x7B49;&#xFF0C;&#x80FD;&#x63D0;&#x4F9B;&#x66F4;&#x597D;&#x7684;&#x6027;&#x80FD;&#x548C;&#x591A;&#x7EBF;&#x7A0B;&#x652F;&#x6301;&#x3002;</p>
<blockquote>
<p>WebGPU &#x5DF2;&#x7ECF;&#x88AB;&#x6B63;&#x5F0F;&#x96C6;&#x6210;&#x5230; Chrome 113 &#x4E2D;&#xFF0C;&#x9996;&#x4E2A;&#x7248;&#x672C;&#x53EF;&#x5728;&#x4F1A;&#x652F;&#x6301; Vulkan &#x7684; ChromeOS &#x8BBE;&#x5907;&#x3001; Direct3D 12 &#x7684; Windows &#x8BBE;&#x5907;&#x548C; macOS &#x7684; Chrome 113 &#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x9664;&#x6B64;&#x4E4B;&#x5916; Linux&#x3001;Android &#x4E5F;&#x5C06;&#x5728; 2023 &#x5E74;&#x5185;&#x5F00;&#x59CB;&#x9646;&#x7EED;&#x53D1;&#x5E03;&#xFF0C;&#x540C;&#x6B65;&#x76EE;&#x524D;&#x4E5F;&#x521D;&#x6B65;&#x767B;&#x9646;&#x4E86; Firefox &#x548C; Safari &#x3002;</p>
</blockquote>
<p>&#x63D0;&#x53CA; WebGPU &#x7684;&#x539F;&#x56E0;&#x5728;&#x4E8E;&#xFF1A;<strong>WebGPU + WebAssembly &#x662F;&#x5426;&#x5728;&#x672A;&#x6765;&#x53EF;&#x4EE5;&#x8BA9; Web &#x4E5F;&#x652F;&#x6301; Impeller &#x7684;&#x53EF;&#x80FD;&#xFF1F;</strong>&#x3002;</p>
<blockquote>
<p>&#x8BE6;&#x7EC6;&#x53EF;&#x89C1;&#xFF1A;<a href="/external_links/bbb6b900015ec3e7943b89f93d0414aa.html" target="blank" rel="noopener">cohost.org/mcc/post/14&#x2026;</a> &#x548C; <a href="/external_links/1533722fe756310c2cddecffcf48cd9c.html" target="blank" rel="noopener">www.infoq.cn/article/qwa&#x2026;</a></p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/bf605de52c72f02157a7d9ae434acec1.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7231565908631633979.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7231565908631633979.html" itemprop="url">Google I/O 2023 - Flutter 310</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-11T07:04:33+08:00">
                2023-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x6838;&#x5FC3;&#x90E8;&#x5206;&#x539F;&#x6587;&#x94FE;&#x63A5;&#xFF1A;<a href="/external_links/ca480ed40ae6a0d226bc0e23376b613d.html" target="blank" rel="noopener">medium.com/flutter/wha&#x2026;</a></p>
</blockquote>
<p>&#x867D;&#x7136;&#x672C;&#x6B21; I/O &#x7684;&#x6838;&#x5FC3; keynote &#x4E3B;&#x8981;&#x662F; AI &#xFF0C;&#x4F46;&#x662F;&#x6309;&#x7167;&#x60EF;&#x4F8B;&#x4F9D;&#x7136;&#x53D1;&#x5E03;&#x4E86;&#x65B0;&#x7684; Flutter &#x7A33;&#x5B9A;&#x7248;&#xFF0C;&#x4E0D;&#x8FC7;&#x5E76;&#x975E;&#x5927;&#x5BB6;&#x731C;&#x6D4B;&#x7684; 4.0&#xFF0C;&#x800C;&#x662F; 3.10 &#xFF0C;Flutter &#x7684;&#x7248;&#x672C;&#x53F7;&#x4F9D;&#x7136;&#x90A3;&#x4E48;&#x7684;&#x51FA;&#x4EBA;&#x610F;&#x6599;&#x3002;</p>
<p><strong>Flutter 3.10 &#x4E3B;&#x8981;&#x5305;&#x62EC;&#x6709;&#x5BF9; Web&#x3001;mobile&#x3001;graphics&#x3001;&#x5B89;&#x5168;&#x6027;&#x7B49;&#x65B9;&#x9762;&#x7684;&#x76F8;&#x5173;&#x6539;&#x8FDB;</strong>&#xFF0C;&#x6838;&#x5FC3;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#xFF1A;</p>
<ul>
<li>iOS &#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x4E86; Impeller</li>
<li>&#x4E00;&#x5806;&#x65B0;&#x7684; Material 3 &#x63A7;&#x4EF6;&#x88AD;&#x6765;</li>
<li>iOS &#x6027;&#x80FD;&#x4F18;&#x5316;&#xFF0C;Android &#x987A;&#x5E26;&#x53EF;&#x6709;&#x53EF;&#x65E0;&#x7684;&#x66F4;&#x65B0;</li>
<li>Web &#x53EF;&#x4EE5;&#x65E0; iframe &#x5D4C;&#x5957;&#x5230;&#x5176;&#x4ED6;&#x5E94;&#x7528;</li>
</ul>
<h1 id="Framework"><a href="#Framework" class="headerlink" title="Framework"></a>Framework</h1><h2 id="Material-3"><a href="#Material-3" class="headerlink" title="Material 3"></a>Material 3</h2><p>&#x770B;&#x8D77;&#x6765;&#x8C37;&#x6B4C;&#x5BF9;&#x4E8E; Material 3 &#x7684;&#x8BBE;&#x8BA1;&#x89C4;&#x8303;&#x5F88;&#x4E0A;&#x5FC3;&#xFF0C;&#x6839;&#x636E;&#x6700;&#x65B0;&#x7684; <a href="/external_links/795199807d561c786258aa081061c41f.html" target="blank" rel="noopener">Material Design spec</a> &#x89C4;&#x8303; Flutter &#x4E5F;&#x8DDF;&#x8FDB;&#x4E86;&#x76F8;&#x5173;&#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x6709;<strong>&#x65B0;&#x7EC4;&#x4EF6;&#x548C;&#x7EC4;&#x4EF6;&#x4E3B;&#x9898;&#x548C;&#x65B0;&#x7684;&#x89C6;&#x89C9;&#x6548;&#x679C;&#x7B49;</strong>&#x3002;</p>
<p>&#x76EE;&#x524D;&#x4F9D;&#x7136;&#x662F;&#x7531;&#x5F00;&#x53D1;&#x8005;&#x53EF;&#x4EE5;&#x5728; <code>MaterialApp</code> &#x4E3B;&#x9898;&#x914D;&#x7F6E;&#x4E0B;&#xFF0C;&#x901A;&#x8FC7; <code>useMaterial3</code> &#x6807;&#x5FD7;&#x4F4D;&#x9009;&#x62E9;&#x662F;&#x5426;&#x4F7F;&#x7528; Material 3&#xFF0C;<strong>&#x4E0D;&#x8FC7;&#x4ECE;&#x4E0B;&#x4E00;&#x4E2A;&#x7A33;&#x5B9A;&#x7248;&#x672C;&#x5F00;&#x59CB;&#xFF0C;<code>useMaterial3</code> &#x9ED8;&#x8BA4;&#x4F1A;&#x88AB;&#x8C03;&#x6574;&#x4E3A; <code>true</code></strong> &#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f7777a3dec4d24064e1426392a34cff097867358b9b16d26c80c2d3740752ad2" alt></p>
<blockquote>
<p>&#x5BF9;&#x4E8E; Material 3 &#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <a href="/external_links/b68c282c71947ac765efab9dbf5f3dfe.html" target="blank" rel="noopener">flutter.github.io/samples/mat&#x2026;</a> &#x4E0A;&#x7684;&#x76F8;&#x5173; Demo &#x9884;&#x89C8;&#x3002;</p>
</blockquote>
<h2 id="ColorScheme-fromImageProvider"><a href="#ColorScheme-fromImageProvider" class="headerlink" title="ColorScheme.fromImageProvider"></a>ColorScheme.fromImageProvider</h2><p>&#x6240;&#x6709; M3 &#x7EC4;&#x4EF6;&#x914D;&#x7F6E;&#x4E3B;&#x9898;&#x7684;&#x9ED8;&#x8BA4;&#x989C;&#x8272; <code>ColorScheme</code>&#xFF0C;<strong>&#x9ED8;&#x8BA4;&#x914D;&#x8272;&#x65B9;&#x6848;&#x4F7F;&#x7528;&#x7D2B;&#x8272; shades&#xFF0C;&#x8FD9;&#x6709;&#x533A;&#x522B;&#x4E8E;&#x4E4B;&#x524D;&#x9ED8;&#x8BA4;&#x7684;&#x84DD;&#x8272;</strong>&#x3002;</p>
<p>&#x9664;&#x4E86;&#x53EF;&#x4EE5;&#x4ECE;&#x5355;&#x4E00; &#x201C;seed&#x201D; &#x989C;&#x8272;&#x6765;&#x5B9A;&#x5236;&#x914D;&#x7F6E;&#x65B9;&#x6848;&#x4E4B;&#x540E;&#xFF0C;&#x901A;&#x8FC7; <code>fromImageProvider</code> &#x56FE;&#x50CF;&#x4E5F;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x8272;&#x65B9;&#x6848;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/d32bab3396e96a353e39382763d1f31bfa5a3c64df67c36f16d3744df9b580b1" alt></p>
<h2 id="NavigationBar"><a href="#NavigationBar" class="headerlink" title="NavigationBar"></a>NavigationBar</h2><p>&#x672C;&#x6B21;&#x8FD8;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E2A; M3 &#x7248;&#x672C;&#x7684; <code>BottomNavigationBar</code> &#x63A7;&#x4EF6;&#x6548;&#x679C;&#xFF0C;&#x867D;&#x7136; <a href="/external_links/b11fcb037d61a30a580b10989a4a5490.html" target="blank" rel="noopener">M3</a> &#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x989C;&#x8272;&#x3001;highlighting &#x548C; elevation&#xFF0C;&#x4F46;&#x5B83;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x5176;&#x5B9E;&#x8FD8;&#x662F;&#x548C;&#x4EE5;&#x524D;&#x4E00;&#x6837;&#x3002;</p>
<p>&#x5982;&#x679C;&#x9700;&#x8981;&#x8C03;&#x6574; <code>NavigationBars</code> &#x7684;&#x9ED8;&#x8BA4;&#x5916;&#x89C2;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4F7F;&#x7528; <code>NavigationBarTheme</code> &#x6765;&#x8986;&#x76D6;&#x4FEE;&#x6539;&#xFF0C;&#x867D;&#x7136;&#x76EE;&#x524D;&#x4F60;&#x4E0D;&#x9700;&#x8981;&#x5C06;&#x73B0;&#x6709; App &#x8FC1;&#x79FB;&#x5230; <code>NavigationBars</code> &#xFF0C;&#x4F46;&#x662F;&#x5B98;&#x65B9;&#x5EFA;&#x8BAE;&#x8FD8;&#x662F;&#x5C3D;&#x53EF;&#x80FD;&#x5728;&#x65B0;&#x9879;&#x76EE;&#x91CC;&#x4F7F;&#x7528; <code>NavigationBars</code> &#x4F5C;&#x4E3A;&#x5BFC;&#x822A;&#x63A7;&#x4EF6;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2a5faa6c9b79f406f3551dd536d741031caa2a694eaa7955fd944a0d82e45930" alt></p>
<h2 id="NavigationDrawer"><a href="#NavigationDrawer" class="headerlink" title="NavigationDrawer"></a>NavigationDrawer</h2><p>M3 &#x9488;&#x5BF9; Drawer &#x540C;&#x6837;&#x63D0;&#x4F9B;&#x4E86;&#x65B0;&#x7684; <code>NavigationDrawer</code> &#xFF0C;&#x5B83;&#x901A;&#x8FC7; <code>NavigationDestinations</code> &#x663E;&#x793A;&#x5355;&#x9009;&#x5217;&#x8868;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x8BE5;&#x5217;&#x8868;&#x4E2D;&#x5305;&#x542B;&#x5176;&#x4ED6;&#x63A7;&#x4EF6;&#x3002;</p>
<blockquote>
<p>&#x540C;&#x6B65;M3&#x4E0B; <code>Drawer</code> &#x4E5F;&#x66F4;&#x65B0;&#x4E86;&#x989C;&#x8272;&#x548C;&#x9AD8;&#x5EA6;&#xFF0C;&#x540C;&#x65F6;&#x5BF9;&#x5E03;&#x5C40;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E9B;&#x5C0F;&#x7684;&#x66F4;&#x6539;&#x3002;</p>
</blockquote>
<p><code>NavigationDrawer</code> &#x9700;&#x8981;&#x65F6;&#x53EF;&#x4EE5;&#x6EDA;&#x52A8;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x8986;&#x76D6; <code>NavigationDrawer</code> &#x7684;&#x9ED8;&#x8BA4;&#x5916;&#x89C2;&#xFF0C;&#x540C;&#x6837;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>NavigationDrawerTheme</code> &#x6765;&#x8986;&#x76D6;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/aaf6b1e91361d8089b7abad3810fe3276d0b46a3bc334eae30a3e69cdbaaac9a" alt></p>
<h2 id="SearchBar-&#x548C;-SearchAnchor"><a href="#SearchBar-&#x548C;-SearchAnchor" class="headerlink" title="SearchBar &#x548C; SearchAnchor"></a>SearchBar &#x548C; SearchAnchor</h2><p>&#x8FD9;&#x662F; Flutter &#x4E3A;&#x641C;&#x7D22;&#x67E5;&#x8BE2;&#x548C;&#x63D0;&#x4F9B;&#x9884;&#x6D4B;&#x6548;&#x679C;&#x65B0;&#x589E;&#x7684;&#x63A7;&#x4EF6;&#x3002;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x5728;&#x8F93;&#x5165;&#x641C;&#x7D22;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x4F1A;&#x5728; &#x201C;search view&#x201D; &#x4E2D;&#x8BA1;&#x7B97;&#x5339;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x914D;&#x54CD;&#x5E94;&#x5217;&#x8868;&#xFF0C;&#x7528;&#x6237;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#x6216;&#x8C03;&#x6574;&#x5339;&#x914D;&#x7ED3;&#x679C;&#x3002;</p>
<p>&#x5982;&#x679C;&#x8981;&#x8986;&#x76D6; <code>SearchBarTheme</code> &#x7684;&#x9ED8;&#x8BA4;&#x5916;&#x89C2;&#xFF0C;&#x540C;&#x6837;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>SearchAnchorTheme</code> &#x6765;&#x8986;&#x76D6;&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
</table>
<h2 id="Secondary-Tab-Bar"><a href="#Secondary-Tab-Bar" class="headerlink" title="Secondary Tab Bar"></a>Secondary Tab Bar</h2><p>M3 &#x4E0B; Flutter &#x73B0;&#x5728;&#x9ED8;&#x8BA4;&#x63D0;&#x4F9B;&#x521B;&#x5EFA;&#x7B2C;&#x4E8C;&#x5C42;&#x9009;&#x9879;&#x5361;&#x5F0F;&#x5185;&#x5BB9;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x9488;&#x5BF9;&#x4E8C;&#x7EA7; Tab &#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>TabBar.secondary</code>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/cf5862a5c3bb9325c648c349dc8375da605f2b1329e263027c6816ba4b999018" alt></p>
<h2 id="DatePicker-&#x548C;-TimePicker-&#x66F4;&#x65B0;"><a href="#DatePicker-&#x548C;-TimePicker-&#x66F4;&#x65B0;" class="headerlink" title="DatePicker &#x548C; TimePicker &#x66F4;&#x65B0;"></a>DatePicker &#x548C; TimePicker &#x66F4;&#x65B0;</h2><p>M3&#x4E0B; <code>DatePicker</code> &#x66F4;&#x65B0;&#x4E86;&#x63A7;&#x4EF6;&#x7684;&#x65E5;&#x5386;&#x3001;&#x6587;&#x672C;&#x5B57;&#x6BB5;&#x7684;&#x989C;&#x8272;&#x3001;&#x5E03;&#x5C40;&#x548C;&#x5F62;&#x72B6;&#x7B49;&#xFF0C;&#x5BF9;&#x5E94; API &#x6CA1;&#x6709;&#x53D8;&#x52A8;&#xFF0C;&#x4F46;&#x4F1A;&#x4E2A;&#x65B0;&#x589E;&#x4E86; <code>DatePickerTheme</code> &#x7528;&#x4E8E;&#x8C03;&#x6574;&#x63A7;&#x4EF6;&#x6837;&#x5F0F;&#x3002;</p>
<p><code>TimePicker</code> &#x548C;<code>DatePicker</code> &#x4E00;&#x6837;&#xFF0C;&#x66F4;&#x65B0;&#x4E86;&#x63A7;&#x4EF6;&#x7684;&#x5E38;&#x89C4;&#x7248;&#x672C;&#x548C;&#x7D27;&#x51D1;&#x7248;&#x672C;&#x7684;&#x989C;&#x8272;&#x3001;&#x5E03;&#x5C40;&#x548C;&#x5F62;&#x72B6;&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
</table>
<h2 id="BottomSheet-&#x66F4;&#x65B0;"><a href="#BottomSheet-&#x66F4;&#x65B0;" class="headerlink" title="BottomSheet &#x66F4;&#x65B0;"></a>BottomSheet &#x66F4;&#x65B0;</h2><p>M3 &#x4E0B; <code>BottomSheet</code> &#x9664;&#x4E86;&#x989C;&#x8272;&#x548C;&#x5F62;&#x72B6;&#x66F4;&#x65B0;&#x4E4B;&#x5916;&#xFF0C;&#x8FD8;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x9009;&#x7684;&#x62D6;&#x52A8;&#x624B;&#x67C4;&#xFF0C;&#x5F53;&#x8BBE;&#x7F6E; <code>showDragHandle</code>&#x4E3A; <code>true</code> &#x65F6;&#x751F;&#x6548;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/92a70a6fa82623bb04346ecf9ffd438c003456c966f260ce5879e8fe61dae6e2" alt></p>
<h2 id="ListTile-&#x66F4;&#x65B0;"><a href="#ListTile-&#x66F4;&#x65B0;" class="headerlink" title="ListTile &#x66F4;&#x65B0;"></a>ListTile &#x66F4;&#x65B0;</h2><p>M3&#x4E0B; <code>ListTile</code> &#x66F4;&#x65B0;&#x4E86;&#x5B9A;&#x4F4D;&#x548C;&#x95F4;&#x8DDD;&#xFF0C;&#x5305;&#x62EC; content padding&#x3001;leading &#x548C; trailing &#x63A7;&#x4EF6;&#x7684;&#x5BF9;&#x9F50;&#x3001;minimum leading width, &#x548C; vertical spacing &#x7B49;&#xFF0C;&#x4F46;&#x662F; API &#x4FDD;&#x6301;&#x4E0D;&#x53D8;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2b36b9572ca7687ebbae22083e2fa14d4a1436797275c5831dbba1c25856e472" alt></p>
<h1 id="TextField-&#x66F4;&#x65B0;"><a href="#TextField-&#x66F4;&#x65B0;" class="headerlink" title="TextField &#x66F4;&#x65B0;"></a>TextField &#x66F4;&#x65B0;</h1><p>M3 &#x66F4;&#x65B0;&#x4E86;&#x6240;&#x6709; <code>TextField</code> &#x5BF9;&#x539F;&#x751F;&#x624B;&#x52BF;&#x652F;&#x6301;&#x3002;</p>
<p>&#x7528;&#x9F20;&#x6807;&#x53CC;&#x51FB;&#x6216;&#x4E09;&#x6B21;&#x70B9;&#x51FB; <code>TextField</code> &#x548C;&#x5728;&#x89E6;&#x6478;&#x8BBE;&#x5907;&#x4E0A;&#x53CC;&#x51FB;&#x6216;&#x4E09;&#x6B21;&#x70B9;&#x51FB;&#x6548;&#x679C;&#x76F8;&#x540C;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B; <code>TextField</code> &#x548C;<code>CupertinoTextField</code>  &#x90FD;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#x3002;</p>
<h3 id="TextField-double-click-tap-&#x624B;&#x52BF;"><a href="#TextField-double-click-tap-&#x624B;&#x52BF;" class="headerlink" title="TextField double click/tap &#x624B;&#x52BF;"></a><code>TextField</code> double click/tap &#x624B;&#x52BF;</h3><ul>
<li>Double click + drag&#xFF1A;&#x6269;&#x5C55;&#x5B57;&#x5757;&#x4E2D;&#x7684;&#x9009;&#x62E9;&#x3002;</li>
<li>Double tap + drag&#xFF1A;&#x6269;&#x5C55;&#x5B57;&#x5757;&#x4E2D;&#x7684;&#x9009;&#x62E9;&#x3002;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/2098d0cbde09b974226a5f0dc130c634ac2922858b9ee1afb195da1b010a3d3f" alt></p>
<h3 id="TextField-triple-click-tap-&#x624B;&#x52BF;"><a href="#TextField-triple-click-tap-&#x624B;&#x52BF;" class="headerlink" title="TextField triple click/tap &#x624B;&#x52BF;"></a><code>TextField</code> triple click/tap &#x624B;&#x52BF;</h3><p>Triple click</p>
<ul>
<li>&#x5728;&#x591A;&#x884C; <code>TextField</code>(Android/Fuchsia/iOS/macOS/Windows) &#x4E2D;&#x9009;&#x62E9;&#x70B9;&#x51FB;&#x4F4D;&#x7F6E;&#x7684;&#x6BB5;&#x843D;&#x5757;&#x3002;</li>
<li>&#x5728;&#x591A;&#x884C; <code>TextField</code> (Linux) &#x5185;&#x90E8;&#x65F6;&#xFF0C;&#x5728; click &#x4F4D;&#x7F6E;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x884C;&#x5757;&#x3002;</li>
<li>&#x9009;&#x62E9;&#x5355;&#x884C;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x6587;&#x672C; <code>TextField</code>&#x3002;</li>
</ul>
<p>Triple tap</p>
<ul>
<li>&#x5728; multi-line <code>TextField</code> &#x4E2D;&#x9009;&#x62E9;&#x70B9;&#x51FB;&#x4F4D;&#x7F6E;&#x7684;&#x6BB5;&#x843D;&#x5757; &#x3002;</li>
<li>&#x9009;&#x62E9;&#x5355;&#x884C; <code>TextField</code> &#x4E2D;&#x7684;&#x6240;&#x6709;&#x6587;&#x672C;</li>
</ul>
<p>Triple click+&#x62D6;&#x52A8;</p>
<ul>
<li>&#x6269;&#x5C55;&#x6BB5;&#x843D;&#x5757;&#x4E2D;&#x7684;&#x9009;&#x62E9; (Android/Fuchsia/iOS/macOS/Windows)&#x3002;</li>
<li>&#x6269;&#x5C55;&#x884C;&#x5757;&#x4E2D;&#x7684;&#x9009;&#x62E9; (Linux)&#x3002;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e1d566fc4aabf4839e8f782b43cab60dfbefb9d55086c289f437914b8aa3b9d8" alt></p>
<blockquote>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F;&#x624B;&#x52BF;&#x548C;&#x9F20;&#x6807;&#x5728;&#x53CC;&#x51FB;&#x548C;&#x4E09;&#x51FB;&#x4E0B;&#xFF0C;&#x4F1A;&#x89E6;&#x53D1;&#x4E0D;&#x540C;&#x7684;&#x9009;&#x62E9;&#x6548;&#x679C;&#xFF0C;&#x5E76;&#x4E14; Linux &#x5728;&#x4E09;&#x51FB;&#x6548;&#x679C;&#x4E0B;&#x4F1A;&#x6709;&#x70B9;&#x5DEE;&#x5F02;</p>
</blockquote>
<h2 id="Flutter-&#x652F;&#x6301;-SLSA-&#x7EA7;&#x522B;-1"><a href="#Flutter-&#x652F;&#x6301;-SLSA-&#x7EA7;&#x522B;-1" class="headerlink" title="Flutter &#x652F;&#x6301; SLSA &#x7EA7;&#x522B; 1"></a>Flutter &#x652F;&#x6301; SLSA &#x7EA7;&#x522B; 1</h2><p>Flutter Framework &#x73B0;&#x5728;&#x4F7F;&#x7528;&#x8F6F;&#x4EF6;&#x5DE5;&#x4EF6;&#x4F9B;&#x5E94;&#x94FE;&#x7EA7;&#x522B; ( <a href="/external_links/a9a6958d41beed85a715fb1b6cf7a748.html" target="blank" rel="noopener">SLSA</a> ) &#x7EA7;&#x522B; 1 &#x8FDB;&#x884C;&#x7F16;&#x8BD1;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x652F;&#x6301;&#x4E86;&#x8BB8;&#x591A;&#x5B89;&#x5168;&#x529F;&#x80FD;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;</p>
<ul>
<li><strong>&#x811A;&#x672C;&#x5316;&#x6784;&#x5EFA;&#x8FC7;&#x7A0B;</strong>&#xFF1A;Flutter &#x7684;&#x6784;&#x5EFA;&#x811A;&#x672C;&#x73B0;&#x5728;&#x5141;&#x8BB8;&#x5728;&#x53D7;&#x4FE1;&#x4EFB;&#x7684;&#x6784;&#x5EFA;&#x5E73;&#x53F0;&#x4E0A;&#x81EA;&#x52A8;&#x6784;&#x5EFA;&#xFF0C;&#x5EFA;&#x7ACB;&#x5728;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x67B6;&#x6784;&#x4E0A;&#x6709;&#x52A9;&#x4E8E;&#x9632;&#x6B62;&#x5DE5;&#x4EF6;&#x7BE1;&#x6539;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x4F9B;&#x5E94;&#x94FE;&#x5B89;&#x5168;&#x6027;&#x3002;</li>
<li><strong>&#x5E26;&#x6709;&#x5BA1;&#x8BA1;&#x65E5;&#x5FD7;&#x7684;&#x591A;&#x65B9;&#x6279;&#x51C6;</strong>&#xFF1A;Flutter &#x53D1;&#x5E03;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#x4EC5;&#x5728;&#x591A;&#x4E2A;&#x5DE5;&#x7A0B;&#x5E08;&#x6279;&#x51C6;&#x540E;&#x6267;&#x884C;&#xFF0C;&#x6240;&#x6709;&#x6267;&#x884C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x53EF;&#x5BA1;&#x8BA1;&#x7684;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#xFF0C;&#x8FD9;&#x4E9B;&#x66F4;&#x6539;&#x786E;&#x4FDD;&#x6CA1;&#x6709;&#x4EBA;&#x53EF;&#x4EE5;&#x5728;&#x6E90;&#x4EE3;&#x7801;&#x548C;&#x5DE5;&#x4EF6;&#x751F;&#x6210;&#x4E4B;&#x95F4;&#x5F15;&#x5165;&#x66F4;&#x6539;&#x3002;</li>
<li><strong>&#x51FA;&#x5904;</strong>&#xFF1A;Beta &#x548C;&#x7A33;&#x5B9A;&#x7248;&#x672C;&#x73B0;&#x5728;&#x4F7F;&#x7528; <a href="/external_links/a137ed4ae57762a79ad952bc4bbca6fa.html" target="blank" rel="noopener">provenance</a> &#x6784;&#x5EFA;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5177;&#x6709;&#x9884;&#x671F;&#x5185;&#x5BB9;&#x7684;&#x53EF;&#x4FE1;&#x6765;&#x6E90;&#x6784;&#x5EFA;&#x4E86;&#x6846;&#x67B6;&#x53D1;&#x5E03;&#x5DE5;&#x4EF6;&#xFF0C;&#x6BCF;&#x4E2A;&#x7248;&#x672C;&#x90FD;&#x4F1A;&#x53D1;&#x5E03;&#x94FE;&#x63A5;&#x4EE5;&#x67E5;&#x770B;&#x548C;&#x9A8C;&#x8BC1; <a href="/external_links/182bb0eb9010b95eed933691818b7332.html" target="blank" rel="noopener">SDK &#x5B58;&#x6863;</a> &#x7684;&#x51FA;&#x5904;&#x3002;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/f3faec400614bd1f96a86630e098cadd6a1bf019c655895d277815e1439d7e58" alt></p>
<p>&#x8FD9;&#x9879;&#x5DE5;&#x4F5C;&#x8FD8;&#x5728;&#x671D;&#x7740; SLSA L2 &#x548C; L3 &#x5408;&#x89C4;&#x6027;&#x8FC8;&#x8FDB;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x7EA7;&#x522B;&#x4FA7;&#x91CD;&#x4E8E;&#x5728;&#x6784;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#x548C;&#x6784;&#x5EFA;&#x4E4B;&#x540E;&#x63D0;&#x4F9B; artifacts &#x4FDD;&#x62A4;&#x3002;</p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="&#x6539;&#x8FDB;&#x4E86;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;"><a href="#&#x6539;&#x8FDB;&#x4E86;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;" class="headerlink" title="&#x6539;&#x8FDB;&#x4E86;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;"></a>&#x6539;&#x8FDB;&#x4E86;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;</h2><p>3.10 &#x51CF;&#x5C0F;&#x4E86;&#x56FE;&#x6807;&#x5B57;&#x4F53;&#x7684;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#xFF0C;&#x5B83;&#x4F1A;&#x4ECE; Material &#x548C; Cupertino &#x4E2D;&#x5220;&#x9664;&#x4E86;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5B57;&#x5F62;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x4F9B;&#x4E86;&#x66F4;&#x5FEB;&#x52A0;&#x8F7D;&#x3002;</p>
<h2 id="CanvasKit-&#x53D8;&#x5C0F;"><a href="#CanvasKit-&#x53D8;&#x5C0F;" class="headerlink" title="CanvasKit &#x53D8;&#x5C0F;"></a>CanvasKit &#x53D8;&#x5C0F;</h2><p>&#x57FA;&#x4E8E; Chromium &#x7684;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x66F4;&#x5C0F;&#x7684;&#x81EA;&#x5B9A;&#x4E49; CanvasKit &#x6E20;&#x9053;&#xFF0C;&#x6258;&#x7BA1;&#x5728; Google <a href="/external_links/b53777969ae44bbeae1c1e0cef8e481d.html" target="blank" rel="noopener">gstatic.com</a>  &#x4E0A;&#x7684; CanvasKit &#x53EF;&#x4EE5;&#x8FDB;&#x4E00;&#x6B65;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#x3002;</p>
<h2 id="Element-&#x5D4C;&#x5165;"><a href="#Element-&#x5D4C;&#x5165;" class="headerlink" title="Element &#x5D4C;&#x5165;"></a>Element &#x5D4C;&#x5165;</h2><p>&#x73B0;&#x5728;&#x53EF;&#x4EE5; <a href="/external_links/1e3efffb48109c345e21639a678b545f.html" target="blank" rel="noopener">&#x4ECE;&#x9875;&#x9762;&#x4E2D;&#x7684;&#x7279;&#x5B9A; Element &#x6765;&#x52A0;&#x8F7D; Flutter Web</a> &#xFF0C;&#x4E0D;&#x9700;&#x8981; <code>iframe</code>&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x7248;&#x672C;&#x4E4B;&#x524D; fluter web &#x662F;&#x9700;&#x8981;&#x586B;&#x5145;&#x6574;&#x4E2A;&#x9875;&#x9762;&#x4E3B;&#x4F53;&#x6216;&#x663E;&#x793A;&#x5728; <code>iframe</code> &#x6807;&#x8BB0;&#x5185;&#xFF0C;&#x7B80;&#x5355;&#x8BF4;&#x5C31;&#x662F;&#x628A; flutter web &#x5D4C;&#x5957;&#x5230;&#x5176;&#x4ED6; Web &#x4E0B;&#x66F4;&#x65B9;&#x4FBF;&#x4E86;&#x3002;</p>
<blockquote>
<p>&#x5177;&#x4F53; Demo &#x53EF;&#x89C1;&#xFF1A;<a href="/external_links/ba7f722a3e2b6a802317e78f711010c4.html" target="blank" rel="noopener">github.com/flutter/sam&#x2026;</a></p>
</blockquote>
<h2 id="&#x7740;&#x8272;&#x5668;&#x652F;&#x6301;"><a href="#&#x7740;&#x8272;&#x5668;&#x652F;&#x6301;" class="headerlink" title="&#x7740;&#x8272;&#x5668;&#x652F;&#x6301;"></a><strong>&#x7740;&#x8272;&#x5668;&#x652F;&#x6301;</strong></h2><p>Web &#x5E94;&#x7528;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; Flutter &#x7684; <a href="/external_links/ef2870771fe9537b215c3b740715f240.html" target="blank" rel="noopener">fragment shader</a> &#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;flutter:</span><br><span class="line">  shaders:</span><br><span class="line">    - shaders/myshader.frag</span><br></pre></td></tr></table></figure>

<h1 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h1><h2 id="Impeller"><a href="#Impeller" class="headerlink" title="Impeller"></a>Impeller</h2><p>&#x5728; 3.7 &#x7A33;&#x5B9A;&#x7248;&#x4E2D; iOS &#x63D0;&#x4F9B;&#x4E86; <a href="/external_links/9f769d1c904ad4f26e395f44c90b0c5d.html" target="blank" rel="noopener">Impeller</a>  &#x9884;&#x89C8;&#x652F;&#x6301;&#xFF0C;&#x4ECE;&#x90A3;&#x65F6;&#x8D77; Impeller &#x5C31;&#x6536;&#x5230;&#x5E76;&#x89E3;&#x51B3;&#x4E86;&#x7528;&#x6237;&#x7684;&#x5927;&#x91CF;&#x53CD;&#x9988;&#x3002;</p>
<p>&#x5728; 3.10 &#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9; Impeller &#x8FDB;&#x884C;&#x4E86; 250 &#x591A;&#x6B21;&#x63D0;&#x4EA4;&#xFF0C;<strong>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5C06; Impeller &#x8BBE;&#x7F6E;&#x4E3A; iOS &#x4E0A;&#x7684;&#x9ED8;&#x8BA4;&#x6E32;&#x67D3;&#x5668;</strong>&#x3002;</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6240;&#x6709;&#x4F7F;&#x7528; Flutter 3.10 &#x4E3A; iOS &#x6784;&#x5EFA;&#x7684;&#x5E94;&#x7528;&#x90FD;&#x4F7F;&#x7528; Impeller&#xFF0C;&#x8FD9;&#x6837; iOS &#x5E94;&#x7528;&#x9884;&#x8BA1;&#x5C06;&#x4F1A;&#x6709;&#x66F4;&#x5C11;&#x7684;&#x5361;&#x987F;&#x548C;&#x66F4;&#x4E00;&#x81F4;&#x7684;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x81EA; 3.7 &#x7248;&#x672C;&#x4EE5;&#x6765;&#xFF0C;iOS &#x4E0A;&#x7684; Impeller &#x6539;&#x8FDB;&#x4E86;&#x5185;&#x5B58;&#x5360;&#x7528;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8F83;&#x5C11;&#x7684;&#x6E32;&#x67D3;&#x901A;&#x9053;&#x548C;&#x4E2D;&#x95F4;&#x6E32;&#x67D3;&#x76EE;&#x6807;&#x3002;</p>
<p>&#x5728;&#x8F83;&#x65B0;&#x7684; iPhone &#x4E0A;&#xFF0C;<strong>&#x542F;&#x7528;&#x6709;&#x635F;&#x7EB9;&#x7406;&#x538B;&#x7F29;&#x53EF;&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x4FDD;&#x771F;&#x5EA6;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x51CF;&#x5C11;&#x5185;&#x5B58;&#x5360;&#x7528;&#xFF0C;&#x8FD9;&#x4E9B;&#x8FDB;&#x6B65;&#x4E5F;&#x663E;&#x7740;&#x63D0;&#x9AD8;&#x4E86; iPad &#x7684;&#x6027;&#x80FD;</strong>&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e7b6b49811b1d88e947dbe4997db120c605803a09d74cf32a73dd694089613ce" alt></p>
<p>&#x6BD4;&#x5982; <a href="/external_links/375340f25335e612391b458be39dc662.html" target="blank" rel="noopener">Wonderous</a> &#x5E94;&#x7528;&#x4E2D;&#x7684; &#x201C;pull quote&#x201D; &#x9875;&#x9762;&#xFF0C;<strong>&#x8FD9;&#x4E9B;&#x6539;&#x8FDB;&#x662F;&#x7684;&#x5F53;&#x524D;&#x9875;&#x9762;&#x4E0B;&#x7684;&#x5185;&#x5B58;&#x5360;&#x7528;&#x91CF;&#x51CF;&#x5C11;&#x4E86;&#x8FD1;&#x4E00;&#x534A;</strong>&#x3002;</p>
<p>&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;&#x7684;&#x51CF;&#x5C11;&#x4E5F;&#x9002;&#x5EA6;&#x964D;&#x4F4E;&#x4E86; GPU &#x548C; CPU &#x8D1F;&#x8F7D;&#xFF0C;Wondrous &#x5E94;&#x7528;&#x53EF;&#x80FD;&#x4E0D;&#x4F1A;&#x8BB0;&#x5F55;&#x8FD9;&#x4E9B;&#x8D1F;&#x8F7D;&#x4E0B;&#x964D;&#xFF0C;&#x5B83;&#x7684;&#x6846;&#x67B6;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4F18;&#x5316;&#x7684;&#x4E0D;&#x9519;&#xFF0C;&#x4F46;&#x8FD9;&#x4E00;&#x53D8;&#x5316;&#x5E94;&#x8BE5;&#x4F1A;&#x5EF6;&#x957F;&#x7EED;&#x822A;&#x80FD;&#x529B;&#x3002;</p>
<p>Impeller &#x8FD8;&#x91CA;&#x653E;&#x4E86;&#x56E2;&#x961F;&#x53EF;&#x4EE5;&#x66F4;&#x5FEB;&#x5730;&#x4EA4;&#x4ED8;&#x6D41;&#x884C;&#x529F;&#x80FD;&#x8BF7;&#x6C42;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x4F8B;&#x5982;&#x5728; iOS &#x4E0A;&#x652F;&#x6301;&#x66F4;&#x5E7F;&#x6CDB;&#x7684; P3 &#x8272;&#x57DF;&#x3002;</p>
<blockquote>
<p>&#x793E;&#x533A;&#x8D21;&#x732E;&#x52A0;&#x901F;&#x4E86;&#x6211;&#x4EEC;&#x7684;&#x8FDB;&#x6B65;&#xFF0C;&#x7279;&#x522B;&#x662F; GitHub &#x7528; &#x6237;<a href="/external_links/820bb8d9d469a83e4ccd2d52f5196e32.html" target="blank" rel="noopener">ColdPaleLight</a> &#x548C; <a href="/external_links/e0c36eabb93926ca5a2ff1b227ab599e.html" target="blank" rel="noopener">luckysmg</a> &#xFF0C;&#x4ED6;&#x4EEC;&#x7F16;&#x5199;&#x4E86;&#x591A;&#x4E2A;&#x4E0E; Impeller &#x76F8;&#x5173;&#x7684;&#x8865;&#x4E01;&#xFF0C;&#x63D0;&#x9AD8;&#x4E86;&#x4FDD;&#x771F;&#x5EA6;&#x548C;&#x6027;&#x80FD;&#x3002;</p>
</blockquote>
<p>&#x867D;&#x7136; Impeller &#x6EE1;&#x8DB3;&#x5927;&#x591A;&#x6570; Flutter &#x5E94;&#x7528;&#x7684;&#x6E32;&#x67D3;&#x9700;&#x6C42;&#xFF0C;&#x4F46;&#x4F60;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x5173;&#x95ED; Impeller&#x3002;&#x5982;&#x679C;&#x9009;&#x62E9;&#x9000;&#x51FA;&#xFF0C;&#x8BF7;&#x8003;&#x8651;&#x5728; <a href="/external_links/f2613b44b292167854793ca45b65b8bd.html" target="blank" rel="noopener">GitHub &#x4E0A;&#x63D0;&#x4EA4;&#x95EE;&#x9898;</a>&#x4EE5;&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x539F;&#x56E0;&#x3002;</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;  &lt;key&gt;FLTEnableImpeller&lt;/key&gt;</span><br><span class="line">&gt;   &lt;false/&gt;</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&#x7528;&#x6237;&#x53EF;&#x80FD;&#x4F1A;&#x6CE8;&#x610F;&#x5230; Skia &#x548C; Impeller &#x5728;&#x6E32;&#x67D3;&#x65F6;&#x5B58;&#x5728;&#x7EC6;&#x5FAE;&#x5DEE;&#x522B;&#xFF0C;&#x8FD9;&#x4E9B;&#x5DEE;&#x5F02;&#x53EF;&#x80FD;&#x662F;&#x9519;&#x8BEF;&#xFF0C;&#x6240;&#x4EE5;&#x8BF7;&#x52A1;&#x5FC5;&#x5728; Github &#x4E0A;&#x63D0;&#x51FA;&#x95EE;&#x9898;&#xFF0C;<strong>&#x5728;&#x672A;&#x6765;&#x7684;&#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5220;&#x9664;&#x9002;&#x7528;&#x4E8E; iOS &#x7684;&#x65E7;&#x7248; Skia &#x6E32;&#x67D3;&#x5668;&#x4EE5;&#x51CF;&#x5C0F; Flutter &#x7684;&#x5927;&#x5C0F;</strong>&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;Impeller &#x7684; Vulkan &#x540E;&#x7AEF;&#x7136;&#x5728;&#x652F;&#x6301;&#x5F53;&#x4E2D;&#xFF0C;Android &#x4E0A;&#x7684; Impeller &#x4ECD;&#x5728;&#x79EF;&#x6781;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x4F46;&#x5C1A;&#x672A;&#x51C6;&#x5907;&#x597D;&#x8FDB;&#x884C;&#x9884;&#x89C8;&#x3002;</p>
<blockquote>
<p>&#x8981;&#x4E86;&#x89E3; Impeller &#x8FDB;&#x5C55;&#xFF0C;&#x8BF7;&#x67E5;&#x770B; <a href="/external_links/776c365e72e03dd64f5660ce0275bf3b.html" target="blank" rel="noopener">github.com/orgs/flutte&#x2026;</a></p>
</blockquote>
<h1 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h1><p>3.10 &#x7248;&#x672C;&#x6DB5;&#x76D6;&#x4E86;&#x9664; Impeller &#x4E4B;&#x5916;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x6027;&#x80FD;&#x6539;&#x8FDB;&#x548C;&#x4FEE;&#x590D;&#x3002;</p>
<h2 id="&#x6D88;&#x9664;&#x5361;&#x987F;"><a href="#&#x6D88;&#x9664;&#x5361;&#x987F;" class="headerlink" title="&#x6D88;&#x9664;&#x5361;&#x987F;"></a>&#x6D88;&#x9664;&#x5361;&#x987F;</h2><p>&#x8FD9;&#x91CC;&#x8981;&#x611F;&#x8C22; <a href="/external_links/e0c36eabb93926ca5a2ff1b227ab599e.html" target="blank" rel="noopener">luckysmg</a>&#xFF0C; &#x4ED6;&#x4EEC;&#x53D1;&#x73B0;&#x53EF;&#x4EE5;&#x7F29;&#x77ED;&#x4ECE; Metal &#x9A71;&#x52A8;&#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;&#x53EF;&#x7ED8;&#x5236;&#x5C42;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x800C;&#x65B9;&#x5F0F;&#x5C31;&#x662F;&#x9700;&#x8981;&#x5C06; <code>FlutterViews</code> &#x80CC;&#x666F;&#x989C;&#x8272;&#x8BBE;&#x7F6E;&#x4E3A;&#x975E;&#x96F6;&#x503C;&#x3002;</p>
<p>&#x6B64;&#x66F4;&#x6539;&#x6D88;&#x9664;&#x4E86;&#x6700;&#x8FD1; iOS 120Hz &#x663E;&#x793A;&#x5668;&#x4E0A;&#x7684;&#x4F4E;&#x5E27;&#x7387;&#x95EE;&#x9898;&#xFF0C;<strong>&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#x5B83;&#x4F1A;&#x4F7F;&#x5E27;&#x901F;&#x7387;&#x589E;&#x52A0;&#x4E09;&#x500D;</strong>&#xFF0C;&#x8FD9;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x4E86;&#x516D;&#x4E2A; GitHub issue&#x3002;</p>
<p><strong>&#x8FD9;&#x4E00;&#x53D8;&#x5316;&#x5177;&#x6709;&#x610F;&#x4E49;&#x91CD;&#x5927;&#xFF0C;&#x4EE5;&#x81F3;&#x4E8E;&#x6211;&#x4EEC;&#x5411;&#x540E;&#x79FB;&#x690D;&#x4E86;&#x4E00;&#x4E2A;&#x4FEE;&#x8865;&#x7A0B;&#x5E8F;&#x5230; 3.7 &#x7248;&#x672C;&#x4E2D;</strong>&#x3002;</p>
<p>&#x5728; 3.7 &#x7A33;&#x5B9A;&#x7248;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x672C;&#x5730;&#x56FE;&#x50CF;&#x7684;&#x52A0;&#x8F7D;&#x4ECE;&#x5E73;&#x53F0;&#x7EBF;&#x7A0B;&#x8F6C;&#x79FB;&#x5230; Dart &#x7EBF;&#x7A0B;&#xFF0C;&#x4EE5;&#x907F;&#x514D;&#x5EF6;&#x8FDF;&#x6765;&#x81EA;&#x5E73;&#x53F0;&#x7EBF;&#x7A0B;&#x7684; vsync &#x4E8B;&#x4EF6;&#x3002;&#x4F46;&#x662F;<a href="/external_links/3205d1ecb5ddfa9f0b93d2c8d8e82925.html" target="blank" rel="noopener">&#x7528;&#x6237;</a>&#x6CE8;&#x610F;&#x5230; Dart &#x7EBF;&#x7A0B;&#x4E0A;&#x7684;&#x8FD9;&#x9879;&#x989D;&#x5916;&#x5DE5;&#x4F5C;&#x4E5F;&#x5BFC;&#x81F4;&#x4E86;&#x4E00;&#x4E9B;&#x5361;&#x987F;&#x3002;</p>
<p>&#x5728; 3.10 &#x4E2D;&#xFF0C;<strong>&#x6211;&#x4EEC;&#x5C06;&#x672C;&#x5730;&#x56FE;&#x50CF;&#x7684;&#x6253;&#x5F00;&#x548C;&#x89E3;&#x7801;&#x4ECE; Dart &#x7EBF;&#x7A0B;&#x79FB;&#x81F3;<a href="/external_links/d686a7f70c452f8ce911050b9a31bcf9.html" target="blank" rel="noopener">&#x540E;&#x53F0;&#x7EBF;&#x7A0B;</a></strong>&#xFF0C;&#x8FD9;&#x4E2A;&#x66F4;&#x6539;&#x6D88;&#x9664;&#x4E86;&#x5177;&#x6709;&#x5927;&#x91CF;&#x672C;&#x5730;&#x56FE;&#x50CF;&#x7684;&#x5C4F;&#x5E55;&#x4E0A;&#x6F5C;&#x5728;&#x7684;&#x957F;&#x65F6;&#x95F4;&#x505C;&#x987F;&#xFF0C;&#x540C;&#x65F6;&#x907F;&#x514D;&#x4E86;&#x5EF6;&#x8FDF; vsync &#x4E8B;&#x4EF6;&#xFF0C;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x672C;&#x5730;&#x6D4B;&#x8BD5;&#x548C;&#x81EA;&#x52A8;&#x5316;&#x57FA;&#x51C6;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x66F4;&#x6539;&#x5C06;&#x591A;&#x4E2A;&#x540C;&#x6B65;&#x56FE;&#x50CF;&#x7684;&#x52A0;&#x8F7D;&#x65F6;&#x95F4;&#x7F29;&#x77ED;&#x4E86;&#x4E00;&#x534A;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/df253dd2fcf70e9cc51f7470d166c4e2d457bbe2f03572186187ab5917b70694" alt></p>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x5728; Flutter &#x65B0;&#x7684;&#x5185;&#x90E8; DisplayList &#x7ED3;&#x6784;&#x4E4B;&#x4E0A;&#x6784;&#x5EFA;&#x4F18;&#x5316;&#xFF0C;&#x5728; 3.10 &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x4E86; <a href="/external_links/b1319997ec22500caceda4861c305da5.html" target="blank" rel="noopener">R-Tree based culling</a> &#x673A;&#x5236;&#x3002;</p>
<p>&#x8FD9;&#x79CD;&#x673A;&#x5236;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x6E32;&#x67D3;&#x5668;&#x4E2D;&#x66F4;&#x65E9;&#x5730;&#x79FB;&#x9664;&#x4E86;&#x7ED8;&#x5236;&#x64CD;&#x4F5C;&#x7684;&#x5904;&#x7406;&#x3002;<a href="/external_links/ccdd138dc9d8228eb54dd82fb35063ff.html" target="blank" rel="noopener">&#x4F8B;&#x5982;</a> &#x4F18;&#x5316;&#x52A0;&#x901F;&#x4E86;&#x8F93;&#x51FA;&#x5728;&#x5C4F;&#x5E55;&#x5916;&#x5931;&#x8D25;&#x7684;&#x81EA;&#x5B9A;&#x4E49;painter&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x7684; <a href="/external_links/97c89db43c9a22aaf5842574f10dcb04.html" target="blank" rel="noopener">microbenchmarks</a> &#x663E;&#x793A; DisplayList &#x5904;&#x7406;&#x65F6;&#x95F4;&#x6700;&#x591A;&#x51CF;&#x5C11;&#x4E86; 50%&#xFF0C;&#x5177;&#x6709;&#x88C1;&#x526A;&#x81EA;&#x5B9A;&#x4E49;&#x7ED8;&#x753B;&#x7684; App &#x53EF;&#x80FD;&#x4F1A;&#x770B;&#x5230;&#x4E0D;&#x540C;&#x6548;&#x679C;&#x7684;&#x6539;&#x8FDB;&#xFF0C;&#x6539;&#x8FDB;&#x7684;&#x7A0B;&#x5EA6;&#x53D6;&#x51B3;&#x4E8E;&#x9690;&#x85CF;&#x7ED8;&#x5236;&#x64CD;&#x4F5C;&#x7684;&#x590D;&#x6742;&#x6027;&#x548C;&#x6570;&#x91CF;&#x3002;</p>
<h2 id="&#x51CF;&#x5C11;-iOS-&#x542F;&#x52A8;&#x5EF6;&#x8FDF;"><a href="#&#x51CF;&#x5C11;-iOS-&#x542F;&#x52A8;&#x5EF6;&#x8FDF;" class="headerlink" title="&#x51CF;&#x5C11; iOS &#x542F;&#x52A8;&#x5EF6;&#x8FDF;"></a>&#x51CF;&#x5C11; iOS &#x542F;&#x52A8;&#x5EF6;&#x8FDF;</h2><p>&#x4E4B;&#x524D;&#x5E94;&#x7528;&#x4E2D;&#x6807;&#x8BC6;&#x7B26;&#x67E5;&#x627E;&#x7684;<a href="/external_links/06d1512fc8474ae9d79f93ca48f95ee8.html" target="blank" rel="noopener">&#x4F4E;&#x6548;&#x7B56;&#x7565;</a>&#x589E;&#x52A0;&#x4E86;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x5EF6;&#x8FDF;&#xFF0C;&#x8FD9;&#x4E2A;&#x542F;&#x52A8;&#x5EF6;&#x8FDF;&#x7684;&#x589E;&#x957F;&#x4E0E;&#x5E94;&#x7528;&#x7684;&#x5927;&#x5C0F;&#x6210;&#x6B63;&#x6BD4;&#x3002;</p>
<p>&#x800C;&#x5728; 3.10 &#x4E2D;&#xFF0C;<a href="/external_links/b974b61649c1413e8849cf07d32f2cb6.html" target="blank" rel="noopener">&#x6211;&#x4EEC;&#x4FEE;&#x590D;&#x4E86; bundle identifier lookup</a>&#xFF0C;&#x8FD9;&#x5C06;&#x5927;&#x578B;&#x5E94;&#x7528;&#x7684;&#x542F;&#x52A8;&#x5EF6;&#x8FDF;&#x51CF;&#x5C11;&#x4E86; 100 &#x6BEB;&#x79D2;&#x6216;&#x5927;&#x7EA6; 30&#x2013;50%&#x3002;</p>
<h2 id="&#x7F29;&#x5C0F;&#x5C3A;&#x5BF8;"><a href="#&#x7F29;&#x5C0F;&#x5C3A;&#x5BF8;" class="headerlink" title="&#x7F29;&#x5C0F;&#x5C3A;&#x5BF8;"></a>&#x7F29;&#x5C0F;&#x5C3A;&#x5BF8;</h2><p>Flutter &#x4F7F;&#x7528; <code>SkParagraph</code> &#x4F5C;&#x4E3A;&#x6587;&#x672C;&#x3001;&#x5E03;&#x5C40;&#x548C;&#x6E32;&#x67D3;&#x7684;&#x9ED8;&#x8BA4;&#x5E93;&#xFF0C;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5305;&#x62EC;&#x4E86;&#x4E00;&#x4E2A;&#x6807;&#x5FD7;&#x4EE5;&#x652F;&#x6301;&#x56DE;&#x9000;&#x5230;&#x9057;&#x7559; <code>libtxt</code>&#x548C; <code>minikin</code> &#x3002;</p>
<p>&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5BF9; <code>SkParagraph</code> &#x6709;&#x5145;&#x5206;&#x7684;&#x4FE1;&#x5FC3;&#xFF0C;<a href="/external_links/3ffbe2ec6ee218d49553eb8f272c9e83.html" target="blank" rel="noopener">&#x6211;&#x4EEC;</a>&#x5728; 3.10 &#x4E2D;&#x5220;&#x9664;&#x4E86; <code>libtxt</code> &#x548C; <code>minikin</code> &#x4EE5;&#x53CA;&#x5B83;&#x4EEC;&#x7684;&#x6807;&#x5FD7;&#xFF0C;&#x8FD9;&#x5C06; Flutter &#x7684;&#x538B;&#x7F29;&#x5927;&#x5C0F;&#x51CF;&#x5C11;&#x4E86; 30KB&#x3002;</p>
<blockquote>
<p>&#x770B;&#x8D77;&#x6765;&#x4FE1;&#x5FC3;&#x5341;&#x8DB3;&#x4E86;&#x3002;</p>
</blockquote>
<h2 id="&#x7A33;&#x5B9A;&#x6027;"><a href="#&#x7A33;&#x5B9A;&#x6027;" class="headerlink" title="&#x7A33;&#x5B9A;&#x6027;"></a>&#x7A33;&#x5B9A;&#x6027;</h2><p>&#x5728; 3.0 &#x7248;&#x672C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x6E32;&#x67D3;&#x7BA1;&#x9053;&#x540E;&#x671F;&#x542F;&#x7528;&#x4E86;&#x4E00;&#x9879; Android &#x529F;&#x80FD;&#xFF0C;&#x8BE5;&#x529F;&#x80FD;&#x4F7F;&#x7528;&#x9AD8;&#x7EA7; GPU &#x9A71;&#x52A8;&#xFF0C;&#x5F53;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x201C;dirty&#x201D; &#x533A;&#x57DF;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x8FD9;&#x4E9B;&#x9A71;&#x52A8;&#x529F;&#x80FD;&#x4F1A;&#x91CD;&#x65B0;&#x7ED8;&#x5236;&#x8F83;&#x5C11;&#x7684;&#x5C4F;&#x5E55;&#x5185;&#x5BB9;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x5C06;&#x5B83;&#x6DFB;&#x52A0;&#x5230;&#x65E9;&#x671F;&#x7684;&#x4F18;&#x5316;&#x4E2D;&#x4EE5;&#x8FBE;&#x5230;&#x7C7B;&#x4F3C;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5C3D;&#x7BA1;&#x6211;&#x4EEC;&#x7684;&#x57FA;&#x51C6;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x4E0D;&#x9519;&#xFF0C;&#x4F46;&#x8FD8;&#x662F;&#x51FA;&#x73B0;&#x4E86;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ul>
<li>&#x9996;&#x5148;&#xFF0C;&#x6539;&#x8FDB;&#x6700;&#x591A;&#x7684;&#x57FA;&#x51C6;&#x53EF;&#x80FD;&#x4E0D;&#x4EE3;&#x8868;&#x5B9E;&#x9645;&#x7528;&#x4F8B;&#x3002;</li>
<li>&#x5176;&#x6B21;&#xFF0C;<a href="/external_links/e008477eb993f567001d6a581b60a4fb.html" target="blank" rel="noopener">&#x4E8B;&#x5B9E;&#x8BC1;&#x660E;&#x5F88;&#x96BE;&#x627E;&#x5230;</a>&#x652F;&#x6301;&#x6B64; GPU &#x9A71;&#x52A8;&#x529F;&#x80FD;&#x7684;&#x8BBE;&#x5907;&#x548C; Android &#x7248;&#x672C;&#x96C6;</li>
</ul>
<p>&#x9274;&#x4E8E;&#x6709;&#x9650;&#x7684;&#x8FDB;&#x6B65;&#x548C;&#x652F;&#x6301;&#xFF0C;&#x6211;&#x4EEC;&#x5728; Android &#x4E0A;<a href="/external_links/c5fa286c66e6919ee5ce51487837ea4f.html" target="blank" rel="noopener">&#x7981;&#x7528;&#x4E86;</a>&#x90E8;&#x5206;&#x91CD;&#x7ED8;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x800C;&#x4F7F;&#x7528; Skia &#x540E;&#x7AEF;&#x65F6;&#xFF0C;&#x8BE5;&#x529F;&#x80FD;&#x5728; iOS &#x4E0A;&#x4F9D;&#x7136;&#x4FDD;&#x6301;&#x542F;&#x7528;&#x72B6;&#x6001;&#xFF0C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5728;&#x672A;&#x6765;&#x7684;&#x7248;&#x672C;&#x4E2D;&#x53EF;&#x4EE5;<a href="/external_links/07205ab40be8b510f24e0a968a1c7732.html" target="blank" rel="noopener">&#x901A;&#x8FC7; Impeller &#x542F;&#x7528;&#x5B83;&#x3002;</a></p>
<h1 id="API-&#x6539;&#x8FDB;"><a href="#API-&#x6539;&#x8FDB;" class="headerlink" title="API &#x6539;&#x8FDB;"></a>API &#x6539;&#x8FDB;</h1><h2 id="APNG&#x89E3;&#x7801;&#x5668;"><a href="#APNG&#x89E3;&#x7801;&#x5668;" class="headerlink" title="APNG&#x89E3;&#x7801;&#x5668;"></a>APNG&#x89E3;&#x7801;&#x5668;</h2><p>Flutter 3.10 <a href="/external_links/5a936063b055e311037c951cba315391.html" target="blank" rel="noopener">&#x89E3;&#x51B3;&#x4E86;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x6700;&#x53D7;&#x5173;&#x6CE8;&#x7684;&#x95EE;&#x9898;</a>&#xFF0C;&#x5B83;&#x589E;&#x52A0;&#x4E86; <code>APNG</code> &#x89E3;&#x7801;&#x56FE;&#x50CF;&#x7684;<a href="/external_links/4faf391d425ca86dd9ef511f195bdafe.html" target="blank" rel="noopener">&#x80FD;&#x529B;</a>&#xFF0C;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; Flutter &#x73B0;&#x6709;&#x7684;&#x56FE;&#x7247;&#x52A0;&#x8F7D; API &#x6765;&#x52A0;&#x8F7D; <code>APNG</code> &#x56FE;&#x7247;&#x3002;</p>
<h2 id="&#x56FE;&#x7247;&#x52A0;&#x8F7D;-API-&#x6539;&#x8FDB;"><a href="#&#x56FE;&#x7247;&#x52A0;&#x8F7D;-API-&#x6539;&#x8FDB;" class="headerlink" title="&#x56FE;&#x7247;&#x52A0;&#x8F7D; API &#x6539;&#x8FDB;"></a>&#x56FE;&#x7247;&#x52A0;&#x8F7D; API &#x6539;&#x8FDB;</h2><p>3.10 &#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;<a href="/external_links/88e9f448ce74590171d0e8245ba4b891.html" target="blank" rel="noopener">&#x65B0;&#x65B9;&#x6CD5;</a> <code>instantiateImageCodecWithSize</code>&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x6EE1;&#x8DB3;&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x6761;&#x4EF6;&#x7684;<a href="/external_links/1748edda76bed8ebff3f93b76f3113d0.html" target="blank" rel="noopener">&#x7528;&#x4F8B;&#x652F;&#x6301;&#xFF1A;</a></p>
<ul>
<li>&#x52A0;&#x8F7D;&#x65F6;&#x5BBD;&#x9AD8;&#x6BD4;&#x672A;&#x77E5;</li>
<li>&#x8FB9;&#x754C;&#x6846;&#x7EA6;&#x675F;</li>
<li>&#x539F;&#x59CB;&#x7EB5;&#x6A2A;&#x6BD4;&#x7EA6;&#x675F;</li>
</ul>
<h1 id="Mobile"><a href="#Mobile" class="headerlink" title="Mobile"></a>Mobile</h1><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><h3 id="&#x65E0;&#x7EBF;&#x8C03;&#x8BD5;"><a href="#&#x65E0;&#x7EBF;&#x8C03;&#x8BD5;" class="headerlink" title="&#x65E0;&#x7EBF;&#x8C03;&#x8BD5;"></a>&#x65E0;&#x7EBF;&#x8C03;&#x8BD5;</h3><p><strong>&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x5728;&#x65E0;&#x7EBF;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8FD0;&#x884C;&#x548C;&#x70ED;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x7684; Flutter iOS &#x5E94;&#x7528;</strong>&#x3002;</p>
<p>&#x5728; Xcode &#x4E2D;&#x6210;&#x529F;&#x65E0;&#x7EBF;&#x914D;&#x5BF9; iOS &#x8BBE;&#x5907;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; flutter run &#x5C06;&#x5E94;&#x7528;&#x90E8;&#x7F72;&#x5230;&#x8BE5;&#x8BBE;&#x5907;&#xFF0C;<strong>&#x5982;&#x679C;&#x9047;&#x5230;&#x95EE;&#x9898;&#xFF0C;&#x8BF7;&#x5728; Window &gt; Devices</strong> &#x548C; <strong>Simulators &gt; Devices</strong>&#x4E0B;&#x9A8C;&#x8BC1;&#x7F51;&#x7EDC;&#x56FE;&#x6807;&#x662F;&#x5426;&#x51FA;&#x73B0;&#x5728;&#x8BBE;&#x5907;&#x65C1;&#x8FB9;&#x3002;</p>
<blockquote>
<p>&#x8981;&#x4E86;&#x89E3;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x9605; <a href="/external_links/e493f9b92a3c1d05721705e3c315861e.html" target="blank" rel="noopener">docs.flutter.dev/get-started&#x2026;</a></p>
</blockquote>
<h3 id="&#x5BBD;&#x8272;&#x57DF;&#x56FE;&#x50CF;&#x652F;&#x6301;"><a href="#&#x5BBD;&#x8272;&#x57DF;&#x56FE;&#x50CF;&#x652F;&#x6301;" class="headerlink" title="&#x5BBD;&#x8272;&#x57DF;&#x56FE;&#x50CF;&#x652F;&#x6301;"></a>&#x5BBD;&#x8272;&#x57DF;&#x56FE;&#x50CF;&#x652F;&#x6301;</h3><p>iOS &#x4E0A;&#x7684; Flutter &#x5E94;&#x7528;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x652F;&#x6301;&#x5BBD;&#x8272;&#x57DF;&#x56FE;&#x50CF;&#x7684;&#x7CBE;&#x786E;&#x6E32;&#x67D3;&#xFF0C;&#x8981;&#x4F7F;&#x7528;&#x5BBD;&#x8272;&#x57DF;&#x652F;&#x6301;&#xFF0C;&#x5E94;&#x7528;&#x5FC5;&#x987B;&#x4F7F;&#x7528; Impeller &#x5E76;&#x5728; <code>Info.plist</code> &#x6587;&#x4EF6;&#x6DFB;&#x52A0; <code>FLTEnableWideGamut</code>  &#x6807;&#x5FD7;&#x3002;</p>
<h3 id="&#x62FC;&#x5199;&#x68C0;&#x67E5;&#x652F;&#x6301;"><a href="#&#x62FC;&#x5199;&#x68C0;&#x67E5;&#x652F;&#x6301;" class="headerlink" title="&#x62FC;&#x5199;&#x68C0;&#x67E5;&#x652F;&#x6301;"></a>&#x62FC;&#x5199;&#x68C0;&#x67E5;&#x652F;&#x6301;</h3><p><code>SpellCheckConfiguration()</code> &#x63A7;&#x4EF6;&#x73B0;&#x5728;&#x9ED8;&#x8BA4;&#x652F;&#x6301; <a href="/external_links/613bf0b906b354358ff19e48a717103f.html" target="blank" rel="noopener">Apple</a> &#x5728; iOS &#x4E0A;&#x7684;&#x62FC;&#x5199;&#x68C0;&#x67E5;&#x670D;&#x52A1;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>spellCheckConfiguration</code> &#x4E2D;&#x7684;&#x53C2;&#x6570;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E; <code>CupertinoTextField</code> &#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/87679d27f7f35b759706c092a959a08f84f947737f4f15d604301650fc5df3bf" alt></p>
<h3 id="&#x81EA;&#x9002;&#x5E94;&#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;"><a href="#&#x81EA;&#x9002;&#x5E94;&#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;" class="headerlink" title="&#x81EA;&#x9002;&#x5E94;&#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;"></a>&#x81EA;&#x9002;&#x5E94;&#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;</h3><p>3.10 &#x5C06; <code>CupertinoCheckBox</code> &#x548C; <code>CupertinoRadio</code> &#x6DFB;&#x52A0;&#x5230;&#x5E93;&#x4E2D; <code>Cupertino</code> &#xFF0C;&#x4ED6;&#x4EEC;&#x521B;&#x5EFA;&#x7B26;&#x5408; Apple &#x6837;&#x5F0F;&#x7684;&#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;&#x6309;&#x94AE;&#x7EC4;&#x4EF6;&#x3002;</p>
<p>Material &#x590D;&#x9009;&#x6846;&#x548C;&#x5355;&#x9009;&#x63A7;&#x4EF6;&#x6DFB;&#x52A0;&#x4E86; <code>.adaptive</code> &#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x5728; iOS &#x548C; macOS &#x4E0A;&#xFF0C;&#x8FD9;&#x4E9B;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x76F8;&#x5E94;&#x7684; Cupertino &#x63A7;&#x4EF6;&#xFF0C;&#x5728;&#x5176;&#x4ED6;&#x5E73;&#x53F0;&#x4E0A;&#x4F7F;&#x7528; Material &#x63A7;&#x4EF6;&#x3002;</p>
<h3 id="&#x4F18;&#x5316;-Cupertino-&#x52A8;&#x753B;&#x3001;&#x8FC7;&#x6E21;&#x548C;&#x989C;&#x8272;"><a href="#&#x4F18;&#x5316;-Cupertino-&#x52A8;&#x753B;&#x3001;&#x8FC7;&#x6E21;&#x548C;&#x989C;&#x8272;" class="headerlink" title="&#x4F18;&#x5316; Cupertino &#x52A8;&#x753B;&#x3001;&#x8FC7;&#x6E21;&#x548C;&#x989C;&#x8272;"></a>&#x4F18;&#x5316; Cupertino &#x52A8;&#x753B;&#x3001;&#x8FC7;&#x6E21;&#x548C;&#x989C;&#x8272;</h3><p>Flutter 3.10 &#x6539;&#x8FDB;&#x4E86;&#x4E00;&#x4E9B;&#x52A8;&#x753B;&#x3001;&#x8FC7;&#x6E21;&#x548C;&#x989C;&#x8272;&#x4EE5;&#x5339;&#x914D; SwiftUI&#xFF0C;&#x8FD9;&#x4E9B;&#x6539;&#x8FDB;&#x5305;&#x62EC;&#xFF1A;</p>
<ul>
<li><a href="/external_links/281a379950179b76cf8962a5d51e73b7.html" target="blank" rel="noopener">&#x66F4;&#x65B0;</a> <code>CupertinoPageRoute</code></li>
<li><a href="/external_links/46d1e575eec53a022e3abcc2a01a124c.html" target="blank" rel="noopener">&#x6DFB;&#x52A0;</a>&#x6807;&#x9898;&#x653E;&#x5927;&#x52A8;&#x753B; <code>CupertinoSliverNavigationBar</code></li>
<li>&#x6DFB;&#x52A0;&#x51E0;&#x79CD;<a href="/external_links/1b0fa0ccaeca7fddc59f0ff3fb679487.html" target="blank" rel="noopener">&#x65B0;&#x7684; iOS &#x7CFB;&#x7EDF;&#x989C;&#x8272;</a> <code>CupertinoColors</code></li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/88ca3cf25594a54a44e196537a17da142b22ecc3517785b8f39806cef79ed737" alt></p>
<h3 id="PlatformView-&#x6027;&#x80FD;"><a href="#PlatformView-&#x6027;&#x80FD;" class="headerlink" title="PlatformView &#x6027;&#x80FD;"></a>PlatformView &#x6027;&#x80FD;</h3><p>&#x5F53; <code>PlatformViews</code> &#x51FA;&#x73B0;&#x5728;&#x5C4F;&#x5E55;&#x4E0A;&#x65F6;&#xFF0C;Flutter&#x4F1A;&#x9650;&#x5236; iOS &#x4E0A;&#x7684;<a href="/external_links/b86f05d98e06bd4e48623664fd4596dc.html" target="blank" rel="noopener">&#x5237;&#x65B0;&#x7387;&#x4EE5;&#x51CF;&#x5C11;&#x5361;&#x987F;</a>&#xFF0C;&#x5F53;&#x5E94;&#x7528;&#x663E;&#x793A;&#x52A8;&#x753B;&#x6216;&#x53EF;&#x6EDA;&#x52A8;&#x65F6;&#xFF0C;&#x7528;&#x6237;&#x53EF;&#x80FD;&#x4F1A;&#x5728;&#x5E94;&#x7528;&#x51FA;&#x73B0; <code>PlatformViews</code> &#x65F6;&#x6CE8;&#x610F;&#x5230;&#x8FD9;&#x4E00;&#x70B9;&#x3002;</p>
<h3 id="macOS-&#x548C;-iOS-&#x53EF;&#x4EE5;&#x5728;&#x63D2;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x5171;&#x4EAB;&#x4EE3;&#x7801;"><a href="#macOS-&#x548C;-iOS-&#x53EF;&#x4EE5;&#x5728;&#x63D2;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x5171;&#x4EAB;&#x4EE3;&#x7801;" class="headerlink" title="macOS &#x548C; iOS &#x53EF;&#x4EE5;&#x5728;&#x63D2;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x5171;&#x4EAB;&#x4EE3;&#x7801;"></a>macOS &#x548C; iOS &#x53EF;&#x4EE5;&#x5728;&#x63D2;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x5171;&#x4EAB;&#x4EE3;&#x7801;</h3><p>Flutter &#x73B0;&#x5728;&#x652F;&#x6301;&#x63D2;&#x4EF6; <code>pubspec.yaml</code> &#x6587;&#x4EF6;&#x4E2D;&#x7684; <code>sharedDarwinSource</code> &#xFF0C;&#x8FD9;&#x4E2A; key &#x8868;&#x793A; Flutter &#x5E94;&#x8BE5;&#x5171;&#x4EAB; iOS &#x548C; macOS &#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;ios: </span><br><span class="line">  pluginClass:  PathProviderPlugin </span><br><span class="line">  dartPluginClass:  PathProviderFoundation </span><br><span class="line">  sharedDarwinSource:  true </span><br><span class="line">macos: </span><br><span class="line">  pluginClass:  PathProviderPlugin </span><br><span class="line">  dartPluginClass:  PathProviderFoundation </span><br><span class="line">  sharedDarwinSource:  true</span><br></pre></td></tr></table></figure>

<h3 id="&#x5E94;&#x7528;&#x6269;&#x5C55;&#x7684;&#x65B0;&#x8D44;&#x6E90;"><a href="#&#x5E94;&#x7528;&#x6269;&#x5C55;&#x7684;&#x65B0;&#x8D44;&#x6E90;" class="headerlink" title="&#x5E94;&#x7528;&#x6269;&#x5C55;&#x7684;&#x65B0;&#x8D44;&#x6E90;"></a>&#x5E94;&#x7528;&#x6269;&#x5C55;&#x7684;&#x65B0;&#x8D44;&#x6E90;</h3><p>&#x6211;&#x4EEC;&#x4E3A; Flutter &#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x6DFB;&#x52A0;&#x4E86;&#x4F7F;&#x7528; iOS &#x5E94;&#x7528;&#x6269;&#x5C55;&#x6587;&#x6863;&#xFF0C;&#x8FD9;&#x4E9B;&#x6269;&#x5C55;&#x5305;&#x62EC;&#x5B9E;&#x65F6;&#x6D3B;&#x52A8;&#x3001;&#x4E3B;&#x5C4F;&#x5E55;&#x63A7;&#x4EF6;&#x548C;&#x5171;&#x4EAB;&#x6269;&#x5C55;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x521B;&#x5EFA;&#x4E3B;&#x5C4F;&#x5E55;&#x63A7;&#x4EF6;&#x548C;&#x5171;&#x4EAB;&#x6570;&#x636E;&#xFF0C;&#x6211;&#x4EEC;&#x5411; <code>path_provider</code> &#x548C; <code>homescreen_widget</code> &#x63D2;&#x4EF6;&#x6DFB;&#x52A0;&#x4E86;&#x65B0;&#x65B9;&#x6CD5;&#x3002;</p>
<blockquote>
<p>&#x5177;&#x4F53;&#x53EF;&#x89C1;&#xFF1A;<a href="/external_links/be9393da8c28b632abc1608af99e1bd8.html" target="blank" rel="noopener">docs.flutter.dev/development&#x2026;</a></p>
</blockquote>
<h3 id="&#x8DE8;&#x5E73;&#x53F0;&#x8BBE;&#x8BA1;&#x7684;&#x65B0;&#x8D44;&#x6E90;"><a href="#&#x8DE8;&#x5E73;&#x53F0;&#x8BBE;&#x8BA1;&#x7684;&#x65B0;&#x8D44;&#x6E90;" class="headerlink" title="&#x8DE8;&#x5E73;&#x53F0;&#x8BBE;&#x8BA1;&#x7684;&#x65B0;&#x8D44;&#x6E90;"></a>&#x8DE8;&#x5E73;&#x53F0;&#x8BBE;&#x8BA1;&#x7684;&#x65B0;&#x8D44;&#x6E90;</h3><p>&#x8BE5;&#x6587;&#x6863;&#x73B0;&#x5728;&#x5305;&#x62EC;&#x9488;&#x5BF9;&#x7279;&#x5B9A; <a href="/external_links/f816aa05be01d1e77f40c1975d0dd1f8.html" target="blank" rel="noopener">UI &#x7EC4;&#x4EF6;</a>&#x7684;&#x8DE8;&#x5E73;&#x53F0;&#x8BBE;&#x8BA1;&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#xFF0C;&#x8981;&#x4E86;&#x89E3;&#x6709;&#x5173;&#x8FD9;&#x4E9B; UI &#x7EC4;&#x4EF6;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x67E5;&#x770B;Flutter UX GitHub &#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x7684;&#x8BA8;&#x8BBA;&#xFF1A; <a href="/external_links/bb9ae14795eb37357cc2e825aeb11939.html" target="blank" rel="noopener">github.com/flutter/uxr&#x2026;</a></p>
<blockquote>
<p>&#x5177;&#x4F53;&#x53EF;&#x89C1;&#xFF1A;<a href="/external_links/f816aa05be01d1e77f40c1975d0dd1f8.html" target="blank" rel="noopener">docs.flutter.dev/resources/p&#x2026;</a></p>
</blockquote>
<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><h3 id="Android-CameraX-&#x652F;&#x6301;"><a href="#Android-CameraX-&#x652F;&#x6301;" class="headerlink" title="Android CameraX &#x652F;&#x6301;"></a>Android CameraX &#x652F;&#x6301;</h3><p><a href="/external_links/8220bc0ce6b409c2284db15d005b0d69.html" target="blank" rel="noopener">Camera X</a> &#x662F;&#x4E00;&#x4E2A; Jetpack &#x5E93;&#xFF0C;&#x53EF;&#x7B80;&#x5316;&#x5411; Android &#x5E94;&#x7528;&#x6DFB;&#x52A0;&#x4E30;&#x5BCC;&#x7684;&#x76F8;&#x673A;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x8BE5;&#x529F;&#x80FD;&#x9002;&#x7528;&#x4E8E;&#x591A;&#x79CD; Android &#x76F8;&#x673A;&#x786C;&#x4EF6;&#xFF0C;&#x5728; 3.10 &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E3A; Flutter Camera &#x63D2;&#x4EF6;&#x6DFB;&#x52A0;&#x4E86;&#x5BF9; CameraX &#x7684;&#x521D;&#x6B65;&#x652F;&#x6301;&#xFF0C;&#x6B64;&#x652F;&#x6301;&#x6DB5;&#x76D6;&#x4EE5;&#x4E0B;&#x7528;&#x4F8B;&#xFF1A;</p>
<ul>
<li>&#x56FE;&#x50CF;&#x6355;&#x6349;</li>
<li>&#x89C6;&#x9891;&#x5F55;&#x5236;</li>
<li>&#x663E;&#x793A;&#x5B9E;&#x65F6;&#x76F8;&#x673A;&#x9884;&#x89C8;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Dependencies: </span><br><span class="line">  camera:  ^0.10.4  # &#x6700;&#x65B0;&#x76F8;&#x673A;&#x7248;&#x672C;</span><br><span class="line">  camera_android_camerax:  ^0.5.0</span><br></pre></td></tr></table></figure>

<h1 id="&#x5F00;&#x53D1;&#x8005;&#x5DE5;&#x5177;"><a href="#&#x5F00;&#x53D1;&#x8005;&#x5DE5;&#x5177;" class="headerlink" title="&#x5F00;&#x53D1;&#x8005;&#x5DE5;&#x5177;"></a>&#x5F00;&#x53D1;&#x8005;&#x5DE5;&#x5177;</h1><p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x6539;&#x8FDB;&#x4E86; DevTools&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x5957;&#x7528;&#x4E8E; Dart &#x548C; Flutter &#x7684;&#x6027;&#x80FD;&#x548C;&#x8C03;&#x8BD5;&#x5DE5;&#x5177;&#xFF0C;&#x4E00;&#x4E9B;&#x4EAE;&#x70B9;&#x5305;&#x62EC;&#xFF1A;</p>
<ul>
<li>DevTools UI &#x4F7F;&#x7528; Material 3&#xFF0C;&#x8FD9;&#x8BA9;&#x5916;&#x89C2;&#x73B0;&#x4EE3;&#x5316;&#x53C8;&#x589E;&#x5F3A;&#x4E86;&#x53EF;&#x8BBF;&#x95EE;&#x6027;&#x3002;</li>
<li>DevTools &#x63A7;&#x5236;&#x53F0;&#x652F;&#x6301;&#x5728;&#x8C03;&#x8BD5;&#x6A21;&#x5F0F;&#x4E0B;&#x8BC4;&#x4F30;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x5E94;&#x7528;&#xFF0C;&#x5728; 3.10 &#x4E4B;&#x524D;&#xFF0C;&#x53EA;&#x80FD;&#x5728;&#x6682;&#x505C;&#x5E94;&#x7528;&#x65F6;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#x3002;</li>
<li>&#x5D4C;&#x5165;&#x5F0F; <a href="/external_links/fe3138e26271fbd794a935faf6cda7d4.html" target="blank" rel="noopener">Perfetto &#x8DDF;&#x8E2A;&#x67E5;&#x770B;&#x5668;</a>&#x53D6;&#x4EE3;&#x4E86;&#x4EE5;&#x524D;&#x7684;&#x65F6;&#x95F4;&#x7EBF;&#x8DDF;&#x8E2A;&#x67E5;&#x770B;&#x5668;&#x3002;</li>
</ul>
<p>Perfetto &#x53EF;&#x4EE5;&#x5904;&#x7406;&#x66F4;&#x5927;&#x7684;&#x6570;&#x636E;&#x96C6;&#xFF0C;&#x5E76;&#x4E14;&#x6BD4;&#x4F20;&#x7EDF;&#x7684;&#x8DDF;&#x8E2A;&#x67E5;&#x770B;&#x5668;&#x8868;&#x73B0;&#x5F97;&#x66F4;&#x597D;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<ul>
<li>&#x5141;&#x8BB8;&#x56FA;&#x5B9A;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x7EBF;&#x7A0B;</li>
<li>&#x5355;&#x51FB;&#x5E76;&#x62D6;&#x52A8;&#x4EE5;&#x4ECE;&#x591A;&#x4E2A;&#x5E27;&#x4E2D;&#x9009;&#x62E9;&#x591A;&#x4E2A;&#x65F6;&#x95F4;&#x8F74;&#x4E8B;&#x4EF6;</li>
<li>&#x4F7F;&#x7528; SQL &#x67E5;&#x8BE2;&#x4ECE;&#x65F6;&#x95F4;&#x8F74;&#x4E8B;&#x4EF6;&#x4E2D;&#x63D0;&#x53D6;&#x7279;&#x5B9A;&#x6570;&#x636E;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/8ac9e29988c33a9ff62458f1e0cb12a1178626cca0cbd949b35d1d0339872ac1" alt></p>
<h1 id="&#x5F03;&#x7528;&#x548C;&#x91CD;&#x5927;&#x66F4;&#x6539;"><a href="#&#x5F03;&#x7528;&#x548C;&#x91CD;&#x5927;&#x66F4;&#x6539;" class="headerlink" title="&#x5F03;&#x7528;&#x548C;&#x91CD;&#x5927;&#x66F4;&#x6539;"></a>&#x5F03;&#x7528;&#x548C;&#x91CD;&#x5927;&#x66F4;&#x6539;</h1><h2 id="&#x5F03;&#x7528;&#x7684;-API"><a href="#&#x5F03;&#x7528;&#x7684;-API" class="headerlink" title="&#x5F03;&#x7528;&#x7684; API"></a>&#x5F03;&#x7528;&#x7684; API</h2><p>3.10 &#x4E2D;&#x7684;&#x91CD;&#x5927;&#x66F4;&#x6539;&#x5305;&#x62EC;&#x5728; v3.7 &#x53D1;&#x5E03;&#x540E;&#x8FC7;&#x671F;&#x7684;&#x5F03;&#x7528; API&#x3002;</p>
<p>&#x8981;&#x67E5;&#x770B;&#x6240;&#x6709;&#x53D7;&#x5F71;&#x54CD;&#x7684; API &#x4EE5;&#x53CA;&#x5176;&#x4ED6;&#x4E0A;&#x4E0B;&#x6587;&#x548C;&#x8FC1;&#x79FB;&#x6307;&#x5357;&#xFF0C;&#x8BF7;&#x67E5;&#x770B;<a href="/external_links/655fdd156f3e5d35e12ae8cf8d69f6b5.html" target="blank" rel="noopener">&#x4E4B;&#x524D;&#x7248;&#x672C;&#x7684;&#x5F03;&#x7528;&#x6307;&#x5357;</a>&#x3002;</p>
<blockquote>
<p><a href="/external_links/45ca80860c3523db2431441380c55efb.html" target="blank" rel="noopener">Dart Fix</a> &#x53EF;&#x4EE5;&#x4FEE;&#x590D;&#x5176;&#x4E2D;&#x7684;&#x8BB8;&#x591A;&#x95EE;&#x9898;&#xFF0C;&#x5305;&#x62EC;&#x5728; IDE &#x4E2D;&#x5FEB;&#x901F;&#x4FEE;&#x590D;&#x548C;&#x4F7F;&#x7528;<code>dart fix</code>&#x547D;&#x4EE4;&#x6279;&#x91CF;&#x5E94;&#x7528;&#x3002;</p>
</blockquote>
<h2 id="Android-Studio-Flamingo-&#x5347;&#x7EA7;"><a href="#Android-Studio-Flamingo-&#x5347;&#x7EA7;" class="headerlink" title="Android Studio Flamingo &#x5347;&#x7EA7;"></a>Android Studio Flamingo &#x5347;&#x7EA7;</h2><p>&#x5C06; Android Studio &#x5347;&#x7EA7;&#x5230; Flamingo &#x540E;&#xFF0C;&#x4F60;&#x53EF;&#x80FD;&#x4F1A;&#x5728;&#x5C1D;&#x8BD5; <code>flutter run</code> &#x6216; <code>flutter build</code> Flutter Android &#x5E94;&#x7528;&#x65F6;&#x770B;&#x5230;&#x9519;&#x8BEF;&#x3002;</p>
<p><a href="/external_links/3beb1fbe130bf51b1491adafa585bea7.html" target="blank" rel="noopener">&#x53D1;&#x751F;&#x6B64;&#x9519;&#x8BEF;&#x662F;&#x56E0;&#x4E3A; Android Studio Flamingo &#x5C06;&#x5176;&#x6346;&#x7ED1;&#x7684; Java SDK &#x4ECE; 11 &#x66F4;&#x65B0;&#x5230; 17&#xFF0C;</a>&#x4F7F;&#x7528; Java 17 &#x65F6;&#xFF0C;&#x4E4B;&#x524D;&#x7684; 7.3 Gradle &#x7248;&#x672C;&#x65E0;&#x6CD5;&#x8FD0;&#x884C;&#x3002;</p>
<p>&#x6211;&#x4EEC;<a href="/external_links/b484664c7598be81be3ff82ee2ce3562.html" target="blank" rel="noopener">&#x66F4;&#x65B0;</a>&#x6765;&#x4E86; <code>flutter analyze --suggestions</code> &#x4EE5;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x7531;&#x4E8E; Java SDK &#x548C; Gradle &#x7248;&#x672C;&#x4E4B;&#x95F4;&#x7684;&#x4E0D;&#x517C;&#x5BB9;&#x800C;&#x53D1;&#x751F;&#x6B64;&#x9519;&#x8BEF;&#x3002;</p>
<blockquote>
<p>&#x8981;&#x4E86;&#x89E3;&#x4FEE;&#x590D;&#x6B64;&#x9519;&#x8BEF;&#x7684;&#x4E0D;&#x540C;&#x65B9;&#x6CD5;&#xFF0C;&#x8BF7;&#x67E5;&#x770B;&#x6211;&#x4EEC;&#x7684;&#x8FC1;&#x79FB;&#x6307;&#x5357;&#xFF1A;<a href="/external_links/b4dd9691c630c20872c1c821e475d869.html" target="blank" rel="noopener">docs.flutter.dev/go/android-&#x2026;</a></p>
</blockquote>
<h2 id="Window-singleton-&#x5F03;&#x7528;"><a href="#Window-singleton-&#x5F03;&#x7528;" class="headerlink" title="Window singleton &#x5F03;&#x7528;"></a>Window singleton &#x5F03;&#x7528;</h2><p>&#x8BE5;&#x7248;&#x672C;&#x5F03;&#x7528;&#x4E86; Window singleton&#xFF0C;&#x4F9D;&#x8D56;&#x5B83;&#x7684;&#x5E94;&#x7528;&#x548C;&#x5E93;&#x9700;&#x8981;&#x5F00;&#x59CB;<a href="/external_links/f042cb3cd1f8dc5fcbcf683cc2803d46.html" target="blank" rel="noopener">&#x8FC1;&#x79FB;</a>&#x3002;</p>
<p>&#x5F53;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x5728;&#x672A;&#x6765;&#x7248;&#x672C;&#x7684; Flutter &#x4E2D;&#x505A;&#x652F;&#x6301;&#x65F6;&#xFF0C;&#x8FD9;&#x4F1A;&#x53EF;&#x4EE5;&#x4E3A;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x63D0;&#x524D;&#x505A;&#x597D;&#x591A;&#x7A97;&#x53E3;&#x51C6;&#x5907;&#x652F;&#x6301;&#x3002;</p>
<blockquote>
<p>PS&#xFF1A;&#x8FD8;&#x53EF;&#x4EE5;&#x5173;&#x6CE8;&#x4E0B;&#x672C;&#x6B21; I/O &#x57FA;&#x4E8E; Flutter &#x53D1;&#x5E03;&#x7684;&#x65B0;&#x5C0F;&#x6E38;&#x620F;&#xFF1A;<a href="https://dev.newban.cn/7231378331139997757">I/O FLIP &#x5C0F;&#x6E38;&#x620F;</a></p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/4e0bbb8bcdbac974b3d0084014ac2f8d.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7231539903649349691.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7231539903649349691.html" itemprop="url">【若川视野 x 源码共读】44期   神器啊，从未想过 VS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-10T22:52:13+08:00">
                2023-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x524D;&#x8A00;"><a href="#&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x524D;&#x8A00;" class="headerlink" title="&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x524D;&#x8A00;"></a>&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x524D;&#x8A00;</h2><p><strong>&#x4E3A;&#x4E86;&#x80FD;&#x5E2E;&#x52A9;&#x5230;&#x66F4;&#x591A;&#x5BF9;&#x6E90;&#x7801;&#x611F;&#x5174;&#x8DA3;&#x3001;&#x60F3;&#x5B66;&#x4F1A;&#x770B;&#x6E90;&#x7801;&#x3001;&#x63D0;&#x5347;&#x81EA;&#x5DF1;&#x5199;&#x4F5C;&#x548C;&#x524D;&#x7AEF;&#x6280;&#x672F;&#x80FD;&#x529B;&#x7684;&#x540C;&#x5B66;&#x3002;</strong> &#x5E2E;&#x52A9;&#x8BFB;&#x8005;&#x592F;&#x5B9E;&#x57FA;&#x7840;&#xFF0C;&#x67E5;&#x6F0F;&#x8865;&#x7F3A;&#xFF0C;&#x5F00;&#x9614;&#x773C;&#x754C;&#xFF0C;&#x62D3;&#x5BBD;&#x89C6;&#x91CE;&#xFF0C;&#x77E5;&#x5176;&#x7136;&#x77E5;&#x5176;&#x6240;&#x4EE5;&#x7136;&#x3002;</p>
<p>&#x6211;&#x503E;&#x529B;&#x7EC4;&#x7EC7;&#x4E86;&#x6BCF;&#x5468;&#x4E00;&#x8D77;&#x5B66;200&#x884C;&#x5DE6;&#x53F3;&#x7684;&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x6D3B;&#x52A8;&#x3002;&#x6211;&#x5199;&#x6709;<a href="/external_links/fedfaff5eac6f4a3b25ab39b65554b53.html" target="blank" rel="noopener">&#x300A;&#x5B66;&#x4E60;&#x6E90;&#x7801;&#x6574;&#x4F53;&#x67B6;&#x6784;&#x7CFB;&#x5217;&#x300B;</a>20&#x4F59;&#x7BC7;&#xFF0C;<strong>&#x8D70;&#x8FC7;&#x8DEF;&#x8FC7;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x53EF;&#x4EE5;&#x70B9;&#x51FB;&#x5173;&#x6CE8;&#x4E0B;&#x8FD9;&#x4E2A;&#x76EE;&#x524D;&#x662F;&#x6398;&#x91D1;&#x5173;&#x6CE8;&#x6570;&#x6700;&#x591A;&#x7684;&#x4E13;&#x680F;</strong>&#x3002;</p>
<p><strong>&#x6B22;&#x8FCE;<a href="/external_links/f6715fb41c5add76a791f132e3c512af.html" target="blank" rel="noopener">&#x70B9;&#x6B64;&#x626B;&#x7801;&#x52A0;&#x6211;&#x5FAE;&#x4FE1; ruochuan02</a> &#x4EA4;&#x6D41;&#xFF0C;&#x53C2;&#x4E0E; <a href="https://dev.newban.cn/7079706017579139102">&#x6E90;&#x7801;&#x5171;&#x8BFB;</a> &#x6D3B;&#x52A8;&#xFF0C;&#x6BCF;&#x5468;&#x5927;&#x5BB6;&#x4E00;&#x8D77;&#x5B66;&#x4E60;200&#x884C;&#x5DE6;&#x53F3;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5171;&#x540C;&#x8FDB;&#x6B65;&#x3002;&#x53EF;&#x4EE5;&#x6301;&#x7EED;&#x5173;&#x6CE8;&#x6211;<a href="/external_links/0eaae9aee67b3837a4608f6f57e3fe73.html" target="blank" rel="noopener">@&#x82E5;&#x5DDD;</a></strong>&#x3002;</p>
<h2 id="&#x4ECE;&#x6613;&#x5230;&#x96BE;&#x63A8;&#x8350;&#x5B66;&#x4E60;&#x987A;&#x5E8F;"><a href="#&#x4ECE;&#x6613;&#x5230;&#x96BE;&#x63A8;&#x8350;&#x5B66;&#x4E60;&#x987A;&#x5E8F;" class="headerlink" title="&#x4ECE;&#x6613;&#x5230;&#x96BE;&#x63A8;&#x8350;&#x5B66;&#x4E60;&#x987A;&#x5E8F;"></a>&#x4ECE;&#x6613;&#x5230;&#x96BE;&#x63A8;&#x8350;&#x5B66;&#x4E60;&#x987A;&#x5E8F;</h2><p>&#x6D3B;&#x52A8;&#x4ECB;&#x7ECD;&#x548C;&#x987A;&#x5E8F;&#x5177;&#x4F53;&#x770B;&#x8FD9;&#x91CC;<a href="https://dev.newban.cn/7079706017579139102#heading-3">&#x4ECE;&#x6613;&#x5230;&#x96BE;&#x63A8;&#x8350;&#x5B66;&#x4E60;&#x987A;&#x5E8F;</a></p>
<h2 id="&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;"><a href="#&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;" class="headerlink" title="&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;"></a>&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;</h2><p><a href="https://dev.newban.cn/7079706017579139102#heading-2">&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;&#x65B9;&#x5F0F;&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x770B;&#x8FD9;&#x91CC;</a><br>&#x7B80;&#x8A00;&#x4E4B;&#xFF1A;&#x770B;&#x4EFB;&#x52A1;&#xFF0C;&#x770B;&#x8F85;&#x52A9;&#x6587;&#x7AE0;&#x3001;&#x770B;&#x6E90;&#x7801;&#xFF0C;&#x4EA4;&#x6D41;&#x8BA8;&#x8BBA;&#xFF0C;&#x5728;&#x6398;&#x91D1;&#x5199;&#x7B14;&#x8BB0;&#xFF0C;&#x5199;&#x597D;&#x540E;&#x63D0;&#x4EA4;&#x5230;&#x672C;&#x6587;&#x8BC4;&#x8BBA;&#x533A;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x7ED9;&#x5927;&#x5BB6;&#x8C0B;&#x798F;&#x5229;&#xFF0C;&#x53E6;&#x5916;&#x7ED9;&#x5927;&#x5BB6;&#x7684;&#x6587;&#x7AE0;&#x5E26;&#x6765;&#x66F4;&#x591A;&#x9605;&#x8BFB;&#x91CF;&#xFF0C;&#x4FBF;&#x4E8E;&#x641C;&#x7D22;&#xFF0C;&#x4ECE;2022&#x5E74;3&#x6708;27&#x65E5;&#x8D77;&#xFF0C;&#x7B14;&#x8BB0;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x53D1;&#x5E03;&#x5728;&#x6398;&#x91D1;&#xFF0C;&#x4EE5;&#x300A;&#x6807;&#x9898;&#x81EA;&#x53D6;&#x300B;&#x6807;&#x9898;&#x4E0D;&#x9650;&#xFF0C;&#x53EF;&#x4EE5;&#x53D6;&#x4E2A;&#x597D;&#x6807;&#x9898;&#xFF0C;&#x5BB9;&#x6613;&#x88AB;&#x6398;&#x91D1;&#x63A8;&#x8350;&#x3002;</p>
<p><strong>&#x7B14;&#x8BB0;&#x6587;&#x7AE0;&#x5F00;&#x5934;&#x52A0;&#x4E24;&#x53E5;&#x8BDD;</strong>&#xFF1A;</p>
<ul>
<li><strong>&#x672C;&#x6587;&#x53C2;&#x52A0;&#x4E86;&#x7531;</strong><a href="/external_links/2e94e5f617ec57b813b3f7922f4fcea6.html" target="blank" rel="noopener">&#x516C;&#x4F17;&#x53F7;@&#x82E5;&#x5DDD;&#x89C6;&#x91CE;</a> <strong>&#x53D1;&#x8D77;&#x7684;&#x6BCF;&#x5468;&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x6D3B;&#x52A8;&#xFF0C;</strong> <a href="https://dev.newban.cn/7079706017579139102">&#x70B9;&#x51FB;&#x4E86;&#x89E3;&#x8BE6;&#x60C5;&#x4E00;&#x8D77;&#x53C2;&#x4E0E;&#x3002;</a></li>
<li><strong>&#x8FD9;&#x662F;&#x6E90;&#x7801;&#x5171;&#x8BFB;&#x7684;&#x7B2C;xx&#x671F;&#xFF0C;&#x94FE;&#x63A5;&#xFF1A;xxx&#x3002;</strong></li>
</ul>
<p><strong>&#x7B14;&#x8BB0;&#x6587;&#x7AE0;&#x6700;&#x540E;&#xFF0C;&#x5EFA;&#x8BAE;&#x5199;&#x4E0A;&#x603B;&#x7ED3;&#x3001;&#x6536;&#x83B7;&#x3001;&#x611F;&#x53D7;&#x7B49;&#x3002;</strong></p>
<ul>
<li><strong>&#x5F00;&#x5934;&#x7B2C;&#x4E00;&#x53E5;&#x4F5C;&#x7528;&#x662F;</strong>&#xFF1A;&#x65B9;&#x4FBF;&#x6BCF;&#x6708;&#x7EDF;&#x8BA1;&#x8BC4;&#x4F18;&#xFF0C;&#x6398;&#x91D1;&#x8D5E;&#x52A9;&#x9001;&#x5C0F;&#x793C;&#x7269;&#x3002;&#x987A;&#x4FBF;&#x5E2E;&#x5FD9;&#x5BA3;&#x4F20;&#x63A8;&#x5E7F;&#xFF0C;&#x8BA9;&#x66F4;&#x591A;&#x4EBA;&#x53C2;&#x4E0E;&#x8FDB;&#x6765;&#xFF0C;&#x4E00;&#x8D77;&#x5B66;&#x4E60;&#x3002;</li>
<li><strong>&#x5F00;&#x5934;&#x7B2C;&#x4E8C;&#x53E5;&#x4F5C;&#x7528;&#x662F;</strong>&#xFF1A;&#x52A0;&#x4E0A;&#x662F;&#x591A;&#x5C11;&#x671F;&#xFF0C;&#x5F53;&#x524D;&#x4EFB;&#x52A1;&#x8BF4;&#x660E;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x65B9;&#x4FBF;&#x8BFB;&#x8005;&#x77E5;&#x9053;&#x8FD9;&#x662F;&#x4EC0;&#x4E48;&#x6D3B;&#x52A8;&#x3002;</li>
</ul>
<p><strong>&#x7B14;&#x8BB0;&#x5199;&#x5B8C;&#x540E;&#xFF0C;&#x5230;&#x5F53;&#x524D;&#x671F;&#x6D3B;&#x52A8;&#x7684;&#x6587;&#x7AE0;&#x8BC4;&#x8BBA;&#x533A;&#x7559;&#x8A00;&#x81EA;&#x5DF1;&#x7684;&#x6587;&#x7AE0;&#x548C;&#x7B14;&#x8BB0;&#x7279;&#x70B9;</strong>&#x3002;&#x65B9;&#x4FBF;&#x5927;&#x5BB6;&#x67E5;&#x9605;&#x5B66;&#x4E60;&#x4EA4;&#x6D41;&#x8BA8;&#x8BBA;&#x3002;</p>
<h2 id="&#x4EFB;&#x52A1;&#x53D1;&#x5E03;&#x65F6;&#x95F4;"><a href="#&#x4EFB;&#x52A1;&#x53D1;&#x5E03;&#x65F6;&#x95F4;" class="headerlink" title="&#x4EFB;&#x52A1;&#x53D1;&#x5E03;&#x65F6;&#x95F4;"></a>&#x4EFB;&#x52A1;&#x53D1;&#x5E03;&#x65F6;&#x95F4;</h2><p>2023&#x5E74;5&#x6708;4&#x65E5; - 2023&#x5E74;5&#x6708;21&#x65E5;(&#x4E24;&#x5468;)&#x3002;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x81EA;&#x5DF1;&#x8282;&#x594F;&#x5B66;&#x4E60;&#xFF0C;&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;&#x5373;&#x53EF;&#xFF08;&#x4E0D;&#x4E00;&#x5B9A;&#x8981;&#x4E25;&#x683C;&#x6309;&#x7167;&#x6211;&#x89C4;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#xFF09;&#x3002;&#x5F80;&#x671F;&#x5171;&#x8BFB;&#x4E5F;&#x53EF;&#x4EE5;&#x53CA;&#x65F6;&#x590D;&#x4E60;&#xFF0C;&#x7B14;&#x8BB0;&#x672A;&#x5B8C;&#x6210;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x5B8C;&#x6210;&#x3002;</p>
<h3 id="&#x8BED;&#x96C0;&#x672C;&#x671F;&#x4EFB;&#x52A1;&#x8BF4;&#x660E;&#x94FE;&#x63A5;"><a href="#&#x8BED;&#x96C0;&#x672C;&#x671F;&#x4EFB;&#x52A1;&#x8BF4;&#x660E;&#x94FE;&#x63A5;" class="headerlink" title="&#x8BED;&#x96C0;&#x672C;&#x671F;&#x4EFB;&#x52A1;&#x8BF4;&#x660E;&#x94FE;&#x63A5;"></a>&#x8BED;&#x96C0;&#x672C;&#x671F;&#x4EFB;&#x52A1;&#x8BF4;&#x660E;&#x94FE;&#x63A5;</h3><p><a href="/external_links/0312c4e7ff021ab29f0777ffbf795661.html" target="blank" rel="noopener">&#x8BED;&#x96C0;&#x6709;&#x6811;&#x5F62;&#x83DC;&#x5355;&#xFF0C;&#x66F4;&#x65B9;&#x4FBF;&#x67E5;&#x770B;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x653E;&#x4E0B;&#x8BED;&#x96C0;&#x7684;&#x8FD9;&#x4E00;&#x671F;&#x94FE;&#x63A5;</a></p>
<h2 id="&#x5B66;&#x4E60;&#x4EFB;&#x52A1;"><a href="#&#x5B66;&#x4E60;&#x4EFB;&#x52A1;" class="headerlink" title="&#x5B66;&#x4E60;&#x4EFB;&#x52A1;"></a>&#x5B66;&#x4E60;&#x4EFB;&#x52A1;</h2><ol>
<li>&#x5982;&#x4F55;&#x5F00;&#x53D1;&#x4E00;&#x4E2A; VSCode &#x63D2;&#x4EF6;</li>
<li>&#x5B66;&#x4F1A;&#x5F00;&#x53D1;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x662F;&#x600E;&#x6837;&#x7684;</li>
<li>&#x5B66;&#x4F1A;&#x8C03;&#x8BD5; VSCode &#x63D2;&#x4EF6;</li>
<li>&#x5B66;&#x4F1A; open in github button vscode &#x63D2;&#x4EF6;&#x7684;&#x539F;&#x7406;&#x662F;&#x4EC0;&#x4E48;</li>
<li>&#x5B66;&#x4F1A; open in github vscode &#x63D2;&#x4EF6;&#x539F;&#x7406;</li>
</ol>
<ul>
<li>&#x53C2;&#x8003;&#x6211;&#x7684;&#x6587;&#x7AE0;</li>
<li><a href="https://dev.newban.cn/7226376235559403575">&#x795E;&#x5668;&#x554A;&#xFF0C;&#x4ECE;&#x672A;&#x60F3;&#x8FC7; VSCode &#x8FD8;&#x80FD;&#x8FD9;&#x6837;&#x76F4;&#x63A5;&#x6253;&#x5F00;&#x4ED3;&#x5E93;URL&#xFF0C;&#x539F;&#x7406;&#x63ED;&#x79D8;~</a></li>
</ul>
<h2 id="&#x53C2;&#x8003;&#x6587;&#x7AE0;"><a href="#&#x53C2;&#x8003;&#x6587;&#x7AE0;" class="headerlink" title="&#x53C2;&#x8003;&#x6587;&#x7AE0;"></a>&#x53C2;&#x8003;&#x6587;&#x7AE0;</h2><ul>
<li><a href="https://dev.newban.cn/7226376235559403575">&#x795E;&#x5668;&#x554A;&#xFF0C;&#x4ECE;&#x672A;&#x60F3;&#x8FC7; VSCode &#x8FD8;&#x80FD;&#x8FD9;&#x6837;&#x76F4;&#x63A5;&#x6253;&#x5F00;&#x4ED3;&#x5E93;URL&#xFF0C;&#x539F;&#x7406;&#x63ED;&#x79D8;~</a></li>
<li>&#x770B;&#x6587;&#x7AE0;&#xFF0C;&#x770B;&#x6E90;&#x7801;&#xFF0C;&#x4EA4;&#x6D41;&#x8BA8;&#x8BBA;&#xFF0C;&#x5199;&#x7B14;&#x8BB0;&#x53D1;&#x5E03;&#x5728;&#x6398;&#x91D1;&#x3002;&#x518D;&#x5728;&#x6398;&#x91D1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E0B;&#x8BC4;&#x8BBA;&#x653E;&#x4E0A;&#x63D0;&#x4EA4;&#x7B14;&#x8BB0;&#x7684;&#x94FE;&#x63A5;&#x3002;</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/da4869d87a7f0b24046f91d8399c3910.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7231378331139997757.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7231378331139997757.html" itemprop="url">Google IO 2023 第一弹， I/O FLIP 小</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-10T11:31:24+08:00">
                2023-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Google IO 2023 &#x9A6C;&#x4E0A;&#x5C31;&#x8981;&#x5F00;&#x59CB;&#x4E86;&#xFF0C;&#x800C;&#x548C;&#x53BB;&#x5E74;&#x4E00;&#x6837;&#xFF0C;&#x4ECA;&#x5E74;&#x540C;&#x6837;&#x53D1;&#x5E03;&#x4E86;&#x9884;&#x70ED;&#x5C0F;&#x6E38;&#x620F; <a href="/external_links/3e33e54ca93ee12f3531a0f0980e0d96.html" target="blank" rel="noopener">I/O FLIP</a> &#xFF0C; <strong>&#x8BE5;&#x6B3E;&#x5C0F;&#x6E38;&#x620F;&#x662F;&#x4F7F;&#x7528; AI &#x8BBE;&#x8BA1;&#x7684;&#x7EB8;&#x724C;&#x6E38;&#x620F;&#xFF0C;&#x91C7;&#x7528;&#x4E86; Flutter &#x548C; Firebase &#x5F00;&#x53D1;&#x6784;&#x5EFA;</strong>&#xFF0C;&#x6574;&#x4F53;&#x4F53;&#x9A8C;&#x4E0A;&#x50CF;&#x662F; Demo &#x7248;&#x672C;&#x7684;&#x7089;&#x77F3;&#x4F20;&#x8BF4;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/bcb0ee753efa44f1d5392fc11c3c667c22812f0c6f662cd0e86a2e5e90daa967" alt></p>
<p><strong>Google &#x672C;&#x6B21;&#x9488;&#x5BF9; <a href="/external_links/3e33e54ca93ee12f3531a0f0980e0d96.html" target="blank" rel="noopener">I/O FLIP</a> &#x63D0;&#x4F9B; AI &#x652F;&#x6301;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5E0C;&#x671B;&#x5C55;&#x793A; AI &#x6280;&#x672F;&#x7684;&#x53EF;&#x80FD;&#x6027;</strong>&#xFF0C;&#x5E95;&#x5C42;&#x4E3B;&#x8981;&#x4F7F;&#x7528; <a href="/external_links/94240643453dfc40cf86ae0ce8c14742.html" target="blank" rel="noopener">DreamBooth</a> &#x548C; <a href="/external_links/1aa1239dd1e957860247b4f2aa51bdf4.html" target="blank" rel="noopener">Muse</a> &#x9884;&#x5148;&#x751F;&#x6210;&#x4E86;&#x5927;&#x91CF;&#x81EA;&#x5B9A;&#x4E49;&#x89D2;&#x8272;&#x56FE;&#x50CF;&#xFF0C;&#x5E76;&#x4F7F;&#x7528; <a href="/external_links/9479de430c12e2c938a9a6e326a8e067.html" target="blank" rel="noopener">PaLM API</a> &#x751F;&#x6210;&#x4E86;&#x5B83;&#x4EEC;&#x7684;&#x63CF;&#x8FF0;&#x3002;</p>
<p><strong>&#x6E38;&#x620F;&#x7684; UI &#x548C;&#x540E;&#x7AEF;&#x4F7F;&#x7528; Flutter &#x548C; Dart &#x6784;&#x5EFA;</strong>&#xFF0C;&#x5229;&#x7528; Firebase &#x6258;&#x7BA1;&#x548C;&#x5171;&#x4EAB;&#x6570;&#x636E;&#xFF0C;Cloud Run &#x7528;&#x4E8E;&#x5E2E;&#x52A9;&#x6269;&#x5C55;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1f0e869d6b6abe2d30929286ea6eb639f02f5e1625f7de4bea9a33e80ea0e6fa" alt></p>
<p>&#x6E38;&#x620F;&#x6574;&#x4F53;&#x6D41;&#x7A0B;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x8FDB;&#x5165;&#x6E38;&#x620F;&#x540E;&#xFF1A;</p>
<ul>
<li>&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x89D2;&#x8272;&#x7C7B;&#x522B;&#x548C;&#x4E00;&#x4E2A;&#x529B;&#x91CF;&#x4F53;&#x7CFB;&#x6765;&#x968F;&#x673A;&#x751F;&#x6210; 12 &#x5F20;&#x5361;&#x7247;</li>
<li>&#x4ECE;&#x5305;&#x4E2D;&#x9009;&#x62E9;&#x4E09;&#x5F20;&#x5361;&#x7247;&#x4F60;&#x89C9;&#x5F97;&#x6700;&#x5408;&#x9002;&#x7684;&#x5361;&#x7247;&#x5F00;&#x59CB;&#x6E38;&#x620F;</li>
<li>&#x52A0;&#x5165;&#x4E00;&#x573A;&#x6BD4;&#x8D5B;&#x5E76;&#x8D62;&#x5F97;&#x4E09;&#x5C40;&#x4E24;&#x80DC;&#xFF08;&#x7530;&#x5FCC;&#x8D5B;&#x9A6C;&#xFF09;&#xFF0C;&#x8D62;&#x4E86;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x573A;</li>
<li><strong>&#x5361;&#x7247;&#x5BF9;&#x6218;&#x662F;&#x4EE5;&#x653B;&#x51FB;&#x529B;&#x4E3A;&#x4E3B;&#xFF0C;&#x5E76;&#x4F1A;&#x6709;&#x5C5E;&#x6027;&#x514B;&#x5236;&#x6548;&#x679C;&#xFF0C;&#x5C5E;&#x6027;&#x514B;&#x5236;&#x65F6;&#x4F1A;&#x964D;&#x4F4E;&#x5BF9;&#x65B9; 10 &#x70B9;&#x653B;&#x51FB;&#x529B;</strong></li>
<li>&#x8FDE;&#x7EED;&#x8D62;&#x5F97;&#x591A;&#x573A;&#x4F1A;&#x6709;&#x8FDE;&#x80DC;&#x7EAA;&#x5F55;&#xFF0C;&#x4ECE;&#x800C;&#x6709;&#x673A;&#x4F1A;&#x8FDB;&#x5165;&#x6392;&#x884C;&#x699C;</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
</table>
<h1 id="Flutter-&#x548C;-Dart-&#x652F;&#x6301;"><a href="#Flutter-&#x548C;-Dart-&#x652F;&#x6301;" class="headerlink" title="Flutter &#x548C; Dart &#x652F;&#x6301;"></a>Flutter &#x548C; Dart &#x652F;&#x6301;</h1><p>I/O FLIP &#x7684;&#x903B;&#x8F91;&#x3001;UI &#x548C;&#x97F3;&#x9891;&#x652F;&#x6301;&#x4F7F;&#x7528;&#x7684;&#x662F; <a href="/external_links/b50afb9289d678b35eb571fbad4237ea.html" target="blank" rel="noopener">Flutter Casual Games Toolkit</a> &#x5DE5;&#x5177;&#x5305;&#xFF0C;&#x5E76;&#x4E14;&#x5229;&#x7528; <a href="/external_links/7b58a487aa899c92b1bcd67b887a404e.html" target="blank" rel="noopener">go_router</a> &#x5B9E;&#x73B0;&#x9875;&#x9762;&#x8DEF;&#x7531;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x7531;&#x4E8E; FLIP &#x662F;&#x4E00;&#x4E2A; web &#x6E38;&#x620F;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x9700;&#x8981;&#x9002;&#x914D;&#x4E0D;&#x540C;&#x5C4F;&#x5E55;&#x7684;&#x5927;&#x5C0F;&#x548C;&#x8C03;&#x6574;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x9700;&#x8981;&#x652F;&#x6301; <a href="/external_links/181c42a652432f6ad8f52f032c315939.html" target="blank" rel="noopener">adaptive-responsive</a>&#x3002;</p>
<p>FLIP &#x4E2D;&#x7684;&#x5927;&#x90E8;&#x5206;&#x903B;&#x8F91;&#x662F;&#x57FA;&#x4E8E;&#x6E38;&#x620F;&#x5361;&#x7247;&#x8FDB;&#x884C;&#x8BBE;&#x8BA1;&#xFF0C;&#x6BCF;&#x5F20;&#x5361;&#x7247;&#x90FD;&#x5305;&#x542B;&#x56DB;&#x4E2A; Google &#x5409;&#x7965;&#x7269;&#x4E4B;&#x4E00;&#x7684;&#x5F62;&#x8C61;&#xFF1A;<code>Dash</code>&#x3001;<code>Sparky</code>&#x3001;<code>Dino</code> &#x548C; <code>Android</code> &#x4EE5;&#x53CA;&#x5B83;&#x4EEC;&#x5BF9;&#x5E94;&#x7684;&#x63CF;&#x8FF0;&#x3002;</p>
<p><strong>&#x4E24;&#x8005;&#x7684;&#x8BBE;&#x5B9A;&#x4E3B;&#x8981;&#x90FD;&#x6765;&#x81EA;&#x7528;&#x6237;&#x5728;&#x6E38;&#x620F;&#x5F00;&#x59CB;&#x65F6;&#x9009;&#x62E9;&#x7684;&#x804C;&#x4E1A;&#x548C;&#x529B;&#x91CF;</strong>&#xFF0C;&#x5361;&#x7247;&#x8FD8;&#x968F;&#x673A;&#x5206;&#x914D;&#x4E86;&#x4E00;&#x79CD;&#x5143;&#x7D20;&#x529B;&#x91CF;&#xFF08;&#x7A7A;&#x6C14;&#x3001;&#x6C34;&#x3001;&#x706B;&#x3001;&#x91D1;&#x5C5E;&#x3001;&#x5730;&#x7403;&#xFF09;&#x548C;&#x4E00;&#x4E2A; 10-100 &#x4E4B;&#x95F4;&#x7684;&#x6570;&#x5B57;&#xFF0C;&#x6570;&#x5B57;&#x8868;&#x793A;&#x5361;&#x7247;&#x7684;&#x5F3A;&#x5EA6;&#xFF0C;&#x5143;&#x7D20;&#x529B;&#x91CF;&#x53EF;&#x4EE5;&#x5728;&#x6BD4;&#x8D5B;&#x4E2D;&#x76F8;&#x4E92;&#x5F71;&#x54CD;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/1e996a5e502e6fca00d5fe45087901f83e5b4da3a6f6a46440d654076cf7d58a" alt></p>
<blockquote>
<p><strong>&#x5982;&#x679C;&#x5361;&#x7247;&#x7684;&#x5143;&#x7D20;&#x53D7;&#x5230;&#x514B;&#x5236;&#xFF0C;&#x90A3;&#x573A;&#x4E0A;&#x5B83;&#x5C06;&#x53D7;&#x5230; 10 &#x5206;&#x7684;&#x524A;&#x5F31;&#x3002;</strong></p>
</blockquote>
<p><strong>&#x6BCF;&#x573A;&#x6BD4;&#x8D5B;&#x90FD;&#x662F;&#x4E09;&#x5C40;&#x4E24;&#x80DC;&#x5236;&#xFF0C;&#x7C7B;&#x4F3C;&#x7530;&#x5FCC;&#x8D5B;&#x9A6C;</strong>&#xFF0C;&#x73A9;&#x5BB6;&#x8D62;&#x4E86;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x7528;&#x4ED6;&#x4EEC;&#x9009;&#x62E9;&#x7684;&#x624B;&#x724C;&#x7EE7;&#x7EED;&#x6BD4;&#x8D5B;&#xFF0C;&#x800C;&#x8F93;&#x7684;&#x4E00;&#x65B9;&#x53EF;&#x4EE5;&#x5206;&#x4EAB;&#x4ED6;&#x4EEC;&#x7684;&#x624B;&#x724C;&#x6216;&#x9009;&#x62E9;&#x65B0;&#x624B;&#x724C;&#x518D;&#x6B21;&#x5F00;&#x59CB;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x91CC;&#xFF0C;&#x5373;&#x5C06;&#x53D1;&#x5E03;&#x7684;= Flutter &#x548C; Dart &#x5168;&#x65B0;&#x529F;&#x80FD;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x5FEB;&#x901F;&#x5B9E;&#x73B0;&#x4E0A;&#x8FF0;&#x652F;&#x6301;&#xFF1A;&#x4F8B;&#x5982; &#xFF1A;</p>
<ul>
<li>Dart 3 &#x7684; <a href="/external_links/33fcb09654e0aefb08317588cd09c267.html" target="blank" rel="noopener">record</a> &#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x57FA;&#x4E8E;&#x5361;&#x7247;&#x5143;&#x7D20;&#x6765;&#x6E32;&#x67D3; frame</li>
<li><a href="/external_links/ef2870771fe9537b215c3b740715f240.html" target="blank" rel="noopener">fragment shaders</a> &#x7684;&#x5B98;&#x65B9;&#x652F;&#x6301;&#xFF0C;&#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E00;&#x4E9B;&#x5361;&#x7247;&#x4E0A;&#x7684;&#x7279;&#x6B8A; 3D &#x6548;&#x679C;&#x3002;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/e090216e00ffe5b392826cb566823b904b23807fcc674abd7f37e8b8011e5768" alt></p>
<h1 id="Muse-&#x548C;-PaLM-API-&#x4E0A;&#x7684;-Dreambooth"><a href="#Muse-&#x548C;-PaLM-API-&#x4E0A;&#x7684;-Dreambooth" class="headerlink" title="Muse &#x548C; PaLM API &#x4E0A;&#x7684; Dreambooth"></a>Muse &#x548C; PaLM API &#x4E0A;&#x7684; Dreambooth</h1><p><strong>I/O FLIP &#x4E2D;&#x7684;&#x6BCF;&#x5F20;&#x5361;&#x7247;&#x90FD;&#x662F;&#x4F7F;&#x7528;&#x4E86; AI &#x751F;&#x6210;&#x7684;&#x56FE;&#x50CF;&#x548C;&#x63CF;&#x8FF0;</strong>&#x3002;</p>
<p>&#x56FE;&#x50CF;&#x662F;&#x4F7F;&#x7528; Google Research &#x5F00;&#x521B;&#x7684;&#x4E24;&#x79CD;&#x6280;&#x672F;&#x9884;&#x5148;&#x751F;&#x6210;&#x7684;&#xFF1A;</p>
<ul>
<li><a href="/external_links/1aa1239dd1e957860247b4f2aa51bdf4.html" target="blank" rel="noopener">Muse</a>&#xFF0C;&#x4E00;&#x79CD;&#x6765;&#x81EA; Imagen &#x6A21;&#x578B;&#x7CFB;&#x5217;&#x7684;&#x6587;&#x672C;&#x5230;&#x56FE;&#x50CF; AI &#x6A21;&#x578B;</li>
<li><a href="/external_links/94240643453dfc40cf86ae0ce8c14742.html" target="blank" rel="noopener">DreamBooth</a>&#xFF0C;&#x4E00;&#x79CD;&#x8FD0;&#x884C;&#x5728; Muse &#x4E4B;&#x4E0A;&#x7684;&#x6280;&#x672F;&#xFF0C;&#x5141;&#x8BB8;&#x4E2A;&#x6027;&#x5316;&#x6587;&#x672C; to &#x56FE;&#x50CF;&#x7684;&#x6A21;&#x578B;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x5C0F;&#x7EC4;&#x56FE;&#x50CF;&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;&#xFF0C;&#x751F;&#x6210;&#x7279;&#x5B9A;&#x4E3B;&#x9898;&#x7684;&#x65B0;&#x56FE;&#x50CF;</li>
</ul>
<p><strong>&#x5361;&#x7247;&#x63CF;&#x8FF0;&#x5728; MakerSuite &#x4E2D;&#x5236;&#x4F5C;&#x539F;&#x578B;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x8BBF;&#x95EE; Google &#x5927;&#x578B;&#x8BED;&#x8A00;&#x6A21;&#x578B;&#x7684; <a href="/external_links/9479de430c12e2c938a9a6e326a8e067.html" target="blank" rel="noopener">PaLM API</a> &#x8FDB;&#x884C;&#x9884;&#x5148;&#x751F;&#x6210;</strong>&#x3002;</p>
<p>&#x6839;&#x636E;&#x73A9;&#x5BB6;&#x5728;&#x6E38;&#x620F;&#x5F00;&#x59CB;&#x65F6;&#x9009;&#x62E9;&#x7684;&#x529B;&#x91CF;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x5F97;&#x5230;&#x4E00;&#x5F20;&#x5361;&#x7247;&#x63CF;&#x8FF0;&#xFF0C;&#x4E3A;&#x56FE;&#x50CF;&#x63D0;&#x4F9B;&#x80CC;&#x666F;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x62EC;&#x89D2;&#x8272;&#x7684;&#x7279;&#x6B8A;&#x529B;&#x91CF;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<blockquote>
<p>&#x201C;Dash the Wizard lives in a castle with his pet dragon. He loves to cast spells and make people laugh.&#x201D;</p>
</blockquote>
<p>Flutter &#x7528;&#x4E8E;&#x4F7F;&#x7528; GameCard &#x63A7;&#x4EF6;&#xFF0C;&#x6839;&#x636E;&#x540D;&#x79F0;&#x3001;&#x63CF;&#x8FF0;&#x3001;&#x56FE;&#x50CF;&#x548C;&#x80FD;&#x529B;&#x7EC4;&#x5408;&#x5361;&#x7247;&#xFF0C;&#x521B;&#x5EFA;&#x5361;&#x7247;&#x540E;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x5143;&#x7D20;&#x7684;&#x8FB9;&#x6846;&#x5C31;&#x4F1A;&#x88AB;&#x8D4B;&#x4E88;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x8FD0;&#x6C14;&#x591F;&#x597D;&#xFF0C;&#x8BBE;&#x8BA1;&#x4E2D;&#x8FD8;&#x4F1A;&#x6709;&#x7279;&#x6B8A;&#x7684;&#x7740;&#x8272;&#x5668;&#x6548;&#x679C;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/11bf91cf53abc16d9327b4236ba91ea05f9c1337c5cbd80aafb6c33c428e2510" alt></p>
<h3 id="Firebase&#xFF1A;-&#x6E38;&#x620F;&#x6258;&#x7BA1;&#x3001;&#x5171;&#x4EAB;&#x548C;&#x5B9E;&#x65F6;&#x6E38;&#x620F;"><a href="#Firebase&#xFF1A;-&#x6E38;&#x620F;&#x6258;&#x7BA1;&#x3001;&#x5171;&#x4EAB;&#x548C;&#x5B9E;&#x65F6;&#x6E38;&#x620F;" class="headerlink" title="Firebase&#xFF1A; &#x6E38;&#x620F;&#x6258;&#x7BA1;&#x3001;&#x5171;&#x4EAB;&#x548C;&#x5B9E;&#x65F6;&#x6E38;&#x620F;"></a><strong>Firebase&#xFF1A;</strong> &#x6E38;&#x620F;&#x6258;&#x7BA1;&#x3001;&#x5171;&#x4EAB;&#x548C;&#x5B9E;&#x65F6;&#x6E38;&#x620F;</h3><p><a href="/external_links/ebbc67a4b43e6277fb92eacfe51648e8.html" target="blank" rel="noopener">Cloud Storage for Firebase</a> &#x5B58;&#x50A8;&#x751F;&#x6210;&#x73A9;&#x5BB6;&#x724C;&#x7EC4;&#x7684;&#x6240;&#x6709;&#x56FE;&#x50CF;&#x3001;&#x63CF;&#x8FF0;&#x3001;&#x5143;&#x7D20;&#x548C;&#x6570;&#x5B57;&#x3002;</p>
<p><a href="/external_links/a4c8888e3f18362b04121898f614a3d0.html" target="blank" rel="noopener">Firestore</a> &#x8DDF;&#x8E2A;&#x201C;&#x6700;&#x9AD8;&#x8FDE;&#x80DC;&#x201D;&#x7684;&#x6392;&#x884C;&#x699C;&#xFF0C;&#x5E76;&#x4F7F;&#x7528; <a href="/external_links/e5b2b65e8e483776be29ea258f555939.html" target="blank" rel="noopener">firedart</a>  &#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x83B7;&#x80DC;&#x8005;&#x3002;</p>
<p>&#x5728; Flutter &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x76F4;&#x63A5;&#x8BBF;&#x95EE; Firestore &#x7684;&#x6240;&#x6709;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x4F7F;&#x7528;<a href="/external_links/d55af1359c244b1c6b4c3afddc241408.html" target="blank" rel="noopener">App Check</a>&#x6765;&#x786E;&#x4FDD;&#x53EA;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x7F16;&#x5199;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x4F7F;&#x7528; Firebase &#x5B89;&#x5168;&#x89C4;&#x5219;&#x6765;&#x786E;&#x4FDD;&#x4EE3;&#x7801;&#x53EA;&#x80FD;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x5E76;&#x8FDB;&#x884C;&#x66F4;&#x6539;&#x6388;&#x6743;&#x7ED9;&#x3002;</p>
<h1 id="Dart-Frog"><a href="#Dart-Frog" class="headerlink" title="Dart Frog"></a>Dart Frog</h1><p><a href="/external_links/3b84e4778cac8490ad097c6cf09bd9c2.html" target="blank" rel="noopener">Dart Frog</a> &#x4F1A;&#x5C06;&#x6E38;&#x620F;&#x7ED3;&#x679C;&#xFF08;&#x4F8B;&#x5982;&#x6BCF;&#x4E00;&#x8F6E;&#x7684;&#x83B7;&#x80DC;&#x8005;&#xFF09;&#x4FDD;&#x7559;&#x5728;&#x540E;&#x7AEF;&#xFF0C;&#x5E76;&#x4E14;&#x5728; Flutter &#x524D;&#x7AEF;&#x548C; Firestore &#x540E;&#x7AEF;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#x6B64;&#x4EE3;&#x7801;&#xFF0C;<strong>&#x8FD9;&#x4E0D;&#x4EC5;&#x6709;&#x52A9;&#x4E8E;&#x9632;&#x6B62;&#x4F5C;&#x5F0A;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x8BA9;&#x6211;&#x4EEC;&#x7528;&#x540C;&#x4E00;&#x79CD;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#x540E;&#x7AEF;&#x548C;&#x524D;&#x7AEF;&#x4EE3;&#x7801;</strong>&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x5C06; I/O FLIP &#x7684; Dart Frog &#x670D;&#x52A1;&#x5668;&#x90E8;&#x7F72;&#x5230; <a href="/external_links/4a274c5ae9ed5fb8978d4a7bbcd2e243.html" target="blank" rel="noopener">Cloud Run</a>&#xFF0C;&#x8BE5;&#x6E38;&#x620F;&#x8FD8;&#x53EF;&#x4EE5;&#x5229;&#x7528;autoscaling &#x7B49;&#x529F;&#x80FD;&#xFF0C;&#x4F7F;&#x5176;&#x80FD;&#x591F;&#x540C;&#x65F6;&#x5904;&#x7406;&#x8BB8;&#x591A;&#x73A9;&#x5BB6;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;Dart Frog &#x8FD8;&#x652F;&#x6301;&#x5728;&#x793E;&#x533A;&#x91CC;&#x4E0B;&#x8F7D;&#x6216;&#x5206;&#x4EAB;&#x5361;&#x7247;&#xFF0C;&#x5728;&#x4E00;&#x8F6E;&#x6E38;&#x620F;&#x7ED3;&#x675F;&#x65F6;&#xFF0C;&#x73A9;&#x5BB6;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4E0B;&#x8F7D;&#x6216;&#x5206;&#x4EAB;&#x5230; Twitter &#x6216; Facebook&#x3002;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x70B9;&#x51FB;&#x5206;&#x4EAB;&#x6309;&#x94AE;&#x65F6;&#xFF0C;Dart Frog &#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x9884;&#x586B;&#x5145;&#x7684;&#x5E16;&#x5B50;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x8981;&#x5206;&#x4EAB;&#x7684;&#x6587;&#x672C;&#x548C;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x5E26;&#x6709;&#x76F8;&#x5E94;&#x624B;&#x724C;&#x6216;&#x5361;&#x7247;&#x7684;&#x7F51;&#x9875;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x4EE5;&#x53CA;&#x4E00;&#x4E2A;&#x4F9B;&#x8BBF;&#x95EE;&#x8005;&#x73A9;&#x6E38;&#x620F;&#x7684;&#x6309;&#x952E;&#x3002;</p>
<h1 id="&#x4E2A;&#x4EBA;&#x603B;&#x7ED3;"><a href="#&#x4E2A;&#x4EBA;&#x603B;&#x7ED3;" class="headerlink" title="&#x4E2A;&#x4EBA;&#x603B;&#x7ED3;"></a>&#x4E2A;&#x4EBA;&#x603B;&#x7ED3;</h1><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;<strong>&#x672C;&#x6B21; Google IO &#x7684;&#x6838;&#x5FC3;&#x8FD8;&#x662F; AI &#xFF0C;&#x6574;&#x4E2A;&#x6E38;&#x620F;&#x7684;&#x8BBE;&#x8BA1;&#x90FD;&#x662F;&#x57FA;&#x4E8E; AI &#x5B9E;&#x73B0;</strong>&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230; AI &#x5728;&#x8BBE;&#x8BA1;&#x548C;&#x5185;&#x5BB9;&#x9886;&#x57DF;&#x7684;&#x80FD;&#x529B;&#x652F;&#x6301;&#x4E0A;&#x8D8A;&#x6765;&#x8D8A;&#x6210;&#x719F;&#x3002;</p>
<p>&#x540C;&#x65F6;&#x672C;&#x6B21;&#x6E38;&#x620F;&#x7684;&#x6574;&#x4F53;&#x4F53;&#x9A8C;&#x4E5F;&#x6BD4;&#x53BB;&#x5E74;&#x66F4;&#x52A0;&#x4F18;&#x79C0;&#xFF0C;<strong>&#x4E3B;&#x8981;&#x662F; Flutter &#x5728;&#x6E38;&#x620F;&#x9886;&#x57DF;&#x7684;&#x652F;&#x6301;&#x4E5F;&#x5F97;&#x5230;&#x8FDB;&#x4E00;&#x6B65;&#x63D0;&#x5347;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x5370;&#x8BC1;&#x4E86;&#x53BB;&#x5E74;&#x7684;&#x8BF4;&#x6CD5;</strong>&#xFF0C; Flutter &#x56E2;&#x961F;&#x5728;&#x6E38;&#x620F;&#x652F;&#x6301;&#x4E0A;&#x7684;&#x8FDB;&#x4E00;&#x6B65;&#x6295;&#x5165;&#xFF0C;&#x8BA9; Flutter Forward &#x4E0A;&#x7684;&#x627F;&#x8BFA;&#x5728;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x6162;&#x6162;&#x6210;&#x4E3A;&#x73B0;&#x5B9E;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/49e6d2e30c4180db317d932440e257f9de8a388a39a676405a512c0cc6f5ca80" alt></p>
<p>&#x6700;&#x540E;&#xFF0C;&#x8BE5;&#x9879;&#x76EE;&#x4E5F;&#x662F;&#x5F00;&#x6E90;&#x7684;&#xFF0C;&#x5F00;&#x6E90;&#x5730;&#x5740;&#xFF1A; <a href="/external_links/f6f4d8ef88d2e74413a73f6be47bf03d.html" target="blank" rel="noopener">github.com/flutter/io_&#x2026;</a></p>
<blockquote>
<p>PS&#xFF1A;&#x672C;&#x7BC7;&#x5927;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x6765;&#x81EA;&#xFF1A; <a href="/external_links/c3e50b227b8c3e57bfb9e074ced4e1e8.html" target="blank" rel="noopener">developers.googleblog.com/2023/05/how&#x2026;</a> &#xFF0C;&#x4E2A;&#x4EBA;&#x505A;&#x4E86;&#x4E00;&#x4E9B;&#x8865;&#x5145;&#x8C03;&#x6574;&#x3002;</p>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/d7fdc06912b87142f75021eae40a28e9.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7225879724546113573.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7225879724546113573.html" itemprop="url">全网最硬核 JVM 内存解析 - 13JVM 线程内存设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-25T15:44:36+08:00">
                2023-04-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x4E2A;&#x4EBA;&#x521B;&#x4F5C;&#x516C;&#x7EA6;&#xFF1A;&#x672C;&#x4EBA;&#x58F0;&#x660E;&#x521B;&#x4F5C;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x7686;&#x4E3A;&#x81EA;&#x5DF1;&#x539F;&#x521B;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x53C2;&#x8003;&#x4EFB;&#x4F55;&#x6587;&#x7AE0;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x4F1A;&#x6807;&#x6CE8;&#x51FA;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x758F;&#x6F0F;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x6279;&#x5224;&#x3002;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x53D1;&#x73B0;&#x7F51;&#x4E0A;&#x6709;&#x6284;&#x88AD;&#x672C;&#x6587;&#x7AE0;&#x7684;&#xFF0C;&#x6B22;&#x8FCE;&#x4E3E;&#x62A5;&#xFF0C;&#x5E76;&#x4E14;&#x79EF;&#x6781;&#x5411;&#x8FD9;&#x4E2A; <a href="/external_links/a7475ce7cc4a9ea6f81215803b043243.html" target="blank" rel="noopener">github &#x4ED3;&#x5E93;</a> &#x63D0;&#x4EA4; issue&#xFF0C;&#x8C22;&#x8C22;&#x652F;&#x6301;~<br>&#x53E6;&#x5916;&#xFF0C;&#x672C;&#x6587;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x6284;&#x88AD;&#xFF0C;&#x4F1A;&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x9605;&#x8BFB;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x6587;&#x7AE0;&#x7684;&#x968F;&#x673A;&#x4F4D;&#x7F6E;&#x653E;&#x5165;&#x5BF9;&#x4E8E;&#x6284;&#x88AD;&#x548C;&#x6D17;&#x7A3F;&#x7684;&#x4EBA;&#x7684;&#x201C;&#x4EB2;&#x5207;&#x201D;&#x7684;&#x95EE;&#x5019;&#x3002;&#x5982;&#x679C;&#x662F;&#x6B63;&#x5E38;&#x8BFB;&#x8005;&#x770B;&#x5230;&#xFF0C;&#x7B14;&#x8005;&#x5728;&#x8FD9;&#x91CC;&#x8BF4;&#x58F0;&#x5BF9;&#x4E0D;&#x8D77;&#xFF0C;&#x3002;&#x5982;&#x679C;&#x88AB;&#x6284;&#x88AD;&#x72D7;&#x6216;&#x8005;&#x6D17;&#x7A3F;&#x72D7;&#x770B;&#x5230;&#x4E86;&#xFF0C;&#x5E0C;&#x671B;&#x4F60;&#x80FD;&#x591F;&#x597D;&#x597D;&#x53CD;&#x601D;&#xFF0C;&#x4E0D;&#x8981;&#x518D;&#x6284;&#x88AD;&#x4E86;&#xFF0C;&#x8C22;&#x8C22;&#x3002;<br>&#x4ECA;&#x5929;&#x53C8;&#x662F;&#x5E72;&#x8D27;&#x6EE1;&#x6EE1;&#x7684;&#x4E00;&#x5929;&#xFF0C;&#x8FD9;&#x662F;&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x89E3;&#x6790;&#x7CFB;&#x5217;&#x7B2C;&#x56DB;&#x7BC7;&#xFF0C;&#x5F80;&#x671F;&#x7CBE;&#x5F69;&#xFF1A;</p>
<ul>
<li><a href="https://dev.newban.cn/6925217498723778568">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; TLAB &#x89E3;&#x6790;</a></li>
<li><a href="https://dev.newban.cn/7051386828913377316">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; Java &#x968F;&#x673A;&#x6570;&#x89E3;&#x6790;</a></li>
<li><a href="https://dev.newban.cn/7080869319407566879">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; Java &#x65B0;&#x5185;&#x5B58;&#x6A21;&#x578B;&#x89E3;&#x6790;</a></li>
</ul>
</blockquote>
<blockquote>
<p>&#x672C;&#x7BC7;&#x662F;&#x5173;&#x4E8E; JVM &#x5185;&#x5B58;&#x7684;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x3002;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5173;&#x4E8E; JVM &#x5185;&#x5B58;&#x7ED3;&#x6784;&#x7684;&#x5206;&#x6790;&#x4EE5;&#x53CA;&#x56FE;&#x7247;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x4E0D;&#x662F;&#x4E00;&#x624B;&#x7684;&#x8D44;&#x6599;&#x4EA6;&#x6216;&#x662F;&#x4EBA;&#x4E91;&#x4EA6;&#x4E91;&#x5BFC;&#x81F4;&#x6709;&#x5F88;&#x9519;&#x8BEF;&#xFF0C;&#x9020;&#x6210;&#x4E86;&#x5F88;&#x591A;&#x8BEF;&#x89E3;&#xFF1B;&#x5E76;&#x4E14;&#xFF0C;&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x6700;&#x5BB9;&#x6613;&#x6DF7;&#x6DC6;&#x7684;&#x662F;&#x4E00;&#x8FB9;&#x662F; JVM Specification &#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4E00;&#x8FB9;&#x662F; Hotspot JVM &#x7684;&#x5B9E;&#x9645;&#x5B9E;&#x73B0;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x4EBA;&#x4EEC;&#x4E00;&#x4E9B;&#x90E8;&#x5206;&#x8BF4;&#x7684;&#x662F; JVM Specification&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x8BF4;&#x7684;&#x662F; Hotspot &#x5B9E;&#x73B0;&#xFF0C;&#x7ED9;&#x4EBA;&#x4E00;&#x79CD;&#x5272;&#x88C2;&#x611F;&#x4E0E;&#x8BEF;&#x89E3;&#x3002;&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x4ECE; Hotspot &#x5B9E;&#x73B0;&#x51FA;&#x53D1;&#xFF0C;&#x4EE5; Linux x86 &#x73AF;&#x5883;&#x4E3A;&#x4E3B;&#xFF0C;&#x7D27;&#x5BC6;&#x8D34;&#x5408; JVM &#x6E90;&#x7801;&#x5E76;&#x4E14;&#x8F85;&#x4EE5;&#x5404;&#x79CD; JVM &#x5DE5;&#x5177;&#x9A8C;&#x8BC1;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x7406;&#x89E3; JVM &#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x672C;&#x7BC7;&#x4EC5;&#x9650;&#x4E8E;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E9B;&#x5185;&#x5B58;&#x7684;&#x7528;&#x9014;&#xFF0C;&#x4F7F;&#x7528;&#x9650;&#x5236;&#xFF0C;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6709;&#x4E9B;&#x5730;&#x65B9;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x6DF1;&#x5165;&#xFF0C;&#x6709;&#x4E9B;&#x5730;&#x65B9;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x672C;&#x8EAB;&#x7528;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x6D89;&#x53CA;&#x7684; JVM &#x6A21;&#x5757;&#x53BB;&#x8BF4;&#xFF0C;&#x4F1A;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x7CFB;&#x5217;&#x6587;&#x7AE0;&#x8BE6;&#x7EC6;&#x63CF;&#x8FF0;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x6D17;&#x7A3F;&#x6284;&#x88AD;&#x72D7;&#x4E0D;&#x5F97; house</p>
</blockquote>
<p>&#x672C;&#x7BC7;&#x5168;&#x7BC7;&#x76EE;&#x5F55;&#xFF08;&#x4EE5;&#x53CA;&#x6D89;&#x53CA;&#x7684; JVM &#x53C2;&#x6570;&#xFF09;&#xFF1A;</p>
<ol>
<li>&#x4ECE; Native Memory Tracking &#x8BF4;&#x8D77;&#xFF08;<a href="https://dev.newban.cn/7225871227743043644">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 1.&#x4ECE; Native Memory Tracking &#x8BF4;&#x8D77;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Native Memory Tracking &#x7684;&#x5F00;&#x542F;</li>
<li>Native Memory Tracking &#x7684;&#x4F7F;&#x7528;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>NativeMemoryTracking</code>&#xFF09;</li>
<li>Native Memory Tracking &#x7684; summary &#x4FE1;&#x606F;&#x6BCF;&#x90E8;&#x5206;&#x542B;&#x4E49;</li>
<li>Native Memory Tracking &#x7684; summary &#x4FE1;&#x606F;&#x7684;&#x6301;&#x7EED;&#x76D1;&#x63A7;</li>
<li>&#x4E3A;&#x4F55; Native Memory Tracking &#x4E2D;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5206;&#x4E3A; reserved &#x548C; committed</li>
</ol>
</li>
<li>JVM &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x4E0E;&#x4F7F;&#x7528;&#x6D41;&#x7A0B;&#xFF08;<a href="https://dev.newban.cn/7225875600644407357">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 2.JVM &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x4E0E;&#x4F7F;&#x7528;&#x6D41;&#x7A0B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Linux &#x4E0B;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6A21;&#x578B;&#x7B80;&#x8FF0;</li>
<li>JVM commit &#x7684;&#x5185;&#x5B58;&#x4E0E;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x5185;&#x5B58;&#x7684;&#x5DEE;&#x5F02;<ol>
<li>JVM commit &#x7684;&#x5185;&#x5B58;&#x4E0E;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x5185;&#x5B58;&#x7684;&#x5DEE;&#x5F02;</li>
</ol>
</li>
<li>&#x5927;&#x9875;&#x5206;&#x914D; UseLargePages&#xFF08;<a href="https://dev.newban.cn/7225875600644489277">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 3.&#x5927;&#x9875;&#x5206;&#x914D; UseLargePages</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Linux &#x5927;&#x9875;&#x5206;&#x914D;&#x65B9;&#x5F0F; - Huge Translation Lookaside Buffer Page (hugetlbfs)</li>
<li>Linux &#x5927;&#x9875;&#x5206;&#x914D;&#x65B9;&#x5F0F; - Transparent Huge Pages (THP)</li>
<li>JVM &#x5927;&#x9875;&#x5206;&#x914D;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x4E0E;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseLargePages</code>,<code>UseHugeTLBFS</code>,<code>UseSHM</code>,<code>UseTransparentHugePages</code>,<code>LargePageSizeInBytes</code>&#xFF09;</li>
</ol>
</li>
</ol>
</li>
<li>Java &#x5806;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225874698906615864">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 4.Java &#x5806;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x7684;&#x786E;&#x8BA4;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x901A;&#x7528;&#x521D;&#x59CB;&#x5316;&#x4E0E;&#x6269;&#x5C55;&#x6D41;&#x7A0B;</li>
<li>&#x76F4;&#x63A5;&#x6307;&#x5B9A;&#x4E09;&#x4E2A;&#x6307;&#x6807;&#x7684;&#x65B9;&#x5F0F;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MaxHeapSize</code>,<code>MinHeapSize</code>,<code>InitialHeapSize</code>,<code>Xmx</code>,<code>Xms</code>&#xFF09;</li>
<li>&#x4E0D;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E09;&#x4E2A;&#x6307;&#x6807;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E09;&#x4E2A;&#x6307;&#x6807;(MinHeapSize,MaxHeapSize,InitialHeapSize)&#x662F;&#x5982;&#x4F55;&#x8BA1;&#x7B97;&#x7684;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x76F8;&#x5173;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseCompressedOops</code>&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225874698906714168">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 5.&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x76F8;&#x5173;&#x673A;&#x5236;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x5B58;&#x5728;&#x7684;&#x610F;&#x4E49;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ObjectAlignmentInBytes</code>&#xFF09;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E;&#x538B;&#x7F29;&#x7C7B;&#x6307;&#x9488;&#x7684;&#x5173;&#x7CFB;&#x6F14;&#x8FDB;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseCompressedOops</code>,<code>UseCompressedClassPointers</code>&#xFF09;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x7684;&#x4E0D;&#x540C;&#x6A21;&#x5F0F;&#x4E0E;&#x5BFB;&#x5740;&#x4F18;&#x5316;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ObjectAlignmentInBytes</code>,<code>HeapBaseMinAddress</code>&#xFF09;</li>
</ol>
</li>
<li>&#x4E3A;&#x4F55;&#x9884;&#x7559;&#x7B2C; 0 &#x9875;&#xFF0C;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488; null &#x5224;&#x65AD;&#x64E6;&#x9664;&#x7684;&#x5B9E;&#x73B0;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>HeapBaseMinAddress</code>&#xFF09;</li>
<li>&#x7ED3;&#x5408;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#x5806;&#x5185;&#x5B58;&#x9650;&#x5236;&#x7684;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5173;&#x7CFB;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>HeapBaseMinAddress</code>,<code>ObjectAlignmentInBytes</code>,<code>MinHeapSize</code>,<code>MaxHeapSize</code>,<code>InitialHeapSize</code>&#xFF09;</li>
<li>&#x4F7F;&#x7528; jol + jhsdb + JVM &#x65E5;&#x5FD7;&#x67E5;&#x770B;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E; Java &#x5806;&#x9A8C;&#x8BC1;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x7684;&#x7ED3;&#x8BBA;<ol>
<li>&#x9A8C;&#x8BC1; <code>32-bit</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Zero based</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Non-zero disjoint</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Non-zero based</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
</ol>
</li>
<li>&#x5806;&#x5927;&#x5C0F;&#x7684;&#x52A8;&#x6001;&#x4F38;&#x7F29;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MinHeapFreeRatio</code>,<code>MaxHeapFreeRatio</code>,<code>MinHeapDeltaBytes</code>&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225879698952470588">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 6.&#x5176;&#x4ED6; Java &#x5806;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x7684;&#x7279;&#x6B8A;&#x673A;&#x5236;</a>&#x5F00;&#x59CB;&#xFF09;</li>
<li>&#x9002;&#x7528;&#x4E8E;&#x957F;&#x671F;&#x8FD0;&#x884C;&#x5E76;&#x4E14;&#x5C3D;&#x91CF;&#x5C06;&#x6240;&#x6709;&#x53EF;&#x7528;&#x5185;&#x5B58;&#x88AB;&#x5806;&#x4F7F;&#x7528;&#x7684; JVM &#x53C2;&#x6570; AggressiveHeap</li>
<li>JVM &#x53C2;&#x6570; AlwaysPreTouch &#x7684;&#x4F5C;&#x7528;</li>
<li>JVM &#x53C2;&#x6570; UseContainerSupport - JVM &#x5982;&#x4F55;&#x611F;&#x77E5;&#x5230;&#x5BB9;&#x5668;&#x5185;&#x5B58;&#x9650;&#x5236;</li>
<li>JVM &#x53C2;&#x6570; SoftMaxHeapSize - &#x7528;&#x4E8E;&#x5E73;&#x6ED1;&#x8FC1;&#x79FB;&#x66F4;&#x8017;&#x5185;&#x5B58;&#x7684; GC &#x4F7F;&#x7528;</li>
</ol>
</li>
<li>JVM &#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225879698952486972">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 7.&#x5143;&#x7A7A;&#x95F4;&#x5B58;&#x50A8;&#x7684;&#x5143;&#x6570;&#x636E;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x4EC0;&#x4E48;&#x662F;&#x5143;&#x6570;&#x636E;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5143;&#x6570;&#x636E;</li>
<li>&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x7528;&#x5230;&#x5143;&#x7A7A;&#x95F4;&#xFF0C;&#x5143;&#x7A7A;&#x95F4;&#x4FDD;&#x5B58;&#x4EC0;&#x4E48;</li>
<li>2.1. &#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x7528;&#x5230;&#x5143;&#x7A7A;&#x95F4;&#xFF0C;&#x4EE5;&#x53CA;&#x91CA;&#x653E;&#x65F6;&#x673A;</li>
<li>2.2. &#x5143;&#x7A7A;&#x95F4;&#x4FDD;&#x5B58;&#x4EC0;&#x4E48;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#x4E0E;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225879724545835045">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 8.&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#x4E0E;&#x8BBE;&#x8BA1;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6574;&#x4F53;&#x914D;&#x7F6E;&#x4EE5;&#x53CA;&#x76F8;&#x5173;&#x53C2;&#x6570;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MetaspaceSize</code>,<code>MaxMetaspaceSize</code>,<code>MinMetaspaceExpansion</code>,<code>MaxMetaspaceExpansion</code>,<code>MaxMetaspaceFreeRatio</code>,<code>MinMetaspaceFreeRatio</code>,<code>UseCompressedClassPointers</code>,<code>CompressedClassSpaceSize</code>,<code>CompressedClassSpaceBaseAddress</code>,<code>MetaspaceReclaimPolicy</code>&#xFF09;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x4E0A;&#x4E0B;&#x6587; <code>MetaspaceContext</code></li>
<li>&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9;&#x5217;&#x8868; <code>VirtualSpaceList</code></li>
<li>&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9; <code>VirtualSpaceNode</code> &#x4E0E; <code>CompressedClassSpaceSize</code></li>
<li><code>MetaChunk</code><ol>
<li><code>ChunkHeaderPool</code> &#x6C60;&#x5316; <code>MetaChunk</code> &#x5BF9;&#x8C61;</li>
<li><code>ChunkManager</code> &#x7BA1;&#x7406;&#x7A7A;&#x95F2;&#x7684; <code>MetaChunk</code></li>
</ol>
</li>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x7684;&#x5165;&#x53E3; <code>SystemDictionary</code> &#x4E0E;&#x4FDD;&#x7559;&#x6240;&#x6709; <code>ClassLoaderData</code> &#x7684; <code>ClassLoaderDataGraph</code></li>
<li>&#x6BCF;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x79C1;&#x6709;&#x7684; <code>ClassLoaderData</code> &#x4EE5;&#x53CA; <code>ClassLoaderMetaspace</code></li>
<li>&#x7BA1;&#x7406;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684; <code>MetaChunk</code> &#x7684; <code>MetaspaceArena</code></li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6D41;&#x7A0B;&#xFF08;<a href="https://dev.newban.cn/7225879724545900581">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 9.&#x5143;&#x7A7A;&#x95F4;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6D41;&#x7A0B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x5230; <code>MetaSpaceArena</code> &#x7684;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x6574;&#x4F53;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - <code>FreeBlocks</code> &#x56DE;&#x6536;&#x8001;&#x7684; <code>current chunk</code> &#x4E0E;&#x7528;&#x4E8E;&#x540E;&#x7EED;&#x5206;&#x914D;&#x7684;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x5C1D;&#x8BD5;&#x4ECE; <code>FreeBlocks</code> &#x5206;&#x914D;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x5C1D;&#x8BD5;&#x6269;&#x5BB9; <code>current chunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code> - &#x4ECE; <code>VirtualSpaceList</code> &#x7533;&#x8BF7;&#x65B0;&#x7684; <code>RootMetaChunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code> - &#x5C06; <code>RootMetaChunk</code> &#x5207;&#x5272;&#x6210;&#x4E3A;&#x9700;&#x8981;&#x7684; <code>MetaChunk</code></li>
<li><code>MetaChunk</code> &#x56DE;&#x6536; - &#x4E0D;&#x540C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C; <code>MetaChunk</code> &#x5982;&#x4F55;&#x653E;&#x5165; <code>FreeChunkListVector</code></li>
</ol>
</li>
<li><code>ClassLoaderData</code> &#x56DE;&#x6536;</li>
</ol>
</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;&#xFF08;<a href="https://dev.newban.cn/7225879698952634428">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 10.&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x9996;&#x5148;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 1023 &#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x8FD8;&#x9700;&#x8981;&#x5206;&#x914D; 1023 &#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 264 KB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 2 MB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 128KB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x65B0;&#x6765;&#x4E00;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 2&#xFF0C;&#x9700;&#x8981;&#x5206;&#x914D; 1023 Bytes &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x88AB; GC &#x56DE;&#x6536;&#x6389;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 2 &#x9700;&#x8981;&#x5206;&#x914D; 1 MB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
</ol>
</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x9650;&#x5236;&#x4E0E;&#x52A8;&#x6001;&#x4F38;&#x7F29;&#xFF08;<a href="https://dev.newban.cn/7225879724546015269">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 11.&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li><code>CommitLimiter</code> &#x7684;&#x9650;&#x5236;&#x5143;&#x7A7A;&#x95F4;&#x53EF;&#x4EE5; commit &#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x4EE5;&#x53CA;&#x9650;&#x5236;&#x5143;&#x7A7A;&#x95F4;&#x5360;&#x7528;&#x8FBE;&#x5230;&#x591A;&#x5C11;&#x5C31;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5; GC</li>
<li>&#x6BCF;&#x6B21; GC &#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x4F1A;&#x5C1D;&#x8BD5;&#x91CD;&#x65B0;&#x8BA1;&#x7B97; <code>_capacity_until_GC</code></li>
</ol>
</li>
<li><code>jcmd VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;&#xFF08;<a href="https://dev.newban.cn/7225879731177013303">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 12.&#x5143;&#x7A7A;&#x95F4;&#x5404;&#x79CD;&#x76D1;&#x63A7;&#x624B;&#x6BB5;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li><code>jcmd &lt;pid&gt; VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;</li>
<li>&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;<ol>
<li><code>jdk.MetaspaceSummary</code> &#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceAllocationFailure</code> &#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceOOM</code> &#x5143;&#x7A7A;&#x95F4; OOM &#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceGCThreshold</code> &#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceChunkFreeListSummary</code> &#x5143;&#x7A7A;&#x95F4; Chunk FreeList &#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76; Java &#x7EBF;&#x7A0B;&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225879724546113573">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 13.JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>JVM &#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ThreadStackSize</code>,<code>VMThreadStackSize</code>,<code>CompilerThreadStackSize</code>,<code>StackYellowPages</code>,<code>StackRedPages</code>,<code>StackShadowPages</code>,<code>StackReservedPages</code>,<code>RestrictReservedStack</code>&#xFF09;</li>
<li>Java &#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;</li>
<li>Java &#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684; StackOverflowError<ol>
<li>&#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;</li>
<li>&#x4E00;&#x4E2A; Java &#x7EBF;&#x7A0B; Xss &#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;</li>
</ol>
</li>
</ol>
</li>
</ol>
<ol start="5">
<li><h1 id="JVM-&#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76;-Java-&#x7EBF;&#x7A0B;&#xFF09;"><a href="#JVM-&#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76;-Java-&#x7EBF;&#x7A0B;&#xFF09;" class="headerlink" title="JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76; Java &#x7EBF;&#x7A0B;&#xFF09;"></a>JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76; Java &#x7EBF;&#x7A0B;&#xFF09;</h1></li>
</ol>
<p>Java 19 &#x4E2D; Loom &#x7EC8;&#x4E8E; Preview &#x4E86;&#xFF0C;&#x865A;&#x62DF;&#x7EBF;&#x7A0B;&#xFF08;<code>VirtualThread</code>&#xFF09;&#x662F;&#x6211;&#x671F;&#x5F85;&#x5DF2;&#x4E45;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x8BF4;&#x7684;&#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x8FD9;&#x79CD; &#x865A;&#x62DF;&#x7EBF;&#x7A0B;&#xFF0C;&#x8FD8;&#x662F;&#x8001;&#x7684;&#x7EBF;&#x7A0B;&#x3002;&#x5176;&#x5B9E;&#x65B0;&#x7684;&#x865A;&#x62DF;&#x7EBF;&#x7A0B;&#xFF0C;&#x5728;&#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x7ED3;&#x6784;&#x4E0A;&#x5E76;&#x6CA1;&#x6709;&#x5565;&#x53D8;&#x5316;&#xFF0C;&#x53EA;&#x662F;&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x5B9E;&#x9645;&#x7684;&#x8D1F;&#x8F7D;&#x7EBF;&#x7A0B;&#xFF08;<code>CarrierThread</code>&#xFF09;&#x8FD8;&#x662F;&#x8001;&#x7684;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x540C;&#x65F6;&#xFF0C;JVM &#x7EBF;&#x7A0B;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#x5206;&#x4E3A;&#x4E24;&#x4E2A;&#x90E8;&#x5206;&#xFF1A;&#x5206;&#x522B;&#x662F;&#x7EBF;&#x7A0B;&#x6808;&#x5360;&#x7528;&#x5185;&#x5B58;&#xFF0C;&#x4EE5;&#x53CA;&#x7EBF;&#x7A0B;&#x672C;&#x8EAB;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#x3002;</p>
<h2 id="5-1-JVM-&#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;"><a href="#5-1-JVM-&#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;" class="headerlink" title="5.1. JVM &#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;"></a>5.1. JVM &#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;</h2><p>JVM &#x4E2D;&#x6709;&#x5982;&#x4E0B;&#x51E0;&#x7C7B;&#x7EBF;&#x7A0B;&#xFF1A;</p>
<ul>
<li><strong>VM &#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x8D1F;&#x8D23;&#x6267;&#x884C; <code>VM Operations</code>&#xFF0C;&#x4F8B;&#x5982; JVM &#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x64CD;&#x4F5C;&#x5927;&#x90E8;&#x5206;&#x9700;&#x8981;&#x5728;&#x5B89;&#x5168;&#x70B9;&#x6267;&#x884C;&#xFF0C;&#x5373; Stop the world &#x7684;&#x65F6;&#x5019;&#x6267;&#x884C;&#x3002;&#x6240;&#x6709;&#x7684;&#x64CD;&#x4F5C;&#x8BF7;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21+17/src/hotspot/share/runtime/vmOperation.hpp</code></a></li>
<li><strong>GC &#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x8D1F;&#x8D23;&#x505A; GC &#x64CD;&#x4F5C;&#x7684;&#x7EBF;&#x7A0B;</li>
<li><strong>Java &#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x5305;&#x62EC; Java &#x5E94;&#x7528;&#x7EBF;&#x7A0B;&#xFF08;<code>java.lang.Thread</code>&#xFF09;&#xFF0C;&#x4EE5;&#x53CA; <code>CodeCacheSweeper</code> &#x7EBF;&#x7A0B;&#xFF0C; <code>JVMTI</code> &#x7684; Agent &#x4E0E; Service &#x7EBF;&#x7A0B;&#x5176;&#x5B9E;&#x4E5F;&#x662F; JAva &#x7EBF;&#x7A0B;&#x3002;</li>
<li><strong>&#x7F16;&#x8BD1;&#x5668;&#x7EBF;&#x7A0B;</strong>&#xFF1A; JIT &#x7F16;&#x8BD1;&#x5668;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x6709; C1 &#x548C; C2 &#x7EBF;&#x7A0B;(xi&#x7A3F;&#x6EDA;&#x53BB;shi)</li>
<li><strong>&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x65F6;&#x949F;&#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x5373; Watcher &#x7EBF;&#x7A0B;&#xFF0C;&#x8D1F;&#x8D23;&#x8BA1;&#x65F6;&#x5E76;&#x6267;&#x884C;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x76EE;&#x524D; JVM &#x4E2D;&#x5305;&#x62EC;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x67E5;&#x770B;&#x7EE7;&#x627F; <code>PeriodicTask</code> &#x7684;&#x7C7B;&#x770B;&#x5230;&#xFF0C;&#x5176;&#x4E2D;&#x4E24;&#x4E2A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x4EFB;&#x52A1;&#x662F;&#xFF1A;<ul>
<li><code>StatSamplerTask</code>&#xFF1A;&#x5B9A;&#x65F6;&#x66F4;&#x65B0;&#x91C7;&#x96C6;&#x7684; JVM Performance Data&#xFF08;PerfData&#xFF09;&#x6570;&#x636E;&#xFF0C; &#x5305;&#x62EC; GC&#x3001;&#x7C7B;&#x52A0;&#x8F7D;&#x3001;&#x8FD0;&#x884C;&#x91C7;&#x96C6;&#x7B49;&#x7B49;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x591A;&#x4E45;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x662F;&#x901A;&#x8FC7; <code>-XX:PerfDataSamplingInterval</code> &#x53C2;&#x6570;&#x63A7;&#x5236;&#x7684;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 50 &#x6BEB;&#x79D2;&#xFF08;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/share/runtime/globals.hpp</code></a>&#xFF09;&#x3002;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x4E00;&#x822C;&#x901A;&#x8FC7; jstat &#x8BFB;&#x53D6;&#xFF0C;&#x6216;&#x8005;&#x901A;&#x8FC7; JMX &#x8BFB;&#x53D6;&#x3002;</li>
<li><code>VMOperationTimeoutTask</code>&#xFF1A;&#x7531;&#x4E8E; VM &#x7EBF;&#x7A0B;&#x662F;&#x5355;&#x7EBF;&#x7A0B;&#xFF0C;&#x6267;&#x884C; <code>VM Operations</code>&#xFF0C;&#x5355;&#x4E2A;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x4E0D;&#x80FD;&#x592A;&#x4E45;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x963B;&#x585E;&#x5176;&#x4ED6; <code>VM Operations</code>&#x3002;&#x6240;&#x4EE5;&#x6BCF;&#x6B21;&#x6267;&#x884C; <code>VM Operations</code> &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x90FD;&#x4F1A;&#x68C0;&#x67E5;&#x5F53;&#x524D;&#x6267;&#x884C;&#x4E86;&#x591A;&#x4E45;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x8FC7; <code>-XX:AbortVMOnVMOperationTimeoutDelay</code> &#x5C31;&#x4F1A;&#x62A5;&#x8B66;&#x3002;<code>AbortVMOnVMOperationTimeoutDelay</code> &#x9ED8;&#x8BA4;&#x662F; 1000ms&#xFF08;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/share/runtime/globals.hpp</code></a>&#xFF09;&#x3002;</li>
</ul>
</li>
<li><strong>&#x5F02;&#x6B65;&#x65E5;&#x5FD7;&#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C; Java 17 &#x5F15;&#x5165;&#x7684;&#x5F02;&#x6B65; JVM &#x65E5;&#x5FD7;&#x7279;&#x6027;&#xFF0C;&#x9632;&#x6B62;&#x56E0;&#x4E3A; JVM &#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x963B;&#x585E;&#x5F71;&#x54CD;&#x5168;&#x5C40;&#x5B89;&#x5168;&#x70B9;&#x4E8B;&#x4EF6;&#x5BFC;&#x81F4;&#x5168;&#x5C40;&#x6682;&#x505C;&#x8FC7;&#x957F;&#xFF0C;&#x6216;&#x8005; JVM &#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x5BFC;&#x81F4;&#x7EBF;&#x7A0B;&#x963B;&#x585E;&#xFF0C;&#x8D1F;&#x8D23;&#x5F02;&#x6B65;&#x5199;&#x65E5;&#x5FD7;&#xFF0C;&#x901A;&#x8FC7; <code>-Xlog:async</code> &#x542F;&#x7528; JVM &#x5F02;&#x6B65;&#x65E5;&#x5FD7;&#xFF0C;&#x901A;&#x8FC7; <code>-XX:AsyncLogBufferSize=</code> &#x6307;&#x5B9A;&#x5F02;&#x6B65;&#x65E5;&#x5FD7;&#x7F13;&#x51B2;&#x5927;&#x5C0F;&#xFF0C;&#x8FD9;&#x4E2A;&#x5927;&#x5C0F;&#x9ED8;&#x8BA4;&#x662F; <code>2097152</code> &#x5373; <code>2MB</code></li>
<li><strong>JFR &#x91C7;&#x6837;&#x7EBF;&#x7A0B;</strong>&#xFF1A;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x8D1F;&#x8D23;&#x91C7;&#x96C6; JFR &#x4E2D;&#x7684;&#x4E24;&#x79CD;&#x91C7;&#x6837;&#x4E8B;&#x4EF6;&#xFF0C;&#x4E00;&#x4E2A;&#x662F; <code>jdk.ExecutionSample</code>&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x662F; <code>jdk.NativeMethodSample</code>&#xFF0C;&#x90FD;&#x662F;&#x91C7;&#x6837;&#x5F53;&#x524D;&#x6B63;&#x5728; <code>RUNNING</code> &#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x5982;&#x679C;&#x7EBF;&#x7A0B;&#x5728;&#x6267;&#x884C; Java &#x4EE3;&#x7801;&#xFF0C;&#x5C31;&#x5C5E;&#x4E8E; <code>jdk.ExecutionSample</code>&#xFF0C;&#x5982;&#x679C;&#x6267;&#x884C; native &#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x5C5E;&#x4E8E; <code>jdk.NativeMethodSample</code>&#x3002;</li>
</ul>
<p>&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x6709;&#xFF1A;</p>
<ul>
<li><code>ThreadStackSize</code>&#xFF1A;&#x6BCF;&#x4E2A; <strong>Java &#x7EBF;&#x7A0B;</strong>&#x7684;&#x6808;&#x5927;&#x5C0F;&#xFF0C;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x901A;&#x8FC7; <code>-Xss</code> &#x4E5F;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#xFF0C;&#x5404;&#x79CD;&#x5E73;&#x53F0;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&#xFF1A;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1024 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_x86/globals_linux_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2048 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_aarch64/globals_linux_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_x86/globals_windows_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_aarch64/globals_windows_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>VMThreadStackSize</code>&#xFF1A;<strong>VM &#x7EBF;&#x7A0B;</strong>&#xFF0C;<strong>GC &#x7EBF;&#x7A0B;</strong>&#xFF0C;<strong>&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;&#x65F6;&#x949F;&#x7EBF;&#x7A0B;</strong>&#xFF0C;<strong>&#x5F02;&#x6B65;&#x65E5;&#x5FD7;&#x7EBF;&#x7A0B;</strong>&#xFF0C;<strong>JFR &#x91C7;&#x6837;&#x7EBF;&#x7A0B;</strong>&#x7684;&#x6808;&#x5927;&#x5C0F;&#xFF0C;&#x5404;&#x79CD;&#x5E73;&#x53F0;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&#xFF1A;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1024 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_x86/globals_linux_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2048 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_aarch64/globals_linux_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_x86/globals_windows_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_aarch64/globals_windows_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>CompilerThreadStackSize</code>&#xFF1A;<strong>&#x7F16;&#x8BD1;&#x5668;&#x7EBF;&#x7A0B;</strong>&#x7684;&#x6808;&#x5927;&#x5C0F;&#xFF0C;&#x5404;&#x79CD;&#x5E73;&#x53F0;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&#xFF1A;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1024 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_x86/globals_linux_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2048 KB&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/linux_aarch64/globals_linux_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_x86/globals_windows_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x503C;&#xFF08;64 &#x4F4D;&#x865A;&#x62DF;&#x673A;&#x4E3A; 1024KB&#xFF09;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/os_cpu/windows_aarch64/globals_windows_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>StackYellowPages</code>&#xFF1A;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;&#x5E76;&#x5206;&#x6790;&#x7684;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#x7684;&#x9875;&#x5927;&#x5C0F;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 3 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 2 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>StackRedPages</code>&#xFF1A;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;&#x5E76;&#x5206;&#x6790;&#x7684;&#x7EA2;&#x8272;&#x533A;&#x57DF;&#x7684;&#x9875;&#x5927;&#x5C0F;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>StackShadowPages</code>&#xFF1A;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;&#x5E76;&#x5206;&#x6790;&#x7684;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x7684;&#x9875;&#x5927;&#x5C0F;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 20 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 20 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 8 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 20 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>StackReservedPages</code>&#xFF1A;&#x540E;&#x9762;&#x4F1A;&#x63D0;&#x5230;&#x5E76;&#x5206;&#x6790;&#x7684;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x7684;&#x9875;&#x5927;&#x5C0F;<ul>
<li>linux &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>linux &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;x86 CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 0 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/globals_x86.hpp</code></a></li>
<li>windows &#x5E73;&#x53F0;&#xFF0C;aarch CPU&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; 1 &#x9875;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/aarch64/globals_aarch64.hpp</code></a></li>
</ul>
</li>
<li><code>RestrictReservedStack</code>&#xFF1A;&#x9ED8;&#x8BA4;&#x4E3A; true&#xFF0C;&#x4E0E;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x76F8;&#x5173;&#xFF0C;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x4F1A;&#x4FDD;&#x62A4;&#x4E34;&#x754C;&#x533A;&#x4EE3;&#x7801;&#xFF08;&#x4F8B;&#x5982; <code>ReentrantLock</code>&#xFF09;&#x5728;&#x629B;&#x51FA; <code>StackOverflow</code> &#x4E4B;&#x524D;&#x5148;&#x628A;&#x4E34;&#x754C;&#x533A;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x5B8C;&#x518D;&#x7ED3;&#x675F;&#xFF0C;&#x9632;&#x6B62;&#x4E34;&#x754C;&#x533A;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x5230;&#x4E00;&#x534A;&#x5C31;&#x629B;&#x51FA; <code>StackOverflow</code> &#x5BFC;&#x81F4;&#x72B6;&#x6001;&#x4E0D;&#x4E00;&#x81F4;&#x5BFC;&#x81F4;&#x8FD9;&#x4E2A;&#x9501;&#x4E4B;&#x540E;&#x518D;&#x4E5F;&#x7528;&#x4E0D;&#x4E86;&#x4E86;&#x3002;&#x6807;&#x8BB0;&#x4E34;&#x754C;&#x533A;&#x4EE3;&#x7801;&#x7684;&#x6CE8;&#x89E3;&#x662F; <code>@jdk.internal.vm.annotation.ReservedStackAccess</code>&#x3002;&#x5728;&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x4E3A; true &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x9ED8;&#x8BA4;&#x53EA;&#x80FD; jdk &#x5185;&#x90E8;&#x4EE3;&#x7801;&#x4F7F;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x6709;&#x7C7B;&#x4F3C;&#x4E8E; <code>ReentrantLock</code> &#x8FD9;&#x79CD;&#x5E26;&#x6709;&#x4E34;&#x754C;&#x533A;&#x7684;&#x4EE3;&#x7801;&#x4E5F;&#x60F3;&#x4FDD;&#x62A4;&#x8D77;&#x6765;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E; <code>-XX:-RestrictReservedStack</code>&#xFF0C;&#x5173;&#x95ED;&#x5BF9;&#x4E8E; <code>@jdk.internal.vm.annotation.ReservedStackAccess</code> &#x7684;&#x9650;&#x5236;&#xFF0C;&#x8FD9;&#x6837;&#x4F60;&#x5C31;&#x53EF;&#x4EE5;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x4E86;&#x3002;</li>
</ul>
<p>&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x91CD;&#x70B9;&#x5206;&#x6790; Java &#x7EBF;&#x7A0B;&#x6808;&#x3002;</p>
<h2 id="5-2-Java-&#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;"><a href="#5-2-Java-&#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;" class="headerlink" title="5.2. Java &#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;"></a>5.2. Java &#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;</h2><p>&#x719F;&#x6089;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x4EBA;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x6FC0;&#x6D3B;&#x8BB0;&#x5F55;&#xFF08;Activation Record&#xFF09;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x79CD;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x652F;&#x6301;&#x4E00;&#x6B21;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x6240;&#x9700;&#x7684;&#x6240;&#x6709;&#x4FE1;&#x606F;&#x3002;&#x5B83;&#x5305;&#x542B;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x6240;&#x6709;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#xFF0C;&#x4EE5;&#x53CA;&#x6307;&#x5411;&#x53E6;&#x4E00;&#x4E2A;&#x6FC0;&#x6D3B;&#x8BB0;&#x5F55;&#x7684;&#x5F15;&#x7528;&#xFF08;&#x6216;&#x6307;&#x9488;&#xFF09;&#xFF0C;&#x5176;&#x5B9E;&#x4F60;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x7406;&#x89E3;&#x4E3A;&#xFF0C;&#x6BCF;&#x591A;&#x4E00;&#x6B21;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x5C31;&#x591A;&#x4E00;&#x4E2A;&#x6FC0;&#x6D3B;&#x8BB0;&#x5F55;&#x3002;&#x800C;&#x7EBF;&#x7A0B;&#x6808;&#x5E27;&#xFF08;Stack Frame&#xFF09;&#xFF0C;&#x5C31;&#x662F;&#x6FC0;&#x6D3B;&#x8BB0;&#x5F55;&#x7684;&#x5B9E;&#x9645;&#x5B9E;&#x73B0;&#x3002;&#x6BCF;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x591A;&#x4E00;&#x6B21;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x5C31;&#x591A;&#x4E00;&#x4E2A;&#x6808;&#x5E27;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x8BF4;&#x6CD5;&#x5E76;&#x4E0D;&#x4E25;&#x8C28;&#xFF0C;&#x6BD4;&#x5982;&#xFF0C;JIT &#x53EF;&#x80FD;&#x4F1A;&#x5185;&#x8054;&#x4E00;&#x4E9B;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x8DF3;&#x8FC7;&#x67D0;&#x4E9B;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x7B49;&#x7B49;&#x3002;Java &#x7EBF;&#x7A0B;&#x7684;&#x6808;&#x5E27;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x5462;&#xFF0C;&#x5176;&#x5B9E;&#x6839;&#x636E; Java &#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x7684;&#x65B9;&#x6CD5;&#x6709; Java &#x65B9;&#x6CD5;&#x4EE5;&#x53CA;&#x539F;&#x751F;&#x65B9;&#x6CD5;&#xFF08;Native&#xFF09;&#x5C31;&#x80FD;&#x63A8;&#x6D4B;&#x51FA;&#x6709;&#x4E24;&#x79CD;&#xFF1A;</p>
<ul>
<li>Java &#x865A;&#x62DF;&#x673A;&#x6808;&#x5E27;&#xFF08;Java Virtual Machine Stack Frame&#xFF09;&#xFF1A;&#x7528;&#x4E8E;&#x4FDD;&#x5B58; Java &#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;&#x3001;&#x64CD;&#x4F5C;&#x6570;&#x6808;&#x3001;&#x65B9;&#x6CD5;&#x51FA;&#x53E3;&#x7B49;&#x4FE1;&#x606F;&#x3002;</li>
<li>Native &#x65B9;&#x6CD5;&#x6808;&#x5E27;&#xFF08;Native Method Stack Frame&#xFF09;&#xFF1A;&#x7528;&#x4E8E;&#x4FDD;&#x5B58; Native &#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;&#x3001;&#x64CD;&#x4F5C;&#x6570;&#x6808;&#x3001;&#x65B9;&#x6CD5;&#x51FA;&#x53E3;&#x7B49;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
<p>&#x5728;&#x6700;&#x65E9;&#x7684;&#x65F6;&#x5019;&#xFF0C;Linux &#x8FD8;&#x6CA1;&#x6709;&#x7EBF;&#x7A0B;&#x7684;&#x6982;&#x5FF5;&#xFF0C;Java &#x81EA;&#x5DF1;&#x505A;&#x4E86;&#x4E00;&#x79CD;&#x53EB;&#x505A; <code>Green Thread</code> &#x7684;&#x4E1C;&#x897F;&#x5373;&#x7528;&#x6237;&#x6001;&#x7EBF;&#x7A0B;&#xFF08;&#x4E0E;&#x73B0;&#x5728;&#x7684;&#x865A;&#x62DF;&#x7EBF;&#x7A0B;&#x8BBE;&#x8BA1;&#x5DEE;&#x5F02;&#x5F88;&#x5927;&#xFF0C;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x6982;&#x5FF5;&#x4E86;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x8C03;&#x5EA6;&#x6709;&#x8BF8;&#x591A;&#x95EE;&#x9898;&#xFF0C;&#x6240;&#x4EE5;&#x5728; Linux &#x6709;&#x7EBF;&#x7A0B;&#x4E4B;&#x540E;&#xFF0C;Java &#x4E5F;&#x820D;&#x5F03;&#x4E86; <code>Green Thread</code>&#x3002;Java &#x7EBF;&#x7A0B;&#x5176;&#x5B9E;&#x5E95;&#x5C42;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7EBF;&#x7A0B;&#x5B9E;&#x73B0;&#xFF0C;&#x662F;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x7684;&#x5173;&#x7CFB;&#x3002;&#x4E0D;&#x8FC7;&#x73B0;&#x5728;&#xFF0C;&#x865A;&#x62DF;&#x7EBF;&#x7A0B;&#x4E5F;&#x5FEB;&#x8981; release &#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x5E76;&#x4E0D;&#x662F;&#x4ECA;&#x5929;&#x7684;&#x91CD;&#x70B9;&#x3002;&#x5E76;&#x4E14;&#xFF0C;&#x5728;&#x6700;&#x65E9;&#x7684;&#x65F6;&#x5019;&#xFF0C;Java &#x7EBF;&#x7A0B;&#x6808;&#x4E0E; Native &#x7EBF;&#x7A0B;&#x6808;&#x4E5F;&#x662F;&#x5206;&#x5F00;&#x7684;&#xFF0C;&#x867D;&#x7136;&#x53EF;&#x80FD;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x7684;&#x3002;&#x540E;&#x6765;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x6837;&#x505A;&#x5BF9;&#x4E8E; JIT &#x4F18;&#x5316;&#xFF0C;&#x4EE5;&#x53CA;&#x7EBF;&#x7A0B;&#x6808;&#x5927;&#x5C0F;&#x9650;&#x5236;&#xFF0C;&#x4EE5;&#x53CA;&#x5B9E;&#x73B0;&#x9AD8;&#x6548;&#x7684; StackOverflow &#x68C0;&#x67E5;&#x90FD;&#x4E0D;&#x5229;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x628A; Java &#x7EBF;&#x7A0B;&#x6808;&#x4E0E; Native &#x7EBF;&#x7A0B;&#x6808;&#x5408;&#x5E76;&#x4E86;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6808;&#x4E86;&#x3002;</p>
<p>JVM &#x4E2D;&#x5BF9;&#x4E8E;&#x7EBF;&#x7A0B;&#x6808;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x662F;&#x9650;&#x5236;&#x6B7B;&#x7684;&#x3002;<strong>&#x5BF9;&#x4E8E; Java &#x7EBF;&#x7A0B;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x9650;&#x5236;&#x662F;&#x7531; <code>-Xss</code> &#x6216;&#x8005; <code>-XX:ThreadStackSize</code> &#x6765;&#x63A7;&#x5236;&#x7684;</strong>&#xFF0C;<code>-Xss</code> &#x6216;&#x8005; <code>-XX:ThreadStackSize</code> &#x57FA;&#x672C;&#x7B49;&#x4EF7;&#xFF0C; &#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;<code>-Xss</code> &#x6216;&#x8005; <code>-XX:ThreadStackSize</code> &#x662F;&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x6808;&#x5927;&#x5C0F;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x66F4;&#x4E25;&#x8C28;&#x7684;&#x8BF4;&#x6CD5;&#x662F;&#xFF0C;&#x5B83;&#x662F;&#x8BBE;&#x7F6E;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x6808;&#x6700;&#x5927;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x4E14;&#x5B9E;&#x9645;&#x53EF;&#x7528;&#x7684;&#x5927;&#x5C0F;&#x7531;&#x4E8E;&#x4FDD;&#x62A4;&#x9875;&#x7684;&#x5B58;&#x5728;&#x8FD8;&#x8981;&#x5C0F;&#x4E8E;&#x8FD9;&#x4E2A;&#x503C;&#xFF0C;&#x5E76;&#x4E14;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E2A;&#x503C;&#x4E0D;&#x80FD;&#x5C0F;&#x4E8E;&#x4FDD;&#x62A4;&#x9875;&#x9700;&#x8981;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5426;&#x5219;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#x3002;&#x6839;&#x636E;&#x524D;&#x9762;&#x5BF9;&#x4E8E; JVM &#x5176;&#x4ED6;&#x533A;&#x57DF;&#x7684;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x63A8;&#x6D4B;&#x51FA;&#xFF0C;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x90FD;&#x4F1A;&#x5148; <code>Reserve</code> &#x51FA; <code>-Xss</code> &#x6216;&#x8005; <code>-XX:ThreadStackSize</code> &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4E4B;&#x540E;&#x968F;&#x7740;&#x7EBF;&#x7A0B;&#x5360;&#x7528;&#x5185;&#x5B58;&#x5347;&#x9AD8;&#x800C;&#x4E0D;&#x65AD; <code>Commit</code> &#x5185;&#x5B58;&#x3002;</p>
<p>&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x8FD8;&#x77E5;&#x9053;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x6BB5; Java &#x4EE3;&#x7801;&#xFF0C;&#x5206;&#x4E3A;&#x7F16;&#x8BD1;&#x5668;&#x6267;&#x884C;&#xFF0C;C1 &#x6267;&#x884C;&#xFF0C;C2 &#x6267;&#x884C;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x4E00;&#x4E2A; Java &#x7EBF;&#x7A0B;&#x7684;&#x6808;&#x5185;&#x5B58;&#x7ED3;&#x6784;&#x53EF;&#x80FD;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/807b265b8b80bde773182b8aa2c7ab62436f67027b0bc003dd9ed21fef8a1d46" alt></p>
<p>&#x8FD9;&#x4E2A;&#x56FE;&#x7247;&#x6211;&#x4EEC;&#x5C55;&#x793A;&#x4E86;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x6781;&#x7AEF;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x7EBF;&#x7A0B;&#x5148;&#x89E3;&#x91CA;&#x6267;&#x884C;&#x65B9;&#x6CD5; 1&#xFF0C;&#x4E4B;&#x540E;&#x8C03;&#x7528;&#x5E76;&#x89E3;&#x91CA;&#x6267;&#x884C;&#x65B9;&#x6CD5; 2&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x70ED;&#x70B9;&#x7684;&#x65B9;&#x6CD5; 3&#xFF0C;&#x65B9;&#x6CD5; 3 &#x5DF2;&#x7ECF;&#x88AB; C1 &#x4F18;&#x5316;&#x7F16;&#x8BD1;&#xFF0C;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x7684;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4E4B;&#x540E;&#x8C03;&#x7528;&#x53EF;&#x80FD;&#x66F4;&#x70ED;&#x70B9;&#x7684;&#x65B9;&#x6CD5; 4&#xFF0C;&#x65B9;&#x6CD5; 4 &#x5DF2;&#x7ECF;&#x88AB; C2 &#x4F18;&#x5316;&#x7F16;&#x8BD1;&#xFF0C;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x7684;&#x662F;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x6700;&#x540E;&#x65B9;&#x6CD5; 4 &#x8FD8;&#x9700;&#x8981;&#x8C03;&#x7528;&#x4E00;&#x4E2A; native &#x65B9;&#x6CD5; 5&#x3002;</p>
<h2 id="5-3-Java-&#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684;-StackOverflowError"><a href="#5-3-Java-&#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684;-StackOverflowError" class="headerlink" title="5.3. Java &#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684; StackOverflowError"></a>5.3. Java &#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684; StackOverflowError</h2><p>JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/3a178f82e9e32eedbdb86d66714fdb51861c4d1a57fd4999a6532dd491f1f26c" alt></p>
<ul>
<li>&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#xFF08;Guard Zone&#xFF09;&#xFF0C;&#x4FDD;&#x62A4;&#x533A;&#x7684;&#x5185;&#x5B58;&#x6CA1;&#x6709;&#x6620;&#x5C04;&#x7269;&#x7406;&#x5185;&#x5B58;&#xFF0C;&#x8BBF;&#x95EE;&#x7684;&#x8BDD;&#x4F1A;&#x50CF;&#x524D;&#x9762;&#x7B2C;&#x4E09;&#x7AE0;&#x63D0;&#x5230;&#x7684; <code>NullPointerException</code> &#x4F18;&#x5316;&#x65B9;&#x5F0F;&#x7C7B;&#x4F3C;&#xFF0C;&#x5373;&#x629B;&#x51FA; <code>SIGSEGV</code> &#x88AB; JVM &#x6355;&#x83B7;&#xFF0C;&#x518D;&#x629B;&#x51FA; <code>StackOverflowError</code>&#x3002;&#x4FDD;&#x62A4;&#x533A;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x4E09;&#x79CD;&#xFF1A;<ul>
<li><strong>&#x9EC4;&#x8272;&#x533A;&#x57DF;</strong>&#xFF08;Yellow Zone&#xFF09;&#xFF1A;&#x5927;&#x5C0F;&#x7531;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684; <code>-XX:StackYellowPages</code> &#x53C2;&#x6570;&#x51B3;&#x5B9A;&#x3002;&#x5982;&#x679C;&#x6808;&#x6269;&#x5C55;&#x5230;&#x4E86;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#xFF0C;&#x5219;&#x53D1;&#x751F; <code>SIGSEGV</code>&#xFF0C;&#x5E76;&#x4E14;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x629B;&#x51FA; <code>StackOverflowError</code> &#x5E76;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x9EC4;&#x8272;&#x9875;&#x9762;&#x4F1A;&#x88AB;&#x6620;&#x5C04;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x4EE5;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x6808;&#x7A7A;&#x95F4;&#x7ED9;&#x5F02;&#x5E38;&#x629B;&#x51FA;&#x7684;&#x4EE3;&#x7801;&#x4F7F;&#x7528;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x9EC4;&#x8272;&#x9875;&#x9762;&#x4F1A;&#x91CD;&#x65B0;&#x53BB;&#x6389;&#x6620;&#x5C04;&#xFF0C;&#x53D8;&#x6210;&#x4FDD;&#x62A4;&#x533A;&#x3002;</li>
<li><strong>&#x7EA2;&#x8272;&#x533A;&#x57DF;</strong>&#xFF08;Red Zone&#xFF09;&#xFF1A;&#x5927;&#x5C0F;&#x7531;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684; <code>-XX:StackRedPages</code> &#x53C2;&#x6570;&#x51B3;&#x5B9A;&#x3002;&#x6B63;&#x5E38;&#x7684;&#x4EE3;&#x7801;&#x53EA;&#x4F1A;&#x53EF;&#x80FD;&#x5230;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#xFF0C;&#x53EA;&#x6709; JVM &#x51FA;&#x4E00;&#x4E9B; bug &#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5230;&#x7EA2;&#x8272;&#x533A;&#x57DF;&#xFF0C;&#x8FD9;&#x4E2A;&#x76F8;&#x5F53;&#x4E8E;&#x6700;&#x540E;&#x4E00;&#x5C42;&#x4FDD;&#x8BC1;&#x3002;&#x4FDD;&#x7559;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;&#x662F;&#x4E3A;&#x4E86;&#x51FA;&#x8FD9;&#x79CD; bug &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x80FD;&#x6709;&#x7A7A;&#x95F4;&#x53EF;&#x4EE5;&#x5C06;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x5199;&#x5165; <code>hs_err_pid.log</code> &#x6587;&#x4EF6;&#x7528;&#x4E8E;&#x5B9A;&#x4F4D;&#x3002;</li>
<li><strong>&#x4FDD;&#x7559;&#x533A;&#x57DF;</strong>&#xFF08;Reserved Zone&#xFF09;&#xFF1A;&#x5927;&#x5C0F;&#x7531;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684; <code>-XX:StackReservedPages</code> &#x53C2;&#x6570;&#x51B3;&#x5B9A;&#x3002;&#x5728; Java 9 &#x5F15;&#x5165;&#xFF08;<a href="/external_links/883a9b7368b003f3cb8d824e97548541.html" target="blank" rel="noopener">JEP 270: Reserved Stack Areas for Critical Sections</a>&#xFF09;&#xFF08;&#x6D17;&#x7A3F;&#x72D7;&#x7684;&#x533A;&#x57DF;&#x662F;&#x7EC6;&#x72D7;&#x533A;&#xFF09;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3; JDK &#x5185;&#x90E8;&#x7684;&#x4E34;&#x754C;&#x533A;&#x4EE3;&#x7801;&#xFF08;&#x4F8B;&#x5982;<code>ReentrantLock</code>&#xFF09;&#x5BFC;&#x81F4; <code>StackOverflowError</code> &#x7684;&#x65F6;&#x5019;&#x4FDD;&#x8BC1;&#x5185;&#x90E8;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0D;&#x4F1A;&#x5904;&#x4E8E;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x72B6;&#x6001;&#x5BFC;&#x81F4;&#x9501;&#x65E0;&#x6CD5;&#x91CA;&#x653E;&#x6216;&#x8005;&#x88AB;&#x83B7;&#x53D6;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;&#xFF0C;&#x5728; <code>ReentrantLock.lock()</code> &#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x8C03;&#x7528;&#x67D0;&#x4E2A;&#x5185;&#x90E8;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x53EF;&#x80FD;&#x4F1A;&#x8FDB;&#x5165;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#xFF0C;&#x5BFC;&#x81F4; <code>StackOverflowError</code>&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x53EF;&#x80FD; <code>ReentrantLock</code> &#x5185;&#x90E8;&#x7684;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x4FEE;&#x6539;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x5BFC;&#x81F4;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x65E0;&#x6CD5;&#x56DE;&#x6EDA;&#x8BA9;&#x9501;&#x5904;&#x4E8E;&#x5F53;&#x521D;&#x8BBE;&#x8BA1;&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x8BBE;&#x8BA1;&#x7684;&#x4E0D;&#x4E00;&#x81F4;&#x72B6;&#x6001;&#x3002;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x8FD9;&#x4E2A;&#x60C5;&#x51B5;&#xFF0C;&#x5F15;&#x5165;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x3002;&#x5728;&#x6267;&#x884C;&#x4E34;&#x754C;&#x533A;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF08;&#x88AB; <code>@jdk.internal.vm.annotation.ReservedStackAccess</code> &#x6CE8;&#x89E3;&#x4FEE;&#x9970;&#x7684;&#x65B9;&#x6CD5;&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x8FDB;&#x5165;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF0C;&#x90A3;&#x4E48;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x4F1A;&#x88AB;&#x6620;&#x5C04;&#x5185;&#x5B58;&#xFF0C;&#x7528;&#x4E8E;&#x6267;&#x884C;&#x5B8C;&#x4E34;&#x754C;&#x533A;&#x65B9;&#x6CD5;&#xFF0C;&#x6267;&#x884C;&#x5B8C;&#x4E34;&#x754C;&#x533A;&#x65B9;&#x6CD5;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x629B;&#x51FA; <code>StackOverflowError</code>&#xFF0C;&#x5E76;&#x89E3;&#x9664;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x7684;&#x6620;&#x5C04;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;<code>@jdk.internal.vm.annotation.ReservedStackAccess</code> &#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x9ED8;&#x8BA4;&#x53EA;&#x80FD; jdk &#x5185;&#x90E8;&#x4EE3;&#x7801;&#x4F7F;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x6709;&#x7C7B;&#x4F3C;&#x4E8E; <code>ReentrantLock</code> &#x8FD9;&#x79CD;&#x5E26;&#x6709;&#x4E34;&#x754C;&#x533A;&#x7684;&#x4EE3;&#x7801;&#x4E5F;&#x60F3;&#x4FDD;&#x62A4;&#x8D77;&#x6765;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E; <code>-XX:-RestrictReservedStack</code>&#xFF0C;&#x5173;&#x95ED;&#x5BF9;&#x4E8E; <code>@jdk.internal.vm.annotation.ReservedStackAccess</code> &#x7684;&#x9650;&#x5236;&#xFF0C;&#x8FD9;&#x6837;&#x4F60;&#x5C31;&#x53EF;&#x4EE5;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x4E86;&#x3002;</li>
</ul>
</li>
<li><strong>&#x5F71;&#x5B50;&#x533A;&#x57DF;</strong>&#xFF08;Shadow Zone&#xFF09;&#xFF1A;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;&#x7684;&#x5927;&#x5C0F;&#x7531;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684; <code>-XX:StackShadowPages</code> &#x53C2;&#x6570;&#x51B3;&#x5B9A;&#x3002;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x53EA;&#x662F;&#x62BD;&#x8C61;&#x6982;&#x5FF5;&#xFF0C;&#x8DDF;&#x5728;&#x5F53;&#x524D;&#x6808;&#x5360;&#x7528;&#x7684;&#x9876;&#x90E8;&#x6808;&#x5E27;&#x540E;&#x9762;&#xFF0C;&#x968F;&#x7740;&#x9876;&#x90E8;&#x6808;&#x5E27;&#x53D8;&#x5316;&#x800C;&#x53D8;&#x5316;&#x3002;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;&#x7528;&#x4E8E;&#x4FDD;&#x8BC1; Native &#x8C03;&#x7528;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4; <code>StackOverflowError</code>&#x3002;<strong>&#x5728;&#x540E;&#x9762;&#x7684;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x4F1A;&#x770B;&#x5230;&#xFF0C;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x524D;&#x9700;&#x8981;&#x4F30;&#x7B97;&#x65B9;&#x6CD5;&#x6808;&#x5E27;&#x7684;&#x5360;&#x7528;&#x5927;&#x5C0F;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E; Native &#x8C03;&#x7528;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x4F30;&#x7B97;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x5047;&#x8BBE; Native &#x5927;&#x5C0F;&#x6700;&#x5927;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x5927;&#x5C0F;</strong>&#xFF0C;&#x5728;&#x53D1;&#x751F; <code>Native</code> &#x8C03;&#x7528;&#x524D;&#xFF0C;&#x4F1A;&#x67E5;&#x770B;&#x5F53;&#x524D;&#x6808;&#x5E27;&#x4F4D;&#x7F6E;&#x52A0;&#x4E0A;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x5927;&#x5C0F;&#x662F;&#x5426;&#x4F1A;&#x8FBE;&#x5230;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF0C;&#x5982;&#x679C;&#x8FBE;&#x5230;&#x4E86;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x629B;&#x51FA; <code>StackOverflowError</code>&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8FBE;&#x5230;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;JVM &#x5047;&#x8BBE; Native &#x8C03;&#x7528;&#x5360;&#x7528;&#x7A7A;&#x95F4;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x5927;&#x5C0F;&#xFF0C;JDK &#x4E2D;&#x81EA;&#x5E26;&#x7684; native &#x8C03;&#x7528;&#x4E5F;&#x786E;&#x5B9E;&#x662F;&#x8FD9;&#x6837;&#x3002;&#x5982;&#x679C;&#x4F60;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x4E86; Native &#x65B9;&#x6CD5;&#x5E76;&#x4E14;&#x4F1A;&#x5360;&#x7528;&#x5927;&#x91CF;&#x6808;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x9700;&#x8981;&#x8C03;&#x6574; <code>StackShadowPages</code>&#x3002;</li>
</ul>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E0B;&#x6E90;&#x7801;&#x4E2D;&#x5982;&#x4F55;&#x4F53;&#x73B0;&#x7684;&#x8FD9;&#x4E9B;&#x533A;&#x57DF;&#xFF0C;&#x53C2;&#x8003;&#x6E90;&#x7801;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B18/src/hotspot/share/runtime/stackOverflow.hpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;size_t StackOverflow::_stack_red_zone_size = 0;</span><br><span class="line">size_t StackOverflow::_stack_yellow_zone_size = 0;</span><br><span class="line">size_t StackOverflow::_stack_reserved_zone_size = 0;</span><br><span class="line">size_t StackOverflow::_stack_shadow_zone_size = 0;</span><br><span class="line"></span><br><span class="line">void StackOverflow::initialize_stack_zone_sizes() {</span><br><span class="line">  //&#x8BFB;&#x53D6;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#xFF0C;&#x7B2C;&#x4E8C;&#x7AE0;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x8FC7;</span><br><span class="line">  size_t page_size = os::vm_page_size();</span><br><span class="line">  //&#x76EE;&#x524D;&#x5404;&#x4E2A;&#x5E73;&#x53F0;&#x6700;&#x5C0F;&#x9875;&#x5927;&#x5C0F;&#x57FA;&#x672C;&#x90FD;&#x662F; 4K</span><br><span class="line">  size_t unit = 4*K;</span><br><span class="line">  //&#x4F7F;&#x7528; StackRedPages &#x4E58;&#x4EE5; 4K &#x7136;&#x540E;&#x5BF9;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#x4F5C;&#x4E3A;&#x7EA2;&#x8272;&#x533A;&#x57DF;&#x5927;&#x5C0F;</span><br><span class="line">  assert(_stack_red_zone_size == 0, &quot;This should be called only once.&quot;);</span><br><span class="line">  _stack_red_zone_size = align_up(StackRedPages * unit, page_size);</span><br><span class="line">  //&#x4F7F;&#x7528; StackYellowPages &#x4E58;&#x4EE5; 4K &#x7136;&#x540E;&#x5BF9;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#x4F5C;&#x4E3A;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#x5927;&#x5C0F;</span><br><span class="line">  assert(_stack_yellow_zone_size == 0, &quot;This should be called only once.&quot;);</span><br><span class="line">  _stack_yellow_zone_size = align_up(StackYellowPages * unit, page_size);</span><br><span class="line">  //&#x4F7F;&#x7528; StackReservedPages &#x4E58;&#x4EE5; 4K &#x7136;&#x540E;&#x5BF9;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#x4F5C;&#x4E3A;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x5927;&#x5C0F;</span><br><span class="line">  assert(_stack_reserved_zone_size == 0, &quot;This should be called only once.&quot;);</span><br><span class="line">  _stack_reserved_zone_size = align_up(StackReservedPages * unit, page_size);</span><br><span class="line">  //&#x4F7F;&#x7528; StackShadowPages &#x4E58;&#x4EE5; 4K &#x7136;&#x540E;&#x5BF9;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#x4F5C;&#x4E3A;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#x5927;&#x5C0F;</span><br><span class="line">  assert(_stack_shadow_zone_size == 0, &quot;This should be called only once.&quot;);</span><br><span class="line">  _stack_shadow_zone_size = align_up(StackShadowPages * unit, page_size);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="5-3-1-&#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;"><a href="#5-3-1-&#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;" class="headerlink" title="5.3.1. &#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;"></a>5.3.1. &#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;</h3><p><strong>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x9488;&#x5BF9; Java &#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x8BA8;&#x8BBA;</strong>&#x3002;&#x5728;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#xFF0C;Java &#x7EBF;&#x7A0B;&#x6808;&#x7684;&#x5927;&#x5C0F;&#x662F;&#x6709;&#x9650;&#x5236;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x7EBF;&#x7A0B;&#x6808;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x8D85;&#x8FC7;&#x4E86;&#x9650;&#x5236;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x629B;&#x51FA; <code>StackOverflowError</code>&#x3002;&#x4F46;&#x662F;&#xFF0C;JVM &#x5982;&#x4F55;&#x77E5;&#x9053;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8BE5;&#x629B;&#x51FA;&#x5462;&#xFF1F;</p>
<p>&#x9996;&#x5148;&#xFF0C;&#x5BF9;&#x4E8E;&#x89E3;&#x91CA;&#x6267;&#x884C;&#xFF0C;&#x4E00;&#x822C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4F18;&#x5316;&#xFF0C;&#x5C31;&#x662F;&#x5728;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x524D;&#x68C0;&#x67E5;&#x3002;&#x4E0D;&#x540C;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#x7684;&#x5B9E;&#x73B0;&#x4F1A;&#x6709;&#x4E9B;&#x5DEE;&#x522B;&#xFF0C;&#x6211;&#x4EEC;&#x4EE5; x86 cpu &#x4E3A;&#x4F8B;&#xFF1A;</p>
<p><a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/templateInterpreterGenerator_x86.cpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;void TemplateInterpreterGenerator::generate_stack_overflow_check(void) {</span><br><span class="line">  //&#x8BA1;&#x7B97;&#x6808;&#x5E27;&#x7684;&#x4E00;&#x4E9B;&#x5143;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7684;&#x6D88;&#x8017;</span><br><span class="line">  const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;</span><br><span class="line">  const int overhead_size =</span><br><span class="line">    -(frame::interpreter_frame_initial_sp_offset * wordSize) + entry_size;</span><br><span class="line">  //&#x8BFB;&#x53D6;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#xFF0C;&#x7B2C;&#x4E8C;&#x7AE0;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x8FC7;</span><br><span class="line">  const int page_size = os::vm_page_size();</span><br><span class="line">  //&#x6BD4;&#x8F83;&#x5F53;&#x524D;&#x8981;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x7684;&#x5143;&#x7D20;&#x4E2A;&#x6570;&#xFF0C;&#x5224;&#x65AD;&#x4E0E;&#x9664;&#x53BB;&#x5143;&#x6570;&#x636E;&#x4EE5;&#x5916;&#x4E00;&#x9875;&#x80FD;&#x5BB9;&#x7EB3;&#x7684;&#x5143;&#x7D20;&#x4E2A;&#x6570;&#x8C01;&#x5927;&#x8C01;&#x5C0F;</span><br><span class="line">  Label after_frame_check;</span><br><span class="line">  __ cmpl(rdx, (page_size - overhead_size) / Interpreter::stackElementSize);</span><br><span class="line">  __ jcc(Assembler::belowEqual, after_frame_check);</span><br><span class="line">  //&#x5927;&#x4E8E;&#x7684;&#x624D;&#x4F1A;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x7684;&#x5224;&#x65AD;&#xFF0C;&#x56E0;&#x4E3A;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#x7684;&#x8BDD;&#xFF0C;&#x7EDD;&#x5BF9;&#x53EF;&#x4EE5;&#x88AB;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#x9650;&#x5236;&#x4F4F;&#xFF0C;&#x56E0;&#x4E3A;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#x8981;&#x4E0E;&#x9875;&#x5927;&#x5C0F;&#x5BF9;&#x9F50;&#xFF0C;&#x56E0;&#x6B64;&#x81F3;&#x5C11;&#x4E00;&#x9875;</span><br><span class="line">  //&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#x7684;&#x6808;&#x5E27;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x8DF3;&#x8FC7;&#x9EC4;&#x8272;&#x533A;&#x57DF;&#xFF0C;&#x53EA;&#x6709;&#x5927;&#x4E8E;&#x7684;&#x987B;&#x6709;&#x540E;&#x7EED;&#x4ED4;&#x7EC6;&#x5224;&#x65AD;</span><br><span class="line"></span><br><span class="line">  Label after_frame_check_pop;</span><br><span class="line">  //&#x8BFB;&#x53D6;&#x7EBF;&#x7A0B;&#x7684; stack_overflow_limit_offset</span><br><span class="line">  //_stack_overflow_limit = stack_end() + MAX2(stack_guard_zone_size(), stack_shadow_zone_size());</span><br><span class="line">  //&#x5373;&#x6808;&#x5C3E; &#x52A0;&#x4E0A; &#x4FDD;&#x62A4;&#x533A;&#x57DF; &#x6216;&#x8005; &#x9634;&#x5F71;&#x533A;&#x57DF; &#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x5373;&#x6709;&#x6548;&#x6808;&#x5C3E;&#x5730;&#x5740;</span><br><span class="line">  //&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x6808;&#x5BB9;&#x91CF;&#x9876;&#x90E8;&#x51CF;&#x53BB; &#x4FDD;&#x62A4;&#x533A;&#x57DF; &#x6216;&#x8005; &#x9634;&#x5F71;&#x533A;&#x57DF; &#x7684;&#x6700;&#x5927;&#x503C;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5373;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x6808;&#x53EA;&#x80FD;&#x589E;&#x957F;&#x5230;&#x8FD9;&#x4E2A;&#x5730;&#x5740;</span><br><span class="line">  const Address stack_limit(thread, JavaThread::stack_overflow_limit_offset());</span><br><span class="line">  //&#x5C06;&#x524D;&#x9762;&#x8BA1;&#x7B97;&#x7684;&#x6808;&#x5E27;&#x5143;&#x7D20;&#x4E2A;&#x6570;&#x5927;&#x5C0F;&#x4FDD;&#x5B58;&#x5728; rax</span><br><span class="line">  __ mov(rax, rdx);</span><br><span class="line">  //&#x5C06;&#x6808;&#x5E27;&#x7684;&#x5143;&#x7D20;&#x4E2A;&#x6570;&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x8282;&#x5927;&#x5C0F;&#xFF0C;&#x7136;&#x540E;&#x52A0;&#x4E0A;&#x6808;&#x5E27;&#x7684;&#x5143;&#x6570;&#x636E;&#x6D88;&#x8017;</span><br><span class="line">  __ shlptr(rax, Interpreter::logStackElementSize); </span><br><span class="line">  __ addptr(rax, overhead_size);</span><br><span class="line"></span><br><span class="line">  //&#x52A0;&#x4E0A;&#x524D;&#x9762;&#x8BA1;&#x7B97;&#x7684;&#x6709;&#x6548;&#x6808;&#x5C3E;&#x5730;&#x5740;</span><br><span class="line">  __ addptr(rax, stack_limit);</span><br><span class="line"></span><br><span class="line">  //&#x4E0E;&#x5F53;&#x524D;&#x6808;&#x9876;&#x5730;&#x5740;&#x6BD4;&#x8F83;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x6808;&#x9876;&#x5730;&#x5740;&#x5927;&#x4E8E; rax &#x5F53;&#x524D;&#x503C;&#xFF0C;&#x8BC1;&#x660E;&#x6CA1;&#x6709;&#x6EA2;&#x51FA;</span><br><span class="line">  __ cmpptr(rsp, rax);</span><br><span class="line">  __ jcc(Assembler::above, after_frame_check_pop);</span><br><span class="line"></span><br><span class="line">  //&#x5426;&#x5219;&#x629B;&#x51FA; StackOverflowError &#x5F02;&#x5E38;</span><br><span class="line">  __ jump(ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));</span><br><span class="line">  __ bind(after_frame_check_pop);</span><br><span class="line">  __ bind(after_frame_check);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4EE3;&#x7801;&#x7684;&#x6B65;&#x9AA4;&#x5927;&#x6982;&#x662F;&#xFF08;plagiarism&#x548C;&#x6D17;&#x7A3F;&#x662F;&#x6076;&#x610F;&#x6284;&#x88AD;&#x4ED6;&#x4EBA;&#x52B3;&#x52A8;&#x6210;&#x679C;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x662F;&#x5BF9;&#x52B3;&#x52A8;&#x4EF7;&#x503C;&#x7684;&#x6F20;&#x89C6;&#x548C;&#x8DF5;&#x8E0F;&#xFF01; &#xFF09;&#xFF1A;</p>
<ol>
<li>&#x9996;&#x5148;&#x5224;&#x65AD;&#x8981;&#x5206;&#x914D;&#x7684;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#xFF0C;&#x662F;&#x5426;&#x5927;&#x4E8E;&#x4E00;&#x9875;&#x3002;</li>
<li><strong>&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#x7B49;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x4E0D;&#x7528;&#x68C0;&#x67E5;&#xFF0C;&#x76F4;&#x63A5;&#x7ED3;&#x675F;</strong>&#x3002;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x90A3;&#x4E48;&#x6808;&#x5E27;&#x7684;&#x5143;&#x7D20;&#x4E2A;&#x6570;&#x4E00;&#x5B9A;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x6808;&#x589E;&#x957F;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x8DF3;&#x8FC7;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#xFF0C;&#x5982;&#x679C;&#x8FBE;&#x5230;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x5C31;&#x4F1A;&#x89E6;&#x53D1; <code>SIGSEGV</code> &#x629B;&#x51FA; <code>StackOverflowError</code>&#x3002;&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x5982;&#x524D;&#x9762;&#x6E90;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x90FD;&#x662F;&#x5BF9;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x81F3;&#x5C11;&#x4E00;&#x9875;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5927;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x68C0;&#x67E5;&#x3002;&#x68C0;&#x67E5;&#x5F53;&#x524D;&#x5DF2;&#x7ECF;&#x4F7F;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x52A0;&#x4E0A;&#x6808;&#x5E27;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x52A0;&#x4E0A;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x4E0E;&#x9634;&#x5F71;&#x533A;&#x57DF;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x5360;&#x7528;&#x7A7A;&#x95F4;&#x662F;&#x5426;&#x5927;&#x4E8E;&#x6808;&#x7A7A;&#x95F4;&#x9650;&#x5236;&#x3002;&#x5982;&#x679C;&#x5927;&#x4E8E;&#xFF0C;&#x5219;&#x629B;&#x51FA; <code>StackOverflowError</code> &#x5F02;&#x5E38;&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x662F;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x4E0E;&#x9634;&#x5F71;&#x533A;&#x57DF;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF1F;&#x9634;&#x5F71;&#x533A;&#x57DF;&#x5176;&#x5B9E;&#x662F;&#x6211;&#x4EEC;&#x5047;&#x8BBE;&#x7684;&#x6700;&#x5927;&#x5E27;&#x5927;&#x5C0F;&#xFF0C;&#x6700;&#x540E;&#x81F3;&#x5C11;&#x8981;&#x6709;&#x8FD9;&#x4E48;&#x591A;&#x7A7A;&#x95F4;&#x624D;&#x4E00;&#x5B9A;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x6EA2;&#x51FA;&#x6808;&#x9876;&#x6C61;&#x67D3;&#x5176;&#x4ED6;&#x5185;&#x5B58;&#xFF08;&#x5F53;&#x7136;&#xFF0C;&#x5982;&#x4E4B;&#x524D;&#x6240;&#x8FF0;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A; Native &#x8C03;&#x7528;&#x5E76;&#x4E14;&#x6808;&#x5E27;&#x5F88;&#x5927;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x9634;&#x5F71;&#x533A;&#x57DF;&#x5927;&#x5C0F;&#xFF09;&#x3002;&#x5982;&#x679C;&#x672C;&#x8EAB;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x5C31;&#x6BD4;&#x9634;&#x5F71;&#x533A;&#x57DF;&#x5927;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x7528;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5C31;&#x4E5F;&#x80FD;&#x4FDD;&#x8BC1;&#x8FD9;&#x4E00;&#x70B9;&#x3002;</li>
</ol>
<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#xFF0C;&#x867D;&#x7136;&#x505A;&#x4E86;&#x4E00;&#x5B9A;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x5F88;&#x590D;&#x6742;&#xFF0C;&#x5C31;&#x7B97;&#x5927;&#x90E8;&#x5206;&#x6808;&#x5E27;&#x5E94;&#x8BE5;&#x90FD;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x4F46;&#x662F;&#x521A;&#x5F00;&#x59CB;&#x7684;&#x5224;&#x65AD;&#x6307;&#x4EE4;&#x8FD8;&#x662F;&#x6709;&#x4E0D;&#x5C0F;&#x7684;&#x6D88;&#x8017;&#x3002;&#x6211;&#x4EEC;&#x770B;&#x770B; JIT &#x7F16;&#x8BD1;&#x540E;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x8FD8;&#x662F;&#x4EE5; x86 cpu &#x4E3A;&#x4F8B;&#xFF1A;</p>
<p><a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/share/asm/assembler.cpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;void AbstractAssembler::generate_stack_overflow_check(int frame_size_in_bytes) {</span><br><span class="line">  //&#x8BFB;&#x53D6;&#x865A;&#x62DF;&#x673A;&#x9875;&#x5927;&#x5C0F;&#xFF0C;&#x7B2C;&#x4E8C;&#x7AE0;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x8FC7;</span><br><span class="line">  const int page_size = os::vm_page_size();</span><br><span class="line">  //&#x8BFB;&#x53D6;&#x5F71;&#x5B50;&#x533A;&#x5927;&#x5C0F;</span><br><span class="line">  int bang_end = (int)StackOverflow::stack_shadow_zone_size();</span><br><span class="line">  </span><br><span class="line">  //&#x5982;&#x679C;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#x5927;&#x4E8E;&#x4E00;&#x9875;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x5C06; bang_end &#x52A0;&#x4E0A;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#xFF0C;&#x4E4B;&#x540E;&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x9875;&#x662F;&#x5426;&#x5904;&#x4E8E;&#x4FDD;&#x62A4;&#x533A;&#x57DF;</span><br><span class="line">  const int bang_end_safe = bang_end;</span><br><span class="line">  if (frame_size_in_bytes &gt; page_size) {</span><br><span class="line">    bang_end += frame_size_in_bytes;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  //&#x68C0;&#x67E5;&#x6BCF;&#x4E00;&#x9875;&#x662F;&#x5426;&#x5904;&#x4E8E;&#x4FDD;&#x62A4;&#x533A;&#x57DF;</span><br><span class="line">  int bang_offset = bang_end_safe;</span><br><span class="line">  while (bang_offset &lt;= bang_end) {</span><br><span class="line">    bang_stack_with_offset(bang_offset);</span><br><span class="line">    bang_offset += page_size;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/cpu/x86/macroAssembler_x86.cpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;//&#x68C0;&#x67E5;&#x662F;&#x5426;&#x5904;&#x4E8E;&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C06; rsp - offset &#x7684;&#x5730;&#x5740;&#x4E0A;&#x7684;&#x503C;&#x5199;&#x5165; rax &#x4E0A;&#xFF0C;</span><br><span class="line">//&#x5982;&#x679C; rsp - offset &#x4FDD;&#x62A4;&#x533A;&#x57DF;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x89E6;&#x53D1; SIGSEGV</span><br><span class="line">void bang_stack_with_offset(int offset) {</span><br><span class="line">    movl(Address(rsp, (-offset)), rax);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x7F16;&#x8BD1;&#x540E;&#x6267;&#x884C;&#x7684;&#x6307;&#x4EE4;&#x5C31;&#x7B80;&#x5355;&#x591A;&#x4E86;&#xFF1A;</p>
<ol>
<li>&#x5982;&#x679C;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#xFF1A;&#x53EA;&#x9700;&#x8981;&#x8003;&#x8651; Native &#x8C03;&#x7528;&#x662F;&#x5426;&#x4F1A;&#x5BFC;&#x81F4; <code>StackOverflow</code> &#x5373;&#x53EF;&#x3002;&#x68C0;&#x67E5;&#x5F53;&#x524D;&#x5360;&#x7528;&#x4F4D;&#x7F6E;&#x52A0;&#x4E0A;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x5927;&#x5C0F;&#xFF0C;&#x4E4B;&#x540E;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4F1A;&#x8FDB;&#x5165;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x5373;&#x53EF;&#xFF0C;&#x4E0D;&#x7528;&#x8003;&#x8651;&#x5F53;&#x524D;&#x65B9;&#x6CD5;&#x6808;&#x5E27;&#x5360;&#x7528;&#x5927;&#x5C0F;&#xFF0C;&#x56E0;&#x4E3A;&#x80AF;&#x5B9A;&#x5C0F;&#x4E8E;&#x4E00;&#x9875;&#x3002;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x8FDB;&#x5165;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x4E5F;&#x548C;&#x4E4B;&#x524D;&#x8BA8;&#x8BBA;&#x8FC7;&#x7684; <code>NullPointeException</code> &#x7684;&#x5904;&#x7406;&#x662F;&#x7C7B;&#x4F3C;&#x7684;&#xFF0C;&#x5C31;&#x662F;&#x5C06; rsp - offset &#x7684;&#x5730;&#x5740;&#x4E0A;&#x7684;&#x503C;&#x5199;&#x5165; rax &#x4E0A;&#xFF0C;&#x5982;&#x679C; rsp - offset &#x5904;&#x4E8E;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x89E6;&#x53D1; <code>SIGSEGV</code>&#x3002;</li>
<li>&#x5982;&#x679C;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#x5927;&#x4E8E;&#x4E00;&#x9875;&#xFF1A;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x5C06;&#x5F53;&#x524D;&#x5360;&#x7528;&#x4F4D;&#x7F6E;&#xFF0C;&#x52A0;&#x4E0A;&#x6808;&#x5E27;&#x5927;&#x5C0F;&#xFF0C;&#x52A0;&#x4E0A;&#x5F71;&#x5B50;&#x533A;&#x57DF;&#x5927;&#x5C0F;&#xFF0C;&#x4E4B;&#x540E;&#x4ECE;&#x5F53;&#x524D;&#x6808;&#x5E27;&#x6309;&#x9875;&#x68C0;&#x67E5;&#xFF0C;&#x662F;&#x5426;&#x5904;&#x4E8E;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x3002;&#x56E0;&#x4E3A;&#x5927;&#x4E8E;&#x4E00;&#x9875;&#x7684;&#x8BDD;&#xFF0C;&#x76F4;&#x63A5;&#x9A8C;&#x8BC1;&#x6700;&#x540E;&#x7684;&#x4F4D;&#x7F6E;&#x53EF;&#x80FD;&#x4F1A;&#x6EA2;&#x51FA;&#x5230;&#x5176;&#x4ED6;&#x4E1C;&#x897F;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF08;&#x6BD4;&#x5982;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF09;&#x3002;</li>
</ol>
<h3 id="5-3-2-&#x4E00;&#x4E2A;-Java-&#x7EBF;&#x7A0B;-Xss-&#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;"><a href="#5-3-2-&#x4E00;&#x4E2A;-Java-&#x7EBF;&#x7A0B;-Xss-&#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;" class="headerlink" title="5.3.2. &#x4E00;&#x4E2A; Java &#x7EBF;&#x7A0B; Xss &#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;"></a>5.3.2. &#x4E00;&#x4E2A; Java &#x7EBF;&#x7A0B; Xss &#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;</h3><p>&#x8FD9;&#x4E2A;&#x548C;&#x5E73;&#x53F0;&#x662F;&#x76F8;&#x5173;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x4EE5; linux x86 &#x4E3A;&#x4F8B;&#x5B50;&#xFF0C;&#x5047;&#x8BBE;&#x6CA1;&#x6709;&#x5927;&#x9875;&#x5206;&#x914D;&#xFF0C;&#x4E00;&#x9875;&#x5C31;&#x662F; 4K&#xFF0C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x81F3;&#x5C11;&#x8981;&#x4FDD;&#x7559;&#x5982;&#x4E0B;&#x7684;&#x7A7A;&#x95F4;&#xFF1A;</p>
<ul>
<li>&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#xFF1A;<ul>
<li>&#x9EC4;&#x8272;&#x533A;&#x57DF;&#xFF1A;&#x9ED8;&#x8BA4; 2 &#x9875;</li>
<li>&#x7EA2;&#x8272;&#x533A;&#x57DF;&#xFF1A;&#x9ED8;&#x8BA4; 1 &#x9875;</li>
<li>&#x4FDD;&#x7559;&#x533A;&#x57DF;&#xFF1A;&#x9ED8;&#x8BA4; 1 &#x9875;</li>
</ul>
</li>
<li>&#x5F71;&#x5B50;&#x533A;&#x57DF;&#xFF1A;&#x9ED8;&#x8BA4; 20 &#x9875;</li>
</ul>
<p>&#x8FD9;&#x4E9B;&#x52A0;&#x5728;&#x4E00;&#x8D77;&#x662F; 24 &#x9875;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; 96K&#x3002;</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x5728; JVM &#x4EE3;&#x7801;&#x4E2D;&#x4E5F;&#x9650;&#x5236;&#x4E86;&#xFF0C;&#x9664;&#x4E86;&#x8FD9;&#x4E9B;&#x7A7A;&#x95F4;&#xFF0C;&#x6BCF;&#x79CD;&#x7EBF;&#x7A0B;&#x7684;&#x6700;&#x5C0F;&#x5927;&#x5C0F;&#xFF1A;</p>
<p><a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B19/src/hotspot/os_cpu/linux_x86/os_linux_x86.cpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;size_t os::_compiler_thread_min_stack_allowed = 48 * K;</span><br><span class="line">size_t os::_java_thread_min_stack_allowed = 40 * K;</span><br><span class="line">size_t os::_vm_internal_thread_min_stack_allowed = 64 * K;</span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#xFF0C;&#x5BF9;&#x4E8E; Java &#x7EBF;&#x7A0B;&#xFF0C;&#x81F3;&#x5C11;&#x9700;&#x8981; <code>40 + 96 = 136K</code> &#x7684;&#x7A7A;&#x95F4;&#x3002;&#x6211;&#x4EEC;&#x8BD5;&#x4E00;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vbnet&#x590D;&#x5236;&#x4EE3;&#x7801;bash-4.2$ java -Xss1k</span><br><span class="line">The Java thread stack size specified is too small. Specify at least 136k</span><br><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">Error: A fatal exception has occurred. Program will exit.</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>&#x5FAE;&#x4FE1;&#x641C;&#x7D22;&#x201C;&#x5E72;&#x8D27;&#x6EE1;&#x6EE1;&#x5F20;&#x54C8;&#x5E0C;&#x201D;&#x5173;&#x6CE8;&#x516C;&#x4F17;&#x53F7;&#xFF0C;&#x52A0;&#x4F5C;&#x8005;&#x5FAE;&#x4FE1;&#xFF0C;&#x6BCF;&#x65E5;&#x4E00;&#x5237;&#xFF0C;&#x8F7B;&#x677E;&#x63D0;&#x5347;&#x6280;&#x672F;&#xFF0C;&#x65A9;&#x83B7;&#x5404;&#x79CD;offer</strong><br>&#x6211;&#x4F1A;&#x7ECF;&#x5E38;&#x53D1;&#x4E00;&#x4E9B;&#x5F88;&#x597D;&#x7684;&#x5404;&#x79CD;&#x6846;&#x67B6;&#x7684;&#x5B98;&#x65B9;&#x793E;&#x533A;&#x7684;&#x65B0;&#x95FB;&#x89C6;&#x9891;&#x8D44;&#x6599;&#x5E76;&#x52A0;&#x4E0A;&#x4E2A;&#x4EBA;&#x7FFB;&#x8BD1;&#x5B57;&#x5E55;&#x5230;&#x5982;&#x4E0B;&#x5730;&#x5740;&#xFF08;&#x4E5F;&#x5305;&#x62EC;&#x4E0A;&#x9762;&#x7684;&#x516C;&#x4F17;&#x53F7;&#xFF09;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF1A;</p>
<ul>
<li>&#x77E5;&#x4E4E;&#xFF1A;<a href="/external_links/371449001e02a5502b7dec21cae420e8.html" target="blank" rel="noopener">www.zhihu.com/people/zhxh&#x2026;</a></li>
<li>B &#x7AD9;&#xFF1A;<a href="/external_links/4cb1b1096c7f68ac89bbd30f61437b90.html" target="blank" rel="noopener">space.bilibili.com/31359187</a></li>
</ul>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/c5e5ce259de606845ef80ad4a8eae2ca.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn../../7225879731177013303.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../7225879731177013303.html" itemprop="url">全网最硬核 JVM 内存解析 - 12元空间各种监控手段</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-25T15:43:40+08:00">
                2023-04-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>&#x4E2A;&#x4EBA;&#x521B;&#x4F5C;&#x516C;&#x7EA6;&#xFF1A;&#x672C;&#x4EBA;&#x58F0;&#x660E;&#x521B;&#x4F5C;&#x7684;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x7686;&#x4E3A;&#x81EA;&#x5DF1;&#x539F;&#x521B;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x53C2;&#x8003;&#x4EFB;&#x4F55;&#x6587;&#x7AE0;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x4F1A;&#x6807;&#x6CE8;&#x51FA;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x758F;&#x6F0F;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x6279;&#x5224;&#x3002;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x53D1;&#x73B0;&#x7F51;&#x4E0A;&#x6709;&#x6284;&#x88AD;&#x672C;&#x6587;&#x7AE0;&#x7684;&#xFF0C;&#x6B22;&#x8FCE;&#x4E3E;&#x62A5;&#xFF0C;&#x5E76;&#x4E14;&#x79EF;&#x6781;&#x5411;&#x8FD9;&#x4E2A; <a href="/external_links/a7475ce7cc4a9ea6f81215803b043243.html" target="blank" rel="noopener">github &#x4ED3;&#x5E93;</a> &#x63D0;&#x4EA4; issue&#xFF0C;&#x8C22;&#x8C22;&#x652F;&#x6301;~<br>&#x53E6;&#x5916;&#xFF0C;&#x672C;&#x6587;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x6284;&#x88AD;&#xFF0C;&#x4F1A;&#x5728;&#x4E0D;&#x5F71;&#x54CD;&#x9605;&#x8BFB;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x6587;&#x7AE0;&#x7684;&#x968F;&#x673A;&#x4F4D;&#x7F6E;&#x653E;&#x5165;&#x5BF9;&#x4E8E;&#x6284;&#x88AD;&#x548C;&#x6D17;&#x7A3F;&#x7684;&#x4EBA;&#x7684;&#x201C;&#x4EB2;&#x5207;&#x201D;&#x7684;&#x95EE;&#x5019;&#x3002;&#x5982;&#x679C;&#x662F;&#x6B63;&#x5E38;&#x8BFB;&#x8005;&#x770B;&#x5230;&#xFF0C;&#x7B14;&#x8005;&#x5728;&#x8FD9;&#x91CC;&#x8BF4;&#x58F0;&#x5BF9;&#x4E0D;&#x8D77;&#xFF0C;&#x3002;&#x5982;&#x679C;&#x88AB;&#x6284;&#x88AD;&#x72D7;&#x6216;&#x8005;&#x6D17;&#x7A3F;&#x72D7;&#x770B;&#x5230;&#x4E86;&#xFF0C;&#x5E0C;&#x671B;&#x4F60;&#x80FD;&#x591F;&#x597D;&#x597D;&#x53CD;&#x601D;&#xFF0C;&#x4E0D;&#x8981;&#x518D;&#x6284;&#x88AD;&#x4E86;&#xFF0C;&#x8C22;&#x8C22;&#x3002;<br>&#x4ECA;&#x5929;&#x53C8;&#x662F;&#x5E72;&#x8D27;&#x6EE1;&#x6EE1;&#x7684;&#x4E00;&#x5929;&#xFF0C;&#x8FD9;&#x662F;&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x89E3;&#x6790;&#x7CFB;&#x5217;&#x7B2C;&#x56DB;&#x7BC7;&#xFF0C;&#x5F80;&#x671F;&#x7CBE;&#x5F69;&#xFF1A;</p>
<ul>
<li><a href="https://dev.newban.cn/6925217498723778568">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; TLAB &#x89E3;&#x6790;</a></li>
<li><a href="https://dev.newban.cn/7051386828913377316">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; Java &#x968F;&#x673A;&#x6570;&#x89E3;&#x6790;</a></li>
<li><a href="https://dev.newban.cn/7080869319407566879">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; Java &#x65B0;&#x5185;&#x5B58;&#x6A21;&#x578B;&#x89E3;&#x6790;</a></li>
</ul>
</blockquote>
<blockquote>
<p>&#x672C;&#x7BC7;&#x662F;&#x5173;&#x4E8E; JVM &#x5185;&#x5B58;&#x7684;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x3002;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x591A;&#x5173;&#x4E8E; JVM &#x5185;&#x5B58;&#x7ED3;&#x6784;&#x7684;&#x5206;&#x6790;&#x4EE5;&#x53CA;&#x56FE;&#x7247;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x4E0D;&#x662F;&#x4E00;&#x624B;&#x7684;&#x8D44;&#x6599;&#x4EA6;&#x6216;&#x662F;&#x4EBA;&#x4E91;&#x4EA6;&#x4E91;&#x5BFC;&#x81F4;&#x6709;&#x5F88;&#x9519;&#x8BEF;&#xFF0C;&#x9020;&#x6210;&#x4E86;&#x5F88;&#x591A;&#x8BEF;&#x89E3;&#xFF1B;&#x5E76;&#x4E14;&#xFF0C;&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x6700;&#x5BB9;&#x6613;&#x6DF7;&#x6DC6;&#x7684;&#x662F;&#x4E00;&#x8FB9;&#x662F; JVM Specification &#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4E00;&#x8FB9;&#x662F; Hotspot JVM &#x7684;&#x5B9E;&#x9645;&#x5B9E;&#x73B0;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x4EBA;&#x4EEC;&#x4E00;&#x4E9B;&#x90E8;&#x5206;&#x8BF4;&#x7684;&#x662F; JVM Specification&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x8BF4;&#x7684;&#x662F; Hotspot &#x5B9E;&#x73B0;&#xFF0C;&#x7ED9;&#x4EBA;&#x4E00;&#x79CD;&#x5272;&#x88C2;&#x611F;&#x4E0E;&#x8BEF;&#x89E3;&#x3002;&#x672C;&#x7BC7;&#x4E3B;&#x8981;&#x4ECE; Hotspot &#x5B9E;&#x73B0;&#x51FA;&#x53D1;&#xFF0C;&#x4EE5; Linux x86 &#x73AF;&#x5883;&#x4E3A;&#x4E3B;&#xFF0C;&#x7D27;&#x5BC6;&#x8D34;&#x5408; JVM &#x6E90;&#x7801;&#x5E76;&#x4E14;&#x8F85;&#x4EE5;&#x5404;&#x79CD; JVM &#x5DE5;&#x5177;&#x9A8C;&#x8BC1;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x7406;&#x89E3; JVM &#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x672C;&#x7BC7;&#x4EC5;&#x9650;&#x4E8E;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E9B;&#x5185;&#x5B58;&#x7684;&#x7528;&#x9014;&#xFF0C;&#x4F7F;&#x7528;&#x9650;&#x5236;&#xFF0C;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6709;&#x4E9B;&#x5730;&#x65B9;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x6DF1;&#x5165;&#xFF0C;&#x6709;&#x4E9B;&#x5730;&#x65B9;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x672C;&#x8EAB;&#x7528;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x6D89;&#x53CA;&#x7684; JVM &#x6A21;&#x5757;&#x53BB;&#x8BF4;&#xFF0C;&#x4F1A;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x7CFB;&#x5217;&#x6587;&#x7AE0;&#x8BE6;&#x7EC6;&#x63CF;&#x8FF0;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x6D17;&#x7A3F;&#x6284;&#x88AD;&#x72D7;&#x4E0D;&#x5F97; house</p>
</blockquote>
<p>&#x672C;&#x7BC7;&#x5168;&#x7BC7;&#x76EE;&#x5F55;&#xFF08;&#x4EE5;&#x53CA;&#x6D89;&#x53CA;&#x7684; JVM &#x53C2;&#x6570;&#xFF09;&#xFF1A;</p>
<ol>
<li>&#x4ECE; Native Memory Tracking &#x8BF4;&#x8D77;&#xFF08;<a href="https://dev.newban.cn/7225871227743043644">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 1.&#x4ECE; Native Memory Tracking &#x8BF4;&#x8D77;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Native Memory Tracking &#x7684;&#x5F00;&#x542F;</li>
<li>Native Memory Tracking &#x7684;&#x4F7F;&#x7528;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>NativeMemoryTracking</code>&#xFF09;</li>
<li>Native Memory Tracking &#x7684; summary &#x4FE1;&#x606F;&#x6BCF;&#x90E8;&#x5206;&#x542B;&#x4E49;</li>
<li>Native Memory Tracking &#x7684; summary &#x4FE1;&#x606F;&#x7684;&#x6301;&#x7EED;&#x76D1;&#x63A7;</li>
<li>&#x4E3A;&#x4F55; Native Memory Tracking &#x4E2D;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x5206;&#x4E3A; reserved &#x548C; committed</li>
</ol>
</li>
<li>JVM &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x4E0E;&#x4F7F;&#x7528;&#x6D41;&#x7A0B;&#xFF08;<a href="https://dev.newban.cn/7225875600644407357">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 2.JVM &#x5185;&#x5B58;&#x7533;&#x8BF7;&#x4E0E;&#x4F7F;&#x7528;&#x6D41;&#x7A0B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Linux &#x4E0B;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6A21;&#x578B;&#x7B80;&#x8FF0;</li>
<li>JVM commit &#x7684;&#x5185;&#x5B58;&#x4E0E;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x5185;&#x5B58;&#x7684;&#x5DEE;&#x5F02;<ol>
<li>JVM commit &#x7684;&#x5185;&#x5B58;&#x4E0E;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x5185;&#x5B58;&#x7684;&#x5DEE;&#x5F02;</li>
</ol>
</li>
<li>&#x5927;&#x9875;&#x5206;&#x914D; UseLargePages&#xFF08;<a href="https://dev.newban.cn/7225875600644489277">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 3.&#x5927;&#x9875;&#x5206;&#x914D; UseLargePages</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>Linux &#x5927;&#x9875;&#x5206;&#x914D;&#x65B9;&#x5F0F; - Huge Translation Lookaside Buffer Page (hugetlbfs)</li>
<li>Linux &#x5927;&#x9875;&#x5206;&#x914D;&#x65B9;&#x5F0F; - Transparent Huge Pages (THP)</li>
<li>JVM &#x5927;&#x9875;&#x5206;&#x914D;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x4E0E;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseLargePages</code>,<code>UseHugeTLBFS</code>,<code>UseSHM</code>,<code>UseTransparentHugePages</code>,<code>LargePageSizeInBytes</code>&#xFF09;</li>
</ol>
</li>
</ol>
</li>
<li>Java &#x5806;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225874698906615864">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 4.Java &#x5806;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x7684;&#x786E;&#x8BA4;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x901A;&#x7528;&#x521D;&#x59CB;&#x5316;&#x4E0E;&#x6269;&#x5C55;&#x6D41;&#x7A0B;</li>
<li>&#x76F4;&#x63A5;&#x6307;&#x5B9A;&#x4E09;&#x4E2A;&#x6307;&#x6807;&#x7684;&#x65B9;&#x5F0F;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MaxHeapSize</code>,<code>MinHeapSize</code>,<code>InitialHeapSize</code>,<code>Xmx</code>,<code>Xms</code>&#xFF09;</li>
<li>&#x4E0D;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E09;&#x4E2A;&#x6307;&#x6807;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E09;&#x4E2A;&#x6307;&#x6807;(MinHeapSize,MaxHeapSize,InitialHeapSize)&#x662F;&#x5982;&#x4F55;&#x8BA1;&#x7B97;&#x7684;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x76F8;&#x5173;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseCompressedOops</code>&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225874698906714168">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 5.&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x76F8;&#x5173;&#x673A;&#x5236;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x5B58;&#x5728;&#x7684;&#x610F;&#x4E49;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ObjectAlignmentInBytes</code>&#xFF09;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E;&#x538B;&#x7F29;&#x7C7B;&#x6307;&#x9488;&#x7684;&#x5173;&#x7CFB;&#x6F14;&#x8FDB;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>UseCompressedOops</code>,<code>UseCompressedClassPointers</code>&#xFF09;</li>
<li>&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x7684;&#x4E0D;&#x540C;&#x6A21;&#x5F0F;&#x4E0E;&#x5BFB;&#x5740;&#x4F18;&#x5316;&#x673A;&#x5236;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ObjectAlignmentInBytes</code>,<code>HeapBaseMinAddress</code>&#xFF09;</li>
</ol>
</li>
<li>&#x4E3A;&#x4F55;&#x9884;&#x7559;&#x7B2C; 0 &#x9875;&#xFF0C;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488; null &#x5224;&#x65AD;&#x64E6;&#x9664;&#x7684;&#x5B9E;&#x73B0;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>HeapBaseMinAddress</code>&#xFF09;</li>
<li>&#x7ED3;&#x5408;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#x5806;&#x5185;&#x5B58;&#x9650;&#x5236;&#x7684;&#x521D;&#x59CB;&#x5316;&#x7684;&#x5173;&#x7CFB;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>HeapBaseMinAddress</code>,<code>ObjectAlignmentInBytes</code>,<code>MinHeapSize</code>,<code>MaxHeapSize</code>,<code>InitialHeapSize</code>&#xFF09;</li>
<li>&#x4F7F;&#x7528; jol + jhsdb + JVM &#x65E5;&#x5FD7;&#x67E5;&#x770B;&#x538B;&#x7F29;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#x4E0E; Java &#x5806;&#x9A8C;&#x8BC1;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x7684;&#x7ED3;&#x8BBA;<ol>
<li>&#x9A8C;&#x8BC1; <code>32-bit</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Zero based</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Non-zero disjoint</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
<li>&#x9A8C;&#x8BC1; <code>Non-zero based</code> &#x538B;&#x7F29;&#x6307;&#x9488;&#x6A21;&#x5F0F;</li>
</ol>
</li>
<li>&#x5806;&#x5927;&#x5C0F;&#x7684;&#x52A8;&#x6001;&#x4F38;&#x7F29;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MinHeapFreeRatio</code>,<code>MaxHeapFreeRatio</code>,<code>MinHeapDeltaBytes</code>&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225879698952470588">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 6.&#x5176;&#x4ED6; Java &#x5806;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x7684;&#x7279;&#x6B8A;&#x673A;&#x5236;</a>&#x5F00;&#x59CB;&#xFF09;</li>
<li>&#x9002;&#x7528;&#x4E8E;&#x957F;&#x671F;&#x8FD0;&#x884C;&#x5E76;&#x4E14;&#x5C3D;&#x91CF;&#x5C06;&#x6240;&#x6709;&#x53EF;&#x7528;&#x5185;&#x5B58;&#x88AB;&#x5806;&#x4F7F;&#x7528;&#x7684; JVM &#x53C2;&#x6570; AggressiveHeap</li>
<li>JVM &#x53C2;&#x6570; AlwaysPreTouch &#x7684;&#x4F5C;&#x7528;</li>
<li>JVM &#x53C2;&#x6570; UseContainerSupport - JVM &#x5982;&#x4F55;&#x611F;&#x77E5;&#x5230;&#x5BB9;&#x5668;&#x5185;&#x5B58;&#x9650;&#x5236;</li>
<li>JVM &#x53C2;&#x6570; SoftMaxHeapSize - &#x7528;&#x4E8E;&#x5E73;&#x6ED1;&#x8FC1;&#x79FB;&#x66F4;&#x8017;&#x5185;&#x5B58;&#x7684; GC &#x4F7F;&#x7528;</li>
</ol>
</li>
<li>JVM &#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225879698952486972">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 7.&#x5143;&#x7A7A;&#x95F4;&#x5B58;&#x50A8;&#x7684;&#x5143;&#x6570;&#x636E;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x4EC0;&#x4E48;&#x662F;&#x5143;&#x6570;&#x636E;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5143;&#x6570;&#x636E;</li>
<li>&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x7528;&#x5230;&#x5143;&#x7A7A;&#x95F4;&#xFF0C;&#x5143;&#x7A7A;&#x95F4;&#x4FDD;&#x5B58;&#x4EC0;&#x4E48;</li>
<li>2.1. &#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x7528;&#x5230;&#x5143;&#x7A7A;&#x95F4;&#xFF0C;&#x4EE5;&#x53CA;&#x91CA;&#x653E;&#x65F6;&#x673A;</li>
<li>2.2. &#x5143;&#x7A7A;&#x95F4;&#x4FDD;&#x5B58;&#x4EC0;&#x4E48;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#x4E0E;&#x8BBE;&#x8BA1;&#xFF08;<a href="https://dev.newban.cn/7225879724545835045">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 8.&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#x4E0E;&#x8BBE;&#x8BA1;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x6574;&#x4F53;&#x914D;&#x7F6E;&#x4EE5;&#x53CA;&#x76F8;&#x5173;&#x53C2;&#x6570;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>MetaspaceSize</code>,<code>MaxMetaspaceSize</code>,<code>MinMetaspaceExpansion</code>,<code>MaxMetaspaceExpansion</code>,<code>MaxMetaspaceFreeRatio</code>,<code>MinMetaspaceFreeRatio</code>,<code>UseCompressedClassPointers</code>,<code>CompressedClassSpaceSize</code>,<code>CompressedClassSpaceBaseAddress</code>,<code>MetaspaceReclaimPolicy</code>&#xFF09;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x4E0A;&#x4E0B;&#x6587; <code>MetaspaceContext</code></li>
<li>&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9;&#x5217;&#x8868; <code>VirtualSpaceList</code></li>
<li>&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9; <code>VirtualSpaceNode</code> &#x4E0E; <code>CompressedClassSpaceSize</code></li>
<li><code>MetaChunk</code><ol>
<li><code>ChunkHeaderPool</code> &#x6C60;&#x5316; <code>MetaChunk</code> &#x5BF9;&#x8C61;</li>
<li><code>ChunkManager</code> &#x7BA1;&#x7406;&#x7A7A;&#x95F2;&#x7684; <code>MetaChunk</code></li>
</ol>
</li>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x7684;&#x5165;&#x53E3; <code>SystemDictionary</code> &#x4E0E;&#x4FDD;&#x7559;&#x6240;&#x6709; <code>ClassLoaderData</code> &#x7684; <code>ClassLoaderDataGraph</code></li>
<li>&#x6BCF;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x79C1;&#x6709;&#x7684; <code>ClassLoaderData</code> &#x4EE5;&#x53CA; <code>ClassLoaderMetaspace</code></li>
<li>&#x7BA1;&#x7406;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684; <code>MetaChunk</code> &#x7684; <code>MetaspaceArena</code></li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6D41;&#x7A0B;&#xFF08;<a href="https://dev.newban.cn/7225879724545900581">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 9.&#x5143;&#x7A7A;&#x95F4;&#x5185;&#x5B58;&#x5206;&#x914D;&#x6D41;&#x7A0B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x5230; <code>MetaSpaceArena</code> &#x7684;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x6574;&#x4F53;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - <code>FreeBlocks</code> &#x56DE;&#x6536;&#x8001;&#x7684; <code>current chunk</code> &#x4E0E;&#x7528;&#x4E8E;&#x540E;&#x7EED;&#x5206;&#x914D;&#x7684;&#x6D41;&#x7A0B;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x5C1D;&#x8BD5;&#x4ECE; <code>FreeBlocks</code> &#x5206;&#x914D;</li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x5C1D;&#x8BD5;&#x6269;&#x5BB9; <code>current chunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code> - &#x4ECE; <code>VirtualSpaceList</code> &#x7533;&#x8BF7;&#x65B0;&#x7684; <code>RootMetaChunk</code></li>
<li>&#x4ECE; <code>MetaChunkArena</code> &#x666E;&#x901A;&#x5206;&#x914D; - &#x4ECE; <code>ChunkManager</code> &#x5206;&#x914D;&#x65B0;&#x7684; <code>MetaChunk</code> - &#x5C06; <code>RootMetaChunk</code> &#x5207;&#x5272;&#x6210;&#x4E3A;&#x9700;&#x8981;&#x7684; <code>MetaChunk</code></li>
<li><code>MetaChunk</code> &#x56DE;&#x6536; - &#x4E0D;&#x540C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C; <code>MetaChunk</code> &#x5982;&#x4F55;&#x653E;&#x5165; <code>FreeChunkListVector</code></li>
</ol>
</li>
<li><code>ClassLoaderData</code> &#x56DE;&#x6536;</li>
</ol>
</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;&#xFF08;<a href="https://dev.newban.cn/7225879698952634428">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 10.&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>&#x9996;&#x5148;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 1023 &#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x8FD8;&#x9700;&#x8981;&#x5206;&#x914D; 1023 &#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 264 KB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 2 MB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x9700;&#x8981;&#x5206;&#x914D; 128KB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x65B0;&#x6765;&#x4E00;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 2&#xFF0C;&#x9700;&#x8981;&#x5206;&#x914D; 1023 Bytes &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 1 &#x88AB; GC &#x56DE;&#x6536;&#x6389;</li>
<li>&#x7136;&#x540E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668; 2 &#x9700;&#x8981;&#x5206;&#x914D; 1 MB &#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5C5E;&#x4E8E;&#x7C7B;&#x7A7A;&#x95F4;</li>
</ol>
</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x9650;&#x5236;&#x4E0E;&#x52A8;&#x6001;&#x4F38;&#x7F29;&#xFF08;<a href="https://dev.newban.cn/7225879724546015269">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 11.&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x56DE;&#x6536;&#x6D41;&#x7A0B;&#x4E3E;&#x4F8B;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li><code>CommitLimiter</code> &#x7684;&#x9650;&#x5236;&#x5143;&#x7A7A;&#x95F4;&#x53EF;&#x4EE5; commit &#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x4EE5;&#x53CA;&#x9650;&#x5236;&#x5143;&#x7A7A;&#x95F4;&#x5360;&#x7528;&#x8FBE;&#x5230;&#x591A;&#x5C11;&#x5C31;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5; GC</li>
<li>&#x6BCF;&#x6B21; GC &#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x4F1A;&#x5C1D;&#x8BD5;&#x91CD;&#x65B0;&#x8BA1;&#x7B97; <code>_capacity_until_GC</code></li>
</ol>
</li>
<li><code>jcmd VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;&#xFF08;<a href="https://dev.newban.cn/7225879731177013303">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 12.&#x5143;&#x7A7A;&#x95F4;&#x5404;&#x79CD;&#x76D1;&#x63A7;&#x624B;&#x6BB5;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li><code>jcmd &lt;pid&gt; VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;</li>
<li>&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;</li>
<li>&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;<ol>
<li><code>jdk.MetaspaceSummary</code> &#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceAllocationFailure</code> &#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceOOM</code> &#x5143;&#x7A7A;&#x95F4; OOM &#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceGCThreshold</code> &#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;</li>
<li><code>jdk.MetaspaceChunkFreeListSummary</code> &#x5143;&#x7A7A;&#x95F4; Chunk FreeList &#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;&#xFF08;&#x91CD;&#x70B9;&#x7814;&#x7A76; Java &#x7EBF;&#x7A0B;&#xFF09;&#xFF08;<a href="https://dev.newban.cn/7225879724546113573">&#x5168;&#x7F51;&#x6700;&#x786C;&#x6838; JVM &#x5185;&#x5B58;&#x89E3;&#x6790; - 13.JVM &#x7EBF;&#x7A0B;&#x5185;&#x5B58;&#x8BBE;&#x8BA1;</a>&#x5F00;&#x59CB;&#xFF09;<ol>
<li>JVM &#x4E2D;&#x6709;&#x54EA;&#x51E0;&#x79CD;&#x7EBF;&#x7A0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x6808;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4EC0;&#x4E48;&#xFF08;&#x6D89;&#x53CA; JVM &#x53C2;&#x6570;&#xFF1A;<code>ThreadStackSize</code>,<code>VMThreadStackSize</code>,<code>CompilerThreadStackSize</code>,<code>StackYellowPages</code>,<code>StackRedPages</code>,<code>StackShadowPages</code>,<code>StackReservedPages</code>,<code>RestrictReservedStack</code>&#xFF09;</li>
<li>Java &#x7EBF;&#x7A0B;&#x6808;&#x5185;&#x5B58;&#x7684;&#x7ED3;&#x6784;</li>
<li>Java &#x7EBF;&#x7A0B;&#x5982;&#x4F55;&#x629B;&#x51FA;&#x7684; StackOverflowError<ol>
<li>&#x89E3;&#x91CA;&#x6267;&#x884C;&#x4E0E;&#x7F16;&#x8BD1;&#x6267;&#x884C;&#x65F6;&#x5019;&#x7684;&#x5224;&#x65AD;&#xFF08;x86&#x4E3A;&#x4F8B;&#xFF09;</li>
<li>&#x4E00;&#x4E2A; Java &#x7EBF;&#x7A0B; Xss &#x6700;&#x5C0F;&#x80FD;&#x6307;&#x5B9A;&#x591A;&#x5927;</li>
</ol>
</li>
</ol>
</li>
</ol>
<ol start="4">
<li><h1 id="JVM-&#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;"><a href="#JVM-&#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;" class="headerlink" title="JVM &#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;"></a>JVM &#x5143;&#x7A7A;&#x95F4;&#x8BBE;&#x8BA1;</h1></li>
</ol>
<h2 id="4-6-jcmd-VM-metaspace-&#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173;-JVM-&#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4;-JFR-&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;"><a href="#4-6-jcmd-VM-metaspace-&#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173;-JVM-&#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4;-JFR-&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;" class="headerlink" title="4.6. jcmd VM.metaspace &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;"></a>4.6. <code>jcmd VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;&#x4EE5;&#x53CA;&#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;</h2><h3 id="4-6-1-jcmd-lt-pid-gt-VM-metaspace-&#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;"><a href="#4-6-1-jcmd-lt-pid-gt-VM-metaspace-&#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;" class="headerlink" title="4.6.1. jcmd &lt;pid&gt; VM.metaspace &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;"></a>4.6.1. <code>jcmd &lt;pid&gt; VM.metaspace</code> &#x5143;&#x7A7A;&#x95F4;&#x8BF4;&#x660E;</h3><p>&#x901A;&#x8FC7; <code>jcmd &lt;pid&gt; VM.metaspace</code> &#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5BF9;&#x5E94; JVM &#x8FDB;&#x7A0B;&#x7684;&#x5143;&#x7A7A;&#x95F4;&#x5F53;&#x524D;&#x7684;&#x8BE6;&#x7EC6;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#xFF0C;&#x8FD4;&#x56DE;&#x5185;&#x5BB9;&#x662F;&#xFF1A;</p>
<p><strong>1.&#x5143;&#x7A7A;&#x95F4;&#x4ECE; <code>MetaChunk</code> &#x89D2;&#x5EA6;&#x7684;&#x4F7F;&#x7528;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Total Usage - 1383 loaders, 33006 classes (1361 shared):</span><br><span class="line">  Non-Class: 7964 chunks,    150.83 MB capacity,  150.77 MB (&gt;99%) committed,   150.21 MB (&gt;99%) used,   562.77 KB ( &lt;1%) free,     6.65 KB ( &lt;1%) waste , deallocated: 869 blocks with 249.52 KB</span><br><span class="line">  Class: 2546 chunks,     21.00 MB capacity,   20.93 MB (&gt;99%) committed,    20.21 MB ( 96%) used,   741.42 KB (  3%) free,   216 bytes ( &lt;1%) waste , deallocated: 1057 blocks with 264.88 KB</span><br><span class="line">  Both: 10510 chunks,   171.83 MB capacity,  171.70 MB (&gt;99%) committed,   170.42 MB (&gt;99%) used,     1.27 MB ( &lt;1%) free,     6.86 KB ( &lt;1%) waste , deallocated: 1926 blocks with 514.41 KB</span><br></pre></td></tr></table></figure>

<p>&#x610F;&#x601D;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x4E00;&#x5171; 1383 &#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#xFF0C;&#x52A0;&#x8F7D;&#x4E86; 33006 &#x4E2A;&#x7C7B;&#xFF08;&#x5176;&#x4E2D; 1361 &#x4E2A;&#x662F;&#x5171;&#x4EAB;&#x7C7B;&#xFF09;&#x3002;</li>
<li>capacity &#x662F;&#x6307; <code>MetaChunk</code> &#x7684;&#x603B;&#x5BB9;&#x91CF;&#x5927;&#x5C0F;&#xFF08;<code>Reserved</code> &#x5185;&#x5B58;&#xFF09;&#xFF1B;committed &#x662F;&#x6307;&#x8FD9;&#x4E9B; <code>MetaChunk</code> &#x4E2D; <code>committed</code> &#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x7CFB;&#x7EDF;&#x7269;&#x7406;&#x5185;&#x5B58;&#x662F;&#x8FD9;&#x4E48;&#x5927;&#xFF08;&#x867D;&#x7136;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x70B9;&#x7EC6;&#x5FAE;&#x5DEE;&#x5F02;&#xFF0C;&#x53C2;&#x8003;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x7B2C;&#x4E8C;&#x7AE0;&#xFF09;&#xFF1B;used &#x662F;&#x6307;&#x8FD9;&#x4E9B; <code>MetaChunk</code> &#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x80AF;&#x5B9A;&#x6BD4; <code>committed</code> &#x7684;&#x8981;&#x5C0F;&#xFF1B;free &#x662F;&#x6307;&#x5269;&#x4F59;&#x7684;&#x5927;&#x5C0F;&#xFF1B;committed = used + free + waste&#xFF1B;deallocated &#x662F;&#x6307;&#x56DE;&#x6536;&#x5230; <code>FreeBlocks</code> &#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5C5E;&#x4E8E; free &#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x53E6;&#x4E00;&#x90E8;&#x5206;&#x5C31;&#x662F; <code>MetaChunk</code> &#x4E2D; <code>committed</code> &#x4F46;&#x662F;&#x8FD8;&#x6CA1;&#x4F7F;&#x7528;&#x7684;&#x90E8;&#x5206;&#xFF1B;waste &#x662F;&#x6307;&#x6D6A;&#x8D39;&#x7684;&#x5927;&#x5C0F;&#xFF08;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x4E86;&#x4EC0;&#x4E48;&#x9020;&#x6210;&#x7684;&#x6D6A;&#x8D39;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x641C;&#x7D22; <code>FreeBlocks</code> &#x7684;&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x80FD;&#x6B63;&#x597D;&#x5269;&#x4E0B; 1 &#x5B57;&#x8282;&#xFF0C;&#x5C31;&#x4E0D;&#x653E;&#x56DE;&#x4E86;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;&#x4E86;&#xFF09;&#x6D17;&#x7A3F;&#x7684;&#x72D7;&#x4E5F;&#x9047;&#x5230;&#x4E0D;&#x5C11;</li>
<li>&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#xFF1A;&#x4E00;&#x5171;&#x4F7F;&#x7528;&#x4E86; 7964 &#x4E2A; <code>MetaChunk</code>&#xFF0C;&#x8FD9;&#x4E9B; <code>MetaChunk</code> &#x76F8;&#x5173;&#x603B;&#x5BB9;&#x91CF;&#x5927;&#x5C0F;&#x662F; <code>150.83 MB</code>&#xFF0C;&#x76EE;&#x524D; <code>commit</code> &#x4E86; <code>150.77 MB</code>&#xFF0C;&#x4F7F;&#x7528;&#x4E86; <code>150.21 MB</code>&#xFF0C;&#x5269;&#x4F59; <code>562.77 KB</code> &#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;<code>6.65 KB</code> &#x7684;&#x7A7A;&#x95F4;&#x88AB;&#x6D6A;&#x8D39;&#x4E86;&#x3002;<code>FreeBlocks</code> &#x76EE;&#x524D;&#x56DE;&#x6536;&#x4E86; <code>869</code> &#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x5171; <code>249.52 KB</code>&#x3002;</li>
<li>&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#xFF1A;&#x4E00;&#x5171;&#x4F7F;&#x7528;&#x4E86; 2546 &#x4E2A; <code>MetaChunk</code>&#xFF0C;&#x603B;&#x5BB9;&#x91CF;&#x5927;&#x5C0F;&#x662F; <code>21.00 MB</code>&#xFF0C;&#x76EE;&#x524D; <code>commit</code> &#x4E86; <code>20.93 MB</code>&#xFF0C;&#x4F7F;&#x7528;&#x4E86; <code>20.21 MB</code>&#xFF0C;&#x5269;&#x4F59; <code>741.42 KB</code> &#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;<code>216 bytes</code> &#x7684;&#x7A7A;&#x95F4;&#x88AB;&#x6D6A;&#x8D39;&#x4E86;&#x3002;<code>FreeBlocks</code> &#x76EE;&#x524D;&#x56DE;&#x6536;&#x4E86; <code>1057</code> &#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x5171; <code>264.88 KB</code>&#x3002;</li>
<li>&#x603B;&#x7684;&#x5143;&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#xFF08;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; + &#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#xFF09;&#xFF1A;&#x4E00;&#x5171;&#x4F7F;&#x7528;&#x4E86; 10510 &#x4E2A; <code>MetaChunk</code>&#xFF0C;&#x603B;&#x5BB9;&#x91CF;&#x5927;&#x5C0F;&#x662F; <code>171.83 MB</code>&#xFF0C;&#x76EE;&#x524D; <code>commit</code> &#x4E86; <code>171.70 MB</code>&#xFF0C;&#x4F7F;&#x7528;&#x4E86; <code>170.42 MB</code>&#xFF0C;&#x5269;&#x4F59; <code>1.27 MB</code> &#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;<code>6.86 KB</code> &#x7684;&#x7A7A;&#x95F4;&#x88AB;&#x6D6A;&#x8D39;&#x4E86;&#x3002;<code>FreeBlocks</code> &#x76EE;&#x524D;&#x56DE;&#x6536;&#x4E86; <code>1926</code> &#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x5171; <code>514.41 KB</code>&#x3002;</li>
</ol>
<p>&#x524D;&#x9762;&#x7684;&#x662F;&#x4ECE; <code>MetaChunk</code> &#x7684;&#x89D2;&#x5EA6;&#x53BB;&#x67E5;&#x770B;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x89D2;&#x5EA6;&#x662F;&#x4ECE; <code>VirtualSpaceList</code> &#x53BB;&#x67E5;&#x770B;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x4FE1;&#x606F;&#x5C31;&#x662F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kotlin&#x590D;&#x5236;&#x4EE3;&#x7801;Virtual space:</span><br><span class="line">  Non-class space:      152.00 MB reserved,     150.81 MB (&gt;99%) committed,  19 nodes.</span><br><span class="line">      Class space:        1.00 GB reserved,      20.94 MB (  2%) committed,  1 nodes.</span><br><span class="line">             Both:        1.15 GB reserved,     171.75 MB ( 15%) committed.</span><br></pre></td></tr></table></figure>

<p>&#x610F;&#x601D;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>VirtualSpaceList</code>&#xFF1A;&#x603B;&#x5171; <code>Reserve</code> &#x4E86; <code>152.00 MB</code>&#xFF0C;&#x76EE;&#x524D; <code>Commit</code> &#x4E86; <code>150.81 MB</code>&#xFF0C;&#x4E00;&#x5171;&#x6709; <code>19</code> &#x4E2A; <code>VirtualSpaceNode</code>&#x3002;&#x8FD9;&#x4E2A;&#x4E0E; <code>MetaChunk</code> &#x7684;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#x662F;&#x6709;&#x5DEE;&#x5F02;&#x7684;&#xFF0C;<code>VirtualSpaceList</code> &#x7684;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#x66F4;&#x4F53;&#x73B0;&#x5143;&#x7A7A;&#x95F4;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x7684;&#xFF0C;&#x4ECE; <code>MetaChunk</code> &#x89D2;&#x5EA6;&#x7EDF;&#x8BA1;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;&#x6BCF;&#x4E2A; <code>MetaChunk</code> &#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#x76F8;&#x52A0;&#xFF0C;&#x4F1A;&#x6709;&#x7CBE;&#x5EA6;&#x635F;&#x5931;&#x3002;</li>
<li>&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>VirtualSpaceList</code>&#xFF1A;&#x603B;&#x5171; <code>Reserve</code> &#x4E86; <code>1.00 GB</code>&#xFF0C;&#x76EE;&#x524D; <code>Commit</code> &#x4E86; <code>20.94 MB</code>&#xFF0C;&#x4E00;&#x5171;&#x6709; <code>1</code> &#x4E2A; <code>VirtualSpaceNode</code>&#x3002;</li>
<li>&#x603B;&#x7684;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>VirtualSpaceList</code>&#xFF1A;&#x603B;&#x5171; <code>Reserve</code> &#x4E86; <code>1.15 GB</code>&#xFF0C;&#x76EE;&#x524D; <code>Commit</code> &#x4E86; <code>171.75 MB</code>&#x3002;&#x4E0D;&#x8981;&#x5077;&#x53D6;&#x4ED6;&#x4EBA;&#x7684;&#x52B3;&#x52A8;&#x6210;&#x679C;&#xFF0C;&#x4E5F;&#x4E0D;&#x8981;&#x6D6A;&#x8D39;&#x81EA;&#x5DF1;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x7CBE;&#x529B;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x505A;&#x4E00;&#x4E2A;&#x6709;&#x826F;&#x77E5;&#x7684;&#x5199;&#x4F5C;&#x8005;&#x3002;</li>
</ol>
<p>&#x63A5;&#x4E0B;&#x6765;&#x662F;&#x6BCF;&#x4E2A; <code>ChunkManager</code> &#x7684; <code>FreeChunkListVector</code> &#x7684;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Chunk freelists:</span><br><span class="line">   Non-Class:</span><br><span class="line"></span><br><span class="line">  4m: (none)</span><br><span class="line">  2m: (none)</span><br><span class="line">  1m:    2, capacity=2.00 MB, committed=0 bytes (  0%)</span><br><span class="line">512k: (none)</span><br><span class="line">256k: (none)</span><br><span class="line">128k:    2, capacity=256.00 KB, committed=0 bytes (  0%)</span><br><span class="line"> 64k: (none)</span><br><span class="line"> 32k:    2, capacity=64.00 KB, committed=0 bytes (  0%)</span><br><span class="line"> 16k: (none)</span><br><span class="line">  8k:    2, capacity=16.00 KB, committed=0 bytes (  0%)</span><br><span class="line">  4k:    2, capacity=8.00 KB, committed=0 bytes (  0%)</span><br><span class="line">  2k: (none)</span><br><span class="line">  1k:    2, capacity=2.00 KB, committed=0 bytes (  0%)</span><br><span class="line">Total word size: 2.34 MB, committed: 0 bytes (  0%)</span><br><span class="line"></span><br><span class="line">       Class:</span><br><span class="line"></span><br><span class="line">  4m: (none)</span><br><span class="line">  2m:    1, capacity=2.00 MB, committed=0 bytes (  0%)</span><br><span class="line">  1m:    1, capacity=1.00 MB, committed=0 bytes (  0%)</span><br><span class="line">512k: (none)</span><br><span class="line">256k: (none)</span><br><span class="line">128k: (none)</span><br><span class="line"> 64k: (none)</span><br><span class="line"> 32k: (none)</span><br><span class="line"> 16k: (none)</span><br><span class="line">  8k: (none)</span><br><span class="line">  4k:    1, capacity=4.00 KB, committed=0 bytes (  0%)</span><br><span class="line">  2k: (none)</span><br><span class="line">  1k: (none)</span><br><span class="line">Total word size: 3.00 MB, committed: 0 bytes (  0%)</span><br><span class="line"></span><br><span class="line">        Both:</span><br><span class="line"></span><br><span class="line">  4m: (none)</span><br><span class="line">  2m:    1, capacity=2.00 MB, committed=0 bytes (  0%)</span><br><span class="line">  1m:    3, capacity=3.00 MB, committed=0 bytes (  0%)</span><br><span class="line">512k: (none)</span><br><span class="line">256k: (none)</span><br><span class="line">128k:    2, capacity=256.00 KB, committed=0 bytes (  0%)</span><br><span class="line"> 64k: (none)</span><br><span class="line"> 32k:    2, capacity=64.00 KB, committed=0 bytes (  0%)</span><br><span class="line"> 16k: (none)</span><br><span class="line">  8k:    2, capacity=16.00 KB, committed=0 bytes (  0%)</span><br><span class="line">  4k:    3, capacity=12.00 KB, committed=0 bytes (  0%)</span><br><span class="line">  2k: (none)</span><br><span class="line">  1k:    2, capacity=2.00 KB, committed=0 bytes (  0%)</span><br><span class="line">Total word size: 5.34 MB, committed: 0 bytes (  0%)</span><br></pre></td></tr></table></figure>

<p>&#x4EE5;&#x4E0A;&#x7684;&#x4FE1;&#x606F;&#x53EF;&#x80FD;&#x7528;&#x56FE;&#x7247;&#x66F4;&#x76F4;&#x63A5;&#x4E00;&#x4E9B;&#xFF1A;<br><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/554fb41b328c9e8308e63fe58ca17858d93d9bd424c256e985fa69468cc5e382" alt></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x662F;&#x5173;&#x4E8E;&#x56DE;&#x6536;&#x5229;&#x7528;&#x7684;&#x4ECE; <code>MetaChunk</code> &#x7684;&#x89D2;&#x5EA6;&#x53BB;&#x67E5;&#x770B;&#x4E00;&#x4E9B;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">erlang&#x590D;&#x5236;&#x4EE3;&#x7801;Waste (unused committed space):(percentages refer to total committed size 171.75 MB):</span><br><span class="line">        Waste in chunks in use:      6.86 KB ( &lt;1%)</span><br><span class="line">        Free in chunks in use:      1.27 MB ( &lt;1%)</span><br><span class="line">                In free chunks:      0 bytes (  0%)</span><br><span class="line">Deallocated from chunks in use:    514.41 KB ( &lt;1%) (1926 blocks)</span><br><span class="line">                       -total-:      1.78 MB (  1%)</span><br><span class="line"></span><br><span class="line">chunk header pool: 10520 items, 748.30 KB.</span><br></pre></td></tr></table></figure>

<p>&#x5305;&#x542B;&#x7684;&#x4FE1;&#x606F;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x5F53;&#x524D;&#x88AB;&#x4F7F;&#x7528;&#x7684; <code>MetaChunk</code>&#xFF08;&#x5373;&#x5B58;&#x5728;&#x4E8E;&#x6BCF;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x5BF9;&#x5E94;&#x7684; <code>MetaspaceArena</code> &#x4E2D;&#x7684; <code>MetaChunk</code>&#xFF09;&#x4E2D;&#x6709; <code>6.86 KB</code> &#x7684;&#x7A7A;&#x95F4;&#x88AB;&#x6D6A;&#x8D39;&#x4E86;&#x3002;&#x5F53;&#x524D;&#x88AB;&#x4F7F;&#x7528;&#x7684; <code>MetaChunk</code>&#xFF08;&#x5373;&#x5B58;&#x5728;&#x4E8E;&#x6BCF;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x5BF9;&#x5E94;&#x7684; <code>MetaspaceArena</code> &#x4E2D;&#x7684; <code>MetaChunk</code>&#xFF09;&#x4E2D;&#x5269;&#x4F59; <code>1.27 MB</code> &#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x3002;&#x5728; <code>FreeChunkListVector</code> &#x4E2D;&#x6CA1;&#x6709;&#x6D6A;&#x8D39;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x5176;&#x5B9E;&#x4ECE;&#x524D;&#x9762;&#x7684; <code>FreeChunkListVector</code> &#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x5C31;&#x80FD;&#x770B;&#x51FA;&#x6765;&#x3002;</li>
<li><code>FreeBlocks</code> &#x76EE;&#x524D;&#x56DE;&#x6536;&#x4E86; <code>1926</code> &#x5757;&#x5185;&#x5B58;&#xFF0C;&#x4E00;&#x5171; <code>514.41 KB</code>&#x3002;<code>FreeBlocks</code> &#x91CC;&#x9762;&#x6709; <code>1926</code> &#x4E2A; <code>FreeBlock</code>&#xFF0C;&#x4E00;&#x5171; <code>514.41 KB</code>&#x3002;</li>
<li><code>ChunkHeaderPool</code> &#x76EE;&#x524D;&#x6709; <code>10520</code> &#x4E2A; <code>ChunkHeader</code>&#xFF0C;&#x4E00;&#x5171;&#x5360;&#x7528; <code>748.30 KB</code>&#x3002;</li>
</ol>
<p>&#x7136;&#x540E;&#x662F;&#x4E00;&#x4E9B;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Internal statistics:</span><br><span class="line"></span><br><span class="line">num_allocs_failed_limit: 24.</span><br><span class="line">num_arena_births: 2768.</span><br><span class="line">num_arena_deaths: 2.</span><br><span class="line">num_vsnodes_births: 20.</span><br><span class="line">num_vsnodes_deaths: 0.</span><br><span class="line">num_space_committed: 2746.</span><br><span class="line">num_space_uncommitted: 0.</span><br><span class="line">num_chunks_returned_to_freelist: 28.</span><br><span class="line">num_chunks_taken_from_freelist: 10515.</span><br><span class="line">num_chunk_merges: 9.</span><br><span class="line">num_chunk_splits: 6610.</span><br><span class="line">num_chunks_enlarged: 4139.</span><br><span class="line">num_purges: 2.</span><br><span class="line">num_inconsistent_stats: 0.</span><br></pre></td></tr></table></figure>

<p>&#x5305;&#x542B;&#x7684;&#x4FE1;&#x606F;&#x662F;&#xFF1A;</p>
<ol>
<li><code>num_allocs_failed_limit</code>&#xFF1A;&#x5143;&#x7A7A;&#x95F4;&#x666E;&#x901A;&#x5206;&#x6279;&#x5185;&#x5B58;&#x5931;&#x8D25;&#x7684;&#x6B21;&#x6570;&#xFF08;&#x524D;&#x6587;&#x5206;&#x6790;&#x8FC7;&#x8BE6;&#x7EC6;&#x6D41;&#x7A0B;&#xFF09;&#xFF0C;&#x540E;&#x9762;&#x4E5F;&#x6709;&#x5BF9;&#x5E94;&#x7684; JFR &#x4E8B;&#x4EF6;&#x4F1A;&#x5206;&#x6790;&#x3002;</li>
<li><code>num_arena_births</code>&#xFF1A;<code>MetaspaceArena</code> &#x7684;&#x521B;&#x5EFA;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_arena_deaths</code>&#xFF1A;<code>MetaspaceArena</code> &#x7684;&#x9500;&#x6BC1;&#x6B21;&#x6570;&#x3002;&#x53D1;&#x751F;&#x4E8E;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x88AB;&#x56DE;&#x6536;&#x4E4B;&#x540E;&#x3002;</li>
<li><code>num_vsnodes_births</code>&#xFF1A;<code>VirtualSpaceNode</code> &#x7684;&#x521B;&#x5EFA;&#x6B21;&#x6570;&#x3002;&#xFF08;&#x6839;&#x636E;&#x524D;&#x9762;&#x7684; <code>VirtualSpaceList</code> &#x7684;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x662F; 19 + 1 = 20&#xFF09;</li>
<li><code>num_vsnodes_deaths</code>&#xFF1A;<code>VirtualSpaceNode</code> &#x7684;&#x9500;&#x6BC1;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_space_committed</code>&#xFF1A;<code>Commit</code> &#x5185;&#x5B58;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_space_uncommitted</code>&#xFF1A;<code>Uncommit</code> &#x5185;&#x5B58;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_chunks_returned_to_freelist</code>&#xFF1A;<code>MetaChunk</code> &#x88AB;&#x56DE;&#x6536;&#x5230; <code>FreeChunkListVector</code> &#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_chunks_taken_from_freelist</code>&#xFF1A;&#x4ECE; <code>FreeChunkListVector</code> &#x4E2D;&#x83B7;&#x53D6; <code>MetaChunk</code> &#x8FDB;&#x884C;&#x5206;&#x914D;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_chunk_merges</code>&#xFF1A;<code>MetaChunk</code> &#x5408;&#x5E76;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_chunk_splits</code>&#xFF1A;<code>MetaChunk</code> &#x62C6;&#x5206;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_chunks_enlarged</code>&#xFF1A;<code>MetaChunk</code> &#x6269;&#x5BB9;&#x7684;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_purges</code>&#xFF1A;<code>MetaspaceArena</code> &#x7684;&#x6E05;&#x7406;&#x6B21;&#x6570;&#x3002;&#x4E00;&#x822C;&#x7B49;&#x4E8E;&#x9500;&#x6BC1;&#x6B21;&#x6570;&#x3002;</li>
<li><code>num_inconsistent_stats</code>&#xFF1A;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x7EDF;&#x8BA1;&#x6B21;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x4E00;&#x822C;&#x4E0D;&#x7528;&#x5173;&#x5FC3;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x8C03;&#x8BD5;&#x7528;&#x7684;&#x3002;</li>
</ol>
<p>&#x6700;&#x540E;&#x662F;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#x4FE1;&#x606F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;Settings:</span><br><span class="line">MaxMetaspaceSize: unlimited</span><br><span class="line">CompressedClassSpaceSize: 1.00 GB</span><br><span class="line">Initial GC threshold: 40.00 MB</span><br><span class="line">Current GC threshold: 210.12 MB</span><br><span class="line">CDS: on</span><br><span class="line">MetaspaceReclaimPolicy: balanced</span><br><span class="line"> - commit_granule_bytes: 65536.</span><br><span class="line"> - commit_granule_words: 8192.</span><br><span class="line"> - virtual_space_node_default_size: 1048576.</span><br><span class="line"> - enlarge_chunks_in_place: 1.</span><br><span class="line"> - new_chunks_are_fully_committed: 0.</span><br><span class="line"> - uncommit_free_chunks: 1.</span><br><span class="line"> - use_allocation_guard: 0.</span><br><span class="line"> - handle_deallocations: 1.</span><br></pre></td></tr></table></figure>

<ol>
<li><code>MaxMetaspaceSize</code>&#xFF1A;&#x5143;&#x7A7A;&#x95F4;&#x6700;&#x5927;&#x503C;&#x3002;&#x9ED8;&#x8BA4;&#x662F;&#x65E0;&#x9650;&#x5236;&#x7684;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x6CA1;&#x9650;&#x5236;&#x3002;</li>
<li><code>CompressedClassSpaceSize</code>&#xFF1A;&#x538B;&#x7F29;&#x7C7B;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x3002;&#x9ED8;&#x8BA4;&#x662F; 1 GB&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x6CA1;&#x6307;&#x5B9A;&#xFF0C;&#x6240;&#x4EE5;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#x3002;</li>
<li><code>Initial GC threshold</code>&#xFF1A;&#x521D;&#x59CB;&#x7684;&#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x3002;&#x9ED8;&#x8BA4;&#x662F; 40 MB&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x6CA1;&#x6307;&#x5B9A;&#xFF0C;&#x6240;&#x4EE5;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#x3002;</li>
<li><code>Current GC threshold</code>&#xFF1A;&#x5F53;&#x524D;&#x7684;&#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x3002;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x8FC7;&#x8FD9;&#x4E2A;&#x9608;&#x503C;&#x6539;&#x53D8;&#x7684;&#x673A;&#x5236;&#x3002;</li>
<li><code>CDS</code>&#xFF1A;&#x662F;&#x5426;&#x5F00;&#x542F;&#x4E86; CDS&#x3002;&#x9ED8;&#x8BA4;&#x5F00;&#x542F;&#x3002;&#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x4E0D;&#x7528;&#x592A;&#x5173;&#x5FC3;&#xFF0C;&#x4E3B;&#x8981;&#x548C; CDS &#x7279;&#x6027;&#x76F8;&#x5173;&#xFF08;<a href="/external_links/fefe9be1f0e1001e2c10b55619bf252a.html" target="blank" rel="noopener">JEP 310: Application Class-Data Sharing</a> &#x548C; <a href="/external_links/7705aab25c921c5d9a64080ee76e7c22.html" target="blank" rel="noopener">JEP 350: Dynamic CDS Archives</a>&#xFF09;&#xFF0C;&#x5728;&#x4EE5;&#x540E;&#x7684;&#x6587;&#x7AE0;&#x4F1A;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x3002;</li>
<li>&#x5143;&#x7A7A;&#x95F4; <code>MetaspaceReclaimPolicy</code> &#x4E3A; <code>balanced</code></li>
<li>commit &#x7C92;&#x5EA6;&#xFF08;<code>commit_granule_bytes</code>&#xFF09;&#x4E3A; 65536 &#x5B57;&#x8282;&#xFF0C;&#x8F6C;&#x5316;&#x5355;&#x4F4D;&#x4E3A;&#x5B57;&#x4E4B;&#x540E;&#xFF0C;&#x662F; 8192 &#x5B57;&#xFF08;&#x4E00; word &#x4E3A; 8 &#x5B57;&#x8282;&#xFF09;&#x3002;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;<code>virtual_space_node_default_size</code>&#xFF09;&#x4E3A; 1048576 &#x5B57;&#xFF0C;&#x8F6C;&#x5316;&#x5355;&#x4F4D;&#x4E3A;&#x5B57;&#x4E4B;&#x540E;&#xFF0C;&#x662F; 64 MB&#x3002;&#x5F53;&#x524D; MetaChunk &#x4E0D;&#x8DB3;&#x4EE5;&#x5206;&#x914D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x5426;&#x5C1D;&#x8BD5;&#x6269;&#x5BB9;&#x5F53;&#x524D; <code>MetaChunk</code>&#xFF08;<code>enlarge_chunks_in_place</code>&#xFF09;&#x4E3A;&#x662F;&#xFF0C;&#x65B0;&#x5206;&#x914D;&#x7684; <code>MetaChunk</code> &#x662F;&#x5426;&#x4E00;&#x6B21;&#x6027;&#x5168;&#x90E8; commit&#xFF08;<code>new_chunks_are_fully_committed</code>&#xFF09;&#x4E3A;&#x5426;&#xFF0C;&#x662F;&#x5426;&#x5728; <code>MetaChunk</code> &#x91CA;&#x653E;&#x7684;&#x65F6;&#x5019; uncommit&#xFF08;<code>uncommit_free_chunks</code>&#xFF09;&#x4E3A;&#x662F;&#x3002;&#x4EE5;&#x4E0A;&#x914D;&#x7F6E;&#x90FD;&#x5728;&#x524D;&#x6587;&#x5206;&#x6790;&#x8FC7;&#x3002;&#x6700;&#x540E;&#x4E24;&#x4E2A;&#x914D;&#x7F6E;&#x90FD;&#x662F; debug &#x914D;&#x7F6E;&#xFF0C;&#x6B63;&#x5F0F;&#x7248;&#x91CC;&#x9762;&#x90FD;&#x662F;&#x65E0;&#x6CD5;&#x4FEE;&#x6539;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x4E0D;&#x7528;&#x592A;&#x5173;&#x5FC3;&#x8FD9;&#x4E24;&#x4E2A;&#x914D;&#x7F6E;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5E76;&#x4E14; <code>handle_deallocations</code> &#x5DF2;&#x7ECF;&#x5728; Java 18 &#x4E2D;&#x79FB;&#x9664;&#x4E86;&#xFF08;<a href="/external_links/1ae99c65246be92dc51351aa01c012ab.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/commit/157e1d5073e221dab084422389f68eea53974f4c</code></a>&#xFF09;</li>
</ol>
<h3 id="4-6-2-&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173;-JVM-&#x65E5;&#x5FD7;"><a href="#4-6-2-&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173;-JVM-&#x65E5;&#x5FD7;" class="headerlink" title="4.6.2. &#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;"></a>4.6.2. &#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;</h3><p>&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x542F;&#x52A8;&#x53C2;&#x6570; <code>-Xlog:metaspace*=debug::utctime,level,tags</code>&#xFF0C;&#x67E5;&#x770B;&#x5143;&#x7A7A;&#x95F4;&#x76F8;&#x5173; JVM &#x65E5;&#x5FD7;&#x3002;</p>
<p>&#x9996;&#x5148;&#xFF0C;&#x521D;&#x59CB;&#x5316; JVM &#x5143;&#x7A7A;&#x95F4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x8F93;&#x51FA;&#x5143;&#x7A7A;&#x95F4;&#x57FA;&#x672C;&#x53C2;&#x6570;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[2023-04-11T09:07:31.994+0000][info][metaspace] Initialized with strategy: balanced reclaim.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - commit_granule_bytes: 65536.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - commit_granule_words: 8192.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - virtual_space_node_default_size: 1048576.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - enlarge_chunks_in_place: 1.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - new_chunks_are_fully_committed: 0.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - uncommit_free_chunks: 1.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - use_allocation_guard: 0.</span><br><span class="line">[2023-04-11T09:07:31.994+0000][info][metaspace]  - handle_deallocations: 1.</span><br></pre></td></tr></table></figure>

<p>&#x4EE5;&#x4E0A;&#x8FD9;&#x51E0;&#x884C;&#x65E5;&#x5FD7;&#x7684;&#x610F;&#x601D;&#x662F;&#xFF1A;&#x5143;&#x7A7A;&#x95F4; <code>MetaspaceReclaimPolicy</code> &#x4E3A; <code>balanced</code>&#xFF0C;commit &#x7C92;&#x5EA6;&#xFF08;<code>commit_granule_bytes</code>&#xFF09;&#x4E3A; 65536 &#x5B57;&#x8282;&#xFF0C;&#x8F6C;&#x5316;&#x5355;&#x4F4D;&#x4E3A;&#x5B57;&#x4E4B;&#x540E;&#xFF0C;&#x662F; 8192 &#x5B57;&#xFF08;&#x4E00; word &#x4E3A; 8 &#x5B57;&#x8282;&#xFF09;&#x3002;&#x865A;&#x62DF;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8282;&#x70B9;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF08;<code>virtual_space_node_default_size</code>&#xFF09;&#x4E3A; 1048576 &#x5B57;&#xFF0C;&#x8F6C;&#x5316;&#x5355;&#x4F4D;&#x4E3A;&#x5B57;&#x4E4B;&#x540E;&#xFF0C;&#x662F; 64 MB&#x3002;&#x5F53;&#x524D; MetaChunk &#x4E0D;&#x8DB3;&#x4EE5;&#x5206;&#x914D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x5426;&#x5C1D;&#x8BD5;&#x6269;&#x5BB9;&#x5F53;&#x524D; <code>MetaChunk</code>&#xFF08;<code>enlarge_chunks_in_place</code>&#xFF09;&#x4E3A;&#x662F;&#xFF0C;&#x65B0;&#x5206;&#x914D;&#x7684; <code>MetaChunk</code> &#x662F;&#x5426;&#x4E00;&#x6B21;&#x6027;&#x5168;&#x90E8; commit&#xFF08;<code>new_chunks_are_fully_committed</code>&#xFF09;&#x4E3A;&#x5426;&#xFF0C;&#x662F;&#x5426;&#x5728; <code>MetaChunk</code> &#x91CA;&#x653E;&#x7684;&#x65F6;&#x5019; uncommit&#xFF08;<code>uncommit_free_chunks</code>&#xFF09;&#x4E3A;&#x662F;&#x3002;&#x4EE5;&#x4E0A;&#x914D;&#x7F6E;&#x90FD;&#x5728;&#x524D;&#x6587;&#x5206;&#x6790;&#x8FC7;&#x3002;&#x6700;&#x540E;&#x4E24;&#x4E2A;&#x914D;&#x7F6E;&#x90FD;&#x662F; debug &#x914D;&#x7F6E;&#xFF0C;&#x6B63;&#x5F0F;&#x7248;&#x91CC;&#x9762;&#x90FD;&#x662F;&#x65E0;&#x6CD5;&#x4FEE;&#x6539;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x4E0D;&#x7528;&#x592A;&#x5173;&#x5FC3;&#x8FD9;&#x4E24;&#x4E2A;&#x914D;&#x7F6E;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5E76;&#x4E14; <code>handle_deallocations</code> &#x5DF2;&#x7ECF;&#x5728; Java 18 &#x4E2D;&#x79FB;&#x9664;&#x4E86;&#xFF08;<a href="/external_links/1ae99c65246be92dc51351aa01c012ab.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/commit/157e1d5073e221dab084422389f68eea53974f4c</code></a>&#xFF09;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">less&#x590D;&#x5236;&#x4EE3;&#x7801;[2023-04-11T09:07:32.411+0000][info ][gc,metaspace] CDS archive(s) mapped at: [0x0000000800000000-0x0000000800bde000-0x0000000800bde000), size 12443648, SharedBaseAddress: 0x0000000800000000, ArchiveRelocationMode: 0.[2023-04-11T09:07:32.411+0000][info ][gc,metaspace] Compressed class space mapped at: 0x0000000800c00000-0x0000000840c00000, reserved size: 1073741824</span><br><span class="line">[2023-04-11T09:07:32.411+0000][info ][gc,metaspace] Narrow klass base: 0x0000000800000000, Narrow klass shift: 0, Narrow klass range: 0x100000000</span><br><span class="line">[2023-04-11T09:07:32.417+0000][debug][metaspace   ] Arena @0x0000ffff807a1cc0 (non-class sm): : born.</span><br><span class="line">[2023-04-11T09:07:32.417+0000][debug][metaspace   ] Arena @0x0000ffff807a1dd0 (class sm): : born.</span><br><span class="line">[2023-04-11T09:07:32.417+0000][debug][metaspace   ] CLMS @0x0000ffff807a1c80 : born (nonclass arena: 0x0000ffff807a1cc0, class arena: 0x0000ffff807a1dd0.</span><br><span class="line">[2023-04-11T09:07:32.411+0000][debug][metaspace   ] VsListNode @0x0000ffff80784ab0 base 0x0000000800c00000 : born (word_size 134217728).</span><br><span class="line">[2023-04-11T09:07:32.417+0000][debug][metaspace   ] VsListNode @0x0000ffff807a27b0 base 0x0000ffff52800000 : born (word_size 1048576).</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x51E0;&#x884C;&#x65E5;&#x5FD7;&#x7684;&#x610F;&#x601D;&#x662F;&#xFF1A;</p>
<ol>
<li>CDS &#x5143;&#x6570;&#x636E;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#x7684;&#x5730;&#x5740;&#x8303;&#x56F4;&#x662F; <code>[0x0000000800000000-0x0000000800bde000-0x0000000800bde000)</code>&#xFF0C;&#x5927;&#x5C0F;&#x4E3A; 12443648 &#x5B57;&#x8282;&#xFF0C;&#x5171;&#x4EAB;&#x57FA;&#x5730;&#x5740;&#x4E3A; <code>0x0000000800000000</code>&#xFF0C;<code>ArchiveRelocationMode</code> &#x4E3A;&#x5173;&#x95ED;&#x3002;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x6211;&#x4EEC;&#x4E0D;&#x7528;&#x592A;&#x5173;&#x5FC3;&#xFF0C;&#x4E3B;&#x8981;&#x548C; CDS &#x7279;&#x6027;&#x76F8;&#x5173;&#xFF08;<a href="/external_links/fefe9be1f0e1001e2c10b55619bf252a.html" target="blank" rel="noopener">JEP 310: Application Class-Data Sharing</a> &#x548C; <a href="/external_links/7705aab25c921c5d9a64080ee76e7c22.html" target="blank" rel="noopener">JEP 350: Dynamic CDS Archives</a>&#xFF09;&#xFF0C;&#x5728;&#x4EE5;&#x540E;&#x7684;&#x6587;&#x7AE0;&#x4F1A;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x3002;</li>
<li>&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x662F;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#xFF0C;&#x6240;&#x4EE5;&#x538B;&#x7F29;&#x7C7B;&#x7A7A;&#x95F4;&#x662F;&#x5F00;&#x542F;&#x7684;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x538B;&#x7F29;&#x7C7B;&#x7A7A;&#x95F4;&#xFF0C;&#x6620;&#x5C04;&#x5230;&#x5185;&#x5B58;&#x7684;&#x5730;&#x5740;&#x8303;&#x56F4;&#x662F; <code>[0x0000000800c00000-0x0000000840c00000)</code>&#xFF0C;Reserved &#x5185;&#x5B58;&#x5927;&#x5C0F;&#x4E3A; 1073741824 &#x5B57;&#x8282;&#xFF08;1GB&#xFF09;&#xFF0C;&#x9ED8;&#x8BA4;&#x538B;&#x7F29;&#x7C7B;&#x7A7A;&#x95F4;&#x6700;&#x5927;&#x5927;&#x5C0F;&#x5C31;&#x662F; 1GB&#x3002;&#x52A0;&#x8F7D;&#x5230;&#x538B;&#x7F29;&#x7C7B;&#x7A7A;&#x95F4;&#x7684;&#x7C7B;&#x7684;&#x57FA;&#x5730;&#x5740;&#x4E3A; <code>0x0000000800000000</code>&#xFF08;&#xFF09;&#xFF0C;&#x504F;&#x79FB;&#x91CF;&#x4E3A; 0&#xFF0C;&#x8303;&#x56F4;&#x4E3A; <code>0x100000000</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x524D;&#x9762;&#x4E5F;&#x7B80;&#x5355;&#x5206;&#x6790;&#x8FC7;&#x3002;</li>
<li><code>Bootstrap ClassLoader</code> &#x521B;&#x5EFA;&#x4E86;&#x4E24;&#x4E2A; <code>MetaspaceArena</code>&#xFF0C;&#x5206;&#x522B;&#x662F;&#x524D;&#x6587;&#x5206;&#x6790;&#x7684;&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>MetaspaceArena</code> &#x548C;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>MetaspaceArena</code>&#xFF0C;&#x653E;&#x5165;&#x5BF9;&#x5E94;&#x7684; <code>ClassLoadMetaSpace</code> &#x4E2D;&#x3002;&#x4E0D;&#x8981;&#x5077;&#x53D6;&#x4ED6;&#x4EBA;&#x7684;&#x52B3;&#x52A8;&#x6210;&#x679C;&#xFF0C;&#x4E5F;&#x4E0D;&#x8981;&#x6D6A;&#x8D39;&#x81EA;&#x5DF1;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x7CBE;&#x529B;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x505A;&#x4E00;&#x4E2A;&#x6709;&#x826F;&#x77E5;&#x7684;&#x5199;&#x4F5C;&#x8005;&#x3002;</li>
<li>&#x521D;&#x59CB;&#x5316;&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x8FD8;&#x6709;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684; <code>VirtualSpaceList</code>&#xFF0C;&#x5E76;&#x5206;&#x522B;&#x521B;&#x5EFA;&#x5E76;&#x653E;&#x5165;&#x5404;&#x81EA;&#x7684;&#x7B2C;&#x4E00;&#x4E2A; <code>VirtualSpaceNode</code></li>
</ol>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5F00;&#x59CB;&#x52A0;&#x8F7D;&#x7C7B;&#xFF0C;&#x4ECE;&#x5143;&#x7A7A;&#x95F4;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x5206;&#x914D;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ini&#x590D;&#x5236;&#x4EE3;&#x7801;[2023-04-11T09:07:32.411+0000][debug][metaspace] ChkMgr @0x0000ffff807863d0 (class-space): requested chunk: pref_level: lv12, max_level: lv12, min committed size: 0.</span><br><span class="line">[2023-04-11T09:07:32.411+0000][debug][metaspace] VsListNode @0x0000ffff80784ab0 base 0x0000000800c00000 : new root chunk @0x0000ffff807867f0, f, base 0x0000000800c00000, level lv00.</span><br><span class="line">[2023-04-11T09:07:32.411+0000][debug][metaspace] ChkMgr @0x0000ffff807863d0 (class-space): allocated new root chunk.</span><br><span class="line">[2023-04-11T09:07:32.411+0000][debug][metaspace] ChkMgr @0x0000ffff807863d0 (class-space): splitting chunk @0x0000ffff807867f0, f, base 0x0000000800c00000, level lv00 to lv12.</span><br><span class="line">[2023-04-11T09:07:32.411+0000][debug][metaspace] ChkMgr @0x0000ffff807863d0 (class-space): handing out chunk @0x0000ffff807867f0, u, base 0x0000000800c00000, level lv12.</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x51E0;&#x884C;&#x65E5;&#x5FD7;&#x7684;&#x610F;&#x601D;&#x5206;&#x522B;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x52A0;&#x8F7D;&#x7C7B;&#x9700;&#x8981;&#x4ECE;&#x5143;&#x7A7A;&#x95F4;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x662F;&#x7B2C;&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#xFF0C;&#x6240;&#x4EE5;&#x5404;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x90FD;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x7533;&#x8BF7;&#x65B0;&#x7684; <code>MetaChunk</code>&#xFF0C;&#x4F18;&#x5148;&#x8003;&#x8651;&#x7684;&#x4E0E;&#x6700;&#x5927;&#x7684; <code>ChunkLevel</code> &#x90FD;&#x662F; <code>12</code>&#xFF0C;&#x5BF9;&#x5E94; 1KB&#x3002;&#x672C;&#x6B21;&#x7533;&#x8BF7;&#x53D1;&#x751F;&#x5728; <code>ChunkManager @0x0000ffff807863d0</code></li>
<li>&#x7533;&#x8BF7;&#x65B0;&#x7684; <code>RootMetaChunk</code>&#xFF0C;&#x57FA;&#x5740; <code>0x0000000800c00000</code></li>
<li>&#x5C06;&#x65B0;&#x7684; <code>RootMetaChunk</code> &#x6309;&#x7167;&#x4E4B;&#x524D;&#x7684;&#x7B97;&#x6CD5;&#x62C6;&#x5206;&#x5230; <code>ChunkLevel</code> &#x4E3A; <code>12</code>&#xFF0C;&#x7ED3;&#x679C;&#x662F; <code>MetaChunk @0x0000ffff807867f0</code>&#xFF0C;&#x5C06;&#x62C6;&#x51FA;&#x6765;&#x7684;&#x5176;&#x4ED6; <code>MetaChunk</code> &#x653E;&#x5165; <code>ChunkManager @0x0000ffff807863d0</code> &#x7684; <code>FreeListVector</code> &#x4E2D;</li>
</ol>
<h3 id="4-6-3-&#x5143;&#x7A7A;&#x95F4;-JFR-&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;"><a href="#4-6-3-&#x5143;&#x7A7A;&#x95F4;-JFR-&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;" class="headerlink" title="4.6.3. &#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;"></a>4.6.3. &#x5143;&#x7A7A;&#x95F4; JFR &#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;</h3><h4 id="4-6-3-1-jdk-MetaspaceSummary-&#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;"><a href="#4-6-3-1-jdk-MetaspaceSummary-&#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;" class="headerlink" title="4.6.3.1. jdk.MetaspaceSummary &#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;"></a>4.6.3.1. <code>jdk.MetaspaceSummary</code> &#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</h4><p>&#x5143;&#x7A7A;&#x95F4;&#x5B9A;&#x65F6;&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6; <code>jdk.MetaspaceSummary</code>&#xFF0C;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li>&#x4E8B;&#x4EF6;&#x5F00;&#x59CB;&#x65F6;&#x95F4;&#xFF1A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;&#x95F4;</li>
<li>GC Identifier&#xFF1A;&#x5168;&#x5C40; GC &#x7684; id &#x6807;&#x8BC6;</li>
<li>When&#xFF1A;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x7684;&#x65F6;&#x673A;&#xFF0C;&#x5305;&#x62EC; <code>Before GC</code> &#x548C; <code>After GC</code> &#x4E24;&#x79CD;&#xFF0C;&#x5206;&#x522B;&#x662F; GC &#x524D;&#x548C; GC &#x540E;&#x7684;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#xFF0C;&#x53EF;&#x4EE5;&#x6839;&#x636E; GC Identifier &#x5BF9;&#x6BD4; GC &#x524D;&#x540E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x770B;&#x770B; GC &#x4E4B;&#x540E;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x4F7F;&#x7528;&#x60C5;&#x51B5;.plagiarism&#x548C;&#x6D17;&#x7A3F;&#x662F;&#x6076;&#x610F;&#x6284;&#x88AD;&#x4ED6;&#x4EBA;&#x52B3;&#x52A8;&#x6210;&#x679C;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x662F;&#x5BF9;&#x52B3;&#x52A8;&#x4EF7;&#x503C;&#x7684;&#x6F20;&#x89C6;&#x548C;&#x8DF5;&#x8E0F;&#xFF01;</li>
<li>GC Threshold&#xFF1A;GC &#x9608;&#x503C;&#xFF0C;&#x5373;&#x524D;&#x9762;&#x63D0;&#x7684; <code>_capacity_until_GC</code></li>
<li>Class:Reserved&#xFF1A;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; Reserved &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</li>
<li>Class:Committed&#xFF1A;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; Committed &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</li>
<li>Class:Used&#xFF1A;&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x5B9E;&#x9645;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF08;&#x524D;&#x9762;&#x7684;&#x673A;&#x5236;&#x5206;&#x6790;&#x4E2D;&#x6211;&#x4EEC;&#x4F1A;&#x770B;&#x5230;&#xFF0C;Committed &#x7684;&#x7A7A;&#x95F4;&#x4F1A;&#x6BD4;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x7684;&#x5927;&#xFF0C;&#x4E3B;&#x8981;&#x56E0;&#x4E3A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x56DE;&#x6536;&#xFF0C;&#x4EE5;&#x53CA;&#x53EF;&#x80FD; <code>MetaChunk</code> &#x5206;&#x914D;&#x7684;&#x65F6;&#x5019; commit &#x6240;&#x6709;&#x5185;&#x5B58;&#xFF09;</li>
<li>Data:Reserved&#xFF1A;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4; Reserved &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</li>
<li>Data:Committed&#xFF1A;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4; Committed &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</li>
<li>Data:Used&#xFF1A;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x5B9E;&#x9645;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</li>
<li>Total:Reserved&#xFF1A;&#x6574;&#x4E2A;&#x5143;&#x7A7A;&#x95F4; Reserved &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF08;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; + &#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#xFF09;</li>
<li>Total:Committed&#xFF1A;&#x6574;&#x4E2A;&#x5143;&#x7A7A;&#x95F4; Committed &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF08;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; + &#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#xFF09;</li>
<li>Total:Used&#xFF1A;&#x6574;&#x4E2A;&#x5143;&#x7A7A;&#x95F4;&#x5B9E;&#x9645;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF08;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x7C7B;&#x5143;&#x7A7A;&#x95F4; + &#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#xFF09;</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/9c77546d7f64a1756b674ad049bd1a5b18322a7e1def19ba393dba8345b353ba" alt></p>
<h4 id="4-6-3-2-jdk-MetaspaceAllocationFailure-&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;"><a href="#4-6-3-2-jdk-MetaspaceAllocationFailure-&#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;" class="headerlink" title="4.6.3.2. jdk.MetaspaceAllocationFailure &#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;"></a>4.6.3.2. <code>jdk.MetaspaceAllocationFailure</code> &#x5143;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5931;&#x8D25;&#x4E8B;&#x4EF6;</h4><p>&#x524D;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x5982;&#x679C;&#x666E;&#x901A;&#x5206;&#x914D;&#x5931;&#x8D25;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x89E6;&#x53D1; <code>jdk.MetaspaceAllocationFailure</code> &#x8FD9;&#x4E2A; JFR &#x4E8B;&#x4EF6;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x76D1;&#x63A7;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x53BB;&#x8C03;&#x6574;&#x5143;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x51CF;&#x5C11;&#x7531;&#x4E8E;&#x5143;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#x89E6;&#x53D1;&#x7684; GC&#xFF0C;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li>&#x4E8B;&#x4EF6;&#x5F00;&#x59CB;&#x65F6;&#x95F4;&#xFF1A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;&#x95F4;</li>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#xFF1A;&#x89E6;&#x53D1; OOM &#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</li>
<li>Hidden Class Loader&#xFF1A;&#x662F;&#x5426;&#x662F;&#x9690;&#x85CF;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</li>
<li>Metadata Type&#xFF1A;&#x5143;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF0C;&#x5206;&#x4E3A;&#x5C5E;&#x4E8E;&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x4EE5;&#x53CA;&#x5C5E;&#x4E8E;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;<code>Class</code> &#x548C; <code>Metadata</code></li>
<li>Metaspace Object Type&#xFF1A;&#x5143;&#x7A7A;&#x95F4;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#xFF0C;&#x5305;&#x62EC; <code>Class</code>&#x3001;<code>ConstantPool</code>&#x3001;<code>Symbol</code>&#x3001;<code>Method</code>&#x3001;<code>Klass</code>&#x3001;<code>Module</code>&#x3001;<code>Package</code>&#x3001;<code>Other</code></li>
<li>Size&#xFF1A;&#x672C;&#x6B21;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;</li>
</ul>
<p>&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x4E5F;&#x4F1A;&#x91C7;&#x96C6;&#x5806;&#x6808;&#x4FE1;&#x606F;&#xFF0C;&#x7528;&#x6765;&#x5B9A;&#x4F4D;&#x5206;&#x914D;&#x5931;&#x8D25;&#x7684;&#x6E90;&#x5934;&#x662F;&#x54EA;&#x4E9B;&#x7C7B;&#x7684;&#x52A0;&#x8F7D;&#x5BFC;&#x81F4;&#x7684;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/25c73a85d320cfd52c39984b165bfb6364aa6a0b545cfc4977ae191754a9d496" alt></p>
<h4 id="4-6-3-3-jdk-MetaspaceOOM-&#x5143;&#x7A7A;&#x95F4;-OOM-&#x4E8B;&#x4EF6;"><a href="#4-6-3-3-jdk-MetaspaceOOM-&#x5143;&#x7A7A;&#x95F4;-OOM-&#x4E8B;&#x4EF6;" class="headerlink" title="4.6.3.3. jdk.MetaspaceOOM &#x5143;&#x7A7A;&#x95F4; OOM &#x4E8B;&#x4EF6;"></a>4.6.3.3. <code>jdk.MetaspaceOOM</code> &#x5143;&#x7A7A;&#x95F4; OOM &#x4E8B;&#x4EF6;</h4><p>&#x524D;&#x9762;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x5F53;&#x5143;&#x7A7A;&#x95F4; OOM &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x5C5E;&#x6027;&#xFF08;&#x548C; <code>jdk.MetaspaceAllocationFailure</code> &#x4E8B;&#x4EF6;&#x4E00;&#x6837;&#xFF09;&#xFF1A;</p>
<ul>
<li>&#x4E8B;&#x4EF6;&#x5F00;&#x59CB;&#x65F6;&#x95F4;&#xFF1A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;&#x95F4;</li>
<li>&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#xFF1A;&#x89E6;&#x53D1; OOM &#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</li>
<li>Hidden Class Loader&#xFF1A;&#x662F;&#x5426;&#x662F;&#x9690;&#x85CF;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</li>
<li>Metadata Type&#xFF1A;&#x5143;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF0C;&#x5206;&#x4E3A;&#x5C5E;&#x4E8E;&#x7C7B;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x4EE5;&#x53CA;&#x5C5E;&#x4E8E;&#x6570;&#x636E;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;<code>Class</code> &#x548C; <code>Metadata</code></li>
<li>Metaspace Object Type&#xFF1A;&#x5143;&#x7A7A;&#x95F4;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#xFF0C;&#x5305;&#x62EC; <code>Class</code>&#x3001;<code>ConstantPool</code>&#x3001;<code>Symbol</code>&#x3001;<code>Method</code>&#x3001;<code>Klass</code>&#x3001;<code>Module</code>&#x3001;<code>Package</code>&#x3001;<code>Other</code></li>
<li>Size&#xFF1A;&#x672C;&#x6B21;&#x5206;&#x914D;&#x7684;&#x5927;&#x5C0F;</li>
</ul>
<p>&#x4E0E; <code>jdk.MetaspaceAllocationFailure</code> &#x4E8B;&#x4EF6;&#x4E00;&#x6837;&#xFF0C;&#x4E5F;&#x4F1A;&#x91C7;&#x96C6;&#x5806;&#x6808;&#x4FE1;&#x606F;&#xFF0C;&#x7528;&#x6765;&#x5B9A;&#x4F4D; OOM &#x7684;&#x539F;&#x56E0;&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/c4c6d8d776260eb18285919fbb5dc1d02c0617903478dbe3e0682e3e9f25a6a7" alt></p>
<h4 id="4-6-3-4-jdk-MetaspaceGCThreshold-&#x5143;&#x7A7A;&#x95F4;-GC-&#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;"><a href="#4-6-3-4-jdk-MetaspaceGCThreshold-&#x5143;&#x7A7A;&#x95F4;-GC-&#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;" class="headerlink" title="4.6.3.4. jdk.MetaspaceGCThreshold &#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;"></a>4.6.3.4. <code>jdk.MetaspaceGCThreshold</code> &#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;</h4><p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x8BF4;&#x8FC7;&#xFF0C;&#x5143;&#x7A7A;&#x95F4;&#x7684; GC &#x9608;&#x503C;&#xFF08;<code>_capacity_until_GC</code>&#xFF09;&#x662F;&#x52A8;&#x6001;&#x8C03;&#x6574;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5C31;&#x662F;&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x5143;&#x7A7A;&#x95F4; GC &#x9608;&#x503C;&#x53D8;&#x5316;&#x7684;&#x3002;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li>&#x4E8B;&#x4EF6;&#x5F00;&#x59CB;&#x65F6;&#x95F4;&#xFF1A;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;&#x95F4;</li>
<li>New Value&#xFF1A;&#x65B0;&#x7684; GC &#x9608;&#x503C;</li>
<li>Old Value&#xFF1A;&#x65E7;&#x7684; GC &#x9608;&#x503C;</li>
<li>Updater&#xFF1A;&#x54EA;&#x4E2A;&#x673A;&#x5236;&#x89E6;&#x53D1;&#x7684; GC &#x9608;&#x503C;&#x4FEE;&#x6539;&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BA8;&#x8BBA;&#x8FC7; <code>_capacity_until_GC</code> &#x6709;&#x4E24;&#x4E2A;&#x573A;&#x666F;&#x4F1A;&#x4FEE;&#x6539;&#xFF1A;<ul>
<li>&#x5206;&#x914D;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x8FBE;&#x5230; GC &#x9608;&#x503C;&#xFF0C;&#x89E6;&#x53D1; GC&#xFF0C;&#x4F46;&#x662F;&#x5904;&#x4E8E; GCLocker &#x5904;&#x4E8E;&#x9501;&#x5B9A;&#x7981;&#x6B62; GC&#xFF0C;&#x5C31;&#x5C1D;&#x8BD5;&#x589E;&#x5927; <code>_capacity_until_GC</code> &#x8FDB;&#x884C;&#x5206;&#x914D;&#x3002;&#x5BF9;&#x5E94;&#x7684; <code>Updater</code> &#x662F; <code>expand_and_allocate</code></li>
<li>&#x6BCF;&#x6B21; GC &#x4E4B;&#x540E;&#xFF0C;&#x89E6;&#x53D1;&#x91CD;&#x65B0;&#x8BA1;&#x7B97; <code>_capacity_until_GC</code>&#xFF0C;&#x5982;&#x679C;&#x6709;&#x66F4;&#x65B0;&#xFF0C;&#x5C31;&#x4F1A;&#x751F;&#x6210;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x5BF9;&#x5E94;&#x7684; <code>Updater</code> &#x662F; <code>compute_new_size</code></li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/d59dc7f79ac8dea8e0a665061160bca4cb9ffd06f091ecb92df854861fd2f866" alt></p>
<h4 id="4-6-3-5-jdk-MetaspaceChunkFreeListSummary-&#x5143;&#x7A7A;&#x95F4;-Chunk-FreeList-&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;"><a href="#4-6-3-5-jdk-MetaspaceChunkFreeListSummary-&#x5143;&#x7A7A;&#x95F4;-Chunk-FreeList-&#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;" class="headerlink" title="4.6.3.5. jdk.MetaspaceChunkFreeListSummary &#x5143;&#x7A7A;&#x95F4; Chunk FreeList &#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;"></a>4.6.3.5. <code>jdk.MetaspaceChunkFreeListSummary</code> &#x5143;&#x7A7A;&#x95F4; Chunk FreeList &#x7EDF;&#x8BA1;&#x4E8B;&#x4EF6;</h4><p>&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5728; Java 16 &#x5F15;&#x5165; JEP 387: Elastic Metaspace &#x5F39;&#x6027;&#x5143;&#x7A7A;&#x95F4;&#x7684;&#x8BBE;&#x8BA1;&#x4E4B;&#x540E;&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x5C31;&#x90FD;&#x662F; 0 &#x4E86;&#xFF0C;&#x8FD8;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#xFF0C;&#x53C2;&#x8003;&#xFF1A;<a href="/external_links/c97543fe5df94044bad94cebbf1b7f03.html" target="blank" rel="noopener"><code>https://bugs.openjdk.org/browse/JDK-8251342</code></a>&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5148;&#x4E0D;&#x7528;&#x5173;&#x5FC3;&#x3002;&#x53C2;&#x8003;&#x6E90;&#x7801;&#xFF1A;<a href="/external_links/b01aba2b0f439453416021e7ad923df8.html" target="blank" rel="noopener"><code>https://github.com/openjdk/jdk/blob/jdk-21%2B17/src/hotspot/share/memory/metaspaceUtils.hpp</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scss&#x590D;&#x5236;&#x4EE3;&#x7801;// (See JDK-8251342). Implement or Consolidate.</span><br><span class="line">static MetaspaceChunkFreeListSummary chunk_free_list_summary(Metaspace::MetadataType mdtype) {</span><br><span class="line">    return MetaspaceChunkFreeListSummary(0,0,0,0,0,0,0,0);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p2/raw/master/img/047d0c2740f989d133cf94e643fe1529b54ec6ba75a9cd8bd7eae34c2fbe1225" alt></p>
<blockquote>
<p><strong>&#x5FAE;&#x4FE1;&#x641C;&#x7D22;&#x201C;&#x5E72;&#x8D27;&#x6EE1;&#x6EE1;&#x5F20;&#x54C8;&#x5E0C;&#x201D;&#x5173;&#x6CE8;&#x516C;&#x4F17;&#x53F7;&#xFF0C;&#x52A0;&#x4F5C;&#x8005;&#x5FAE;&#x4FE1;&#xFF0C;&#x6BCF;&#x65E5;&#x4E00;&#x5237;&#xFF0C;&#x8F7B;&#x677E;&#x63D0;&#x5347;&#x6280;&#x672F;&#xFF0C;&#x65A9;&#x83B7;&#x5404;&#x79CD;offer</strong><br>&#x6211;&#x4F1A;&#x7ECF;&#x5E38;&#x53D1;&#x4E00;&#x4E9B;&#x5F88;&#x597D;&#x7684;&#x5404;&#x79CD;&#x6846;&#x67B6;&#x7684;&#x5B98;&#x65B9;&#x793E;&#x533A;&#x7684;&#x65B0;&#x95FB;&#x89C6;&#x9891;&#x8D44;&#x6599;&#x5E76;&#x52A0;&#x4E0A;&#x4E2A;&#x4EBA;&#x7FFB;&#x8BD1;&#x5B57;&#x5E55;&#x5230;&#x5982;&#x4E0B;&#x5730;&#x5740;&#xFF08;&#x4E5F;&#x5305;&#x62EC;&#x4E0A;&#x9762;&#x7684;&#x516C;&#x4F17;&#x53F7;&#xFF09;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF1A;</p>
<ul>
<li>&#x77E5;&#x4E4E;&#xFF1A;<a href="/external_links/371449001e02a5502b7dec21cae420e8.html" target="blank" rel="noopener">www.zhihu.com/people/zhxh&#x2026;</a></li>
<li>B &#x7AD9;&#xFF1A;<a href="/external_links/4cb1b1096c7f68ac89bbd30f61437b90.html" target="blank" rel="noopener">space.bilibili.com/31359187</a></li>
</ul>
</blockquote>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/94348181589d5c5d6c4d705d208906de.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../98/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../98/">98</a><span class="page-number current">99</span><a class="page-number" href="../100/">100</a><span class="space">&hellip;</span><a class="page-number" href="../298/">298</a><a class="extend next" rel="next" href="../100/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">2975</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1162</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="../../atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
