<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Python,">





  <link rel="alternate" href="atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta name="description" content="Python Decorators From the Ground UpDecorators are your friends. Despite this they tend to be seen as a rather obscure feature and are often left horribly neglected. In this post I will show you that">
<meta name="keywords" content="Python">
<meta property="og:type" content="article">
<meta property="og:title" content="从头开始学习Python装饰器 Python Decorat">
<meta property="og:url" content="https://dev.newban.cn/6844903520252985352.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:description" content="Python Decorators From the Ground UpDecorators are your friends. Despite this they tend to be seen as a rather obscure feature and are often left horribly neglected. In this post I will show you that">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2024-04-28T04:59:06.055Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从头开始学习Python装饰器 Python Decorat">
<meta name="twitter:description" content="Python Decorators From the Ground UpDecorators are your friends. Despite this they tend to be seen as a rather obscure feature and are often left horribly neglected. In this post I will show you that">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/6844903520252985352.html">





  <title>从头开始学习Python装饰器 Python Decorat | 开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从头开始学习Python装饰器 Python Decorat</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T16:13:54+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Python-Decorators-From-the-Ground-Up"><a href="#Python-Decorators-From-the-Ground-Up" class="headerlink" title="Python Decorators From the Ground Up"></a>Python Decorators From the Ground Up</h1><p>Decorators are your friends. Despite this they tend to be seen as a rather obscure feature and are often left horribly neglected. In this post I will show you that decorators don&#x2019;t need to be complicated and that, when used correctly, can become<br> your MVP in many situations.</p>
<p>I won&#x2019;t just tell you what decorators are, but rather build a bottom up journey where we assemble a decorator from scratch, step by step. I&#x2019;ll visit the different ideas that make up the decorator idiom and the specific issues they aim to solve.<br> Hopefully by the end of your reading you will be able to identify the scenarios where decorators excel and the reason they became part of the python language.</p>
<p>Let&#x2019;s begin with a very realistic example:</p>
<h1 id="The-Algorithm-of-Love"><a href="#The-Algorithm-of-Love" class="headerlink" title="The Algorithm of Love"></a>The Algorithm of Love</h1><p>Imagine you are working on a dating platform that lets users find hot singles in their area. Your matching algorithm, based on some vague search criteria, is able to retrieve perfect matches from the user registry:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def hottie_lookup(search_criteria):</span><br><span class="line">    print(&apos;Querying hotties database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    #Simulate patended algorithm to find hot singles in your area</span><br><span class="line">    time.sleep(2) </span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>In no time your platform becomes very popular. Even though people really seem love it, you have heard some complaints about long response times. You decide to measure the execution time of your love algorithm:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def hottie_lookup(search_criteria):</span><br><span class="line"></span><br><span class="line">    current_time = time.time()</span><br><span class="line"></span><br><span class="line">    print(&apos;Querying hotties database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    time.sleep(2) </span><br><span class="line">    #Simulate patended algorithm to find hot singles in your area</span><br><span class="line"></span><br><span class="line">    print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line"></span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>After the great success you decide that it would be useful to gather some usage statistics: What are the most popular searching criteria (besides hotness off course)? What are the most popular singles in town?</p>
<p>For this you decide to log every received request and its corresponding response:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def hottie_lookup(search_criteria):</span><br><span class="line"></span><br><span class="line">    print(&quot;Request was made:&quot;, search_criteria)</span><br><span class="line">    current_time = time.time()</span><br><span class="line"></span><br><span class="line">    print(&apos;Querying hotties database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    #Simulate patented algorithm to find hot singles in your area</span><br><span class="line">    time.sleep(2) </span><br><span class="line"></span><br><span class="line">    print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">    print(&quot;Matching entries found:&quot;, search_results)</span><br><span class="line"></span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>Your matching algorithm works so well that the majority of your users found their true love, and, as your analytics show, a clear decay in traffic is evident. You meditate on this and discover that your algorithm could be generalized to solve<br> other kinds of matching problems, such as finding the more skilful gardeners in town:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def gardener_lookup(search_criteria):</span><br><span class="line"></span><br><span class="line">    print(&quot;Request was made&quot;, search_criteria)</span><br><span class="line">    current_time = time.time()</span><br><span class="line">    </span><br><span class="line">    print(&apos;Querying gardeners database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    #Simulate patended algorithm to find skillful gardeners in town</span><br><span class="line">    time.sleep(2) </span><br><span class="line"></span><br><span class="line">    print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">    print(&quot;Matching entries found:&quot;, search_results)</span><br><span class="line"></span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>Perfect! You can now use your magical matching solution for the sake of perfectly mowed lawns and less awkward family gatherings. Now, is this the best way of solving this? not really, there are a few issues with this design:</p>
<h3 id="Code-Duplication"><a href="#Code-Duplication" class="headerlink" title="Code Duplication"></a>Code Duplication</h3><p>It&#x2019;s clear that in our services, hotties and gardeners search, functionality has to be replicated: both need to be timed and logged. This is bad, since every time we need to add a new service the same stuff needs to be reimplemented.</p>
<p>Image that we receive the requirement to authenticate users before each database lookup, then we would then need to implement user authenticaion in every single service. What if we had a few dozen services? Embarrassing.</p>
<h3 id="Single-Responsibility-Principle"><a href="#Single-Responsibility-Principle" class="headerlink" title="Single Responsibility Principle"></a>Single Responsibility Principle</h3><p>In our functions, which are supposed to run awesome ranking algorithms to retrieve perfect matches from the database, we are suddenly measuring time and persisting analytics. Our functions are polluted, have several reasons to change and break<br> the single responsibility principle. Shame.</p>
<h1 id="Wrapper-Functions"><a href="#Wrapper-Functions" class="headerlink" title="Wrapper Functions"></a>Wrapper Functions</h1><p>Clearly polluting our lookup functions with extra functionality isn&#x2019;t the best idea. But, how can we time our functions while leaving them unchanged? Maybe we can <em>wrap</em> them inside another function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def hottie_lookup_timed(search_criteria):</span><br><span class="line">    current_time = time.time()</span><br><span class="line">    # Call original unchanged hottie_lookup</span><br><span class="line">    search_results = hottie_lookup(search_criteria) </span><br><span class="line">    print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>Is this better? well, kinda, at least <code>hottie_lookup()</code> doesn&#x2019;t need to worry about measuring execution time anymore. But what about request and response logging? we could write a wrapper function of our wrapper function dawg:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;def hotties_lookup_logged(search_criteria):</span><br><span class="line">    print(&quot;Request was made:&quot;, search_criteria)</span><br><span class="line">    search_results = hottie_lookup_timed(search_criteria) </span><br><span class="line">    print(&quot;Matching entries found:&quot;, search_results)</span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<p>Awesome! Now <code>hottie_lookup()</code> is back to its original implementation and free of extra work.</p>
<p>All we need to do now is search/replace all calls to <code>hottie_lookup()</code> with <code>hotties_lookup_logged()</code>, so that every time the service is executed the wrapper function is called instead. Sure, but if we want to add an extra<br> wrapper? Then we would need to rename all function calls again :/. Sure we can do better.</p>
<h1 id="Functions-Are-First-Class-Citizens"><a href="#Functions-Are-First-Class-Citizens" class="headerlink" title="Functions Are First Class Citizens"></a>Functions Are First Class Citizens</h1><p>By enclosing our lookup functions inside a wrapper, we were able to perform timing and logging by leaving the original implementations unchanged. This is a step in the right direction, but there are still some issues to solve.</p>
<p>First off all, we completely forgot about the gardener search, that function needs to be decorated as well! Sure we can repeat the same trick, but we would end up having two functions, <code>gardener_lookup_timed()</code> and a <code>gardener_lookup_logged()</code> that would be practically the same their hottie search versions. What if we want to log the time in milliseconds instead of seconds? We would need to change two implementations.</p>
<p>What do we do in this cases? We generalize! Python is a very democratic language, where functions have the same rights as any other value, so why not just write a single timer wrapper function that receives the function to be timed as parameter?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def timer(func):</span><br><span class="line">    def inner_func(search_criteria):</span><br><span class="line">        current_time = time.time()</span><br><span class="line">        result = func(search_criteria)</span><br><span class="line">        print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">        return result</span><br><span class="line">    return inner_func</span><br></pre></td></tr></table></figure>

<p>Wow wow slow down, what happened here? Yes, it looks complex, but it really isn&#x2019;t that complicated once we have dissected it.</p>
<p>Decorators take advantage of how functions are implemented in python. Have you ever heard of classes and objects? well in python functions are just that, objects. This means that functions can be passed as arguments to another functions and returned<br> as any other value. Once you have understood this the snippet above becomes much more digestible.</p>
<p>A decorator is a function that receives a function and returns a function. Think about it this way: we are <strong>decorating</strong>, we are supposed to receive something, add some extra stuff to it and return the same thing we received. But,<br> what exactly is returned? The wrapper function from last section! All decorators do is create a wrapper function and return it.</p>
<p>This new &#x201C;trick&#x201D; is so awesome that we can write our <code>hottie_lookup_timed()</code> and <code>gardener_lookup_timed()</code> like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;hottie_lookup_timed = timer(hottie_lookup)</span><br><span class="line">gardener_lookup_timed = timer(gardener_lookup)</span><br></pre></td></tr></table></figure>

<p>Do you see it? our timer decorator takes our original function, adds a timer around it, and returns it. And most importantly: timing functionality exists in a single place and can be used to time <em>any</em> function we want. Do we have to log<br> time in milliseconds? Sure, a single modification to our timer decorator will do.</p>
<p>Let&#x2019;s make a test with our new <code>hotties_lookup_timed()</code> function with some very popular search criteria:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; hotties_lookup_timed([&apos;latino&apos;, &apos;computer scientist&apos;])</span><br><span class="line">Querying hotties database...</span><br><span class="line">Request took 2.0 seconds</span><br></pre></td></tr></table></figure>

<p>Perfect! Our function is timed and the decorator seems to be working.</p>
<p>Naturally the same technique can be applied to construct a single logging decorator.</p>
<h2 id="Generalizing-with-args-and-kwargs"><a href="#Generalizing-with-args-and-kwargs" class="headerlink" title="Generalizing with \args* and \*kwargs*"></a>Generalizing with <em>\</em>args* and <em>\</em>*kwargs*</h2><p>The timer decorator we wrote works, but only if we are decorating a function that receives a single argument. What if in the future we need to decorate a function that receives no arguments? That wouldn&#x2019;t work with the current implementation,<br> as our inner function declares one argument.</p>
<p>The problem here is that we are making assumptions on the function to be decorated.</p>
<p>For this reason, in case your decorators don&#x2019;t need to know anything about the decorated function, it is standard practice to define our inner function with variable arguments and propagate them to the input function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line">def timer(func):</span><br><span class="line">    def inner_func(*args, **kwargs):</span><br><span class="line">        current_time = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">        return result</span><br><span class="line">    return inner_func</span><br></pre></td></tr></table></figure>

<p>Don&#x2019;t let python&#x2019;s <em>\</em>args* and <em>\</em>*kwargs* scare you away. All we did was define a function that can receive an arbitrary number of arguments, both keyworded and non-keyworded. For example, you can do this: <code>inner_func(8)</code>,<br> or this: <code>inner_func(city=&apos;Munich&apos;, state=&apos;Bavaria&apos;)</code>. You then propagate all your arguments to <code>func</code>, that&#x2019;s it.</p>
<p>By using <em>\</em>args* and <em>\</em>*kwargs*, our decorators can decorate arbitrary functions as we no longer need to know beforehand the arguments they declare.</p>
<h1 id="Leaving-Callers-Unchanged"><a href="#Leaving-Callers-Unchanged" class="headerlink" title="Leaving Callers Unchanged"></a>Leaving Callers Unchanged</h1><p>We were able to decorate our <code>hotties_lookup()</code> and <code>gardeners_lookup()</code> with a shared timer decorator. But are we completely happy? not really, we still have the problem mentioned before: callers of our functions need to<br> be changed, as <code>hotties_lookup_timed()</code> needs to be called instead of <code>hotties_search()</code>. But remember, functions are objects, we can just assign them to other variables, so why not just reassign the original implementations?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;hotties_lookup = timer(hotties_lookup)</span><br><span class="line">gardeners_lookup = timer(gardeners_lookup)</span><br></pre></td></tr></table></figure>

<p>We just <em>replaced</em> our original <code>hotties_lookup()</code> with its decorated version. This means that callers no longer need to be changed, since <code>hotties_lookup()</code> now points to the timed (a.k.a decorated) version:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; hotties_search([&apos;latino&apos;, &apos;computer scientist&apos;])</span><br><span class="line">Querying hotties database...</span><br><span class="line">Request took 2.0 seconds</span><br></pre></td></tr></table></figure>

<p>This idiom is so common that it has its own built-in language syntax.</p>
<p>The expression:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;hotties_lookup = timer(hotties_lookup)</span><br></pre></td></tr></table></figure>

<p>is equivalent to:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;@timer</span><br><span class="line">def hotties_lookup(search_criteria):</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<h1 id="Putting-It-All-Together"><a href="#Putting-It-All-Together" class="headerlink" title="Putting It All Together"></a>Putting It All Together</h1><p>Now we are happy. Here the entire implementation:</p>
<p>First we write the decorators we need:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;import time</span><br><span class="line"></span><br><span class="line">def logger(func):</span><br><span class="line">    def inner_func(search_criteria):</span><br><span class="line">        print(&quot;Request has made with criteria:&quot;, search_criteria)</span><br><span class="line">        result = func(search_criteria)</span><br><span class="line">        print(&quot;Matching entries found:&quot;, result)</span><br><span class="line">        return result</span><br><span class="line">    return inner_func</span><br><span class="line"></span><br><span class="line">def timer(func):</span><br><span class="line">    def inner_func(search_criteria):</span><br><span class="line">        current_time = time.time()</span><br><span class="line">        result = func(search_criteria)</span><br><span class="line">        print(&quot;Request took {:.1f}s&quot;.format(time.time()-current_time))</span><br><span class="line">        return result</span><br><span class="line">    return inner_func</span><br></pre></td></tr></table></figure>

<p>Then we decorate our functions:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;@logger</span><br><span class="line">@timer</span><br><span class="line">def hottie_lookup(search_criteria):</span><br><span class="line">    print(&apos;Querying hotties database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    #Simulate patended algorithm to find hottes singles in your area</span><br><span class="line">    time.sleep(2) </span><br><span class="line">    return search_results</span><br><span class="line"></span><br><span class="line">@logger</span><br><span class="line">@timer</span><br><span class="line">def gardener_lookup(search_criteria):</span><br><span class="line">    print(&apos;Querying gardeners database...&apos;)</span><br><span class="line">    search_results = []</span><br><span class="line">    #Simulate patended algorithm to find skilful gardeners in town</span><br><span class="line">    time.sleep(2) </span><br><span class="line">    return search_results</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&gt;&gt;&gt; hotties_lookup([&apos;latino&apos;, &apos;computer scientist&apos;])</span><br><span class="line">Request has made with criteria: [&apos;latino&apos;, &apos;computer scientist&apos;]</span><br><span class="line">Querying hotties database...</span><br><span class="line">Request took 2.0s</span><br><span class="line">Matching entries found: []</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; gardeners_lookup([&apos;bush sculpture&apos;, &apos;semilegal botany&apos;])</span><br><span class="line">Request has made with criteria: [&apos;bush sculpture&apos;, &apos;semilegal botany&apos;]</span><br><span class="line">Querying gardeners database...</span><br><span class="line">Request took 2.0s</span><br><span class="line">Matching entries found: []</span><br></pre></td></tr></table></figure>

<p>Voila. That&#x2019;s it. We have covered the basics of python decorators and hopefully you are now convinced of how simple and useful they are. This is not the end of it, though, there is more stuff you can do with decorators. Most importantly, you can<br> add extra generalization to your decorators by passing arguments to them:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;@time(&apos;seconds&apos;)</span><br><span class="line">def hottie_lookup(search_criteria):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">@time(&apos;milliseconds&apos;)</span><br><span class="line">def gardener_lookup(search_criteria):</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<p>Here, for instance, we wrote a generic timer decorator that receives the time unit to measure as argument. This lets us time the hottie lookup in seconds and the gardener lookup in milliseconds, all by using a single decorator. Decorators with<br> arguments are out of the scope of this post, but if you are curious and have liked this post, leave me a comment and maybe I&#x2019;ll write a follow up post.</p>
<h1 id="Wrapping-Up"><a href="#Wrapping-Up" class="headerlink" title="Wrapping Up"></a>Wrapping Up</h1><ul>
<li><p>Decorators receive a function and returned a wrapped version of it</p>
</li>
<li><p>Decorated functions or methods don&#x2019;t change: decorators can only append or prepend functionality</p>
</li>
<li><p>Decoration is transparent to callers: original function calls are replaced by decorated versions</p>
</li>
<li><p>Decorators avoid code duplication: decorating functionality resides in a single place</p>
</li>
<li><p>Decorators are reusable: decorate several functions with single decorator</p>
</li>
<li><p>Decorators are flexible: combine decorators as you wish, you can even decorate decorators!</p>
</li>
<li><p>Use <em>\</em>args* and <em>\</em>*kwargs* to write generic decorators that can decorate arbitrary functions</p>
<p>Written on November 29, 2017 </p>
</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/15f4a3b74a8e096ffb558da0c0f5ab04.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="tags/Python/" rel="tag"># Python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="6844903520211042312.html" rel="next" title="JAVA安全编码与代码审计">
                <i class="fa fa-chevron-left"></i> JAVA安全编码与代码审计
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="6844903520324288526.html" rel="prev" title="线上问题解决及shell脚本实现自动保留最近n次备份记录 项">
                线上问题解决及shell脚本实现自动保留最近n次备份记录 项 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


    <!-- 有瓣音频文章内嵌广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6145016388"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    <div class="post-spread">
      
    </div>
  </div>
  <!-- 有瓣音频信息流广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-6t+ed+2i-1n-4w" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6455528644"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">3990</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1304</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python-Decorators-From-the-Ground-Up"><span class="nav-number">1.</span> <span class="nav-text">Python Decorators From the Ground Up</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Algorithm-of-Love"><span class="nav-number">2.</span> <span class="nav-text">The Algorithm of Love</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-Duplication"><span class="nav-number">2.0.1.</span> <span class="nav-text">Code Duplication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Single-Responsibility-Principle"><span class="nav-number">2.0.2.</span> <span class="nav-text">Single Responsibility Principle</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#Wrapper-Functions"><span class="nav-number">3.</span> <span class="nav-text">Wrapper Functions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Functions-Are-First-Class-Citizens"><span class="nav-number">4.</span> <span class="nav-text">Functions Are First Class Citizens</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Generalizing-with-args-and-kwargs"><span class="nav-number">4.1.</span> <span class="nav-text">Generalizing with \args* and \*kwargs*</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Leaving-Callers-Unchanged"><span class="nav-number">5.</span> <span class="nav-text">Leaving Callers Unchanged</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Putting-It-All-Together"><span class="nav-number">6.</span> <span class="nav-text">Putting It All Together</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Wrapping-Up"><span class="nav-number">7.</span> <span class="nav-text">Wrapping Up</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
