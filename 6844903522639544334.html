<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Node.js,">





  <link rel="alternate" href="atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta name="description" content="&amp;#x672C;&amp;#x6587;&amp;#x9996;&amp;#x53D1;&amp;#x4E8E;&amp;#x77E5;&amp;#x4E4E;&amp;#x4E13;&amp;#x680F;&amp;#x8682;&amp;#x8681;&amp;#x91D1;&amp;#x670D;&amp;#x4F53;&amp;#x9A8C;&amp;#x79D1;&amp;#x6280;&amp;#x3002;  &amp;#x9996;&amp;#x5148;&amp;#x58F0;&amp;#x660E;&amp;#xFF0C;&amp;#x6211;&amp;#x57">
<meta name="keywords" content="Node.js">
<meta property="og:type" content="article">
<meta property="og:title" content="Nodejs 中遇到含空格 URL 的神奇“Bug”——小">
<meta property="og:url" content="https://dev.newban.cn/6844903522639544334.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:description" content="&amp;#x672C;&amp;#x6587;&amp;#x9996;&amp;#x53D1;&amp;#x4E8E;&amp;#x77E5;&amp;#x4E4E;&amp;#x4E13;&amp;#x680F;&amp;#x8682;&amp;#x8681;&amp;#x91D1;&amp;#x670D;&amp;#x4F53;&amp;#x9A8C;&amp;#x79D1;&amp;#x6280;&amp;#x3002;  &amp;#x9996;&amp;#x5148;&amp;#x58F0;&amp;#x660E;&amp;#xFF0C;&amp;#x6211;&amp;#x57">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/afb065ae7869b393cd18cde2c1598836d55c9b0d075e97513f4a4fa4669ffb4a">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/bb636618c2a355d55b4c85d1641161f35709f4ed07be3366154c8c87e5ea37b7">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/0b887742e121ba06b2a501b9e85a55bfa84c9ab6374f4a7d3bc226f0a162423f">
<meta property="og:updated_time" content="2024-04-28T03:02:38.619Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nodejs 中遇到含空格 URL 的神奇“Bug”——小">
<meta name="twitter:description" content="&amp;#x672C;&amp;#x6587;&amp;#x9996;&amp;#x53D1;&amp;#x4E8E;&amp;#x77E5;&amp;#x4E4E;&amp;#x4E13;&amp;#x680F;&amp;#x8682;&amp;#x8681;&amp;#x91D1;&amp;#x670D;&amp;#x4F53;&amp;#x9A8C;&amp;#x79D1;&amp;#x6280;&amp;#x3002;  &amp;#x9996;&amp;#x5148;&amp;#x58F0;&amp;#x660E;&amp;#xFF0C;&amp;#x6211;&amp;#x57">
<meta name="twitter:image" content="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/afb065ae7869b393cd18cde2c1598836d55c9b0d075e97513f4a4fa4669ffb4a">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/6844903522639544334.html">





  <title>Nodejs 中遇到含空格 URL 的神奇“Bug”——小 | 开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nodejs 中遇到含空格 URL 的神奇“Bug”——小</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-13T17:07:41+08:00">
                2017-12-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p><a href="/external_links/396070a860be2f2cac3b71cc0d3f7430.html" target="blank" rel="noopener">&#x672C;&#x6587;</a>&#x9996;&#x53D1;&#x4E8E;&#x77E5;&#x4E4E;&#x4E13;&#x680F;<a href="/external_links/303a163ec7f63284c65ee0f4d933c11f.html" target="blank" rel="noopener">&#x8682;&#x8681;&#x91D1;&#x670D;&#x4F53;&#x9A8C;&#x79D1;&#x6280;</a>&#x3002;</p>
</blockquote>
<p>&#x9996;&#x5148;&#x58F0;&#x660E;&#xFF0C;&#x6211;&#x5728;&#x201C;Bug&#x201D;&#x5B57;&#x773C;&#x4E0A;&#x52A0;&#x4E86;&#x5F15;&#x53F7;&#xFF0C;&#x81EA;&#x7136;&#x662F;&#x4E3A;&#x4E86;&#x8BF4;&#x660E;&#x5B83;&#x5E76;&#x975E;&#x4E00;&#x4E2A;&#x771F; Bug&#x3002;</p>
<h2 id="&#x95EE;&#x9898;&#x629B;&#x51FA;"><a href="#&#x95EE;&#x9898;&#x629B;&#x51FA;" class="headerlink" title="&#x95EE;&#x9898;&#x629B;&#x51FA;"></a>&#x95EE;&#x9898;&#x629B;&#x51FA;</h2><p>&#x6628;&#x5929;&#x6709;&#x4E2A;&#x7AE5;&#x978B;&#x5728;&#x770B;&#x540E;&#x53F0;&#x76D1;&#x63A7;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7A81;&#x7136;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;[error] 000001#0: ... upstream prematurely closed connection while reading response header from upstream.</span><br><span class="line">  client: 10.10.10.10</span><br><span class="line">  server: foo.com</span><br><span class="line">  request: &quot;GET /foo/bar?rmicmd,begin run clean docker images job HTTP/1.1&quot;</span><br><span class="line">  upstream: &quot;http://...&quot;</span><br></pre></td></tr></table></figure>

<p>&#x5927;&#x6982;&#x610F;&#x601D;&#x5C31;&#x662F;&#x8BF4;&#xFF1A;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x901A;&#x8FC7; HTTP &#x534F;&#x8BAE;&#x53BB;&#x8BF7;&#x6C42;&#x53E6;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5355;&#x65B9;&#x9762;&#x88AB;&#x5BF9;&#x65B9;&#x670D;&#x52A1;&#x5668;&#x65AD;&#x5F00;&#x4E86;&#x8FDE;&#x63A5;&#x2014;&#x2014;&#x5E76;&#x4E14;&#x5E76;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8FD4;&#x56DE;&#x3002;</p>
<h2 id="&#x5F00;&#x59CB;&#x91CD;&#x73B0;"><a href="#&#x5F00;&#x59CB;&#x91CD;&#x73B0;" class="headerlink" title="&#x5F00;&#x59CB;&#x91CD;&#x73B0;"></a>&#x5F00;&#x59CB;&#x91CD;&#x73B0;</h2><h3 id="&#x5BA2;&#x6237;&#x7AEF;-CURL-&#x6307;&#x4EE4;"><a href="#&#x5BA2;&#x6237;&#x7AEF;-CURL-&#x6307;&#x4EE4;" class="headerlink" title="&#x5BA2;&#x6237;&#x7AEF; CURL &#x6307;&#x4EE4;"></a>&#x5BA2;&#x6237;&#x7AEF; CURL &#x6307;&#x4EE4;</h3><p>&#x5176;&#x5B9E;&#x8FD9;&#x6B21;&#x8BF7;&#x6C42;&#x7684;&#x4E00;&#x4E9B;&#x732B;&#x817B;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x80FD;&#x53D1;&#x73B0;&#x2014;&#x2014;&#x5728; URL &#x4E2D;&#x6709;&#x7A7A;&#x683C;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x80FD;&#x7B80;&#x5316;&#x51FA;&#x4E00;&#x6761;&#x6700;&#x7B80;&#x5355;&#x7684; CURL &#x6307;&#x4EE4;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh&#x590D;&#x5236;&#x4EE3;&#x7801;$ curl &quot;http://foo/bar baz&quot; -v</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong>&#xFF1A;&#x4E0D;&#x5E26;&#x4EFB;&#x4F55;&#x8F6C;&#x4E49;&#x3002;</p>
</blockquote>
<h3 id="&#x6700;&#x5C0F;-Node-js-&#x6E90;&#x7801;"><a href="#&#x6700;&#x5C0F;-Node-js-&#x6E90;&#x7801;" class="headerlink" title="&#x6700;&#x5C0F; Node.js &#x6E90;&#x7801;"></a>&#x6700;&#x5C0F; Node.js &#x6E90;&#x7801;</h3><p>&#x597D;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x53BB;&#x5F00;&#x59CB;&#x5199;&#x76F8;&#x5E94;&#x7684;&#x6700;&#x7B80;&#x5355;&#x7684; Node.js HTTP &#x670D;&#x52A1;&#x7AEF;&#x6E90;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">const server = http.createServer(function(req, resp) {</span><br><span class="line">    console.log(&apos;&#x1F31A;&apos;);</span><br><span class="line">    resp.end(&apos;hello world&apos;);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.listen(5555);</span><br></pre></td></tr></table></figure>

<p>&#x5927;&#x529F;&#x544A;&#x6210;&#xFF0C;&#x542F;&#x52A8;&#x8FD9;&#x6BB5; Node.js &#x4EE3;&#x7801;&#xFF0C;&#x5F00;&#x59CB;&#x8BD5;&#x8BD5;&#x770B;&#x4E0A;&#x9762;&#x7684;&#x6307;&#x4EE4;&#x5427;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x4E5F;&#x6B63;&#x5728;&#x8DDF;&#x7740;&#x5C1D;&#x8BD5;&#x8FD9;&#x4EF6;&#x4E8B;&#x60C5;&#x7684;&#x8BDD;&#xFF0C;&#x4F60;&#x5C31;&#x4F1A;&#x53D1;&#x73B0; Node.js &#x7684;&#x547D;&#x4EE4;&#x884C;&#x6CA1;&#x6709;&#x8F93;&#x51FA;&#x4EFB;&#x4F55;&#x4FE1;&#x606F;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5632;&#x8BBD;&#x7684; <code>&apos;&#x1F31A;&apos;</code>&#xFF0C;&#x800C;&#x5728; CURL &#x7684;&#x7ED3;&#x679C;&#x4E2D;&#xFF0C;&#x4F60;&#x5C06;&#x4F1A;&#x770B;&#x89C1;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">shell&#x590D;&#x5236;&#x4EE3;&#x7801;$ curl &apos;http://127.0.0.1:5555/d d&apos; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET /d d HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">* Empty reply from server</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>

<p>&#x77A7;&#xFF0C;<strong>Empty reply from server</strong>&#x3002;</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>&#x53D1;&#x73B0;&#x4E86;&#x95EE;&#x9898;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x6709;&#x53E6;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x503C;&#x5F97;&#x601D;&#x8003;&#x4E86;&#xFF1A;&#x5C31; Node.js &#x4F1A;&#x51FA;&#x73B0;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5462;&#xFF0C;&#x8FD8;&#x662F;&#x5176;&#x5B83;&#x4E00;&#x4E9B; HTTP &#x670D;&#x52A1;&#x5668;&#x4E5F;&#x4F1A;&#x6709;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5462;&#x3002;</p>
<p>&#x4E8E;&#x662F;&#x62FF;&#x5C0F;&#x767D;&#x9F20; Nginx &#x505A;&#x4E86;&#x4E2A;&#x5B9E;&#x9A8C;&#x3002;&#x6211;&#x5199;&#x4E86;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nginx&#x590D;&#x5236;&#x4EE3;&#x7801;server {</span><br><span class="line">    listen 5555;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        return 200 $uri;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x63A5;&#x7740;&#x4E5F;&#x6267;&#x884C;&#x4E00;&#x904D; CURL&#xFF0C;&#x5F97;&#x5230;&#x4E86;&#x5982;&#x4E0B;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yaml&#x590D;&#x5236;&#x4EE3;&#x7801;$ curl &apos;http://127.0.0.1:5555/d d&apos; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET /d d HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Server: openresty/1.11.2.1</span><br><span class="line">&lt; Date: Tue, 12 Dec 2017 09:07:56 GMT</span><br><span class="line">&lt; Content-Type: application/octet-stream</span><br><span class="line">&lt; Content-Length: 4</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host xcoder.in left intact</span><br><span class="line">/d d</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/afb065ae7869b393cd18cde2c1598836d55c9b0d075e97513f4a4fa4669ffb4a" alt><br>&#x5389;&#x5BB3;&#x4E86;&#xFF0C;&#x6211;&#x7684; Nginx<br>&#x4E8E;&#x662F;&#x4E4E;&#xFF0C;&#x7406;&#x6240;&#x5F53;&#x7136;&#xFF0C;&#x6211;<strong>&#x6682;&#x65F6;</strong>&#x5C06;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5B9A;&#x6027;&#x4E3A; Node.js &#x7684;&#x4E00;&#x4E2A; Bug&#x3002;</p>
<h2 id="Node-js-&#x6E90;&#x7801;&#x6392;&#x67E5;"><a href="#Node-js-&#x6E90;&#x7801;&#x6392;&#x67E5;" class="headerlink" title="Node.js &#x6E90;&#x7801;&#x6392;&#x67E5;"></a>Node.js &#x6E90;&#x7801;&#x6392;&#x67E5;</h2><p>&#x8BA4;&#x5B9A;&#x4E86;&#x5B83;&#x662F;&#x4E2A; Bug &#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x5C31;&#x5F00;&#x59CB;&#x4E86;&#x4E00;&#x8D2F;&#x7684;&#x770B;&#x6E90;&#x7801;&#x73AF;&#x8282;&#x2014;&#x2014;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A; Bug &#x7684;&#x590D;&#x73B0;&#x6761;&#x4EF6;&#x6BD4;&#x8F83;&#x660E;&#x663E;&#xFF0C;&#x6211;&#x6682;&#x65F6;&#x5C06;&#x5176;&#x5B9A;&#x6027;&#x4E3A;&#x201C;Node.js HTTP &#x670D;&#x52A1;&#x7AEF;&#x6A21;&#x5757;&#x5728;&#x63A5;&#x5230;&#x8BF7;&#x6C42;&#x540E;&#x89E3;&#x6790; HTTP &#x6570;&#x636E;&#x5305;&#x7684;&#x65F6;&#x5019;&#x89E3;&#x6790; URI &#x65F6;&#x51FA;&#x4E86;&#x95EE;&#x9898;&#x201D;&#x3002;</p>
<h3 id="http-js-gt-http-server-js-gt-http-common-js"><a href="#http-js-gt-http-server-js-gt-http-common-js" class="headerlink" title="http.js -&gt; _http_server.js -&gt; _http_common.js"></a>http.js -&gt; _http_server.js -&gt; _http_common.js</h3><blockquote>
<p>&#x6E90;&#x7801;&#x4EE5; <a href="/external_links/c68d19c6b4ac60d669a02c1bc44896a8.html" target="blank" rel="noopener">Node.js 8.9.2</a> &#x4E3A;&#x51C6;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x5148;&#x9884;&#x7559;&#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x80FD;&#x9A6C;&#x4E0A;&#x60F3;&#x5230;&#x7684; <strong>node_http_parser.cc</strong>&#xFF0C;&#x800C;&#x5148;&#x8BB2;&#x8FD9;&#x51E0;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x662F;&#x6709;&#x539F;&#x56E0;&#x7684;&#x2014;&#x2014;&#x8FD9;&#x6D89;&#x53CA;&#x5230;&#x6700;&#x540E;&#x7684;&#x4E00;&#x4E2A;&#x5E94;&#x5BF9;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x9996;&#x5148;&#x770B;&#x770B; <a href="/external_links/82bebbefc17c3aafd4449130749b3d92.html" target="blank" rel="noopener"><strong>lib/http.js</strong></a> &#x7684;&#x76F8;&#x5E94;&#x6E90;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;...</span><br><span class="line">const server = require(&apos;_http_server&apos;);</span><br><span class="line"></span><br><span class="line">const { Server } = server;</span><br><span class="line"></span><br><span class="line">function createServer(requestListener) {</span><br><span class="line">  return new Server(requestListener);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x90A3;&#x4E48;&#xFF0C;&#x9A6C;&#x4E0A;&#x8FDB;&#x5165; <strong>lib/_http_server.js</strong> &#x770B;&#x5427;&#x3002;</p>
<p>&#x9996;&#x5148;&#x662F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; HttpParser &#x5E76;&#x7ED1;&#x4E0A;&#x76D1;&#x542C;&#x83B7;&#x53D6;&#x5230; HTTP &#x6570;&#x636E;&#x5305;&#x540E;&#x89E3;&#x6790;&#x7ED3;&#x679C;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const {</span><br><span class="line">  parsers,</span><br><span class="line">  ...</span><br><span class="line">} = require(&apos;_http_common&apos;);</span><br><span class="line"></span><br><span class="line">function connectionListener(socket) {</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  var parser = parsers.alloc();</span><br><span class="line">  parser.reinitialize(HTTPParser.REQUEST);</span><br><span class="line">  parser.socket = socket;</span><br><span class="line">  socket.parser = parser;</span><br><span class="line">  parser.incoming = null;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  state.onData = socketOnData.bind(undefined, this, socket, parser, state);</span><br><span class="line">  ...</span><br><span class="line">  socket.on(&apos;data&apos;, state.onData);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function socketOnData(server, socket, parser, state, d) {</span><br><span class="line">  assert(!socket._paused);</span><br><span class="line">  debug(&apos;SERVER socketOnData %d&apos;, d.length);</span><br><span class="line"></span><br><span class="line">  var ret = parser.execute(d);</span><br><span class="line">  onParserExecuteCommon(server, socket, parser, state, ret, d);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x6E90;&#x7801;&#x4E2D;&#x6587;&#x6211;&#x4EEC;&#x80FD;&#x770B;&#x5230;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A; HTTP &#x8BF7;&#x6C42;&#x8FC7;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x76D1;&#x542C;&#x51FD;&#x6570; <code>connectionListener()</code> &#x4F1A;&#x62FF;&#x7740; Socket &#x5BF9;&#x8C61;&#x52A0;&#x4E0A;&#x4E00;&#x4E2A; <code>data</code> &#x4E8B;&#x4EF6;&#x76D1;&#x542C;&#x2014;&#x2014;&#x4E00;&#x65E6;&#x6709;&#x8BF7;&#x6C42;&#x8FDE;&#x63A5;&#x8FC7;&#x6765;&#xFF0C;&#x5C31;&#x53BB;&#x6267;&#x884C; <code>socketOnData()</code> &#x51FD;&#x6570;&#x3002;</p>
<p>&#x800C;&#x5728; <code>socketOnData()</code> &#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x505A;&#x7684;&#x4E3B;&#x8981;&#x4E8B;&#x60C5;&#x5C31;&#x662F; <code>parser.execute(d)</code> &#x6765;&#x89E3;&#x6790; HTTP &#x6570;&#x636E;&#x5305;&#xFF0C;&#x5728;&#x89E3;&#x6790;&#x5B8C;&#x6210;&#x540E;&#x6267;&#x884C;&#x4E00;&#x4E0B;&#x56DE;&#x8C03;&#x51FD;&#x6570; <code>onParserExecuteCommon()</code>&#x3002;</p>
<p>&#x81F3;&#x4E8E;&#x8FD9;&#x4E2A; <code>parser</code>&#xFF0C;&#x6211;&#x4EEC;&#x80FD;&#x770B;&#x5230;&#x5B83;&#x662F;&#x4ECE; <a href="/external_links/a3d2ad1b2994e6d80776144afa89caa6.html" target="blank" rel="noopener"><strong>lib/_http_common.js</strong></a> &#x4E2D;&#x6765;&#x7684;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;var parsers = new FreeList(&apos;parsers&apos;, 1000, function() {</span><br><span class="line">  var parser = new HTTPParser(HTTPParser.REQUEST);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  parser[kOnHeaders] = parserOnHeaders;</span><br><span class="line">  parser[kOnHeadersComplete] = parserOnHeadersComplete;</span><br><span class="line">  parser[kOnBody] = parserOnBody;</span><br><span class="line">  parser[kOnMessageComplete] = parserOnMessageComplete;</span><br><span class="line">  parser[kOnExecute] = null;</span><br><span class="line"></span><br><span class="line">  return parser;</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>&#x80FD;&#x770B;&#x51FA;&#x6765; <code>parsers</code> &#x662F; <code>HTTPParser</code> &#x7684;&#x4E00;&#x6761; Free List&#xFF08;&#x6548;&#x679C;&#x7C7B;&#x4F3C;&#x4E8E;&#x6700;&#x7B80;&#x6613;&#x7684;&#x52A8;&#x6001;&#x5185;&#x5B58;&#x6C60;&#xFF09;&#xFF0C;&#x6BCF;&#x4E2A; Parser &#x5728;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x7ED1;&#x5B9A;&#x4E0A;&#x4E86;&#x5404;&#x79CD;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;&#x5177;&#x4F53;&#x7684;&#x4E00;&#x4E9B;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5C31;&#x4E0D;&#x7EC6;&#x8BB2;&#x4E86;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x7AE5;&#x978B;&#x53EF;&#x81EA;&#x884C;&#x7FFB;&#x9605;&#x3002;</p>
<p>&#x8FD9;&#x4E48;&#x4E00;&#x6765;&#xFF0C;&#x94FE;&#x8DEF;&#x5C31;&#x6BD4;&#x8F83;&#x660E;&#x6670;&#x4E86;&#xFF1A;</p>
<p><strong>&#x8BF7;&#x6C42;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;Server &#x5BF9;&#x8C61;&#x4F1A;&#x4E3A;&#x8BE5;&#x6B21;&#x8BF7;&#x6C42;&#x7684; Socket &#x5206;&#x914D;&#x4E00;&#x4E2A; <code>HttpParser</code> &#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x5176; <code>execute()</code> &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x5728;&#x89E3;&#x6790;&#x5B8C;&#x6210;&#x540E;&#x8C03;&#x7528; <code>onParserExecuteCommon()</code> &#x51FD;&#x6570;&#x3002;</strong></p>
<h3 id="node-http-parser-cc"><a href="#node-http-parser-cc" class="headerlink" title="node_http_parser.cc"></a>node_http_parser.cc</h3><p>&#x6211;&#x4EEC;&#x5728; <strong>lib/_http_common.js</strong> &#x4E2D;&#x80FD;&#x53D1;&#x73B0;&#xFF0C;<code>HTTPParser</code> &#x7684;&#x5B9E;&#x73B0;&#x5B58;&#x5728;&#x4E8E; <strong>src/node_http_parser.cc</strong> &#x4E2D;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;const binding = process.binding(&apos;http_parser&apos;);</span><br><span class="line">const { methods, HTTPParser } = binding;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48; <code>const binding = process.binding(&apos;http_parser&apos;)</code> &#x5C31;&#x662F;&#x5BF9;&#x5E94;&#x5230; <strong>src/node_http_parser.cc</strong> &#x6587;&#x4EF6;&#xFF0C;&#x4EE5;&#x53CA;&#x8FD9;&#x4E00;&#x5C0F;&#x8282;&#x4E2D;&#x4E0B;&#x9762;&#x7684;&#x4E00;&#x4E9B; C++ &#x6E90;&#x7801;&#x76F8;&#x5173;&#x5206;&#x6790;&#xFF0C;&#x4E0D;&#x660E;&#x767D;&#x4E14;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x7AE5;&#x978B;&#x53EF;&#x81EA;&#x884C;&#x53BB;&#x9605;&#x8BFB;&#x66F4;&#x6DF1;&#x4E00;&#x5C42;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x6216;&#x8005;&#x7F51;&#x4E0A;&#x641C;&#x7D22;&#x7B54;&#x6848;&#xFF0C;&#x6216;&#x8005;&#x6211;&#x63D0;&#x524D;&#x65E0;&#x803B;&#x786C;&#x5E7F;&#x4E00;&#x4E0B;&#x6211;&#x5FEB;&#x8981;&#x4E0A;&#x5E02;&#x7684;&#x4E66;&#x300A;Node.js&#xFF1A;&#x6765;&#x4E00;&#x6253; C++ &#x6269;&#x5C55;&#x300B;&#x2014;&#x2014;&#x91CC;&#x9762;&#x4E5F;&#x6709;&#x8BF4;&#x660E;&#xFF0C;&#x4EE5;&#x53CA;&#x6211;&#x7684;&#x6709;&#x4E00;&#x573A;&#x77E5;&#x4E4E; Live&#x300A;&#x6DF1;&#x5165;&#x7406;&#x89E3; Node.js &#x5305;&#x4E0E;&#x6A21;&#x5757;&#x673A;&#x5236;&#x300B;&#x3002;</p>
</blockquote>
<p>&#x603B;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x53BB;&#x8981;&#x770B;&#x7684;&#x5C31;&#x662F; <a href="/external_links/5c6abd32c8f24e03d4233c64f827f97b.html" target="blank" rel="noopener"><strong>src/node_http_parser.cc</strong></a> &#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;env-&gt;SetProtoMethod(t, &quot;close&quot;, Parser::Close);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;execute&quot;, Parser::Execute);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;finish&quot;, Parser::Finish);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;reinitialize&quot;, Parser::Reinitialize);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;pause&quot;, Parser::Pause&lt;true&gt;);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;resume&quot;, Parser::Pause&lt;false&gt;);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;consume&quot;, Parser::Consume);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;unconsume&quot;, Parser::Unconsume);</span><br><span class="line">env-&gt;SetProtoMethod(t, &quot;getCurrentBuffer&quot;, Parser::GetCurrentBuffer);</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x6240;&#x793A;&#xFF0C;&#x524D;&#x6587;&#x4E2D; <code>parser.execute()</code> &#x6240;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x5C31;&#x662F; <code>Parser::Execute()</code> &#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;class Parser : public AsyncWrap {</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  static void Execute(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span><br><span class="line">    Parser* parser;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Local&lt;Object&gt; buffer_obj = args[0].As&lt;Object&gt;();</span><br><span class="line">    char* buffer_data = Buffer::Data(buffer_obj);</span><br><span class="line">    size_t buffer_len = Buffer::Length(buffer_obj);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Local&lt;Value&gt; ret = parser-&gt;Execute(buffer_data, buffer_len);</span><br><span class="line"></span><br><span class="line">    if (!ret.IsEmpty())</span><br><span class="line">      args.GetReturnValue().Set(ret);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  Local&lt;Value&gt; Execute(char* data, size_t len) {</span><br><span class="line">    EscapableHandleScope scope(env()-&gt;isolate());</span><br><span class="line"></span><br><span class="line">    current_buffer_len_ = len;</span><br><span class="line">    current_buffer_data_ = data;</span><br><span class="line">    got_exception_ = false;</span><br><span class="line"></span><br><span class="line">    size_t nparsed =</span><br><span class="line">      http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br><span class="line"></span><br><span class="line">    Save();</span><br><span class="line"></span><br><span class="line">    // Unassign the &apos;buffer_&apos; variable</span><br><span class="line">    current_buffer_.Clear();</span><br><span class="line">    current_buffer_len_ = 0;</span><br><span class="line">    current_buffer_data_ = nullptr;</span><br><span class="line"></span><br><span class="line">    // If there was an exception in one of the callbacks</span><br><span class="line">    if (got_exception_)</span><br><span class="line">      return scope.Escape(Local&lt;Value&gt;());</span><br><span class="line"></span><br><span class="line">    Local&lt;Integer&gt; nparsed_obj = Integer::New(env()-&gt;isolate(), nparsed);</span><br><span class="line">    // If there was a parse error in one of the callbacks</span><br><span class="line">    // TODO(bnoordhuis) What if there is an error on EOF?</span><br><span class="line">    if (!parser_.upgrade &amp;&amp; nparsed != len) {</span><br><span class="line">      enum http_errno err = HTTP_PARSER_ERRNO(&amp;parser_);</span><br><span class="line"></span><br><span class="line">      Local&lt;Value&gt; e = Exception::Error(env()-&gt;parse_error_string());</span><br><span class="line">      Local&lt;Object&gt; obj = e-&gt;ToObject(env()-&gt;isolate());</span><br><span class="line">      obj-&gt;Set(env()-&gt;bytes_parsed_string(), nparsed_obj);</span><br><span class="line">      obj-&gt;Set(env()-&gt;code_string(),</span><br><span class="line">               OneByteString(env()-&gt;isolate(), http_errno_name(err)));</span><br><span class="line"></span><br><span class="line">      return scope.Escape(e);</span><br><span class="line">    }</span><br><span class="line">    return scope.Escape(nparsed_obj);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x9996;&#x5148;&#x8FDB;&#x5165; <code>Parser</code> &#x7684;&#x9759;&#x6001; <code>Execute()</code> &#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x5B83;&#x628A;&#x4F20;&#x8FDB;&#x6765;&#x7684; <code>Buffer</code> &#x8F6C;&#x5316;&#x4E3A; C++ &#x4E0B;&#x7684; <code>char*</code> &#x6307;&#x9488;&#xFF0C;&#x5E76;&#x8BB0;&#x5F55;&#x5176;&#x6570;&#x636E;&#x957F;&#x5EA6;&#xFF0C;&#x540C;&#x65F6;&#x53BB;&#x6267;&#x884C;&#x5F53;&#x524D;&#x8C03;&#x7528;&#x7684; <code>parser</code> &#x5BF9;&#x8C61;&#x6240;&#x5BF9;&#x5E94;&#x7684; <code>Execute()</code> &#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A; <code>Execute()</code> &#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6709;&#x4E2A;&#x6700;&#x91CD;&#x8981;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5C31;&#x662F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;size_t nparsed =</span><br><span class="line">    http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x662F;&#x8C03;&#x7528;&#x771F;&#x6B63;&#x89E3;&#x6790; HTTP &#x6570;&#x636E;&#x5305;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x662F; Node.js &#x8FD9;&#x4E2A;&#x9879;&#x76EE;&#x7684;&#x4E00;&#x4E2A;&#x81EA;&#x7814;&#x4F9D;&#x8D56;&#xFF0C;&#x53EB; <a href="/external_links/f657e3f8df4393e909f3a59a27cdb3d2.html" target="blank" rel="noopener">http-parser</a>&#x3002;&#x5B83;&#x72EC;&#x7ACB;&#x7684;&#x9879;&#x76EE;&#x5730;&#x5740;&#x5728; <a href="/external_links/913990ebfbad888ec7859ae0237ae15b.html" target="blank" rel="noopener">github.com/nodejs/http&#x2026;</a>&#xFF0C;&#x6211;&#x4EEC;&#x672C;&#x6587;&#x4E2D;&#x7528;&#x7684;&#x662F; Node.js v8.9.2 &#x4E2D;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5E94;&#x8BE5;&#x4F1A;&#x6709;&#x504F;&#x5DEE;&#x3002;</p>
<h3 id="http-parser"><a href="#http-parser" class="headerlink" title="http-parser"></a>http-parser</h3><h4 id="HTTP-Request-&#x6570;&#x636E;&#x5305;&#x4F53;"><a href="#HTTP-Request-&#x6570;&#x636E;&#x5305;&#x4F53;" class="headerlink" title="HTTP Request &#x6570;&#x636E;&#x5305;&#x4F53;"></a>HTTP Request &#x6570;&#x636E;&#x5305;&#x4F53;</h4><blockquote>
<p>&#x5982;&#x679C;&#x4F60;&#x5DF2;&#x7ECF;&#x5BF9; HTTP &#x5305;&#x4F53;&#x4E86;&#x89E3;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x7565;&#x8FC7;&#x8FD9;&#x4E00;&#x8282;&#x3002;</p>
</blockquote>
<p>HTTP &#x7684; Request &#x6570;&#x636E;&#x5305;&#x5176;&#x5B9E;&#x662F;&#x6587;&#x672C;&#x683C;&#x5F0F;&#x7684;&#xFF0C;&#x5728; Raw &#x7684;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x5927;&#x6982;&#x662F;&#x4EE5;&#x8FD9;&#x6837;&#x7684;&#x5F62;&#x5F0F;&#x5B58;&#x5728;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;&#x65B9;&#x6CD5; URI HTTP/&#x7248;&#x672C;</span><br><span class="line">&#x5934;1: &#x6211;&#x662F;&#x5934;1</span><br><span class="line">&#x5934;2: &#x6211;&#x662F;&#x5934;2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x7B80;&#x5355;&#x8D77;&#x89C1;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x5199;&#x51FA;&#x6700;&#x57FA;&#x7840;&#x7684;&#x4E00;&#x4E9B;&#x5185;&#x5BB9;&#xFF0C;&#x81F3;&#x4E8E; Body &#x4EC0;&#x4E48;&#x7684;&#x5927;&#x5BB6;&#x81EA;&#x5DF1;&#x627E;&#x8D44;&#x6599;&#x770B;&#x5427;&#x3002;</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#x610F;&#x601D;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x770B;&#x770B; CURL &#x7684;&#x7ED3;&#x679C;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x5BF9;&#x5E94; <code>curl ... -v</code> &#x7684;&#x4E2D;&#x95F4;&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;GET /test HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:5555</span><br><span class="line">User-Agent: curl/7.54.0</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#x5B9E;&#x9645;&#x4E0A;&#x5927;&#x5BB6;&#x5E73;&#x65F6;&#x5728;&#x6587;&#x7AE0;&#x4E2D;&#x3001;&#x6D4F;&#x89C8;&#x5668;&#x8C03;&#x8BD5;&#x5DE5;&#x5177;&#x4E2D;&#x770B;&#x5230;&#x7684;&#x4EC0;&#x4E48;&#x8BF7;&#x6C42;&#x5934;&#x554A;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x90FD;&#x662F;&#x4EE5;&#x6587;&#x672C;&#x5F62;&#x5F0F;&#x5B58;&#x5728;&#x7684;&#xFF0C;&#x4EE5;&#x6362;&#x884C;&#x7B26;&#x5206;&#x5272;&#x3002;</p>
<p>&#x800C;&#x2014;&#x2014;&#x91CD;&#x70B9;&#x6765;&#x4E86;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x672C;&#x6587;&#x6240;&#x8FF0;&#x201C;Bug&#x201D;&#x51FA;&#x73B0;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x5B83;&#x7684;&#x8BF7;&#x6C42;&#x5305;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makefile&#x590D;&#x5236;&#x4EE3;&#x7801;GET /foo bar HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:5555</span><br><span class="line">User-Agent: curl/7.54.0</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>&#x91CD;&#x70B9;&#x5728;&#x7B2C;&#x4E00;&#x884C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash&#x590D;&#x5236;&#x4EE3;&#x7801;GET /foo bar HTTP/1.1</span><br></pre></td></tr></table></figure>

<h4 id="&#x6E90;&#x7801;&#x89E3;&#x6790;"><a href="#&#x6E90;&#x7801;&#x89E3;&#x6790;" class="headerlink" title="&#x6E90;&#x7801;&#x89E3;&#x6790;"></a>&#x6E90;&#x7801;&#x89E3;&#x6790;</h4><p>&#x8BDD;&#x4E0D;&#x591A;&#x5C11;&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x95F4;&#x524D;&#x5F80; http-parser &#x7684; <a href="/external_links/77017139e997b662f76e070c376e86c5.html" target="blank" rel="noopener">http_parser.c</a> &#x770B; <code>http_parser_execute ()</code> &#x51FD;&#x6570;&#x4E2D;&#x7684;&#x72B6;&#x6001;&#x673A;&#x53D8;&#x5316;&#x3002;</p>
<p>&#x4ECE;&#x6E90;&#x7801;&#x4E2D;&#x6587;&#x6211;&#x4EEC;&#x80FD;&#x770B;&#x5230;&#xFF0C;http-parser &#x7684;&#x6D41;&#x7A0B;&#x662F;&#x4ECE;&#x5934;&#x5230;&#x5C3E;&#x4EE5; O(n) &#x7684;&#x65F6;&#x95F4;&#x590D;&#x6742;&#x5EA6;&#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x9010;&#x5B57;&#x626B;&#x63CF;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x540E;&#x9000;&#x4E5F;&#x4E0D;&#x5F80;&#x524D;&#x8DF3;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x626B;&#x63CF;&#x5230;&#x6BCF;&#x4E2A;&#x5B57;&#x7B26;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x6709;&#x5C5E;&#x4E8E;&#x5F53;&#x524D;&#x7684;&#x4E00;&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x201C;&#x6B63;&#x5728;&#x626B;&#x63CF;&#x5904;&#x7406; uri&#x201D;&#x3001;&#x201C;&#x6B63;&#x5728;&#x626B;&#x63CF;&#x5904;&#x7406; HTTP &#x534F;&#x8BAE;&#x5E76;&#x4E14;&#x5904;&#x7406;&#x5230;&#x4E86; H&#x201D;&#x3001;&#x201C;&#x6B63;&#x5728;&#x626B;&#x63CF;&#x5904;&#x7406; HTTP &#x534F;&#x8BAE;&#x5E76;&#x4E14;&#x5904;&#x7406;&#x5230;&#x4E86; HT&#x201D;&#x3001;&#x201C;&#x6B63;&#x5728;&#x626B;&#x63CF;&#x5904;&#x7406; HTTP &#x534F;&#x8BAE;&#x5E76;&#x4E14;&#x5904;&#x7406;&#x5230;&#x4E86; HTT&#x201D;&#x3001;&#x201C;&#x6B63;&#x5728;&#x626B;&#x63CF;&#x5904;&#x7406; HTTP &#x534F;&#x8BAE;&#x5E76;&#x4E14;&#x5904;&#x7406;&#x5230;&#x4E86; HTTP&#x201D;&#x3001;&#x2026;&#x2026;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/bb636618c2a355d55b4c85d1641161f35709f4ed07be3366154c8c87e5ea37b7" alt><br>&#x618B;&#x7B11;&#xFF0C;&#x8FD9;&#x662F;&#x771F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x770B;&#x4EE3;&#x7801;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;case s_req_server:</span><br><span class="line">case s_req_server_with_at:</span><br><span class="line">case s_req_path:</span><br><span class="line">case s_req_query_string_start:</span><br><span class="line">case s_req_query_string:</span><br><span class="line">case s_req_fragment_start:</span><br><span class="line">case s_req_fragment:</span><br><span class="line">{</span><br><span class="line">  switch (ch) {</span><br><span class="line">    case &apos; &apos;:</span><br><span class="line">      UPDATE_STATE(s_req_http_start);</span><br><span class="line">      CALLBACK_DATA(url);</span><br><span class="line">      break;</span><br><span class="line">    case CR:</span><br><span class="line">    case LF:</span><br><span class="line">      parser-&gt;http_major = 0;</span><br><span class="line">      parser-&gt;http_minor = 9;</span><br><span class="line">      UPDATE_STATE((ch == CR) ?</span><br><span class="line">        s_req_line_almost_done :</span><br><span class="line">        s_header_field_start);</span><br><span class="line">      CALLBACK_DATA(url);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      UPDATE_STATE(parse_url_char(CURRENT_STATE(), ch));</span><br><span class="line">      if (UNLIKELY(CURRENT_STATE() == s_dead)) {</span><br><span class="line">        SET_ERRNO(HPE_INVALID_URL);</span><br><span class="line">        goto error;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  break;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x626B;&#x63CF;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x662F; URI &#x76F8;&#x5173;&#x7684;&#xFF08;&#x5982; <code>s_req_path</code>&#x3001;<code>s_req_query_string</code> &#x7B49;&#xFF09;&#xFF0C;&#x5219;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#x5B50; <code>switch</code>&#xFF0C;&#x91CC;&#x9762;&#x7684;&#x5904;&#x7406;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x82E5;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x662F;&#x7A7A;&#x683C;&#xFF0C;&#x5219;&#x5C06;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x4E3A; <code>s_req_http_start</code> &#x5E76;&#x8BA4;&#x4E3A; URI &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x597D;&#x4E86;&#xFF0C;&#x901A;&#x8FC7;&#x5B8F; <code>CALLBACK_DATA()</code> &#x89E6;&#x53D1; URI &#x89E3;&#x6790;&#x597D;&#x7684;&#x4E8B;&#x4EF6;&#xFF1B;</li>
<li>&#x82E5;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x662F;&#x6362;&#x884C;&#x7B26;&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8FD8;&#x5728;&#x89E3;&#x6790; URI &#x7684;&#x65F6;&#x5019;&#x5C31;&#x88AB;&#x6362;&#x884C;&#x4E86;&#xFF0C;&#x540E;&#x9762;&#x5C31;&#x4E0D;&#x53EF;&#x80FD;&#x8DDF;&#x7740; HTTP &#x534F;&#x8BAE;&#x7248;&#x672C;&#x7684;&#x7533;&#x660E;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x7684; HTTP &#x7248;&#x672C;&#x4E3A; <code>0.9</code>&#xFF0C;&#x5E76;&#x4FEE;&#x6539;&#x5F53;&#x524D;&#x72B6;&#x6001;&#xFF0C;&#x6700;&#x540E;&#x8BA4;&#x4E3A; URI &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x597D;&#x4E86;&#xFF0C;&#x901A;&#x8FC7;&#x5B8F; <code>CALLBACK_DATA()</code> &#x89E6;&#x53D1; URI &#x89E3;&#x6790;&#x597D;&#x7684;&#x4E8B;&#x4EF6;&#xFF1B;</li>
<li>&#x5176;&#x4F59;&#x60C5;&#x51B5;&#xFF08;&#x6240;&#x6709;&#x5176;&#x5B83;&#x5B57;&#x7B26;&#xFF09;&#x4E0B;&#xFF0C;&#x901A;&#x8FC7;&#x8C03;&#x7528; <code>parse_url_char()</code> &#x51FD;&#x6570;&#x6765;&#x89E3;&#x6790;&#x4E00;&#x4E9B;&#x4E1C;&#x897F;&#x5E76;&#x66F4;&#x65B0;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;&#xFF08;&#x56E0;&#x4E3A;&#x54EA;&#x6015;&#x662F;&#x5728;&#x89E3;&#x6790; URI &#x72B6;&#x6001;&#x4E2D;&#xFF0C;&#x4E5F;&#x8FD8;&#x6709;&#x5404;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x7EC6;&#x5206;&#xFF0C;&#x5982; <code>s_req_path</code>&#x3001;<code>s_req_query_string</code> &#xFF09;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x7684;&#x91CD;&#x70B9;&#x8FD8;&#x662F;&#x5F53;&#x72B6;&#x6001;&#x4E3A;&#x89E3;&#x6790; URI &#x7684;&#x65F6;&#x5019;&#x9047;&#x5230;&#x4E86;&#x7A7A;&#x683C;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x4E0A;&#x9762;&#x4E5F;&#x89E3;&#x91CA;&#x8FC7;&#x4E86;&#xFF0C;&#x4E00;&#x65E6;&#x9047;&#x5230;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x5219;&#x4F1A;&#x8BA4;&#x4E3A; URI &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x597D;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x72B6;&#x6001;&#x4FEE;&#x6539;&#x4E3A; <code>s_req_http_start</code>&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6709;&#x201C;Bug&#x201D;&#x7684;&#x90A3;&#x4E2A;&#x6570;&#x636E;&#x5305;<br><code>GET /foo bar HTTP/1.1</code> &#x5728;&#x89E3;&#x6790;&#x5230; <code>foo</code> &#x540E;&#x9762;&#x7684;&#x7A7A;&#x683C;&#x7684;&#x65F6;&#x5019;&#x5B83;&#x5C31;&#x5C06;&#x72B6;&#x6001;&#x6539;&#x4E3A; <code>s_req_http_start</code> &#x5E76;&#x4E14;&#x8BA4;&#x4E3A; URI &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x7ED3;&#x675F;&#x4E86;&#x3002;</p>
<p>&#x597D;&#x7684;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x770B;&#x770B; <code>s_req_http_start</code> &#x600E;&#x4E48;&#x5904;&#x7406;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;case s_req_http_start:</span><br><span class="line">  switch (ch) {</span><br><span class="line">    case &apos;H&apos;:</span><br><span class="line">      UPDATE_STATE(s_req_http_H);</span><br><span class="line">      break;</span><br><span class="line">    case &apos; &apos;:</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      SET_ERRNO(HPE_INVALID_CONSTANT);</span><br><span class="line">      goto error;</span><br><span class="line">  }</span><br><span class="line">  break;</span><br><span class="line"></span><br><span class="line">case s_req_http_H:</span><br><span class="line">  STRICT_CHECK(ch != &apos;T&apos;);</span><br><span class="line">  UPDATE_STATE(s_req_http_HT);</span><br><span class="line">  break;</span><br><span class="line"></span><br><span class="line">case s_req_http_HT:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">case s_req_http_HTT:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">case s_req_http_HTTP:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">case s_req_first_http_major:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x4EE3;&#x7801;&#x6240;&#x89C1;&#xFF0C;&#x82E5;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x4E3A; <code>s_req_http_start</code>&#xFF0C;&#x5219;&#x5148;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x662F;&#x4E0D;&#x662F;&#x5408;&#x6807;&#x3002;&#x56E0;&#x4E3A;&#x5C31; HTTP &#x8BF7;&#x6C42;&#x5305;&#x4F53;&#x7684;&#x683C;&#x5F0F;&#x6765;&#x770B;&#xFF0C;&#x5982;&#x679C; URI &#x89E3;&#x6790;&#x7ED3;&#x675F;&#x7684;&#x8BDD;&#xFF0C;&#x7406;&#x5E94;&#x51FA;&#x73B0;&#x7C7B;&#x4F3C; <code>HTTP/1.1</code> &#x7684;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x7533;&#x660E;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x65F6;&#x5019; http-parser &#x4F1A;&#x76F4;&#x63A5;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x662F;&#x5426;&#x4E3A; <code>H</code>&#x3002;</p>
<ul>
<li>&#x82E5;&#x662F; <code>H</code>&#xFF0C;&#x5219;&#x5C06;&#x72B6;&#x6001;&#x6539;&#x4E3A; <code>s_req_http_H</code> &#x5E76;&#x7EE7;&#x7EED;&#x626B;&#x63CF;&#x5FAA;&#x73AF;&#x7684;&#x4E0B;&#x4E00;&#x4F4D;&#xFF0C;&#x540C;&#x7406;&#x5728; <code>s_req_http_H</code> &#x4E0B;&#x82E5;&#x5408;&#x6CD5;&#x72B6;&#x6001;&#x5C31;&#x4F1A;&#x53D8;&#x6210; <code>s_req_http_HT</code>&#xFF0C;&#x4EE5;&#x6B64;&#x7C7B;&#x63A8;&#xFF1B;</li>
</ul>
<p>+&#x82E5;&#x662F;&#x7A7A;&#x683C;&#xFF0C;&#x5219;&#x8BA4;&#x4E3A;&#x662F;&#x591A;&#x4F59;&#x7684;&#x7A7A;&#x683C;&#xFF0C;&#x90A3;&#x4E48;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x4E0D;&#x505A;&#x4EFB;&#x4F55;&#x6539;&#x53D8;&#xFF0C;&#x5E76;&#x7EE7;&#x7EED;&#x4E0B;&#x4E00;&#x4E2A;&#x626B;&#x63CF;&#xFF1B;</p>
<ul>
<li>&#x4F46;&#x5982;&#x679C;&#x5F53;&#x524D;&#x5B57;&#x7B26;&#x65E2;&#x4E0D;&#x662F;&#x7A7A;&#x683C;&#x4E5F;&#x4E0D;&#x662F; <code>H</code>&#xFF0C;&#x90A3;&#x4E48;&#x597D;&#x4E86;&#xFF0C;http-parser &#x76F4;&#x63A5;&#x8BA4;&#x4E3A;&#x4F60;&#x7684;&#x8BF7;&#x6C42;&#x5305;&#x4E0D;&#x5408;&#x6CD5;&#xFF0C;&#x5C06;&#x4F60;&#x672C;&#x6B21;&#x7684;&#x89E3;&#x6790;&#x8BBE;&#x7F6E;&#x9519;&#x8BEF; <code>HPE_INVALID_CONSTANT</code> &#x5E76; <code>goto</code> &#x5230; <code>error</code> &#x4EE3;&#x7801;&#x5757;&#x3002;</li>
</ul>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x57FA;&#x672C;&#x4E0A;&#x5DF2;&#x7ECF;&#x660E;&#x767D;&#x4E86;&#x539F;&#x56E0;&#x4E86;&#xFF1A;</p>
<p><strong>http-parser &#x8BA4;&#x4E3A;&#x5728; HTTP &#x8BF7;&#x6C42;&#x5305;&#x4F53;&#x4E2D;&#xFF0C;&#x7B2C;&#x4E00;&#x884C;&#x7684; URI &#x89E3;&#x6790;&#x9636;&#x6BB5;&#x4E00;&#x65E6;&#x51FA;&#x73B0;&#x4E86;&#x7A7A;&#x683C;&#xFF0C;&#x5C31;&#x4F1A;&#x8BA4;&#x4E3A; URI &#x89E3;&#x6790;&#x5B8C;&#x6210;&#xFF0C;&#x7EE7;&#x800C;&#x89E3;&#x6790; HTTP &#x534F;&#x8BAE;&#x7248;&#x672C;&#x3002;&#x4F46;&#x82E5;&#x6B64;&#x65F6;&#x7D27;&#x8DDF;&#x7740;&#x7684;&#x4E0D;&#x662F; HTTP &#x534F;&#x8BAE;&#x7248;&#x672C;&#x7684;&#x6807;&#x51C6;&#x683C;&#x5F0F;&#xFF0C;http-parser &#x5C31;&#x4F1A;&#x8BA4;&#x4E3A;&#x4F60;&#x8FD9;&#x662F;&#x4E00;&#x4E2A; <code>HPE_INVALID_CONSTANT</code> &#x7684;&#x6570;&#x636E;&#x5305;&#x3002;</strong></p>
<p>&#x4E0D;&#x8FC7;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x7EE7;&#x7EED;&#x770B;&#x770B;&#x5B83;&#x7684; <code>error</code> &#x4EE3;&#x7801;&#x5757;&#x5427;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;error:</span><br><span class="line">  if (HTTP_PARSER_ERRNO(parser) == HPE_OK) {</span><br><span class="line">    SET_ERRNO(HPE_UNKNOWN);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  RETURN(p - data);</span><br></pre></td></tr></table></figure>

<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E2D;&#x9996;&#x5148;&#x5224;&#x65AD;&#x4E00;&#x4E0B;&#x5F53;&#x8DF3;&#x5230;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x6709;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#xFF0C;&#x82E5;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x9519;&#x8BEF;&#x5219;&#x5C06;&#x9519;&#x8BEF;&#x8BBE;&#x7F6E;&#x4E3A;&#x672A;&#x77E5;&#x9519;&#x8BEF;&#xFF08;<code>HPE_UNKNOWN</code>&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x5DF2;&#x89E3;&#x6790;&#x7684;&#x6570;&#x636E;&#x5305;&#x957F;&#x5EA6;&#x3002;</p>
<blockquote>
<p><code>p</code> &#x662F;&#x5F53;&#x524D;&#x89E3;&#x6790;&#x5B57;&#x7B26;&#x6307;&#x9488;&#xFF0C;<code>data</code> &#x662F;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x7684;&#x8D77;&#x59CB;&#x6307;&#x9488;&#xFF0C;&#x6240;&#x4EE5; <code>p - data</code> &#x5C31;&#x662F;&#x5DF2;&#x89E3;&#x6790;&#x7684;&#x6570;&#x636E;&#x957F;&#x5EA6;&#x3002;&#x5982;&#x679C;&#x6210;&#x529F;&#x89E3;&#x6790;&#x5B8C;&#xFF0C;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x7684;&#x5B8C;&#x6574;&#x957F;&#x5EA6;&#xFF0C;&#x82E5;&#x4E0D;&#x7B49;&#x5219;&#x7406;&#x8BBA;&#x4E0A;&#x8BF4;&#x660E;&#x80AF;&#x5B9A;&#x662F;&#x4E2D;&#x9014;&#x51FA;&#x9519;&#x63D0;&#x524D;&#x8FD4;&#x56DE;&#x3002;</p>
</blockquote>
<h3 id="&#x56DE;&#x5230;-node-http-parser-cc"><a href="#&#x56DE;&#x5230;-node-http-parser-cc" class="headerlink" title="&#x56DE;&#x5230; node_http_parser.cc"></a>&#x56DE;&#x5230; node_http_parser.cc</h3><p>&#x770B;&#x5B8C;&#x4E86; http-parser &#x7684;&#x539F;&#x7406;&#x540E;&#xFF0C;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x8305;&#x585E;&#x987F;&#x5F00;&#x3002;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x56DE;&#x5230;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x5730; <a href="/external_links/5c6abd32c8f24e03d4233c64f827f97b.html" target="blank" rel="noopener"><strong>node_http_parser.cc</strong></a> &#x7EE7;&#x7EED;&#x9605;&#x8BFB;&#x5427;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cpp&#x590D;&#x5236;&#x4EE3;&#x7801;Local&lt;Value&gt; Execute(char* data, size_t len) {</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  size_t nparsed =</span><br><span class="line">    http_parser_execute(&amp;parser_, &amp;settings, data, len);</span><br><span class="line"></span><br><span class="line">  Local&lt;Integer&gt; nparsed_obj = Integer::New(env()-&gt;isolate(), nparsed);</span><br><span class="line">  if (!parser_.upgrade &amp;&amp; nparsed != len) {</span><br><span class="line">    enum http_errno err = HTTP_PARSER_ERRNO(&amp;parser_);</span><br><span class="line"></span><br><span class="line">    Local&lt;Value&gt; e = Exception::Error(env()-&gt;parse_error_string());</span><br><span class="line">    Local&lt;Object&gt; obj = e-&gt;ToObject(env()-&gt;isolate());</span><br><span class="line">    obj-&gt;Set(env()-&gt;bytes_parsed_string(), nparsed_obj);</span><br><span class="line">    obj-&gt;Set(env()-&gt;code_string(),</span><br><span class="line">             OneByteString(env()-&gt;isolate(), http_errno_name(err)));</span><br><span class="line"></span><br><span class="line">    return scope.Escape(e);</span><br><span class="line">  }</span><br><span class="line">  return scope.Escape(nparsed_obj);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x4ECE;&#x8C03;&#x7528;&#x5904;&#x6211;&#x4EEC;&#x80FD;&#x770B;&#x89C1;&#xFF0C;&#x5728;&#x6267;&#x884C;&#x5B8C; <code>http_parser_execute()</code> &#x540E;&#x6709;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#xFF0C;&#x82E5;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x4E0D;&#x662F; <code>upgrade</code> &#x8BF7;&#x6C42;&#xFF08;&#x5373;&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x6709;&#x8BF4;&#x660E; <code>Upgrade</code>&#xFF0C;&#x901A;&#x5E38;&#x7528;&#x4E8E; WebSocket&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x89E3;&#x6790;&#x957F;&#x5EA6;&#x4E0D;&#x7B49;&#x4E8E;&#x539F;&#x6570;&#x636E;&#x5305;&#x957F;&#x5EA6;&#xFF08;&#x524D;&#x6587;&#x8BF4;&#x4E86;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5C5E;&#x4E8E;&#x51FA;&#x9519;&#x4E86;&#xFF09;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x8FDB;&#x5165;&#x4E2D;&#x95F4;&#x7684;&#x9519;&#x8BEF;&#x4EE3;&#x7801;&#x5757;&#x3002;</p>
<p>&#x5728;&#x9519;&#x8BEF;&#x4EE3;&#x7801;&#x5757;&#x4E2D;&#xFF0C;&#x5148; <code>HTTP_PARSER_ERRNO(&amp;parser_)</code> &#x62FF;&#x5230;&#x9519;&#x8BEF;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7; <code>Exception::Error()</code> &#x751F;&#x6210;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#xFF0C;&#x5C06;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x585E;&#x8FDB;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#x4E2D;&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6CA1;&#x9519;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x89E3;&#x6790;&#x957F;&#x5EA6;&#xFF08;<code>nparsed_obj</code> &#x5373; <code>nparsed</code>&#xFF09;&#x3002;</p>
<blockquote>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x773C;&#x5C16;&#x7684;&#x7AE5;&#x978B;&#x53EF;&#x80FD;&#x53D1;&#x73B0;&#x4E86;&#xFF0C;&#x6267;&#x884C; <code>Execute()</code> &#x6709;&#x597D;&#x591A;&#x5904;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x5B9E;&#x9645;&#x4E0A;&#x4E00;&#x4E2A; HTTP &#x8BF7;&#x6C42;&#x53EF;&#x80FD;&#x662F;&#x6D41;&#x5F0F;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x65F6;&#x5019;&#x53EF;&#x80FD;&#x4F1A;&#x53EA;&#x62FF;&#x5230;&#x90E8;&#x5206;&#x6570;&#x636E;&#x5305;&#x3002;&#x6240;&#x4EE5;&#x6700;&#x540E;&#x6709;&#x4E00;&#x4E2A;&#x7ED3;&#x675F;&#x7B26;&#x9700;&#x8981;&#x88AB;&#x786E;&#x8BA4;&#x3002;<strong>&#x8FD9;&#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48; http-parser &#x5728;&#x89E3;&#x6790;&#x7684;&#x65F6;&#x5019;&#x53EA;&#x80FD;&#x9010;&#x5B57;&#x89E3;&#x6790;&#x800C;&#x4E0D;&#x80FD;&#x8DF3;&#x8DC3;&#x6216;&#x8005;&#x540E;&#x9000;&#x4E86;&#x3002;</strong></p>
</blockquote>
<h3 id="&#x56DE;&#x5230;-http-server-js"><a href="#&#x56DE;&#x5230;-http-server-js" class="headerlink" title="&#x56DE;&#x5230; _http_server.js"></a>&#x56DE;&#x5230; _http_server.js</h3><p>&#x6211;&#x4EEC;&#x628A; <code>Parser::Execute()</code> &#x4E5F;&#x5C31;&#x662F; JavaScript &#x4EE3;&#x7801;&#x4E2D;&#x7684; <code>parser.execute()</code> &#x7ED9;&#x641E;&#x6E05;&#x695A;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x56DE;&#x5230; <a href="/external_links/0c943f140f1b0ef05f96601694eb5702.html" target="blank" rel="noopener">_http_server.js</a> &#x770B;&#x4EE3;&#x7801;&#x4E86;&#x3002;</p>
<p>&#x524D;&#x6587;&#x8BF4;&#x4E86;&#xFF0C;<code>socketOnData</code> &#x5728;&#x89E3;&#x6790;&#x5B8C;&#x6570;&#x636E;&#x5305;&#x540E;&#x4F1A;&#x6267;&#x884C; <code>onParserExecuteCommon</code> &#x51FD;&#x6570;&#xFF0C;&#x73B0;&#x5728;&#x5C31;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E2A; <code>onParserExecuteCommon()</code> &#x51FD;&#x6570;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;function onParserExecuteCommon(server, socket, parser, state, ret, d) {</span><br><span class="line">  resetSocketTimeout(server, socket, state);</span><br><span class="line"></span><br><span class="line">  if (ret instanceof Error) {</span><br><span class="line">    debug(&apos;parse error&apos;, ret);</span><br><span class="line">    socketOnError.call(socket, ret);</span><br><span class="line">  } else if (parser.incoming &amp;&amp; parser.incoming.upgrade) {</span><br><span class="line">    ...</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x957F;&#x957F;&#x7684;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x6211;&#x7CBE;&#x7B80;&#x6210;&#x8FD9;&#x4E48;&#x51E0;&#x53E5;&#x8BDD;&#xFF0C;&#x91CD;&#x70B9;&#x5F88;&#x660E;&#x663E;&#x3002;<code>ret</code> &#x5C31;&#x662F;&#x4ECE; <code>socketOnData</code> &#x4F20;&#x8FDB;&#x6765;&#x5DF2;&#x89E3;&#x6790;&#x7684;&#x6570;&#x636E;&#x957F;&#x5EA6;&#xFF0C;&#x4F46;&#x662F;&#x5728; C++ &#x4EE3;&#x7801;&#x4E2D;&#x6211;&#x4EEC;&#x4E5F;&#x770B;&#x5230;&#x4E86;&#x5B83;&#x8FD8;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#x3002;&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E2D;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#xFF0C;&#x5224;&#x65AD;&#x89E3;&#x6790;&#x7684;&#x7ED3;&#x679C;&#x662F;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#x5219;&#x8C03;&#x7528; <code>socketOnError()</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;function socketOnError(e) {</span><br><span class="line">  // Ignore further errors</span><br><span class="line">  this.removeListener(&apos;error&apos;, socketOnError);</span><br><span class="line">  this.on(&apos;error&apos;, () =&gt; {});</span><br><span class="line"></span><br><span class="line">  if (!this.server.emit(&apos;clientError&apos;, e, this))</span><br><span class="line">    this.destroy(e);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#xFF0C;&#x5982;&#x679C;&#x771F;&#x7684;&#x4E0D;&#x5C0F;&#x5FC3;&#x8D70;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#x7684;&#x8BDD;&#xFF0C;HTTP Server &#x5BF9;&#x8C61;&#x4F1A;&#x89E6;&#x53D1;&#x4E00;&#x4E2A; <code>clientError</code> &#x4E8B;&#x4EF6;&#x3002;</p>
<p>&#x6574;&#x4E2A;&#x4E8B;&#x60C5;&#x4E32;&#x8054;&#x8D77;&#x6765;&#x4E86;&#xFF1A;</p>
<ul>
<li>&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x540E;&#x4F1A;&#x901A;&#x8FC7; http-parser &#x89E3;&#x6790;&#x6570;&#x636E;&#x5305;&#xFF1B;</li>
<li><code>GET /foo bar HTTP/1.1</code> &#x4F1A;&#x88AB;&#x89E3;&#x6790;&#x51FA;&#x9519;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#xFF1B;</li>
<li>&#x9519;&#x8BEF;&#x5BF9;&#x8C61;&#x4F1A;&#x8FDB;&#x5165; <code>if (ret instanceof Error)</code> &#x6761;&#x4EF6;&#x5206;&#x652F;&#x5E76;&#x8C03;&#x7528; <code>socketOnError()</code> &#x51FD;&#x6570;&#xFF1B;</li>
<li><code>socketOnError()</code> &#x51FD;&#x6570;&#x4E2D;&#x4F1A;&#x5BF9;&#x670D;&#x52A1;&#x5668;&#x89E6;&#x53D1;&#x4E00;&#x4E2A; <code>clientError</code> &#x4E8B;&#x4EF6;&#xFF1B;&#xFF08;<code>this.server.emit(&apos;clientError&apos;, e, this)</code>&#xFF09;</li>
<li><strong>&#x81F3;&#x6B64;&#xFF0C;HTTP Server &#x5E76;&#x4E0D;&#x4F1A;&#x8D70;&#x5230;&#x4F60;&#x7684;&#x90A3;&#x4E2A; <code>function(req, resp)</code> &#x4E2D;&#x53BB;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x6709;&#x4EFB;&#x4F55;&#x7684;&#x6570;&#x636E;&#x88AB;&#x8FD4;&#x56DE;&#x5C31;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x89E3;&#x7B54;&#x4E86;&#x4E00;&#x5F00;&#x59CB;&#x7684;&#x95EE;&#x9898;&#x2014;&#x2014;&#x6536;&#x4E0D;&#x5230;&#x4EFB;&#x4F55;&#x6570;&#x636E;&#x5C31;&#x8BF7;&#x6C42;&#x7ED3;&#x675F;&#x3002;</strong></li>
</ul>
<p>&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x8981;&#x9010;&#x7EA7;&#x8FDB;&#x6765;&#x770B;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x8FBE; http-parser &#x7684;&#x539F;&#x56E0;&#x4E86;&#x2014;&#x2014;<code>clientError</code> &#x662F;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x3002;</p>
<h2 id="&#x5904;&#x7406;&#x529E;&#x6CD5;"><a href="#&#x5904;&#x7406;&#x529E;&#x6CD5;" class="headerlink" title="&#x5904;&#x7406;&#x529E;&#x6CD5;"></a>&#x5904;&#x7406;&#x529E;&#x6CD5;</h2><p>&#x8981;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x201C;Bug&#x201D;&#x5176;&#x5B9E;&#x4E0D;&#x96BE;&#xFF0C;&#x76F4;&#x63A5;&#x76D1;&#x542C; <a href="/external_links/af2eec066b5c5ba2e44799e2c4f5b617.html" target="blank" rel="noopener"><code>clientError</code> &#x4E8B;&#x4EF6;</a>&#x5E76;&#x505A;&#x4E00;&#x4E9B;&#x5904;&#x7406;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">js&#x590D;&#x5236;&#x4EE3;&#x7801;&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">const server = http.createServer(function(req, resp) {</span><br><span class="line">    console.log(&apos;&#x1F31A;&apos;);</span><br><span class="line">    resp.end(&apos;hello world&apos;);</span><br><span class="line">}).on(&apos;clientError&apos;, function(err, sock) {</span><br><span class="line">    console.log(&apos;&#x1F437;&apos;);</span><br><span class="line">    sock.end(&apos;HTTP/1.1 400 Bad Request\r\n\r\n&apos;);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.listen(5555);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>**&#x6CE8;&#x610F;&#xFF1A;**&#x7531;&#x4E8E;&#x8FD0;&#x884C;&#x5230; <code>clientError</code> &#x4E8B;&#x4EF6;&#x65F6;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4EFB;&#x4F55; Request &#x548C; Response &#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x4F60;&#x80FD;&#x62FF;&#x5230;&#x7684;&#x662F;&#x4E00;&#x4E2A; Node.js &#x4E2D;&#x539F;&#x59CB;&#x7684; Socket &#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;&#x4F60;&#x8981;&#x8FD4;&#x56DE;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x6309;&#x7167; HTTP &#x8FD4;&#x56DE;&#x6570;&#x636E;&#x5305;&#x7684;&#x683C;&#x5F0F;&#x6765;&#x8F93;&#x51FA;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x518D;&#x6325;&#x8D77;&#x4F60;&#x7684;&#x5C0F;&#x624B;&#x8BD5;&#x4E00;&#x4E0B; CURL &#x5427;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">perl&#x590D;&#x5236;&#x4EE3;&#x7801;$ curl &apos;http://127.0.0.1:5555/d d&apos; -v</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 5555 (#0)</span><br><span class="line">&gt; GET /d d HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:5555</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 400 Bad Request</span><br><span class="line">* no chunk, no close, no size. Assume close to signal end</span><br><span class="line">&lt;</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>

<p>&#x5982;&#x613F;&#x4EE5;&#x507F;&#x5730;&#x8F93;&#x51FA;&#x4E86; 400 &#x72B6;&#x6001;&#x7801;&#x3002;</p>
<h2 id="&#x5F15;&#x7533;"><a href="#&#x5F15;&#x7533;" class="headerlink" title="&#x5F15;&#x7533;"></a>&#x5F15;&#x7533;</h2><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x8981;&#x5F15;&#x7533;&#x8BA8;&#x8BBA;&#x7684;&#x4E00;&#x4E2A;&#x70B9;&#x662F;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x8D27;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x771F;&#x6B63;&#x610F;&#x4E49;&#x4E0A;&#x7684; Bug&#x3002;</p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x770B;&#x770B; Nginx &#x8FD9;&#x4E48;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x9ED1;&#x79D1;&#x6280;&#x7684;&#x5427;&#x3002;</p>
<h3 id="Nginx-&#x5B9E;&#x73B0;"><a href="#Nginx-&#x5B9E;&#x73B0;" class="headerlink" title="Nginx &#x5B9E;&#x73B0;"></a>Nginx &#x5B9E;&#x73B0;</h3><p>&#x6253;&#x5F00; Nginx &#x6E90;&#x7801;&#x7684;<a href="/external_links/ed47d928056a11ec8b8972cf43676c82.html" target="blank" rel="noopener">&#x76F8;&#x5E94;&#x4F4D;&#x7F6E;</a>&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x80FD;&#x770B;&#x5230;&#x5B83;&#x7684;&#x72B6;&#x6001;&#x673A;&#x5BF9;&#x4E8E; URI &#x548C; HTTP &#x534F;&#x8BAE;&#x58F0;&#x660E;&#x4E2D;&#x95F4;&#x591A;&#x4E86;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x72B6;&#x6001;&#xFF0C;&#x53EB; <code>sw_check_uri_http_09</code>&#xFF0C;&#x4E13;&#x95E8;&#x5904;&#x7406; URI &#x540E;&#x9762;&#x7684;&#x7A7A;&#x683C;&#x3002;</p>
<p>&#x5728;&#x5404;&#x79CD; URI &#x89E3;&#x6790;&#x72B6;&#x6001;&#x4E2D;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x90FD;&#x80FD;&#x627E;&#x5230;&#x8FD9;&#x4E48;&#x4E00;&#x53E5;&#x8BDD;&#xFF0C;&#x8868;&#x793A;&#x82E5;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x6B63;&#x5219;&#x89E3;&#x6790; URI &#x7684;&#x5404;&#x79CD;&#x72B6;&#x6001;&#x5E76;&#x4E14;&#x9047;&#x5230;&#x7A7A;&#x683C;&#x7684;&#x8BDD;&#xFF0C;&#x5219;&#x5C06;&#x72B6;&#x6001;&#x6539;&#x4E3A; <code>sw_check_uri_http_09</code>&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;case sw_check_uri:</span><br><span class="line">  switch (ch) {</span><br><span class="line">  case &apos; &apos;:</span><br><span class="line">    r-&gt;uri_end = p;</span><br><span class="line">    state = sw_check_uri_http_09;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>&#x7136;&#x540E;&#x5728; <code>sw_check_uri_http_09</code> &#x72B6;&#x6001;&#x65F6;&#x4F1A;&#x505A;&#x4E00;&#x4E9B;&#x68C0;&#x67E5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">c&#x590D;&#x5236;&#x4EE3;&#x7801;case sw_check_uri_http_09:</span><br><span class="line">    switch (ch) {</span><br><span class="line">    case &apos; &apos;:</span><br><span class="line">        break;</span><br><span class="line">    case CR:</span><br><span class="line">        r-&gt;http_minor = 9;</span><br><span class="line">        state = sw_almost_done;</span><br><span class="line">        break;</span><br><span class="line">    case LF:</span><br><span class="line">        r-&gt;http_minor = 9;</span><br><span class="line">        goto done;</span><br><span class="line">    case &apos;H&apos;:</span><br><span class="line">        r-&gt;http_protocol.data = p;</span><br><span class="line">        state = sw_http_H;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        r-&gt;space_in_uri = 1;</span><br><span class="line">        state = sw_check_uri;</span><br><span class="line">        p--;</span><br><span class="line">        break;</span><br><span class="line">    }</span><br><span class="line">    break;</span><br></pre></td></tr></table></figure>

<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<ul>
<li>&#x9047;&#x5230;&#x7A7A;&#x683C;&#x5219;&#x7EE7;&#x7EED;&#x4FDD;&#x6301;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x5F00;&#x59CB;&#x626B;&#x63CF;&#x4E0B;&#x4E00;&#x4F4D;&#xFF1B;</li>
<li>&#x5982;&#x679C;&#x662F;&#x6362;&#x884C;&#x7B26;&#x5219;&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4; HTTP &#x7248;&#x672C;&#x5E76;&#x7EE7;&#x7EED;&#x626B;&#x63CF;&#xFF1B;</li>
<li>&#x5982;&#x679C;&#x9047;&#x5230;&#x7684;&#x662F; <code>H</code> &#x624D;&#x4FEE;&#x6539;&#x72B6;&#x6001;&#x4E3A; <code>sw_http_H</code> &#x8BA4;&#x4E3A;&#x63A5;&#x4E0B;&#x53BB;&#x5F00;&#x59CB; HTTP &#x7248;&#x672C;&#x626B;&#x63CF;&#xFF1B;</li>
<li>&#x5982;&#x679C;&#x662F;&#x5176;&#x5B83;&#x5B57;&#x7B26;&#xFF0C;&#x5219;&#x6807;&#x660E;&#x4E00;&#x4E0B; URI &#x4E2D;&#x6709;&#x7A7A;&#x683C;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x72B6;&#x6001;&#x6539;&#x56DE; <code>sw_check_uri</code>&#xFF0C;&#x7136;&#x540E;&#x5012;&#x9000;&#x56DE;&#x4E00;&#x683C;&#x4EE5; <code>sw_check_uri</code> &#x7EE7;&#x7EED;&#x626B;&#x63CF;&#x5F53;&#x524D;&#x7684;&#x7A7A;&#x683C;&#x3002;</li>
</ul>
<p>&#x5728;&#x7406;&#x89E3;&#x4E86;&#x8FD9;&#x4E2A;&#x201C;&#x9ED1;&#x79D1;&#x6280;&#x201D;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5F88;&#x5FEB;&#x80FD;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x73A9;&#x7684;&#x70B9;&#xFF0C;&#x5F00;&#x542F;&#x4F60;&#x7684; Nginx &#x5E76;&#x7528; CURL &#x8BF7;&#x6C42;&#x4EE5;&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E00;&#x4E0B;&#x5B83;&#x770B;&#x770B;&#x5427;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">xml&#x590D;&#x5236;&#x4EE3;&#x7801;$ curl &apos;http://xcoder.in:5555/d H&apos; -v</span><br><span class="line">*   Trying 103.238.225.181...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to xcoder.in (103.238.225.181) port 5555 (#0)</span><br><span class="line">&gt; GET /d H HTTP/1.1</span><br><span class="line">&gt; Host: xcoder.in:5555</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 400 Bad Request</span><br><span class="line">&lt; Server: openresty/1.11.2.1</span><br><span class="line">&lt; Date: Tue, 12 Dec 2017 11:18:13 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 179</span><br><span class="line">&lt; Connection: close</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;openresty/1.11.2.1&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>

<p>&#x600E;&#x4E48;&#x6837;&#xFF1F;&#x662F;&#x4E0D;&#x662F;&#x53D1;&#x73B0;&#x7ED3;&#x679C;&#x8DDF;&#x4E4B;&#x524D;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#x4E86;&#x2014;&#x2014;&#x5B83;&#x5C45;&#x7136;&#x4E5F;&#x8FD4;&#x56DE;&#x4E86; 400 Bad Request&#x3002;</p>
<p>&#x539F;&#x56E0;&#x4E3A;&#x4F55;&#x5C31;&#x4EA4;&#x7ED9;&#x7AE5;&#x978B;&#x4EEC;&#x81EA;&#x5DF1;&#x8003;&#x8651;&#x5427;&#x3002;</p>
<h3 id="RFC-2616-&#x4E0E;-RFC-2396"><a href="#RFC-2616-&#x4E0E;-RFC-2396" class="headerlink" title="RFC 2616 &#x4E0E; RFC 2396"></a>RFC 2616 &#x4E0E; RFC 2396</h3><p>&#x90A3;&#x4E48;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x5373;&#x4F7F;&#x5728; Nginx &#x652F;&#x6301;&#x7A7A;&#x683C; URI &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x8FD8;&#x8BF4; Node.js &#x8FD9;&#x4E2A;&#x4E0D;&#x7B97; Bug&#xFF0C;&#x5E76;&#x4E14;&#x6307;&#x660E; Nginx &#x662F;&#x201C;&#x9ED1;&#x79D1;&#x6280;&#x201D;&#x5462;&#xFF1F;</p>
<p>&#x540E;&#x6765;&#x6211;&#x53BB;&#x770B;&#x4E86; HTTP &#x534F;&#x8BAE; RFC&#x3002;</p>
<p>&#x539F;&#x56E0;&#x5728;&#x4E8E; Network Working Group &#x7684; <a href="/external_links/1957bcdfebd486b9e0b0c924d317ef06.html" target="blank" rel="noopener">RFC 2616</a>&#xFF0C;&#x5173;&#x4E8E; HTTP &#x534F;&#x8BAE;&#x7684;&#x89C4;&#x8303;&#x3002;</p>
<p>&#x5728; RFC 2616 &#x7684; <a href="/external_links/77e3c7f5d513590f66d6404c6f9f2178.html" target="blank" rel="noopener">3.2.1 &#x8282;</a>&#x4E2D;&#x505A;&#x4E86;&#x4E00;&#x4E9B;&#x8BF4;&#x660E;&#xFF0C;&#x5B83;&#x8BF4;&#x4E86;&#x5728; HTTP &#x534F;&#x8BAE;&#x4E2D;&#x5173;&#x4E8E; URI &#x7684;&#x6587;&#x6CD5;&#x548C;&#x8BED;&#x4E49;&#x53C2;&#x7167;&#x4E86; <a href="/external_links/d14a4429195a3f2198d020ce8a68697a.html" target="blank" rel="noopener">RFC 2396</a>&#x3002;</p>
<blockquote>
<p>URIs in HTTP can be represented in absolute form or relative to some known base URI, depending upon the context of their use. The two forms are differentiated by the fact that absolute URIs always begin with a scheme name followed by a colon. For definitive information on URL syntax and semantics, see &#x201C;Uniform Resource Identifiers (URI): Generic Syntax and Semantics,&#x201D; RFC 2396 (which replaces RFCs 1738 and RFC 1808). This specification adopts the definitions of &#x201C;URI-reference&#x201D;, &#x201C;absoluteURI&#x201D;, &#x201C;relativeURI&#x201D;, &#x201C;port&#x201D;, &#x201C;host&#x201D;,&#x201D;abs_path&#x201D;, &#x201C;rel_path&#x201D;, and &#x201C;authority&#x201D; from that specification.</p>
</blockquote>
<p>&#x800C;&#x5728; <a href="/external_links/d14a4429195a3f2198d020ce8a68697a.html" target="blank" rel="noopener">RFC 2396</a> &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x540C;&#x6837;&#x627E;&#x5230;&#x4E86;&#x5B83;&#x7684; <a href="/external_links/d14a4429195a3f2198d020ce8a68697a.html" target="blank" rel="noopener">2.4.3 &#x8282;</a>&#x3002;&#x91CC;&#x9762;&#x5BF9;&#x4E8E; Disallow &#x7684; US-ASCII &#x5B57;&#x7B26;&#x505A;&#x4E86;&#x89E3;&#x91CA;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#xFF1A;</p>
<ul>
<li>&#x63A7;&#x5236;&#x7B26;&#xFF0C;&#x6307; ASCII &#x7801;&#x5728; 0x00-0x1F &#x8303;&#x56F4;&#x5185;&#x4EE5;&#x53CA; 0x7F&#xFF1B;</li>
</ul>
<p>&#x63A7;&#x5236;&#x7B26;&#x901A;&#x5E38;&#x4E0D;&#x53EF;&#x89C1;&#xFF1B;</p>
<ul>
<li>&#x7A7A;&#x683C;&#xFF0C;&#x6307; 0x20&#xFF1B;</li>
</ul>
<p>&#x7A7A;&#x683C;&#x4E0D;&#x53EF;&#x63A7;&#xFF0C;&#x5982;&#x7ECF;&#x7531;&#x4E00;&#x4E9B;&#x6392;&#x7248;&#x8F6F;&#x4EF6;&#x8F6C;&#x5F55;&#x540E;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x53D8;&#x5316;&#xFF0C;&#x800C;&#x5230;&#x4E86; HTTP &#x534F;&#x8BAE;&#x8FD9;&#x5C42;&#x65F6;&#xFF0C;&#x53CD;&#x6B63;&#x7A7A;&#x683C;&#x4E0D;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x7D22;&#x6027;&#x7528;&#x7A7A;&#x683C;&#x4F5C;&#x4E3A;&#x9996;&#x884C;&#x5206;&#x9694;&#x7B26;&#x4E86;&#xFF1B;</p>
<ul>
<li>&#x5206;&#x9694;&#x7B26;&#xFF0C;<code>&quot;&lt;&quot;</code>&#x3001;<code>&quot;&gt;&quot;</code>&#x3001;<code>&quot;#&quot;</code>&#x3001;<code>&quot;%&quot;</code>&#x3001;<code>&quot;\&quot;&quot;</code>&#x3002;</li>
</ul>
<p>&#x5982; <code>#</code> &#x5C06;&#x7528;&#x4E8E;&#x6D4F;&#x89C8;&#x5668;&#x5730;&#x5740;&#x680F;&#x7684; Hash&#xFF1B;&#x800C; <code>%</code> &#x5219;&#x4F1A;&#x4E0E; URI &#x8F6C;&#x4E49;&#x4E00;&#x540C;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x5E94;&#x5355;&#x72EC;&#x51FA;&#x73B0;&#x5728; URI &#x4E2D;&#x3002;</p>
<p><strong>&#x4E8E;&#x662F;&#x4E4E;&#xFF0C;HTTP &#x8BF7;&#x6C42;&#x4E2D;&#xFF0C;&#x5305;&#x4F53;&#x7684; URI &#x4F3C;&#x4E4E;&#x672C;&#x5C31;&#x4E0D;&#x5E94;&#x8BE5;&#x51FA;&#x73B0;&#x7A7A;&#x683C;&#xFF0C;&#x800C; Nginx &#x662F;&#x4E00;&#x4E2A;&#x9ED1;&#x9B54;&#x6CD5;&#x7684;&#x59FF;&#x52BF;&#x3002;</strong></p>
<h2 id="&#x5C0F;&#x7ED3;"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</h2><p>&#x56AF;&#xFF0C;&#x5199;&#x5F97;&#x7D2F;&#x6B7B;&#x4E86;&#x3002;&#x672C;&#x6B21;&#x7684;&#x4E00;&#x4E2A;&#x63A2;&#x7D22;&#x57FA;&#x4E8E;&#x4E86;&#x4E00;&#x4E2A;&#x6709;&#x7A7A;&#x683C;&#x975E;&#x6B63;&#x5E38;&#x7684; URI &#x901A;&#x8FC7; CURL &#x6216;&#x8005;&#x5176;&#x5B83;&#x4E00;&#x4E9B;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;Node.js &#x51FA;&#x73B0;&#x7684; Bug &#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>&#x5B9E;&#x9645;&#x4E0A;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A; Bug &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x4F3C;&#x4E4E;&#x662F;&#x56E0;&#x4E3A;&#x90A3;&#x8FB9;&#x7684;&#x5F00;&#x53D1;&#x8005;&#x624B;&#x6296;&#xFF0C;&#x4E0D;&#x5C0F;&#x5FC3;&#x5C06;&#x4E0D;&#x5E94;&#x8BE5;&#x62FC;&#x63A5;&#x8FDB;&#x6765;&#x7684;&#x5185;&#x5BB9;&#x7ED9;&#x62FC;&#x63A5;&#x5230;&#x4E86; URL &#x4E2D;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E; <code>$ rm -rf /</code>&#x3002;</p>
</blockquote>
<p>&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x4EE5;&#x4E3A;&#x8FD9;&#x662F; Node.js &#x7684; Bug&#xFF0C;&#x5728;&#x63A2;&#x5BFB;&#x4E4B;&#x540E;&#x53D1;&#x73B0;&#x662F;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x6CA1;&#x7528; Node.js HTTP Server &#x63D0;&#x4F9B;&#x7684; <code>clientError</code> &#x4E8B;&#x4EF6;&#x505A;&#x6B63;&#x786E;&#x7684;&#x5904;&#x7406;&#x3002;&#x800C; Nginx &#x7684;&#x6B63;&#x5E38;&#x8BF7;&#x6C42;&#x5219;&#x662F;&#x5B83;&#x7684;&#x9ED1;&#x79D1;&#x6280;&#x3002;&#x8FD9;&#x4E9B;&#x7B54;&#x6848;&#x90FD;&#x80FD;&#x4ECE; RFC &#x4E2D;&#x5BFB;&#x627E;&#x2014;&#x2014;<strong>&#x518D;&#x6B21;&#x4F53;&#x73B0;&#x4E86;&#x9047;&#x5230;&#x95EE;&#x9898;&#x770B;&#x6E90;&#x7801;&#x770B;&#x89C4;&#x8303;&#x7684;&#x91CD;&#x8981;&#x6027;&#x3002;</strong></p>
<p>&#x53E6;&#xFF0C;&#x6211;&#x672C;&#x6253;&#x7B97;&#x7ED9; http-parser &#x4E5F;&#x52A0;&#x4E0A;&#x9ED1;&#x9B54;&#x6CD5;&#xFF0C;&#x540E;&#x6765;&#x6211;&#x5FEB;&#x5199;&#x597D;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x73B0;&#x5B83;&#x662F;&#x6D41;&#x5F0F;&#x7684;&#xFF0C;&#x5F88;&#x591A;&#x72B6;&#x6001;&#x6CA1;&#x6CD5;&#x5728;&#x73B0;&#x6709;&#x7684;&#x4F53;&#x7CFB;&#x4E2D;&#x4FDD;&#x7559;&#x4E0B;&#x6765;&#xFF0C;&#x6700;&#x540E;&#x653E;&#x5F03;&#x4E86;&#xFF0C;&#x53CD;&#x6B63;&#x8FD9;&#x4E5F;&#x4E0D;&#x7B97; Bug&#x3002;&#x4E0D;&#x8FC7;&#x5728;&#x4EE5;&#x540E;&#x6709;&#x65F6;&#x95F4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x611F;&#x89C9;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x597D;&#x597D;&#x6574;&#x7406;&#x4E00;&#x4E0B;&#x4EE3;&#x7801;&#xFF0C;&#x597D;&#x597D;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#x7ED9;&#x63D0;&#x4E2A; PR &#x4E0A;&#x53BB;&#xFF0C;&#x4EE5;&#x6B64;&#x81EA;&#x52C9;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x6C42; fafa&#x3002;</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p4/raw/master/img/0b887742e121ba06b2a501b9e85a55bfa84c9ab6374f4a7d3bc226f0a162423f" alt></p>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/8e7a41f77409815e75dbb42643ffbda5.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="tags/Node-js/" rel="tag"># Node.js</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="6844903522513747982.html" rel="next" title="从JDK源码看OutputStream">
                <i class="fa fa-chevron-left"></i> 从JDK源码看OutputStream
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="6844903521624522760.html" rel="prev" title="HTTP 代理服务器技术选型之旅 背景 代理服务器工作模型">
                HTTP 代理服务器技术选型之旅 背景 代理服务器工作模型 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


    <!-- 有瓣音频文章内嵌广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6145016388"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    <div class="post-spread">
      
    </div>
  </div>
  <!-- 有瓣音频信息流广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-6t+ed+2i-1n-4w" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6455528644"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">1775</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">725</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题抛出"><span class="nav-number">1.</span> <span class="nav-text">问题抛出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始重现"><span class="nav-number">2.</span> <span class="nav-text">开始重现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端-CURL-指令"><span class="nav-number">2.1.</span> <span class="nav-text">客户端 CURL 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最小-Node-js-源码"><span class="nav-number">2.2.</span> <span class="nav-text">最小 Node.js 源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx"><span class="nav-number">2.3.</span> <span class="nav-text">Nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node-js-源码排查"><span class="nav-number">3.</span> <span class="nav-text">Node.js 源码排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http-js-gt-http-server-js-gt-http-common-js"><span class="nav-number">3.1.</span> <span class="nav-text">http.js -&gt; _http_server.js -&gt; _http_common.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-http-parser-cc"><span class="nav-number">3.2.</span> <span class="nav-text">node_http_parser.cc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-parser"><span class="nav-number">3.3.</span> <span class="nav-text">http-parser</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-Request-数据包体"><span class="nav-number">3.3.1.</span> <span class="nav-text">HTTP Request 数据包体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码解析"><span class="nav-number">3.3.2.</span> <span class="nav-text">源码解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回到-node-http-parser-cc"><span class="nav-number">3.4.</span> <span class="nav-text">回到 node_http_parser.cc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回到-http-server-js"><span class="nav-number">3.5.</span> <span class="nav-text">回到 _http_server.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理办法"><span class="nav-number">4.</span> <span class="nav-text">处理办法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引申"><span class="nav-number">5.</span> <span class="nav-text">引申</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-实现"><span class="nav-number">5.1.</span> <span class="nav-text">Nginx 实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RFC-2616-与-RFC-2396"><span class="nav-number">5.2.</span> <span class="nav-text">RFC 2616 与 RFC 2396</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">6.</span> <span class="nav-text">小结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
