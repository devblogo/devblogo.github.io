<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="never">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Node.js,安全,Express,后端,">





  <link rel="alternate" href="atom.xml" title="开发者博客 – IT技术 尽在开发者博客" type="application/atom+xml">






<meta name="description" content="Express is a great way to build a web server using Node.js. It&amp;#x2019;s easy to get started with and allows you to configure and extend it easily thanks to its concept of middleware. While there are a">
<meta name="keywords" content="Node.js,安全,Express,后端">
<meta property="og:type" content="article">
<meta property="og:title" content="【英】 使用 helmet 库来保护你的 Express 网">
<meta property="og:url" content="https://dev.newban.cn/6844903516889169927.html">
<meta property="og:site_name" content="开发者博客 – IT技术 尽在开发者博客">
<meta property="og:description" content="Express is a great way to build a web server using Node.js. It&amp;#x2019;s easy to get started with and allows you to configure and extend it easily thanks to its concept of middleware. While there are a">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/6f1d1f9dd70f193a72b31fc247784d4834fa3b8d4a1576d1211b54d57852f3ec">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/25906dab13c251f8cfc9c550227902794165b6715e893e2154ee5767b5a94701">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/d6f6fb5c5864efdf53402bb123c91ca8d5245d5780b6cc3e9b2e009c492d935d">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/199e9a516346468ccfcc343287c4675a73f7fe54901ad068bf45df468d9e51b5">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/e5279360f844b8ed748ad7c146a8252607a12416c6e1b798ffb37d78a00cbd32">
<meta property="og:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/0c4d6e6eb7862b6631dbb52c2f73b711c41e4c9d237860b630151393892f4cea">
<meta property="og:updated_time" content="2024-04-29T07:27:31.043Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【英】 使用 helmet 库来保护你的 Express 网">
<meta name="twitter:description" content="Express is a great way to build a web server using Node.js. It&amp;#x2019;s easy to get started with and allows you to configure and extend it easily thanks to its concept of middleware. While there are a">
<meta name="twitter:image" content="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/6f1d1f9dd70f193a72b31fc247784d4834fa3b8d4a1576d1211b54d57852f3ec">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<!--谷歌广告验证代码-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-2626449904708114",
          enable_page_level_ads: true
     });
</script>
<!--谷歌广告验证代码-->



  <link rel="canonical" href="https://dev.newban.cn/6844903516889169927.html">





  <title>【英】 使用 helmet 库来保护你的 Express 网 | 开发者博客 – IT技术 尽在开发者博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">开发者博客 – IT技术 尽在开发者博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">开发者博客 – 科技是第一生产力</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="http://dev.newban.cn/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="https://dev.newban.cn/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dev.newban.cn">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="开发者博客">
      <meta itemprop="description" content>
      <meta itemprop="image" content="images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="开发者博客 – IT技术 尽在开发者博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">【英】 使用 helmet 库来保护你的 Express 网</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-27T14:26:27+08:00">
                2017-11-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="/external_links/4ed5922eb818b953fc6e20d667e67b46.html" target="blank" rel="noopener">Express</a> is a great way to build a web server using <a href="/external_links/d85a99338b8814ad95a7d155affb699c.html" target="blank" rel="noopener">Node.js</a>. It&#x2019;s easy to get started with and allows you to configure and extend it easily thanks to its concept of middleware.<br> While there are a <a href="/external_links/5506f3d87b4e2a889ab3ec8b2b27237c.html" target="blank" rel="noopener">variety of frameworks to create web applications</a> in Node.js, my first choice is always Express. However, out of the box Express<br> doesn&#x2019;t adhere to all security best practices. Let&#x2019;s look at how we can use modules like <a href="/external_links/051474e053754afd0d69e559ea5a2d6e.html" target="blank" rel="noopener"><code>helmet</code></a>  to improve the security of an application.</p>
<h3 id="Set-Up"><a href="#Set-Up" class="headerlink" title="Set Up"></a>Set Up</h3><p>Before we get started make sure you have Node.js and npm (or yarn) installed. You can find the <a href="/external_links/6b8b4efc7defcb0fc1edb85964cd4557.html" target="blank" rel="noopener">download and installation instructions on the Node.js website</a>.</p>
<p>We&#x2019;ll work on a new project but you can also apply these features to your existing project.</p>
<p>Start a new project in your command line by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;mkdir secure-express-demo</span><br><span class="line">cd secure-express-demo</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure>

<p>Install the Express module by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;npm install express --save</span><br></pre></td></tr></table></figure>

<p>Create a new file called <code>index.js</code> in the <code>secure-express-demo</code> folder and add the following lines:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const PORT = process.env.PORT || 3000;</span><br><span class="line">const app = express();</span><br><span class="line">&#xA0;</span><br><span class="line">app.get(&apos;/&apos;, (req, res) =&gt; {</span><br><span class="line">&#xA0;&#xA0;res.send(`&lt;h1&gt;Hello World&lt;/h1&gt;`);</span><br><span class="line">});</span><br><span class="line">&#xA0;</span><br><span class="line">app.listen(PORT, () =&gt; {</span><br><span class="line">&#xA0;&#xA0;console.log(`Listening on http://localhost:${PORT}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>Save the file and let&#x2019;s see if everything is working. Start the server by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;node index.js</span><br></pre></td></tr></table></figure>

<p>Navigate to <a href="/external_links/87a70ce46ea04de7c28dd1e4da31904c.html" target="blank" rel="noopener">http://localhost:3000</a> and you should be greeted with <code>Hello World</code>.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/6f1d1f9dd70f193a72b31fc247784d4834fa3b8d4a1576d1211b54d57852f3ec" alt="hello-world.png"></p>
<h3 id="Inspecting-the-Headers"><a href="#Inspecting-the-Headers" class="headerlink" title="Inspecting the Headers"></a>Inspecting the Headers</h3><p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/25906dab13c251f8cfc9c550227902794165b6715e893e2154ee5767b5a94701" alt="giphy.gif"></p>
<p>We&#x2019;ll start by adding and removing a few HTTP headers that will help improve our security. To inspect these headers you can use a tool like <code>curl</code> by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;curl http://localhost:3000 --include</span><br></pre></td></tr></table></figure>

<p>The <code>--include</code> flag makes sure to print out the HTTP headers of the response. If you don&#x2019;t have <code>curl</code> installed you can also use your favorite browser developer tools and the networking pane.</p>
<p>At the moment you should see the following HTTP headers being transmitted in the response:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;HTTP/1.1 200 OK</span><br><span class="line">X-Powered-By: Express</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 20</span><br><span class="line">ETag: W/&quot;14-SsoazAISF4H46953FT6rSL7/tvU&quot;</span><br><span class="line">Date: Wed, 01 Nov 2017 13:36:10 GMT</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>One header that you should keep an eye on is <code>X-Powered-By</code>. Generally speaking headers that start with <code>X-</code> are non-standard headers. This one gives away which framework you are using. For an attacker, this cuts the attack space<br> down for them as they can concentrate on the known vulnerabilities in that framework.</p>
<h3 id="Putting-the-helmet-on"><a href="#Putting-the-helmet-on" class="headerlink" title="Putting the helmet on"></a>Putting the helmet on</h3><p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/d6f6fb5c5864efdf53402bb123c91ca8d5245d5780b6cc3e9b2e009c492d935d" alt="giphy.gif"></p>
<p>Let&#x2019;s see what happens if we start using <code>helmet</code>. Install <code>helmet</code> by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;npm install helmet --save</span><br></pre></td></tr></table></figure>

<p>Now add the <code>helmet</code> middleware to your application. Modify the <code>index.js</code> accordingly:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const helmet = require(&apos;helmet&apos;);</span><br><span class="line">const PORT = process.env.PORT || 3000;</span><br><span class="line">const app = express();</span><br><span class="line">&#xA0;</span><br><span class="line">app.use(helmet());</span><br><span class="line">&#xA0;</span><br><span class="line">app.get(&apos;/&apos;, (req, res) =&gt; {</span><br><span class="line">&#xA0;&#xA0;res.send(`&lt;h1&gt;Hello World&lt;/h1&gt;`);</span><br><span class="line">});</span><br><span class="line">&#xA0;</span><br><span class="line">app.listen(PORT, () =&gt; {</span><br><span class="line">&#xA0;&#xA0;console.log(`Listening on http://localhost:${PORT}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>This is using the default configuration of <code>helmet</code>. Let&#x2019;s take a look at what it actually does. Restart the server and inspect the HTTP headers again by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;curl http://localhost:3000 --inspect</span><br></pre></td></tr></table></figure>

<p>The new headers should look something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;HTTP/1.1 200 OK</span><br><span class="line">X-DNS-Prefetch-Control: off</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Strict-Transport-Security: max-age=15552000; includeSubDomains</span><br><span class="line">X-Download-Options: noopen</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 20</span><br><span class="line">ETag: W/&quot;14-SsoazAISF4H46953FT6rSL7/tvU&quot;</span><br><span class="line">Date: Wed, 01 Nov 2017 13:50:42 GMT</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>The <code>X-Powered-By</code> header is gone, which is a good start, but now we have a bunch of new headers. What are they all doing?</p>
<h4 id="X-DNS-Prefetch-Control"><a href="#X-DNS-Prefetch-Control" class="headerlink" title="X-DNS-Prefetch-Control"></a>X-DNS-Prefetch-Control</h4><p>This header isn&#x2019;t much of an added security benefit as much as an added privacy benefit. By setting the value to <code>off</code> it turns off the DNS lookups that the browser does for URLs in the page. The DNS lookups are done for performance improvements<br> and according to MDN they can <a href="/external_links/baa5a01ccd73f270b1619c0e76f569ea.html" target="blank" rel="noopener">improve the performance of loading images by 5% or more</a>. However this look up can make it appear like the user visited<br> things they never visited.</p>
<p>The default for this is <code>off</code> but if you care about the added performance benefit you can enable it by passing <code>{ dnsPrefetchControl: { allow: true }}</code> to the <code>helmet()</code> call.</p>
<h4 id="X-Frame-Options"><a href="#X-Frame-Options" class="headerlink" title="X-Frame-Options"></a>X-Frame-Options</h4><p><code>X-Frame-Options</code> allows you to control whether the page can be loaded in a frame like <code>&lt;frame/&gt;</code> <code>&lt;iframe/&gt;</code> or <code>&lt;object/&gt;</code>. Unless you really need to frame your page you should just disable<br> it entirely by passing the option to the <code>helmet()</code> call:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;app.use(helmet({</span><br><span class="line">&#xA0; frameguard: {</span><br><span class="line">&#xA0; &#xA0; action: &apos;deny&apos;</span><br><span class="line">&#xA0; }</span><br><span class="line">}));</span><br></pre></td></tr></table></figure>

<p><a href="/external_links/4ed653c049948fa153f2b83098279f7e.html" target="blank" rel="noopener"><code>X-Frame-Options</code> is supported by all modern browsers</a>. It can however also be controlled via a Content Security Policy as we&#x2019;ll see later.</p>
<h4 id="Strict-Transport-Security"><a href="#Strict-Transport-Security" class="headerlink" title="Strict-Transport-Security"></a>Strict-Transport-Security</h4><p>This is also known as HSTS (HTTP Strict Transport Security) and is used to ensure that there is no protocol downgrade when you are using HTTPS. If a user visited the website once on HTTPS it makes sure that the browser will not allow any future communication<br> via HTTP. This feature is helpful to avoid Man-In-The-Middle attacks.</p>
<p>You might have seen this feature in action if you tried to access a page like <a href="/external_links/99999ebcfdb78df077ad2727fd00969f.html" target="blank" rel="noopener">https://google.com</a> while being on a public WiFi with a captive portal. The WiFi is trying to redirect you to their captive portal but since you visited <code>google.com</code> before via HTTPS and it set the <code>Strict-Transport-Security</code> header, the browser will block this redirect.</p>
<p>You can read more about it on the <a href="/external_links/8404577735e94f1066395311d62b8662.html" target="blank" rel="noopener">MDN page</a> or the <a href="/external_links/b32fff8b85fbeb3612953109a9ac3acd.html" target="blank" rel="noopener">OWASP wiki page</a>.</p>
<h4 id="X-Download-Options"><a href="#X-Download-Options" class="headerlink" title="X-Download-Options"></a>X-Download-Options</h4><p>This header is only protecting you from an old IE security vulnerability. Basically if you host untrusted HTML files for download, users were able open these directly (rather than saving them to disk first) and they would execute in the context of<br> your app. This header ensures that users download files before they open them so that they can&#x2019;t execute in your app&#x2019;s security context.</p>
<p>You can find more information about this on the <a href="/external_links/8014f6549b4e65cfe0e208bb610d73ca.html" target="blank" rel="noopener">helmet page</a> and this <a href="/external_links/a7ad2c888fd818c55aca5803d619642e.html" target="blank" rel="noopener">MSDN blog post</a>.</p>
<h4 id="X-Content-Type-Options"><a href="#X-Content-Type-Options" class="headerlink" title="X-Content-Type-Options"></a>X-Content-Type-Options</h4><p>Some browsers perform &#x201C;MIME sniffing&#x201D; meaning that rather than loading things based on the <code>Content-Type</code> that the server will send, the browser will try to determine the content type based on the file content and execute it based on that.</p>
<p>Say your page offers a way to upload pictures and an attacker uploads some HTML instead, if the browser performs MIME sniffing, it could execute the code as HTML and the attacker would have performed a successful XSS attack.</p>
<p>By setting this header to <code>nosniff</code> we are disabling this MIME sniffing.</p>
<h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a>X-XSS-Protection</h4><p>This header is used to turn on basic XSS protections in the user&#x2019;s browser. It can&#x2019;t avoid every XSS opportunity but it can determine basic ones. For example, if it detects that the query string contains something like a script tag, the browser could<br> block the execution of the same code in the page knowing that it&#x2019;s likely an XSS attack. This header can have three different values. <code>0</code>, <code>1</code> and <code>1; mode=block</code>. If you want to learn more about which mode<br> you should choose, make sure to <a href="/external_links/38f0ba1b3f986a0687edfa1f54028925.html" target="blank" rel="noopener">check out this blog post about <code>X-XSS-Protection</code> and it&#x2019;s potential dangers</a>.</p>
<h4 id="Upgrading-your-helmet"><a href="#Upgrading-your-helmet" class="headerlink" title="Upgrading your helmet"></a>Upgrading your helmet</h4><p>These are just the default settings that <a href="/external_links/da60cc72719a5a0a2e82529d59c3c914.html" target="blank" rel="noopener"><code>helmet</code></a> provides. Additionally it allows you to configure headers like the <a href="/external_links/f6d77d6b1be0404a595cf2c1e7a51e21.html" target="blank" rel="noopener"><code>Expect-CT</code></a>,<br> <a href="/external_links/ec85229cb1c9245a30d7571203126c79.html" target="blank" rel="noopener"><code>Public-Key-Pins</code></a>, <a href="/external_links/0611c937774507fdf3466bfca190aeae.html" target="blank" rel="noopener"><code>Cache-Control</code></a> and <a href="/external_links/0b3b7a6e9f27fc4cc5f5b61a04c7b3e8.html" target="blank" rel="noopener"><code>Referrer-Policy</code></a>.<br> You can find more about the respective headers and how to configure them in the <a href="/external_links/da60cc72719a5a0a2e82529d59c3c914.html" target="blank" rel="noopener"><code>helmet</code> documentation</a>.</p>
<h3 id="Protecting-your-page-from-unwanted-content"><a href="#Protecting-your-page-from-unwanted-content" class="headerlink" title="Protecting your page from unwanted content"></a>Protecting your page from unwanted content</h3><p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/199e9a516346468ccfcc343287c4675a73f7fe54901ad068bf45df468d9e51b5" alt="giphy.gif"></p>
<p>Cross-site scripting is a constant threat to web applications. If an attacker can inject and run code in your application it can be a nightmare for you and your users. One solution that tries to stop the risk of unwanted code being executed on<br> your page is a <code>Content Security Policy</code> or <code>CSP</code>.</p>
<p>A CSP allows you to specify a set of rules that define the origins from which your page can load various resources. Any resource that violates these rules will be blocked by the browser automatically.</p>
<p>You can specify these rules via the <code>Content-Security-Policy</code> HTTP header but you can also set them in an HTML meta tag if you don&#x2019;t have a way to modify the HTTP headers.</p>
<p>This is what such a header might look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;Content-Security-Policy: default-src &apos;none&apos;;</span><br><span class="line">&#xA0; &#xA0; script-src &apos;nonce-XQY ZwBUm/WV9iQ3PwARLw==&apos;;</span><br><span class="line">&#xA0; &#xA0; style-src &apos;nonce-XQY ZwBUm/WV9iQ3PwARLw==&apos;;</span><br><span class="line">&#xA0; &#xA0; img-src &apos;self&apos;;</span><br><span class="line">&#xA0; &#xA0; font-src &apos;nonce-XQY ZwBUm/WV9iQ3PwARLw==&apos; fonts.gstatic.com;</span><br><span class="line">&#xA0; &#xA0; object-src &apos;none&apos;;</span><br><span class="line">&#xA0; &#xA0; block-all-mixed-content;</span><br><span class="line">&#xA0; &#xA0; frame-ancestors &apos;none&apos;;</span><br></pre></td></tr></table></figure>

<p>In this example you can see that for fonts we only allow them if they are from our own domain or from fonts.gstatic.com aka Google Fonts. Images we&#x2019;ll only allow from our own domain and not any external domain. For scripts and styles, however, we<br> only allow them if they have a certain <code>nonce</code>. This means we don&#x2019;t even care about the origin but we care about a very specific value. This nonce has to be specified in a way like below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;&lt;script src=&quot;myscript.js&quot; nonce=&quot;XQY ZwBUm/WV9iQ3PwARLw==&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;mystyles.css&quot; nonce=&quot;XQY ZwBUm/WV9iQ3PwARLw==&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>When the browser receives the HTML it will make sure to clear out the nonce for security purposes, so other scripts won&#x2019;t be able to access them to add additional unwanted scripts.</p>
<p>We are also disabling any mixed content meaning that HTTP content inside our HTTPS page is not permitted. Other things that we don&#x2019;t permit are any <code>&lt;object /&gt;</code> elements and anything that isn&#x2019;t an image, stylesheet<br> or script since the <code>default-src</code> is mapping to <code>none</code>. Additionally we are disabling iframing with the <code>frame-ancestors</code> value.</p>
<p>We could write these headers manually but luckily there are plenty of solutions to use CSP in Express. <a href="/external_links/213cf30350a4cc341c080cb409623253.html" target="blank" rel="noopener"><code>helmet</code> comes with support for CSP</a> but in the case of <code>nonce</code> it<br> forces you to generate them yourself. I&#x2019;m personally using a module called <code>express-csp-header</code> for this.</p>
<p>Install <code>express-csp-header</code> by running:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;npm install express-csp-header --save</span><br></pre></td></tr></table></figure>

<p>Consume and enable CSP by adding the following lines to your <code>index.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x590D;&#x5236;&#x4EE3;&#x7801;const express = require(&apos;express&apos;);</span><br><span class="line">const helmet = require(&apos;helmet&apos;);</span><br><span class="line">const csp = require(&apos;express-csp-header&apos;);</span><br><span class="line">&#xA0;</span><br><span class="line">const PORT = process.env.PORT || 3000;</span><br><span class="line">const app = express();</span><br><span class="line">&#xA0;</span><br><span class="line">const cspMiddleware = csp({</span><br><span class="line">&#xA0; policies: {</span><br><span class="line">&#xA0; &#xA0; &apos;default-src&apos;: [csp.NONE],</span><br><span class="line">&#xA0; &#xA0; &apos;script-src&apos;: [csp.NONCE],</span><br><span class="line">&#xA0; &#xA0; &apos;style-src&apos;: [csp.NONCE],</span><br><span class="line">&#xA0; &#xA0; &apos;img-src&apos;: [csp.SELF],</span><br><span class="line">&#xA0; &#xA0; &apos;font-src&apos;: [csp.NONCE, &apos;fonts.gstatic.com&apos;],</span><br><span class="line">&#xA0; &#xA0; &apos;object-src&apos;: [csp.NONE],</span><br><span class="line">&#xA0; &#xA0; &apos;block-all-mixed-content&apos;: true,</span><br><span class="line">&#xA0; &#xA0; &apos;frame-ancestors&apos;: [csp.NONE]</span><br><span class="line">&#xA0; }</span><br><span class="line">});</span><br><span class="line">&#xA0;</span><br><span class="line">app.use(helmet());</span><br><span class="line">app.use(cspMiddleware);</span><br><span class="line">&#xA0;</span><br><span class="line">app.get(&apos;/&apos;, (req, res) =&gt; {</span><br><span class="line">&#xA0; res.send(`</span><br><span class="line">&#xA0; &#xA0; &lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">&#xA0; &#xA0; &lt;style nonce=${req.nonce}&gt;</span><br><span class="line">&#xA0; &#xA0; &#xA0; .blue { background: cornflowerblue; color: white; }</span><br><span class="line">&#xA0; &#xA0; &lt;/style&gt;</span><br><span class="line">&#xA0; &#xA0; &lt;p class=&quot;blue&quot;&gt;This should have a blue background because of the loaded styles&lt;/p&gt;</span><br><span class="line">&#xA0; &#xA0; &lt;style&gt;</span><br><span class="line">&#xA0; &#xA0; &#xA0; .red { background: maroon; color: white; }</span><br><span class="line">&#xA0; &#xA0; &lt;/style&gt;</span><br><span class="line">&#xA0; &#xA0; &lt;p class=&quot;red&quot;&gt;This should not have a red background, the styles are not loaded because of the missing nonce.&lt;/p&gt;</span><br><span class="line">&#xA0; `);</span><br><span class="line">});</span><br><span class="line">&#xA0;</span><br><span class="line">app.listen(PORT, () =&gt; {</span><br><span class="line">&#xA0; console.log(`Listening on http://localhost:${PORT}`);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>

<p>Restart your server and navigate to <a href="/external_links/87a70ce46ea04de7c28dd1e4da31904c.html" target="blank" rel="noopener">http://localhost:3000</a> you should see one paragraph with a blue background because the styles have been loaded. The other paragraph is not styled because of the missing nonce.</p>
<p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/e5279360f844b8ed748ad7c146a8252607a12416c6e1b798ffb37d78a00cbd32" alt="csp-output.png"></p>
<p>The CSP header allows you also to specify a report URL that a violation report should be sent to and you can even execute CSP in report-only mode if you want to gather some data first before enforcing it strictly.</p>
<p>You can find more information about <a href="/external_links/0778f58a4d872d657f1d0a385d2fc9f6.html" target="blank" rel="noopener">CSP on the respective MDN page</a> and the <a href="/external_links/4ed653c049948fa153f2b83098279f7e.html" target="blank" rel="noopener">current browser support on the caniuse.com page</a> but<br> overall all major browsers support it.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><img src="https://gitee.com/songjianzaina/juejin_p5/raw/master/img/0c4d6e6eb7862b6631dbb52c2f73b711c41e4c9d237860b630151393892f4cea" alt="giphy.gif"></p>
<p>Unfortunately there is no silver bullet in security and new vulnerabilities constantly pop up but setting these HTTP headers in your web applications is easy to do and significantly improve your app&#x2019;s security. If you want to do a quick check of how<br> your HTTP headers hold up to security best practices, make sure to <a href="/external_links/a98eff7b5589f99a2a28f2b3587c8e58.html" target="blank" rel="noopener">check out securityheaders.io</a>.</p>
<p>If you want to learn more about web security best practices, make sure to <a href="/external_links/2fa21074142e0cd118def44fc23b7466.html" target="blank" rel="noopener">check out the Open Web Applications Security Project aka. OWASP</a>. It covers a wide selection of topics and links to additional<br> helpful resources.</p>
<p>If you have any questions or any other helpful tools to improve the security of your Node.js web applications, feel free to ping me:</p>
<ul>
<li>Twitter: <a href="/external_links/143485dbeaf2dd1f8b62a8c5f3c13a02.html" target="blank" rel="noopener">@dkundel</a></li>
<li>Email: <a href="/external_links/9271043bb4cd5a965a417e8bd6bacd38.html" target="blank" rel="noopener">dkundel@twilio.com</a></li>
<li>GitHub: <a href="/external_links/2abda60eb3918431b2e66ed3407e9f6a.html" target="blank" rel="noopener">dkundel</a></li>
</ul>
<p><strong>&#x672C;&#x6587;&#x8F6C;&#x8F7D;&#x81EA;:</strong> <a href="/external_links/69fcee097b9cc1053101c4bc746dc16c.html" target="blank" rel="noopener">&#x6398;&#x91D1;</a></p>
<p><em><a href="https://dev.newban.cn/">&#x5F00;&#x53D1;&#x8005;&#x535A;&#x5BA2; &#x2013; &#x548C;&#x5F00;&#x53D1;&#x76F8;&#x5173;&#x7684; &#x8FD9;&#x91CC;&#x5168;&#x90FD;&#x6709;</a></em></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="tags/Node-js-安全-Express-后端/" rel="tag"># Node.js,安全,Express,后端</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="6844903516889333774.html" rel="next" title="PHP 的 错误/异常 处理总结">
                <i class="fa fa-chevron-left"></i> PHP 的 错误/异常 处理总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="6844903516905930759.html" rel="prev" title="Laravel 中的简单工厂和抽象工厂">
                Laravel 中的简单工厂和抽象工厂 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


    <!-- 有瓣音频文章内嵌广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6145016388"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    <div class="post-spread">
      
    </div>
  </div>
  <!-- 有瓣音频信息流广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-6t+ed+2i-1n-4w" data-ad-client="ca-pub-2626449904708114" data-ad-slot="6455528644"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">开发者博客</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="https://dev.newban.cn/archives/">
              
                  <span class="site-state-item-count">3990</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1304</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Set-Up"><span class="nav-number">1.</span> <span class="nav-text">Set Up</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Inspecting-the-Headers"><span class="nav-number">2.</span> <span class="nav-text">Inspecting the Headers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Putting-the-helmet-on"><span class="nav-number">3.</span> <span class="nav-text">Putting the helmet on</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#X-DNS-Prefetch-Control"><span class="nav-number">3.1.</span> <span class="nav-text">X-DNS-Prefetch-Control</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-Frame-Options"><span class="nav-number">3.2.</span> <span class="nav-text">X-Frame-Options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Strict-Transport-Security"><span class="nav-number">3.3.</span> <span class="nav-text">Strict-Transport-Security</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-Download-Options"><span class="nav-number">3.4.</span> <span class="nav-text">X-Download-Options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-Content-Type-Options"><span class="nav-number">3.5.</span> <span class="nav-text">X-Content-Type-Options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-XSS-Protection"><span class="nav-number">3.6.</span> <span class="nav-text">X-XSS-Protection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Upgrading-your-helmet"><span class="nav-number">3.7.</span> <span class="nav-text">Upgrading your helmet</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protecting-your-page-from-unwanted-content"><span class="nav-number">4.</span> <span class="nav-text">Protecting your page from unwanted content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">5.</span> <span class="nav-text">Summary</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">开发者博客</span>
  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




  <script type="text/javascript" async src="js/src/mermaid.min.js"></script>
  <script>
  if (window.mermaid) {
        var mermaid_config = {
            startOnLoad: true,
            theme: 'default',
            flowchart:{
                useMaxWidth: false,
                htmlLabels: true
            }                
        }
        mermaid.initialize(mermaid_config);
  }
  </script>
  

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
